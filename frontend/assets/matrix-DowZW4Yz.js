function oc(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}const sv="modulepreload",ov=function(i){return"/"+i},Wl={},lv=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){let d=function(l){return Promise.all(l.map(u=>Promise.resolve(u).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),o=s?.nonce||s?.getAttribute("nonce");n=d(t.map(l=>{if(l=ov(l),l in Wl)return;Wl[l]=!0;const u=l.endsWith(".css"),h=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${h}`))return;const v=document.createElement("link");if(v.rel=u?"stylesheet":sv,u||(v.as="script"),v.crossOrigin="",v.href=l,o&&v.setAttribute("nonce",o),document.head.appendChild(v),u)return new Promise((m,f)=>{v.addEventListener("load",m),v.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(s){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=s,window.dispatchEvent(o),!o.defaultPrevented)throw s}return n.then(s=>{for(const o of s||[])o.status==="rejected"&&a(o.reason);return e().catch(a)})};function Kl(i,e,t,r,n,a,s){try{var o=i[a](s),d=o.value}catch(l){return void t(l)}o.done?e(d):Promise.resolve(d).then(r,n)}function _(i){return function(){var e=this,t=arguments;return new Promise(function(r,n){var a=i.apply(e,t);function s(d){Kl(a,r,n,s,o,"next",d)}function o(d){Kl(a,r,n,s,o,"throw",d)}s(void 0)})}}function Mi(i){"@babel/helpers - typeof";return Mi=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Mi(i)}function dv(i,e){if(Mi(i)!="object"||!i)return i;var t=i[Symbol.toPrimitive];if(t!==void 0){var r=t.call(i,e);if(Mi(r)!="object")return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(i)}function uv(i){var e=dv(i,"string");return Mi(e)=="symbol"?e:e+""}function c(i,e,t){return(e=uv(e))in i?Object.defineProperty(i,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):i[e]=t,i}const cv="l",hv="rn",vv={0:"O",1:"l","֭":"֖","֮":"֘","֨":"֙","֤":"֚","᪴":"ۛ","⃛":"ۛ","ؙ":"̓","ࣳ":"̓","̓":"̓","̕":"̓","ُ":"̓","ٝ":"̔","֜":"́","֝":"́","ؘ":"́","݇":"́","́":"́","॔":"́","َ":"́","̀":"̀","॓":"̀","̌":"̆","꙼":"̆","٘":"̆","ٚ":"̆","ͮ":"̆","ۨ":"̆̇","̐":"̆̇","ँ":"̆̇","ঁ":"̆̇","ઁ":"̆̇","ଁ":"̆̇","ఀ":"̆̇","ಁ":"̆̇","ഁ":"̆̇","𑒿":"̆̇","᳐":"̂","̑":"̂","ٛ":"̂","߮":"̂","꛰":"̂","֯":"̊","۟":"̊","៓":"̊","゚":"̊","ْ":"̊","ஂ":"̊","ံ":"̊","ំ":"̊","𑌀":"̊","ํ":"̊","ໍ":"̊","ͦ":"̊","ⷪ":"̊","࣫":"̈","߳":"̈","ً":"̋","ࣰ":"̋","͂":"̃","ٓ":"̃","ׄ":"̇","۬":"̇","݀":"̇","࣪":"̇","݁":"̇","͘":"̇","ֹ":"̇","ֺ":"̇","ׂ":"̇","ׁ":"̇","߭":"̇","ं":"̇","ਂ":"̇","ં":"̇","்":"̇","̷":"̸","᪷":"̨","̢":"̨","ͅ":"̨","᳒":"̄","̅":"̄","ٙ":"̄","߫":"̄","꛱":"̄","᳚":"̎","ٗ":"̒","͗":"͐","ࣿ":"͐","ࣸ":"͐","ऀ":"͒","᳭":"̖","᳜":"̩","ٖ":"̩","᳕":"̫","͇":"̳","ࣹ":"͔","ࣺ":"͕","゛":"ﾞ","゜":"ﾟ","̶":"̵","〬":"̉","ׅ":"̣","࣭":"̣","᳝":"̣","ִ":"̣","ٜ":"̣","़":"̣","়":"̣","਼":"̣","઼":"̣","଼":"̣","𑇊":"̣","𑓃":"̣","𐨺":"̣","࣮":"̤","᳞":"̤","༷":"̥","〭":"̥","̧":"̦","̡":"̦","̹":"̦","᳙":"̭","᳘":"̮","॒":"̱","̠":"̱","ࣱ":"ٌ","ࣨ":"ٌ","ࣥ":"ٌ",ﱞ:"ﹲّ","ࣲ":"ٍ",ﱟ:"ﹴّ",ﳲ:"ﹷّ",ﱠ:"ﹶّ",ﳳ:"ﹹّ",ﱡ:"ﹸّ","ؚ":"ِ","̗":"ِ",ﳴ:"ﹻّ",ﱢ:"ﹺّ",ﱣ:"ﹼٰ","ٟ":"ٕ","̍":"ٰ","݂":"ܼ","ਃ":"ঃ","ః":"ঃ","ಃ":"ঃ","ഃ":"ঃ","ඃ":"ঃ","း":"ঃ","𑓁":"ঃ","់":"่","່":"่","້":"้","໊":"๊","໋":"๋","꙯":"⃩","\u2028":" ","\u2029":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" ","ߺ":"_","﹍":"_","﹎":"_","﹏":"_","‐":"-","‑":"-","‒":"-","–":"-","﹘":"-","۔":"-","⁃":"-","˗":"-","−":"-","➖":"-","Ⲻ":"-","⨩":"-̓","⸚":"-̈","﬩":"-̇","∸":"-̇","⨪":"-̣","꓾":"-.","～":"〜","؍":",","٫":",","‚":",","¸":",","ꓹ":",","⸲":"،","٬":"،",";":";","⸵":"؛","ः":":","ઃ":":","：":":","։":":","܃":":","܄":":","᛬":":","︰":":","᠃":":","᠉":":","⁚":":","׃":":","˸":":","꞉":":","∶":":",ː:":","ꓽ":":","⩴":"::=","⧴":":→","！":"!",ǃ:"!","ⵑ":"!","‼":"!!","⁉":"!?",ʔ:"?","Ɂ":"?","ॽ":"?",Ꭾ:"?","ꛫ":"?","⁈":"?!","⁇":"??","⸮":"؟","𝅭":".","․":".","܁":".","܂":".","꘎":".","𐩐":".","٠":".","۰":".","ꓸ":".","ꓻ":".,","‥":"..","ꓺ":"..","…":"...","꛴":"꛳꛳","・":"·","･":"·","᛫":"·","·":"·","⸱":"·","𐄁":"·","•":"·","‧":"·","∙":"·","⋅":"·","ꞏ":"·",ᐧ:"·","⋯":"···","ⵈ":"···",ᑄ:"·<","⋗":"·>",ᐷ:"·>",ᑀ:"·>",ᔯ:"·4",ᑾ:"·b",ᒀ:"·ḃ",ᑺ:"·d",ᒘ:"·J",ᒶ:"·L",ᑶ:"·P",ᑗ:"·U",ᐺ:"·V",ᐼ:"·Ʌ",ᒮ:"·Γ",ᐎ:"·Δ",ᑙ:"·Ո",ᐌ:"·ᐁ",ᐐ:"·ᐄ",ᐒ:"·ᐅ",ᐔ:"·ᐆ",ᐗ:"·ᐊ",ᐙ:"·ᐋ",ᐾ:"·ᐲ",ᑂ:"·ᐴ",ᑆ:"·ᐹ",ᑛ:"·ᑏ",ᑔ:"·ᑐ",ᑝ:"·ᑐ",ᑟ:"·ᑑ",ᑡ:"·ᑕ",ᑣ:"·ᑖ",ᑴ:"·ᑫ",ᑸ:"·ᑮ",ᑼ:"·ᑰ",ᒒ:"·ᒉ",ᒔ:"·ᒋ",ᒖ:"·ᒌ",ᒚ:"·ᒎ",ᒜ:"·ᒐ",ᒞ:"·ᒑ",ᒬ:"·ᒣ",ᒰ:"·ᒦ",ᒲ:"·ᒧ",ᒴ:"·ᒨ",ᒸ:"·ᒫ",ᓉ:"·ᓀ","ᣆ":"·ᓂ","ᣈ":"·ᓃ","ᣊ":"·ᓄ","ᣌ":"·ᓅ",ᓋ:"·ᓇ",ᓍ:"·ᓈ",ᓜ:"·ᓓ",ᓞ:"·ᓕ",ᓠ:"·ᓖ",ᓢ:"·ᓗ",ᓤ:"·ᓘ",ᓦ:"·ᓚ",ᓨ:"·ᓛ",ᓶ:"·ᓭ",ᓸ:"·ᓯ",ᓺ:"·ᓰ",ᓼ:"·ᓱ",ᓾ:"·ᓲ",ᔀ:"·ᓴ",ᔂ:"·ᓵ",ᔗ:"·ᔐ",ᔙ:"·ᔑ",ᔛ:"·ᔒ",ᔝ:"·ᔓ",ᔟ:"·ᔔ",ᔡ:"·ᔕ",ᔣ:"·ᔖ",ᔱ:"·ᔨ",ᔳ:"·ᔩ",ᔵ:"·ᔪ",ᔷ:"·ᔫ",ᔹ:"·ᔭ",ᔻ:"·ᔮ","ᣎ":"·ᕃ","ᣏ":"·ᕆ","ᣐ":"·ᕇ","ᣑ":"·ᕈ","ᣒ":"·ᕉ","ᣓ":"·ᕋ",ᕎ:"·ᕌ",ᕛ:"·ᕚ",ᕨ:"·ᕧ","ᢳ":"·ᢱ","ᢶ":"·ᢴ","ᢹ":"·ᢸ","ᣂ":"·ᣀ","꠰":"।","॥":"।।","᰼":"᰻᰻","။":"၊၊","᪩":"᪨᪨","᪫":"᪪᪨","᭟":"᭞᭞","𐩗":"𐩖𐩖","𑑌":"𑑋𑑋","𑙂":"𑙁𑙁","𑱂":"𑱁𑱁","᱿":"᱾᱾","՝":"'","＇":"'","‘":"'","’":"'","‛":"'","′":"'","‵":"'","՚":"'","׳":"'","`":"'","`":"'","｀":"'","´":"'","΄":"'","´":"'","᾽":"'","᾿":"'","῾":"'","ʹ":"'","ʹ":"'","ˈ":"'","ˊ":"'","ˋ":"'","˴":"'",ʻ:"'",ʽ:"'",ʼ:"'",ʾ:"'","ꞌ":"'",י:"'","ߴ":"'","ߵ":"'",ᑊ:"'",ᛌ:"'","𖽑":"'","𖽒":"'","᳓":"''",'"':"''","＂":"''","“":"''","”":"''","‟":"''","″":"''","‶":"''","〃":"''","״":"''","˝":"''","ʺ":"''","˶":"''",ˮ:"''",ײ:"''","‴":"'''","‷":"'''","⁗":"''''",Ɓ:"'B",Ɗ:"'D",ŉ:"'n",Ƥ:"'P",Ƭ:"'T",Ƴ:"'Y","［":"(","❨":"(","❲":"(","〔":"(","﴾":"(","⸨":"((","㈠":"(ー)","⑵":"(2)","⒇":"(2O)","⑶":"(3)","⑷":"(4)","⑸":"(5)","⑹":"(6)","⑺":"(7)","⑻":"(8)","⑼":"(9)","⒜":"(a)","🄐":"(A)","⒝":"(b)","🄑":"(B)","⒞":"(c)","🄒":"(C)","⒟":"(d)","🄓":"(D)","⒠":"(e)","🄔":"(E)","⒡":"(f)","🄕":"(F)","⒢":"(g)","🄖":"(G)","⒣":"(h)","🄗":"(H)","⒤":"(i)","⒥":"(j)","🄙":"(J)","⒦":"(k)","🄚":"(K)","⑴":"(l)","🄘":"(l)","⒧":"(l)","🄛":"(L)","⑿":"(l2)","⒀":"(l3)","⒁":"(l4)","⒂":"(l5)","⒃":"(l6)","⒄":"(l7)","⒅":"(l8)","⒆":"(l9)","⑾":"(ll)","⑽":"(lO)","🄜":"(M)","⒩":"(n)","🄝":"(N)","⒪":"(o)","🄞":"(O)","⒫":"(p)","🄟":"(P)","⒬":"(q)","🄠":"(Q)","⒭":"(r)","🄡":"(R)","⒨":"(rn)","⒮":"(s)","🄢":"(S)","🄪":"(S)","⒯":"(t)","🄣":"(T)","⒰":"(u)","🄤":"(U)","⒱":"(v)","🄥":"(V)","⒲":"(w)","🄦":"(W)","⒳":"(x)","🄧":"(X)","⒴":"(y)","🄨":"(Y)","⒵":"(z)","🄩":"(Z)","㈀":"(ᄀ)","㈎":"(가)","㈁":"(ᄂ)","㈏":"(나)","㈂":"(ᄃ)","㈐":"(다)","㈃":"(ᄅ)","㈑":"(라)","㈄":"(ᄆ)","㈒":"(마)","㈅":"(ᄇ)","㈓":"(바)","㈆":"(ᄉ)","㈔":"(사)","㈇":"(ᄋ)","㈕":"(아)","㈝":"(오전)","㈞":"(오후)","㈈":"(ᄌ)","㈖":"(자)","㈜":"(주)","㈉":"(ᄎ)","㈗":"(차)","㈊":"(ᄏ)","㈘":"(카)","㈋":"(ᄐ)","㈙":"(타)","㈌":"(ᄑ)","㈚":"(파)","㈍":"(ᄒ)","㈛":"(하)","㈦":"(七)","㈢":"(三)","🉁":"(三)","㈨":"(九)","㈡":"(二)","🉂":"(二)","㈤":"(五)","㈹":"(代)","㈽":"(企)","㉁":"(休)","㈧":"(八)","㈥":"(六)","㈸":"(労)","🉇":"(勝)","㈩":"(十)","㈿":"(協)","㈴":"(名)","㈺":"(呼)","㈣":"(四)","㈯":"(土)","㈻":"(学)","🉃":"(安)","🉅":"(打)","🉈":"(敗)","㈰":"(日)","㈪":"(月)","㈲":"(有)","㈭":"(木)","🉀":"(本)","㈱":"(株)","㈬":"(水)","㈫":"(火)","🉄":"(点)","㈵":"(特)","🉆":"(盗)","㈼":"(監)","㈳":"(社)","㈷":"(祝)","㉀":"(祭)","㉂":"(自)","㉃":"(至)","㈶":"(財)","㈾":"(資)","㈮":"(金)","］":")","❩":")","❳":")","〕":")","﴿":")","⸩":"))","❴":"{","𝄔":"{","❵":"}","〚":"⟦","〛":"⟧","⟨":"❬","〈":"❬","〈":"❬","㇛":"❬",く:"❬","𡿨":"❬","⟩":"❭","〉":"❭","〉":"❭","＾":"︿","⸿":"¶","⁎":"*","٭":"*","∗":"*","𐌟":"*","᜵":"/","⁁":"/","∕":"/","⁄":"/","╱":"/","⟋":"/","⧸":"/","𝈺":"/","㇓":"/",〳:"/","Ⳇ":"/",ノ:"/",丿:"/","⼃":"/","⧶":"/̄","⫽":"//","⫻":"///","＼":"\\","﹨":"\\","∖":"\\","⟍":"\\","⧵":"\\","⧹":"\\","𝈏":"\\","𝈻":"\\","㇔":"\\",丶:"\\","⼂":"\\","⳹":"\\\\","⑊":"\\\\","⟈":"\\ᑕ","ꝸ":"&","૰":"॰","𑂻":"॰","𑇇":"॰","⚬":"॰","𑇛":"꣼","៙":"๏","៕":"๚","៚":"๛","༌":"་","༎":"།།","˄":"^","ˆ":"^","꙾":"ˇ","˘":"ˇ","‾":"ˉ","﹉":"ˉ","﹊":"ˉ","﹋":"ˉ","﹌":"ˉ","¯":"ˉ","￣":"ˉ","▔":"ˉ",ъ:"ˉb","ꙑ":"ˉbi","͵":"ˏ","˻":"˪","꜖":"˪","꜔":"˫","。":"˳","⸰":"°","˚":"°","∘":"°","○":"°","◦":"°","⍜":"°̲","⍤":"°̈","℃":"°C","℉":"°F","௵":"௳","༛":"༚༚","༟":"༚༝","࿎":"༝༚","༞":"༝༝","Ⓒ":"©","Ⓡ":"®","Ⓟ":"℗","𝈛":"⅄","⯬":"↞","⯭":"↟","⯮":"↠","⯯":"↡","↵":"↲","⥥":"⇃⇂","⥯":"⇃ᛚ","𝛛":"∂","𝜕":"∂","𝝏":"∂","𝞉":"∂","𝟃":"∂","𞣌":"∂","𞣍":"∂̵",ð:"∂̵","⌀":"∅","𝛁":"∇","𝛻":"∇","𝜵":"∇","𝝯":"∇","𝞩":"∇","𑢨":"∇","⍢":"∇̈","⍫":"∇̴","█":"∎","■":"∎","⨿":"∐","᛭":"+","➕":"+","𐊛":"+","⨣":"+̂","⨢":"+̊","⨤":"+̃","∔":"+̇","⨥":"+̣","⨦":"+̰","⨧":"+₂","➗":"÷","‹":"<","❮":"<","˂":"<","𝈶":"<",ᐸ:"<",ᚲ:"<","⋖":"<·","Ⲵ":"<·",ᑅ:"<·","≪":"<<","⋘":"<<<","᐀":"=","⹀":"=","゠":"=","꓿":"=","≚":"=̆","≙":"=̂","≗":"=̊","≐":"=̇","≑":"=̣̇","⩮":"=⃰","⩵":"==","⩶":"===","≞":"=ͫ","›":">","❯":">","˃":">","𝈷":">",ᐳ:">","𖼿":">",ᑁ:">·","⪥":"><","≫":">>","⨠":">>","⋙":">>>","⁓":"~","˜":"~","῀":"~","∼":"~","⍨":"~̈","⸞":"~̇","⩪":"~̇","⸟":"~̣","𞣈":"∠","⋀":"∧","∯":"∮∮","∰":"∮∮∮","⸫":"∴","⸪":"∵","⸬":"∷","𑇞":"≈","♎":"≏","🝞":"≏","≣":"≡","⨃":"⊍","⨄":"⊎","𝈸":"⊏","𝈹":"⊐","⨅":"⊓","⨆":"⊔","⨂":"⊗","⍟":"⊛","🝱":"⊠","🝕":"⊡","◁":"⊲","▷":"⊳","⍣":"⋆̈","︴":"⌇","◠":"⌒","⨽":"⌙","⌥":"⌤","⧇":"⌻","◎":"⌾","⦾":"⌾","⧅":"⍂","⦰":"⍉","⏃":"⍋","⏂":"⍎","⏁":"⍕","⏆":"⍭","☸":"⎈","︵":"⏜","︶":"⏝","︷":"⏞","︸":"⏟","︹":"⏠","︺":"⏡","▱":"⏥","⏼":"⏻","︱":"│","｜":"│","┃":"│","┏":"┌","┣":"├","▐":"▌","▗":"▖","▝":"▘","☐":"□","￭":"▪","▸":"▶","►":"▶","⳩":"☧","🜊":"☩","🌒":"☽","🌙":"☽","⏾":"☾","🌘":"☾","⧙":"⦚","🜺":"⧟","⨾":"⨟","𐆠":"⳨","♩":"𝅘𝅥","♪":"𝅘𝅥𝅮","⓪":"🄍","↺":"🄎","˙":"ॱ","ൎ":"ॱ","－":"ー","—":"ー","―":"ー","─":"ー","━":"ー","㇐":"ー","ꟷ":"ー",ᅳ:"ー",ㅡ:"ー",一:"ー","⼀":"ー",ᆖ:"ーー","ힹ":"ーᅡ","ힺ":"ーᅥ","ힻ":"ーᅥ丨","ힼ":"ーᅩ",ᆕ:"ーᅮ",ᅴ:"ー丨",ㅢ:"ー丨",ᆗ:"ー丨ᅮ","🄏":"$⃠","₤":"£","〒":"₸","〶":"₸","᭜":"᭐","꧆":"꧐","𑓑":"১","೧":"౧","ၥ":"၁","①":"➀","⑩":"➉","⏨":"₁₀","𝟐":"2","𝟚":"2","𝟤":"2","𝟮":"2","𝟸":"2","🯲":"2","Ꝛ":"2",Ƨ:"2",Ϩ:"2","Ꙅ":"2",ᒿ:"2","ꛯ":"2","ꧏ":"٢","۲":"٢","૨":"२","𑓒":"২","೨":"౨","②":"➁",ƻ:"2̵","🄃":"2,","⒉":"2.","㏵":"22日","㍮":"22点","㏶":"23日","㍯":"23点","㏷":"24日","㍰":"24点","㏸":"25日","㏹":"26日","㏺":"27日","㏻":"28日","㏼":"29日","㏴":"2l日","㍭":"2l点","⒛":"2O.","㏳":"2O日","㍬":"2O点","෩":"෨ා","෯":"෨ී","㏡":"2日","㋁":"2月","㍚":"2点","𝈆":"3","𝟑":"3","𝟛":"3","𝟥":"3","𝟯":"3","𝟹":"3","🯳":"3","Ɜ":"3",Ȝ:"3",Ʒ:"3","Ꝫ":"3","Ⳍ":"3",З:"3",Ӡ:"3","𖼻":"3","𑣊":"3","۳":"٣","𞣉":"٣","૩":"३","③":"➂",Ҙ:"3̦","🄄":"3,","⒊":"3.","㏾":"3l日","㏽":"3O日","㏢":"3日","㋂":"3月","㍛":"3点","𝟒":"4","𝟜":"4","𝟦":"4","𝟰":"4","𝟺":"4","🯴":"4",Ꮞ:"4","𑢯":"4","۴":"٤","૪":"४","④":"➃","🄅":"4,","⒋":"4.",ᔰ:"4·","㏣":"4日","㋃":"4月","㍜":"4点","𝟓":"5","𝟝":"5","𝟧":"5","𝟱":"5","𝟻":"5","🯵":"5",Ƽ:"5","𑢻":"5","⑤":"➄","🄆":"5,","⒌":"5.","㏤":"5日","㋄":"5月","㍝":"5点","𝟔":"6","𝟞":"6","𝟨":"6","𝟲":"6","𝟼":"6","🯶":"6","Ⳓ":"6",б:"6",Ꮾ:"6","𑣕":"6","۶":"٦","𑓖":"৬","⑥":"➅","🄇":"6,","⒍":"6.","㏥":"6日","㋅":"6月","㍞":"6点","𝈒":"7","𝟕":"7","𝟟":"7","𝟩":"7","𝟳":"7","𝟽":"7","🯷":"7","𐓒":"7","𑣆":"7","⑦":"➆","🄈":"7,","⒎":"7.","㏦":"7日","㋆":"7月","㍟":"7点","ଃ":"8","৪":"8","੪":"8","𞣋":"8","𝟖":"8","𝟠":"8","𝟪":"8","𝟴":"8","𝟾":"8","🯸":"8",ȣ:"8",Ȣ:"8","𐌚":"8","૮":"८","⑧":"➇","🄉":"8,","⒏":"8.","㏧":"8日","㋇":"8月","㍠":"8点","੧":"9","୨":"9","৭":"9","൭":"9","𝟗":"9","𝟡":"9","𝟫":"9","𝟵":"9","𝟿":"9","🯹":"9","Ꝯ":"9","Ⳋ":"9","𑣌":"9","𑢬":"9","𑣖":"9","१":"٩","𑣤":"٩","۹":"٩","೯":"౯","⑨":"➈","🄊":"9,","⒐":"9.","㏨":"9日","㋈":"9月","㍡":"9点","⍺":"a",ａ:"a","𝐚":"a","𝑎":"a","𝒂":"a","𝒶":"a","𝓪":"a","𝔞":"a","𝕒":"a","𝖆":"a","𝖺":"a","𝗮":"a","𝘢":"a","𝙖":"a","𝚊":"a",ɑ:"a",α:"a","𝛂":"a","𝛼":"a","𝜶":"a","𝝰":"a","𝞪":"a",а:"a","ⷶ":"ͣ",Ａ:"A","𝐀":"A","𝐴":"A","𝑨":"A","𝒜":"A","𝓐":"A","𝔄":"A","𝔸":"A","𝕬":"A","𝖠":"A","𝗔":"A","𝘈":"A","𝘼":"A","𝙰":"A",Α:"A","𝚨":"A","𝛢":"A","𝜜":"A","𝝖":"A","𝞐":"A",А:"A",Ꭺ:"A",ᗅ:"A","ꓮ":"A","𖽀":"A","𐊠":"A","⍶":"a̲",ǎ:"ă",Ǎ:"Ă",ȧ:"å",Ȧ:"Å",ẚ:"ả","℀":"a/c","℁":"a/s","ꜳ":"aa","Ꜳ":"AA",æ:"ae",ӕ:"ae",Æ:"AE",Ӕ:"AE","ꜵ":"ao","Ꜵ":"AO","🜇":"AR","ꜷ":"au","Ꜷ":"AU","ꜹ":"av","ꜻ":"av","Ꜹ":"AV","Ꜻ":"AV","ꜽ":"ay","Ꜽ":"AY","ꭺ":"ᴀ","∀":"Ɐ","𝈗":"Ɐ",ᗄ:"Ɐ","ꓯ":"Ɐ","𐐟":"Ɒ","𝐛":"b","𝑏":"b","𝒃":"b","𝒷":"b","𝓫":"b","𝔟":"b","𝕓":"b","𝖇":"b","𝖻":"b","𝗯":"b","𝘣":"b","𝙗":"b","𝚋":"b",Ƅ:"b",Ь:"b",Ꮟ:"b",ᑲ:"b",ᖯ:"b",Ｂ:"B",ℬ:"B","𝐁":"B","𝐵":"B","𝑩":"B","𝓑":"B","𝔅":"B","𝔹":"B","𝕭":"B","𝖡":"B","𝗕":"B","𝘉":"B","𝘽":"B","𝙱":"B","Ꞵ":"B",Β:"B","𝚩":"B","𝛣":"B","𝜝":"B","𝝗":"B","𝞑":"B",В:"B",Ᏼ:"B",ᗷ:"B","ꓐ":"B","𐊂":"B","𐊡":"B","𐌁":"B",ɓ:"b̔",ᑳ:"ḃ",ƃ:"b̄",Ƃ:"b̄",Б:"b̄",ƀ:"b̵",ҍ:"b̵",Ҍ:"b̵",ѣ:"b̵",Ѣ:"b̵",ᑿ:"b·",ᒁ:"ḃ·",ᒈ:"b'",Ы:"bl",в:"ʙ","ᏼ":"ʙ",ｃ:"c","ⅽ":"c","𝐜":"c","𝑐":"c","𝒄":"c","𝒸":"c","𝓬":"c","𝔠":"c","𝕔":"c","𝖈":"c","𝖼":"c","𝗰":"c","𝘤":"c","𝙘":"c","𝚌":"c","ᴄ":"c",ϲ:"c","ⲥ":"c",с:"c","ꮯ":"c","𐐽":"c","ⷭ":"ͨ","🝌":"C","𑣲":"C","𑣩":"C",Ｃ:"C","Ⅽ":"C",ℂ:"C",ℭ:"C","𝐂":"C","𝐶":"C","𝑪":"C","𝒞":"C","𝓒":"C","𝕮":"C","𝖢":"C","𝗖":"C","𝘊":"C","𝘾":"C","𝙲":"C","Ϲ":"C","Ⲥ":"C",С:"C",Ꮯ:"C","ꓚ":"C","𐊢":"C","𐌂":"C","𐐕":"C","𐔜":"C","¢":"c̸","ȼ":"c̸","₡":"C⃫","🅮":"C⃠",ç:"c̦",ҫ:"c̦",Ç:"C̦",Ҫ:"C̦",Ƈ:"C'","℅":"c/o","℆":"c/u","🅭":"㏄	⃝","⋴":"ꞓ",ɛ:"ꞓ",ε:"ꞓ","ϵ":"ꞓ","𝛆":"ꞓ","𝛜":"ꞓ","𝜀":"ꞓ","𝜖":"ꞓ","𝜺":"ꞓ","𝝐":"ꞓ","𝝴":"ꞓ","𝞊":"ꞓ","𝞮":"ꞓ","𝟄":"ꞓ","ⲉ":"ꞓ",є:"ꞓ","ԑ":"ꞓ","ꮛ":"ꞓ","𑣎":"ꞓ","𐐩":"ꞓ","€":"Ꞓ","Ⲉ":"Ꞓ",Є:"Ꞓ","⍷":"ꞓ̲","ͽ":"ꜿ","Ͽ":"Ꜿ","ⅾ":"d","ⅆ":"d","𝐝":"d","𝑑":"d","𝒅":"d","𝒹":"d","𝓭":"d","𝔡":"d","𝕕":"d","𝖉":"d","𝖽":"d","𝗱":"d","𝘥":"d","𝙙":"d","𝚍":"d","ԁ":"d",Ꮷ:"d",ᑯ:"d","ꓒ":"d","Ⅾ":"D","ⅅ":"D","𝐃":"D","𝐷":"D","𝑫":"D","𝒟":"D","𝓓":"D","𝔇":"D","𝔻":"D","𝕯":"D","𝖣":"D","𝗗":"D","𝘋":"D","𝘿":"D","𝙳":"D",Ꭰ:"D",ᗞ:"D",ᗪ:"D","ꓓ":"D",ɗ:"d̔",ɖ:"d̨",ƌ:"d̄",đ:"d̵",Đ:"D̵",Ð:"D̵",Ɖ:"D̵","₫":"ḏ̵","ꝺ":"Ꝺ",ᑻ:"d·",ᒇ:"d'",ʤ:"dȝ",ǳ:"dz",ʣ:"dz",ǲ:"Dz",Ǳ:"DZ",ǆ:"dž",ǅ:"Dž",Ǆ:"DŽ",ʥ:"dʑ","ꭰ":"ᴅ","⸹":"ẟ",δ:"ẟ","𝛅":"ẟ","𝛿":"ẟ","𝜹":"ẟ","𝝳":"ẟ","𝞭":"ẟ",ծ:"ẟ",ᕷ:"ẟ","℮":"e",ｅ:"e",ℯ:"e","ⅇ":"e","𝐞":"e","𝑒":"e","𝒆":"e","𝓮":"e","𝔢":"e","𝕖":"e","𝖊":"e","𝖾":"e","𝗲":"e","𝘦":"e","𝙚":"e","𝚎":"e","ꬲ":"e",е:"e",ҽ:"e","ⷷ":"ͤ","⋿":"E",Ｅ:"E",ℰ:"E","𝐄":"E","𝐸":"E","𝑬":"E","𝓔":"E","𝔈":"E","𝔼":"E","𝕰":"E","𝖤":"E","𝗘":"E","𝘌":"E","𝙀":"E","𝙴":"E",Ε:"E","𝚬":"E","𝛦":"E","𝜠":"E","𝝚":"E","𝞔":"E",Е:"E","ⴹ":"E",Ꭼ:"E","ꓰ":"E","𑢦":"E","𑢮":"E","𐊆":"E",ě:"ĕ",Ě:"Ĕ","ɇ":"e̸","Ɇ":"E̸",ҿ:"ę","ꭼ":"ᴇ",ə:"ǝ",ә:"ǝ","∃":"Ǝ","ⴺ":"Ǝ","ꓱ":"Ǝ",ɚ:"ǝ˞","ᴔ":"ǝo","ꭁ":"ǝo̸","ꭂ":"ǝo̵",Ә:"Ə","𝈡":"Ɛ",ℇ:"Ɛ","Ԑ":"Ɛ",Ꮛ:"Ɛ","𖼭":"Ɛ","𐐁":"Ɛ","ᶟ":"ᵋ","ᴈ":"ɜ",з:"ɜ",ҙ:"ɜ̦","𐑂":"ɞ","ꞝ":"ʚ","𐐪":"ʚ","𝐟":"f","𝑓":"f","𝒇":"f","𝒻":"f","𝓯":"f","𝔣":"f","𝕗":"f","𝖋":"f","𝖿":"f","𝗳":"f","𝘧":"f","𝙛":"f","𝚏":"f","ꬵ":"f","ꞙ":"f",ſ:"f","ẝ":"f",ք:"f","𝈓":"F",ℱ:"F","𝐅":"F","𝐹":"F","𝑭":"F","𝓕":"F","𝔉":"F","𝔽":"F","𝕱":"F","𝖥":"F","𝗙":"F","𝘍":"F","𝙁":"F","𝙵":"F","Ꞙ":"F",Ϝ:"F","𝟊":"F",ᖴ:"F","ꓝ":"F","𑣂":"F","𑢢":"F","𐊇":"F","𐊥":"F","𐔥":"F",ƒ:"f̦",Ƒ:"F̦","ᵮ":"f̴","℻":"FAX",ﬀ:"ff",ﬃ:"ffi",ﬄ:"ffl",ﬁ:"fi",ﬂ:"fl",ʩ:"fŋ",ᖵ:"Ⅎ","ꓞ":"Ⅎ","𝈰":"ꟻ",ᖷ:"ꟻ",ｇ:"g",ℊ:"g","𝐠":"g","𝑔":"g","𝒈":"g","𝓰":"g","𝔤":"g","𝕘":"g","𝖌":"g","𝗀":"g","𝗴":"g","𝘨":"g","𝙜":"g","𝚐":"g",ɡ:"g","ᶃ":"g",ƍ:"g",ց:"g","𝐆":"G","𝐺":"G","𝑮":"G","𝒢":"G","𝓖":"G","𝔊":"G","𝔾":"G","𝕲":"G","𝖦":"G","𝗚":"G","𝘎":"G","𝙂":"G","𝙶":"G","Ԍ":"G",Ꮐ:"G",Ᏻ:"G","ꓖ":"G","ᶢ":"ᵍ",ɠ:"g̔",ǧ:"ğ",Ǧ:"Ğ",ǵ:"ģ",ǥ:"g̵",Ǥ:"G̵",Ɠ:"G'","ԍ":"ɢ","ꮐ":"ɢ","ᏻ":"ɢ",ｈ:"h",ℎ:"h","𝐡":"h","𝒉":"h","𝒽":"h","𝓱":"h","𝔥":"h","𝕙":"h","𝖍":"h","𝗁":"h","𝗵":"h","𝘩":"h","𝙝":"h","𝚑":"h",һ:"h",հ:"h",Ꮒ:"h",Ｈ:"H",ℋ:"H",ℌ:"H",ℍ:"H","𝐇":"H","𝐻":"H","𝑯":"H","𝓗":"H","𝕳":"H","𝖧":"H","𝗛":"H","𝘏":"H","𝙃":"H","𝙷":"H",Η:"H","𝚮":"H","𝛨":"H","𝜢":"H","𝝜":"H","𝞖":"H","Ⲏ":"H",Н:"H",Ꮋ:"H",ᕼ:"H","ꓧ":"H","𐋏":"H","ᵸ":"ᴴ",ɦ:"h̔","ꚕ":"h̔",Ᏺ:"h̔","Ⱨ":"H̩",Ң:"H̩",ħ:"h̵",ℏ:"h̵",ћ:"h̵",Ħ:"H̵","Ӊ":"H̦",Ӈ:"H̦",н:"ʜ","ꮋ":"ʜ",ң:"ʜ̩","ӊ":"ʜ̦",ӈ:"ʜ̦","Ԋ":"Ƕ","ꮀ":"ⱶ","Ͱ":"Ⱶ",Ꭸ:"Ⱶ",Ꮀ:"Ⱶ","ꚱ":"Ⱶ","ꞕ":"ꜧ","˛":"i","⍳":"i",ｉ:"i","ⅰ":"i",ℹ:"i","ⅈ":"i","𝐢":"i","𝑖":"i","𝒊":"i","𝒾":"i","𝓲":"i","𝔦":"i","𝕚":"i","𝖎":"i","𝗂":"i","𝗶":"i","𝘪":"i","𝙞":"i","𝚒":"i",ı:"i","𝚤":"i",ɪ:"i",ɩ:"i",ι:"i",ι:"i",ͺ:"i","𝛊":"i","𝜄":"i","𝜾":"i","𝝸":"i","𝞲":"i",і:"i","ꙇ":"i","ӏ":"i","ꭵ":"i",Ꭵ:"i","𑣃":"i","ⓛ":"Ⓘ","⍸":"i̲",ǐ:"ĭ",Ǐ:"Ĭ",ɨ:"i̵","ᵻ":"i̵","ᵼ":"i̵","ⅱ":"ii","ⅲ":"iii",ĳ:"ij","ⅳ":"iv","ⅸ":"ix",ｊ:"j","ⅉ":"j","𝐣":"j","𝑗":"j","𝒋":"j","𝒿":"j","𝓳":"j","𝔧":"j","𝕛":"j","𝖏":"j","𝗃":"j","𝗷":"j","𝘫":"j","𝙟":"j","𝚓":"j",ϳ:"j",ј:"j",Ｊ:"J","𝐉":"J","𝐽":"J","𝑱":"J","𝒥":"J","𝓙":"J","𝔍":"J","𝕁":"J","𝕵":"J","𝖩":"J","𝗝":"J","𝘑":"J","𝙅":"J","𝙹":"J","Ʝ":"J","Ϳ":"J",Ј:"J",Ꭻ:"J",ᒍ:"J","ꓙ":"J","ɉ":"j̵","Ɉ":"J̵",ᒙ:"J·","𝚥":"ȷ",յ:"ȷ","ꭻ":"ᴊ","𝐤":"k","𝑘":"k","𝒌":"k","𝓀":"k","𝓴":"k","𝔨":"k","𝕜":"k","𝖐":"k","𝗄":"k","𝗸":"k","𝘬":"k","𝙠":"k","𝚔":"k",K:"K",Ｋ:"K","𝐊":"K","𝐾":"K","𝑲":"K","𝒦":"K","𝓚":"K","𝔎":"K","𝕂":"K","𝕶":"K","𝖪":"K","𝗞":"K","𝘒":"K","𝙆":"K","𝙺":"K",Κ:"K","𝚱":"K","𝛫":"K","𝜥":"K","𝝟":"K","𝞙":"K","Ⲕ":"K",К:"K",Ꮶ:"K",ᛕ:"K","ꓗ":"K","𐔘":"K",ƙ:"k̔","Ⱪ":"K̩",Қ:"K̩","₭":"K̵","Ꝁ":"K̵",Ҟ:"K̵",Ƙ:"K'","׀":"l","|":"l","∣":"l","⏽":"l","￨":"l","١":"l","۱":"l","𐌠":"l","𞣇":"l","𝟏":"l","𝟙":"l","𝟣":"l","𝟭":"l","𝟷":"l","🯱":"l",I:cv,Ｉ:"l","Ⅰ":"l",ℐ:"l",ℑ:"l","𝐈":"l","𝐼":"l","𝑰":"l","𝓘":"l","𝕀":"l","𝕴":"l","𝖨":"l","𝗜":"l","𝘐":"l","𝙄":"l","𝙸":"l",Ɩ:"l",ｌ:"l","ⅼ":"l",ℓ:"l","𝐥":"l","𝑙":"l","𝒍":"l","𝓁":"l","𝓵":"l","𝔩":"l","𝕝":"l","𝖑":"l","𝗅":"l","𝗹":"l","𝘭":"l","𝙡":"l","𝚕":"l",ǀ:"l",Ι:"l","𝚰":"l","𝛪":"l","𝜤":"l","𝝞":"l","𝞘":"l","Ⲓ":"l",І:"l",Ӏ:"l",ו:"l",ן:"l",ا:"l","𞸀":"l","𞺀":"l",ﺎ:"l",ﺍ:"l","ߊ":"l","ⵏ":"l",ᛁ:"l","ꓲ":"l","𖼨":"l","𐊊":"l","𐌉":"l","𝈪":"L","Ⅼ":"L",ℒ:"L","𝐋":"L","𝐿":"L","𝑳":"L","𝓛":"L","𝔏":"L","𝕃":"L","𝕷":"L","𝖫":"L","𝗟":"L","𝘓":"L","𝙇":"L","𝙻":"L","Ⳑ":"L",Ꮮ:"L",ᒪ:"L","ꓡ":"L","𖼖":"L","𑢣":"L","𑢲":"L","𐐛":"L","𐔦":"L",ﴼ:"l̋",ﴽ:"l̋",ł:"l̸",Ł:"L̸",ɭ:"l̨",Ɨ:"l̵",ƚ:"l̵",ɫ:"l̴",إ:"lٕ",ﺈ:"lٕ",ﺇ:"lٕ",ٳ:"lٕ",ŀ:"l·",Ŀ:"l·",ᒷ:"l·","🄂":"l,","⒈":"l.",ױ:"l'","⒓":"l2.","㏫":"l2日","㋋":"l2月","㍤":"l2点","⒔":"l3.","㏬":"l3日","㍥":"l3点","⒕":"l4.","㏭":"l4日","㍦":"l4点","⒖":"l5.","㏮":"l5日","㍧":"l5点","⒗":"l6.","㏯":"l6日","㍨":"l6点","⒘":"l7.","㏰":"l7日","㍩":"l7点","⒙":"l8.","㏱":"l8日","㍪":"l8点","⒚":"l9.","㏲":"l9日","㍫":"l9点",ǉ:"lj",Ĳ:"lJ",ǈ:"Lj",Ǉ:"LJ","‖":"ll","∥":"ll","Ⅱ":"ll",ǁ:"ll",װ:"ll","𐆙":"l̵l̵","⒒":"ll.","Ⅲ":"lll","𐆘":"l̵l̵S̵","㏪":"ll日","㋊":"ll月","㍣":"ll点",Ю:"lO","⒑":"lO.","㏩":"lO日","㋉":"lO月","㍢":"lO点",ʪ:"ls","₶":"lt","Ⅳ":"lV","Ⅸ":"lX",ɮ:"lȝ",ʫ:"lz",أ:"lٴ",ﺄ:"lٴ",ﺃ:"lٴ",ٲ:"lٴ",ٵ:"lٴ",ﷳ:"lكبر",ﷲ:"lللّٰo","㏠":"l日","㋀":"l月","㍙":"l点","ⳑ":"ʟ","ꮮ":"ʟ","𐑃":"ʟ",Ｍ:"M","Ⅿ":"M",ℳ:"M","𝐌":"M","𝑀":"M","𝑴":"M","𝓜":"M","𝔐":"M","𝕄":"M","𝕸":"M","𝖬":"M","𝗠":"M","𝘔":"M","𝙈":"M","𝙼":"M",Μ:"M","𝚳":"M","𝛭":"M","𝜧":"M","𝝡":"M","𝞛":"M","Ϻ":"M","Ⲙ":"M",М:"M",Ꮇ:"M",ᗰ:"M",ᛖ:"M","ꓟ":"M","𐊰":"M","𐌑":"M","Ӎ":"M̦","🝫":"MB","ⷨ":"ᷟ","𝐧":"n","𝑛":"n","𝒏":"n","𝓃":"n","𝓷":"n","𝔫":"n","𝕟":"n","𝖓":"n","𝗇":"n","𝗻":"n","𝘯":"n","𝙣":"n","𝚗":"n",ո:"n",ռ:"n",Ｎ:"N",ℕ:"N","𝐍":"N","𝑁":"N","𝑵":"N","𝒩":"N","𝓝":"N","𝔑":"N","𝕹":"N","𝖭":"N","𝗡":"N","𝘕":"N","𝙉":"N","𝙽":"N",Ν:"N","𝚴":"N","𝛮":"N","𝜨":"N","𝝢":"N","𝞜":"N","Ⲛ":"N","ꓠ":"N","𐔓":"N","𐆎":"N̊",ɳ:"n̨",ƞ:"n̩",η:"n̩","𝛈":"n̩","𝜂":"n̩","𝜼":"n̩","𝝶":"n̩","𝞰":"n̩",Ɲ:"N̦","ᵰ":"n̴",ǌ:"nj",ǋ:"Nj",Ǌ:"NJ","№":"No","ͷ":"ᴎ",и:"ᴎ","𐑍":"ᴎ",ņ:"ɲ","ం":"o","ಂ":"o","ം":"o","ං":"o","०":"o","੦":"o","૦":"o","௦":"o","౦":"o","೦":"o","൦":"o","๐":"o","໐":"o","၀":"o","٥":"o","۵":"o",ｏ:"o",ℴ:"o","𝐨":"o","𝑜":"o","𝒐":"o","𝓸":"o","𝔬":"o","𝕠":"o","𝖔":"o","𝗈":"o","𝗼":"o","𝘰":"o","𝙤":"o","𝚘":"o","ᴏ":"o","ᴑ":"o","ꬽ":"o",ο:"o","𝛐":"o","𝜊":"o","𝝄":"o","𝝾":"o","𝞸":"o",σ:"o","𝛔":"o","𝜎":"o","𝝈":"o","𝞂":"o","𝞼":"o","ⲟ":"o",о:"o","ჿ":"o",օ:"o",ס:"o",ه:"o","𞸤":"o","𞹤":"o","𞺄":"o",ﻫ:"o",ﻬ:"o",ﻪ:"o",ﻩ:"o",ھ:"o",ﮬ:"o",ﮭ:"o",ﮫ:"o",ﮪ:"o",ہ:"o",ﮨ:"o",ﮩ:"o",ﮧ:"o",ﮦ:"o",ە:"o",ഠ:"o",ဝ:"o","𐓪":"o","𑣈":"o","𑣗":"o","𐐬":"o","߀":"O","০":"O","୦":"O","〇":"O","𑓐":"O","𑣠":"O","𝟎":"O","𝟘":"O","𝟢":"O","𝟬":"O","𝟶":"O","🯰":"O",Ｏ:"O","𝐎":"O","𝑂":"O","𝑶":"O","𝒪":"O","𝓞":"O","𝔒":"O","𝕆":"O","𝕺":"O","𝖮":"O","𝗢":"O","𝘖":"O","𝙊":"O","𝙾":"O",Ο:"O","𝚶":"O","𝛰":"O","𝜪":"O","𝝤":"O","𝞞":"O","Ⲟ":"O",О:"O",Օ:"O","ⵔ":"O",ዐ:"O",ଠ:"O","𐓂":"O","ꓳ":"O","𑢵":"O","𐊒":"O","𐊫":"O","𐐄":"O","𐔖":"O","⁰":"º","ᵒ":"º",ǒ:"ŏ",Ǒ:"Ŏ","ۿ":"ô",Ő:"Ö",ø:"o̸","ꬾ":"o̸",Ø:"O̸","ⵁ":"O̸",Ǿ:"Ó̸",ɵ:"o̵","ꝋ":"o̵",ө:"o̵",ѳ:"o̵","ꮎ":"o̵","ꮻ":"o̵","⊖":"O̵","⊝":"O̵","⍬":"O̵","𝈚":"O̵","🜔":"O̵",Ɵ:"O̵","Ꝋ":"O̵",θ:"O̵",ϑ:"O̵","𝛉":"O̵","𝛝":"O̵","𝜃":"O̵","𝜗":"O̵","𝜽":"O̵","𝝑":"O̵","𝝷":"O̵","𝞋":"O̵","𝞱":"O̵","𝟅":"O̵",Θ:"O̵","ϴ":"O̵","𝚯":"O̵","𝚹":"O̵","𝛩":"O̵","𝛳":"O̵","𝜣":"O̵","𝜭":"O̵","𝝝":"O̵","𝝧":"O̵","𝞗":"O̵","𝞡":"O̵",Ө:"O̵",Ѳ:"O̵","ⴱ":"O̵",Ꮎ:"O̵",Ꮻ:"O̵","ꭴ":"ơ",ﳙ:"oٰ","🄁":"O,","🄀":"O.",ơ:"o'",Ơ:"O'",Ꭴ:"O'","%":"º/₀","٪":"º/₀","⁒":"º/₀","‰":"º/₀₀","؉":"º/₀₀","‱":"º/₀₀₀","؊":"º/₀₀₀",œ:"oe",Œ:"OE",ɶ:"oᴇ","∞":"oo","ꝏ":"oo","ꚙ":"oo","Ꝏ":"OO","Ꚙ":"OO",ﳗ:"oج",ﱑ:"oج",ﳘ:"oم",ﱒ:"oم",ﶓ:"oمج",ﶔ:"oمم",ﱓ:"oى",ﱔ:"oى","ൟ":"oരo",တ:"oာ","㍘":"O点","ↄ":"ɔ","ᴐ":"ɔ","ͻ":"ɔ","𐑋":"ɔ","Ↄ":"Ɔ","Ͻ":"Ɔ","ꓛ":"Ɔ","𐐣":"Ɔ","ꬿ":"ɔ̸","ꭢ":"ɔe","𐐿":"ɷ","⍴":"p",ｐ:"p","𝐩":"p","𝑝":"p","𝒑":"p","𝓅":"p","𝓹":"p","𝔭":"p","𝕡":"p","𝖕":"p","𝗉":"p","𝗽":"p","𝘱":"p","𝙥":"p","𝚙":"p",ρ:"p",ϱ:"p","𝛒":"p","𝛠":"p","𝜌":"p","𝜚":"p","𝝆":"p","𝝔":"p","𝞀":"p","𝞎":"p","𝞺":"p","𝟈":"p","ⲣ":"p",р:"p",Ｐ:"P",ℙ:"P","𝐏":"P","𝑃":"P","𝑷":"P","𝒫":"P","𝓟":"P","𝔓":"P","𝕻":"P","𝖯":"P","𝗣":"P","𝘗":"P","𝙋":"P","𝙿":"P",Ρ:"P","𝚸":"P","𝛲":"P","𝜬":"P","𝝦":"P","𝞠":"P","Ⲣ":"P",Р:"P",Ꮲ:"P",ᑭ:"P","ꓑ":"P","𐊕":"P",ƥ:"p̔","ᵽ":"p̵",ᑷ:"p·",ᒆ:"P'","ᴩ":"ᴘ","ꮲ":"ᴘ",φ:"ɸ",ϕ:"ɸ","𝛗":"ɸ","𝛟":"ɸ","𝜑":"ɸ","𝜙":"ɸ","𝝋":"ɸ","𝝓":"ɸ","𝞅":"ɸ","𝞍":"ɸ","𝞿":"ɸ","𝟇":"ɸ","ⲫ":"ɸ",ф:"ɸ","𝐪":"q","𝑞":"q","𝒒":"q","𝓆":"q","𝓺":"q","𝔮":"q","𝕢":"q","𝖖":"q","𝗊":"q","𝗾":"q","𝘲":"q","𝙦":"q","𝚚":"q","ԛ":"q",գ:"q",զ:"q",ℚ:"Q","𝐐":"Q","𝑄":"Q","𝑸":"Q","𝒬":"Q","𝓠":"Q","𝔔":"Q","𝕼":"Q","𝖰":"Q","𝗤":"Q","𝘘":"Q","𝙌":"Q","𝚀":"Q","ⵕ":"Q",ʠ:"q̔","🜀":"QE","ᶐ":"ɋ","ᴋ":"ĸ",κ:"ĸ",ϰ:"ĸ","𝛋":"ĸ","𝛞":"ĸ","𝜅":"ĸ","𝜘":"ĸ","𝜿":"ĸ","𝝒":"ĸ","𝝹":"ĸ","𝞌":"ĸ","𝞳":"ĸ","𝟆":"ĸ","ⲕ":"ĸ",к:"ĸ","ꮶ":"ĸ",қ:"ĸ̩",ҟ:"ĸ̵","𝐫":"r","𝑟":"r","𝒓":"r","𝓇":"r","𝓻":"r","𝔯":"r","𝕣":"r","𝖗":"r","𝗋":"r","𝗿":"r","𝘳":"r","𝙧":"r","𝚛":"r","ꭇ":"r","ꭈ":"r","ᴦ":"r","ⲅ":"r",г:"r","ꮁ":"r","𝈖":"R",ℛ:"R",ℜ:"R",ℝ:"R","𝐑":"R","𝑅":"R","𝑹":"R","𝓡":"R","𝕽":"R","𝖱":"R","𝗥":"R","𝘙":"R","𝙍":"R","𝚁":"R",Ʀ:"R",Ꭱ:"R",Ꮢ:"R","𐒴":"R",ᖇ:"R","ꓣ":"R","𖼵":"R",ɽ:"r̨",ɼ:"r̩","ɍ":"r̵",ғ:"r̵","ᵲ":"r̴",ґ:"r'","𑣣":"rn",m:hv,"ⅿ":"rn","𝐦":"rn","𝑚":"rn","𝒎":"rn","𝓂":"rn","𝓶":"rn","𝔪":"rn","𝕞":"rn","𝖒":"rn","𝗆":"rn","𝗺":"rn","𝘮":"rn","𝙢":"rn","𝚖":"rn","𑜀":"rn","₥":"rn̸",ɱ:"rn̦","ᵯ":"rn̴","₨":"Rs","ꭱ":"ʀ","ꮢ":"ʀ",я:"ᴙ","ᵳ":"ɾ̴","℩":"ɿ",ｓ:"s","𝐬":"s","𝑠":"s","𝒔":"s","𝓈":"s","𝓼":"s","𝔰":"s","𝕤":"s","𝖘":"s","𝗌":"s","𝘀":"s","𝘴":"s","𝙨":"s","𝚜":"s","ꜱ":"s",ƽ:"s",ѕ:"s","ꮪ":"s","𑣁":"s","𐑈":"s",Ｓ:"S","𝐒":"S","𝑆":"S","𝑺":"S","𝒮":"S","𝓢":"S","𝔖":"S","𝕊":"S","𝕾":"S","𝖲":"S","𝗦":"S","𝘚":"S","𝙎":"S","𝚂":"S",Ѕ:"S",Տ:"S",Ꮥ:"S",Ꮪ:"S","ꓢ":"S","𖼺":"S","𐊖":"S","𐐠":"S",ʂ:"s̨","ᵴ":"s̴","ꞵ":"ß",β:"ß",ϐ:"ß","𝛃":"ß","𝛽":"ß","𝜷":"ß","𝝱":"ß","𝞫":"ß",Ᏸ:"ß","🝜":"sss",ﬆ:"st","∫":"ʃ","ꭍ":"ʃ","∑":"Ʃ","⅀":"Ʃ",Σ:"Ʃ","𝚺":"Ʃ","𝛴":"Ʃ","𝜮":"Ʃ","𝝨":"Ʃ","𝞢":"Ʃ","ⵉ":"Ʃ","∬":"ʃʃ","∭":"ʃʃʃ","⨌":"ʃʃʃʃ","𝐭":"t","𝑡":"t","𝒕":"t","𝓉":"t","𝓽":"t","𝔱":"t","𝕥":"t","𝖙":"t","𝗍":"t","𝘁":"t","𝘵":"t","𝙩":"t","𝚝":"t","⊤":"T","⟙":"T","🝨":"T",Ｔ:"T","𝐓":"T","𝑇":"T","𝑻":"T","𝒯":"T","𝓣":"T","𝔗":"T","𝕋":"T","𝕿":"T","𝖳":"T","𝗧":"T","𝘛":"T","𝙏":"T","𝚃":"T",Τ:"T","𝚻":"T","𝛵":"T","𝜯":"T","𝝩":"T","𝞣":"T","Ⲧ":"T",Т:"T",Ꭲ:"T","ꓔ":"T","𖼊":"T","𑢼":"T","𐊗":"T","𐊱":"T","𐌕":"T",ƭ:"t̔","⍡":"T̈","Ⱦ":"T̸",Ț:"Ţ",Ʈ:"T̨",Ҭ:"T̩","₮":"T⃫",ŧ:"t̵",Ŧ:"T̵","ᵵ":"t̴",Ⴀ:"Ꞇ","Ꜩ":"T3",ʨ:"tɕ","℡":"TEL","ꝷ":"tf",ʦ:"ts",ʧ:"tʃ","ꜩ":"tȝ",τ:"ᴛ","𝛕":"ᴛ","𝜏":"ᴛ","𝝉":"ᴛ","𝞃":"ᴛ","𝞽":"ᴛ",т:"ᴛ","ꭲ":"ᴛ",ҭ:"ᴛ̩",ţ:"ƫ",ț:"ƫ",Ꮏ:"ƫ","𝐮":"u","𝑢":"u","𝒖":"u","𝓊":"u","𝓾":"u","𝔲":"u","𝕦":"u","𝖚":"u","𝗎":"u","𝘂":"u","𝘶":"u","𝙪":"u","𝚞":"u","ꞟ":"u","ᴜ":"u","ꭎ":"u","ꭒ":"u",ʋ:"u",υ:"u","𝛖":"u","𝜐":"u","𝝊":"u","𝞄":"u","𝞾":"u",ս:"u","𐓶":"u","𑣘":"u","∪":"U","⋃":"U","𝐔":"U","𝑈":"U","𝑼":"U","𝒰":"U","𝓤":"U","𝔘":"U","𝕌":"U","𝖀":"U","𝖴":"U","𝗨":"U","𝘜":"U","𝙐":"U","𝚄":"U",Ս:"U",ሀ:"U","𐓎":"U",ᑌ:"U","ꓴ":"U","𖽂":"U","𑢸":"U",ǔ:"ŭ",Ǔ:"Ŭ","ᵾ":"u̵","ꮜ":"u̵","Ʉ":"U̵",Ꮜ:"U̵",ᑘ:"U·",ᑧ:"U'","ᵫ":"ue","ꭣ":"uo",ṃ:"ꭑ",պ:"ɰ",ሣ:"ɰ","℧":"Ʊ",ᘮ:"Ʊ",ᘴ:"Ʊ","ᵿ":"ʊ̵","∨":"v","⋁":"v",ｖ:"v","ⅴ":"v","𝐯":"v","𝑣":"v","𝒗":"v","𝓋":"v","𝓿":"v","𝔳":"v","𝕧":"v","𝖛":"v","𝗏":"v","𝘃":"v","𝘷":"v","𝙫":"v","𝚟":"v","ᴠ":"v",ν:"v","𝛎":"v","𝜈":"v","𝝂":"v","𝝼":"v","𝞶":"v",ѵ:"v",ט:"v","𑜆":"v","ꮩ":"v","𑣀":"v","𝈍":"V","٧":"V","۷":"V","Ⅴ":"V","𝐕":"V","𝑉":"V","𝑽":"V","𝒱":"V","𝓥":"V","𝔙":"V","𝕍":"V","𝖁":"V","𝖵":"V","𝗩":"V","𝘝":"V","𝙑":"V","𝚅":"V",Ѵ:"V","ⴸ":"V",Ꮩ:"V",ᐯ:"V","ꛟ":"V","ꓦ":"V","𖼈":"V","𑢠":"V","𐔝":"V","𐆗":"V̵",ᐻ:"V·","🝬":"VB","ⅵ":"vi","ⅶ":"vii","ⅷ":"viii","Ⅵ":"Vl","Ⅶ":"Vll","Ⅷ":"Vlll","🜈":"Vᷤ","ᴧ":"ʌ","𐓘":"ʌ","٨":"Ʌ","۸":"Ʌ",Λ:"Ʌ","𝚲":"Ʌ","𝛬":"Ʌ","𝜦":"Ʌ","𝝠":"Ʌ","𝞚":"Ʌ",Л:"Ʌ","ⴷ":"Ʌ","𐒰":"Ʌ",ᐱ:"Ʌ","ꛎ":"Ʌ","ꓥ":"Ʌ","𖼽":"Ʌ","𐊍":"Ʌ","Ӆ":"Ʌ̦",ᐽ:"Ʌ·",ɯ:"w","𝐰":"w","𝑤":"w","𝒘":"w","𝓌":"w","𝔀":"w","𝔴":"w","𝕨":"w","𝖜":"w","𝗐":"w","𝘄":"w","𝘸":"w","𝙬":"w","𝚠":"w","ᴡ":"w",ѡ:"w","ԝ":"w",ա:"w","𑜊":"w","𑜎":"w","𑜏":"w","ꮃ":"w","𑣯":"W","𑣦":"W","𝐖":"W","𝑊":"W","𝑾":"W","𝒲":"W","𝓦":"W","𝔚":"W","𝕎":"W","𝖂":"W","𝖶":"W","𝗪":"W","𝘞":"W","𝙒":"W","𝚆":"W","Ԝ":"W",Ꮃ:"W",Ꮤ:"W","ꓪ":"W",ѽ:"w҆҇","𑓅":"ẇ","₩":"W̵","ꝡ":"w̦","ᴍ":"ʍ",м:"ʍ","ꮇ":"ʍ","ӎ":"ʍ̦","᙮":"x","×":"x","⤫":"x","⤬":"x","⨯":"x",ｘ:"x","ⅹ":"x","𝐱":"x","𝑥":"x","𝒙":"x","𝓍":"x","𝔁":"x","𝔵":"x","𝕩":"x","𝖝":"x","𝗑":"x","𝘅":"x","𝘹":"x","𝙭":"x","𝚡":"x",х:"x",ᕁ:"x",ᕽ:"x","ⷯ":"ͯ","᙭":"X","╳":"X","𐌢":"X","𑣬":"X",Ｘ:"X","Ⅹ":"X","𝐗":"X","𝑋":"X","𝑿":"X","𝒳":"X","𝓧":"X","𝔛":"X","𝕏":"X","𝖃":"X","𝖷":"X","𝗫":"X","𝘟":"X","𝙓":"X","𝚇":"X","Ꭓ":"X",Χ:"X","𝚾":"X","𝛸":"X","𝜲":"X","𝝬":"X","𝞦":"X","Ⲭ":"X",Х:"X","ⵝ":"X",ᚷ:"X","ꓫ":"X","𐊐":"X","𐊴":"X","𐌗":"X","𐔧":"X","⨰":"ẋ",Ҳ:"X̩","𐆖":"X̵","ⅺ":"xi","ⅻ":"xii","Ⅺ":"Xl","Ⅻ":"Xll",ɣ:"y","ᶌ":"y",ｙ:"y","𝐲":"y","𝑦":"y","𝒚":"y","𝓎":"y","𝔂":"y","𝔶":"y","𝕪":"y","𝖞":"y","𝗒":"y","𝘆":"y","𝘺":"y","𝙮":"y","𝚢":"y",ʏ:"y","ỿ":"y","ꭚ":"y",γ:"y","ℽ":"y","𝛄":"y","𝛾":"y","𝜸":"y","𝝲":"y","𝞬":"y",у:"y",ү:"y",ყ:"y","𑣜":"y",Ｙ:"Y","𝐘":"Y","𝑌":"Y","𝒀":"Y","𝒴":"Y","𝓨":"Y","𝔜":"Y","𝕐":"Y","𝖄":"Y","𝖸":"Y","𝗬":"Y","𝘠":"Y","𝙔":"Y","𝚈":"Y",Υ:"Y",ϒ:"Y","𝚼":"Y","𝛶":"Y","𝜰":"Y","𝝪":"Y","𝞤":"Y","Ⲩ":"Y",У:"Y",Ү:"Y",Ꭹ:"Y",Ꮍ:"Y","ꓬ":"Y","𖽃":"Y","𑢤":"Y","𐊲":"Y",ƴ:"y̔","ɏ":"y̵",ұ:"y̵","¥":"Y̵","Ɏ":"Y̵",Ұ:"Y̵",ʒ:"ȝ","ꝫ":"ȝ","ⳍ":"ȝ",ӡ:"ȝ",ჳ:"ȝ","𝐳":"z","𝑧":"z","𝒛":"z","𝓏":"z","𝔃":"z","𝔷":"z","𝕫":"z","𝖟":"z","𝗓":"z","𝘇":"z","𝘻":"z","𝙯":"z","𝚣":"z","ᴢ":"z","ꮓ":"z","𑣄":"z","𐋵":"Z","𑣥":"Z",Ｚ:"Z",ℤ:"Z",ℨ:"Z","𝐙":"Z","𝑍":"Z","𝒁":"Z","𝒵":"Z","𝓩":"Z","𝖅":"Z","𝖹":"Z","𝗭":"Z","𝘡":"Z","𝙕":"Z","𝚉":"Z",Ζ:"Z","𝚭":"Z","𝛧":"Z","𝜡":"Z","𝝛":"Z","𝞕":"Z",Ꮓ:"Z","ꓜ":"Z","𑢩":"Z",ʐ:"z̨",ƶ:"z̵",Ƶ:"Z̵",ȥ:"z̦",Ȥ:"Z̦","ᵶ":"z̴",ƿ:"þ","ϸ":"þ","Ϸ":"Þ","𐓄":"Þ","⁹":"ꝰ","ᴤ":"ƨ",ϩ:"ƨ","ꙅ":"ƨ",ь:"ƅ","ꮟ":"ƅ",ы:"ƅi","ꭾ":"ɂ",ˤ:"ˁ","ꛍ":"ʡ","⊙":"ʘ","☉":"ʘ","⨀":"ʘ","Ꙩ":"ʘ","ⵙ":"ʘ","𐓃":"ʘ","ℾ":"Γ","𝚪":"Γ","𝛤":"Γ","𝜞":"Γ","𝝘":"Γ","𝞒":"Γ","Ⲅ":"Γ",Г:"Γ",Ꮁ:"Γ",ᒥ:"Γ","𖼇":"Γ",Ғ:"Γ̵",ᒯ:"Γ·",Ґ:"Γ'","∆":"Δ","△":"Δ","🜂":"Δ","𝚫":"Δ","𝛥":"Δ","𝜟":"Δ","𝝙":"Δ","𝞓":"Δ","Ⲇ":"Δ","ⵠ":"Δ",ᐃ:"Δ","𖼚":"Δ","𐊅":"Δ","𐊣":"Δ","⍙":"Δ̲",ᐏ:"Δ·",ᐬ:"Δᐠ","𝟋":"ϝ","𝛇":"ζ","𝜁":"ζ","𝜻":"ζ","𝝵":"ζ","𝞯":"ζ","ⳤ":"ϗ","𝛌":"λ","𝜆":"λ","𝝀":"λ","𝝺":"λ","𝞴":"λ","Ⲗ":"λ","𐓛":"λ",µ:"μ","𝛍":"μ","𝜇":"μ","𝝁":"μ","𝝻":"μ","𝞵":"μ","𝛏":"ξ","𝜉":"ξ","𝝃":"ξ","𝝽":"ξ","𝞷":"ξ","𝚵":"Ξ","𝛯":"Ξ","𝜩":"Ξ","𝝣":"Ξ","𝞝":"Ξ",ϖ:"π","ℼ":"π","𝛑":"π","𝛡":"π","𝜋":"π","𝜛":"π","𝝅":"π","𝝕":"π","𝝿":"π","𝞏":"π","𝞹":"π","𝟉":"π","ᴨ":"π",п:"π","∏":"Π","ℿ":"Π","𝚷":"Π","𝛱":"Π","𝜫":"Π","𝝥":"Π","𝞟":"Π","Ⲡ":"Π",П:"Π","ꛛ":"Π","𐊭":"Ϙ","𐌒":"Ϙ",ϛ:"ς","𝛓":"ς","𝜍":"ς","𝝇":"ς","𝞁":"ς","𝞻":"ς","𝚽":"Φ","𝛷":"Φ","𝜱":"Φ","𝝫":"Φ","𝞥":"Φ","Ⲫ":"Φ",Ф:"Φ",Փ:"Φ",ቀ:"Φ","ᛰ":"Φ","𐊳":"Φ","ꭓ":"χ","ꭕ":"χ","𝛘":"χ","𝜒":"χ","𝝌":"χ","𝞆":"χ","𝟀":"χ","ⲭ":"χ","𝛙":"ψ","𝜓":"ψ","𝝍":"ψ","𝞇":"ψ","𝟁":"ψ",ѱ:"ψ","𐓹":"ψ","𝚿":"Ψ","𝛹":"Ψ","𝜳":"Ψ","𝝭":"Ψ","𝞧":"Ψ","Ⲯ":"Ψ",Ѱ:"Ψ","𐓑":"Ψ",ᛘ:"Ψ","𐊵":"Ψ","⍵":"ω","ꞷ":"ω","𝛚":"ω","𝜔":"ω","𝝎":"ω","𝞈":"ω","𝟂":"ω","ⲱ":"ω","ꙍ":"ω",Ω:"Ω","𝛀":"Ω","𝛺":"Ω","𝜴":"Ω","𝝮":"Ω","𝞨":"Ω",ᘯ:"Ω",ᘵ:"Ω","𐊶":"Ω","⍹":"ω̲",ώ:"ῴ","☰":"Ⲷ","Ⳝ":"Ϭ",җ:"ж̩",Җ:"Ж̩","𝈋":"И","Ͷ":"И","ꚡ":"И","𐐥":"И",Й:"Ѝ","Ҋ":"Ѝ̦",ѝ:"й","ҋ":"й̦","𐒼":"Ӄ","ᴫ":"л","ӆ":"л̦","ꭠ":"љ","𐓫":"ꙩ","ᷮ":"ⷬ","𐓍":"Ћ","𝈂":"Ӿ","𝈢":"Ѡ",Ꮗ:"Ѡ",ᗯ:"Ѡ",Ѽ:"Ѡ҆҇","ᣭ":"Ѡ·","Ꞷ":"Ꙍ",ӌ:"ҷ",Ӌ:"Ҷ",Ҿ:"Ҽ̨","ⲽ":"ш","Ⲽ":"Ш","Ꙑ":"Ъl","℈":"Э","🜁":"Ꙙ","𖼜":"Ꙙ","ꦒ":"ⰿ",և:"եւ",ኔ:"ձ",ﬔ:"մե",ﬕ:"մի",ﬗ:"մխ",ﬓ:"մն","∩":"Ո","⋂":"Ո","𝉅":"Ո",በ:"Ո",ᑎ:"Ո","ꓵ":"Ո",ᑚ:"Ո·",ᑨ:"Ո'",ﬖ:"վն","₽":"Ք","˓":"ՙ",ʿ:"ՙ",ℵ:"א",ﬡ:"א",אָ:"אַ",אּ:"אַ",ﭏ:"אל",ℶ:"ב",ℷ:"ג",ℸ:"ד",ﬢ:"ד",ﬣ:"ה",יּ:"יִ",ﬤ:"כ",ﬥ:"ל",ﬦ:"ם",ﬠ:"ע",ﬧ:"ר",שׂ:"שׁ",שּ:"שׁ",שּׂ:"שּׁ",ﬨ:"ת",ﺀ:"ء","۽":"ء͈",ﺂ:"آ",ﺁ:"آ",ﭑ:"ٱ",ﭐ:"ٱ","𞸁":"ب","𞸡":"ب","𞹡":"ب","𞺁":"ب","𞺡":"ب",ﺑ:"ب",ﺒ:"ب",ﺐ:"ب",ﺏ:"ب","ݑ":"بۛ","ࢶ":"بۢ","ࢡ":"بٔ",ﲠ:"بo",ﳢ:"بo",ﲜ:"بج",ﰅ:"بج",ﲝ:"بح",ﰆ:"بح",ﷂ:"بحى",ﲞ:"بخ",ﰇ:"بخ",ﳒ:"بخ",ﱋ:"بخ",ﶞ:"بخى",ﱪ:"بر",ﱫ:"بز",ﲟ:"بم",ﳡ:"بم",ﱬ:"بم",ﰈ:"بم",ﱭ:"بن",ﱮ:"بى",ﰉ:"بى",ﱯ:"بى",ﰊ:"بى",ﭔ:"ٻ",ﭕ:"ٻ",ﭓ:"ٻ",ﭒ:"ٻ",ې:"ٻ",ﯦ:"ٻ",ﯧ:"ٻ",ﯥ:"ٻ",ﯤ:"ٻ",ﭜ:"ڀ",ﭝ:"ڀ",ﭛ:"ڀ",ﭚ:"ڀ","ࢩ":"ݔ","ݧ":"ݔ","⍥":"ة",ö:"ة",ﺔ:"ة",ﺓ:"ة",ۃ:"ة","𞸕":"ت","𞸵":"ت","𞹵":"ت","𞺕":"ت","𞺵":"ت",ﺗ:"ت",ﺘ:"ت",ﺖ:"ت",ﺕ:"ت",ﲥ:"تo",ﳤ:"تo",ﲡ:"تج",ﰋ:"تج",ﵐ:"تجم",ﶠ:"تجى",ﶟ:"تجى",ﲢ:"تح",ﰌ:"تح",ﵒ:"تحج",ﵑ:"تحج",ﵓ:"تحم",ﲣ:"تخ",ﰍ:"تخ",ﵔ:"تخم",ﶢ:"تخى",ﶡ:"تخى",ﱰ:"تر",ﱱ:"تز",ﲤ:"تم",ﳣ:"تم",ﱲ:"تم",ﰎ:"تم",ﵕ:"تمج",ﵖ:"تمح",ﵗ:"تمخ",ﶤ:"تمى",ﶣ:"تمى",ﱳ:"تن",ﱴ:"تى",ﰏ:"تى",ﱵ:"تى",ﰐ:"تى",ﭠ:"ٺ",ﭡ:"ٺ",ﭟ:"ٺ",ﭞ:"ٺ",ﭤ:"ٿ",ﭥ:"ٿ",ﭣ:"ٿ",ﭢ:"ٿ","𞸂":"ج","𞸢":"ج","𞹂":"ج","𞹢":"ج","𞺂":"ج","𞺢":"ج",ﺟ:"ج",ﺠ:"ج",ﺞ:"ج",ﺝ:"ج",ﲧ:"جح",ﰕ:"جح",ﶦ:"جحى",ﶾ:"جحى",ﷻ:"جل جلlلo",ﲨ:"جم",ﰖ:"جم",ﵙ:"جمح",ﵘ:"جمح",ﶧ:"جمى",ﶥ:"جمى",ﴝ:"جى",ﴁ:"جى",ﴞ:"جى",ﴂ:"جى",ﭸ:"ڃ",ﭹ:"ڃ",ﭷ:"ڃ",ﭶ:"ڃ",ﭴ:"ڄ",ﭵ:"ڄ",ﭳ:"ڄ",ﭲ:"ڄ",ﭼ:"چ",ﭽ:"چ",ﭻ:"چ",ﭺ:"چ",ﮀ:"ڇ",ﮁ:"ڇ",ﭿ:"ڇ",ﭾ:"ڇ","𞸇":"ح","𞸧":"ح","𞹇":"ح","𞹧":"ح","𞺇":"ح","𞺧":"ح",ﺣ:"ح",ﺤ:"ح",ﺢ:"ح",ﺡ:"ح",څ:"حۛ",ځ:"حٔ","ݲ":"حٔ",ﲩ:"حج",ﰗ:"حج",ﶿ:"حجى",ﲪ:"حم",ﰘ:"حم",ﵛ:"حمى",ﵚ:"حمى",ﴛ:"حى",ﳿ:"حى",ﴜ:"حى",ﴀ:"حى","𞸗":"خ","𞸷":"خ","𞹗":"خ","𞹷":"خ","𞺗":"خ","𞺷":"خ",ﺧ:"خ",ﺨ:"خ",ﺦ:"خ",ﺥ:"خ",ﲫ:"خج",ﰙ:"خج",ﰚ:"خح",ﲬ:"خم",ﰛ:"خم",ﴟ:"خى",ﴃ:"خى",ﴠ:"خى",ﴄ:"خى","𐋡":"د","𞸃":"د","𞺃":"د","𞺣":"د",ﺪ:"د",ﺩ:"د",ڈ:"دؕ",ﮉ:"دؕ",ﮈ:"دؕ",ڎ:"دۛ",ﮇ:"دۛ",ﮆ:"دۛ","ۮ":"د̂","ࢮ":"د̤̣","𞸘":"ذ","𞺘":"ذ","𞺸":"ذ",ﺬ:"ذ",ﺫ:"ذ",ﱛ:"ذٰ",ڋ:"ڊؕ",ﮅ:"ڌ",ﮄ:"ڌ",ﮃ:"ڍ",ﮂ:"ڍ","𞸓":"ر","𞺓":"ر","𞺳":"ر",ﺮ:"ر",ﺭ:"ر",ڑ:"رؕ",ﮍ:"رؕ",ﮌ:"رؕ",ژ:"رۛ",ﮋ:"رۛ",ﮊ:"رۛ",ڒ:"ر̆","ࢹ":"ر̆̇","ۯ":"ر̂","ݬ":"رٔ",ﱜ:"رٰ",ﷶ:"رسول","﷼":"رىlل","𞸆":"ز","𞺆":"ز","𞺦":"ز",ﺰ:"ز",ﺯ:"ز","ࢲ":"ز̂","ݱ":"ڗؕ","𞸎":"س","𞸮":"س","𞹎":"س","𞹮":"س","𞺎":"س","𞺮":"س",ﺳ:"س",ﺴ:"س",ﺲ:"س",ﺱ:"س",ش:"سۛ","𞸔":"سۛ","𞸴":"سۛ","𞹔":"سۛ","𞹴":"سۛ","𞺔":"سۛ","𞺴":"سۛ",ﺷ:"سۛ",ﺸ:"سۛ",ﺶ:"سۛ",ﺵ:"سۛ","ݾ":"س̂",ﴱ:"سo",ﳨ:"سo",ﴲ:"سۛo",ﳪ:"سۛo",ﲭ:"سج",ﴴ:"سج",ﰜ:"سج",ﴭ:"سۛج",ﴷ:"سۛج",ﴥ:"سۛج",ﴉ:"سۛج",ﵝ:"سجح",ﵞ:"سجى",ﵩ:"سۛجى",ﲮ:"سح",ﴵ:"سح",ﰝ:"سح",ﴮ:"سۛح",ﴸ:"سۛح",ﴦ:"سۛح",ﴊ:"سۛح",ﵜ:"سحج",ﵨ:"سۛحم",ﵧ:"سۛحم",ﶪ:"سۛحى",ﲯ:"سخ",ﴶ:"سخ",ﰞ:"سخ",ﴯ:"سۛخ",ﴹ:"سۛخ",ﴧ:"سۛخ",ﴋ:"سۛخ",ﶨ:"سخى",ﷆ:"سخى",ﴪ:"سر",ﴎ:"سر",ﴩ:"سۛر",ﴍ:"سۛر",ﲰ:"سم",ﳧ:"سم",ﰟ:"سم",ﴰ:"سۛم",ﳩ:"سۛم",ﴨ:"سۛم",ﴌ:"سۛم",ﵡ:"سمج",ﵠ:"سمح",ﵟ:"سمح",ﵫ:"سۛمخ",ﵪ:"سۛمخ",ﵣ:"سمم",ﵢ:"سمم",ﵭ:"سۛمم",ﵬ:"سۛمم",ﴗ:"سى",ﳻ:"سى",ﴘ:"سى",ﳼ:"سى",ﴙ:"سۛى",ﳽ:"سۛى",ﴚ:"سۛى",ﳾ:"سۛى","𐋲":"ص","𞸑":"ص","𞸱":"ص","𞹑":"ص","𞹱":"ص","𞺑":"ص","𞺱":"ص",ﺻ:"ص",ﺼ:"ص",ﺺ:"ص",ﺹ:"ص",ڞ:"صۛ","ࢯ":"ص̤̣",ﲱ:"صح",ﰠ:"صح",ﵥ:"صحح",ﵤ:"صحح",ﶩ:"صحى",ﲲ:"صخ",ﴫ:"صر",ﴏ:"صر",ﷵ:"صلعم",ﷹ:"صلى",ﷰ:"صلى",ﷺ:"صلى lللo علىo وسلم",ﲳ:"صم",ﰡ:"صم",ﷅ:"صمم",ﵦ:"صمم",ﴡ:"صى",ﴅ:"صى",ﴢ:"صى",ﴆ:"صى","𞸙":"ض","𞸹":"ض","𞹙":"ض","𞹹":"ض","𞺙":"ض","𞺹":"ض",ﺿ:"ض",ﻀ:"ض",ﺾ:"ض",ﺽ:"ض",ﲴ:"ضج",ﰢ:"ضج",ﲵ:"ضح",ﰣ:"ضح",ﵮ:"ضحى",ﶫ:"ضحى",ﲶ:"ضخ",ﰤ:"ضخ",ﵰ:"ضخم",ﵯ:"ضخم",ﴬ:"ضر",ﴐ:"ضر",ﲷ:"ضم",ﰥ:"ضم",ﴣ:"ضى",ﴇ:"ضى",ﴤ:"ضى",ﴈ:"ضى","𐋨":"ط","𞸈":"ط","𞹨":"ط","𞺈":"ط","𞺨":"ط",ﻃ:"ط",ﻄ:"ط",ﻂ:"ط",ﻁ:"ط",ڟ:"طۛ",ﲸ:"طح",ﰦ:"طح",ﴳ:"طم",ﴺ:"طم",ﰧ:"طم",ﵲ:"طمح",ﵱ:"طمح",ﵳ:"طمم",ﵴ:"طمى",ﴑ:"طى",ﳵ:"طى",ﴒ:"طى",ﳶ:"طى","𞸚":"ظ","𞹺":"ظ","𞺚":"ظ","𞺺":"ظ",ﻇ:"ظ",ﻈ:"ظ",ﻆ:"ظ",ﻅ:"ظ",ﲹ:"ظم",ﴻ:"ظم",ﰨ:"ظم","؏":"ع","𞸏":"ع","𞸯":"ع","𞹏":"ع","𞹯":"ع","𞺏":"ع","𞺯":"ع",ﻋ:"ع",ﻌ:"ع",ﻊ:"ع",ﻉ:"ع",ﲺ:"عج",ﰩ:"عج",ﷄ:"عجم",ﵵ:"عجم",ﷷ:"علىo",ﲻ:"عم",ﰪ:"عم",ﵷ:"عمم",ﵶ:"عمم",ﵸ:"عمى",ﶶ:"عمى",ﴓ:"عى",ﳷ:"عى",ﴔ:"عى",ﳸ:"عى","𞸛":"غ","𞸻":"غ","𞹛":"غ","𞹻":"غ","𞺛":"غ","𞺻":"غ",ﻏ:"غ",ﻐ:"غ",ﻎ:"غ",ﻍ:"غ",ﲼ:"غج",ﰫ:"غج",ﲽ:"غم",ﰬ:"غم",ﵹ:"غمم",ﵻ:"غمى",ﵺ:"غمى",ﴕ:"غى",ﳹ:"غى",ﴖ:"غى",ﳺ:"غى","𞸐":"ف","𞸰":"ف","𞹰":"ف","𞺐":"ف","𞺰":"ف",ﻓ:"ف",ﻔ:"ف",ﻒ:"ف",ﻑ:"ف",ڧ:"ف",ﲾ:"فج",ﰭ:"فج",ﲿ:"فح",ﰮ:"فح",ﳀ:"فخ",ﰯ:"فخ",ﵽ:"فخم",ﵼ:"فخم",ﳁ:"فم",ﰰ:"فم",ﷁ:"فمى",ﱼ:"فى",ﰱ:"فى",ﱽ:"فى",ﰲ:"فى","𞸞":"ڡ","𞹾":"ڡ","ࢻ":"ڡ","ٯ":"ڡ","𞸟":"ڡ","𞹟":"ڡ","ࢼ":"ڡ",ڤ:"ڡۛ",ﭬ:"ڡۛ",ﭭ:"ڡۛ",ﭫ:"ڡۛ",ﭪ:"ڡۛ",ڨ:"ڡۛ","ࢤ":"ڢۛ",ﭰ:"ڦ",ﭱ:"ڦ",ﭯ:"ڦ",ﭮ:"ڦ","𞸒":"ق","𞸲":"ق","𞹒":"ق","𞹲":"ق","𞺒":"ق","𞺲":"ق",ﻗ:"ق",ﻘ:"ق",ﻖ:"ق",ﻕ:"ق",ﳂ:"قح",ﰳ:"قح",ﷱ:"قلى",ﳃ:"قم",ﰴ:"قم",ﶴ:"قمح",ﵾ:"قمح",ﵿ:"قمم",ﶲ:"قمى",ﱾ:"قى",ﰵ:"قى",ﱿ:"قى",ﰶ:"قى","𞸊":"ك","𞸪":"ك","𞹪":"ك",ﻛ:"ك",ﻜ:"ك",ﻚ:"ك",ﻙ:"ك",ک:"ك",ﮐ:"ك",ﮑ:"ك",ﮏ:"ك",ﮎ:"ك",ڪ:"ك",ڭ:"كۛ",ﯕ:"كۛ",ﯖ:"كۛ",ﯔ:"كۛ",ﯓ:"كۛ","ݣ":"كۛ",ﲀ:"كl",ﰷ:"كl",ﳄ:"كج",ﰸ:"كج",ﳅ:"كح",ﰹ:"كح",ﳆ:"كخ",ﰺ:"كخ",ﳇ:"كل",ﳫ:"كل",ﲁ:"كل",ﰻ:"كل",ﳈ:"كم",ﳬ:"كم",ﲂ:"كم",ﰼ:"كم",ﷃ:"كمم",ﶻ:"كمم",ﶷ:"كمى",ﲃ:"كى",ﰽ:"كى",ﲄ:"كى",ﰾ:"كى","ݢ":"ڬ",ﮔ:"گ",ﮕ:"گ",ﮓ:"گ",ﮒ:"گ","ࢰ":"گ",ڴ:"گۛ",ﮜ:"ڱ",ﮝ:"ڱ",ﮛ:"ڱ",ﮚ:"ڱ",ﮘ:"ڳ",ﮙ:"ڳ",ﮗ:"ڳ",ﮖ:"ڳ","𞸋":"ل","𞸫":"ل","𞹋":"ل","𞺋":"ل","𞺫":"ل",ﻟ:"ل",ﻠ:"ل",ﻞ:"ل",ﻝ:"ل",ڷ:"لۛ",ڵ:"ل̆",ﻼ:"لl",ﻻ:"لl",ﻺ:"لlٕ",ﻹ:"لlٕ",ﻸ:"لlٴ",ﻷ:"لlٴ",ﳍ:"لo",ﻶ:"لآ",ﻵ:"لآ",ﳉ:"لج",ﰿ:"لج",ﶃ:"لجج",ﶄ:"لجج",ﶺ:"لجم",ﶼ:"لجم",ﶬ:"لجى",ﳊ:"لح",ﱀ:"لح",ﶵ:"لحم",ﶀ:"لحم",ﶂ:"لحى",ﶁ:"لحى",ﳋ:"لخ",ﱁ:"لخ",ﶆ:"لخم",ﶅ:"لخم",ﳌ:"لم",ﳭ:"لم",ﲅ:"لم",ﱂ:"لم",ﶈ:"لمح",ﶇ:"لمح",ﶭ:"لمى",ﲆ:"لى",ﱃ:"لى",ﲇ:"لى",ﱄ:"لى","𞸌":"م","𞸬":"م","𞹬":"م","𞺌":"م","𞺬":"م",ﻣ:"م",ﻤ:"م",ﻢ:"م",ﻡ:"م","ࢧ":"مۛ","۾":"م͈",ﲈ:"مl",ﳎ:"مج",ﱅ:"مج",ﶌ:"مجح",ﶒ:"مجخ",ﶍ:"مجم",ﷀ:"مجى",ﳏ:"مح",ﱆ:"مح",ﶉ:"محج",ﶊ:"محم",ﷴ:"محمد",ﶋ:"محى",ﳐ:"مخ",ﱇ:"مخ",ﶎ:"مخج",ﶏ:"مخم",ﶹ:"مخى",ﳑ:"مم",ﲉ:"مم",ﱈ:"مم",ﶱ:"ممى",ﱉ:"مى",ﱊ:"مى","𞸍":"ن","𞸭":"ن","𞹍":"ن","𞹭":"ن","𞺍":"ن","𞺭":"ن",ﻧ:"ن",ﻨ:"ن",ﻦ:"ن",ﻥ:"ن","ݨ":"نؕ","ݩ":"ن̆",ﳖ:"نo",ﳯ:"نo",ﶸ:"نجح",ﶽ:"نجح",ﶘ:"نجم",ﶗ:"نجم",ﶙ:"نجى",ﷇ:"نجى",ﳓ:"نح",ﱌ:"نح",ﶕ:"نحم",ﶖ:"نحى",ﶳ:"نحى",ﳔ:"نخ",ﱍ:"نخ",ﲊ:"نر",ﲋ:"نز",ﳕ:"نم",ﳮ:"نم",ﲌ:"نم",ﱎ:"نم",ﶛ:"نمى",ﶚ:"نمى",ﲍ:"نن",ﲎ:"نى",ﱏ:"نى",ﲏ:"نى",ﱐ:"نى",ۂ:"ۀ",ﮥ:"ۀ",ﮤ:"ۀ","𐋤":"و","𞸅":"و","𞺅":"و","𞺥":"و",ﻮ:"و",ﻭ:"و","ࢱ":"و",ۋ:"وۛ",ﯟ:"وۛ",ﯞ:"وۛ",ۇ:"و̓",ﯘ:"و̓",ﯗ:"و̓",ۆ:"و̆",ﯚ:"و̆",ﯙ:"و̆",ۉ:"و̂",ﯣ:"و̂",ﯢ:"و̂",ۈ:"وٰ",ﯜ:"وٰ",ﯛ:"وٰ",ؤ:"وٴ",ﺆ:"وٴ",ﺅ:"وٴ",ٶ:"وٴ",ٷ:"و̓ٴ",ﯝ:"و̓ٴ",ﷸ:"وسلم",ﯡ:"ۅ",ﯠ:"ۅ","ٮ":"ى","𞸜":"ى","𞹼":"ى",ں:"ى","𞸝":"ى","𞹝":"ى",ﮟ:"ى",ﮞ:"ى","ࢽ":"ى",ﯨ:"ى",ﯩ:"ى",ﻰ:"ى",ﻯ:"ى",ي:"ى","𞸉":"ى","𞸩":"ى","𞹉":"ى","𞹩":"ى","𞺉":"ى","𞺩":"ى",ﻳ:"ى",ﻴ:"ى",ﻲ:"ى",ﻱ:"ى",ی:"ى",ﯾ:"ى",ﯿ:"ى",ﯽ:"ى",ﯼ:"ى",ے:"ى",ﮯ:"ى",ﮮ:"ى",ٹ:"ىؕ",ﭨ:"ىؕ",ﭩ:"ىؕ",ﭧ:"ىؕ",ﭦ:"ىؕ",ڻ:"ىؕ",ﮢ:"ىؕ",ﮣ:"ىؕ",ﮡ:"ىؕ",ﮠ:"ىؕ",پ:"ىۛ",ﭘ:"ىۛ",ﭙ:"ىۛ",ﭗ:"ىۛ",ﭖ:"ىۛ",ث:"ىۛ","𞸖":"ىۛ","𞸶":"ىۛ","𞹶":"ىۛ","𞺖":"ىۛ","𞺶":"ىۛ",ﺛ:"ىۛ",ﺜ:"ىۛ",ﺚ:"ىۛ",ﺙ:"ىۛ",ڽ:"ىۛ",ۑ:"ىۛ","ؿ":"ىۛ","ࢷ":"ىۛۢ","ݖ":"ى̆",ێ:"ى̆","ࢺ":"ى̆̇","ؽ":"ى̂","ࢨ":"ىٔ",ﲐ:"ىٰ",ﱝ:"ىٰ",ﳞ:"ىo",ﳱ:"ىo",ﳦ:"ىۛo",ئ:"ىٴ",ﺋ:"ىٴ",ﺌ:"ىٴ",ﺊ:"ىٴ",ﺉ:"ىٴ",ٸ:"ىٴ",ﯫ:"ىٴl",ﯪ:"ىٴl",ﲛ:"ىٴo",ﳠ:"ىٴo",ﯭ:"ىٴo",ﯬ:"ىٴo",ﯸ:"ىٴٻ",ﯷ:"ىٴٻ",ﯶ:"ىٴٻ",ﲗ:"ىٴج",ﰀ:"ىٴج",ﲘ:"ىٴح",ﰁ:"ىٴح",ﲙ:"ىٴخ",ﱤ:"ىٴر",ﱥ:"ىٴز",ﲚ:"ىٴم",ﳟ:"ىٴم",ﱦ:"ىٴم",ﰂ:"ىٴم",ﱧ:"ىٴن",ﯯ:"ىٴو",ﯮ:"ىٴو",ﯱ:"ىٴو̓",ﯰ:"ىٴو̓",ﯳ:"ىٴو̆",ﯲ:"ىٴو̆",ﯵ:"ىٴوٰ",ﯴ:"ىٴوٰ",ﯻ:"ىٴى",ﯺ:"ىٴى",ﱨ:"ىٴى",ﯹ:"ىٴى",ﰃ:"ىٴى",ﱩ:"ىٴى",ﰄ:"ىٴى",ﳚ:"ىج",ﱕ:"ىج",ﰑ:"ىۛج",ﶯ:"ىجى",ﳛ:"ىح",ﱖ:"ىح",ﶮ:"ىحى",ﳜ:"ىخ",ﱗ:"ىخ",ﲑ:"ىر",ﱶ:"ىۛر",ﲒ:"ىز",ﱷ:"ىۛز",ﳝ:"ىم",ﳰ:"ىم",ﲓ:"ىم",ﱘ:"ىم",ﲦ:"ىۛم",ﳥ:"ىۛم",ﱸ:"ىۛم",ﰒ:"ىۛم",ﶝ:"ىمم",ﶜ:"ىمم",ﶰ:"ىمى",ﲔ:"ىن",ﱹ:"ىۛن",ﲕ:"ىى",ﱙ:"ىى",ﲖ:"ىى",ﱚ:"ىى",ﱺ:"ىۛى",ﰓ:"ىۛى",ﱻ:"ىۛى",ﰔ:"ىۛى",ﮱ:"ۓ",ﮰ:"ۓ","𐊸":"ⵀ","⁞":"ⵂ","⸽":"ⵂ","⦙":"ⵂ","︙":"ⵗ","⁝":"ⵗ","⋮":"ⵗ",Մ:"ሆ",Ռ:"ቡ",Ի:"ኮ",Պ:"ጣ",आ:"अा",ऒ:"अाॆ",ओ:"अाे",औ:"अाै","ऄ":"अॆ",ऑ:"अॉ",ऍ:"एॅ",ऎ:"एॆ",ऐ:"एे",ई:"र्इ",ઽ:"ऽ","𑇜":"ꣻ","𑇋":"ऺ","ુ":"ु","ૂ":"ू","ੋ":"ॆ","੍":"्","્":"्",আ:"অা",ৠ:"ঋৃ",ৡ:"ঋৃ","𑒒":"ঘ","𑒔":"চ","𑒖":"জ","𑒘":"ঞ","𑒙":"ট","𑒛":"ড","𑒪":"ণ","𑒞":"ত","𑒟":"থ","𑒠":"দ","𑒡":"ধ","𑒢":"ন","𑒣":"প","𑒩":"ব","𑒧":"ম","𑒨":"য","𑒫":"র","𑒝":"ল","𑒭":"ষ","𑒮":"স","𑓄":"ঽ","𑒰":"া","𑒱":"ি","𑒹":"ে","𑒼":"ো","𑒾":"ৌ","𑓂":"্","𑒽":"ৗ",ਉ:"ੳੁ",ਊ:"ੳੂ",ਆ:"ਅਾ",ਐ:"ਅੈ",ਔ:"ਅੌ",ਇ:"ੲਿ",ਈ:"ੲੀ",ਏ:"ੲੇ",આ:"અા",ઑ:"અાૅ",ઓ:"અાે",ઔ:"અાૈ",ઍ:"અૅ",એ:"અે",ઐ:"અૈ",ଆ:"ଅା","௮":"அ",ர:"ஈ","ா":"ஈ","௫":"ஈு","௨":"உ",ഉ:"உ",ஊ:"உள",ഊ:"உൗ","௭":"எ","௷":"எவ",ஜ:"ஐ",ജ:"ஐ","௧":"க","௪":"ச","௬":"சு","௲":"சூ","ഺ":"டி",ണ:"ண","௺":"நீ","௴":"மீ","௰":"ய",ഴ:"ழ","ௗ":"ள","ை":"ன",ശ:"ஶ","௸":"ஷ","ി":"ி","ീ":"ி","ொ":"ெஈ","ௌ":"ெள","ோ":"ேஈ",ಅ:"అ",ಆ:"ఆ",ಇ:"ఇ",ౠ:"ఋా",ౡ:"ఌా",ಒ:"ఒ",ఔ:"ఒౌ",ಔ:"ఒౌ",ఓ:"ఒౕ",ಓ:"ఒౕ",ಜ:"జ",ಞ:"ఞ",ఢ:"డ̣",ಣ:"ణ",థ:"ధּ",భ:"బ̣",ಯ:"య",ఠ:"రּ",ಱ:"ఱ",ಲ:"ల",ష:"వ̣",హ:"వా",మ:"వు","ూ":"ుా","ౄ":"ృా",ೡ:"ಌಾ",ഈ:"ഇൗ",ഐ:"എെ",ഓ:"ഒാ",ഔ:"ഒൗ",ൡ:"ഞ","൫":"ദ്ര","൹":"നു",ഌ:"നു",ങ:"നു","൯":"ന്","ൻ":"ന്","൬":"ന്ന","൚":"ന്മ",റ:"ര","൪":"ര്","ർ":"ര്","൮":"വ്ര","൶":"ഹ്മ","ൂ":"ു","ൃ":"ു","ൈ":"െെ","෪":"ජ","෫":"ද","𑐓":"𑐴𑑂𑐒","𑐙":"𑐴𑑂𑐘","𑐤":"𑐴𑑂𑐣","𑐪":"𑐴𑑂𑐩","𑐭":"𑐴𑑂𑐬","𑐯":"𑐴𑑂𑐮","𑗘":"𑖂","𑗙":"𑖂","𑗚":"𑖃","𑗛":"𑖄","𑗜":"𑖲","𑗝":"𑖳",ฃ:"ข",ด:"ค",ต:"ค",ม:"ฆ",ຈ:"จ",ซ:"ช",ฏ:"ฎ",ท:"ฑ",ບ:"บ",ປ:"ป",ຝ:"ฝ",ພ:"พ",ຟ:"ฟ",ฦ:"ภ",ຍ:"ย","។":"ฯ",ๅ:"า",ำ:"̊า","ិ":"ิ","ី":"ี","ឹ":"ึ","ឺ":"ื","ຸ":"ุ","ູ":"ู",แ:"เเ",ໜ:"ຫນ",ໝ:"ຫມ",ຳ:"̊າ","༂":"འུྂཿ","༃":"འུྂ༔",ཪ:"ར",ༀ:"ཨོཾ","ཷ":"ྲཱྀ","ཹ":"ླཱྀ","𑲲":"𑲪","ႁ":"ဂှ",က:"ဂာ","ၰ":"ဃှ","ၦ":"ပှ",ဟ:"ပာ","ၯ":"ပာှ","ၾ":"ၽှ",ဩ:"သြ",ဪ:"သြော်","႞":"ႃ̊",ឣ:"អ","᧐":"ᦞ","᧑":"ᦱ","᪀":"ᩅ","᪐":"ᩅ","꩓":"ꨁ","꩖":"ꨣ","᭒":"ᬍ","᭓":"ᬑ","᭘":"ᬨ","ꦣ":"ꦝ",ᢖ:"ᡜ",ᡕ:"ᠵ",ῶ:"Ꮿ",ᐍ:"ᐁ·",ᐫ:"ᐁᐠ",ᐑ:"ᐄ·",ᐓ:"ᐅ·",ᐭ:"ᐅᐠ",ᐕ:"ᐆ·",ᐘ:"ᐊ·",ᐮ:"ᐊᐠ",ᐚ:"ᐋ·","ᣝ":"ᐞᣟ",ᓑ:"ᐡ",ᕀ:"ᐩ",ᐿ:"ᐲ·",ᑃ:"ᐴ·","⍩":"ᐵ",ᑇ:"ᐹ·",ᑜ:"ᑏ·","⸧":"ᑐ","⊃":"ᑐ",ᑞ:"ᑐ·",ᑩ:"ᑐ'","⟉":"ᑐ/","⫗":"ᑐᑕ",ᑠ:"ᑑ·","⸦":"ᑕ","⊂":"ᑕ",ᑢ:"ᑕ·",ᑪ:"ᑕ'",ᑤ:"ᑖ·",ᑵ:"ᑫ·",ᒅ:"ᑫ'",ᑹ:"ᑮ·",ᑽ:"ᑰ·",ᘃ:"ᒉ",ᒓ:"ᒉ·",ᒕ:"ᒋ·",ᒗ:"ᒌ·",ᒛ:"ᒎ·",ᘂ:"ᒐ",ᒝ:"ᒐ·",ᒟ:"ᒑ·",ᒭ:"ᒣ·",ᒱ:"ᒦ·",ᒳ:"ᒧ·",ᒵ:"ᒨ·",ᒹ:"ᒫ·",ᓊ:"ᓀ·","ᣇ":"ᓂ·","ᣉ":"ᓃ·","ᣋ":"ᓄ·","ᣍ":"ᓅ·",ᓌ:"ᓇ·",ᓎ:"ᓈ·",ᘄ:"ᓓ",ᓝ:"ᓓ·",ᓟ:"ᓕ·",ᓡ:"ᓖ·",ᓣ:"ᓗ·",ᓥ:"ᓘ·",ᘇ:"ᓚ",ᓧ:"ᓚ·",ᓩ:"ᓛ·",ᓷ:"ᓭ·",ᓹ:"ᓯ·",ᓻ:"ᓰ·",ᓽ:"ᓱ·",ᓿ:"ᓲ·",ᔁ:"ᓴ·",ᔃ:"ᓵ·",ᔌ:"ᔋ<",ᔎ:"ᔋb",ᔍ:"ᔋᑕ",ᔏ:"ᔋᒐ",ᔘ:"ᔐ·",ᔚ:"ᔑ·",ᔜ:"ᔒ·",ᔞ:"ᔓ·",ᔠ:"ᔔ·",ᔢ:"ᔕ·",ᔤ:"ᔖ·",ᔲ:"ᔨ·",ᔴ:"ᔩ·",ᔶ:"ᔪ·",ᔸ:"ᔫ·",ᔺ:"ᔭ·",ᔼ:"ᔮ·",ᘢ:"ᕃ","ᣠ":"ᕃ·",ᘣ:"ᕆ",ᘤ:"ᕊ",ᕏ:"ᕌ·",ᖃ:"ᕐb",ᖄ:"ᕐḃ",ᖁ:"ᕐd",ᕿ:"ᕐP",ᙯ:"ᕐᑫ",ᕾ:"ᕐᑬ",ᖀ:"ᕐᑮ",ᖂ:"ᕐᑰ",ᖅ:"ᕐᒃ",ᕜ:"ᕚ·","ᣣ":"ᕞ·","ᣤ":"ᕦ·",ᕩ:"ᕧ·","ᣥ":"ᕫ·","ᣨ":"ᖆ·",ᖑ:"ᖕJ",ᙰ:"ᖕᒉ",ᖎ:"ᖕᒊ",ᖏ:"ᖕᒋ",ᖐ:"ᖕᒌ",ᖒ:"ᖕᒎ",ᖓ:"ᖕᒐ",ᖔ:"ᖕᒑ",ᙳ:"ᖖJ",ᙱ:"ᖖᒋ",ᙲ:"ᖖᒌ",ᙴ:"ᖖᒎ",ᙵ:"ᖖᒐ",ᙶ:"ᖖᒑ","ᣪ":"ᖗ·","ᙷ":"ᖧ·","ᙸ":"ᖨ·","ᙹ":"ᖩ·","ᙺ":"ᖪ·","ᙻ":"ᖫ·","ᙼ":"ᖬ·","ᙽ":"ᖭ·","⪫":"ᗒ","⪪":"ᗕ","ꓷ":"ᗡ","ᣰ":"ᗴ·","ᣲ":"ᘛ·","ᶻ":"ᙆ","ꓭ":"ᙠ","ᶺ":"ᣔ","ᴾ":"ᣖ","ᣜ":"ᣟᐞ",ˡ:"ᣳ",ʳ:"ᣴ",ˢ:"ᣵ","ᣛ":"ᣵ","ꚰ":"ᚹ",ᛡ:"ᚼ","⍿":"ᚽ",ᛂ:"ᚽ","𝈿":"ᛋ","↑":"ᛏ","↿":"ᛐ","⥮":"ᛐ⇂","⥣":"ᛐᛚ","ⵣ":"ᛯ","↾":"ᛚ","⨡":"ᛚ","⋄":"ᛜ","◇":"ᛜ","◊":"ᛜ","♢":"ᛜ","🝔":"ᛜ","𑢷":"ᛜ","𐊔":"ᛜ","⍚":"ᛜ̲","⋈":"ᛞ","⨝":"ᛞ","𐓐":"ᛦ","↕":"ᛨ","𐳼":"𐲂","𐳺":"𐲥",ㄱ:"ᄀ",ᆨ:"ᄀ",ᄁ:"ᄀᄀ",ㄲ:"ᄀᄀ",ᆩ:"ᄀᄀ","ᇺ":"ᄀᄂ","ᅚ":"ᄀᄃ",ᇃ:"ᄀᄅ","ᇻ":"ᄀᄇ",ᆪ:"ᄀᄉ",ㄳ:"ᄀᄉ",ᇄ:"ᄀᄉᄀ","ᇼ":"ᄀᄎ","ᇽ":"ᄀᄏ","ᇾ":"ᄀᄒ",ㄴ:"ᄂ",ᆫ:"ᄂ",ᄓ:"ᄂᄀ",ᇅ:"ᄂᄀ",ᄔ:"ᄂᄂ",ㅥ:"ᄂᄂ","ᇿ":"ᄂᄂ",ᄕ:"ᄂᄃ",ㅦ:"ᄂᄃ",ᇆ:"ᄂᄃ","ퟋ":"ᄂᄅ",ᄖ:"ᄂᄇ","ᅛ":"ᄂᄉ",ᇇ:"ᄂᄉ",ㅧ:"ᄂᄉ","ᅜ":"ᄂᄌ",ᆬ:"ᄂᄌ",ㄵ:"ᄂᄌ","ퟌ":"ᄂᄎ",ᇉ:"ᄂᄐ","ᅝ":"ᄂᄒ",ᆭ:"ᄂᄒ",ㄶ:"ᄂᄒ",ᇈ:"ᄂᅀ",ㅨ:"ᄂᅀ",ㄷ:"ᄃ",ᆮ:"ᄃ",ᄗ:"ᄃᄀ",ᇊ:"ᄃᄀ",ᄄ:"ᄃᄃ",ㄸ:"ᄃᄃ","ퟍ":"ᄃᄃ","ퟎ":"ᄃᄃᄇ","ᅞ":"ᄃᄅ",ᇋ:"ᄃᄅ","ꥠ":"ᄃᄆ","ꥡ":"ᄃᄇ","ퟏ":"ᄃᄇ","ꥢ":"ᄃᄉ","ퟐ":"ᄃᄉ","ퟑ":"ᄃᄉᄀ","ꥣ":"ᄃᄌ","ퟒ":"ᄃᄌ","ퟓ":"ᄃᄎ","ퟔ":"ᄃᄐ",ㄹ:"ᄅ",ᆯ:"ᄅ","ꥤ":"ᄅᄀ",ᆰ:"ᄅᄀ",ㄺ:"ᄅᄀ","ꥥ":"ᄅᄀᄀ","ퟕ":"ᄅᄀᄀ",ᇌ:"ᄅᄀᄉ",ㅩ:"ᄅᄀᄉ","ퟖ":"ᄅᄀᄒ",ᄘ:"ᄅᄂ",ᇍ:"ᄅᄂ","ꥦ":"ᄅᄃ",ᇎ:"ᄅᄃ",ㅪ:"ᄅᄃ","ꥧ":"ᄅᄃᄃ",ᇏ:"ᄅᄃᄒ",ᄙ:"ᄅᄅ",ᇐ:"ᄅᄅ","ퟗ":"ᄅᄅᄏ","ꥨ":"ᄅᄆ",ᆱ:"ᄅᄆ",ㄻ:"ᄅᄆ",ᇑ:"ᄅᄆᄀ",ᇒ:"ᄅᄆᄉ","ퟘ":"ᄅᄆᄒ","ꥩ":"ᄅᄇ",ᆲ:"ᄅᄇ",ㄼ:"ᄅᄇ","ퟙ":"ᄅᄇᄃ","ꥪ":"ᄅᄇᄇ",ᇓ:"ᄅᄇᄉ",ㅫ:"ᄅᄇᄉ","ꥫ":"ᄅᄇᄋ",ᇕ:"ᄅᄇᄋ","ퟚ":"ᄅᄇᄑ",ᇔ:"ᄅᄇᄒ","ꥬ":"ᄅᄉ",ᆳ:"ᄅᄉ",ㄽ:"ᄅᄉ",ᇖ:"ᄅᄉᄉ",ᄛ:"ᄅᄋ","ퟝ":"ᄅᄋ","ꥭ":"ᄅᄌ","ꥮ":"ᄅᄏ",ᇘ:"ᄅᄏ",ᆴ:"ᄅᄐ",ㄾ:"ᄅᄐ",ᆵ:"ᄅᄑ",ㄿ:"ᄅᄑ",ᄚ:"ᄅᄒ",ㅀ:"ᄅᄒ",ᄻ:"ᄅᄒ",ᆶ:"ᄅᄒ","ퟲ":"ᄅᄒ",ᇗ:"ᄅᅀ",ㅬ:"ᄅᅀ","ퟛ":"ᄅᅌ",ᇙ:"ᄅᅙ",ㅭ:"ᄅᅙ","ퟜ":"ᄅᅙᄒ",ㅁ:"ᄆ",ᆷ:"ᄆ","ꥯ":"ᄆᄀ",ᇚ:"ᄆᄀ","ퟞ":"ᄆᄂ","ퟟ":"ᄆᄂᄂ","ꥰ":"ᄆᄃ",ᇛ:"ᄆᄅ","ퟠ":"ᄆᄆ",ᄜ:"ᄆᄇ",ㅮ:"ᄆᄇ",ᇜ:"ᄆᄇ","ퟡ":"ᄆᄇᄉ","ꥱ":"ᄆᄉ",ᇝ:"ᄆᄉ",ㅯ:"ᄆᄉ",ᇞ:"ᄆᄉᄉ",ᄝ:"ᄆᄋ",ㅱ:"ᄆᄋ",ᇢ:"ᄆᄋ","ퟢ":"ᄆᄌ",ᇠ:"ᄆᄎ",ᇡ:"ᄆᄒ",ᇟ:"ᄆᅀ",ㅰ:"ᄆᅀ",ㅂ:"ᄇ",ᆸ:"ᄇ",ᄞ:"ᄇᄀ",ㅲ:"ᄇᄀ",ᄟ:"ᄇᄂ",ᄠ:"ᄇᄃ",ㅳ:"ᄇᄃ","ퟣ":"ᄇᄃ",ᇣ:"ᄇᄅ","ퟤ":"ᄇᄅᄑ","ퟥ":"ᄇᄆ",ᄈ:"ᄇᄇ",ㅃ:"ᄇᄇ","ퟦ":"ᄇᄇ",ᄬ:"ᄇᄇᄋ",ㅹ:"ᄇᄇᄋ",ᄡ:"ᄇᄉ",ㅄ:"ᄇᄉ",ᆹ:"ᄇᄉ",ᄢ:"ᄇᄉᄀ",ㅴ:"ᄇᄉᄀ",ᄣ:"ᄇᄉᄃ",ㅵ:"ᄇᄉᄃ","ퟧ":"ᄇᄉᄃ",ᄤ:"ᄇᄉᄇ",ᄥ:"ᄇᄉᄉ",ᄦ:"ᄇᄉᄌ","ꥲ":"ᄇᄉᄐ",ᄫ:"ᄇᄋ",ㅸ:"ᄇᄋ",ᇦ:"ᄇᄋ",ᄧ:"ᄇᄌ",ㅶ:"ᄇᄌ","ퟨ":"ᄇᄌ",ᄨ:"ᄇᄎ","ퟩ":"ᄇᄎ","ꥳ":"ᄇᄏ",ᄩ:"ᄇᄐ",ㅷ:"ᄇᄐ",ᄪ:"ᄇᄑ",ᇤ:"ᄇᄑ","ꥴ":"ᄇᄒ",ᇥ:"ᄇᄒ",ㅅ:"ᄉ",ᆺ:"ᄉ",ᄭ:"ᄉᄀ",ㅺ:"ᄉᄀ",ᇧ:"ᄉᄀ",ᄮ:"ᄉᄂ",ㅻ:"ᄉᄂ",ᄯ:"ᄉᄃ",ㅼ:"ᄉᄃ",ᇨ:"ᄉᄃ",ᄰ:"ᄉᄅ",ᇩ:"ᄉᄅ",ᄱ:"ᄉᄆ","ퟪ":"ᄉᄆ",ᄲ:"ᄉᄇ",ㅽ:"ᄉᄇ",ᇪ:"ᄉᄇ",ᄳ:"ᄉᄇᄀ","ퟫ":"ᄉᄇᄋ",ᄊ:"ᄉᄉ",ㅆ:"ᄉᄉ",ᆻ:"ᄉᄉ","ퟬ":"ᄉᄉᄀ","ퟭ":"ᄉᄉᄃ","ꥵ":"ᄉᄉᄇ",ᄴ:"ᄉᄉᄉ",ᄵ:"ᄉᄋ",ᄶ:"ᄉᄌ",ㅾ:"ᄉᄌ","ퟯ":"ᄉᄌ",ᄷ:"ᄉᄎ","ퟰ":"ᄉᄎ",ᄸ:"ᄉᄏ",ᄹ:"ᄉᄐ","ퟱ":"ᄉᄐ",ᄺ:"ᄉᄑ","ퟮ":"ᄉᅀ",ㅇ:"ᄋ",ᆼ:"ᄋ",ᅁ:"ᄋᄀ",ᇬ:"ᄋᄀ",ᇭ:"ᄋᄀᄀ",ᅂ:"ᄋᄃ","ꥶ":"ᄋᄅ",ᅃ:"ᄋᄆ",ᅄ:"ᄋᄇ",ᅅ:"ᄋᄉ",ᇱ:"ᄋᄉ",ㆂ:"ᄋᄉ",ᅇ:"ᄋᄋ",ㆀ:"ᄋᄋ",ᇮ:"ᄋᄋ",ᅈ:"ᄋᄌ",ᅉ:"ᄋᄎ",ᇯ:"ᄋᄏ",ᅊ:"ᄋᄐ",ᅋ:"ᄋᄑ","ꥷ":"ᄋᄒ",ᅆ:"ᄋᅀ",ᇲ:"ᄋᅀ",ㆃ:"ᄋᅀ",ㅈ:"ᄌ",ᆽ:"ᄌ","ퟷ":"ᄌᄇ","ퟸ":"ᄌᄇᄇ",ᅍ:"ᄌᄋ",ᄍ:"ᄌᄌ",ㅉ:"ᄌᄌ","ퟹ":"ᄌᄌ","ꥸ":"ᄌᄌᄒ",ㅊ:"ᄎ",ᆾ:"ᄎ",ᅒ:"ᄎᄏ",ᅓ:"ᄎᄒ",ㅋ:"ᄏ",ᆿ:"ᄏ",ㅌ:"ᄐ",ᇀ:"ᄐ","ꥹ":"ᄐᄐ",ㅍ:"ᄑ",ᇁ:"ᄑ",ᅖ:"ᄑᄇ",ᇳ:"ᄑᄇ","ퟺ":"ᄑᄉ",ᅗ:"ᄑᄋ",ㆄ:"ᄑᄋ",ᇴ:"ᄑᄋ","ퟻ":"ᄑᄐ","ꥺ":"ᄑᄒ",ㅎ:"ᄒ",ᇂ:"ᄒ",ᇵ:"ᄒᄂ",ᇶ:"ᄒᄅ",ᇷ:"ᄒᄆ",ᇸ:"ᄒᄇ","ꥻ":"ᄒᄉ",ᅘ:"ᄒᄒ",ㆅ:"ᄒᄒ",ᄽ:"ᄼᄼ",ᄿ:"ᄾᄾ",ㅿ:"ᅀ",ᇫ:"ᅀ","ퟳ":"ᅀᄇ","ퟴ":"ᅀᄇᄋ",ㆁ:"ᅌ",ᇰ:"ᅌ","ퟵ":"ᅌᄆ","ퟶ":"ᅌᄒ",ᅏ:"ᅎᅎ",ᅑ:"ᅐᅐ",ㆆ:"ᅙ",ᇹ:"ᅙ","ꥼ":"ᅙᅙ",ㅤ:"ᅠ",ㅏ:"ᅡ","ᆣ":"ᅡー",ᅶ:"ᅡᅩ",ᅷ:"ᅡᅮ",ᅢ:"ᅡ丨",ㅐ:"ᅡ丨",ㅑ:"ᅣ",ᅸ:"ᅣᅩ",ᅹ:"ᅣᅭ","ᆤ":"ᅣᅮ",ᅤ:"ᅣ丨",ㅒ:"ᅣ丨",ㅓ:"ᅥ",ᅼ:"ᅥー",ᅺ:"ᅥᅩ",ᅻ:"ᅥᅮ",ᅦ:"ᅥ丨",ㅔ:"ᅥ丨",ㅕ:"ᅧ","ᆥ":"ᅧᅣ",ᅽ:"ᅧᅩ",ᅾ:"ᅧᅮ",ᅨ:"ᅧ丨",ㅖ:"ᅧ丨",ㅗ:"ᅩ",ᅪ:"ᅩᅡ",ㅘ:"ᅩᅡ",ᅫ:"ᅩᅡ丨",ㅙ:"ᅩᅡ丨","ᆦ":"ᅩᅣ","ᆧ":"ᅩᅣ丨",ᅿ:"ᅩᅥ",ᆀ:"ᅩᅥ丨","ힰ":"ᅩᅧ",ᆁ:"ᅩᅧ丨",ᆂ:"ᅩᅩ","ힱ":"ᅩᅩ丨",ᆃ:"ᅩᅮ",ᅬ:"ᅩ丨",ㅚ:"ᅩ丨",ㅛ:"ᅭ","ힲ":"ᅭᅡ","ힳ":"ᅭᅡ丨",ᆄ:"ᅭᅣ",ㆇ:"ᅭᅣ",ᆆ:"ᅭᅣ",ᆅ:"ᅭᅣ丨",ㆈ:"ᅭᅣ丨","ힴ":"ᅭᅥ",ᆇ:"ᅭᅩ",ᆈ:"ᅭ丨",ㆉ:"ᅭ丨",ㅜ:"ᅮ",ᆉ:"ᅮᅡ",ᆊ:"ᅮᅡ丨",ᅯ:"ᅮᅥ",ㅝ:"ᅮᅥ",ᆋ:"ᅮᅥー",ᅰ:"ᅮᅥ丨",ㅞ:"ᅮᅥ丨","ힵ":"ᅮᅧ",ᆌ:"ᅮᅧ丨",ᆍ:"ᅮᅮ",ᅱ:"ᅮ丨",ㅟ:"ᅮ丨","ힶ":"ᅮ丨丨",ㅠ:"ᅲ",ᆎ:"ᅲᅡ","ힷ":"ᅲᅡ丨",ᆏ:"ᅲᅥ",ᆐ:"ᅲᅥ丨",ᆑ:"ᅲᅧ",ㆊ:"ᅲᅧ",ᆒ:"ᅲᅧ丨",ㆋ:"ᅲᅧ丨","ힸ":"ᅲᅩ",ᆓ:"ᅲᅮ",ᆔ:"ᅲ丨",ㆌ:"ᅲ丨",ㆍ:"ᆞ","ퟅ":"ᆞᅡ",ᆟ:"ᆞᅥ","ퟆ":"ᆞᅥ丨",ᆠ:"ᆞᅮ",ᆢ:"ᆞᆞ",ᆡ:"ᆞ丨",ㆎ:"ᆞ丨",ヘ:"へ","⍁":"〼","⧄":"〼","꒞":"ꁊ","꒬":"ꁐ","꒜":"ꃀ","꒨":"ꄲ","꒿":"ꉙ","꒾":"ꊱ","꒔":"ꋍ","꓀":"ꎫ","꓂":"ꎵ","꒺":"ꎿ","꒰":"ꏂ","꒧":"ꑘ","⊥":"ꓕ","⟂":"ꓕ","𝈜":"ꓕ","Ʇ":"ꓕ","Ꞟ":"ꓤ","⅁":"ꓨ","⅂":"ꓶ","𝈕":"ꓶ","𝈫":"ꓶ","𖼦":"ꓶ","𐐑":"ꓶ","⅃":"𖼀","𑫦":"𑫥𑫯","𑫨":"𑫥𑫥","𑫩":"𑫥𑫥𑫯","𑫪":"𑫥𑫥𑫰","𑫧":"𑫥𑫰","𑫴":"𑫳𑫯","𑫶":"𑫳𑫳","𑫷":"𑫳𑫳𑫯","𑫸":"𑫳𑫳𑫰","𑫵":"𑫳𑫰","𑫬":"𑫫𑫯","𑫭":"𑫫𑫫","𑫮":"𑫫𑫫𑫯","⊕":"𐊨","⨁":"𐊨","🜨":"𐊨","Ꚛ":"𐊨","▽":"𐊼","𝈔":"𐊼","🜄":"𐊼","⧖":"𐋀","ꞛ":"𐐺","Ꞛ":"𐐒","𐒠":"𐒆","𐏑":"𐎂","𐏓":"𐎓","𒀸":"𐎚","☥":"𐦞","𓋹":"𐦞","〹":"卄",不:"不","丽":"丽","並":"並","⎜":"丨","⎟":"丨","⎢":"丨","⎥":"丨","⎪":"丨","⎮":"丨","㇑":"丨",ᅵ:"丨",ㅣ:"丨","⼁":"丨",ᆜ:"丨ー",ᆘ:"丨ᅡ",ᆙ:"丨ᅣ","ힽ":"丨ᅣᅩ","ힾ":"丨ᅣ丨","ힿ":"丨ᅧ","ퟀ":"丨ᅧ丨",ᆚ:"丨ᅩ","ퟁ":"丨ᅩ丨","ퟂ":"丨ᅭ",ᆛ:"丨ᅮ","ퟃ":"丨ᅲ",ᆝ:"丨ᆞ","ퟄ":"丨丨",串:"串","丸":"丸",丹:"丹","乁":"乁","㇠":"乙","⼄":"乙","㇟":"乚","⺃":"乚","㇖":"乛","⺂":"乛","⻲":"亀",亂:"亂","㇚":"亅","⼅":"亅",了:"了",ニ:"二","⼆":"二","𠄢":"𠄢","⼇":"亠",亮:"亮","⼈":"人",イ:"亻","⺅":"亻",什:"什","仌":"仌",令:"令","你":"你",倂:"併","倂":"併","侀":"侀",來:"來",例:"例","侮":"侮","侮":"侮","侻":"侻",便:"便",值:"値",倫:"倫","偺":"偺","備":"備","像":"像",僚:"僚","僧":"僧","僧":"僧","㒞":"㒞","⼉":"儿",兀:"兀","⺎":"兀","充":"充","免":"免","免":"免","兔":"兔","兤":"兤","⼊":"入","內":"內","全":"全",兩:"兩",ハ:"八","⼋":"八",六:"六","具":"具","𠔜":"𠔜","𠔥":"𠔥","冀":"冀","㒹":"㒹","⼌":"冂","再":"再","𠕋":"𠕋","冒":"冒","冕":"冕","㒻":"㒻","最":"最","⼍":"冖","冗":"冗","冤":"冤","⼎":"冫","冬":"冬","况":"况","况":"况",冷:"冷",凉:"凉",凌:"凌",凜:"凜",凞:"凞","⼏":"几","𠘺":"𠘺","凵":"凵","⼐":"凵","⼑":"刀","⺉":"刂","刃":"刃",切:"切","切":"切",列:"列",利:"利","㓟":"㓟",刺:"刺","刻":"刻","剆":"剆","割":"割","剷":"剷",劉:"劉","𠠄":"𠠄",カ:"力",力:"力","⼒":"力",劣:"劣","㔕":"㔕","劳":"劳","勇":"勇","勇":"勇","勉":"勉","勉":"勉",勒:"勒",勞:"勞","勤":"勤","勤":"勤",勵:"勵","⼓":"勹","勺":"勺","勺":"勺","包":"包","匆":"匆","𠣞":"𠣞","⼔":"匕",北:"北","北":"北","⼕":"匚","⼖":"匸",匿:"匿","⼗":"十","〸":"十","〺":"卅","卉":"卉","࿖":"卍","࿕":"卐","卑":"卑","卑":"卑","博":"博",ト:"卜","⼘":"卜","⼙":"卩","⺋":"㔾","即":"即",卵:"卵","卽":"卽","卿":"卿","卿":"卿","卿":"卿","⼚":"厂","𠨬":"𠨬","⼛":"厶",參:"參","⼜":"又","及":"及","叟":"叟","𠭣":"𠭣",ロ:"口","⼝":"口",囗:"口","⼞":"口",句:"句","叫":"叫","叱":"叱","吆":"吆",吏:"吏",吝:"吝","吸":"吸",呂:"呂","呈":"呈","周":"周","咞":"咞","咢":"咢",咽:"咽",䎛:"㖈","哶":"哶","唐":"唐","啓":"啓",啟:"啓","啕":"啕","啣":"啣","善":"善","善":"善",喇:"喇","喙":"喙","喙":"喙","喝":"喝","喝":"喝","喫":"喫","喳":"喳",嗀:"嗀","嗂":"嗂","嗢":"嗢","嘆":"嘆","嘆":"嘆","噑":"噑","噴":"噴","器":"器",囹:"囹","圖":"圖","圗":"圗","⼟":"土",士:"土","⼠":"土","型":"型","城":"城",㦳:"㘽","埴":"埴","堍":"堍","報":"報","堲":"堲","塀":"塀",塚:"塚","塚":"塚",塞:"塞",填:"塡",壿:"墫","墬":"墬","墳":"墳",壘:"壘",壟:"壟","𡓤":"𡓤","壮":"壮","売":"売","壷":"壷","⼡":"夂","夆":"夆","⼢":"夊",タ:"夕","⼣":"夕","多":"多","夢":"夢","⼤":"大","奄":"奄",奈:"奈",契:"契","奔":"奔","奢":"奢",女:"女","⼥":"女","𡚨":"𡚨","𡛪":"𡛪","姘":"姘","姬":"姬","娛":"娛","娧":"娧","婢":"婢","婦":"婦",嬀:"媯","㛮":"㛮","㛼":"㛼","媵":"媵","嬈":"嬈","嬨":"嬨","嬾":"嬾","嬾":"嬾","⼦":"子","⼧":"宀",宅:"宅","𡧈":"𡧈","寃":"寃","寘":"寘",寧:"寧",寧:"寧","寧":"寧",寮:"寮","寳":"寳","𡬘":"𡬘","⼨":"寸","寿":"寿","将":"将","⼩":"小","尢":"尢","⺐":"尢","⼪":"尢","⺏":"尣","㞁":"㞁","⼫":"尸",尿:"尿","屠":"屠",屢:"屢","層":"層",履:"履","屮":"屮","屮":"屮","⼬":"屮","𡴋":"𡴋","⼭":"山","峀":"峀","岍":"岍","𡷤":"𡷤","𡷦":"𡷦",崙:"崙","嵃":"嵃",嵐:"嵐","嵫":"嵫","嵮":"嵮","嵼":"嵼","嶲":"嶲",嶺:"嶺","⼮":"巛","巢":"巢",エ:"工","⼯":"工","⼰":"己","⺒":"巳","㠯":"㠯","巽":"巽","⼱":"巾",帲:"帡","帨":"帨","帽":"帽","幩":"幩","㡢":"㡢","𢆃":"𢆃","⼲":"干",年:"年","𢆟":"𢆟","⺓":"幺","⼳":"幺","⼴":"广",度:"度","㡼":"㡼","庰":"庰","庳":"庳","庶":"庶",廊:"廊","廊":"廊",廉:"廉","廒":"廒",廓:"廓","廙":"廙",廬:"廬","⼵":"廴","廾":"廾","⼶":"廾","𢌱":"𢌱","𢌱":"𢌱",弄:"弄","⼷":"弋","⼸":"弓","弢":"弢","弢":"弢","⼹":"彐","⺔":"彑","当":"当","㣇":"㣇","⼺":"彡","形":"形","彩":"彩","彫":"彫","⼻":"彳",律:"律","㣣":"㣣","徚":"徚",復:"復","徭":"徭","⼼":"心","⺖":"忄","⺗":"㣺","忍":"忍","志":"志",念:"念","忹":"忹",怒:"怒",怜:"怜","恵":"恵","㤜":"㤜","㤺":"㤺","悁":"悁","悔":"悔","悔":"悔","惇":"惇","惘":"惘",惡:"惡","𢛔":"𢛔","愈":"愈","慨":"慨",慄:"慄","慈":"慈","慌":"慌","慌":"慌","慎":"慎","慎":"慎","慠":"慠","慺":"慺","憎":"憎","憎":"憎","憎":"憎",憐:"憐","憤":"憤","憯":"憯","憲":"憲","𢡄":"𢡄","𢡊":"𢡊","懞":"懞","懲":"懲","懲":"懲","懲":"懲",懶:"懶","懶":"懶",戀:"戀","⼽":"戈","成":"成","戛":"戛",戮:"戮","戴":"戴","⼾":"戶",戸:"戶","⼿":"手","⺘":"扌","扝":"扝","抱":"抱",拉:"拉",拏:"拏",拓:"拓","拔":"拔","拼":"拼",拾:"拾","𢬌":"𢬌","挽":"挽","捐":"捐","捨":"捨",捻:"捻","掃":"掃",掠:"掠","掩":"掩","揄":"揄","揤":"揤","摒":"摒","𢯱":"𢯱","搜":"搜","搢":"搢","揅":"揅","摩":"摩","摷":"摷","摾":"摾","㨮":"㨮",搉:"㩁",撚:"撚","撝":"撝",擄:"擄","㩬":"㩬","⽀":"支","⽁":"攴","⺙":"攵","敏":"敏","敏":"敏","敖":"敖","敬":"敬",數:"數","𣀊":"𣀊","⽂":"文","⻫":"斉","⽃":"斗",料:"料","⽄":"斤","⽅":"方",旅:"旅","⽆":"无","⺛":"旡","既":"既","旣":"旣","⽇":"日",易:"易",曶:"㫚","㫤":"㫤","晉":"晉",晩:"晚",晴:"晴","晴":"晴","暑":"暑","暑":"暑",暈:"暈","㬈":"㬈","暜":"暜",暴:"暴",曆:"曆","㬙":"㬙","𣊸":"𣊸","⽈":"曰",更:"更","書":"書","⽉":"月","𣍟":"𣍟",肦:"朌",胐:"朏",胊:"朐",脁:"朓",胶:"㬵",朗:"朗","朗":"朗","朗":"朗",脧:"朘","望":"望","望":"望",幐:"㬺",䐠:"㬻","𣎓":"𣎓",膧:"朣","𣎜":"𣎜","⽊":"木",李:"李","杓":"杓","杖":"杖","杞":"杞","𣏃":"𣏃",柿:"杮",杻:"杻","枅":"枅",林:"林","㭉":"㭉","𣏕":"𣏕",柳:"柳","柺":"柺",栗:"栗","栟":"栟","桒":"桒","𣑭":"𣑭",梁:"梁","梅":"梅","梅":"梅","梎":"梎",梨:"梨","椔":"椔","楂":"楂","㮝":"㮝","㮝":"㮝",槩:"㮣",樧:"榝","榣":"榣","槪":"槪",樂:"樂",樂:"樂",樂:"樂",樓:"樓","𣚣":"𣚣","檨":"檨",櫓:"櫓","櫛":"櫛",欄:"欄","㰘":"㰘","⽋":"欠","次":"次","𣢧":"𣢧","歔":"歔","㱎":"㱎","⽌":"止","⻭":"歯","歲":"歲",歷:"歷","歹":"歹","⽍":"歹","⺞":"歺","殟":"殟",殮:"殮","⽎":"殳",殺:"殺","殺":"殺","殺":"殺","殻":"殻","𣪍":"𣪍","⽏":"毋","⺟":"母","𣫺":"𣫺","⽐":"比","⽑":"毛","⽒":"氏","⺠":"民","⽓":"气","⽔":"水","⺡":"氵","⺢":"氺","汎":"汎","汧":"汧",沈:"沈","沿":"沿",泌:"泌","泍":"泍",泥:"泥","𣲼":"𣲼",洛:"洛",洞:"洞","洴":"洴","派":"派",流:"流","流":"流","流":"流","洖":"洖","浩":"浩",浪:"浪","海":"海","海":"海","浸":"浸","涅":"涅","𣴞":"𣴞",淋:"淋",淚:"淚",淪:"淪","淹":"淹","渚":"渚","港":"港","湮":"湮",潙:"溈","滋":"滋","滋":"滋",溜:"溜",溺:"溺","滇":"滇",滑:"滑","滛":"滛","㴳":"㴳",漏:"漏","漢":"漢","漢":"漢",漣:"漣","𣻑":"𣻑","潮":"潮","𣽞":"𣽞","𣾎":"𣾎","濆":"濆",濫:"濫",濾:"濾","瀛":"瀛","瀞":"瀞","瀞":"瀞","瀹":"瀹","灊":"灊","㶖":"㶖","⽕":"火","⺣":"灬","灰":"灰","灷":"灷","災":"災",炙:"炙","炭":"炭",烈:"烈",烙:"烙","煮":"煮","煮":"煮","𤉣":"𤉣","煅":"煅",煉:"煉","𤋮":"𤋮","熜":"熜",燎:"燎",燐:"燐","𤎫":"𤎫",爐:"爐",爛:"爛","爨":"爨","⽖":"爪","爫":"爫","⺤":"爫","爵":"爵","爵":"爵","⽗":"父","⽘":"爻","⺦":"丬","⽙":"爿","⽚":"片","牐":"牐","⽛":"牙","𤘈":"𤘈","⽜":"牛",牢:"牢","犀":"犀","犕":"犕","⽝":"犬","⺨":"犭","犯":"犯",狀:"狀","𤜵":"𤜵",狼:"狼",猪:"猪","猪":"猪","𤠔":"𤠔",獵:"獵","獺":"獺","⽞":"玄",率:"率",率:"率","⽟":"玉","王":"王","㺬":"㺬","玥":"玥",玲:"玲","㺸":"㺸","㺸":"㺸",珞:"珞",琉:"琉",理:"理","琢":"琢","瑇":"瑇","瑜":"瑜",瑩:"瑩","瑱":"瑱","瑱":"瑱","璅":"璅",璉:"璉",璘:"璘","瓊":"瓊","⽠":"瓜","⽡":"瓦","㼛":"㼛","甆":"甆","⽢":"甘","⽣":"生","甤":"甤","⽤":"用","⽥":"田","画":"画","甾":"甾","𤰶":"𤰶",留:"留",略:"略",異:"異","異":"異","𤲒":"𤲒","⽦":"疋","⽧":"疒",痢:"痢","瘐":"瘐","瘟":"瘟","瘝":"瘝",療:"療",癩:"癩","⽨":"癶","⽩":"白","𤾡":"𤾡","𤾸":"𤾸","⽪":"皮","⽫":"皿","𥁄":"𥁄","㿼":"㿼",益:"益","益":"益","盛":"盛",盧:"盧","䀈":"䀈","⽬":"目","直":"直","直":"直","𥃲":"𥃲","𥃳":"𥃳",省:"省","䀘":"䀘","𥄙":"𥄙","眞":"眞","真":"真","真":"真","𥄳":"𥄳","着":"着","睊":"睊","睊":"睊","鿃":"䀹","䀹":"䀹","䀹":"䀹",晣:"䀿","䁆":"䁆","瞋":"瞋","𥉉":"𥉉","瞧":"瞧","⽭":"矛","⽮":"矢","⽯":"石","䂖":"䂖","𥐝":"𥐝",硏:"研","硎":"硎",硫:"硫",碌:"碌","碌":"碌","碑":"碑",磊:"磊","磌":"磌","磌":"磌",磻:"磻","䃣":"䃣",礪:"礪","⽰":"示","⺭":"礻",礼:"礼","社":"社","祈":"祈","祉":"祉","𥘦":"𥘦","祐":"祐","祖":"祖","祖":"祖","祝":"祝",神:"神",祥:"祥","視":"視","視":"視",祿:"祿","𥚚":"𥚚","禍":"禍","禎":"禎",福:"福","福":"福","𥛅":"𥛅",禮:"禮","⽱":"禸","⽲":"禾",秊:"秊","䄯":"䄯","秫":"秫",稜:"稜","穊":"穊","穀":"穀","穀":"穀","穏":"穏","⽳":"穴","突":"突","𥥼":"𥥼","窱":"窱",立:"立","⽴":"立","⻯":"竜","𥪧":"𥪧","𥪧":"𥪧","竮":"竮","⽵":"竹",笠:"笠","節":"節","節":"節","䈂":"䈂","𥮫":"𥮫","篆":"篆","䈧":"䈧","築":"築","𥲀":"𥲀","𥳐":"𥳐",簾:"簾",籠:"籠","⽶":"米","类":"类",粒:"粒",精:"精","糒":"糒",糖:"糖","糨":"糨","䊠":"䊠","糣":"糣",糧:"糧","⽷":"糸","⺯":"糹","𥾆":"𥾆","紀":"紀",紐:"紐",索:"索",累:"累",絶:"絕","絣":"絣","絛":"絛",綠:"綠",綾:"綾","緇":"緇",練:"練","練":"練","練":"練","縂":"縂","䌁":"䌁","縉":"縉",縷:"縷","繁":"繁","繅":"繅","𦇚":"𦇚","䌴":"䌴","⽸":"缶","𦈨":"𦈨","缾":"缾","𦉇":"𦉇","⽹":"网","⺫":"罒","⺲":"罒","⺱":"罓","䍙":"䍙","署":"署","𦋙":"𦋙",罹:"罹","罺":"罺",羅:"羅","𦌾":"𦌾","⽺":"羊","羕":"羕",羚:"羚",羽:"羽","⽻":"羽","翺":"翺",老:"老","⽼":"老","⺹":"耂","者":"者","者":"者","者":"者","⽽":"而","𦓚":"𦓚","⽾":"耒","𦔣":"𦔣","⽿":"耳",聆:"聆","聠":"聠","𦖨":"𦖨",聯:"聯","聰":"聰",聾:"聾","⾀":"聿","⺺":"肀","⾁":"肉",肋:"肋","肭":"肭","育":"育","䏕":"䏕","䏙":"䏙",腁:"胼","脃":"脃","脾":"脾","䐋":"䐋","朡":"朡","𦞧":"𦞧","𦞵":"𦞵",朦:"䑃",臘:"臘","⾂":"臣",臨:"臨","⾃":"自","臭":"臭","⾄":"至","⾅":"臼","舁":"舁","舁":"舁","舄":"舄","⾆":"舌","舘":"舘","⾇":"舛","⾈":"舟","䑫":"䑫","⾉":"艮",良:"良","⾊":"色","⾋":"艸","艹":"艹","艹":"艹","⺾":"艹","⺿":"艹","⻀":"艹","芋":"芋","芑":"芑","芝":"芝","花":"花","芳":"芳","芽":"芽",若:"若","若":"若","苦":"苦","𦬼":"𦬼",茶:"茶","荒":"荒","荣":"荣","茝":"茝","茣":"茣","莽":"莽","荓":"荓",菉:"菉","菊":"菊","菌":"菌","菜":"菜","菧":"菧","華":"華",菱:"菱","著":"著","著":"著","𦰶":"𦰶","莭":"莭",落:"落",葉:"葉",蔿:"蒍","𦳕":"𦳕","𦵫":"𦵫",蓮:"蓮","蓱":"蓱","蓳":"蓳",蓼:"蓼","蔖":"蔖","䔫":"䔫","蕤":"蕤","𦼬":"𦼬",藍:"藍","䕝":"䕝","𦾱":"𦾱","䕡":"䕡",藺:"藺",蘆:"蘆","䕫":"䕫",蘒:"蘒",蘭:"蘭","𧃒":"𧃒",虁:"蘷",蘿:"蘿","⾌":"虍","⻁":"虎","虐":"虐",虜:"虜","虜":"虜","虧":"虧","虩":"虩","⾍":"虫","蚩":"蚩","蚈":"蚈","蛢":"蛢","蜎":"蜎","蜨":"蜨","蝫":"蝫","蟡":"蟡","蝹":"蝹","蝹":"蝹","螆":"螆","䗗":"䗗","𧏊":"𧏊",螺:"螺","蠁":"蠁","䗹":"䗹",蠟:"蠟","⾎":"血",行:"行","⾏":"行","衠":"衠","衣":"衣","⾐":"衣","⻂":"衤",裂:"裂","𧙧":"𧙧",裏:"裏","裗":"裗","裞":"裞",裡:"裡",裸:"裸","裺":"裺","䘵":"䘵","褐":"褐","襁":"襁",襤:"襤","⾑":"襾","⻄":"西","⻃":"覀","覆":"覆",見:"見","⾒":"見","𧢮":"𧢮","⻅":"见","⾓":"角","⾔":"言","𧥦":"𧥦",詽:"訮",訞:"䚶","䚾":"䚾","䛇":"䛇","誠":"誠",說:"說",說:"說","調":"調","請":"請",諒:"諒",論:"論","諭":"諭","諭":"諭",諸:"諸","諸":"諸",諾:"諾","諾":"諾","謁":"謁","謁":"謁","謹":"謹","謹":"謹",識:"識",讀:"讀",讏:"讆","變":"變","變":"變","⻈":"讠","⾕":"谷","⾖":"豆",豈:"豈","豕":"豕","⾗":"豕",豣:"豜","⾘":"豸","𧲨":"𧲨","⾙":"貝","貫":"貫","賁":"賁",賂:"賂",賈:"賈","賓":"賓","贈":"贈","贈":"贈","贛":"贛","⻉":"贝","⾚":"赤","⾛":"走","起":"起",趆:"赿","𧻓":"𧻓","𧼯":"𧼯","⾜":"足","跋":"跋","趼":"趼",跺:"跥",路:"路","跰":"跰",躛:"躗","⾝":"身",車:"車","⾞":"車","軔":"軔",輧:"軿",輦:"輦",輪:"輪","輸":"輸","輸":"輸",輻:"輻",轢:"轢","⻋":"车","⾟":"辛","辞":"辞",辰:"辰","⾠":"辰","⾡":"辵","辶":"辶","⻌":"辶","⻍":"辶","巡":"巡",連:"連",逸:"逸","逸":"逸","遲":"遲",遼:"遼","𨗒":"𨗒","𨗭":"𨗭",邏:"邏","⾢":"邑","邔":"邔",郎:"郎",郞:"郎","郞":"郎","郱":"郱",都:"都","𨜮":"𨜮","鄑":"鄑","鄛":"鄛","⾣":"酉",酪:"酪","醙":"醙",醴:"醴","⾤":"釆",里:"里","⾥":"里",量:"量",金:"金","⾦":"金",鈴:"鈴","鈸":"鈸","鉶":"鉶","鋗":"鋗","鋘":"鋘","鉼":"鉼",錄:"錄",鍊:"鍊",鎮:"鎭","鏹":"鏹","鐕":"鐕","𨯺":"𨯺","⻐":"钅","⻑":"長","⾧":"長","⻒":"镸","⻓":"长","⾨":"門","開":"開","䦕":"䦕",閭:"閭","閷":"閷","𨵷":"𨵷","⻔":"门","⾩":"阜","⻏":"阝","⻖":"阝",阮:"阮",陋:"陋",降:"降",陵:"陵",陸:"陸","陼":"陼",隆:"隆",隣:"隣","䧦":"䧦","⾪":"隶","隷":"隷",隸:"隷",隸:"隷","⾫":"隹","雃":"雃",離:"離","難":"難","難":"難","⾬":"雨",零:"零",雷:"雷","霣":"霣","𩅅":"𩅅",露:"露",靈:"靈","⾭":"靑","⻘":"青",靖:"靖","靖":"靖","𩇟":"𩇟","⾮":"非","⾯":"面","𩈚":"𩈚","⾰":"革","䩮":"䩮","䩶":"䩶","⾱":"韋","韛":"韛","韠":"韠","⻙":"韦","⾲":"韭","𩐊":"𩐊","⾳":"音","響":"響","響":"響","⾴":"頁","䪲":"䪲","頋":"頋","頋":"頋","頋":"頋",領:"領","頩":"頩","𩒖":"𩒖","頻":"頻","頻":"頻",類:"類","⻚":"页","⾵":"風","𩖶":"𩖶","⻛":"风","⾶":"飛","⻜":"飞","⻝":"食","⾷":"食","⻟":"飠","飢":"飢",飯:"飯",飼:"飼","䬳":"䬳",館:"館","餩":"餩","⻠":"饣","⾸":"首","⾹":"香","馧":"馧","⾺":"馬","駂":"駂",駱:"駱","駾":"駾",驪:"驪","⻢":"马","⾻":"骨","䯎":"䯎","⾼":"高","⾽":"髟","𩬰":"𩬰","鬒":"鬒","鬒":"鬒","⾾":"鬥","⾿":"鬯","⿀":"鬲","⿁":"鬼","⻤":"鬼","⿂":"魚",魯:"魯","鱀":"鱀",鱗:"鱗","⻥":"鱼","⿃":"鳥","鳽":"鳽","䳎":"䳎","鵧":"鵧","䳭":"䳭","𪃎":"𪃎",鶴:"鶴","𪄅":"𪄅","䳸":"䳸",鷺:"鷺","𪈎":"𪈎",鸞:"鸞",鹃:"鹂","⿄":"鹵",鹿:"鹿","⿅":"鹿","𪊑":"𪊑",麗:"麗",麟:"麟","⿆":"麥","⻨":"麦","麻":"麻","⿇":"麻","𪎒":"𪎒","⿈":"黃","⻩":"黄","⿉":"黍",黎:"黎","䵖":"䵖","⿊":"黑",黒:"黑","墨":"墨","黹":"黹","⿋":"黹","⿌":"黽","鼅":"鼅","黾":"黾","⿍":"鼎","鼏":"鼏","⿎":"鼓","鼖":"鼖","⿏":"鼠","鼻":"鼻","⿐":"鼻","齃":"齃","⿑":"齊","⻬":"齐","⿒":"齒","𪘀":"𪘀","⻮":"齿",龍:"龍","⿓":"龍","龎":"龎","⻰":"龙",龜:"龜",龜:"龜","龜":"龜","⿔":"龜","⻳":"龟","⿕":"龠"};var ws,ql;function fv(){if(ql)return ws;ql=1;var i=vv;function e(a){return a.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var t=RegExp(Object.keys(i).map(e).join("|"),"g");function r(a){return i[a]}function n(a){return a.replace(t,r)}return ws=n,ws}var pv=fv();const mv=oc(pv),gv=Object.prototype.toString,yv=i=>gv.call(i)==="[object Error]",Sv=new Set(["network error","Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed","fetch failed","terminated"," A network error occurred.","Network connection lost"]);function bv(i){if(!(i&&yv(i)&&i.name==="TypeError"&&typeof i.message=="string"))return!1;const{message:t,stack:r}=i;return t==="Load failed"?r===void 0||"__sentry_captured__"in i:t.startsWith("error sending request for url")?!0:Sv.has(t)}function Ev(i){if(typeof i=="number"){if(i<0)throw new TypeError("Expected `retries` to be a non-negative number.");if(Number.isNaN(i))throw new TypeError("Expected `retries` to be a valid number or Infinity, got NaN.")}else if(i!==void 0)throw new TypeError("Expected `retries` to be a number or Infinity.")}function ra(i,e,{min:t=0,allowInfinity:r=!1}={}){if(e!==void 0){if(typeof e!="number"||Number.isNaN(e))throw new TypeError(`Expected \`${i}\` to be a number${r?" or Infinity":""}.`);if(!r&&!Number.isFinite(e))throw new TypeError(`Expected \`${i}\` to be a finite number.`);if(e<t)throw new TypeError(`Expected \`${i}\` to be ≥ ${t}.`)}}class lc extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}function _v(i,e){const t=Math.max(1,i+1),r=e.randomize?Math.random()+1:1;let n=Math.round(r*e.minTimeout*e.factor**(t-1));return n=Math.min(n,e.maxTimeout),n}function Vl(i,e){return Number.isFinite(e)?e-(performance.now()-i):e}async function wv({error:i,attemptNumber:e,retriesConsumed:t,startTime:r,options:n}){const a=i instanceof Error?i:new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`);if(a instanceof lc)throw a.originalError;const s=Number.isFinite(n.retries)?Math.max(0,n.retries-t):n.retries,o=n.maxRetryTime??Number.POSITIVE_INFINITY,d=Object.freeze({error:a,attemptNumber:e,retriesLeft:s,retriesConsumed:t});if(await n.onFailedAttempt(d),Vl(r,o)<=0)throw a;const l=await n.shouldConsumeRetry(d),u=Vl(r,o);if(u<=0||s<=0)throw a;if(a instanceof TypeError&&!bv(a)){if(l)throw a;return n.signal?.throwIfAborted(),!1}if(!await n.shouldRetry(d))throw a;if(!l)return n.signal?.throwIfAborted(),!1;const h=_v(t,n),v=Math.min(h,u);return n.signal?.throwIfAborted(),v>0&&await new Promise((m,f)=>{const g=()=>{clearTimeout(T),n.signal?.removeEventListener("abort",g),f(n.signal.reason)},T=setTimeout(()=>{n.signal?.removeEventListener("abort",g),m()},v);n.unref&&T.unref?.(),n.signal?.addEventListener("abort",g,{once:!0})}),n.signal?.throwIfAborted(),!0}async function Rv(i,e={}){if(e={...e},Ev(e.retries),Object.hasOwn(e,"forever"))throw new Error("The `forever` option is no longer supported. For many use-cases, you can set `retries: Infinity` instead.");e.retries??=10,e.factor??=2,e.minTimeout??=1e3,e.maxTimeout??=Number.POSITIVE_INFINITY,e.maxRetryTime??=Number.POSITIVE_INFINITY,e.randomize??=!1,e.onFailedAttempt??=()=>{},e.shouldRetry??=()=>!0,e.shouldConsumeRetry??=()=>!0,ra("factor",e.factor,{min:0,allowInfinity:!1}),ra("minTimeout",e.minTimeout,{min:0,allowInfinity:!1}),ra("maxTimeout",e.maxTimeout,{min:0,allowInfinity:!0}),ra("maxRetryTime",e.maxRetryTime,{min:0,allowInfinity:!0}),e.factor>0||(e.factor=1),e.signal?.throwIfAborted();let t=0,r=0;const n=performance.now();for(;!Number.isFinite(e.retries)||r<=e.retries;){t++;try{e.signal?.throwIfAborted();const a=await i(t);return e.signal?.throwIfAborted(),a}catch(a){await wv({error:a,attemptNumber:t,retriesConsumed:r,startTime:n,options:e})&&r++}}throw new Error("Retry attempts exhausted without throwing an error.")}let Nn=class{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=e?.[this.name]),!t&&this.altName&&(t=e?.[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}};class Qa extends Nn{constructor(){super(...arguments),c(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class Qe extends Nn{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}var Xr=(function(i){return i.Self="m.self",i.Pin="m.pin",i})({}),xn=new Qe("m.asset","org.matrix.msc3488.asset"),ur=new Qe("m.ts","org.matrix.msc3488.ts"),Fn=new Qe("m.location","org.matrix.msc3488.location"),ht=(function(i){return i.Read="m.read",i.FullyRead="m.fully_read",i.ReadPrivate="m.read.private",i})({}),jn="main";function Gl(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Hl(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Gl(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Gl(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Rs=new Map;function Ts(i){return i instanceof String&&(i=i.toString()),Rs.has(i)||Rs.set(i,i),Rs.get(i)}function Xs(i,e){var t=e??new URLSearchParams,r=function(o){a!=null&&(Array.isArray(a)?a.forEach(d=>{t.append(o,String(d))}):t.append(o,String(a)))};for(var[n,a]of Object.entries(i))r(n);return t}function $l(i,e,t){var r=Hl(Hl({},t),{},{[e]:t[i]});return delete r[i],r}function Z(i,e){for(var t in e)if(e.hasOwnProperty(t)){var r=e[t];r!=null&&(i=i.replace(t,encodeURIComponent(r)))}return i}function Oa(i,e,t){var r;if(t){for(r=i.length-1;r>=0;r--)if(e(i[r],r,i))return i.splice(r,1),!0}else for(r=0;r<i.length;r++)if(e(i[r],r,i))return i.splice(r,1),!0;return!1}function dc(i,e){for(var t of e)if(!i.hasOwnProperty(t))throw new Error("Missing required key: "+t)}function Ki(i){return JSON.parse(JSON.stringify(i))}function Qr(i,e){if(i===e)return!0;if(typeof i!=typeof e)return!1;if(typeof i=="number"&&isNaN(i)&&isNaN(e))return!0;if(i===null||e===null)return i===e;if(!(i instanceof Object)||i.constructor!==e.constructor||i.prototype!==e.prototype)return!1;if(i instanceof RegExp||i instanceof Date)return i.toString()===e.toString();if(Array.isArray(i)){if(i.length!==e.length)return!1;for(var t=0;t<i.length;t++)if(!Qr(i[t],e[t]))return!1}else{for(var r in e)if(e.hasOwnProperty(r)!==i.hasOwnProperty(r))return!1;for(var n in i)if(e.hasOwnProperty(n)!==i.hasOwnProperty(n)||!Qr(i[n],e[n]))return!1}return!0}function Qs(i){if(typeof i!="object"||i==null||Array.isArray(i))return i;var e=[];for(var[t,r]of Object.entries(i))e.push([t,Qs(r)]);return e.sort((n,a)=>Ea(n[0],a[0])),e}function Jl(i){return typeof i=="number"&&isFinite(i)}function Hr(i){return typeof i=="string"?mv(i.normalize("NFD").replace(Iv,"")):""}function Zs(i){return typeof i=="string"?i.replace(/[\u202d-\u202e]/g,""):""}function Tv(i){return Hr(i.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var Iv=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function uc(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function cc(i){return uc(i).replace(/\\\*/g,".*").replace(/\?/g,".")}function Is(i){return i!=null&&i.endsWith("/")?i.slice(0,-1):i}function qi(i,e){return new Promise(t=>{setTimeout(t,i,e)})}function vg(i,e,t){return eo.apply(this,arguments)}function eo(){return eo=_(function*(i,e,t){var r=Date.now();try{return yield t()}finally{var n=Date.now();i.debug("[Perf]: ".concat(e," took ").concat(n-r,"ms"))}}),eo.apply(this,arguments)}function Cv(i,e,t){var r=Date.now();try{return t()}finally{var n=Date.now();i.debug("[Perf]: ".concat(e," took ").concat(n-r,"ms"))}}function hc(i){return i==null}function gn(i,e){return to.apply(this,arguments)}function to(){return to=_(function*(i,e){for(var t of i)yield e(yield t)}),to.apply(this,arguments)}function ln(i){return Promise.resolve(i())}function Ov(i,e){return Rv(t=>i(t),{retries:1/0,shouldRetry:e?t=>{var{error:r}=t;return e(r)}:void 0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var Tr=(()=>{for(var i="",e=32;e<=126;e++)i+=String.fromCharCode(e);return i})();function zl(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Tr;return i.padEnd(e,t[0])}function Pi(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Tr,t=BigInt(e.length);if(i<=t){var r;return(r=e[Number(i)-1])!==null&&r!==void 0?r:""}var n=i/t,a=Number(i%t)-1;return a<0&&(n-=BigInt(Math.abs(a)),a=Number(t)-1),Pi(n,e)+e[a]}function ka(i){for(var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Tr,t=BigInt(e.length),r=BigInt(0),n=i.length-1,a=BigInt(0);n>=0;n--,a++){var s=i.charCodeAt(n)-e.charCodeAt(0);r+=BigInt(1+s)*t**a}return r}function kv(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Tr,r=Math.max(i.length,e.length),n=ka(zl(i,r,t),t),a=ka(zl(e,r,t),t),s=(n+a)/BigInt(2);return s===n||s==a?Pi(s,t)+t[0]:Pi(s,t)}function Hn(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Tr;return Pi(ka(i,e)+BigInt(1),e)}function Yl(i){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Tr;return Pi(ka(i,e)-BigInt(1),e)}function Ea(i,e){return i<e?-1:i>e?1:0}function vc(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;for(var[r,n]of Object.entries(e)){if(i[r]instanceof Object&&n){vc(i[r],n);continue}if(n!=null||!t){Ma(i,r,n);continue}}return i}function Xl(i){var e;return(e=ur.findIn(i.getContent()))!==null&&e!==void 0?e:-1}function Mv(i,e){return Xl(e)-Xl(i)}function Mo(i){return[ht.Read,ht.ReadPrivate].includes(i)}function Ql(i,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:(s,o)=>s===o;if(i.size!==e.size)return!1;for(var[r,n]of i){var a=e.get(r);if(a===void 0||!t(n,a))return!1}return!0}function fc(i){return i instanceof Map?Vr(i):Array.isArray(i)?i.map(e=>fc(e)):i}function Vr(i){var e=new Map;for(var[t,r]of i)e.set(t,fc(r));return Object.fromEntries(e.entries())}function _i(i){return i==="__proto__"||i==="prototype"||i==="constructor"}function Ma(i,e,t){if(_i(e))throw new Error("Trying to modify prototype or constructor");i[e]=t}function jt(i){return!(_i(i.room_id)||_i(i.sender)||_i(i.event_id))}class lr extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}var ro="migrationState",Tn=(function(i){return i[i.NOT_STARTED=0]="NOT_STARTED",i[i.INITIAL_DATA_MIGRATED=1]="INITIAL_DATA_MIGRATED",i[i.OLM_SESSIONS_MIGRATED=2]="OLM_SESSIONS_MIGRATED",i[i.MEGOLM_SESSIONS_MIGRATED=3]="MEGOLM_SESSIONS_MIGRATED",i[i.ROOM_SETTINGS_MIGRATED=4]="ROOM_SETTINGS_MIGRATED",i[i.INITIAL_OWN_KEY_QUERY_DONE=5]="INITIAL_OWN_KEY_QUERY_DONE",i})({}),In=50;function Zl(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ed(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Zl(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Zl(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function na(i,e){return encodeURIComponent(i)+"/"+encodeURIComponent(e)}function Pv(i){var e=i.split("/"),t=decodeURIComponent(e[0]),r=decodeURIComponent(e[1]);return{senderKey:t,sessionId:r}}class Vi{constructor(){c(this,"migrationState",Tn.NOT_STARTED),c(this,"account",null),c(this,"crossSigningKeys",null),c(this,"privateKeys",{}),c(this,"sessions",{}),c(this,"inboundGroupSessions",{}),c(this,"inboundGroupSessionsWithheld",{}),c(this,"rooms",{}),c(this,"sessionsNeedingBackup",{})}containsData(){var e=this;return _(function*(){return e.account!==null})()}startup(){var e=this;return _(function*(){return e})()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return _(function*(){return e.migrationState})()}setMigrationState(e){var t=this;return _(function*(){t.migrationState=e})()}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,r){var n=this.privateKeys[r];t(n||null)}storeSecretStorePrivateKey(e,t,r){this.privateKeys[t]=r}countEndToEndSessions(e,t){var r=0;for(var n of Object.values(this.sessions))r+=Object.keys(n).length;t(r)}getEndToEndSession(e,t,r,n){var a=this.sessions[e]||{};n(a[t]||null)}getEndToEndSessions(e,t,r){r(this.sessions[e]||{})}storeEndToEndSession(e,t,r,n){var a=this.sessions[e];a===void 0&&(a={},this.sessions[e]=a),Ma(a,t,r)}getEndToEndSessionsBatch(){var e=this;return _(function*(){var t=[];for(var r of Object.values(e.sessions))for(var n of Object.values(r))if(t.push(n),t.length>=In)return t;return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return _(function*(){for(var{deviceKey:r,sessionId:n}of e){var a=t.sessions[r]||{};delete a[n],Object.keys(a).length===0&&delete t.sessions[r]}})()}getEndToEndInboundGroupSession(e,t,r,n){var a=na(e,t);n(this.inboundGroupSessions[a]||null,this.inboundGroupSessionsWithheld[a]||null)}storeEndToEndInboundGroupSession(e,t,r,n){var a=na(e,t);this.inboundGroupSessions[a]=r}countEndToEndInboundGroupSessions(){var e=this;return _(function*(){return Object.keys(e.inboundGroupSessions).length})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return _(function*(){var t=[];for(var[r,n]of Object.entries(e.inboundGroupSessions))if(t.push(ed(ed({},Pv(r)),{},{sessionData:n,needsBackup:r in e.sessionsNeedingBackup})),t.length>=In)return t;return t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return _(function*(){for(var{senderKey:r,sessionId:n}of e){var a=na(r,n);delete t.inboundGroupSessions[a]}})()}getEndToEndRooms(e,t){t(this.rooms)}markSessionsNeedingBackup(e){for(var t of e){var r=na(t.senderKey,t.sessionId);this.sessionsNeedingBackup[r]=!0}return Promise.resolve()}doTxn(e,t,r){return Promise.resolve(r(null))}}var Av=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function Dv(i){var e=Av.exec(i);return e?.[0]===i}var Lv=/^[\w-]+$/;function Uv(i){var e=Lv.exec(i);return e?.[0]===i}function Gi(i,e,t,r,n){var a=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,s=arguments.length>6?arguments[6]:void 0,o=arguments.length>7?arguments[7]:void 0;if(typeof e!="string"||!e)return"";if(!e.startsWith("mxc://"))return a?e:"";var[d,l,...u]=e.slice(6).split("/");if(u.length>0||!Dv(d)||!Uv(l))return"";o&&(s=!0);var h,v=!!t||!!r||!!n,m=v?"thumbnail":"download";o?h="/_matrix/client/v1/media/".concat(m):h="/_matrix/media/v3/".concat(m);var f=new URL("".concat(h,"/").concat(d,"/").concat(l),i);return t&&f.searchParams.set("width",Math.round(t).toString()),r&&f.searchParams.set("height",Math.round(r).toString()),n&&f.searchParams.set("method",n),typeof s=="boolean"&&f.searchParams.set("allow_redirect",JSON.stringify(s)),f.href}var _a={exports:{}},Nv=_a.exports,td;function xv(){return td||(td=1,(function(i){(function(e,t){i.exports?i.exports=t():e.log=t()})(Nv,function(){var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],a={},s=null;function o(g,T){var R=g[T];if(typeof R.bind=="function")return R.bind(g);try{return Function.prototype.bind.call(R,g)}catch{return function(){return Function.prototype.apply.apply(R,[g,arguments])}}}function d(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(g){return g==="debug"&&(g="log"),typeof console===t?!1:g==="trace"&&r?d:console[g]!==void 0?o(console,g):console.log!==void 0?o(console,"log"):e}function u(){for(var g=this.getLevel(),T=0;T<n.length;T++){var R=n[T];this[R]=T<g?e:this.methodFactory(R,g,this.name)}if(this.log=this.debug,typeof console===t&&g<this.levels.SILENT)return"No console available for logging"}function h(g){return function(){typeof console!==t&&(u.call(this),this[g].apply(this,arguments))}}function v(g,T,R){return l(g)||h.apply(this,arguments)}function m(g,T){var R=this,S,I,b,w="loglevel";typeof g=="string"?w+=":"+g:typeof g=="symbol"&&(w=void 0);function p(V){var Q=(n[V]||"silent").toUpperCase();if(!(typeof window===t||!w)){try{window.localStorage[w]=Q;return}catch{}try{window.document.cookie=encodeURIComponent(w)+"="+Q+";"}catch{}}}function E(){var V;if(!(typeof window===t||!w)){try{V=window.localStorage[w]}catch{}if(typeof V===t)try{var Q=window.document.cookie,le=encodeURIComponent(w),Ae=Q.indexOf(le+"=");Ae!==-1&&(V=/^([^;]+)/.exec(Q.slice(Ae+le.length+1))[1])}catch{}return R.levels[V]===void 0&&(V=void 0),V}}function y(){if(!(typeof window===t||!w)){try{window.localStorage.removeItem(w)}catch{}try{window.document.cookie=encodeURIComponent(w)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function P(V){var Q=V;if(typeof Q=="string"&&R.levels[Q.toUpperCase()]!==void 0&&(Q=R.levels[Q.toUpperCase()]),typeof Q=="number"&&Q>=0&&Q<=R.levels.SILENT)return Q;throw new TypeError("log.setLevel() called with invalid level: "+V)}R.name=g,R.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},R.methodFactory=T||v,R.getLevel=function(){return b??I??S},R.setLevel=function(V,Q){return b=P(V),Q!==!1&&p(b),u.call(R)},R.setDefaultLevel=function(V){I=P(V),E()||R.setLevel(V,!1)},R.resetLevel=function(){b=null,y(),u.call(R)},R.enableAll=function(V){R.setLevel(R.levels.TRACE,V)},R.disableAll=function(V){R.setLevel(R.levels.SILENT,V)},R.rebuild=function(){if(s!==R&&(S=P(s.getLevel())),u.call(R),s===R)for(var V in a)a[V].rebuild()},S=P(s?s.getLevel():"WARN");var N=E();N!=null&&(b=P(N)),u.call(R)}s=new m,s.getLogger=function(T){if(typeof T!="symbol"&&typeof T!="string"||T==="")throw new TypeError("You must supply a name when creating a logger.");var R=a[T];return R||(R=a[T]=new m(T,s.methodFactory)),R};var f=typeof window!==t?window.log:void 0;return s.noConflict=function(){return typeof window!==t&&window.log===s&&(window.log=f),s},s.getLoggers=function(){return a},s.default=s,s})})(_a)),_a.exports}var Fv=xv();const no=oc(Fv);var jv="matrix";no.methodFactory=function(i,e,t){return function(){for(var r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];this.prefix&&n.unshift(this.prefix);var s=i==="error"||i==="warn"||i==="trace"||i==="info"||i==="debug";return s?console[i](...n):console.log(...n)}};function pc(i){var e=jv+(i===void 0?"":"-".concat(i)),t=no.getLogger(e);return t.getChild===void 0&&(t.prefix=i,t.getChild=r=>{var n=pc((i??"")+r);return n.methodFactory=t.methodFactory,n.rebuild(),n},t.setLevel(no.levels.DEBUG,!1)),t}var O=pc();class fg{constructor(e,t){this.parent=e,c(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.error(this.name,...t)}}class Za{constructor(e){this.debugInstance=e}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[TRACE]",...t)}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[DEBUG]",...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[INFO]",...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[WARN]",...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.debugWithPrefix("[ERROR]",...t)}getChild(e){return new Za(this.debugInstance.extend(e))}debugWithPrefix(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++)n[a-1]=arguments[a];if(n.length===0)t="";else if(n[0]instanceof Error){var s=n.shift();t=s.stack||s.message}else typeof n[0]=="string"?t=n.shift():t="%O";this.debugInstance(e+" "+t,...n)}}var ia={exports:{}},rd;function es(){if(rd)return ia.exports;rd=1;var i=typeof Reflect=="object"?Reflect:null,e=i&&typeof i.apply=="function"?i.apply:function(w,p,E){return Function.prototype.apply.call(w,p,E)},t;i&&typeof i.ownKeys=="function"?t=i.ownKeys:Object.getOwnPropertySymbols?t=function(w){return Object.getOwnPropertyNames(w).concat(Object.getOwnPropertySymbols(w))}:t=function(w){return Object.getOwnPropertyNames(w)};function r(b){console&&console.warn&&console.warn(b)}var n=Number.isNaN||function(w){return w!==w};function a(){a.init.call(this)}ia.exports=a,ia.exports.once=R,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var s=10;function o(b){if(typeof b!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof b)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return s},set:function(b){if(typeof b!="number"||b<0||n(b))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+b+".");s=b}}),a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(w){if(typeof w!="number"||w<0||n(w))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+w+".");return this._maxListeners=w,this};function d(b){return b._maxListeners===void 0?a.defaultMaxListeners:b._maxListeners}a.prototype.getMaxListeners=function(){return d(this)},a.prototype.emit=function(w){for(var p=[],E=1;E<arguments.length;E++)p.push(arguments[E]);var y=w==="error",P=this._events;if(P!==void 0)y=y&&P.error===void 0;else if(!y)return!1;if(y){var N;if(p.length>0&&(N=p[0]),N instanceof Error)throw N;var V=new Error("Unhandled error."+(N?" ("+N.message+")":""));throw V.context=N,V}var Q=P[w];if(Q===void 0)return!1;if(typeof Q=="function")e(Q,this,p);else for(var le=Q.length,Ae=f(Q,le),E=0;E<le;++E)e(Ae[E],this,p);return!0};function l(b,w,p,E){var y,P,N;if(o(p),P=b._events,P===void 0?(P=b._events=Object.create(null),b._eventsCount=0):(P.newListener!==void 0&&(b.emit("newListener",w,p.listener?p.listener:p),P=b._events),N=P[w]),N===void 0)N=P[w]=p,++b._eventsCount;else if(typeof N=="function"?N=P[w]=E?[p,N]:[N,p]:E?N.unshift(p):N.push(p),y=d(b),y>0&&N.length>y&&!N.warned){N.warned=!0;var V=new Error("Possible EventEmitter memory leak detected. "+N.length+" "+String(w)+" listeners added. Use emitter.setMaxListeners() to increase limit");V.name="MaxListenersExceededWarning",V.emitter=b,V.type=w,V.count=N.length,r(V)}return b}a.prototype.addListener=function(w,p){return l(this,w,p,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(w,p){return l(this,w,p,!0)};function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(b,w,p){var E={fired:!1,wrapFn:void 0,target:b,type:w,listener:p},y=u.bind(E);return y.listener=p,E.wrapFn=y,y}a.prototype.once=function(w,p){return o(p),this.on(w,h(this,w,p)),this},a.prototype.prependOnceListener=function(w,p){return o(p),this.prependListener(w,h(this,w,p)),this},a.prototype.removeListener=function(w,p){var E,y,P,N,V;if(o(p),y=this._events,y===void 0)return this;if(E=y[w],E===void 0)return this;if(E===p||E.listener===p)--this._eventsCount===0?this._events=Object.create(null):(delete y[w],y.removeListener&&this.emit("removeListener",w,E.listener||p));else if(typeof E!="function"){for(P=-1,N=E.length-1;N>=0;N--)if(E[N]===p||E[N].listener===p){V=E[N].listener,P=N;break}if(P<0)return this;P===0?E.shift():g(E,P),E.length===1&&(y[w]=E[0]),y.removeListener!==void 0&&this.emit("removeListener",w,V||p)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(w){var p,E,y;if(E=this._events,E===void 0)return this;if(E.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):E[w]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete E[w]),this;if(arguments.length===0){var P=Object.keys(E),N;for(y=0;y<P.length;++y)N=P[y],N!=="removeListener"&&this.removeAllListeners(N);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(p=E[w],typeof p=="function")this.removeListener(w,p);else if(p!==void 0)for(y=p.length-1;y>=0;y--)this.removeListener(w,p[y]);return this};function v(b,w,p){var E=b._events;if(E===void 0)return[];var y=E[w];return y===void 0?[]:typeof y=="function"?p?[y.listener||y]:[y]:p?T(y):f(y,y.length)}a.prototype.listeners=function(w){return v(this,w,!0)},a.prototype.rawListeners=function(w){return v(this,w,!1)},a.listenerCount=function(b,w){return typeof b.listenerCount=="function"?b.listenerCount(w):m.call(b,w)},a.prototype.listenerCount=m;function m(b){var w=this._events;if(w!==void 0){var p=w[b];if(typeof p=="function")return 1;if(p!==void 0)return p.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function f(b,w){for(var p=new Array(w),E=0;E<w;++E)p[E]=b[E];return p}function g(b,w){for(;w+1<b.length;w++)b[w]=b[w+1];b.pop()}function T(b){for(var w=new Array(b.length),p=0;p<w.length;++p)w[p]=b[p].listener||b[p];return w}function R(b,w){return new Promise(function(p,E){function y(N){b.removeListener(w,P),E(N)}function P(){typeof b.removeListener=="function"&&b.removeListener("error",y),p([].slice.call(arguments))}I(b,w,P,{once:!0}),w!=="error"&&S(b,y,{once:!0})})}function S(b,w,p){typeof b.on=="function"&&I(b,"error",w,p)}function I(b,w,p,E){if(typeof b.on=="function")E.once?b.once(w,p):b.on(w,p);else if(typeof b.addEventListener=="function")b.addEventListener(w,function y(P){E.once&&b.removeEventListener(w,y),p(P)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof b)}return ia.exports}var Bv=es(),Po=(function(i){return i.NewListener="newListener",i.RemoveListener="removeListener",i.Error="error",i})({});class Ke extends Bv.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return super.emit(e,...r)}emitPromised(e){var t=arguments,r=this;return _(function*(){for(var n=t.length,a=new Array(n>1?n-1:0),s=1;s<n;s++)a[s-1]=t[s];var o=r.listeners(e);return Promise.allSettled(o.map(d=>d(...a))).then(()=>o.length>0)})()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return e===void 0?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}var F=(function(i){return i.RoomCanonicalAlias="m.room.canonical_alias",i.RoomCreate="m.room.create",i.RoomJoinRules="m.room.join_rules",i.RoomMember="m.room.member",i.RoomThirdPartyInvite="m.room.third_party_invite",i.RoomPowerLevels="m.room.power_levels",i.RoomName="m.room.name",i.RoomTopic="m.room.topic",i.RoomAvatar="m.room.avatar",i.RoomPinnedEvents="m.room.pinned_events",i.RoomEncryption="m.room.encryption",i.RoomHistoryVisibility="m.room.history_visibility",i.RoomGuestAccess="m.room.guest_access",i.RoomServerAcl="m.room.server_acl",i.RoomTombstone="m.room.tombstone",i.RoomPredecessor="org.matrix.msc3946.room_predecessor",i.PolicyRuleUser="m.policy.rule.user",i.PolicyRuleRoom="m.policy.rule.room",i.PolicyRuleServer="m.policy.rule.server",i.SpaceChild="m.space.child",i.SpaceParent="m.space.parent",i.RoomRedaction="m.room.redaction",i.RoomMessage="m.room.message",i.RoomMessageEncrypted="m.room.encrypted",i.Sticker="m.sticker",i.CallInvite="m.call.invite",i.CallCandidates="m.call.candidates",i.CallAnswer="m.call.answer",i.CallHangup="m.call.hangup",i.CallReject="m.call.reject",i.CallSelectAnswer="m.call.select_answer",i.CallNegotiate="m.call.negotiate",i.CallSDPStreamMetadataChanged="m.call.sdp_stream_metadata_changed",i.CallSDPStreamMetadataChangedPrefix="org.matrix.call.sdp_stream_metadata_changed",i.CallReplaces="m.call.replaces",i.CallAssertedIdentity="m.call.asserted_identity",i.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",i.CallEncryptionKeysPrefix="io.element.call.encryption_keys",i.KeyVerificationRequest="m.key.verification.request",i.KeyVerificationStart="m.key.verification.start",i.KeyVerificationCancel="m.key.verification.cancel",i.KeyVerificationMac="m.key.verification.mac",i.KeyVerificationDone="m.key.verification.done",i.KeyVerificationKey="m.key.verification.key",i.KeyVerificationAccept="m.key.verification.accept",i.KeyVerificationReady="m.key.verification.ready",i.RoomMessageFeedback="m.room.message.feedback",i.Reaction="m.reaction",i.PollStart="org.matrix.msc3381.poll.start",i.Typing="m.typing",i.Receipt="m.receipt",i.Presence="m.presence",i.FullyRead="m.fully_read",i.Tag="m.tag",i.SpaceOrder="org.matrix.msc3230.space_order",i.PushRules="m.push_rules",i.Direct="m.direct",i.IgnoredUserList="m.ignored_user_list",i.RoomKey="m.room_key",i.RoomKeyRequest="m.room_key_request",i.ForwardedRoomKey="m.forwarded_room_key",i.Dummy="m.dummy",i.SecretRequest="m.secret.request",i.SecretSend="m.secret.send",i.GroupCallPrefix="org.matrix.msc3401.call",i.GroupCallMemberPrefix="org.matrix.msc3401.call.member",i.RTCMembership="org.matrix.msc4143.rtc.member",i.CallNotify="org.matrix.msc4075.call.notify",i.RTCNotification="org.matrix.msc4075.rtc.notification",i.RTCDecline="org.matrix.msc4310.rtc.decline",i})({}),Ue=(function(i){return i.Annotation="m.annotation",i.Replace="m.replace",i.Reference="m.reference",i.Thread="m.thread",i})({}),Wt=(function(i){return i.Text="m.text",i.Emote="m.emote",i.Notice="m.notice",i.Image="m.image",i.File="m.file",i.Audio="m.audio",i.Location="m.location",i.Video="m.video",i.KeyVerificationRequest="m.key.verification.request",i})({}),Ai="type",$r=(function(i){return i.Space="m.space",i.UnstableCall="org.matrix.msc3417.call",i.ElementVideo="io.element.video",i})({}),Hi="org.matrix.msgid",Pa=new Qe("m.room.purpose","org.matrix.msc3088.purpose"),Aa=new Qe("m.enabled","org.matrix.msc3088.enabled"),Da=new Qe("m.data_tree","org.matrix.msc3089.data_tree"),Ao=new Qe("m.leaf","org.matrix.msc3089.leaf"),Jt=new Qe("m.branch","org.matrix.msc3089.branch"),Do=new Qe("m.room.marker","org.matrix.msc2716.marker"),La=new Qe("with_rel_types","org.matrix.msc3912.with_relations"),Lo=new Qe("io.element.functional_members","io.element.functional_members"),Sr=new Qe("m.visibility","org.matrix.msc3531.visibility"),Ua=new Qe("enabled","org.matrix.msc3881.enabled"),mc=new Qe("device_id","org.matrix.msc3881.device_id"),Uo=new Qe("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),Di=new Qe("thread_id","org.matrix.msc4023.thread_id"),No=new Nn("membership","io.element.msc4115.membership"),Se=(function(i){return i.Ban="ban",i.Invite="invite",i.Join="join",i.Knock="knock",i.Leave="leave",i})({}),pt=(function(i){return i.Membership="RoomMember.membership",i.Name="RoomMember.name",i.PowerLevel="RoomMember.powerLevel",i.Typing="RoomMember.typing",i})({});class Cn extends Ke{constructor(e,t){super(),this.roomId=e,this.userId=t,c(this,"_isOutOfBand",!1),c(this,"modified",-1),c(this,"requestedProfileInfo",!1),c(this,"typing",!1),c(this,"name",void 0),c(this,"rawDisplayName",void 0),c(this,"powerLevel",0),c(this,"user",void 0),c(this,"membership",void 0),c(this,"disambiguate",!1),c(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var r,n,a=(r=e.getDirectionalContent().displayname)!==null&&r!==void 0?r:"";if(e.getType()===F.RoomMember){this._isOutOfBand=!1,this.events.member=e;var s=this.membership;this.membership=e.getDirectionalContent().membership,this.membership===void 0&&O.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=Kv(this.userId,a,t);var o=this.name;this.name=qv(this.userId,a,this.disambiguate),this.rawDisplayName=Zs((n=e.getDirectionalContent().displayname)!==null&&n!==void 0?n:""),(!this.rawDisplayName||!Hr(this.rawDisplayName))&&(this.rawDisplayName=this.userId),s!==this.membership&&(this.updateModifiedTime(),this.emit(pt.Membership,e,this,s)),o!==this.name&&(this.updateModifiedTime(),this.emit(pt.Name,e,this,o))}}setPowerLevel(e,t){var r=this.powerLevel;this.powerLevel=e,r!==this.powerLevel&&(this.updateModifiedTime(),this.emit(pt.PowerLevel,t,this))}setTypingEvent(e){if(e.getType()==="m.typing"){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;Array.isArray(r)&&(r.indexOf(this.userId)!==-1&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(pt.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===Se.Leave&&this.events.member!==void 0&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if(t.membership===Se.Join&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),t.membership===Se.Invite&&t.is_direct)return r}}getAvatarUrl(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5?arguments[5]:void 0,o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:!1,d=this.getMxcAvatarUrl();if(!d&&!a)return null;var l=Gi(e,d,t,r,n,s,void 0,o);return l||null}getMxcAvatarUrl(){if(this.events.member)return this.events.member.getDirectionalContent().avatar_url;if(this.user)return this.user.avatarUrl}}var ts=/@.+:.+/,Wv=/[\u200E\u200F\u202A-\u202F]/;function Kv(i,e,t){if(!e||e===i||!t)return!1;var r=Hr(e);if(!r)return!1;if(ts.test(r)||Wv.test(e))return!0;var n=t.getUserIdsWithDisplayName(e);return!!n.some(a=>a!==i)}function qv(i,e,t){return!e||e===i?i:t?Zs(e)+" ("+i+")":Hr(e)?Zs(e):i}var Cs={},$n={},Jn={},nd;function gc(){if(nd)return Jn;nd=1,Object.defineProperty(Jn,"__esModule",{value:!0}),Jn.NamespacedMap=void 0;function i(d,l){var u=typeof Symbol<"u"&&d[Symbol.iterator]||d["@@iterator"];if(!u){if(Array.isArray(d)||(u=e(d))||l){u&&(d=u);var h=0,v=function(){};return{s:v,n:function(){return h>=d.length?{done:!0}:{done:!1,value:d[h++]}},e:function(R){throw R},f:v}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var m=!0,f=!1,g;return{s:function(){u=u.call(d)},n:function(){var R=u.next();return m=R.done,R},e:function(R){f=!0,g=R},f:function(){try{!m&&u.return!=null&&u.return()}finally{if(f)throw g}}}}function e(d,l){if(d){if(typeof d=="string")return t(d,l);var u=Object.prototype.toString.call(d).slice(8,-1);if(u==="Object"&&d.constructor&&(u=d.constructor.name),u==="Map"||u==="Set")return Array.from(d);if(u==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(u))return t(d,l)}}function t(d,l){(l==null||l>d.length)&&(l=d.length);for(var u=0,h=new Array(l);u<l;u++)h[u]=d[u];return h}function r(d,l){if(!(d instanceof l))throw new TypeError("Cannot call a class as a function")}function n(d,l){for(var u=0;u<l.length;u++){var h=l[u];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(d,h.key,h)}}function a(d,l,u){return l&&n(d.prototype,l),Object.defineProperty(d,"prototype",{writable:!1}),d}function s(d,l,u){return l in d?Object.defineProperty(d,l,{value:u,enumerable:!0,configurable:!0,writable:!0}):d[l]=u,d}var o=(function(){function d(l){if(r(this,d),s(this,"internalMap",new Map),l){var u=i(l),h;try{for(u.s();!(h=u.n()).done;){var v=h.value;this.set(v[0],v[1])}}catch(m){u.e(m)}finally{u.f()}}}return a(d,[{key:"get",value:function(u){return u.name&&this.internalMap.has(u.name)?this.internalMap.get(u.name):u.altName&&this.internalMap.has(u.altName)?this.internalMap.get(u.altName):null}},{key:"set",value:function(u,h){u.name&&this.internalMap.set(u.name,h),u.altName&&this.internalMap.set(u.altName,h)}},{key:"has",value:function(u){return!!this.get(u)}},{key:"delete",value:function(u){u.name&&this.internalMap.delete(u.name),u.altName&&this.internalMap.delete(u.altName)}},{key:"hasNamespaced",value:function(u){return this.internalMap.has(u)}},{key:"getNamespaced",value:function(u){return this.internalMap.get(u)}}]),d})();return Jn.NamespacedMap=o,Jn}var zn={},id;function Bn(){if(id)return zn;id=1;function i(f){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(g){return typeof g}:function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},i(f)}Object.defineProperty(zn,"__esModule",{value:!0}),zn.InvalidEventError=void 0;function e(f,g,T){return Object.defineProperty(f,"prototype",{writable:!1}),f}function t(f,g){if(!(f instanceof g))throw new TypeError("Cannot call a class as a function")}function r(f,g){if(typeof g!="function"&&g!==null)throw new TypeError("Super expression must either be null or a function");f.prototype=Object.create(g&&g.prototype,{constructor:{value:f,writable:!0,configurable:!0}}),Object.defineProperty(f,"prototype",{writable:!1}),g&&h(f,g)}function n(f){var g=l();return function(){var R=v(f),S;if(g){var I=v(this).constructor;S=Reflect.construct(R,arguments,I)}else S=R.apply(this,arguments);return a(this,S)}}function a(f,g){if(g&&(i(g)==="object"||typeof g=="function"))return g;if(g!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return s(f)}function s(f){if(f===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return f}function o(f){var g=typeof Map=="function"?new Map:void 0;return o=function(R){if(R===null||!u(R))return R;if(typeof R!="function")throw new TypeError("Super expression must either be null or a function");if(typeof g<"u"){if(g.has(R))return g.get(R);g.set(R,S)}function S(){return d(R,arguments,v(this).constructor)}return S.prototype=Object.create(R.prototype,{constructor:{value:S,enumerable:!1,writable:!0,configurable:!0}}),h(S,R)},o(f)}function d(f,g,T){return l()?d=Reflect.construct:d=function(S,I,b){var w=[null];w.push.apply(w,I);var p=Function.bind.apply(S,w),E=new p;return b&&h(E,b.prototype),E},d.apply(null,arguments)}function l(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function u(f){return Function.toString.call(f).indexOf("[native code]")!==-1}function h(f,g){return h=Object.setPrototypeOf||function(R,S){return R.__proto__=S,R},h(f,g)}function v(f){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(T){return T.__proto__||Object.getPrototypeOf(T)},v(f)}var m=(function(f){r(T,f);var g=n(T);function T(R){return t(this,T),g.call(this,R)}return e(T)})(o(Error));return zn.InvalidEventError=m,zn}var dn={},Yn={},Xn={},ad;function $i(){if(ad)return Xn;ad=1,Object.defineProperty(Xn,"__esModule",{value:!0}),Xn.ExtensibleEvent=void 0;function i(n,a){if(!(n instanceof a))throw new TypeError("Cannot call a class as a function")}function e(n,a){for(var s=0;s<a.length;s++){var o=a[s];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(n,o.key,o)}}function t(n,a,s){return a&&e(n.prototype,a),Object.defineProperty(n,"prototype",{writable:!1}),n}var r=(function(){function n(a){i(this,n),this.wireFormat=a}return t(n,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),n})();return Xn.ExtensibleEvent=r,Xn}var Qn={},sd;function yc(){if(sd)return Qn;sd=1,Object.defineProperty(Qn,"__esModule",{value:!0}),Qn.isOptionalAString=i,Qn.isProvided=e;function i(t){return e(t)&&typeof t=="string"}function e(t){return t!=null}return Qn}var _t={},Pr={},od;function Wn(){if(od)return Pr;od=1;function i(m){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(f){return typeof f}:function(f){return f&&typeof Symbol=="function"&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f},i(m)}Object.defineProperty(Pr,"__esModule",{value:!0}),Pr.UnstableValue=Pr.NamespacedValue=void 0;function e(m,f){if(typeof f!="function"&&f!==null)throw new TypeError("Super expression must either be null or a function");m.prototype=Object.create(f&&f.prototype,{constructor:{value:m,writable:!0,configurable:!0}}),Object.defineProperty(m,"prototype",{writable:!1}),f&&t(m,f)}function t(m,f){return t=Object.setPrototypeOf||function(T,R){return T.__proto__=R,T},t(m,f)}function r(m){var f=s();return function(){var T=o(m),R;if(f){var S=o(this).constructor;R=Reflect.construct(T,arguments,S)}else R=T.apply(this,arguments);return n(this,R)}}function n(m,f){if(f&&(i(f)==="object"||typeof f=="function"))return f;if(f!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return a(m)}function a(m){if(m===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return m}function s(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function o(m){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(g){return g.__proto__||Object.getPrototypeOf(g)},o(m)}function d(m,f){if(!(m instanceof f))throw new TypeError("Cannot call a class as a function")}function l(m,f){for(var g=0;g<f.length;g++){var T=f[g];T.enumerable=T.enumerable||!1,T.configurable=!0,"value"in T&&(T.writable=!0),Object.defineProperty(m,T.key,T)}}function u(m,f,g){return f&&l(m.prototype,f),Object.defineProperty(m,"prototype",{writable:!1}),m}var h=(function(){function m(f,g){if(d(this,m),this.stable=f,this.unstable=g,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return u(m,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(g){return!!this.name&&this.name===g||!!this.altName&&this.altName===g}},{key:"findIn",value:function(g){var T;return this.name&&(T=g?.[this.name]),!T&&this.altName&&(T=g?.[this.altName]),T}},{key:"includedIn",value:function(g){var T=!1;return this.name&&(T=g.includes(this.name)),!T&&this.altName&&(T=g.includes(this.altName)),T}}]),m})();Pr.NamespacedValue=h;var v=(function(m){e(g,m);var f=r(g);function g(T,R){var S;if(d(this,g),S=f.call(this,T,R),!S.unstable)throw new Error("Unstable value must be supplied");return S}return u(g,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),g})(h);return Pr.UnstableValue=v,Pr}var ld;function Xt(){if(ld)return _t;ld=1,Object.defineProperty(_t,"__esModule",{value:!0}),_t.M_TEXT=_t.M_NOTICE=_t.M_MESSAGE=_t.M_HTML=_t.M_EMOTE=void 0;var i=Wn(),e=new i.UnstableValue("m.message","org.matrix.msc1767.message");_t.M_MESSAGE=e;var t=new i.UnstableValue("m.text","org.matrix.msc1767.text");_t.M_TEXT=t;var r=new i.UnstableValue("m.html","org.matrix.msc1767.html");_t.M_HTML=r;var n=new i.UnstableValue("m.emote","org.matrix.msc1767.emote");_t.M_EMOTE=n;var a=new i.UnstableValue("m.notice","org.matrix.msc1767.notice");return _t.M_NOTICE=a,_t}var aa={},dd;function rn(){if(dd)return aa;dd=1,Object.defineProperty(aa,"__esModule",{value:!0}),aa.isEventTypeSame=i;function i(e,t){if(typeof e=="string")return typeof t=="string"?t===e:t.matches(e);if(typeof t=="string")return e.matches(t);var r=t,n=e;return r.matches(n.name)||r.matches(n.altName)}return aa}var ud;function nn(){if(ud)return Yn;ud=1;function i(b){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(w){return typeof w}:function(w){return w&&typeof Symbol=="function"&&w.constructor===Symbol&&w!==Symbol.prototype?"symbol":typeof w},i(b)}Object.defineProperty(Yn,"__esModule",{value:!0}),Yn.MessageEvent=void 0;var e=$i(),t=yc(),r=Bn(),n=Xt(),a=rn();function s(b,w){var p=Object.keys(b);if(Object.getOwnPropertySymbols){var E=Object.getOwnPropertySymbols(b);w&&(E=E.filter(function(y){return Object.getOwnPropertyDescriptor(b,y).enumerable})),p.push.apply(p,E)}return p}function o(b){for(var w=1;w<arguments.length;w++){var p=arguments[w]!=null?arguments[w]:{};w%2?s(Object(p),!0).forEach(function(E){S(b,E,p[E])}):Object.getOwnPropertyDescriptors?Object.defineProperties(b,Object.getOwnPropertyDescriptors(p)):s(Object(p)).forEach(function(E){Object.defineProperty(b,E,Object.getOwnPropertyDescriptor(p,E))})}return b}function d(b,w){if(!(b instanceof w))throw new TypeError("Cannot call a class as a function")}function l(b,w){for(var p=0;p<w.length;p++){var E=w[p];E.enumerable=E.enumerable||!1,E.configurable=!0,"value"in E&&(E.writable=!0),Object.defineProperty(b,E.key,E)}}function u(b,w,p){return w&&l(b.prototype,w),p&&l(b,p),Object.defineProperty(b,"prototype",{writable:!1}),b}function h(b,w){if(typeof w!="function"&&w!==null)throw new TypeError("Super expression must either be null or a function");b.prototype=Object.create(w&&w.prototype,{constructor:{value:b,writable:!0,configurable:!0}}),Object.defineProperty(b,"prototype",{writable:!1}),w&&v(b,w)}function v(b,w){return v=Object.setPrototypeOf||function(E,y){return E.__proto__=y,E},v(b,w)}function m(b){var w=T();return function(){var E=R(b),y;if(w){var P=R(this).constructor;y=Reflect.construct(E,arguments,P)}else y=E.apply(this,arguments);return f(this,y)}}function f(b,w){if(w&&(i(w)==="object"||typeof w=="function"))return w;if(w!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return g(b)}function g(b){if(b===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b}function T(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function R(b){return R=Object.setPrototypeOf?Object.getPrototypeOf:function(p){return p.__proto__||Object.getPrototypeOf(p)},R(b)}function S(b,w,p){return w in b?Object.defineProperty(b,w,{value:p,enumerable:!0,configurable:!0,writable:!0}):b[w]=p,b}var I=(function(b){h(p,b);var w=m(p);function p(E){var y;d(this,p),y=w.call(this,E),S(g(y),"text",void 0),S(g(y),"html",void 0),S(g(y),"renderings",void 0);var P=n.M_MESSAGE.findIn(y.wireContent),N=n.M_TEXT.findIn(y.wireContent),V=n.M_HTML.findIn(y.wireContent);if((0,t.isProvided)(P)){if(!Array.isArray(P))throw new r.InvalidEventError("m.message contents must be an array");var Q=P.find(function(Ae){return!(0,t.isProvided)(Ae.mimetype)||Ae.mimetype==="text/plain"}),le=P.find(function(Ae){return Ae.mimetype==="text/html"});if(!Q)throw new r.InvalidEventError("m.message is missing a plain text representation");y.text=Q.body,y.html=le?.body,y.renderings=P}else if((0,t.isOptionalAString)(N))y.text=N,y.html=V,y.renderings=[{body:N,mimetype:"text/plain"}],y.html&&y.renderings.push({body:y.html,mimetype:"text/html"});else throw new r.InvalidEventError("Missing textual representation for event");return y}return u(p,[{key:"isEmote",get:function(){return n.M_EMOTE.matches(this.wireFormat.type)||(0,t.isProvided)(n.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return n.M_NOTICE.matches(this.wireFormat.type)||(0,t.isProvided)(n.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(y){return(0,a.isEventTypeSame)(y,n.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var y=S({},n.M_MESSAGE.name,this.renderings);if(this.renderings.length===1){var P=this.renderings[0].mimetype;(P===void 0||P==="text/plain")&&(y=S({},n.M_TEXT.name,this.renderings[0].body))}return y}},{key:"serialize",value:function(){var y;return{type:"m.room.message",content:o(o({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:(y=this.html)!==null&&y!==void 0?y:void 0})}}}],[{key:"from",value:function(y,P){var N;return new p({type:n.M_MESSAGE.name,content:(N={},S(N,n.M_TEXT.name,y),S(N,n.M_HTML.name,P),N)})}}]),p})(e.ExtensibleEvent);return Yn.MessageEvent=I,Yn}var Zn={},cd;function xo(){if(cd)return Zn;cd=1;function i(S){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},i(S)}Object.defineProperty(Zn,"__esModule",{value:!0}),Zn.NoticeEvent=void 0;var e=nn(),t=Xt(),r=rn();function n(S,I,b){return I in S?Object.defineProperty(S,I,{value:b,enumerable:!0,configurable:!0,writable:!0}):S[I]=b,S}function a(S,I){if(!(S instanceof I))throw new TypeError("Cannot call a class as a function")}function s(S,I){for(var b=0;b<I.length;b++){var w=I[b];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(S,w.key,w)}}function o(S,I,b){return I&&s(S.prototype,I),b&&s(S,b),Object.defineProperty(S,"prototype",{writable:!1}),S}function d(){return typeof Reflect<"u"&&Reflect.get?d=Reflect.get:d=function(I,b,w){var p=l(I,b);if(p){var E=Object.getOwnPropertyDescriptor(p,b);return E.get?E.get.call(arguments.length<3?I:w):E.value}},d.apply(this,arguments)}function l(S,I){for(;!Object.prototype.hasOwnProperty.call(S,I)&&(S=T(S),S!==null););return S}function u(S,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");S.prototype=Object.create(I&&I.prototype,{constructor:{value:S,writable:!0,configurable:!0}}),Object.defineProperty(S,"prototype",{writable:!1}),I&&h(S,I)}function h(S,I){return h=Object.setPrototypeOf||function(w,p){return w.__proto__=p,w},h(S,I)}function v(S){var I=g();return function(){var w=T(S),p;if(I){var E=T(this).constructor;p=Reflect.construct(w,arguments,E)}else p=w.apply(this,arguments);return m(this,p)}}function m(S,I){if(I&&(i(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return f(S)}function f(S){if(S===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return S}function g(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function T(S){return T=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},T(S)}var R=(function(S){u(b,S);var I=v(b);function b(w){return a(this,b),I.call(this,w)}return o(b,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(p){return(0,r.isEventTypeSame)(p,t.M_NOTICE)||d(T(b.prototype),"isEquivalentTo",this).call(this,p)}},{key:"serialize",value:function(){var p=d(T(b.prototype),"serialize",this).call(this);return p.content.msgtype="m.notice",p}}],[{key:"from",value:function(p,E){var y;return new b({type:t.M_NOTICE.name,content:(y={},n(y,t.M_TEXT.name,p),n(y,t.M_HTML.name,E),y)})}}]),b})(e.MessageEvent);return Zn.NoticeEvent=R,Zn}var ei={},hd;function Fo(){if(hd)return ei;hd=1;function i(S){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},i(S)}Object.defineProperty(ei,"__esModule",{value:!0}),ei.EmoteEvent=void 0;var e=nn(),t=Xt(),r=rn();function n(S,I,b){return I in S?Object.defineProperty(S,I,{value:b,enumerable:!0,configurable:!0,writable:!0}):S[I]=b,S}function a(S,I){if(!(S instanceof I))throw new TypeError("Cannot call a class as a function")}function s(S,I){for(var b=0;b<I.length;b++){var w=I[b];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(S,w.key,w)}}function o(S,I,b){return I&&s(S.prototype,I),b&&s(S,b),Object.defineProperty(S,"prototype",{writable:!1}),S}function d(){return typeof Reflect<"u"&&Reflect.get?d=Reflect.get:d=function(I,b,w){var p=l(I,b);if(p){var E=Object.getOwnPropertyDescriptor(p,b);return E.get?E.get.call(arguments.length<3?I:w):E.value}},d.apply(this,arguments)}function l(S,I){for(;!Object.prototype.hasOwnProperty.call(S,I)&&(S=T(S),S!==null););return S}function u(S,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");S.prototype=Object.create(I&&I.prototype,{constructor:{value:S,writable:!0,configurable:!0}}),Object.defineProperty(S,"prototype",{writable:!1}),I&&h(S,I)}function h(S,I){return h=Object.setPrototypeOf||function(w,p){return w.__proto__=p,w},h(S,I)}function v(S){var I=g();return function(){var w=T(S),p;if(I){var E=T(this).constructor;p=Reflect.construct(w,arguments,E)}else p=w.apply(this,arguments);return m(this,p)}}function m(S,I){if(I&&(i(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return f(S)}function f(S){if(S===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return S}function g(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function T(S){return T=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},T(S)}var R=(function(S){u(b,S);var I=v(b);function b(w){return a(this,b),I.call(this,w)}return o(b,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(p){return(0,r.isEventTypeSame)(p,t.M_EMOTE)||d(T(b.prototype),"isEquivalentTo",this).call(this,p)}},{key:"serialize",value:function(){var p=d(T(b.prototype),"serialize",this).call(this);return p.content.msgtype="m.emote",p}}],[{key:"from",value:function(p,E){var y;return new b({type:t.M_EMOTE.name,content:(y={},n(y,t.M_TEXT.name,p),n(y,t.M_HTML.name,E),y)})}}]),b})(e.MessageEvent);return ei.EmoteEvent=R,ei}var vd;function Sc(){if(vd)return dn;vd=1,Object.defineProperty(dn,"__esModule",{value:!0}),dn.LEGACY_M_ROOM_MESSAGE=void 0,dn.parseMRoomMessage=l;var i=nn(),e=xo(),t=Fo(),r=Wn(),n=Xt();function a(u,h){var v=Object.keys(u);if(Object.getOwnPropertySymbols){var m=Object.getOwnPropertySymbols(u);h&&(m=m.filter(function(f){return Object.getOwnPropertyDescriptor(u,f).enumerable})),v.push.apply(v,m)}return v}function s(u){for(var h=1;h<arguments.length;h++){var v=arguments[h]!=null?arguments[h]:{};h%2?a(Object(v),!0).forEach(function(m){o(u,m,v[m])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(v)):a(Object(v)).forEach(function(m){Object.defineProperty(u,m,Object.getOwnPropertyDescriptor(v,m))})}return u}function o(u,h,v){return h in u?Object.defineProperty(u,h,{value:v,enumerable:!0,configurable:!0,writable:!0}):u[h]=v,u}var d=new r.NamespacedValue("m.room.message");dn.LEGACY_M_ROOM_MESSAGE=d;function l(u){var h,v,m;if(n.M_MESSAGE.findIn(u.content)||n.M_TEXT.findIn(u.content))return new i.MessageEvent(u);var f=(h=u.content)===null||h===void 0?void 0:h.msgtype,g=(v=u.content)===null||v===void 0?void 0:v.body,T=((m=u.content)===null||m===void 0?void 0:m.format)==="org.matrix.custom.html"?u.content.formatted_body:null;if(f==="m.text"){var R;return new i.MessageEvent(s(s({},u),{},{content:s(s({},u.content),{},(R={},o(R,n.M_TEXT.name,g),o(R,n.M_HTML.name,T),R))}))}else if(f==="m.notice"){var S;return new e.NoticeEvent(s(s({},u),{},{content:s(s({},u.content),{},(S={},o(S,n.M_TEXT.name,g),o(S,n.M_HTML.name,T),S))}))}else if(f==="m.emote"){var I;return new t.EmoteEvent(s(s({},u),{},{content:s(s({},u.content),{},(I={},o(I,n.M_TEXT.name,g),o(I,n.M_HTML.name,T),I))}))}else return null}return dn}var sa={},fd;function bc(){if(fd)return sa;fd=1,Object.defineProperty(sa,"__esModule",{value:!0}),sa.parseMMessage=n;var i=nn(),e=Xt(),t=Fo(),r=xo();function n(a){return e.M_EMOTE.matches(a.type)?new t.EmoteEvent(a):e.M_NOTICE.matches(a.type)?new r.NoticeEvent(a):new i.MessageEvent(a)}return sa}var wt={},pd;function Kn(){if(pd)return wt;pd=1,Object.defineProperty(wt,"__esModule",{value:!0}),wt.M_POLL_START=wt.M_POLL_RESPONSE=wt.M_POLL_KIND_UNDISCLOSED=wt.M_POLL_KIND_DISCLOSED=wt.M_POLL_END=void 0;var i=Wn(),e=new i.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");wt.M_POLL_KIND_DISCLOSED=e;var t=new i.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");wt.M_POLL_KIND_UNDISCLOSED=t;var r=new i.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");wt.M_POLL_START=r;var n=new i.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");wt.M_POLL_RESPONSE=n;var a=new i.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");return wt.M_POLL_END=a,wt}var oa={},Ar={},md;function Ec(){if(md)return Ar;md=1;function i($){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(ae){return typeof ae}:function(ae){return ae&&typeof Symbol=="function"&&ae.constructor===Symbol&&ae!==Symbol.prototype?"symbol":typeof ae},i($)}Object.defineProperty(Ar,"__esModule",{value:!0}),Ar.PollStartEvent=Ar.PollAnswerSubevent=void 0;var e=Kn(),t=nn(),r=Xt(),n=Bn(),a=Wn(),s=rn(),o=$i();function d($){return v($)||h($)||u($)||l()}function l(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function u($,ae){if($){if(typeof $=="string")return m($,ae);var se=Object.prototype.toString.call($).slice(8,-1);if(se==="Object"&&$.constructor&&(se=$.constructor.name),se==="Map"||se==="Set")return Array.from($);if(se==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(se))return m($,ae)}}function h($){if(typeof Symbol<"u"&&$[Symbol.iterator]!=null||$["@@iterator"]!=null)return Array.from($)}function v($){if(Array.isArray($))return m($)}function m($,ae){(ae==null||ae>$.length)&&(ae=$.length);for(var se=0,de=new Array(ae);se<ae;se++)de[se]=$[se];return de}function f($,ae){var se=Object.keys($);if(Object.getOwnPropertySymbols){var de=Object.getOwnPropertySymbols($);ae&&(de=de.filter(function(ve){return Object.getOwnPropertyDescriptor($,ve).enumerable})),se.push.apply(se,de)}return se}function g($){for(var ae=1;ae<arguments.length;ae++){var se=arguments[ae]!=null?arguments[ae]:{};ae%2?f(Object(se),!0).forEach(function(de){N($,de,se[de])}):Object.getOwnPropertyDescriptors?Object.defineProperties($,Object.getOwnPropertyDescriptors(se)):f(Object(se)).forEach(function(de){Object.defineProperty($,de,Object.getOwnPropertyDescriptor(se,de))})}return $}function T($,ae){if(!($ instanceof ae))throw new TypeError("Cannot call a class as a function")}function R($,ae){for(var se=0;se<ae.length;se++){var de=ae[se];de.enumerable=de.enumerable||!1,de.configurable=!0,"value"in de&&(de.writable=!0),Object.defineProperty($,de.key,de)}}function S($,ae,se){return ae&&R($.prototype,ae),se&&R($,se),Object.defineProperty($,"prototype",{writable:!1}),$}function I($,ae){if(typeof ae!="function"&&ae!==null)throw new TypeError("Super expression must either be null or a function");$.prototype=Object.create(ae&&ae.prototype,{constructor:{value:$,writable:!0,configurable:!0}}),Object.defineProperty($,"prototype",{writable:!1}),ae&&b($,ae)}function b($,ae){return b=Object.setPrototypeOf||function(de,ve){return de.__proto__=ve,de},b($,ae)}function w($){var ae=y();return function(){var de=P($),ve;if(ae){var Re=P(this).constructor;ve=Reflect.construct(de,arguments,Re)}else ve=de.apply(this,arguments);return p(this,ve)}}function p($,ae){if(ae&&(i(ae)==="object"||typeof ae=="function"))return ae;if(ae!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return E($)}function E($){if($===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return $}function y(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function P($){return P=Object.setPrototypeOf?Object.getPrototypeOf:function(se){return se.__proto__||Object.getPrototypeOf(se)},P($)}function N($,ae,se){return ae in $?Object.defineProperty($,ae,{value:se,enumerable:!0,configurable:!0,writable:!0}):$[ae]=se,$}var V=(function($){I(se,$);var ae=w(se);function se(de){var ve;T(this,se),ve=ae.call(this,de),N(E(ve),"id",void 0);var Re=de.content.id;if(!Re||typeof Re!="string")throw new n.InvalidEventError("Answer ID must be a non-empty string");return ve.id=Re,ve}return S(se,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:g({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(ve,Re){return new se({type:"org.matrix.sdk.poll.answer",content:N({id:ve},r.M_TEXT.name,Re)})}}]),se})(t.MessageEvent);Ar.PollAnswerSubevent=V;var Q=(function($){I(se,$);var ae=w(se);function se(de){var ve;T(this,se),ve=ae.call(this,de),N(E(ve),"question",void 0),N(E(ve),"kind",void 0),N(E(ve),"rawKind",void 0),N(E(ve),"maxSelections",void 0),N(E(ve),"answers",void 0);var Re=e.M_POLL_START.findIn(ve.wireContent);if(!Re.question)throw new n.InvalidEventError("A question is required");if(ve.question=new t.MessageEvent({type:"org.matrix.sdk.poll.question",content:Re.question}),ve.rawKind=Re.kind,e.M_POLL_KIND_DISCLOSED.matches(ve.rawKind)?ve.kind=e.M_POLL_KIND_DISCLOSED:ve.kind=e.M_POLL_KIND_UNDISCLOSED,ve.maxSelections=Number.isFinite(Re.max_selections)&&Re.max_selections>0?Re.max_selections:1,!Array.isArray(Re.answers))throw new n.InvalidEventError("Poll answers must be an array");var et=Re.answers.slice(0,20).map(function(je){return new V({type:"org.matrix.sdk.poll.answer",content:je})});if(et.length<=0)throw new n.InvalidEventError("No answers available");return ve.answers=et,ve}return S(se,[{key:"isEquivalentTo",value:function(ve){return(0,s.isEventTypeSame)(ve,e.M_POLL_START)}},{key:"serialize",value:function(){var ve;return{type:e.M_POLL_START.name,content:(ve={},N(ve,e.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map(function(Re){return Re.serialize().content})}),N(ve,r.M_TEXT.name,"".concat(this.question.text,`
`).concat(this.answers.map(function(Re,et){return"".concat(et+1,". ").concat(Re.text)}).join(`
`))),ve)}}}],[{key:"from",value:function(ve,Re,et){var je,Qt=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1;return new se({type:e.M_POLL_START.name,content:(je={},N(je,r.M_TEXT.name,ve),N(je,e.M_POLL_START.name,{question:N({},r.M_TEXT.name,ve),kind:et instanceof a.NamespacedValue?et.name:et,max_selections:Qt,answers:Re.map(function(H){return N({id:Ae()},r.M_TEXT.name,H)})}),je)})}}]),se})(o.ExtensibleEvent);Ar.PollStartEvent=Q;var le="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function Ae(){return d(Array(16)).map(function(){return le.charAt(Math.floor(Math.random()*le.length))}).join("")}return Ar}var ti={},ri={},gd;function jo(){if(gd)return ri;gd=1,Object.defineProperty(ri,"__esModule",{value:!0}),ri.REFERENCE_RELATION=void 0;var i=Wn(),e=new i.NamespacedValue("m.reference");return ri.REFERENCE_RELATION=e,ri}var yd;function _c(){if(yd)return ti;yd=1;function i(S){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(I){return typeof I}:function(I){return I&&typeof Symbol=="function"&&I.constructor===Symbol&&I!==Symbol.prototype?"symbol":typeof I},i(S)}Object.defineProperty(ti,"__esModule",{value:!0}),ti.PollResponseEvent=void 0;var e=$i(),t=Kn(),r=Bn(),n=jo(),a=rn();function s(S,I){if(!(S instanceof I))throw new TypeError("Cannot call a class as a function")}function o(S,I){for(var b=0;b<I.length;b++){var w=I[b];w.enumerable=w.enumerable||!1,w.configurable=!0,"value"in w&&(w.writable=!0),Object.defineProperty(S,w.key,w)}}function d(S,I,b){return I&&o(S.prototype,I),b&&o(S,b),Object.defineProperty(S,"prototype",{writable:!1}),S}function l(S,I){if(typeof I!="function"&&I!==null)throw new TypeError("Super expression must either be null or a function");S.prototype=Object.create(I&&I.prototype,{constructor:{value:S,writable:!0,configurable:!0}}),Object.defineProperty(S,"prototype",{writable:!1}),I&&u(S,I)}function u(S,I){return u=Object.setPrototypeOf||function(w,p){return w.__proto__=p,w},u(S,I)}function h(S){var I=f();return function(){var w=g(S),p;if(I){var E=g(this).constructor;p=Reflect.construct(w,arguments,E)}else p=w.apply(this,arguments);return v(this,p)}}function v(S,I){if(I&&(i(I)==="object"||typeof I=="function"))return I;if(I!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return m(S)}function m(S){if(S===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return S}function f(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function g(S){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(b){return b.__proto__||Object.getPrototypeOf(b)},g(S)}function T(S,I,b){return I in S?Object.defineProperty(S,I,{value:b,enumerable:!0,configurable:!0,writable:!0}):S[I]=b,S}var R=(function(S){l(b,S);var I=h(b);function b(w){var p;s(this,b),p=I.call(this,w),T(m(p),"internalAnswerIds",void 0),T(m(p),"internalSpoiled",void 0),T(m(p),"pollEventId",void 0);var E=p.wireContent["m.relates_to"];if(!n.REFERENCE_RELATION.matches(E?.rel_type)||typeof E?.event_id!="string")throw new r.InvalidEventError("Relationship must be a reference to an event");return p.pollEventId=E.event_id,p.validateAgainst(null),p}return d(b,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(p){var E=t.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(E?.answers)){this.internalSpoiled=!0,this.internalAnswerIds=[];return}var y=E.answers;if(y.some(function(P){return typeof P!="string"})||y.length===0){this.internalSpoiled=!0,this.internalAnswerIds=[];return}if(p){if(y.some(function(P){return!p.answers.some(function(N){return N.id===P})})){this.internalSpoiled=!0,this.internalAnswerIds=[];return}y=y.slice(0,p.maxSelections)}this.internalAnswerIds=y,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(p){return(0,a.isEventTypeSame)(p,t.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:t.M_POLL_RESPONSE.name,content:T({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:this.pollEventId}},t.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(p,E){return new b({type:t.M_POLL_RESPONSE.name,content:T({"m.relates_to":{rel_type:n.REFERENCE_RELATION.name,event_id:E}},t.M_POLL_RESPONSE.name,{answers:p})})}}]),b})(e.ExtensibleEvent);return ti.PollResponseEvent=R,ti}var ni={},Sd;function wc(){if(Sd)return ni;Sd=1;function i(p){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(E){return typeof E}:function(E){return E&&typeof Symbol=="function"&&E.constructor===Symbol&&E!==Symbol.prototype?"symbol":typeof E},i(p)}Object.defineProperty(ni,"__esModule",{value:!0}),ni.PollEndEvent=void 0;var e=Kn(),t=Bn(),r=jo(),n=nn(),a=Xt(),s=rn(),o=$i();function d(p,E){var y=Object.keys(p);if(Object.getOwnPropertySymbols){var P=Object.getOwnPropertySymbols(p);E&&(P=P.filter(function(N){return Object.getOwnPropertyDescriptor(p,N).enumerable})),y.push.apply(y,P)}return y}function l(p){for(var E=1;E<arguments.length;E++){var y=arguments[E]!=null?arguments[E]:{};E%2?d(Object(y),!0).forEach(function(P){b(p,P,y[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(y)):d(Object(y)).forEach(function(P){Object.defineProperty(p,P,Object.getOwnPropertyDescriptor(y,P))})}return p}function u(p,E){if(!(p instanceof E))throw new TypeError("Cannot call a class as a function")}function h(p,E){for(var y=0;y<E.length;y++){var P=E[y];P.enumerable=P.enumerable||!1,P.configurable=!0,"value"in P&&(P.writable=!0),Object.defineProperty(p,P.key,P)}}function v(p,E,y){return E&&h(p.prototype,E),y&&h(p,y),Object.defineProperty(p,"prototype",{writable:!1}),p}function m(p,E){if(typeof E!="function"&&E!==null)throw new TypeError("Super expression must either be null or a function");p.prototype=Object.create(E&&E.prototype,{constructor:{value:p,writable:!0,configurable:!0}}),Object.defineProperty(p,"prototype",{writable:!1}),E&&f(p,E)}function f(p,E){return f=Object.setPrototypeOf||function(P,N){return P.__proto__=N,P},f(p,E)}function g(p){var E=S();return function(){var P=I(p),N;if(E){var V=I(this).constructor;N=Reflect.construct(P,arguments,V)}else N=P.apply(this,arguments);return T(this,N)}}function T(p,E){if(E&&(i(E)==="object"||typeof E=="function"))return E;if(E!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return R(p)}function R(p){if(p===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return p}function S(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function I(p){return I=Object.setPrototypeOf?Object.getPrototypeOf:function(y){return y.__proto__||Object.getPrototypeOf(y)},I(p)}function b(p,E,y){return E in p?Object.defineProperty(p,E,{value:y,enumerable:!0,configurable:!0,writable:!0}):p[E]=y,p}var w=(function(p){m(y,p);var E=g(y);function y(P){var N;u(this,y),N=E.call(this,P),b(R(N),"pollEventId",void 0),b(R(N),"closingMessage",void 0);var V=N.wireContent["m.relates_to"];if(!r.REFERENCE_RELATION.matches(V?.rel_type)||typeof V?.event_id!="string")throw new t.InvalidEventError("Relationship must be a reference to an event");return N.pollEventId=V.event_id,N.closingMessage=new n.MessageEvent(N.wireFormat),N}return v(y,[{key:"isEquivalentTo",value:function(N){return(0,s.isEventTypeSame)(N,e.M_POLL_END)}},{key:"serialize",value:function(){return{type:e.M_POLL_END.name,content:l(b({"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:this.pollEventId}},e.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(N,V){var Q;return new y({type:e.M_POLL_END.name,content:(Q={"m.relates_to":{rel_type:r.REFERENCE_RELATION.name,event_id:N}},b(Q,e.M_POLL_END.name,{}),b(Q,a.M_TEXT.name,V),Q)})}}]),y})(o.ExtensibleEvent);return ni.PollEndEvent=w,ni}var bd;function Rc(){if(bd)return oa;bd=1,Object.defineProperty(oa,"__esModule",{value:!0}),oa.parseMPoll=n;var i=Kn(),e=Ec(),t=_c(),r=wc();function n(a){return i.M_POLL_START.matches(a.type)?new e.PollStartEvent(a):i.M_POLL_RESPONSE.matches(a.type)?new t.PollResponseEvent(a):i.M_POLL_END.matches(a.type)?new r.PollEndEvent(a):null}return oa}var Ed;function Vv(){if(Ed)return $n;Ed=1,Object.defineProperty($n,"__esModule",{value:!0}),$n.ExtensibleEvents=void 0;var i=gc(),e=Bn(),t=Sc(),r=bc(),n=Xt(),a=Kn(),s=Rc();function o(g,T){var R=typeof Symbol<"u"&&g[Symbol.iterator]||g["@@iterator"];if(!R){if(Array.isArray(g)||(R=d(g))||T){R&&(g=R);var S=0,I=function(){};return{s:I,n:function(){return S>=g.length?{done:!0}:{done:!1,value:g[S++]}},e:function(y){throw y},f:I}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var b=!0,w=!1,p;return{s:function(){R=R.call(g)},n:function(){var y=R.next();return b=y.done,y},e:function(y){w=!0,p=y},f:function(){try{!b&&R.return!=null&&R.return()}finally{if(w)throw p}}}}function d(g,T){if(g){if(typeof g=="string")return l(g,T);var R=Object.prototype.toString.call(g).slice(8,-1);if(R==="Object"&&g.constructor&&(R=g.constructor.name),R==="Map"||R==="Set")return Array.from(g);if(R==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(R))return l(g,T)}}function l(g,T){(T==null||T>g.length)&&(T=g.length);for(var R=0,S=new Array(T);R<T;R++)S[R]=g[R];return S}function u(g,T){if(!(g instanceof T))throw new TypeError("Cannot call a class as a function")}function h(g,T){for(var R=0;R<T.length;R++){var S=T[R];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(g,S.key,S)}}function v(g,T,R){return T&&h(g.prototype,T),R&&h(g,R),Object.defineProperty(g,"prototype",{writable:!1}),g}function m(g,T,R){return T in g?Object.defineProperty(g,T,{value:R,enumerable:!0,configurable:!0,writable:!0}):g[T]=R,g}var f=(function(){function g(){u(this,g),m(this,"interpreters",new i.NamespacedMap([[t.LEGACY_M_ROOM_MESSAGE,t.parseMRoomMessage],[n.M_MESSAGE,r.parseMMessage],[n.M_EMOTE,r.parseMMessage],[n.M_NOTICE,r.parseMMessage],[a.M_POLL_START,s.parseMPoll],[a.M_POLL_RESPONSE,s.parseMPoll],[a.M_POLL_END,s.parseMPoll]])),m(this,"_unknownInterpretOrder",[n.M_MESSAGE])}return v(g,[{key:"unknownInterpretOrder",get:function(){var R;return(R=this._unknownInterpretOrder)!==null&&R!==void 0?R:[]},set:function(R){this._unknownInterpretOrder=R}},{key:"registerInterpreter",value:function(R,S){this.interpreters.set(R,S)}},{key:"parse",value:function(R){try{if(this.interpreters.hasNamespaced(R.type))return this.interpreters.getNamespaced(R.type)(R);var S=o(this.unknownInterpretOrder),I;try{for(S.s();!(I=S.n()).done;){var b=I.value;if(this.interpreters.has(b)){var w=this.interpreters.get(b)(R);if(w)return w}}}catch(p){S.e(p)}finally{S.f()}return null}catch(p){if(p instanceof e.InvalidEventError)return null;throw p}}}],[{key:"defaultInstance",get:function(){return g._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return g.defaultInstance.unknownInterpretOrder},set:function(R){g.defaultInstance.unknownInterpretOrder=R}},{key:"registerInterpreter",value:function(R,S){g.defaultInstance.registerInterpreter(R,S)}},{key:"parse",value:function(R){return g.defaultInstance.parse(R)}}]),g})();return $n.ExtensibleEvents=f,m(f,"_defaultInstance",new f),$n}var Os={},_d;function Gv(){return _d||(_d=1,Object.defineProperty(Os,"__esModule",{value:!0})),Os}var Dr={},wd;function Hv(){if(wd)return Dr;wd=1,Object.defineProperty(Dr,"__esModule",{value:!0}),Dr.LegacyMsgType=void 0,Dr.isEventLike=t;var i=Xt(),e;Dr.LegacyMsgType=e,(function(r){r.Text="m.text",r.Notice="m.notice",r.Emote="m.emote"})(e||(Dr.LegacyMsgType=e={}));function t(r,n){var a=r.content;return n===e.Text?i.M_MESSAGE.matches(r.type)||r.type==="m.room.message"&&a?.msgtype==="m.text":n===e.Emote?i.M_EMOTE.matches(r.type)||r.type==="m.room.message"&&a?.msgtype==="m.emote":n===e.Notice?i.M_NOTICE.matches(r.type)||r.type==="m.room.message"&&a?.msgtype==="m.notice":!1}return Dr}var Rd;function $v(){return Rd||(Rd=1,(function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=Vv();Object.keys(e).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===e[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return e[p]}})});var t=Gv();Object.keys(t).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===t[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return t[p]}})});var r=Bn();Object.keys(r).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===r[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return r[p]}})});var n=Wn();Object.keys(n).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===n[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return n[p]}})});var a=gc();Object.keys(a).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===a[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return a[p]}})});var s=yc();Object.keys(s).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===s[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return s[p]}})});var o=Hv();Object.keys(o).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===o[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return o[p]}})});var d=rn();Object.keys(d).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===d[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return d[p]}})});var l=Sc();Object.keys(l).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===l[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return l[p]}})});var u=bc();Object.keys(u).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===u[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return u[p]}})});var h=Rc();Object.keys(h).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===h[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return h[p]}})});var v=jo();Object.keys(v).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===v[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return v[p]}})});var m=$i();Object.keys(m).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===m[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return m[p]}})});var f=Xt();Object.keys(f).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===f[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return f[p]}})});var g=nn();Object.keys(g).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===g[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return g[p]}})});var T=Fo();Object.keys(T).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===T[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return T[p]}})});var R=xo();Object.keys(R).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===R[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return R[p]}})});var S=Kn();Object.keys(S).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===S[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return S[p]}})});var I=Ec();Object.keys(I).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===I[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return I[p]}})});var b=_c();Object.keys(b).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===b[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return b[p]}})});var w=wc();Object.keys(w).forEach(function(p){p==="default"||p==="__esModule"||p in i&&i[p]===w[p]||Object.defineProperty(i,p,{enumerable:!0,get:function(){return w[p]}})})})(Cs)),Cs}var Et=$v();function Jv(i,e){if(i==null)return{};var t={};for(var r in i)if({}.hasOwnProperty.call(i,r)){if(e.indexOf(r)!==-1)continue;t[r]=i[r]}return t}function zv(i,e){if(i==null)return{};var t,r,n=Jv(i,e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(i);for(r=0;r<a.length;r++)t=a[r],e.indexOf(t)===-1&&{}.propertyIsEnumerable.call(i,t)&&(n[t]=i[t])}return n}var gt=(function(i){return i.DisplayName="User.displayName",i.AvatarUrl="User.avatarUrl",i.Presence="User.presence",i.CurrentlyActive="User.currentlyActive",i.LastPresenceTs="User.lastPresenceTs",i})({});class Yt extends Ke{constructor(e){super(),this.userId=e,c(this,"modified",-1),c(this,"displayName",void 0),c(this,"rawDisplayName",void 0),c(this,"avatarUrl",void 0),c(this,"presenceStatusMsg",void 0),c(this,"presence","offline"),c(this,"lastActiveAgo",0),c(this,"lastPresenceTs",0),c(this,"currentlyActive",!1),c(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var r=new Yt(e);return t.reEmitter.reEmit(r,[gt.AvatarUrl,gt.DisplayName,gt.Presence,gt.CurrentlyActive,gt.LastPresenceTs]),r}setPresenceEvent(e){if(e.getType()==="m.presence"){var t=this.events.presence===null;this.events.presence=e;var r=[];(e.getContent().presence!==this.presence||t)&&r.push(gt.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push(gt.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push(gt.DisplayName),e.getContent().currently_active!==void 0&&e.getContent().currently_active!==this.currentlyActive&&r.push(gt.CurrentlyActive),this.presence=e.getContent().presence,r.push(gt.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime();for(var n of r)this.emit(n,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}var be=(function(i){return i.Backward="b",i.Forward="f",i})({});class te{static setEventMetadata(e,t,r){e.setMetadata(t,r)}constructor(e){var t,r;this.eventTimelineSet=e,c(this,"roomId",void 0),c(this,"name",void 0),c(this,"events",[]),c(this,"baseIndex",0),c(this,"startState",void 0),c(this,"endState",void 0),c(this,"startToken",null),c(this,"endToken",null),c(this,"prevTimeline",null),c(this,"nextTimeline",null),c(this,"paginationRequests",{[be.Backward]:null,[be.Forward]:null}),this.roomId=(t=(r=e.room)===null||r===void 0?void 0:r.roomId)!==null&&t!==void 0?t:null,this.roomId&&(this.startState=new Un(this.roomId),this.endState=new Un(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+new Date().toISOString()}initialiseState(e){var t,r,{timelineWasEmpty:n}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");(t=this.startState)===null||t===void 0||t.setStateEvents(e,{timelineWasEmpty:n}),(r=this.endState)===null||r===void 0||r.setStateEvents(e,{timelineWasEmpty:n})}forkLive(e){var t=this.getState(e),r=new te(this.eventTimelineSet);return r.startState=t?.clone(),r.endState=t,this.endState=t?.clone(),r}fork(e){var t=this.getState(e),r=new te(this.eventTimelineSet);return r.startState=t?.clone(),r.endState=t?.clone(),r}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==te.BACKWARDS)return this.startState;if(e==te.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===be.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===be.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==te.BACKWARDS)return this.prevTimeline;if(e==te.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==te.BACKWARDS)this.prevTimeline=e;else if(t==te.FORWARDS)this.nextTimeline=e;else throw new Error("Invalid direction '"+t+"'");this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:r,roomState:n,timelineWasEmpty:a,addToState:s}=t;n||(n=r?this.startState:this.endState);var o=this.getTimelineSet();if(o.room&&(te.setEventMetadata(e,n,r),s&&e.isState()&&o.room.getUnfilteredTimelineSet()===o)){var d;(d=n)===null||d===void 0||d.setStateEvents([e],{timelineWasEmpty:a}),(!e.sender||e.getType()===F.RoomMember&&!r)&&te.setEventMetadata(e,n,r)}var l;r?l=0:l=this.events.length,this.events.splice(l,0,e),r&&this.baseIndex++}insertEvent(e,t,r,n){var a=this.getTimelineSet();a.room&&(te.setEventMetadata(e,r,!1),n&&e.isState()&&a.room.getUnfilteredTimelineSet()===a&&(r.setStateEvents([e],{}),(!e.sender||e.getType()===F.RoomMember)&&te.setEventMetadata(e,r,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var r=this.events[t];if(r.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,r}return null}toString(){return this.name}}c(te,"BACKWARDS",be.Backward);c(te,"FORWARDS",be.Forward);var wi=(function(i){return i.Add="Relations.add",i.Remove="Relations.remove",i.Redaction="Relations.redaction",i})({}),Yv=function(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[];return[t,...r].includes(e)};class rs extends Ke{constructor(e,t,r,n){var a;super(),a=this,this.relationType=e,this.eventType=t,this.altEventTypes=n,c(this,"relationEventIds",new Set),c(this,"relations",new Set),c(this,"annotationsByKey",{}),c(this,"annotationsBySender",{}),c(this,"sortedAnnotationsByKey",[]),c(this,"targetEvent",null),c(this,"creationEmitted",!1),c(this,"client",void 0),c(this,"onEventStatus",(s,o)=>{if(!s.isSending()){s.removeListener(Me.Status,this.onEventStatus);return}o===pe.CANCELLED&&(s.removeListener(Me.Status,this.onEventStatus),this.removeEvent(s))}),c(this,"onBeforeRedaction",(function(){var s=_(function*(o){if(a.relations.has(o)){if(a.relations.delete(o),a.relationType===Ue.Annotation)a.removeAnnotationFromAggregation(o);else if(a.relationType===Ue.Replace&&a.targetEvent&&!a.targetEvent.isState()){var d=yield a.getLastReplacement();a.targetEvent.makeReplaced(d)}o.removeListener(Me.BeforeRedaction,a.onBeforeRedaction),a.emit(wi.Redaction,o)}});return function(o){return s.apply(this,arguments)}})()),this.client=r instanceof zi?r.client:r}addEvent(e){var t=this;return _(function*(){if(!t.relationEventIds.has(e.getId())){var r=e.getRelation();if(!r){O.error("Event must have relation info");return}var n=r.rel_type,a=e.getType();if(t.relationType!==n||!Yv(a,t.eventType,t.altEventTypes)){O.error("Event relation info doesn't match this container");return}if(e.isSending()&&e.on(Me.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===Ue.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===Ue.Replace&&t.targetEvent&&!t.targetEvent.isState()){var s=yield t.getLastReplacement();t.targetEvent.makeReplaced(s)}e.on(Me.BeforeRedaction,t.onBeforeRedaction),t.emit(wi.Add,e),t.maybeEmitCreated()}})()}removeEvent(e){var t=this;return _(function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===Ue.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===Ue.Replace&&t.targetEvent&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();t.targetEvent.makeReplaced(r)}t.emit(wi.Remove,e)}})()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:r}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(r){var n=this.annotationsByKey[r];n||(n=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,n])),n.add(e),this.sortedAnnotationsByKey.sort((o,d)=>{var l=o[1],u=d[1];return u.size-l.size});var a=e.getSender(),s=this.annotationsBySender[a];s||(s=this.annotationsBySender[a]=new Set),s.add(e)}}removeAnnotationFromAggregation(e){var t,{key:r}=(t=e.getRelation())!==null&&t!==void 0?t:{};if(r){var n=this.annotationsByKey[r];n&&(n.delete(e),this.sortedAnnotationsByKey.sort((o,d)=>{var l=o[1],u=d[1];return u.size-l.size}));var a=e.getSender(),s=this.annotationsBySender[a];s&&s.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==Ue.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==Ue.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return _(function*(){if(e.relationType!==Ue.Replace||!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(Ue.Replace),r=t?.origin_server_ts,n=e.getRelations().reduce((a,s)=>s.getSender()!==e.targetEvent.getSender()||r&&r>s.getTs()||a&&a.getTs()>s.getTs()?a:s,null);return n!=null&&n.shouldAttemptDecryption()&&e.client.getCrypto()?yield n.attemptDecryption(e.client.getCrypto()):n!=null&&n.isBeingDecrypted()&&(yield n.getDecryptionPromise()),n})()}setTargetEvent(e){var t=this;return _(function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===Ue.Replace&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();r&&t.targetEvent.makeReplaced(r)}t.maybeEmitCreated()}})()}maybeEmitCreated(){this.creationEmitted||!this.targetEvent||!this.relations.size||(this.creationEmitted=!0,this.targetEvent.emit(Me.RelationsCreated,this.relationType,this.eventType))}}class Tc{constructor(e,t){this.client=e,this.room=t,c(this,"relations",new Map)}getChildEventsForEvent(e,t,r){var n;return(n=this.relations.get(e))===null||n===void 0||(n=n.get(t))===null||n===void 0?void 0:n.get(r)}getAllChildEventsForEvent(e){var t,r=(t=this.relations.get(e))!==null&&t!==void 0?t:new Map,n=[];for(var a of r.values())for(var s of a.values())n.push(...s.getRelations());return n}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var r of t.values())for(var n of r.values())n.setTargetEvent(e)}aggregateChildEvent(e,t){if(!(e.isRedacted()||e.status===pe.CANCELLED)){var r=e.getRelation();if(r){var n=()=>{if(e.isDecryptionFailure()){e.once(Me.Decrypted,n);return}this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption()){e.once(Me.Decrypted,n);return}var{event_id:a,rel_type:s}=r,o=e.getType(),d=this.relations.get(a);d||(d=new Map,this.relations.set(a,d));var l=d.get(s);l||(l=new Map,d.set(s,l));var u=l.get(o);if(!u){var h,v,m;u=new rs(s,o,this.client),l.set(o,u);var f=(h=this.room)!==null&&h!==void 0?h:t?.room,g=(v=(m=t?.findEventById(a))!==null&&m!==void 0?m:f?.findEventById(a))!==null&&v!==void 0?v:f?.getPendingEvent(a);g&&u.setTargetEvent(g)}u.addEvent(e)}}}}var mn;mn=O.log.bind(O);var En=(function(i){return i.Ignore="ignore",i.Replace="replace",i})({});class Gr extends Ke{constructor(e){var t,r,n,a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},s=arguments.length>2?arguments[2]:void 0,o=arguments.length>3?arguments[3]:void 0,d=arguments.length>4&&arguments[4]!==void 0?arguments[4]:null;super(),this.room=e,this.thread=o,this.threadListType=d,c(this,"relations",void 0),c(this,"timelineSupport",void 0),c(this,"displayPendingEvents",void 0),c(this,"liveTimeline",void 0),c(this,"timelines",void 0),c(this,"_eventIdToTimeline",new Map),c(this,"filter",void 0),this.timelineSupport=!!a.timelineSupport,this.liveTimeline=new te(this),this.displayPendingEvents=a.pendingEvents!==!1,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=a.filter,this.relations=(t=(r=this.room)===null||r===void 0?void 0:r.relations)!==null&&t!==void 0?t:new Tc((n=e?.client)!==null&&n!==void 0?n:s)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return!this.room||!this.displayPendingEvents?[]:this.room.getPendingEvents()}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var r=this._eventIdToTimeline.get(e);r&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,r))}resetLiveTimeline(e,t){var r=!this.timelineSupport||!t,n=this.liveTimeline,a=r?n.forkLive(te.FORWARDS):n.fork(te.FORWARDS);r?(this.timelines=[a],this._eventIdToTimeline=new Map):this.timelines.push(a),t&&n.setPaginationToken(t,te.FORWARDS),a.setPaginationToken(e??null,te.BACKWARDS),this.liveTimeline=a,this.emit(ne.TimelineReset,this.room,this,r)}getTimelineForEvent(e){if(e==null)return null;var t=this._eventIdToTimeline.get(e);return t===void 0?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find(function(r){return r.getId()==e})}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new te(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,r,n,a){if(!n)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&n==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!(this.filter&&(e=this.filter.filterRoomTimeline(e),!e.length))){var s=t?te.BACKWARDS:te.FORWARDS,o=t?te.FORWARDS:te.BACKWARDS,d=!1,l=!1;for(var u of e){var h=u.getId(),v=this._eventIdToTimeline.get(h);if(!v){this.addEventToTimeline(u,n,{toStartOfTimeline:t,addToState:r}),l=!0,d=!0;continue}if(l=!1,v==n){mn("Event "+h+" already in timeline "+n);continue}var m=n.getNeighbouringTimeline(s);if(m){v==m?mn("Event "+h+" in neighbouring timeline - switching to "+v):mn("Event "+h+" already in a different timeline "+v),n=v;continue}O.info("Already have timeline for "+h+" - joining timeline "+n+" to "+v);var f=v===this.liveTimeline,g=n===this.liveTimeline,T=s===te.BACKWARDS&&f,R=s===te.FORWARDS&&g;if(T||R){T&&O.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+v+")"),R&&O.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+n+")");continue}n.setNeighbouringTimeline(v,s),v.setNeighbouringTimeline(n,o),n=v,d=!0}if(l||!d){if(s===te.FORWARDS&&n===this.liveTimeline){O.warn({lastEventWasNew:l,didUpdate:d}),O.warn("Refusing to set forwards pagination token of live timeline "+"".concat(n," to ").concat(a));return}n.setPaginationToken(a??null,s)}}}addLiveEvent(e,t){var{duplicateStrategy:r,fromCache:n,roomState:a,timelineWasEmpty:s,addToState:o}=t;if(this.filter){var d=this.filter.filterRoomTimeline([e]);if(!d.length)return}var l=this._eventIdToTimeline.get(e.getId());if(l){if(r===En.Replace){mn("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var u=l.getEvents(),h=0;h<u.length;h++)if(u[h].getId()===e.getId()){a||(a=l.getState(te.FORWARDS)),te.setEventMetadata(e,a,!1),u[h]=e;break}}else mn("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());return}this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:n,roomState:a,timelineWasEmpty:s,addToState:o})}addEventToTimeline(e,t,r){var{toStartOfTimeline:n,fromCache:a=!1,roomState:s,timelineWasEmpty:o,addToState:d}=r;if(t.getTimelineSet()!==this){var l;throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((l=this.thread)===null||l===void 0?void 0:l.id,")"))}var u=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var h,v="event=".concat(u);e.threadRootId&&(v+="(belongs to thread=".concat(e.threadRootId,")")),O.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(v," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((h=this.thread)===null||h===void 0?void 0:h.id,")"));return}t.addEvent(e,{toStartOfTimeline:n,roomState:s,timelineWasEmpty:o,addToState:d}),this._eventIdToTimeline.set(u,t);var m={timeline:t,liveEvent:!n&&t==this.liveTimeline&&!a};this.emit(ne.Timeline,e,this.room,!!n,!1,m)}insertEventIntoTimeline(e,t,r,n){if(t.getTimelineSet()!==this){var a;throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),` does not belong " +
                "in timelineSet(threadId=`).concat((a=this.thread)===null||a===void 0?void 0:a.id,")"))}var s=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var o,d="event=".concat(s);e.threadRootId&&(d+="(belongs to thread=".concat(e.threadRootId,")")),O.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(d," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat((o=this.thread)===null||o===void 0?void 0:o.id,")"));return}var l=e.relationEventId;if(!l){this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:r,addToState:n});return}for(var u=this.findEventById(l),h=t.getEvents(),v=u!==void 0?h.indexOf(u):0,m=v;m<h.length;m++){var f=h[m];if(f.getTs()>e.getTs())break}t.insertEvent(e,m,r,n),this._eventIdToTimeline.set(s,t);var g={timeline:t,liveEvent:!1};this.emit(ne.Timeline,e,this.room,!1,!1,g)}handleRemoteEcho(e,t,r){var n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(r,n)):(!this.filter||this.filter.filterRoomTimeline([e]).length)&&this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var r=t.removeEvent(e);if(r){this._eventIdToTimeline.delete(e);var n={timeline:t};this.emit(ne.Timeline,r,this.room,void 0,!0,n)}return r}compareEventOrdering(e,t){if(e==t)return 0;var r=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(r===void 0||n===void 0)return null;if(r===n){for(var a=void 0,s=void 0,o=r.getEvents(),d=0;d<o.length&&(a===void 0||s===void 0);d++){var l=o[d].getId();l==e&&(a=d),l==t&&(s=d)}var u=a-s;return u<0?-1:u>0?1:0}for(var h=r;h;){if(h===n)return-1;h=h.getNeighbouringTimeline(te.FORWARDS)}for(h=r;h;){if(h===n)return 1;h=h.getNeighbouringTimeline(te.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var{threadId:t,shouldLiveInRoom:r,shouldLiveInThread:n}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===t;if(!r&&!n){var a;O.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat((a=this.room)===null||a===void 0?void 0:a.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId))}return r}}var pe=(function(i){return i.NOT_SENT="not_sent",i.ENCRYPTING="encrypting",i.SENDING="sending",i.QUEUED="queued",i.SENT="sent",i.CANCELLED="cancelled",i})({});class Bo{constructor(e,t){this.roomId=e}}class Ic{constructor(e){this.target=e,c(this,"reEmitters",new WeakMap)}reEmit(e,t){var r=this,n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));var a=function(d){if(n.has(d))return 1;var l=function(){if(!(d==="error"&&r.target.listenerCount("error")===0)){for(var h=arguments.length,v=new Array(h),m=0;m<h;m++)v[m]=arguments[m];r.target.emit(d,...v,e)}};e.on(d,l),n.set(d,l)};for(var s of t)a(s)}stopReEmitting(e,t){var r=this.reEmitters.get(e);if(r){for(var n of t)e.off(n,r.get(n)),r.delete(n);r.size===0&&this.reEmitters.delete(e)}}}class qn extends Ic{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}var Li=new Qa("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications");function Xv(i,e){if(e.endsWith("*")){var t=e.slice(0,-1);return i.slice(0,t.length)===t}else return i===e}class Td{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,r,n=((t=e.getUnsigned())===null||t===void 0?void 0:t["m.relations"])||{},a=Object.keys(n),s=[];return this.userId&&n!==null&&n!==void 0&&(r=n[De.name])!==null&&r!==void 0&&r.current_user_participated&&s.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),e.getContent()?e.getContent().url!==void 0:!1,a,s)}toJSON(){return Object.fromEntries(Object.entries({types:this.filterJson.types,not_types:this.filterJson.not_types,rooms:this.filterJson.rooms,not_rooms:this.filterJson.not_rooms,senders:this.filterJson.senders,not_senders:this.filterJson.not_senders,contains_url:this.filterJson.contains_url,[zr.name]:this.filterJson[zr.name],[Yr.name]:this.filterJson[Yr.name]}).filter(e=>{var[t,r]=e;return r}))}checkFields(e,t,r,n,a,s){var o={rooms:function(R){return e===R},senders:function(R){return t===R},types:function(R){return Xv(r,R)}};for(var d in o){var l=o[d],u="not_"+d,h=this.filterJson[u];if(h!=null&&h.some(l))return!1;var v=this.filterJson[d];if(v&&!v.some(l))return!1}var m=this.filterJson.contains_url;if(m!==void 0&&m!==n)return!1;var f=this.filterJson[Yr.name];if(f!==void 0&&!this.arrayMatchesFilter(f,a))return!1;var g=this.filterJson[zr.name];return!(g!==void 0&&!this.arrayMatchesFilter(g,s))}arrayMatchesFilter(e,t){return t.length>0&&e.every(r=>t.includes(r))}filter(e){return e.filter(this.check,this)}limit(){return this.filterJson.limit!==void 0?this.filterJson.limit:10}}function Id(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function un(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Id(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Id(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function ks(i,e,t){for(var r=e.split("."),n=i,a=0;a<r.length-1;a++)n[r[a]]||(n[r[a]]={}),n=n[r[a]];n[r[r.length-1]]=t}class St{static fromJson(e,t,r){var n=new St(e,t);return n.setDefinition(r),n}constructor(e,t){this.userId=e,this.filterId=t,c(this,"definition",{}),c(this,"roomFilter",void 0),c(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms)),this.roomFilter=new Td(r,this.userId),this.roomTimelineFilter=new Td(t?.timeline||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){ks(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,r;this.definition=un(un({},this.definition),{},{room:un(un({},(t=this.definition)===null||t===void 0?void 0:t.room),{},{timeline:un(un({},(r=this.definition)===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.timeline),{},{[Li.name]:e})})})}setLazyLoadMembers(e){ks(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){ks(this.definition,"room.include_leave",e)}}c(St,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0});function Na(i){return i!=null}var Cc=new Et.UnstableValue("m.message","org.matrix.msc1767.message"),ns=new Et.UnstableValue("m.text","org.matrix.msc1767.text"),Oc=new Et.UnstableValue("m.html","org.matrix.msc1767.html"),Wo=new Et.NamespacedValue("m.reference");function kc(i,e){if(typeof i=="string")return typeof e=="string"?e===i:e.matches(i);if(typeof e=="string")return i.matches(e);var t=e,r=i;return t.matches(r.name)||Na(r.altName)&&t.matches(r.altName)}var is=new Nn("m.topic");function Cd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Qv(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Cd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Cd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function Mc(i,e){return{msgtype:Wt.Text,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Pc(i,e){return{msgtype:Wt.Notice,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Ac(i,e){return{msgtype:Wt.Emote,format:"org.matrix.custom.html",body:i,formatted_body:e}}function Dc(i){return{msgtype:Wt.Text,body:i}}function Lc(i){return{msgtype:Wt.Notice,body:i}}function Uc(i){return{msgtype:Wt.Emote,body:i}}var Nc=(i,e,t,r)=>{var n="at ".concat(new Date(t).toISOString()),a=e===Xr.Self?"User":void 0,s=r?'"'.concat(r,'"'):void 0;return[a,"Location",s,i,n].filter(Boolean).join(" ")},xc=(i,e,t,r,n)=>{var a=i??Nc(e,n||Xr.Self,t,r),s=t?{[ur.name]:t}:{};return Qv({msgtype:Wt.Location,body:a,geo_uri:e,[Fn.name]:{description:r,uri:e},[xn.name]:{type:n||Xr.Self},[ns.name]:a},s)},Zv=i=>{var e,t,r=Fn.findIn(i),n=xn.findIn(i),a=ur.findIn(i),s=ns.findIn(i),o=(e=r?.uri)!==null&&e!==void 0?e:i?.geo_uri,d=r?.description,l=(t=n?.type)!==null&&t!==void 0?t:Xr.Self,u=s??i.body;return xc(u,o,a??void 0,d,l)},Fc=(i,e)=>{var t=[];return Na(e)&&t.push({body:e,mimetype:"text/html"}),Na(i)&&t.push({body:i,mimetype:"text/plain"}),{topic:i,[is.name]:{"m.text":t}}},ef=i=>{var e,t,r,n,a=is.findIn(i),s=Array.isArray(a)?a:a?.["m.text"];if(!Array.isArray(s)){var o;return{text:(o=i.topic)!==null&&o!==void 0?o:void 0}}var d=(e=(t=s==null||(r=s.find(u=>!Na(u.mimetype)||u.mimetype==="text/plain"))===null||r===void 0?void 0:r.body)!==null&&t!==void 0?t:i.topic)!==null&&e!==void 0?e:void 0,l=s==null||(n=s.find(u=>u.mimetype==="text/html"))===null||n===void 0?void 0:n.body;return{text:d,html:l}},tf=(i,e,t,r,n)=>({description:t,timeout:i,live:e,[ur.name]:n||Date.now(),[xn.name]:{type:r??Xr.Self}}),jc=i=>{var e,{description:t,timeout:r,live:n}=i,a=(e=ur.findIn(i))!==null&&e!==void 0?e:void 0,s=xn.findIn(i);return{description:t,timeout:r,live:n,assetType:s?.type,timestamp:a}},rf=(i,e,t,r)=>({[Fn.name]:{description:r,uri:i},[ur.name]:e,"m.relates_to":{rel_type:Wo.name,event_id:t}}),io=i=>{var e,t=Fn.findIn(i),r=(e=ur.findIn(i))!==null&&e!==void 0?e:void 0;return{description:t?.description,uri:t?.uri,timestamp:r}};const Bc=Object.freeze(Object.defineProperty({__proto__:null,getTextForLocationEvent:Nc,makeBeaconContent:rf,makeBeaconInfoContent:tf,makeEmoteMessage:Uc,makeHtmlEmote:Ac,makeHtmlMessage:Mc,makeHtmlNotice:Pc,makeLocationContent:xc,makeNotice:Lc,makeTextMessage:Dc,makeTopicContent:Fc,parseBeaconContent:io,parseBeaconInfoContent:jc,parseLocationEvent:Zv,parseTopicContent:ef},Symbol.toStringTag,{value:"Module"}));var We=(function(i){return i.New="Beacon.new",i.Update="Beacon.update",i.LivenessChange="Beacon.LivenessChange",i.Destroy="Beacon.Destroy",i.LocationUpdate="Beacon.LocationUpdate",i})({}),xa=(i,e,t)=>t>=i&&i+e>=t,Ui=i=>"".concat(i.getRoomId(),"_").concat(i.getStateKey());class Ko extends Ke{constructor(e){super(),this.rootEvent=e,c(this,"roomId",void 0),c(this,"_beaconInfo",void 0),c(this,"_isLive",void 0),c(this,"livenessWatchTimeout",void 0),c(this,"_latestLocationEvent",void 0),c(this,"clearLatestLocation",()=>{this._latestLocationEvent=void 0,this.emit(We.LocationUpdate,this.latestLocationState)}),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return Ui(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&io(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(Ui(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(We.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(We.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),!!this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout(()=>{this.monitorLiveness()},this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var r=e.filter(a=>{var s=a.getContent(),o=io(s);if(!o.uri||!o.timestamp)return!1;var{timestamp:d}=o;return this._beaconInfo.timestamp&&xa(this._beaconInfo.timestamp,this._beaconInfo.timeout,d)&&(!this.latestLocationState||d>this.latestLocationState.timestamp)}),n=(t=r.sort(Mv))===null||t===void 0?void 0:t[0];n&&(this._latestLocationEvent=n,this.emit(We.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=jc(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&xa(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(We.LivenessChange,this.isLive,this)}}}function Od(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function nf(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Od(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Od(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function Wc(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;return new at({content:{[e.getId()]:{[t]:{[i]:nf({ts:e.getTs()},!r&&{thread_id:tn(e)})}}},type:F.Receipt,room_id:e.getRoomId()})}var cn=0,hn=1;class Kc extends Ke{constructor(){super(...arguments),c(this,"receipts",new lr(()=>new Map)),c(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,a=arguments.length>2&&arguments[2]!==void 0?arguments[2]:ht.Read,[s,o]=(t=(r=this.receipts.get(a))===null||r===void 0?void 0:r.get(e))!==null&&t!==void 0?t:[null,null];return n?s:o??s}compareReceipts(e,t){var r;return(r=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))!==null&&r!==void 0?r:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=this.getLatestReceipt(e,t);return r&&this.receiptPointsAtConsistentEvent(r)?r.eventId:null}receiptPointsAtConsistentEvent(e){var t,r=this.findEventById(e.eventId);if(!r)return!1;if(!((t=e.data)!==null&&t!==void 0&&t.thread_id))return!0;if(e.data.thread_id===jn){var n=Ln(r);if(n)return!0}else if(r.threadRootId===e.data.thread_id)return!0;return O.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(r.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var r,n,a=this.getReadReceiptForUserId(e,t,ht.Read),s=this.getReadReceiptForUserId(e,t,ht.ReadPrivate),o;return a!=null&&a.eventId&&s!==null&&s!==void 0&&s.eventId&&(o=this.compareReceipts(a,s)),o?(n=o<0?s:a)!==null&&n!==void 0?n:null:(r=s??a)!==null&&r!==void 0?r:null}addReceiptToStructure(e,t,r,n,a){var s,o,d=this.receipts.getOrCreate(t),l=d.get(r);l||(l=[null,null],d.set(r,l));var u=l[cn];if(a){var h;u=(h=l[hn])!==null&&h!==void 0?h:l[cn]}var v={eventId:e,data:n};if(u){var m=this.compareReceipts(u,v);if(m>=0)return}var f=a?l[cn]:v,g=a?v:l[hn],T=null;f&&g&&(T=this.getUnfilteredTimelineSet().compareEventOrdering(f.eventId,g.eventId));var R=T===null||T<0,S=(s=l[hn])!==null&&s!==void 0?s:l[cn];a&&R?l[hn]=v:a||(l[cn]=v,R||(l[hn]=null));var I=(o=l[hn])!==null&&o!==void 0?o:l[cn];if(S!==I){if(S&&this.receiptCacheByEventId.get(S.eventId)){var b=S.eventId;this.receiptCacheByEventId.set(b,this.receiptCacheByEventId.get(b).filter(w=>w.type!==t||w.userId!==r)),this.receiptCacheByEventId.get(b).length<1&&this.receiptCacheByEventId.delete(b)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:r,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),r=this.timeline[this.timeline.length-1];r&&t?.eventId===r.getId()&&e===r.getSender()&&(this.setUnread(ke.Total,0),this.setUnread(ke.Highlight,0))}addLocalEchoReceipt(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.addReceipt(Wc(e,t,r,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter(function(t){return Mo(t.type)}).map(function(t){return t.userId})}}var qc=new Et.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),Vc=new Et.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),Gc=new Et.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),On=new Et.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),Ni=new Et.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end"),nr=(function(i){return i.New="Poll.new",i.End="Poll.end",i.Update="Poll.update",i.Responses="Poll.Responses",i.Destroy="Poll.Destroy",i.UndecryptableRelations="Poll.UndecryptableRelations",i})({}),kd=(i,e)=>{var t=i.filter(r=>{if(!r.isDecryptionFailure())return On.matches(r.getType())&&r.getTs()<=e});return{responseEvents:t}};class qo extends Ke{constructor(e,t,r){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=r,c(this,"roomId",void 0),c(this,"pollEvent",void 0),c(this,"_isFetchingResponses",!1),c(this,"relationsNextBatch",void 0),c(this,"responses",null),c(this,"endEvent",void 0),c(this,"undecryptableRelationEventIds",new Set),c(this,"countUndecryptableEvents",n=>{var a=n.filter(o=>o.isDecryptionFailure()).map(o=>o.getId()),s=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...a]),this.undecryptableRelationsCount!==s&&this.emit(nr.UndecryptableRelations,this.undecryptableRelationsCount)}),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return(e=this.endEvent)===null||e===void 0?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return _(function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses})()}onNewRelation(e){var t;if(Ni.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(nr.End)),!!this.responses){var r=((t=this.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:n}=kd([e],r);this.countUndecryptableEvents([e]),n.length&&(n.forEach(a=>{this.responses.addEvent(a)}),this.emit(nr.Responses,this.responses))}}fetchResponses(){var e=this;return _(function*(){var t,r;e._isFetchingResponses=!0;var n=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(n.events.map(l=>e.matrixClient.decryptEventIfNeeded(l)));var a=e.responses||new rs("m.reference",On.name,e.matrixClient,[On.altName]),s=n.events.find(l=>Ni.matches(l.getType()));e.validateEndEvent(s)&&(e.endEvent=s,e.refilterResponsesOnEnd(),e.emit(nr.End));var o=((t=e.endEvent)===null||t===void 0?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:d}=kd(n.events,o);d.forEach(l=>{a.addEvent(l)}),e.relationsNextBatch=(r=n.nextBatch)!==null&&r!==void 0?r:void 0,e.responses=a,e.countUndecryptableEvents(n.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(nr.Responses,e.responses)})()}refilterResponsesOnEnd(){var e;if(this.responses){var t=((e=this.endEvent)===null||e===void 0?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach(r=>{if(r.getTs()>t){var n;(n=this.responses)===null||n===void 0||n.removeEvent(r)}}),this.emit(nr.Responses,this.responses)}}validateEndEvent(e){if(!e||this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,r=e.getSender();return!!r&&(r===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,r))}}var Vo=i=>{var e=i.getType();return Et.M_POLL_START.matches(e)||On.matches(e)||Ni.matches(e)};class af{constructor(e){c(this,"room",void 0),c(this,"threadedReceipts",void 0),c(this,"unthreadedReceipts",void 0),c(this,"danglingReceipts",void 0),c(this,"onTimelineEvent",t=>{var r=t.getId();if(r){var n=this.danglingReceipts.remove(r);n?.forEach(a=>{a.receipt.thread_id?this.threadedReceipts.set(a.receipt.thread_id,a.eventId,a.receiptType,a.userId,a.receipt.ts,a.synthetic):this.unthreadedReceipts.set(r,a.receiptType,a.userId,a.receipt.ts,a.synthetic)})}}),this.room=e,this.threadedReceipts=new df(e),this.unthreadedReceipts=new Hc(e),this.danglingReceipts=new uf,e.on(ne.Timeline,this.onTimelineEvent)}add(e,t){for(var[r,n]of Object.entries(e))for(var[a,s]of Object.entries(n))for(var[o,d]of Object.entries(s)){var l=this.room.findEventById(r);l?d.thread_id?this.threadedReceipts.set(d.thread_id,r,a,o,d.ts,t):this.unthreadedReceipts.set(r,a,o,d.ts,t):this.danglingReceipts.add(new of(r,a,o,d,t))}}hasUserReadEvent(e,t){var r=this.unthreadedReceipts.get(e);if(r&&ao(r.eventId,t,this.room))return!0;var n=this.room.findEventById(t);if(!n)return O.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var a=tn(n),s=this.threadedReceipts.get(a,e);return!!(s&&ao(s.eventId,t,this.room)||this.userSentLatestEventInThread(a,e))}userSentLatestEventInThread(e,t){var r,n=e===jn?this.room.getLiveTimeline().getEvents():(r=this.room.getThread(e))===null||r===void 0?void 0:r.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}}class sf{constructor(e,t,r){this.eventId=e,this.receiptType=t,this.ts=r}}class of{constructor(e,t,r,n,a){this.eventId=e,this.receiptType=t,this.userId=r,this.receipt=n,this.synthetic=a}}class lf{constructor(e){c(this,"room",void 0),c(this,"real",void 0),c(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&ao(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return(e=this.synthetic)!==null&&e!==void 0?e:this.real}getByType(e){return e?this.synthetic:this.real}}class Hc{constructor(e){c(this,"room",void 0),c(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,a){var s=Go(this.data,r,()=>new lf(this.room)),o=s.getByType(a);o&&cf(o.eventId,e,this.room)||s.set(a,new sf(e,t,n))}get(e){var t;return(t=this.data.get(e))===null||t===void 0?void 0:t.get()}}class df{constructor(e){c(this,"room",void 0),c(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,a,s){var o=Go(this.data,e,()=>new Hc(this.room));o.set(t,r,n,a,s)}get(e,t){var r;return(r=this.data.get(e))===null||r===void 0?void 0:r.get(t)}}class uf{constructor(){c(this,"data",new Map)}add(e){var t=Go(this.data,e.eventId,()=>[]);t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function Go(i,e,t){var r=i.get(e);if(r)return r;var n=t();return i.set(e,n),n}function ao(i,e,t){var r=t.compareEventOrdering(i,e);return r!==null&&r>=0}function cf(i,e,t){var r=t.compareEventOrdering(i,e);return r!==null&&r>0}function hf(i,e,t){var r=i.findEventById(e),n=i.findEventById(t);if(!r||!n)return null;var a=Ln(r),s=Ln(n);return a&&s?vf(i,e,t,r,n):ff(e,t,r,n)}function vf(i,e,t,r,n){var a=i.getUnfilteredTimelineSet(),s=a.compareEventOrdering(e,t);if(s!==null)return s;var o=a.getTimelineForEvent(e);if(o===a.getLiveTimeline())return 1;var d=a.getTimelineForEvent(t);return d===a.getLiveTimeline()?-1:$c(r,n)}function ff(i,e,t,r){var n=tn(t),a=tn(r),s=t.getThread();return s&&n===a?s.timelineSet.compareEventOrdering(i,e):$c(t,r)}function $c(i,e){var t=i.getTs(),r=e.getTs();return t<r?-1:t>r?1:0}var W=(function(i){return i.Get="GET",i.Put="PUT",i.Post="POST",i.Delete="DELETE",i.Options="OPTIONS",i.Head="HEAD",i.Patch="PATCH",i})({});function Md(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function pf(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Md(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Md(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class Ir extends Error{constructor(e,t,r){super(e),this.httpStatus=t,this.httpHeaders=r}isRateLimitError(){return this.httpStatus===429}getRetryAfterMs(){var e,t=(e=this.httpHeaders)===null||e===void 0?void 0:e.get("Retry-After");if(t!=null){if(/^\d+$/.test(t)){var r=Number.parseInt(t)*1e3;if(!Number.isFinite(r))throw new Error("Retry-After header integer value is too large");return r}var n=new Date(t);if(n.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return n.getTime()-Date.now()}return null}}class Fe extends Ir{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0,s=e.error||"Unknown message";t&&(s="[".concat(t,"] ").concat(s)),r&&(s="".concat(s," (").concat(r,")")),super("MatrixError: ".concat(s),t,a),this.url=r,this.event=n,c(this,"errcode",void 0),c(this,"error",void 0),c(this,"data",void 0),this.errcode=e.errcode,this.error=e.error,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return this.errcode==="M_LIMIT_EXCEEDED"||(this.errcode==="M_UNKNOWN"||this.errcode===void 0)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(e!==null)return e;if(this.errcode==="M_LIMIT_EXCEEDED"&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,r,n,a={};if(this.httpHeaders)for(var[s,o]of this.httpHeaders)a[s]=o;return{http_status:(e=this.httpStatus)!==null&&e!==void 0?e:400,http_headers:a,url:(t=this.url)!==null&&t!==void 0?t:"",response:pf({errcode:(r=this.errcode)!==null&&r!==void 0?r:"M_UNKNOWN",error:(n=this.data.error)!==null&&n!==void 0?n:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new Fe(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function as(i,e){if(!(i instanceof Ir)||!i.isRateLimitError())return e;try{var t;return(t=i.getRetryAfterMs())!==null&&t!==void 0?t:e}catch{return e}}class Cr extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}class Ho extends Error{constructor(e){var t;super((t=e?.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshError"}}class ss extends Error{constructor(e){var t;super((t=e?.message)!==null&&t!==void 0?t:"")}get name(){return"TokenRefreshLogoutError"}}var $o=new Nn(null,"ORG.MATRIX.MSC4387_SAFETY");class Jo extends Fe{constructor(){super(...arguments),c(this,"harms",void 0),c(this,"expiry",void 0);var e=arguments.length<=0?void 0:arguments[0];this.harms=new Set(e&&"harms"in e&&Array.isArray(e.harms)?e.harms:[]),this.message="".concat(super.message," (").concat([...this.harms].join(", "),")"),e&&"expiry"in e&&typeof e.expiry=="number"&&(this.expiry=new Date(e.expiry))}}var Fa=(function(i){return i.SessionLoggedOut="Session.logged_out",i.NoConsent="no_consent",i})({}),la={};var Pd;function mf(){if(Pd)return la;Pd=1;var i=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,e=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,t=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,r=/\\([\u000b\u0020-\u00ff])/g,n=/([\\"])/g,a=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;la.format=s,la.parse=o;function s(h){if(!h||typeof h!="object")throw new TypeError("argument obj is required");var v=h.parameters,m=h.type;if(!m||!a.test(m))throw new TypeError("invalid type");var f=m;if(v&&typeof v=="object")for(var g,T=Object.keys(v).sort(),R=0;R<T.length;R++){if(g=T[R],!t.test(g))throw new TypeError("invalid parameter name");f+="; "+g+"="+l(v[g])}return f}function o(h){if(!h)throw new TypeError("argument string is required");var v=typeof h=="object"?d(h):h;if(typeof v!="string")throw new TypeError("argument string is required to be a string");var m=v.indexOf(";"),f=m!==-1?v.slice(0,m).trim():v.trim();if(!a.test(f))throw new TypeError("invalid media type");var g=new u(f.toLowerCase());if(m!==-1){var T,R,S;for(i.lastIndex=m;R=i.exec(v);){if(R.index!==m)throw new TypeError("invalid parameter format");m+=R[0].length,T=R[1].toLowerCase(),S=R[2],S.charCodeAt(0)===34&&(S=S.slice(1,-1),S.indexOf("\\")!==-1&&(S=S.replace(r,"$1"))),g.parameters[T]=S}if(m!==v.length)throw new TypeError("invalid parameter format")}return g}function d(h){var v;if(typeof h.getHeader=="function"?v=h.getHeader("content-type"):typeof h.headers=="object"&&(v=h.headers&&h.headers["content-type"]),typeof v!="string")throw new TypeError("content-type header is missing from object");return v}function l(h){var v=String(h);if(t.test(v))return v;if(v.length>0&&!e.test(v))throw new TypeError("invalid parameter value");return'"'+v.replace(n,"\\$1")+'"'}function u(h){this.parameters=Object.create(null),this.type=h}return la}var gf=mf();function Ji(i){var e=new AbortController;return setTimeout(()=>{e.abort()},i),e.signal}function zo(i){var e=new AbortController;function t(){for(var a of i)a.removeEventListener("abort",r)}function r(){e.abort(),t()}for(var n of i){if(n.aborted){r();break}n.addEventListener("abort",r)}return{signal:e.signal,cleanup:t}}function os(i,e){var t,r,n=Ms(i)?new Headers(i.getAllResponseHeaders().trim().split(/[\r\n]+/).map(o=>{var d=o.indexOf(":");return[o.substring(0,d),o.substring(d+1)]})):i.headers,a;try{a=yf(n)}catch(o){return o}if(((t=a)===null||t===void 0?void 0:t.type)==="application/json"&&e){var s=JSON.parse(e);return s.errcode&&$o.matches(s.errcode)?new Jo(s,i.status,Ms(i)?i.responseURL:i.url,void 0,n):new Fe(s,i.status,Ms(i)?i.responseURL:i.url,void 0,n)}return((r=a)===null||r===void 0?void 0:r.type)==="text/plain"?new Ir("Server returned ".concat(i.status," error: ").concat(e),i.status,n):new Ir("Server returned ".concat(i.status," error"),i.status,n)}function Ms(i){return"getResponseHeader"in i}function yf(i){var e=i.get("Content-Type");if(e===null)return null;try{return gf.parse(e)}catch(t){throw new Error("Error parsing Content-Type '".concat(e,"': ").concat(t))}}function ja(i,e){return so.apply(this,arguments)}function so(){return so=_(function*(i,e){for(var t=0,r=null;t<i;)try{if(t>0){var n=1e3*Math.pow(2,t);O.log("network operation failed ".concat(t," times, retrying in ").concat(n,"ms...")),yield qi(n)}return yield e()}catch(a){if(a instanceof Cr)t+=1,r=a;else throw a}throw r}),so.apply(this,arguments)}function Yo(i,e,t){return e>4||i instanceof Cr&&!t||i.httpStatus&&Math.floor(i.httpStatus/100)===4&&i.httpStatus!==429||i.name==="AbortError"||i.name==="M_TOO_LARGE"?-1:as(i,1e3*Math.pow(2,e))}var pr=(function(i){return i.Success="success",i.Failure="failure",i.Logout="logout",i})({}),Sf=500,bf=60*1e3;class Ef{constructor(e){this.opts=e,c(this,"tokenRefreshPromise",void 0),c(this,"latestTokenRefreshExpiry",void 0)}prepareForRequest(){var e=this;return _(function*(){return yield e.refreshIfNeeded(),{accessToken:e.opts.accessToken,refreshToken:e.opts.refreshToken,expiry:e.latestTokenRefreshExpiry}})()}refreshIfNeeded(){var e=this;return _(function*(){if(e.tokenRefreshPromise)return e.tokenRefreshPromise;if(e.latestTokenRefreshExpiry){var t=e.latestTokenRefreshExpiry.getTime()-Date.now();t<=Sf&&(yield e._handleUnknownToken())}})()}handleUnknownToken(e,t){var r=this;return _(function*(){return r._handleUnknownToken(e,t)})()}_handleUnknownToken(e,t){var r=this;return _(function*(){if(e!=null&&e.expiry){var n=e.expiry.getTime()-Date.now();if(n>=bf)return pr.Logout}if(!e||e?.accessToken===r.opts.accessToken){var a;(a=r.tokenRefreshPromise)!==null&&a!==void 0||(r.tokenRefreshPromise=r.doTokenRefresh(t));try{return yield r.tokenRefreshPromise}finally{r.tokenRefreshPromise=void 0}}return pr.Success})()}doTokenRefresh(e){var t=this;return _(function*(){if(!t.opts.refreshToken||!t.opts.tokenRefreshFunction){var r;return(r=t.opts.logger)===null||r===void 0||r.error("Unable to refresh token - no refresh token or refresh function"),pr.Logout}e&&e>1&&(yield qi(1e3*Math.min(32,2**e)));try{var n,a;(n=t.opts.logger)===null||n===void 0||n.debug("Attempting to refresh token");var{accessToken:s,refreshToken:o,expiry:d}=yield t.opts.tokenRefreshFunction(t.opts.refreshToken);return t.opts.accessToken=s,t.opts.refreshToken=o,t.latestTokenRefreshExpiry=d,(a=t.opts.logger)===null||a===void 0||a.debug("... token refresh complete, new token expiry:",d),pr.Success}catch(h){var l;if(h instanceof ss||h instanceof Fe){var u;return(u=t.opts.logger)===null||u===void 0||u.error("Failed to refresh token",h),pr.Logout}return(l=t.opts.logger)===null||l===void 0||l.warn("Failed to refresh token",h),pr.Failure}})()}}function Ad(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Dd(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Ad(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Ad(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class _f{constructor(e,t){var r;if(this.eventEmitter=e,this.opts=t,c(this,"abortController",new AbortController),c(this,"tokenRefresher",void 0),dc(t,["baseUrl","prefix"]),!t.onlyData)throw new Error("Constructing FetchHttpApi without `onlyData=true` is no longer supported.");t.useAuthorizationHeader=(r=t.useAuthorizationHeader)!==null&&r!==void 0?r:!0,this.tokenRefresher=new Ef(t)}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,r,n,a){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var s=void 0,o=void 0;e===W.Get?s=r:o=r;var d=this.getUrl(t,s,n,this.opts.idBaseUrl),l={json:!0,headers:{}};return a&&(l.headers.Authorization="Bearer ".concat(a)),this.requestOtherUrl(e,d,o,l)}authedRequest(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{};return this.doAuthedRequest(1,e,t,r,n,a)}doAuthedRequest(e,t,r,n,a){var s=arguments,o=this;return _(function*(){var d=s.length>5&&s[5]!==void 0?s[5]:{},l=Ki(d);l.abortSignal=d.abortSignal;var u=yield o.tokenRefresher.prepareForRequest();u.accessToken&&(o.opts.useAuthorizationHeader?(l.headers||(l.headers={}),l.headers.Authorization||(l.headers.Authorization="Bearer ".concat(u.accessToken)),n.access_token&&delete n.access_token):n.access_token||(n.access_token=u.accessToken));try{var h=yield o.request(t,r,n,a,l);return h}catch(m){if(!(m instanceof Fe))throw m;if(m.errcode==="M_UNKNOWN_TOKEN"){var v=yield o.tokenRefresher.handleUnknownToken(u,e);if(v===pr.Success)return o.doAuthedRequest(e+1,t,r,n,a,d);if(v===pr.Failure)throw new Ho(m);l!=null&&l.inhibitLogoutEmit||o.eventEmitter.emit(Fa.SessionLoggedOut,m)}else m.errcode=="M_CONSENT_NOT_GIVEN"&&o.eventEmitter.emit(Fa.NoConsent,m.message,m.data.consent_uri);throw m}})()}request(e,t,r,n,a){var s=this.getUrl(t,r,a?.prefix,a?.baseUrl);return this.requestOtherUrl(e,s,n,a)}requestOtherUrl(e,t,r){var n=arguments,a=this;return _(function*(){var s,o,d,l,u=n.length>3&&n[3]!==void 0?n[3]:{};if(u.json!==void 0&&u.rawResponseBody!==void 0)throw new Error("Invalid call to `FetchHttpApi` sets both `opts.json` and `opts.rawResponseBody`");var h=a.sanitizeUrlForLogs(t);(s=a.opts.logger)===null||s===void 0||s.debug("FetchHttpApi: --> ".concat(e," ").concat(h));var v=Object.assign({},u.headers||{}),m=!u.rawResponseBody&&u.json!==!1;m&&(v.Accept||(v.Accept="application/json"));var f=(o=u.localTimeoutMs)!==null&&o!==void 0?o:a.opts.localTimeoutMs,g=(d=u.keepAlive)!==null&&d!==void 0?d:!1,T=[a.abortController.signal];f!==void 0&&T.push(Ji(f)),u.abortSignal&&T.push(u.abortSignal);var R;u.json!==!1&&(r==null||(l=r.constructor)===null||l===void 0?void 0:l.name)===Object.name?(R=JSON.stringify(r),v["Content-Type"]||(v["Content-Type"]="application/json")):R=r;var{signal:S,cleanup:I}=zo(T),b="Authorization"in v?void 0:"no-cache",w,p=Date.now();try{var E;w=yield a.fetch(t,{signal:S,method:e,body:R,headers:v,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:b,credentials:"omit",keepalive:g,priority:u.priority}),(E=a.opts.logger)===null||E===void 0||E.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-p,"ms ").concat(w.status,"]"))}catch(P){var y;throw(y=a.opts.logger)===null||y===void 0||y.debug("FetchHttpApi: <-- ".concat(e," ").concat(h," [").concat(Date.now()-p,"ms ").concat(P,"]")),P.name==="AbortError"?P:new Cr("fetch failed",P)}finally{I()}if(!w.ok)throw os(w,yield w.text());return u.rawResponseBody?yield w.blob():m?yield w.json():yield w.text()})()}sanitizeUrlForLogs(e){try{var t;typeof e=="string"?t=new URL(e):t=e;var r=new URLSearchParams;for(var n of t.searchParams.keys())r.append(n,"xxx");var a=r.toString(),s=a?"?".concat(a):"";return t.origin+t.pathname+s}catch{return"??"}}getUrl(e,t,r,n){var a=n??this.opts.baseUrl,s=a.endsWith("/")?a.slice(0,-1):a,o=new URL(s+(r??this.opts.prefix)+e);if(this.opts.extraParams||t){var d=Dd(Dd({},this.opts.extraParams),t);Xs(d,o.searchParams)}return o}}var $e=(function(i){return i.V1="/_matrix/client/v1",i.V3="/_matrix/client/v3",i.Unstable="/_matrix/client/unstable",i})({}),Vt=(function(i){return i.V2="/_matrix/identity/v2",i})({}),Jr=(function(i){return i.V1="/_matrix/media/v1",i.V3="/_matrix/media/v3",i})({}),wf=1e3,Rf=0,Ps,ar=[],Tf=function(){};function Ld(i,e){for(var t=arguments.length,r=new Array(t>2?t-2:0),n=2;n<t;n++)r[n-2]=arguments[n];e=e||0,e<0&&(e=0);var a=Date.now()+e,s=Rf++,o={runAt:a,func:i,params:r,key:s},d=Cf(ar,function(l){return l.runAt-a});return ar.splice(d,0,o),Xo(),s}function Ud(i){if(ar.length!==0){var e;for(e=0;e<ar.length;e++){var t=ar[e];if(t.key==i){ar.splice(e,1);break}}e===0&&Xo()}}function Xo(){Ps&&globalThis.clearTimeout(Ps);var i=ar[0];if(i){var e=Date.now(),t=Math.min(i.runAt-e,wf);Ps=globalThis.setTimeout(If,t)}}function If(){for(var i=Date.now(),e=[];;){var t=ar[0];if(!t||t.runAt>i)break;var r=ar.shift();Tf("runCallbacks: popping",r.key),e.push(r)}Xo();for(var n of e)try{n.func.apply(globalThis,n.params)}catch(a){O.error("Uncaught exception in callback function",a)}}function Cf(i,e){for(var t=0,r=i.length;t<r;){var n=t+r>>1,a=e(i[n]);a>0?r=n:t=n+1}return t}class Qo extends _f{constructor(){super(...arguments),c(this,"uploads",[])}uploadContent(e){var t,r,n,a,s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=(t=s.includeFilename)!==null&&t!==void 0?t:!0,d=(r=s.abortController)!==null&&r!==void 0?r:new AbortController,l=((n=s.type)!==null&&n!==void 0?n:e.type)||"application/octet-stream",u=(a=s.name)!==null&&a!==void 0?a:e.name,h={loaded:0,total:0,abortController:d},v=Promise.withResolvers();if(globalThis.XMLHttpRequest){var m=new globalThis.XMLHttpRequest,f=function(){m.abort(),v.reject(new Error("Timeout"))},g=Ld(f,3e4);m.onreadystatechange=function(){switch(m.readyState){case globalThis.XMLHttpRequest.DONE:Ud(g);try{if(m.status===0)throw new DOMException(m.statusText,"AbortError");if(!m.responseText)throw new Error("No response body.");m.status>=400?v.reject(os(m,m.responseText)):v.resolve(JSON.parse(m.responseText))}catch(I){if(I.name==="AbortError"){v.reject(I);return}v.reject(new Cr("request failed",I))}break}},m.upload.onprogress=I=>{var b;Ud(g),h.loaded=I.loaded,h.total=I.total,g=Ld(f,3e4),(b=s.progressHandler)===null||b===void 0||b.call(s,{loaded:I.loaded,total:I.total})};var T=this.getUrl("/upload",void 0,Jr.V3);o&&u&&T.searchParams.set("filename",encodeURIComponent(u)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&T.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),m.open(W.Post,T.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&m.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),m.setRequestHeader("Content-Type",l),m.send(e),d.signal.addEventListener("abort",()=>{m.abort()})}else{var R={};o&&u&&(R.filename=u);var S={"Content-Type":l};this.authedRequest(W.Post,"/upload",R,e,{prefix:Jr.V3,headers:S,abortSignal:d.signal}).then(v.resolve,v.reject)}return h.promise=v.promise.finally(()=>{Oa(this.uploads,I=>I===h)}),d.signal.addEventListener("abort",()=>{Oa(this.uploads,I=>I===h),v.reject(new DOMException("Aborted","AbortError"))}),this.uploads.push(h),h.promise}cancelUpload(e){var t=this.uploads.find(r=>r.promise===e);return t?(t.abortController.abort(),!0):!1}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:Jr.V3+"/upload",params:{access_token:this.opts.accessToken}}}}var Of=360*60*1e3,kf=30*1e3,Zo=(function(i){return i.Stable="stable",i.Unstable="unstable",i})({});class el{constructor(e,t){var r=this;this.logger=e,this.http=t,c(this,"capabilities",void 0),c(this,"retryTimeout",void 0),c(this,"refreshTimeout",void 0),c(this,"fetchCapabilities",_(function*(){var n=yield r.http.authedRequest(W.Get,"/capabilities");return r.capabilities=n.capabilities,r.capabilities})),c(this,"poll",_(function*(){try{yield r.fetchCapabilities(),r.clearTimeouts(),r.refreshTimeout=setTimeout(r.poll,Of),r.logger.debug("Fetched new server capabilities")}catch(a){r.clearTimeouts();var n=Math.floor(kf+Math.random()*5e3);r.retryTimeout=setTimeout(r.poll,n),r.logger.warn("Failed to refresh capabilities: retrying in ".concat(n,"ms"),a)}}))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}var ii=O.getChild("RoomStickyEvents"),yr=(function(i){return i.Update="RoomStickyEvents.Update",i})({});function As(i){if(typeof i!="string")throw new Error("Not a string");if(!i.startsWith("@"))throw new Error("Not a userId")}class qr extends Ke{constructor(){super(...arguments),c(this,"stickyEventsMap",new Map),c(this,"unkeyedStickyEvents",new Set),c(this,"stickyEventTimer",void 0),c(this,"nextStickyEventExpiryTs",Number.MAX_SAFE_INTEGER),c(this,"cleanExpiredStickyEvents",()=>{var e=Date.now(),t=[];this.nextStickyEventExpiryTs=Number.MAX_SAFE_INTEGER;for(var[r,n]of this.stickyEventsMap.entries()){var a;for(var[s,[o,...d]]of n)e>=o.unstableStickyExpiresAt?(ii.debug("Expiring sticky event",o.getId()),t.push(o),this.stickyEventsMap.get(r).delete(s)):(this.stickyEventsMap.get(r).set(s,[o,...d.filter(u=>u.unstableStickyExpiresAt<=e)]),this.nextStickyEventExpiryTs=Math.min(this.nextStickyEventExpiryTs,o.unstableStickyExpiresAt));((a=this.stickyEventsMap.get(r))===null||a===void 0?void 0:a.size)===0&&this.stickyEventsMap.delete(r)}for(var l of this.unkeyedStickyEvents)e>=l.unstableStickyExpiresAt?(ii.debug("Expiring sticky event",l.getId()),this.unkeyedStickyEvents.delete(l),t.push(l)):this.nextStickyEventExpiryTs=Math.min(this.nextStickyEventExpiryTs,l.unstableStickyExpiresAt);t.length&&this.emit(yr.Update,[],[],t),this.scheduleStickyTimer()})}static sortStickyEvent(e,t){var r,n;if(t.getTs()!==e.getTs())return t.getTs()-e.getTs();if(((r=t.getId())!==null&&r!==void 0?r:"")>((n=e.getId())!==null&&n!==void 0?n:""))return 1;throw Error("Comparing two sticky events with the same event ID is not allowed.")}static stickyMapKey(e,t){return"".concat(e).concat(t)}*getStickyEvents(){yield*this.unkeyedStickyEvents;for(var e of this.stickyEventsMap.values())for(var t of e.values())yield t[0]}getKeyedStickyEvent(e,t,r){var n;return As(e),(n=this.stickyEventsMap.get(t))===null||n===void 0||(n=n.get(qr.stickyMapKey(r,e)))===null||n===void 0?void 0:n[0]}getUnkeyedStickyEvent(e,t){return[...this.unkeyedStickyEvents].filter(r=>r.getType()===t&&r.getSender()===e)}addStickyEvent(e){var t,r,n,a=e.getContent().msc4354_sticky_key;if(typeof a!="string"&&a!==void 0)throw new Error("".concat(e.getId()," is missing msc4354_sticky_key"));if(e.unstableStickyExpiresAt===void 0)throw new Error("".concat(e.getId()," is missing msc4354_sticky.duration_ms"));var s=e.getSender(),o=e.getType();if(As(s),e.unstableStickyExpiresAt<=Date.now())return ii.info("ignored sticky event with older expiration time than current time",a),{added:!1};if(!s.startsWith("@"))throw new Error("Expected sender to start with @");var d=e;if(a===void 0)return this.unkeyedStickyEvents.add(d),this.nextStickyEventExpiryTs=Math.min(e.unstableStickyExpiresAt,this.nextStickyEventExpiryTs),this.scheduleStickyTimer(),{added:!0};var l=qr.stickyMapKey(a,s),u=[d,...(t=(r=this.stickyEventsMap.get(o))===null||r===void 0?void 0:r.get(l))!==null&&t!==void 0?t:[]].sort(qr.sortStickyEvent);return this.stickyEventsMap.has(o)||this.stickyEventsMap.set(o,new Map),(n=this.stickyEventsMap.get(o))===null||n===void 0||n.set(l,u),this.nextStickyEventExpiryTs=Math.min(d.unstableStickyExpiresAt,this.nextStickyEventExpiryTs),this.scheduleStickyTimer(),{added:u[0]===d,prevEvent:u?.[1]}}addStickyEvents(e){var t=[],r=[];for(var n of e)try{var a=this.addStickyEvent(n);a.added&&(a.prevEvent?r.push({current:n,previous:a.prevEvent}):t.push(n))}catch(s){ii.warn("ignored invalid sticky event",s)}(t.length||r.length)&&this.emit(yr.Update,t,r,[]),this.scheduleStickyTimer()}scheduleStickyTimer(){this.stickyEventTimer&&(clearTimeout(this.stickyEventTimer),this.stickyEventTimer=void 0),this.nextStickyEventExpiryTs!==Number.MAX_SAFE_INTEGER&&(this.stickyEventTimer=setTimeout(this.cleanExpiredStickyEvents,this.nextStickyEventExpiryTs-Date.now()))}handleRedaction(e){var t=typeof e=="string"?e:e.getId();for(var r of this.unkeyedStickyEvents)if(r.getId()===t){this.unkeyedStickyEvents.delete(r),this.emit(yr.Update,[],[],[r]);return}if(typeof e!="string"&&!e.isRedacted()){var n,a,s=e.getContent().msc4354_sticky_key;if(typeof s!="string"&&s!==void 0)return;var o=e.getType(),d=e.getSender();As(d);var l=this.stickyEventsMap.get(o);if(!l)return;var u=qr.stickyMapKey(s,d),[h,...v]=(n=l.get(u))!==null&&n!==void 0?n:[];if(!h)return;ii.debug("Redaction for ".concat(t," under sticky key ").concat(s));var m=v.filter(T=>!T.isRedacted()).sort(qr.sortStickyEvent);(a=this.stickyEventsMap.get(o))===null||a===void 0||a.set(u,m),m.length?this.emit(yr.Update,[],[{previous:h,current:m[0]}],[]):(l.delete(u),l.size===0&&this.stickyEventsMap.delete(o),this.emit(yr.Update,[],[],[h]));return}for(var f of this.stickyEventsMap.values())for(var[g]of f.values())if(g.getId()===t)return this.handleRedaction(g)}clear(){this.stickyEventsMap.clear(),this.nextStickyEventExpiryTs=Number.MAX_SAFE_INTEGER,this.scheduleStickyTimer()}}function Nd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ai(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Nd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Nd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var tl="10",Mf=["1","2","3","4","5","6","7","8","9","10"],Pf=30,ke=(function(i){return i.Highlight="highlight",i.Total="total",i})({}),ne=(function(i){return i.MyMembership="Room.myMembership",i.Tags="Room.tags",i.AccountData="Room.accountData",i.Receipt="Room.receipt",i.Name="Room.name",i.Redaction="Room.redaction",i.RedactionCancelled="Room.redactionCancelled",i.LocalEchoUpdated="Room.localEchoUpdated",i.Timeline="Room.timeline",i.TimelineReset="Room.timelineReset",i.TimelineRefresh="Room.TimelineRefresh",i.OldStateUpdated="Room.OldStateUpdated",i.CurrentStateUpdated="Room.CurrentStateUpdated",i.HistoryImportedWithinTimeline="Room.historyImportedWithinTimeline",i.UnreadNotifications="Room.UnreadNotifications",i.Summary="Room.Summary",i})({});class zi extends Kc{constructor(e,t,r){var n,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};super(),n=this,this.roomId=e,this.client=t,this.myUserId=r,this.opts=a,c(this,"reEmitter",void 0),c(this,"txnToEvent",new Map),c(this,"notificationCounts",{}),c(this,"bumpStamp",void 0),c(this,"threadNotifications",new Map),c(this,"cachedThreadReadReceipts",new Map),c(this,"oldestThreadedReceiptTs",1/0),c(this,"unthreadedReceipts",new Map),c(this,"timelineSets",void 0),c(this,"polls",new Map),c(this,"threadsTimelineSets",[]),c(this,"filteredTimelineSets",{}),c(this,"timelineNeedsRefresh",!1),c(this,"pendingEventList",void 0),c(this,"blacklistUnverifiedDevices",void 0),c(this,"selfMembership",void 0),c(this,"heroes",null),c(this,"getTypeWarning",!1),c(this,"membersPromise",void 0),c(this,"name",void 0),c(this,"normalizedName",void 0),c(this,"tags",{}),c(this,"accountData",new Map),c(this,"summary",null),c(this,"oldState",void 0),c(this,"currentState",void 0),c(this,"relations",void 0),c(this,"threads",new Map),c(this,"visibilityEvents",new Map),c(this,"roomReceipts",new af(this)),c(this,"stickyEvents",new qr),c(this,"threadTimelineSetsPromise",null),c(this,"threadsReady",!1),c(this,"updateThreadRootEvents",(s,o,d)=>{if(s.length){var l;if(this.updateThreadRootEvent((l=this.threadsTimelineSets)===null||l===void 0?void 0:l[0],s,o,d),s.hasCurrentUserParticipated){var u;this.updateThreadRootEvent((u=this.threadsTimelineSets)===null||u===void 0?void 0:u[1],s,o,d)}}}),c(this,"updateThreadRootEvent",(s,o,d,l)=>{s&&o.rootEvent&&(l&&s.removeEvent(o.id),xe.hasServerSideSupport?s.addLiveEvent(o.rootEvent,{duplicateStrategy:En.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):s.addEventToTimeline(o.rootEvent,s.getLiveTimeline(),{toStartOfTimeline:d,addToState:!1}))}),c(this,"tryApplyRedaction",s=>{if(s.isRedaction()){var o=s.event.redacts,d=o?this.findEventById(o):void 0;if(o)try{this.stickyEvents.handleRedaction(d||o)}catch(f){O.error("Failed to handle redaction for sticky event",f)}d&&this.applyEventAsRedaction(s,d)}else if(s.getType()===F.RoomMember){var l=s.getContent().membership;if(l!==Se.Ban&&!(l===Se.Leave&&s.getStateKey()!==s.getSender()))return;var u=s.getContent()["org.matrix.msc4293.redact_events"];if(u!==!0)return;var h=this.getLiveTimeline().getState(be.Forward);if(!h.maySendRedactionForEvent(s,s.getSender()))return;var v=this.getTimelineSets().map(f=>f.getTimelines()).reduce((f,g)=>(f.push(...g),f),[]).map(f=>f.getEvents().filter(g=>g.getSender()===s.getStateKey())).reduce((f,g)=>(f.push(...g),g),[]);for(var m of v)this.applyEventAsRedaction(s,m)}}),this.setMaxListeners(100),this.reEmitter=new qn(this),a.pendingEventOrdering=a.pendingEventOrdering||en.Chronological,this.name=e,this.normalizedName=e,this.relations=new Tc(this.client,this),this.on(ne.Receipt,this.onReceipt),this.reEmitter.reEmit(this.stickyEvents,[yr.Update]),this.timelineSets=[new Gr(this,a)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[ne.Timeline,ne.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===en.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then(s=>{var o=this.client.getEventMapper({decrypt:!1});s.forEach((function(){var d=_(function*(l){var u=o(l);yield t.decryptEventIfNeeded(u),u.setStatus(pe.NOT_SENT),n.addPendingEvent(u,u.getTxnId())});return function(l){return d.apply(this,arguments)}})())})),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return _(function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if((t=e.client)!==null&&t!==void 0&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(At.My)]);var r=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=r[0],e.threadsTimelineSets[1]=r[1],r}catch{return e.threadTimelineSetsPromise=null,null}return null})()}decryptCriticalEvents(){var e=this;return _(function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),r=e.getLiveTimeline().getEvents(),n=r.findIndex(s=>s.event.event_id===t),a=r.slice(n).reverse().map(s=>e.client.decryptEventIfNeeded(s));yield Promise.allSettled(a)}})()}decryptAllEvents(){var e=this;return _(function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map(r=>e.client.decryptEventIfNeeded(r));yield Promise.allSettled(t)}})()}getCreator(){var e,t=this.currentState.getStateEvents(F.RoomCreate,"");return(e=t?.getSender())!==null&&e!==void 0?e:null}getVersion(){return this.currentState.getRoomVersion()}getRecommendedVersion(){var e=this;return _(function*(){var t={};try{t=yield e.client.getCapabilities()}catch{}var r=t["m.room_versions"];if(!r){r={default:tl,available:{}};for(var n of Mf)r.available[n]=Zo.Stable}var a=e.checkVersionAgainstCapability(r);if(a.urgent&&a.needsUpgrade){O.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(s){O.warn("Failed to refresh room version capabilities",s)}if(r=t["m.room_versions"],r)a=e.checkVersionAgainstCapability(r);else return O.warn("No room version capability - assuming upgrade required."),a}return a})()}checkVersionAgainstCapability(e){var t=this.getVersion();O.log("[".concat(this.roomId,"] Current version: ").concat(t)),O.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return r;var n=Object.keys(e.available).filter(a=>e.available[a]==="stable");return n.includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?O.warn("URGENT upgrade required on ".concat(this.roomId)):O.warn("Non-urgent upgrade required on ".concat(this.roomId))),r}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(F.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=Oa(this.pendingEventList,function(r){return r.getId()==e},!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,r;return(t=(r=this.pendingEventList)===null||r===void 0?void 0:r.some(n=>n.getId()===e))!==null&&t!==void 0?t:!1}getPendingEvent(e){var t,r;return(t=(r=this.pendingEventList)===null||r===void 0?void 0:r.find(n=>n.getId()===e))!==null&&t!==void 0?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var r=t[t.length-1];return r.getTs()}else return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,r=this.getLiveTimeline().getEvents(),n=r[r.length-1],a=this.getLastThread();if(!a)return n;var s=a.events[a.events.length-1];return((e=n?.getTs())!==null&&e!==void 0?e:0)>((t=s?.getTs())!==null&&t!==void 0?t:0)?n:s}getLastThread(){return this.getThreads().reduce((e,t)=>{var r,n;if(!e)return t;var a=t.events[t.events.length-1],s=e.events[e.events.length-1];return((r=a?.getTs())!==null&&r!==void 0?r:0)>=((n=s?.getTs())!==null&&n!==void 0?n:0)?t:e},void 0)}getMyMembership(){var e;return(e=this.selfMembership)!==null&&e!==void 0?e:Se.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===Se.Invite){var t=this.getInvitedAndJoinedMemberCount();if(t===2){var r;return(r=this.heroes)===null||r===void 0||(r=r[0])===null||r===void 0?void 0:r.userId}}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.heroes)&&this.heroes.length)return this.heroes[0].userId;var r=this.currentState.getMembers(),n=r.find(a=>a.userId!==this.myUserId);return n?n.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(Lo.name,"");return Array.isArray(e?.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),r=0;if(this.getMembers().forEach(g=>{g.membership!=="join"&&g.membership!=="invite"||t.includes(g.userId)||r++}),!(r>2)){var n=(e=this.heroes)===null||e===void 0?void 0:e.filter(g=>!t.includes(g.userId)),a=Array.isArray(n)&&n.length;if(a){for(var s of n)if(s.fromMSC4186){var d=new Cn(this.roomId,s.userId);return d.setMembershipEvent(new at({event_id:"$"+this.roomId+s.userId+new Date().getTime(),type:F.RoomMember,state_key:s.userId,content:{displayname:s.displayName,avatar_url:s.avatarUrl}})),d}else{var o=this.getMember(s.userId);if(o)return o}var l=n.map(g=>this.getMember(g.userId)).find(g=>!!g);if(l)return l}var u=this.getMembers(),h=u?.filter(g=>!t.includes(g.userId));if(h.length<=2){var v=h.find(g=>g.userId!==this.myUserId);if(v)return v}if(a){var m=n.map(g=>this.client.getUser(g.userId)).find(g=>!!g);if(m){var f=new Cn(this.roomId,m.userId);return f.user=m,f}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===Se.Leave&&this.cleanupAfterLeaving(),this.emit(ne.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return _(function*(){var t=e.client.store.getSyncToken(),r=yield e.client.members(e.roomId,void 0,Se.Leave,t??void 0);return r.chunk})()}loadMembers(){var e=this;return _(function*(){var t=!1,r=yield e.client.store.getOutOfBandMembers(e.roomId);(r===null||e.hasEncryptionStateEvent())&&(t=!0,r=yield e.loadMembersFromServer(),O.log("LL: got ".concat(r.length," ")+"members from server for room ".concat(e.roomId)));var n=r.filter(jt).map(e.client.getEventMapper());return{memberEvents:n,fromServer:t}})()}membersLoaded(){return this.opts.lazyLoadMembers?this.currentState.outOfBandMembersReady():!0}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then(t=>(this.currentState.setOutOfBandMembers(t.memberEvents),t.fromServer)).catch(t=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),t});return e.then(t=>{if(t){var r=this.currentState.getMembers().filter(a=>a.isOutOfBand()).map(a=>{var s;return(s=a.events.member)===null||s===void 0?void 0:s.event});O.log("LL: telling store to write ".concat(r.length)+" members for room ".concat(this.roomId));var n=this.client.store;return n.setOutOfBandMembers(this.roomId,r).catch(a=>{O.log("LL: storing OOB room members failed, oh well",a)})}}).catch(t=>{O.error(t)}),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return _(function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)})()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch(e=>{O.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),O.log(e)})}refreshLiveTimeline(){var e=this;return _(function*(){var t=e.getLiveTimeline(),r=t.getPaginationToken(te.FORWARDS),n=t.getPaginationToken(te.BACKWARDS),a=t.getEvents(),s=a[a.length-1];O.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(s&&s.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(r," ")+"backwardPaginationToken=".concat(n));var o=e.getUnfilteredTimelineSet(),d=null;s?(e.resetLiveTimeline(null,null),e.emit(ne.TimelineRefresh,e,o),d=yield e.client.getEventTimeline(o,s.getId())):d=yield e.client.getLatestTimeline(o);var l=o.getLiveTimeline();!l||l.getPaginationToken(be.Forward)===null&&l.getPaginationToken(be.Backward)===null&&l.getEvents().length===0?(O.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),d.setPaginationToken(r,te.FORWARDS),o.setLiveTimeline(d),e.fixUpLegacyTimelineFields()):O.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(ne.TimelineRefresh,e,o)})()}resetLiveTimeline(e,t){for(var r of this.timelineSets)r.resetLiveTimeline(e??void 0,t??void 0);for(var n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(te.BACKWARDS),this.currentState=this.getLiveTimeline().getState(te.FORWARDS),e!==this.oldState&&this.emit(ne.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(ne.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[we.Events,we.Members,we.NewMember,we.Update,we.Marker,We.New,We.Update,We.Destroy,We.LivenessChange]),this.reEmitter.reEmit(this.currentState,[we.Events,we.Members,we.NewMember,we.Update,we.Marker,We.New,We.Update,We.Destroy,We.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],r=!1,n=e.getContent();for(var a of Object.values(n))for(var[s,o]of Object.entries(a))if(Mo(s)&&o){for(var[d,l]of Object.entries(o))if(!(!l||typeof l!="object")){var u=l;d===this.client.getUserId()&&(u.thread_id===void 0?r=!0:typeof u.thread_id=="string"&&t.push(u.thread_id))}}r&&(t=this.getThreads().filter(w=>this.getThreadUnreadNotificationCount(w.id,ke.Total)>0||this.getThreadUnreadNotificationCount(w.id,ke.Highlight)>0).map(w=>w.id),t.push("main"));for(var h of t){var v,m=20,f=h==="main"?this.getLiveTimeline():(v=this.getThread(h))===null||v===void 0?void 0:v.liveTimeline;if(!f){O.warn("Couldn't find timeline for thread ID ".concat(h," in room ").concat(this.roomId));continue}for(var g=f.getEvents(),T=0,R=g.length-1;R>=0;R--){var S;if(R===g.length-m)return;var I=g[R];if(this.hasUserReadEvent(this.client.getUserId(),I.getId()))break;var b=this.client.getPushActionsForEvent(I);T+=b!=null&&(S=b.tweaks)!==null&&S!==void 0&&S.highlight?1:0}h==="main"?this.setUnreadNotificationCount(ke.Highlight,T):this.setThreadUnreadNotificationCount(h,ke.Highlight,T)}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),r=this.findThreadForEvent(t);return r?r.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var r=this.getThreads(),n=0;n<r.length;n++){var a=r[n];if(t=a.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ke.Total,t=this.getRoomUnreadNotificationCount(e);for(var r of this.threadNotifications.values()){var n;t+=(n=r[e])!==null&&n!==void 0?n:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ke.Total,r=arguments.length>1?arguments[1]:void 0,n=!!r.threadRootId&&!r.isThreadRoot;return(e=n?this.getThreadUnreadNotificationCount(r.threadRootId,t):this.getRoomUnreadNotificationCount(t))!==null&&e!==void 0?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:ke.Total;return(e=this.notificationCounts[t])!==null&&e!==void 0?e:0}getThreadUnreadNotificationCount(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:ke.Total;return(t=(r=this.threadNotifications.get(e))===null||r===void 0?void 0:r[n])!==null&&t!==void 0?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,r;if(((t=e.highlight)!==null&&t!==void 0?t:0)>0||((r=e.total)!==null&&r!==void 0?r:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,r){var n,a,s=ai({highlight:(n=this.threadNotifications.get(e))===null||n===void 0?void 0:n.highlight,total:(a=this.threadNotifications.get(e))===null||a===void 0?void 0:a.total},{[t]:r});this.threadNotifications.set(e,s),this.emit(ne.UnreadNotifications,s,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var r,n;if(((r=t.highlight)!==null&&r!==void 0?r:0)>0)return ke.Highlight;((n=t.total)!==null&&n!==void 0?n:0)>0&&!e&&(e=ke.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[r,n]of this.threadNotifications)e.includes(r)||(n.total=0,t||(n.highlight=0));this.emit(ne.UnreadNotifications)}setBumpStamp(e){this.bumpStamp=e}getBumpStamp(){return this.bumpStamp}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(ne.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t,r=(t=e["m.heroes"])===null||t===void 0?void 0:t.map(s=>({userId:s,fromMSC4186:!1})),n=e["m.joined_member_count"],a=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(a)&&this.currentState.setInvitedMemberCount(a),Array.isArray(r)&&(this.heroes=r.filter(s=>s.userId!=this.myUserId)),this.emit(ne.Summary,e)}setMSC4186SummaryData(e,t,r){e&&(this.heroes=e.filter(n=>n.user_id!==this.myUserId).map(n=>({userId:n.user_id,displayName:n.displayname,avatarUrl:n.avatar_url,fromMSC4186:!0}))),t!==void 0&&Number.isInteger(t)&&this.currentState.setJoinedMemberCount(t),r!==void 0&&Number.isInteger(r)&&this.currentState.setInvitedMemberCount(r),this.emit(ne.Summary,{"m.heroes":this.heroes?this.heroes.map(n=>n.userId):[],"m.joined_member_count":t,"m.invited_member_count":r})}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return this.blacklistUnverifiedDevices===void 0?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0,s=arguments.length>5&&arguments[5]!==void 0?arguments[5]:!1,o=this.getMxcAvatarUrl();return!o&&!a?null:o?Gi(e,o,t,r,n,void 0,void 0,s):null}getMxcAvatarUrl(){var e,t=(e=this.currentState.getStateEvents(F.RoomAvatar,""))===null||e===void 0?void 0:e.getContent().url;return t&&typeof t=="string"?t:null}getCanonicalAlias(){var e,t=(e=this.currentState.getStateEvents(F.RoomCanonicalAlias,""))===null||e===void 0?void 0:e.getContent().alias;return t&&typeof t=="string"?t:null}getAltAliases(){var e,t=(e=this.currentState.getStateEvents(F.RoomCanonicalAlias,""))===null||e===void 0?void 0:e.getContent().alt_aliases;return Array.isArray(t)?t.filter(r=>typeof r=="string"):[]}addEventsToTimeline(e,t,r,n,a){n.getTimelineSet().addEventsToTimeline(e,t,r,n,a)}getThread(e){var t;return(t=this.threads.get(e))!==null&&t!==void 0?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(Se.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter(function(t){return t.membership===e})}getEncryptionTargetMembers(){var e=this;return _(function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(Se.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(Se.Invite))),t})()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(F.RoomHistoryVisibility,"");return(t==null||(e=t.getContent())===null||e===void 0?void 0:e.history_visibility)!=="joined"}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var r=this.getMember(e);return r?r.membership===t:!1}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:r=!0,pendingEvents:n=!0}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var a=Object.assign({filter:e,pendingEvents:n},this.opts),s=new Gr(this,a);this.reEmitter.reEmit(s,[ne.Timeline,ne.TimelineReset]),r&&(this.filteredTimelineSets[e.filterId]=s,this.timelineSets.push(s));var o=this.getLiveTimeline();if(t){o.getEvents().forEach(function(u){s.addLiveEvent(u,{addToState:!1})});for(var d=o;d.getNeighbouringTimeline(te.BACKWARDS);)d=d.getNeighbouringTimeline(te.BACKWARDS);s.getLiveTimeline().setPaginationToken(d.getPaginationToken(te.BACKWARDS),te.BACKWARDS)}else if(r){var l=o.getPaginationToken(be.Forward);s.getLiveTimeline().setPaginationToken(l,be.Backward)}return s}getThreadListFilter(){var e=arguments,t=this;return _(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:At.All,n=t.client.getUserId(),a=new St(n),s={room:{timeline:{[Yr.name]:[De.name]}}};r===At.My&&(s.room.timeline[zr.name]=[n]),a.setDefinition(s);var o=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(r),a);return a.filterId=o,a})()}createThreadTimelineSet(e){var t=this;return _(function*(){var r;if(xe.hasServerSideListSupport)r=new Gr(t,ai(ai({},t.opts),{},{pendingEvents:!1}),void 0,void 0,e??At.All),t.reEmitter.reEmit(r,[ne.Timeline,ne.TimelineReset]);else if(xe.hasServerSideSupport){var n=yield t.getThreadListFilter(e);r=t.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else r=new Gr(t,{pendingEvents:!1}),Array.from(t.threads).forEach(a=>{var[,s]=a;if(s.length!==0){var o=s.timeline.some(d=>d.getSender()===t.client.getUserId());(e!==At.My||o)&&r.getLiveTimeline().addEvent(s.rootEvent,{toStartOfTimeline:!1,addToState:!1})}});return r})()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var r of e)te.setEventMetadata(r,this.currentState,t),this.getThread(r.getId())||this.createThread(r.getId(),r,[],t)}fetchRoomThreads(){var e=this;return _(function*(){if(!(e.threadsReady||!e.client.supportsThreads())){if(xe.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(At.All),e.fetchRoomThreadList(At.My)]);else{var t=yield e.getThreadListFilter(),{chunk:r}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,be.Backward,t);if(!r.length)return;var n=r.map(e.client.getEventMapper()).sort((v,m)=>{var f=v.getServerAggregatedRelation(De.name),g=m.getServerAggregatedRelation(De.name);return f.latest_event.origin_server_ts-g.latest_event.origin_server_ts}),a,s=e.getLiveTimeline().getState(te.FORWARDS);for(var o of n){var d,l={duplicateStrategy:En.Ignore,fromCache:!1,addToState:!1,roomState:s};(d=e.threadsTimelineSets[0])===null||d===void 0||d.addLiveEvent(o,l);var u=o.getServerAggregatedRelation(De.name);if(u!=null&&u.current_user_participated){var h;(h=e.threadsTimelineSets[1])===null||h===void 0||h.addLiveEvent(o,l),a=o}}e.processThreadRoots(n,!0),e.client.decryptEventIfNeeded(n[n.length-1]),a&&e.client.decryptEventIfNeeded(a)}e.on(vt.NewReply,e.onThreadReply),e.on(vt.Update,e.onThreadUpdate),e.on(vt.Delete,e.onThreadDelete),e.threadsReady=!0}})()}processPollEvents(e){var t=this;return _(function*(){for(var r of e)try{if(!r.isEncrypted()&&!Vo(r))continue;yield t.client.decryptEventIfNeeded(r),t.processPollEvent(r)}catch(n){O.warn("Error processing poll event",r.getId(),n)}})()}processPollEvent(e){var t=this;return _(function*(){if(e.isDecryptionFailure()){e.once(Me.Decrypted,s=>{t.processPollEvent(s)});return}if(Et.M_POLL_START.matches(e.getType())){try{var r=new qo(e,t.client,t);t.polls.set(e.getId(),r),t.emit(nr.New,r),e.once(Me.BeforeRedaction,s=>{t.polls.delete(s.getId())})}catch{}return}var n=e.relationEventId;if(n&&t.polls.has(n)){var a=t.polls.get(n);a?.onNewRelation(e)}})()}fetchRoomThreadList(e){var t=this;return _(function*(){if(t.client.supportsThreads()&&t.threadsTimelineSets.length!==0){var r=e===At.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:n,end:a}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,be.Backward,r.threadListType,r.getFilter());if(r.getLiveTimeline().setPaginationToken(a??null,be.Backward),!!n.length){var s=n.map(t.client.getEventMapper());t.processThreadRoots(s,!0);var o=t.getLiveTimeline().getState(te.FORWARDS);for(var d of s)r.addLiveEvent(d,{duplicateStrategy:En.Replace,fromCache:!1,roomState:o,addToState:!1})}}})()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var r=this.getTimelineForEvent(e.id),n=r==null||(t=r.getEvents())===null||t===void 0?void 0:t.find(s=>s.getId()===e.id);n?e.clearEventMetadata(n):O.debug("onThreadDelete: Could not find root event in room timeline");for(var a of this.threadsTimelineSets)a.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var r=this.timelineSets.indexOf(t);r>-1&&this.timelineSets.splice(r,1)}eventShouldLiveIn(e,t,r){var n;if(!((n=this.client)!==null&&n!==void 0&&n.supportsThreads()))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||r!=null&&r.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var a=e.isRelation(De.name),s=e.getAssociatedId(),o=e.threadRootId;if(s&&!a&&(o===s||r!=null&&r.has(s)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};var d;if(s){var l;d=(l=this.findEventById(s))!==null&&l!==void 0?l:t?.find(u=>u.getId()===s)}return d&&!a?this.eventShouldLiveIn(d,t,r):o!=null?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:o}:!s||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=this.getThread(e);if(n)n.addEvents(t,r);else{var a,s=(a=this.findEventById(e))!==null&&a!==void 0?a:t.find(o=>o.getId()===e);this.createThread(e,s,t,r)}}processThreadedEvents(e,t){e.forEach(this.tryApplyRedaction);var r={};for(var n of e){var a,{threadId:s,shouldLiveInThread:o}=this.eventShouldLiveIn(n);o&&!r[s]&&(r[s]=[]),(a=r[s])===null||a===void 0||a.push(n)}Object.entries(r).map(d=>{var[l,u]=d;return this.addThreadedEvents(l,u,t)})}createThread(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],a=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var s=this.relations.getAllChildEventsForEvent(t.getId());s!=null&&s.length&&(n=n.concat(s.filter(d=>!d.isRelation(Ue.Replace))))}var o=new xe(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:(r=this.cachedThreadReadReceipts.get(e))!==null&&r!==void 0?r:[]});return this.reEmitter.reEmit(o,[vt.Delete,vt.Update,vt.NewReply,ne.Timeline,ne.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(o.id,o),o.addEvents(n,!1),this.threadsReady&&o.initialEventsFetched&&this.updateThreadRootEvents(o,a,!1),this.emit(vt.New,o,a),o}applyEventAsRedaction(e,t){var r=t.threadRootId;if(t.makeRedacted(e,this),t.isState()){var n=this.currentState.getStateEvents(t.getType(),t.getStateKey());n?.getId()===t.getId()&&this.currentState.setStateEvents([t])}this.emit(ne.Redaction,e,this,r),this.visibilityEvents.delete(t.getId()),t.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}processLiveEvent(e){this.tryApplyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId){for(var[r,n]of this.txnToEvent)if(n.getId()===e.getId()){O.debug("processLiveEvent: found sent event without txn ID: ",r,e.getId());var a=e.getUnsigned();a.transaction_id=r,e.setUnsigned(a);break}}}addLiveEvent(e,t){var{duplicateStrategy:r,timelineWasEmpty:n,fromCache:a,addToState:s}=t;for(var o of this.timelineSets)o.addLiveEvent(e,{duplicateStrategy:r,fromCache:a,timelineWasEmpty:n,addToState:s});e.sender&&e.getType()!==F.RoomRedaction&&this.addReceipt(Wc(e.sender.userId,e,ht.Read),!0)}addPendingEvent(e,t){if(e.status!==pe.SENDING&&e.status!==pe.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(te.setEventMetadata(e,this.getLiveTimeline().getState(te.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some(s=>s.status===pe.NOT_SENT)&&(O.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(pe.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this.pendingEventList.find(s=>s.getId()===r);!n&&r&&(n=this.findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit(ne.Redaction,e,this,n.threadRootId))}}else for(var a of this.timelineSets)a.getFilter()?a.getFilter().filterRoomTimeline([e]).length&&a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):a.addEventToTimeline(e,a.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(ne.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map(t=>ai(ai({},t.event),{},{txn_id:t.getTxnId()})).filter(t=>{var r=t.type===F.RoomMessageEncrypted,n=this.hasEncryptionStateEvent();return r||!n});this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var r=t.getId(),n=e.getId(),a=t.status;O.debug("Got remote echo for event ".concat(r," -> ").concat(n," old status ").concat(a)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:s,threadId:o}=this.eventShouldLiveIn(e),d=o?this.getThread(o):null;if(d?.setEventMetadata(t),d?.timelineSet.handleRemoteEcho(t,r,n),s)for(var l of this.timelineSets)l.handleRemoteEcho(t,r,n);this.emit(ne.LocalEchoUpdated,t,this,r,a)}updatePendingEvent(e,t,r){if(O.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==pe.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==pe.SENT){var n=this.getTimelineForEvent(r);if(n){var a=this.findEventById(r),s=a?.getUnsigned().transaction_id;if(!s&&a){var o=a.getUnsigned();o.transaction_id=e.getTxnId(),a.setUnsigned(o),this.removeEvent(a.getId()),this.handleRemoteEcho(a,e)}return}}var d=e.status,l=e.getId();if(!d)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var u=Af[d];if(!(u!=null&&u.includes(t)))throw new Error("Invalid EventStatus transition ".concat(d,"->").concat(t));if(e.setStatus(t),t==pe.SENT){e.replaceLocalEventId(r);var{shouldLiveInRoom:h,threadId:v}=this.eventShouldLiveIn(e),m=v?this.getThread(v):void 0;if(m?.setEventMetadata(e),m?.timelineSet.replaceEventId(l,r),h)for(var f of this.timelineSets)f.replaceEventId(l,r)}else if(t==pe.CANCELLED){if(this.pendingEventList){var g=this.getPendingEvent(l);this.removePendingEvent(l),g!=null&&g.isRedaction()&&this.revertRedactionLocalEcho(g)}this.removeEvent(l)}this.savePendingEvents(),this.emit(ne.LocalEchoUpdated,e,this,l,d)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit(ne.RedactionCancelled,e,this),r.isRelation()&&this.aggregateNonLiveRelation(r))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(te.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(te.FORWARDS)+")");if(t.getNeighbouringTimeline(te.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var r=this;return _(function*(){var{duplicateStrategy:n,fromCache:a,timelineWasEmpty:s=!1,addToState:o}=t;if(n&&["replace","ignore"].indexOf(n)===-1)throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");r.assertTimelineSetsAreLive();var d=r.findThreadRoots(e),l={},u={duplicateStrategy:n,fromCache:a,timelineWasEmpty:s,addToState:o},h=[...e];for(var v of e){var m;if(r.processLiveEvent(v),v.getUnsigned().transaction_id){var f=r.txnToEvent.get(v.getUnsigned().transaction_id);if(f){r.handleRemoteEcho(v,f);continue}}var{shouldLiveInRoom:g,shouldLiveInThread:T,threadId:R=""}=r.eventShouldLiveIn(v,h,d);if(!T&&!g&&v.isRelation())try{var S=new at(yield r.client.fetchRoomEvent(r.roomId,v.relationEventId));if(h.push(S),S.threadRootId){d.add(S.threadRootId);var I=v.getUnsigned();I[Di.name]=S.threadRootId,v.setUnsigned(I)}({shouldLiveInRoom:g,shouldLiveInThread:T,threadId:R=""}=r.eventShouldLiveIn(v,h,d))}catch(b){O.error("Failed to load parent event of unhandled relation",b)}T&&!l[R]&&(l[R]=[]),(m=l[R])===null||m===void 0||m.push(v),g?r.addLiveEvent(v,u):!T&&v.isRelation()&&r.relations.aggregateChildEvent(v)}Object.entries(l).forEach(b=>{var[w,p]=b;r.addThreadedEvents(w,p,!1)})})()}partitionThreadedEvents(e){var t=0,r=1,n=2;if(this.client.supportsThreads()){var a=this.findThreadRoots(e);return e.reduce((s,o)=>{var{shouldLiveInRoom:d,shouldLiveInThread:l,threadId:u}=this.eventShouldLiveIn(o,e,a);return d&&s[t].push(o),l&&(o.setThreadId(u??""),s[r].push(o)),!l&&!d&&s[n].push(o),s},[[],[],[]])}else return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var r of e){var n=r.threadRootId;n!=null&&t.add(n)}return t}addReceipt(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=e.getContent();this.roomReceipts.add(r,t),Object.keys(r).forEach(n=>{Object.keys(r[n]).forEach(a=>{Object.keys(r[n][a]).forEach(s=>{var o,d,l,u=r[n][a][s],h=!u.thread_id||u.thread_id===jn,v=h?this:this.threads.get((o=u.thread_id)!==null&&o!==void 0?o:"");if(v){if(v.addReceiptToStructure(n,a,s,u,t),!t&&this.client.isInitialSyncComplete()&&s===this.client.getUserId()){var m=v.timeline[v.timeline.length-1];m&&n===m.getId()&&s===m.getSender()&&(v.setUnread(ke.Total,0),v.setUnread(ke.Highlight,0))}}else{var f;this.cachedThreadReadReceipts.set(u.thread_id,[...(f=this.cachedThreadReadReceipts.get(u.thread_id))!==null&&f!==void 0?f:[],{eventId:n,receiptType:a,userId:s,receipt:u,synthetic:t}])}var g=this.client.getUserId();s===g&&!h&&u.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=u.ts),!u.thread_id&&u.ts>((d=(l=this.unthreadedReceipts.get(s))===null||l===void 0?void 0:l.ts)!==null&&d!==void 0?d:0)&&this.unthreadedReceipts.set(s,u)})})}),this.emit(ne.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===F.Typing?this.currentState.setTypingEvent(t):t.getType()===F.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var r of this.timelineSets){var n=r.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(F.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===Se.Invite){var r=e.getUnsigned().invite_room_state||[];r.forEach(a=>{var s=this.currentState.getStateEvents(a.type,a.state_key);s||this.currentState.setStateEvents([new at({type:a.type,state_key:a.state_key,content:a.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])})}}var n=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=Tv(this.name),this.summary=new Bo(this.roomId,{title:this.name}),n!==this.name&&this.emit(ne.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(ne.Tags,e,this)}addAccountData(e){for(var t of e){t.getType()==="m.tag"&&this.addTags(t);var r=t.getType(),n=this.accountData.get(r);this.accountData.set(r,t),this.emit(ne.AccountData,t,this,n)}}getAccountData(e){return this.accountData.get(e)}_unstable_getStickyEvents(){return this.stickyEvents.getStickyEvents()}_unstable_getKeyedStickyEvent(e,t,r){return this.stickyEvents.getKeyedStickyEvent(e,t,r)}_unstable_getUnkeyedStickyEvent(e,t){return this.stickyEvents.getUnkeyedStickyEvent(e,t)}_unstable_addStickyEvents(e){return this.stickyEvents.addStickyEvents(e)}maySendMessage(){return this.getMyMembership()===Se.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(F.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(F.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===Se.Join,r=this.currentState.getStateEvents(F.RoomPowerLevels,""),n=r&&r.getContent(),a=this.getMember(e);return n&&a&&n.invite>a.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(F.RoomCreate,"");if(!e){this.getTypeWarning||(O.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0);return}return e.getContent()[Ai]}isSpaceRoom(){return this.getType()===$r.Space}isCallRoom(){return this.getType()===$r.UnstableCall}isElementVideoRoom(){return this.getType()===$r.ElementVideo}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.getLiveTimeline().getState(te.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(t!==null)return t}switch(e.type){case Nt.Actual:return e.name;case Nt.Generated:return e.subtype==="Inviting"?"Inviting ".concat(xd(e.names,e.count)):xd(e.names,e.count);case Nt.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!t){var r,n=(r=this.currentState.getStateEvents(F.RoomName,""))===null||r===void 0?void 0:r.getContent().name;if(n&&typeof n=="string")return this.roomNameGenerator({type:Nt.Actual,name:n})}var a=this.getCanonicalAlias();if(a)return this.roomNameGenerator({type:Nt.Actual,name:a});var s=this.currentState.getJoinedMemberCount(),o=this.currentState.getInvitedMemberCount(),d=s+o-1,l=this.getFunctionalMembers(),u=[];if(this.heroes)this.heroes.forEach(S=>{if(l.includes(S.userId)){d--;return}if(S.displayName)u.push(S.displayName);else{var I=this.getMember(S.userId);u.push(I?I.name:S.userId)}});else{var h=this.currentState.getMembers().filter(S=>S.userId!==e&&(S.membership===Se.Invite||S.membership===Se.Join));h=h.filter(S=>{var{userId:I}=S;return l.includes(I)?(d--,!1):!0});var v=new Intl.Collator;h.sort((S,I)=>v.compare(S.userId,I.userId)),h=h.slice(0,5),u=h.map(S=>S.name)}if(d)return this.roomNameGenerator({type:Nt.Generated,names:u,count:d});var m=this.getMyMembership();if(m==Se.Join){var f=this.currentState.getStateEvents(F.RoomThirdPartyInvite);if(f!=null&&f.length){var g=f.map(S=>S.getContent().display_name);return this.roomNameGenerator({type:Nt.Generated,subtype:"Inviting",names:g,count:g.length+1})}}var T=u;T.length||(T=this.currentState.getMembers().filter(S=>S.userId!==e&&S.membership!==Se.Invite&&S.membership!==Se.Join).map(S=>S.name));var R;return T.length&&(R=this.roomNameGenerator({type:Nt.Generated,names:T,count:T.length+1})),this.roomNameGenerator({type:Nt.EmptyRoom,oldName:R})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var r=e.getSender();if(r){var n=Sr.name&&this.currentState.maySendStateEvent(Sr.name,r)||Sr.altName&&this.currentState.maySendStateEvent(Sr.altName,r);if(n){var a=this.visibilityEvents.get(t.eventId);if(a){for(var s=a.length-1,o=Math.max(0,a.length-Pf);s>=o;--s){var d=a[s];if(d.getTs()<e.getTs())break}s===-1?a.unshift(e):a.splice(s+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var l=this.findEventById(t.eventId);l&&l.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),r=t?.event_id,n=this.visibilityEvents.get(r);if(n){var a=n.findIndex(l=>l.getId()===e.getId());if(a!==-1&&(n.splice(a,1),a===n.length)){var s=this.findEventById(r);if(!s)return;if(a===0)this.visibilityEvents.delete(r),s.applyVisibilityEvent();else{var o=n[n.length-1],d=o.asVisibilityChange();if(!d)throw new Error("at this stage, visibility changes should be well-formed");s.applyVisibilityEvent(d)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(!(!t||t.length==0)){var r=t[t.length-1],n=r.asVisibilityChange();n&&(n.visible,!(r.getTs()<e.getTs())&&e.applyVisibilityEvent(n))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter(n=>this.getThreadUnreadNotificationCount(n.id,ke.Total)>0);for(var r of t)r.fixupNotifications(e)}compareEventOrdering(e,t){return hf(this,e,t)}hasEncryptionStateEvent(){var e;return!!(!((e=this.getLiveTimeline().getState(te.FORWARDS))===null||e===void 0)&&e.getStateEvents(F.RoomEncryption,""))}}var Af={[pe.ENCRYPTING]:[pe.SENDING,pe.NOT_SENT,pe.CANCELLED],[pe.SENDING]:[pe.ENCRYPTING,pe.QUEUED,pe.NOT_SENT,pe.SENT],[pe.QUEUED]:[pe.SENDING,pe.NOT_SENT,pe.CANCELLED],[pe.SENT]:[],[pe.NOT_SENT]:[pe.SENDING,pe.QUEUED,pe.CANCELLED],[pe.CANCELLED]:[]},Nt=(function(i){return i[i.EmptyRoom=0]="EmptyRoom",i[i.Generated=1]="Generated",i[i.Actual=2]="Actual",i})({});function xd(i,e){var t=e-1;if(i.length){if(i.length===1&&t<=1)return i[0];if(i.length===2&&t<=2)return"".concat(i[0]," and ").concat(i[1]);var r=t>1;return r?"".concat(i[0]," and ").concat(t," others"):"".concat(i[0]," and 1 other")}else return"Empty room"}var tt=(function(i){return i[i.Stable=0]="Stable",i[i.Unstable=1]="Unstable",i[i.Unsupported=2]="Unsupported",i})({}),nt=(function(i){return i.Thread="Thread",i.ThreadUnreadNotifications="ThreadUnreadNotifications",i.LoginTokenRequest="LoginTokenRequest",i.RelationBasedRedactions="RelationBasedRedactions",i.AccountDataDeletion="AccountDataDeletion",i.RelationsRecursion="RelationsRecursion",i.IntentionalMentions="IntentionalMentions",i})({}),Df={[nt.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[nt.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[nt.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[nt.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[nt.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[nt.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[nt.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function Lf(i){return oo.apply(this,arguments)}function oo(){return oo=_(function*(i){var e=new Map;for(var[t,r]of Object.entries(Df)){var n,a,s,o,d=(n=(a=i.versions)===null||a===void 0?void 0:a.includes(r.matrixVersion||""))!==null&&n!==void 0?n:!1,l=(s=(o=r.unstablePrefixes)===null||o===void 0?void 0:o.every(u=>{var h;return((h=i.unstable_features)===null||h===void 0?void 0:h[u])===!0}))!==null&&s!==void 0?s:!1;d?e.set(t,tt.Stable):l?e.set(t,tt.Unstable):e.set(t,tt.Unsupported)}return e}),oo.apply(this,arguments)}function Fd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Ba(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Fd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Fd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var jd=80*1e3,Uf=3,Pe=(function(i){return i.Error="ERROR",i.Prepared="PREPARED",i.Stopped="STOPPED",i.Syncing="SYNCING",i.Catchup="CATCHUP",i.Reconnecting="RECONNECTING",i})({}),Nf=["org.matrix.msc2716v3"];function Bd(i,e){return"FILTER_SYNC_".concat(i)+(e?"_"+e:"")}var rl=(function(i){return i.Offline="offline",i.Online="online",i.Unavailable="unavailable",i})({});function Jc(i){return Ba({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:30*1e3,pendingEventOrdering:en.Chronological,threadSupport:!1},i)}function zc(i){return Ba({canResetEntireTimeline:e=>!1},i)}class br{constructor(e,t,r){var n=this;this.client=e,c(this,"opts",void 0),c(this,"syncOpts",void 0),c(this,"_peekRoom",null),c(this,"currentSyncRequest",void 0),c(this,"abortController",void 0),c(this,"syncState",null),c(this,"syncStateData",void 0),c(this,"catchingUp",!1),c(this,"running",!1),c(this,"keepAliveTimer",void 0),c(this,"connectionReturnedResolvers",void 0),c(this,"notifEvents",[]),c(this,"failedSyncCount",0),c(this,"storeIsInvalid",!1),c(this,"presence",void 0),c(this,"getPushRules",_(function*(){try{n.syncOpts.logger.debug("Getting push rules...");var a=yield n.client.getPushRules();n.syncOpts.logger.debug("Got push rules"),n.client.pushRules=a}catch(s){return n.syncOpts.logger.error("Getting push rules failed",s),n.shouldAbortSync(s)?void 0:(n.syncOpts.logger.debug("Waiting for saved sync before retrying push rules..."),yield n.recoverFromSyncStartupError(n.savedSyncPromise,s),n.getPushRules())}})),c(this,"buildDefaultFilter",()=>{var a=new St(this.client.credentials.userId);return this.client.canSupport.get(nt.ThreadUnreadNotifications)!==tt.Unsupported&&a.setUnreadThreadNotifications(!0),a}),c(this,"prepareLazyLoadingForSync",_(function*(){n.syncOpts.logger.debug("Prepare lazy loading for sync..."),n.client.isGuest()&&(n.opts.lazyLoadMembers=!1),n.opts.lazyLoadMembers&&(n.syncOpts.logger.debug("Enabling lazy load on sync filter..."),n.opts.filter||(n.opts.filter=n.buildDefaultFilter()),n.opts.filter.setLazyLoadMembers(!0))})),c(this,"storeClientOptions",_(function*(){try{n.syncOpts.logger.debug("Storing client options..."),yield n.client.storeClientOptions(),n.syncOpts.logger.debug("Stored client options")}catch(a){throw n.syncOpts.logger.error("Storing client options failed",a),a}})),c(this,"getFilter",_(function*(){n.syncOpts.logger.debug("Getting filter...");var a;n.opts.filter?a=n.opts.filter:a=n.buildDefaultFilter();var s;try{s=yield n.client.getOrCreateFilter(Bd(n.client.credentials.userId),a)}catch(o){return n.syncOpts.logger.error("Getting filter failed",o),n.shouldAbortSync(o)?{}:(n.syncOpts.logger.debug("Waiting for saved sync before retrying filter..."),yield n.recoverFromSyncStartupError(n.savedSyncPromise,o),n.getFilter())}return{filter:a,filterId:s}})),c(this,"savedSyncPromise",void 0),c(this,"onOnline",()=>{this.syncOpts.logger.debug("Browser thinks we are back online"),this.startKeepAlives(0)}),this.opts=Jc(t),this.syncOpts=zc(r),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[ne.Timeline,ne.TimelineReset])}createRoom(e){var t=Yc(this.client,e,this.opts);return t.on(we.Marker,(r,n)=>{this.onMarkerStateEvent(t,r,n)}),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:r}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(r){this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");return}var n=Nf.includes(e.getVersion())||t.getSender()===e.getCreator();n?(this.syncOpts.logger.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(ne.HistoryImportedWithinTimeline,t,e)):this.syncOpts.logger.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}syncLeftRooms(){var e=this;return _(function*(){var t,r=e.client,n=new St(e.client.credentials.userId);n.setTimelineLimit(1),n.setIncludeLeaveRooms(!0);var a=e.opts.pollTimeout+jd,s=yield r.getOrCreateFilter(Bd(r.credentials.userId,"LEFT_ROOMS"),n),o={timeout:0,filter:s,"org.matrix.msc4222.use_state_after":!0},d=yield r.http.authedRequest(W.Get,"/sync",o,void 0,{localTimeoutMs:a}),l=[];(t=d.rooms)!==null&&t!==void 0&&t.leave&&(l=e.mapSyncResponseToRoomArray(d.rooms.leave));var u=yield Promise.all(l.map((function(){var h=_(function*(v){var m=v.room;if(v.isBrandNewRoom){v.timeline=v.timeline||{prev_batch:null,events:[]},m.getLiveTimeline().setPaginationToken(v.timeline.prev_batch,te.BACKWARDS);var{timelineEvents:f}=yield e.mapAndInjectRoomEvents(v);return m.recalculate(),r.store.storeRoom(m),r.emit(ie.Room,m),e.processEventsForNotifs(m,f),m}});return function(v){return h.apply(this,arguments)}})()));return u.filter(Boolean)})()}peek(e){var t,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;if(((t=this._peekRoom)===null||t===void 0?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var n=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,r).then(a=>{var s;if(((s=this._peekRoom)===null||s===void 0?void 0:s.roomId)!==e)throw new Error("Peeking aborted");a.messages=a.messages||{chunk:[]},a.messages.chunk=a.messages.chunk||[],a.state=a.state||[];var o=Ki(a.state).map(n.getEventMapper()),d=a.state.map(n.getEventMapper()),l=a.messages.chunk.map(n.getEventMapper());return Array.isArray(a.presence)&&a.presence.map(n.getEventMapper()).forEach(function(u){var h=n.store.getUser(u.getContent().user_id);h?h.setPresenceEvent(u):(h=Yt.createUser(u.getContent().user_id,n),h.setPresenceEvent(u),n.store.storeUser(h)),n.emit(ie.Event,u)}),a.messages.start&&(this._peekRoom.oldState.paginationToken=a.messages.start),this._peekRoom.oldState.setStateEvents(o),this._peekRoom.currentState.setStateEvents(d),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(l.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),a.messages.start),n.store.storeRoom(this._peekRoom),n.emit(ie.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom})}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var r,n=this;if(this._peekRoom!==e){this.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}this.client.http.authedRequest(W.Get,"/events",{room_id:e.roomId,timeout:String(30*1e3),from:t},void 0,{localTimeoutMs:50*1e3,abortSignal:(r=this.abortController)===null||r===void 0?void 0:r.signal}).then((function(){var a=_(function*(s){if(n._peekRoom!==e){n.syncOpts.logger.debug("Stopped peeking in room %s",e.roomId);return}s.chunk.filter(function(d){return d.type==="m.presence"}).map(n.client.getEventMapper()).forEach(d=>{var l=n.client.store.getUser(d.getContent().user_id);l?l.setPresenceEvent(d):(l=Yt.createUser(d.getContent().user_id,n.client),l.setPresenceEvent(d),n.client.store.storeUser(l)),n.client.emit(ie.Event,d)});var o=s.chunk.filter(function(d){return d.room_id===e.roomId&&d.event_id}).map(n.client.getEventMapper());yield e.addLiveEvents(o,{addToState:!0}),n.peekPoll(e,s.end)});return function(s){return a.apply(this,arguments)}})(),a=>{this.syncOpts.logger.error("[%s] Peek poll failed: %s",e.roomId,a),setTimeout(()=>{this.peekPoll(e,t)},30*1e3)})}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}recoverFromSyncStartupError(e,t){var r=this;return _(function*(){yield e;var n=r.startKeepAlives();r.updateSyncState(Pe.Error,{error:t}),yield n})()}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(Pe.Error,{error:e}),!0):!1}sync(){var e=this;return _(function*(){var t,r;if(e.running=!0,e.abortController=new AbortController,(t=globalThis.window)===null||t===void 0||(r=t.addEventListener)===null||r===void 0||r.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});e.syncOpts.logger.debug("Getting saved sync token...");var n=e.client.store.getSavedSyncToken().then(u=>(e.syncOpts.logger.debug("Got saved sync token"),u));e.savedSyncPromise=e.client.store.getSavedSync().then(u=>{if(e.syncOpts.logger.debug("Got reply from saved sync, exists? ".concat(!!u)),u)return e.syncFromCache(u)}).catch(u=>{e.syncOpts.logger.error("Getting saved sync failed",u)}),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:a,filter:s}=yield e.getFilter();if(s){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var o=a,d=yield n;if(d)e.syncOpts.logger.debug("Sending first sync request...");else{e.syncOpts.logger.debug("Sending initial sync request...");var l=e.buildDefaultFilter();l.setDefinition(s.getDefinition()),l.setTimelineLimit(e.opts.initialSyncLimit),o=JSON.stringify(l.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:o},d)}return e.syncOpts.logger.debug("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:a})}})()}stop(){var e,t,r;this.syncOpts.logger.debug("SyncApi.stop"),(e=globalThis.window)===null||e===void 0||(t=e.removeEventListener)===null||t===void 0||t.call(e,"online",this.onOnline,!1),this.running=!1,(r=this.abortController)===null||r===void 0||r.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return this.connectionReturnedResolvers?(this.startKeepAlives(0),!0):!1}syncFromCache(e){var t=this;return _(function*(){t.syncOpts.logger.debug("sync(): not doing HTTP hit, instead returning stored /sync data");var r=e.nextBatch;t.client.store.setSyncToken(r);var n={nextSyncToken:r,catchingUp:!1,fromCache:!0},a={next_batch:r,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(n,a)}catch(s){t.syncOpts.logger.error("Error processing cached sync",s)}t.storeIsInvalid||t.updateSyncState(Pe.Prepared,n)})()}doSync(e){var t=this;return _(function*(){for(;t.running;){var r=t.client.store.getSyncToken(),n=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,r)),n=yield t.currentSyncRequest}catch(o){var a=yield t.onSyncError(o);if(a)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(n.next_batch),t.failedSyncCount=0;var s={oldSyncToken:r??void 0,nextSyncToken:n.next_batch,catchingUp:t.catchingUp};try{yield t.processSyncResponse(s,n)}catch(o){t.syncOpts.logger.error("Caught /sync error",o),t.client.emit(ie.SyncUnexpectedError,o)}yield t.client.store.setSyncData(n),s.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(Pe.Prepared,s),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(s)),t.updateSyncState(Pe.Syncing,s),t.client.store.wantsSave()&&(yield t.client.store.save())}t.running||(t.syncOpts.logger.debug("Sync no longer running: exiting."),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(Pe.Stopped))})()}doSyncRequest(e,t){var r,n=this.getSyncParams(e,t);return this.client.http.authedRequest(W.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+jd,abortSignal:(r=this.abortController)===null||r===void 0?void 0:r.signal})}getSyncParams(e,t){var r=this.opts.pollTimeout;(this.getSyncState()!==Pe.Syncing||this.catchingUp)&&(this.catchingUp=!0,r=0);var n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());var a={filter:n,timeout:r,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?a.set_presence=rl.Offline:this.presence!==void 0&&(a.set_presence=this.presence),t?a.since=t:a._cacheBuster=Date.now(),[Pe.Reconnecting,Pe.Error].includes(this.getSyncState())&&(a.timeout=0),a}setPresence(e){this.presence=e}onSyncError(e){var t=this;return _(function*(){if(!t.running)return t.syncOpts.logger.debug("Sync no longer running: exiting"),t.connectionReturnedResolvers&&(t.connectionReturnedResolvers.reject(),t.connectionReturnedResolvers=void 0),t.updateSyncState(Pe.Stopped),!0;if(t.syncOpts.logger.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,t.syncOpts.logger.debug("Number of consecutive failed sync requests:",t.failedSyncCount),t.syncOpts.logger.debug("Starting keep-alive");var r=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=Uf?Pe.Error:Pe.Reconnecting,{error:e});var n=yield r;return n&&t.getSyncState()===Pe.Error&&t.updateSyncState(Pe.Catchup,{catchingUp:!0}),!1})()}processSyncResponse(e,t){var r=this;return _(function*(){var n,a,s,o,d=r.client;if(Array.isArray((n=t.presence)===null||n===void 0?void 0:n.events)&&t.presence.events.filter(jt).map(d.getEventMapper()).forEach(function(R){var S=d.store.getUser(R.getSender());S?S.setPresenceEvent(R):(S=Yt.createUser(R.getSender(),d),S.setPresenceEvent(R),d.store.storeUser(S)),d.emit(ie.Event,R)}),Array.isArray((a=t.account_data)===null||a===void 0?void 0:a.events)){var l=t.account_data.events.filter(jt).map(d.getEventMapper()),u=l.reduce((R,S)=>(R[S.getType()]=d.store.getAccountData(S.getType()),R),{});d.store.storeAccountDataEvents(l),l.forEach(function(R){if(R.getType()===F.PushRules){var S=R.getContent();d.setPushRules(S)}var I=u[R.getType()];return d.emit(ie.AccountData,R,I),R})}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var h=t.to_device.events.filter(jt),v;r.syncOpts.cryptoCallbacks?v=yield r.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(h):v=h.map(R=>({message:R,encryptionInfo:null})),Xc(v,d)}else r.catchingUp=!1;var m=[],f=[],g=[],T=[];t.rooms&&(t.rooms.invite&&(m=r.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(f=r.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(g=r.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(T=r.mapSyncResponseToRoomArray(t.rooms.knock))),r.notifEvents=[],yield gn(m,(function(){var R=_(function*(S){var I=S.room,b=r.mapSyncEventsFormat(S.invite_state,I);yield r.injectRoomEvents(I,b,void 0),S.isBrandNewRoom?(I.recalculate(),d.store.storeRoom(I),d.emit(ie.Room,I)):I.recalculate(),b.forEach(function(w){d.emit(ie.Event,w)})});return function(S){return R.apply(this,arguments)}})()),yield gn(f,(function(){var R=_(function*(S){var I,b=S.room,w=r.mapSyncEventsFormat(S.state,b),p=r.mapSyncEventsFormat(S["org.matrix.msc4222.state_after"],b),E=r.mapSyncEventsFormat(S.timeline,b,!1),y=r.mapSyncEventsFormat(S.ephemeral),P=r.mapSyncEventsFormat(S.account_data),N=r.mapSyncEventsFormat(S.msc4354_sticky),V=S["org.matrix.msc4222.state_after"]?p:w.concat(E),Q=r.isRoomEncrypted(b,V);if(S.unread_notifications){if(!Q||S.unread_notifications.notification_count===0){var le;b.setUnreadNotificationCount(ke.Total,(le=S.unread_notifications.notification_count)!==null&&le!==void 0?le:0)}if(!Q||b.getUnreadNotificationCount(ke.Highlight)<=0){var Ae;b.setUnreadNotificationCount(ke.Highlight,(Ae=S.unread_notifications.highlight_count)!==null&&Ae!==void 0?Ae:0)}}var $=(I=S[Li.name])!==null&&I!==void 0?I:S[Li.altName];if($){b.resetThreadUnreadNotificationCountFromSync(Object.keys($));for(var[ae,se]of Object.entries($)){if(!Q||se.notification_count===0){var de;b.setThreadUnreadNotificationCount(ae,ke.Total,(de=se.notification_count)!==null&&de!==void 0?de:0)}var ve=b.getThreadUnreadNotificationCount(ae,ke.Highlight)<=0;if(!Q||Q&&ve){var Re;b.setThreadUnreadNotificationCount(ae,ke.Highlight,(Re=se.highlight_count)!==null&&Re!==void 0?Re:0)}}}else b.resetThreadUnreadNotificationCountFromSync();if(S.timeline=S.timeline||{},S.isBrandNewRoom)S.timeline.prev_batch!==null&&b.getLiveTimeline().setPaginationToken(S.timeline.prev_batch,te.BACKWARDS);else if(S.timeline.limited){for(var et=!0,je=E.length-1;je>=0;je--){var Qt=E[je].getId();if(b.getTimelineForEvent(Qt)){r.syncOpts.logger.debug("Already have event ".concat(Qt," in limited sync - not resetting")),et=!1,E.splice(0,je);break}}if(et){var H;b.resetLiveTimeline(S.timeline.prev_batch,r.syncOpts.canResetEntireTimeline(b.roomId)?null:(H=e.oldSyncToken)!==null&&H!==void 0?H:null),d.resetNotifTimelineSet()}}if(r.syncOpts.cryptoCallbacks)for(var X of V)X.isState()&&X.getType()===F.RoomEncryption&&X.getStateKey()===""&&(yield r.syncOpts.cryptoCallbacks.onCryptoEvent(b,X));for(var L of E.filter(M=>M.isState()))yield r.client.decryptEventIfNeeded(L);try{"org.matrix.msc4222.state_after"in S?yield r.injectRoomEvents(b,void 0,p,E,e.fromCache):yield r.injectRoomEvents(b,w,void 0,E,e.fromCache)}catch(M){r.syncOpts.logger.error("Failed to process events on room ".concat(b.roomId,":"),M)}S.summary&&b.setSummary(S.summary),b.addEphemeralEvents(y),b.addAccountData(P);var A=N.concat(E.filter(M=>M.unstableStickyInfo!==void 0));b._unstable_addStickyEvents(A),b.recalculate(),S.isBrandNewRoom&&(d.store.storeRoom(b),d.emit(ie.Room,b)),r.processEventsForNotifs(b,E);var k=M=>d.emit(ie.Event,M);w.forEach(k),E.forEach(k),y.forEach(k),P.forEach(k),N.filter(M=>!E.some(C=>C.getId()===M.getId())).forEach(k),b.decryptCriticalEvents()});return function(S){return R.apply(this,arguments)}})()),yield gn(g,(function(){var R=_(function*(S){var I=S.room,{timelineEvents:b,stateEvents:w,stateAfterEvents:p}=yield r.mapAndInjectRoomEvents(S),E=r.mapSyncEventsFormat(S.account_data);I.addAccountData(E),I.recalculate(),S.isBrandNewRoom&&(d.store.storeRoom(I),d.emit(ie.Room,I)),r.processEventsForNotifs(I,b),w?.forEach(function(y){d.emit(ie.Event,y)}),p?.forEach(function(y){d.emit(ie.Event,y)}),b.forEach(function(y){d.emit(ie.Event,y)}),E.forEach(function(y){d.emit(ie.Event,y)})});return function(S){return R.apply(this,arguments)}})()),yield gn(T,(function(){var R=_(function*(S){var I=S.room,b=r.mapSyncEventsFormat(S.knock_state,I);yield r.injectRoomEvents(I,b,void 0),S.isBrandNewRoom?(I.recalculate(),d.store.storeRoom(I),d.emit(ie.Room,I)):I.recalculate(),b.forEach(function(w){d.emit(ie.Event,w)})});return function(S){return R.apply(this,arguments)}})()),e.oldSyncToken&&r.notifEvents.length&&(r.notifEvents.sort(function(R,S){return R.getTs()-S.getTs()}),r.notifEvents.forEach(function(R){var S;(S=d.getNotifTimelineSet())===null||S===void 0||S.addLiveEvent(R,{addToState:!0})})),t.device_lists&&r.syncOpts.cryptoCallbacks&&(yield r.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield(s=r.syncOpts.cryptoCallbacks)===null||s===void 0?void 0:s.processKeyCounts(t.device_one_time_keys_count,(o=t.device_unused_fallback_key_types)!==null&&o!==void 0?o:t["org.matrix.msc2732.device_unused_fallback_key_types"])})()}startKeepAlives(e){return e===void 0&&(e=2e3+Math.floor(Math.random()*5e3)),this.keepAliveTimer!==null&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedResolvers||(this.connectionReturnedResolvers=Promise.withResolvers()),this.connectionReturnedResolvers.promise}pokeKeepAlive(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!this.running){clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.reject("SyncApi.stop() was called"),this.connectionReturnedResolvers=void 0);return}var r=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedResolvers&&(this.connectionReturnedResolvers.resolve(t),this.connectionReturnedResolvers=void 0)};this.client.http.request(W.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15*1e3,abortSignal:(e=this.abortController)===null||e===void 0?void 0:e.signal}).then(()=>{r()},n=>{n.httpStatus==400||n.httpStatus==404?this.keepAliveTimer=setTimeout(r,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(Math.random()*5e3)),this.updateSyncState(Pe.Error,{error:n}))})}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter(r=>!_i(r)).map(r=>{var n=t.store.getRoom(r),a=!1;return n||(n=this.createRoom(r),a=!0),Ba(Ba({},e[r]),{},{room:n,isBrandNewRoom:a})})}mapSyncEventsFormat(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;if(!e||!Array.isArray(e.events))return[];var n=this.client.getEventMapper({decrypt:r});return e.events.filter(jt).map(function(a){return t&&(a.room_id=t.roomId),n(a)})}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Se.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId),a;n?a=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):a=t.getProfileInfo(r.userId),a.then(function(s){var o=r.events.member;o?.getContent().membership===Se.Invite&&(o.getContent().avatar_url=s.avatar_url,o.getContent().displayname=s.displayname,r.setMembershipEvent(o,e.currentState))},function(s){})}})}}findEncryptionEvent(e){return e?.find(t=>t.getType()===F.RoomEncryption&&t.getStateKey()==="")}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return _(function*(){var r=t.mapSyncEventsFormat(e.state,e.room),n=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),a=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,n,a):yield t.injectRoomEvents(e.room,r,void 0,a),{timelineEvents:a,stateEvents:r,stateAfterEvents:n}})()}injectRoomEvents(e,t,r,n){var a=arguments,s=this;return _(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:!1,d=r??t,l=e.getLiveTimeline(),u=l.getEvents().length==0;if(u){for(var h of d)s.client.getPushActionsForEvent(h);l.initialiseState(d,{timelineWasEmpty:u})}s.resolveInvites(e),e.recalculate(),u||(e.oldState.setStateEvents(d),e.currentState.setStateEvents(d)),yield e.addLiveEvents(n||[],{fromCache:o,timelineWasEmpty:u,addToState:r===void 0}),s.client.processBeaconEvents(e,n)})()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var r of t){var n,a=this.client.getPushActionsForEvent(r);a!=null&&a.notify&&(n=a.tweaks)!==null&&n!==void 0&&n.highlight&&this.notifEvents.push(r)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ie.Sync,this.syncState,r,t)}}function Yc(i,e,t){var{timelineSupport:r}=i,n=new zi(e,i,i.getUserId(),{lazyLoadMembers:t.lazyLoadMembers,pendingEventOrdering:t.pendingEventOrdering,timelineSupport:r});return i.reEmitter.reEmit(n,[ne.Name,ne.Redaction,ne.RedactionCancelled,ne.Receipt,ne.Tags,ne.LocalEchoUpdated,ne.AccountData,ne.MyMembership,ne.Timeline,ne.TimelineReset,we.Events,we.Members,we.NewMember,we.Update,We.New,We.Update,We.Destroy,We.LivenessChange]),n.on(we.NewMember,(a,s,o)=>{var d;o.user=(d=i.getUser(o.userId))!==null&&d!==void 0?d:void 0,i.reEmitter.reEmit(o,[pt.Name,pt.Typing,pt.PowerLevel,pt.Membership])}),n}function Xc(i,e){var t=[];i.map(r=>{if(r.message.type==="m.key.verification.cancel"){var n=r.message.content.transaction_id;n&&t.push(n)}return r}).forEach(function(r){{var n=r.message,a=n.content,s=new at(Object.assign({},n));if(n.type==="m.key.verification.start"||n.type==="m.key.verification.request"){var o=a.transaction_id;t.includes(o)&&s.flagCancelled()}r.encryptionInfo&&s.makeEncrypted(F.RoomMessageEncrypted,{ciphertext:""},r.encryptionInfo.senderCurve25519KeyBase64,""),e.emit(ie.ToDeviceEvent,s)}e.emit(ie.ReceivedToDeviceMessage,r)})}class xf{constructor(){c(this,"accountData",new Map),c(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,r,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return _(function*(){return[]})()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return _(function*(){return Promise.resolve()})()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return _(function*(){return Promise.resolve()})()}destroy(){return _(function*(){})()}}const lt=[];for(let i=0;i<256;++i)lt.push((i+256).toString(16).slice(1));function Ff(i,e=0){return(lt[i[e+0]]+lt[i[e+1]]+lt[i[e+2]]+lt[i[e+3]]+"-"+lt[i[e+4]]+lt[i[e+5]]+"-"+lt[i[e+6]]+lt[i[e+7]]+"-"+lt[i[e+8]]+lt[i[e+9]]+"-"+lt[i[e+10]]+lt[i[e+11]]+lt[i[e+12]]+lt[i[e+13]]+lt[i[e+14]]+lt[i[e+15]]).toLowerCase()}let Ds;const jf=new Uint8Array(16);function Bf(){if(!Ds){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Ds=crypto.getRandomValues.bind(crypto)}return Ds(jf)}const Wf=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Wd={randomUUID:Wf};function Kf(i,e,t){i=i||{};const r=i.random??i.rng?.()??Bf();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Ff(r)}function qf(i,e,t){return Wd.randomUUID&&!i?Wd.randomUUID():Kf(i)}var Dt={},Ls={},Us={exports:{}},Kd;function nl(){if(Kd)return Us.exports;Kd=1;var i=Us.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{push:"msid",reg:/^msid:([\w-]+)(?: ([\w-]+))?/,names:["id","appdata"],format:"msid:%s %s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(i).forEach(function(e){var t=i[e];t.forEach(function(r){r.reg||(r.reg=/(.*)/),r.format||(r.format="%s")})}),Us.exports}var qd;function Vf(){return qd||(qd=1,(function(i){var e=function(o){return String(Number(o))===o?Number(o):o},t=function(o,d,l,u){if(u&&!l)d[u]=e(o[1]);else for(var h=0;h<l.length;h+=1)o[h+1]!=null&&(d[l[h]]=e(o[h+1]))},r=function(o,d,l){var u=o.name&&o.names;o.push&&!d[o.push]?d[o.push]=[]:u&&!d[o.name]&&(d[o.name]={});var h=o.push?{}:u?d[o.name]:d;t(l.match(o.reg),h,o.names,o.name),o.push&&d[o.push].push(h)},n=nl(),a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);i.parse=function(o){var d={},l=[],u=d;return o.split(/(\r\n|\r|\n)/).filter(a).forEach(function(h){var v=h[0],m=h.slice(2);v==="m"&&(l.push({rtp:[],fmtp:[]}),u=l[l.length-1]);for(var f=0;f<(n[v]||[]).length;f+=1){var g=n[v][f];if(g.reg.test(m))return r(g,u,m)}}),d.media=l,d};var s=function(o,d){var l=d.split(/=(.+)/,2);return l.length===2?o[l[0]]=e(l[1]):l.length===1&&d.length>1&&(o[l[0]]=void 0),o};i.parseParams=function(o){return o.split(/;\s?/).reduce(s,{})},i.parseFmtpConfig=i.parseParams,i.parsePayloads=function(o){return o.toString().split(" ").map(Number)},i.parseRemoteCandidates=function(o){for(var d=[],l=o.split(" ").map(e),u=0;u<l.length;u+=3)d.push({component:l[u],ip:l[u+1],port:l[u+2]});return d},i.parseImageAttributes=function(o){return o.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(s,{})})},i.parseSimulcastStreamList=function(o){return o.split(";").map(function(d){return d.split(",").map(function(l){var u,h=!1;return l[0]!=="~"?u=e(l):(u=e(l.substring(1,l.length)),h=!0),{scid:u,paused:h}})})}})(Ls)),Ls}var Ns,Vd;function Gf(){if(Vd)return Ns;Vd=1;var i=nl(),e=/%[sdv%]/g,t=function(s){var o=1,d=arguments,l=d.length;return s.replace(e,function(u){if(o>=l)return u;var h=d[o];switch(o+=1,u){case"%%":return"%";case"%s":return String(h);case"%d":return Number(h);case"%v":return""}})},r=function(s,o,d){var l=o.format instanceof Function?o.format(o.push?d:d[o.name]):o.format,u=[s+"="+l];if(o.names)for(var h=0;h<o.names.length;h+=1){var v=o.names[h];o.name?u.push(d[o.name][v]):u.push(d[o.names[h]])}else u.push(d[o.name]);return t.apply(null,u)},n=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];return Ns=function(s,o){o=o||{},s.version==null&&(s.version=0),s.name==null&&(s.name=" "),s.media.forEach(function(h){h.payloads==null&&(h.payloads="")});var d=o.outerOrder||n,l=o.innerOrder||a,u=[];return d.forEach(function(h){i[h].forEach(function(v){v.name in s&&s[v.name]!=null?u.push(r(h,v,s)):v.push in s&&s[v.push]!=null&&s[v.push].forEach(function(m){u.push(r(h,v,m))})})}),s.media.forEach(function(h){u.push(r("m",i.m[0],h)),l.forEach(function(v){i[v].forEach(function(m){m.name in h&&h[m.name]!=null?u.push(r(v,m,h)):m.push in h&&h[m.push]!=null&&h[m.push].forEach(function(f){u.push(r(v,m,f))})})})}),u.join(`\r
`)+`\r
`},Ns}var Gd;function Hf(){if(Gd)return Dt;Gd=1;var i=Vf(),e=Gf(),t=nl();return Dt.grammar=t,Dt.write=e,Dt.parse=i.parse,Dt.parseParams=i.parseParams,Dt.parseFmtpConfig=i.parseFmtpConfig,Dt.parsePayloads=i.parsePayloads,Dt.parseRemoteCandidates=i.parseRemoteCandidates,Dt.parseImageAttributes=i.parseImageAttributes,Dt.parseSimulcastStreamList=i.parseSimulcastStreamList,Dt}var lo=Hf();function il(i,e){if(typeof i.toBase64=="function")return i.toBase64(e);var t=btoa(i.reduce((r,n)=>r+String.fromCharCode(n),""));return e.omitPadding&&(t=t.replace(/={1,2}$/,"")),e.alphabet==="base64url"&&(t=t.replace(/\+/g,"-").replace(/\//g,"_")),t}function _n(i){return il(i,{alphabet:"base64",omitPadding:!1})}function al(i){return il(i,{alphabet:"base64",omitPadding:!0})}function Vn(i){return il(i,{alphabet:"base64url",omitPadding:!0})}function $f(i,e){return typeof Uint8Array.fromBase64=="function"?Uint8Array.fromBase64(i,e):Uint8Array.from(atob(i),t=>t.charCodeAt(0))}function _r(i){return $f(i.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}var Jf="abcdefghijklmnopqrstuvwxyz",zf="ABCDEFGHIJKLMNOPQRSTUVWXYZ",Yf="0123456789";function Xf(i){var e=new Uint8Array(i);return globalThis.crypto.getRandomValues(e),Vn(e)}function wr(i){return Qf(i,zf+Jf+Yf)}function Qf(i,e){if(e.length<2||e.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(i<1||i>32768)throw new Error("Requested random string length must be between 1 and 32768");for(var t=256-256%e.length,r=new Uint8Array(Math.floor(i*1.3)),n=r.length,a=[];a.length<i;){n===r.length&&(globalThis.crypto.getRandomValues(r),n=0);var s=r[n++];s<t&&a.push(e[s%e.length])}return a.join("")}var hr="org.matrix.msc3077.sdp_stream_metadata",Ne=(function(i){return i.Usermedia="m.usermedia",i.Screenshare="m.screenshare",i})({}),Ri=null,uo=0,Zf=()=>(Ri===null&&(Ri=new AudioContext),uo++,Ri),ep=()=>{if(uo--,uo===0){var i;(i=Ri)===null||i===void 0||i.close(),Ri=null}},tp=200,co=-60,rp=8,xt=(function(i){return i.NewStream="new_stream",i.MuteStateChanged="mute_state_changed",i.LocalVolumeChanged="local_volume_changed",i.VolumeChanged="volume_changed",i.ConnectedChanged="connected_changed",i.Speaking="speaking",i.Disposed="disposed",i})({});class ir extends Ke{constructor(e){super(),c(this,"stream",void 0),c(this,"sdpMetadataStreamId",void 0),c(this,"userId",void 0),c(this,"deviceId",void 0),c(this,"purpose",void 0),c(this,"speakingVolumeSamples",void 0),c(this,"client",void 0),c(this,"call",void 0),c(this,"roomId",void 0),c(this,"audioMuted",void 0),c(this,"videoMuted",void 0),c(this,"localVolume",1),c(this,"measuringVolumeActivity",!1),c(this,"audioContext",void 0),c(this,"analyser",void 0),c(this,"frequencyBinCount",void 0),c(this,"speakingThreshold",co),c(this,"speaking",!1),c(this,"volumeLooperTimeout",void 0),c(this,"_disposed",!1),c(this,"_connected",!1),c(this,"onAddTrack",()=>{this.emit(xt.NewStream,this.stream)}),c(this,"onCallState",t=>{t===ge.Connected?this.connected=!0:t===ge.Connecting&&(this.connected=!1)}),c(this,"volumeLooper",()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var t=-1/0;for(var r of this.frequencyBinCount)r>t&&(t=r);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(t),this.emit(xt.VolumeChanged,t);var n=!1;for(var a of this.speakingVolumeSamples)if(a>this.speakingThreshold){n=!0;break}this.speaking!==n&&(this.speaking=n,this.emit(xt.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,tp)}}),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(rp).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(_e.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(xt.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var r=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),r&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(xt.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=Zf()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return(e=t?.getMember(this.userId))!==null&&e!==void 0?e:null}isLocal(){return this.userId===this.client.getUserId()&&(this.deviceId===void 0||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return this.stream.getAudioTracks().length===0||this.audioMuted}isVideoMuted(){return this.stream.getVideoTracks().length===0||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){e!==null&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),t!==null&&(this.videoMuted=t),this.emit(xt.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(xt.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return O.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===Ne.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new ir({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),(e=this.stream)===null||e===void 0||e.removeEventListener("addtrack",this.onAddTrack),(t=this.call)===null||t===void 0||t.removeListener(_e.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,ep()),this._disposed=!0,this.emit(xt.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(xt.LocalVolumeChanged,e)}}var np=3e3,ho=(function(i){return i.Incoming="Call.incoming",i})({});class ip{constructor(e){c(this,"calls",void 0),c(this,"callEventBuffer",void 0),c(this,"nextSeqByCall",new Map),c(this,"toDeviceEventBuffers",new Map),c(this,"client",void 0),c(this,"candidateEventsByCall",void 0),c(this,"eventBufferPromiseChain",void 0),c(this,"onSync",()=>{var t=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then(()=>this.evaluateEventBuffer(t)):this.eventBufferPromiseChain=this.evaluateEventBuffer(t)}),c(this,"onRoomTimeline",t=>{this.callEventBuffer.push(t)}),c(this,"onToDeviceEvent",t=>{var r=t.getContent();if(!r.call_id){this.callEventBuffer.push(t);return}if(this.nextSeqByCall.has(r.call_id)||this.nextSeqByCall.set(r.call_id,0),r.seq===void 0){this.callEventBuffer.push(t);return}var n=this.nextSeqByCall.get(r.call_id)||0;if(r.seq!==n){this.toDeviceEventBuffers.has(r.call_id)||this.toDeviceEventBuffers.set(r.call_id,[]);var a=this.toDeviceEventBuffers.get(r.call_id),s=a.findIndex(u=>u.getContent().seq>r.seq);s===-1?a.push(t):a.splice(s,0,t)}else{var o=r.call_id;this.callEventBuffer.push(t),this.nextSeqByCall.set(o,r.seq+1);for(var d=this.toDeviceEventBuffers.get(o),l=d&&d.shift();l&&l.getContent().seq===this.nextSeqByCall.get(o);)this.callEventBuffer.push(l),this.nextSeqByCall.set(o,l.getContent().seq+1),l=d.shift()}}),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(ie.Sync,this.onSync),this.client.on(ne.Timeline,this.onRoomTimeline),this.client.on(ie.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(ie.Sync,this.onSync),this.client.removeListener(ne.Timeline,this.onRoomTimeline),this.client.removeListener(ie.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return _(function*(){yield Promise.all(e.map(u=>t.client.decryptEventIfNeeded(u)));var r=e.filter(u=>{var h=u.getType();return h.startsWith("m.call.")||h.startsWith("org.matrix.call.")}),n=new Set;for(var a of r){var s=a.getType();(s===F.CallAnswer||s===F.CallHangup)&&n.add(a.getContent().call_id)}for(var o of r){var d=o.getType(),l=o.getContent().call_id;if(!(d===F.CallInvite&&n.has(l)))try{yield t.handleCallEvent(o)}catch(u){O.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",u)}}})()}handleCallEvent(e){var t=this;return _(function*(){var r;t.client.emit(ie.ReceivedVoipEvent,e);var n=e.getContent(),a=e.getRoomId()||((r=t.client.groupCallEventHandler.getGroupCallById(n.conf_id))===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.roomId),s=n.conf_id,o=e.getType(),d=e.getSender(),l=n.call_id?t.calls.get(n.call_id):void 0,u,h;if(s){if(h=t.client.groupCallEventHandler.getGroupCallById(s),!h){O.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(s,", type=").concat(o,")"));return}if(u=n.device_id,!u){O.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(d,")")),h.emit(Le.Error,new Zc(d));return}if(n.dest_session_id!==t.client.getSessionId()){O.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring");return}}var v=d===t.client.credentials.userId&&(u===void 0||u===t.client.getDeviceId());if(a){if(o===F.CallInvite){var m,f,g;if(v||e.getLocalAge()>n.lifetime-np||l&&l.state===ge.Ended||(l&&O.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(n.call_id,")")),n.invitee&&n.invitee!==t.client.getUserId()))return;var T=((m=t.client.getTurnServersExpiry())!==null&&m!==void 0?m:0)-Date.now();if(O.info("CallEventHandler handleCallEvent() current turn creds expire in "+T+" ms"),l=(f=kn(t.client,a,{forceTURN:t.client.forceTURN,opponentDeviceId:u,groupCallId:s,opponentSessionId:n.sender_session_id}))!==null&&f!==void 0?f:void 0,!l){O.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(n.call_id,")"));return}l.callId=n.call_id;var R=(g=h)===null||g===void 0?void 0:g.getGroupCallStats();R&&l.initStats(R);try{yield l.initWithInvite(e)}catch(P){if(P instanceof rr)if(P.code===Ii.UnknownDevice){var S;(S=h)===null||S===void 0||S.emit(Le.Error,P)}else O.error(P)}if(t.calls.set(l.callId,l),t.candidateEventsByCall.get(l.callId))for(var I of t.candidateEventsByCall.get(l.callId))l.onRemoteIceCandidatesReceived(I);var b;for(var w of t.calls.values()){var p,E=[ge.WaitLocalMedia,ge.CreateOffer,ge.InviteSent].includes(w.state);if(l.roomId===w.roomId&&w.direction===fr.Outbound&&((p=l.getOpponentMember())===null||p===void 0?void 0:p.userId)===w.invitee&&E){b=w;break}}b?b.callId>l.callId?(O.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(l.callId,", outgoingId=").concat(b.callId,")")),b.replacedBy(l)):(O.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(l.callId,", outgoingId=").concat(b.callId,")")),l.hangup(Ee.Replaced,!0)):t.client.emit(ho.Incoming,l);return}else if(o===F.CallCandidates){if(v)return;l?l.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(n.call_id)||t.candidateEventsByCall.set(n.call_id,[]),t.candidateEventsByCall.get(n.call_id).push(e));return}else if([F.CallHangup,F.CallReject].includes(o)){if(l)l.state!==ge.Ended&&(o===F.CallHangup?l.onHangupReceived(n):l.onRejectReceived(n),l.state===ge.Ended&&t.calls.delete(n.call_id));else{var y;l=(y=kn(t.client,a,{opponentDeviceId:u,opponentSessionId:n.sender_session_id}))!==null&&y!==void 0?y:void 0,l&&(l.callId=n.call_id,l.initWithHangup(e),t.calls.set(n.call_id,l))}return}if(!l||!l.hasPeerConnection){O.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(o,")"));return}if(e.getContent().party_id!==l.ourPartyId)switch(o){case F.CallAnswer:v?l.state===ge.Ringing&&l.onAnsweredElsewhere(n):l.onAnswerReceived(e);break;case F.CallSelectAnswer:l.onSelectAnswerReceived(e);break;case F.CallNegotiate:l.onNegotiateReceived(e);break;case F.CallAssertedIdentity:case F.CallAssertedIdentityPrefix:l.onAssertedIdentityReceived(e);break;case F.CallSDPStreamMetadataChanged:case F.CallSDPStreamMetadataChangedPrefix:l.onSDPStreamMetadataChangedReceived(e);break}}})()}}var vo=(function(i){return i.Incoming="GroupCall.incoming",i.Outgoing="GroupCall.outgoing",i.Ended="GroupCall.ended",i.Participants="GroupCall.participants",i})({});class ap{constructor(e){this.client=e,c(this,"groupCalls",new Map),c(this,"roomDeferreds",new Map),c(this,"onRoomsChanged",t=>{this.createGroupCallForRoom(t)}),c(this,"onRoomStateChanged",(t,r)=>{var n=t.getType();if(n===F.GroupCallPrefix){var a=t.getStateKey(),s=t.getContent(),o=this.groupCalls.get(r.roomId);!o&&!s["m.terminated"]&&!t.isRedacted()?this.createGroupCallFromRoomStateEvent(t):o&&o.groupCallId===a?s["m.terminated"]||t.isRedacted()?o.terminate(!1):s["m.type"]!==o.type&&O.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(r.roomId,")")):o&&o.groupCallId!==a&&O.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(r.roomId,")"))}})}start(){var e=this;return _(function*(){e.client.getSyncState()!==Pe.Syncing&&(O.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise(n=>{var a=()=>{if(e.client.getSyncState()===Pe.Syncing)return e.client.off(ie.Sync,a),n()};e.client.on(ie.Sync,a)}));var t=e.client.getRooms();for(var r of t)e.createGroupCallForRoom(r);e.client.on(ie.Room,e.onRoomsChanged),e.client.on(we.Events,e.onRoomStateChanged)})()}stop(){this.client.removeListener(ie.Room,this.onRoomsChanged),this.client.removeListener(we.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t=this.roomDeferreds.get(e);if(t===void 0){var r;t={prom:new Promise(n=>{r=n})},t.resolve=r,this.roomDeferreds.set(e,t)}return t}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find(t=>t.groupCallId===e)}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(F.GroupCallPrefix),r=t.sort((s,o)=>o.getTs()-s.getTs());for(var n of r){var a=n.getContent();if(!(a["m.terminated"]||n.isRedacted())){O.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(n.getStateKey(),", ts=").concat(n.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(n);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),r=e.getContent(),n=this.client.getRoom(t);if(!n){O.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"));return}var a=e.getStateKey(),s=r["m.type"];if(!Object.values(Yi).includes(s)){O.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(s,", roomId=").concat(t,")"));return}var o=r["m.intent"];if(!Object.values(sl).includes(o)){O.warn("Received invalid group call intent (type=".concat(s,", roomId=").concat(t,")"));return}var d=!!r["io.element.ptt"],l;if(r!=null&&r.dataChannelsEnabled&&r!==null&&r!==void 0&&r.dataChannelOptions){var{ordered:u,maxPacketLifeTime:h,maxRetransmits:v,protocol:m}=r.dataChannelOptions;l={ordered:u,maxPacketLifeTime:h,maxRetransmits:v,protocol:m}}var f=new ls(this.client,n,s,d,o,a,r?.dataChannelsEnabled||this.client.isVoipWithNoMediaAllowed,l,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,r["io.element.livekit_service_url"]);return this.groupCalls.set(n.roomId,f),this.client.emit(vo.Incoming,f),f}}class sp{constructor(){c(this,"bandwidth",{}),c(this,"bitrate",{}),c(this,"packetLoss",{}),c(this,"transport",[])}}class op{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,r=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:r?Math.round(r/1e3):0}}}class lp{static buildReport(e,t,r,n){var a=e?.get(t.localCandidateId),s=e?.get(t.remoteCandidateId);if(s&&a){var o=s.ip!==void 0?s.ip:s.address,d=s.port,l="".concat(o,":").concat(d),u=a.ip!==void 0?a.ip:a.address,h=a.port,v="".concat(u,":").concat(h),m=s.protocol;r.some(f=>f.ip===l&&f.type===m&&f.localIp===v)||r.push({ip:l,type:m,localIp:v,isFocus:n,localCandidateType:a.candidateType,remoteCandidateType:s.candidateType,networkType:a.networkType,rtt:t.currentRoundTripTime?t.currentRoundTripTime*1e3:NaN})}return r}}class dp{constructor(){c(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var r;return this.ssrcToMid[t].forEach((n,a)=>{if(n.find(s=>s==e)){r=a;return}}),r}parse(e,t){var r=lo.parse(e),n=new Map;r.media.forEach(a=>{if(a.mid&&a.type==="video"||a.type==="audio"){var s,o=[];(s=a.ssrcs)===null||s===void 0||s.forEach(d=>{d.attribute==="cname"&&o.push("".concat(d.id))}),n.set("".concat(a.mid),o)}}),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class up{constructor(e){this.pc=e}getLocalTracks(e){var t=r=>r!==null&&r.kind===e;return this.pc.getTransceivers().filter(r=>r.currentDirection==="sendonly"||r.currentDirection==="sendrecv").filter(r=>r.sender!==null).map(r=>r.sender).map(r=>r.track).filter(t)}getTackById(e){return this.pc.getTransceivers().map(t=>{if(t?.sender.track!==null&&t.sender.track.id===e)return t.sender.track;if(t?.receiver.track!==null&&t.receiver.track.id===e)return t.receiver.track}).find(t=>t!==void 0)}getLocalTrackIdByMid(e){var t,r=this.pc.getTransceivers().find(n=>n.mid===e);return r==null||(t=r.sender)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getRemoteTrackIdByMid(e){var t,r=this.pc.getTransceivers().find(n=>n.mid===e);return r==null||(t=r.receiver)===null||t===void 0||(t=t.track)===null||t===void 0?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find(t=>t.receiver.track.id===e||t.sender.track!==null&&t.sender.track.id===e)}}class cp{constructor(e,t,r){this.trackId=e,this.type=t,this.kind=r,c(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),c(this,"bitrate",{download:0,upload:0}),c(this,"resolution",{width:-1,height:-1}),c(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),c(this,"framerate",0),c(this,"jitter",0),c(this,"codec",""),c(this,"isAlive",!0),c(this,"isMuted",!1),c(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class hp{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,c(this,"track2stats",new Map)}findTrack2Stats(e,t){var r;if(e.trackIdentifier)r=e.trackIdentifier;else if(e.mid)r=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var n=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!n)return;r=t==="remote"?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(r){var a=this.track2stats.get(r);if(!a){var s=this.mediaTrackHandler.getTackById(r);if(s!==void 0){var o=s.kind==="audio"?s.kind:"video";a=new cp(r,t,o),this.track2stats.set(r,a)}else return}return a}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(t.length!==0)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class Br{static getNonNegativeValue(e){var t=e;return typeof t!="number"&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class It{static buildFramerateResolution(e,t){var r={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;r.height&&r.width&&e.setResolution(r),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,r,n){var a=e.getFramerate();if(!a){if(r){var s=t.timestamp-r.timestamp;if(s>0&&t.framesSent){var o=t.framesSent-r.framesSent;a=o/s*1e3}}if(!a)return}a=n?Math.round(a/n):0,e.setFramerate(a)}static buildCodec(e,t,r){var n=e?.get(r.codecId);if(n){var a=n.mimeType.split("/")[1];a&&t.setCodec(a)}}static buildBitrateReceived(e,t,r){e.setBitrate({download:It.calculateBitrate(t.bytesReceived,r.bytesReceived,t.timestamp,r.timestamp),upload:0})}static buildBitrateSend(e,t,r){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,r.bytesSent,t.timestamp,r.timestamp)})}static buildPacketsLost(e,t,r){var n=t.type==="outbound-rtp"?"packetsSent":"packetsReceived",a=t[n];(!a||a<0)&&(a=0);var s=Br.getNonNegativeValue(r[n]),o=Math.max(0,a-s),d=Br.getNonNegativeValue(t.packetsLost),l=Br.getNonNegativeValue(r.packetsLost),u=Math.max(0,d-l);e.setLoss({packetsTotal:o+u,packetsLost:u,isDownloadStream:t.type!=="outbound-rtp"})}static calculateBitrate(e,t,r,n){var a=Br.getNonNegativeValue(e),s=Br.getNonNegativeValue(t),o=Math.max(0,a-s),d=r-n,l=0;return d>0&&(l=Math.round(o*8/d)),l}static setTrackStatsState(e,t){var r;if(t===void 0){e.alive=!1;return}var n=e.getType()==="remote"?t.receiver.track:t==null||(r=t.sender)===null||r===void 0?void 0:r.track;if(n==null){e.alive=!1;return}if(n.readyState==="ended"){e.alive=!1;return}e.muted=n.muted,e.enabled=n.enabled,e.alive=!0}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter(s=>s.getType()==="remote"),a=n.filter(s=>s.kind==="audio");return n.forEach(s=>{var o=s.kind==="video"?t:r;if(o.count++,s.alive&&s.muted&&o.muted++,o.maxJitter<s.getJitter()&&(o.maxJitter=s.getJitter()),o.maxPacketLoss<s.getLoss().packetsLost&&(o.maxPacketLoss=s.getLoss().packetsLost),a.length>0){var d,l;o.concealedAudio+=(d=s.getAudioConcealment())===null||d===void 0?void 0:d.concealedAudio,o.totalAudio+=(l=s.getAudioConcealment())===null||l===void 0?void 0:l.totalAudioDuration}}),{audioTrackSummary:r,videoTrackSummary:t}}static buildJitter(e,t){if(t.type==="inbound-rtp"){var r=t?.jitter;if(r!==void 0){var n=Br.getNonNegativeValue(r);e.setJitter(Math.round(n*1e3))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if(t.type==="inbound-rtp"){var r=1e3*t?.totalSamplesDuration/t?.totalSamplesReceived,n=r*t?.concealedSamples,a=1e3*t?.totalSamplesDuration;e.setAudioConcealment(n,a)}}}class Ti{static build(e){var t={},r={download:0,upload:0},n={download:0,upload:0},a=0,s=0,o={local:new Map,remote:new Map},d={local:new Map,remote:new Map},l={local:new Map,remote:new Map},u=new Map,h=new Map,v=0,m=0,f=0,g=0,T=0,R=0;for(var[S,I]of e){var b=I.getLoss(),w=b.isDownloadStream?"download":"upload";if(r[w]+=b.packetsTotal,n[w]+=b.packetsLost,a+=I.getBitrate().download,s+=I.getBitrate().upload,I.kind==="audio"){var p=I.getAudioConcealment();T+=p.concealedAudio,R+=p.totalAudioDuration,v+=I.getBitrate().download,m+=I.getBitrate().upload}else f+=I.getBitrate().download,g+=I.getBitrate().upload;o[I.getType()].set(S,I.getResolution()),d[I.getType()].set(S,I.getFramerate()),l[I.getType()].set(S,I.getCodec()),I.getType()==="remote"&&(u.set(S,I.getJitter()),I.kind==="audio"&&h.set(S,I.getAudioConcealment())),I.resetBitrate()}return t.bitrate={upload:s,download:a},t.bitrate.audio={upload:m,download:v},t.bitrate.video={upload:g,download:f},t.packetLoss={total:Ti.calculatePacketLoss(n.download+n.upload,r.download+r.upload),download:Ti.calculatePacketLoss(n.download,r.download),upload:Ti.calculatePacketLoss(n.upload,r.upload)},t.audioConcealment=h,t.totalAudioConcealment={concealedAudio:T,totalAudioDuration:R},t.framerate=d,t.resolution=o,t.codec=l,t.jitter=u,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class Er{static buildCallFeedReport(e,t,r){var n=r.getTransceivers(),a=[],s=[];return n.forEach(o=>{var d,l=(d=o.sender)!==null&&d!==void 0&&d.track?Er.buildTrackStats(o.sender.track,"sender"):null,u=Er.buildTrackStats(o.receiver.track,"receiver");a.push({mid:o.mid==null?"null":o.mid,direction:o.direction,currentDirection:o.currentDirection==null?"null":o.currentDirection,sender:l,receiver:u})}),{callId:e,opponentMemberId:t,transceiver:a,callFeeds:s}}static buildTrackStats(e){var t,r,n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"--",a=(t=e.getSettings())===null||t===void 0?void 0:t.deviceId,s=(r=e.getConstraints())===null||r===void 0?void 0:r.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:a??"unknown",constrainDeviceId:s??"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:n}}static expandCallFeedReport(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"unknown";return t.forEach(n=>{var a=n.stream.getAudioTracks(),s=n.stream.getVideoTracks(),o=a.length>0?Er.buildTrackStats(n.stream.getAudioTracks()[0],n.purpose):null,d=s.length>0?Er.buildTrackStats(n.stream.getVideoTracks()[0],n.purpose):null,l={stream:n.stream.id,type:n.isLocal()?"local":"remote",audio:o,video:d,purpose:n.purpose,prefix:r,isVideoMuted:n.isVideoMuted(),isAudioMuted:n.isAudioMuted()};e.callFeeds.push(l)}),e}}function Hd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function da(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Hd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Hd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class vp{constructor(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;this.callId=e,this.opponentMemberId=t,this.pc=r,this.emitter=n,this.isFocus=a,c(this,"isActive",!0),c(this,"previousStatsReport",void 0),c(this,"currentStatsReport",void 0),c(this,"connectionStats",new sp),c(this,"trackStats",void 0),r.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new hp(new dp,new up(r))}processStats(e,t){var r=this;return _(function*(){var n={isFirstCollection:r.previousStatsReport===void 0,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(r.isActive){var a=r.pc.getStats();if(typeof a?.then=="function")return a.then(s=>{var o,d;r.currentStatsReport=typeof s?.result=="function"?s.result():s;try{r.processStatsReport(e,t)}catch(u){return r.handleError(u),n}r.previousStatsReport=r.currentStatsReport,n.receivedMedia=r.connectionStats.bitrate.download,n.receivedAudioMedia=((o=r.connectionStats.bitrate.audio)===null||o===void 0?void 0:o.download)||0,n.receivedVideoMedia=((d=r.connectionStats.bitrate.video)===null||d===void 0?void 0:d.download)||0;var l=It.buildTrackSummary(Array.from(r.trackStats.getTrack2stats().values()));return da(da({},n),{},{audioTrackSummary:l.audioTrackSummary,videoTrackSummary:l.videoTrackSummary})}).catch(s=>(r.handleError(s),n));r.isActive=!1}return Promise.resolve(n)})()}processStatsReport(e,t){var r,n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,(r=this.currentStatsReport)===null||r===void 0||r.forEach(a=>{var s=this.previousStatsReport?this.previousStatsReport.get(a.id):null;if(a.type==="candidate-pair"&&a.nominated&&a.state==="succeeded")this.connectionStats.bandwidth=op.buildBandwidthReport(a),this.connectionStats.transport=lp.buildReport(this.currentStatsReport,a,this.connectionStats.transport,this.isFocus);else if(a.type==="inbound-rtp"||a.type==="outbound-rtp"){var o=this.trackStats.findTrack2Stats(a,a.type==="inbound-rtp"?"remote":"local");if(!o)return;if(s&&It.buildPacketsLost(o,a,s),a.type==="inbound-rtp"){It.buildFramerateResolution(o,a),s&&It.buildBitrateReceived(o,a,s);var d=this.trackStats.findTransceiverByTrackId(o.trackId);It.setTrackStatsState(o,d),It.buildJitter(o,a),It.buildAudioConcealment(o,a)}else s&&(n.set(o.trackId,Br.getNonNegativeValue(a.bytesSent)),It.buildBitrateSend(o,a,s));It.buildCodec(this.currentStatsReport,o,a)}else if(a.type==="track"&&a.kind==="video"&&!a.remoteSource){var l=this.trackStats.findLocalVideoTrackStats(a);if(!l)return;It.buildFramerateResolution(l,a),It.calculateSimulcastFramerate(l,a,s,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}}),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(Er.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,O.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=Ti.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(da(da({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){this.pc.signalingState==="stable"&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var zt=(function(i){return i.CONNECTION_STATS="StatsReport.connection_stats",i.CALL_FEED_REPORT="StatsReport.call_feed_report",i.BYTE_SENT_STATS="StatsReport.byte_sent_stats",i.SUMMARY_STATS="StatsReport.summary_stats",i})({});class fp extends Ke{emitByteSendReport(e){this.emit(zt.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(zt.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(zt.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(zt.SUMMARY_STATS,e)}}class Qc{constructor(e){this.emitter=e}build(e){var t=e.filter(u=>!u.isFirstCollection),r=t.length,n=e.length;if(r!==0){var a={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},s=0,o=0;t.forEach(u=>{this.countTrackListReceivedMedia(a,u),this.countConcealedAudio(a,u),s=this.buildMaxJitter(s,u),o=this.buildMaxPacketLoss(o,u)});var d=5,l={percentageReceivedMedia:Number((a.receivedMedia/r).toFixed(d)),percentageReceivedVideoMedia:Number((a.receivedVideo/r).toFixed(d)),percentageReceivedAudioMedia:Number((a.receivedAudio/r).toFixed(d)),maxJitter:s,maxPacketLoss:o,percentageConcealedAudio:Number(a.totalAudio>0?(a.concealedAudio/a.totalAudio).toFixed(d):0),peerConnections:n};this.emitter.emitSummaryStatsReport(l)}}static extendSummaryReport(e,t){var r=[],n=[];for(var a of t){n.push(a);for(var s of a[1])r.push(s)}e.opponentDevicesInCall=Math.max(0,r.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,r.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=Math.max(0,r.length-1)==0?0:e.peerConnections/(r.length-1)}countTrackListReceivedMedia(e,t){var r=!1,n=!1;(t.receivedAudioMedia>0||t.audioTrackSummary.count===0)&&(e.receivedAudio++,r=!0),(t.receivedVideoMedia>0||t.videoTrackSummary.count===0||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,n=!0),n&&r&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class pp{constructor(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=r,c(this,"timer",void 0),c(this,"gatherers",new Map),c(this,"reports",new fp),c(this,"summaryStatsReportGatherer",new Qc(this.reports))}start(){this.timer===void 0&&this.interval>0&&(this.timer=setInterval(()=>{this.processStats()},this.interval))}stop(){this.timer!==void 0&&(clearInterval(this.timer),this.gatherers.forEach(e=>e.stopProcessingStats()))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,r){return this.hasStatsReportGatherer(e)?!1:(this.gatherers.set(e,new vp(e,t,r,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var r;(r=this.getStatsReportGatherer(e))===null||r===void 0||r.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach(t=>{e.push(t.processStats(this.groupCallId,this.userId))}),Promise.all(e).then(t=>this.summaryStatsReportGatherer.build(t)).catch(t=>{O.error("Could not build summary stats report",t)})}setInterval(e){this.interval=e}}function $d(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ua(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?$d(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):$d(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var sl=(function(i){return i.Ring="m.ring",i.Prompt="m.prompt",i.Room="m.room",i})({}),Yi=(function(i){return i.Video="m.video",i.Voice="m.voice",i})({}),mp=(function(i){return i.CallEnded="call_ended",i})({}),Le=(function(i){return i.GroupCallStateChanged="group_call_state_changed",i.ActiveSpeakerChanged="active_speaker_changed",i.CallsChanged="calls_changed",i.UserMediaFeedsChanged="user_media_feeds_changed",i.ScreenshareFeedsChanged="screenshare_feeds_changed",i.LocalScreenshareStateChanged="local_screenshare_state_changed",i.LocalMuteStateChanged="local_mute_state_changed",i.ParticipantsChanged="participants_changed",i.Error="group_call_error",i})({}),yn=(function(i){return i.ConnectionStats="GroupCall.connection_stats",i.ByteSentStats="GroupCall.byte_sent_stats",i.SummaryStats="GroupCall.summary_stats",i.CallFeedStats="GroupCall.call_feed_stats",i})({}),Ii=(function(i){return i.NoUserMedia="no_user_media",i.UnknownDevice="unknown_device",i.PlaceCallFailed="place_call_failed",i})({});class fo extends Error{constructor(e,t,r){r?(super(t+": "+r),c(this,"code",void 0)):(super(t),c(this,"code",void 0)),this.code=e}}class Zc extends fo{constructor(e){super(Ii.UnknownDevice,"No device found for "+e),this.userId=e}}var Ve=(function(i){return i.LocalCallFeedUninitialized="local_call_feed_uninitialized",i.InitializingLocalCallFeed="initializing_local_call_feed",i.LocalCallFeedInitialized="local_call_feed_initialized",i.Entered="entered",i.Ended="ended",i})({}),Jd=1e3*60*60;function ca(i){var e;return((e=i.getOpponentMember())===null||e===void 0?void 0:e.userId)||i.invitee||null}class ls extends Ke{constructor(e,t,r,n,a,s,o,d,l){var u,h,v=arguments.length>9&&arguments[9]!==void 0?arguments[9]:!1,m=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=r,this.isPtt=n,this.intent=a,this.dataChannelsEnabled=o,this.dataChannelOptions=d,this.useLivekit=v,c(this,"activeSpeakerInterval",1e3),c(this,"retryCallInterval",5e3),c(this,"participantTimeout",1e3*15),c(this,"pttMaxTransmitTime",1e3*20),c(this,"activeSpeaker",void 0),c(this,"localCallFeed",void 0),c(this,"localScreenshareFeed",void 0),c(this,"localDesktopCapturerSourceId",void 0),c(this,"userMediaFeeds",[]),c(this,"screenshareFeeds",[]),c(this,"groupCallId",void 0),c(this,"allowCallWithoutVideoAndAudio",void 0),c(this,"calls",new Map),c(this,"callHandlers",new Map),c(this,"activeSpeakerLoopInterval",void 0),c(this,"retryCallLoopInterval",void 0),c(this,"retryCallCounts",new Map),c(this,"reEmitter",void 0),c(this,"transmitTimer",null),c(this,"participantsExpirationTimer",null),c(this,"resendMemberStateTimer",null),c(this,"initWithAudioMuted",!1),c(this,"initWithVideoMuted",!1),c(this,"initCallFeedPromise",void 0),c(this,"_livekitServiceURL",void 0),c(this,"stats",void 0),c(this,"statsCollectIntervalTime",0),c(this,"onConnectionStats",f=>{this.emit(yn.ConnectionStats,{report:f})}),c(this,"onByteSentStats",f=>{this.emit(yn.ByteSentStats,{report:f})}),c(this,"onSummaryStats",f=>{Qc.extendSummaryReport(f,this.participants),this.emit(yn.SummaryStats,{report:f})}),c(this,"onCallFeedReport",f=>{this.localCallFeed&&(f=Er.expandCallFeedReport(f,[this.localCallFeed],"from-local-feed"));var g=[];this.forEachCall(T=>{T.callId===f.callId&&T.getFeeds().forEach(R=>g.push(R))}),f=Er.expandCallFeedReport(f,g,"from-call-feed"),this.emit(yn.CallFeedStats,{report:f})}),c(this,"_state",Ve.LocalCallFeedUninitialized),c(this,"_participants",new Map),c(this,"_creationTs",null),c(this,"_enteredViaAnotherSession",!1),c(this,"onIncomingCall",f=>{var g,T;if(f.roomId===this.room.roomId){if(f.state!==ge.Ringing){O.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"));return}if(!f.groupCallId||f.groupCallId!==this.groupCallId){O.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),f.reject();return}var R=(g=f.getOpponentMember())===null||g===void 0?void 0:g.userId;if(R===void 0){O.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"));return}if(this.useLivekit){O.info("Received incoming call whilst in signaling-only mode! Ignoring.");return}var S=(T=this.calls.get(R))!==null&&T!==void 0?T:new Map,I=S.get(f.getOpponentDeviceId());if(I?.callId!==f.callId){O.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(R,", callId=").concat(f.callId,")")),I&&I.hangup(Ee.Replaced,!1),S.set(f.getOpponentDeviceId(),f),this.calls.set(R,S),this.initCall(f);var b=this.getLocalFeeds().map(p=>p.clone());if(!this.callExpected(f))for(var w of b)Ze(w.stream.getAudioTracks(),!1),Ze(w.stream.getVideoTracks(),!1);f.answerWithCallFeeds(b),this.emit(Le.CallsChanged,this.calls)}}}),c(this,"onRetryCallLoop",()=>{var f=!1;for(var[{userId:g},T]of this.participants){var R=this.calls.get(g),S=this.retryCallCounts.get(g);for(var[I,b]of T){var w,p,E=R?.get(I),y=(w=(p=S)===null||p===void 0?void 0:p.get(I))!==null&&w!==void 0?w:0;E?.getOpponentSessionId()!==b.sessionId&&this.wantsOutgoingCall(g,I)&&y<3&&(S===void 0&&(S=new Map,this.retryCallCounts.set(g,S)),S.set(I,y+1),f=!0)}}f&&this.placeOutgoingCalls()}),c(this,"onCallFeedsChanged",f=>{var g=ca(f),T=f.getOpponentDeviceId();if(!g)throw new Error("Cannot change call feeds without user id");var R=this.getUserMediaFeed(g,T),S=f.remoteUsermediaFeed,I=S!==R,b=this.calls.get(g),w=b?.get(T);if(w?.callId===f.callId){I&&(!R&&S?this.addUserMediaFeed(S):R&&S?this.replaceUserMediaFeed(R,S):R&&!S&&this.removeUserMediaFeed(R));var p=this.getScreenshareFeed(g,T),E=f.remoteScreensharingFeed,y=E!==p;y&&(!p&&E?this.addScreenshareFeed(E):p&&E?this.replaceScreenshareFeed(p,E):p&&!E&&this.removeScreenshareFeed(p))}}),c(this,"onCallStateChanged",(f,g,T)=>{var R;if(g!==ge.Ended){var S=this.localCallFeed.isAudioMuted();f.localUsermediaStream&&f.isMicrophoneMuted()!==S&&f.setMicrophoneMuted(S);var I=this.localCallFeed.isVideoMuted();f.localUsermediaStream&&f.isLocalVideoMuted()!==I&&f.setLocalVideoMuted(I);var b=(R=f.getOpponentMember())===null||R===void 0?void 0:R.userId;if(g===ge.Connected&&b){var w=this.retryCallCounts.get(b);w?.delete(f.getOpponentDeviceId()),w?.size===0&&this.retryCallCounts.delete(b)}}}),c(this,"onCallHangup",f=>{var g,T;if(f.hangupReason!==Ee.Replaced){var R=(g=(T=f.getOpponentMember())===null||T===void 0?void 0:T.userId)!==null&&g!==void 0?g:this.room.getMember(f.invitee).userId,S=this.calls.get(R);S?.get(f.getOpponentDeviceId())===f&&(this.disposeCall(f,f.hangupReason),S.delete(f.getOpponentDeviceId()),S.size===0&&this.calls.delete(R),this.emit(Le.CallsChanged,this.calls))}}),c(this,"onCallReplaced",(f,g)=>{var T=f.getOpponentMember().userId,R=this.calls.get(T);R===void 0&&(R=new Map,this.calls.set(T,R)),f.hangup(Ee.Replaced,!1),this.initCall(g),R.set(f.getOpponentDeviceId(),g),this.emit(Le.CallsChanged,this.calls)}),c(this,"onActiveSpeakerLoop",()=>{var f=void 0,g=void 0;for(var T of this.userMediaFeeds)if(!(T.isLocal()&&this.userMediaFeeds.length>1)){var R=T.speakingVolumeSamples.reduce((I,b)=>I+Math.max(b,co)),S=R/T.speakingVolumeSamples.length;(!f||S>f)&&(f=S,g=T)}g&&this.activeSpeaker!==g&&f&&f>co&&(this.activeSpeaker=g,this.emit(Le.ActiveSpeakerChanged,this.activeSpeaker))}),c(this,"onRoomState",()=>this.updateParticipants()),c(this,"onParticipantsChanged",()=>{this.forEachCall(f=>{var g=this.callExpected(f);for(var T of f.getLocalFeeds())Ze(T.stream.getAudioTracks(),!T.isAudioMuted()&&g),Ze(T.stream.getVideoTracks(),!T.isVideoMuted()&&g)}),this.state===Ve.Entered&&!this.useLivekit&&this.placeOutgoingCalls()}),c(this,"onStateChanged",(f,g)=>{(f===Ve.Entered||g===Ve.Entered||f===Ve.Ended)&&(this.updateParticipants(),this.updateMemberState().catch(T=>O.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),T)))}),c(this,"onLocalFeedsChanged",()=>{this.state===Ve.Entered&&this.updateMemberState().catch(f=>O.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),f))}),this.reEmitter=new Ic(this),this.groupCallId=s??Wr(),this._livekitServiceURL=m,this.creationTs=(u=(h=t.currentState.getStateEvents(F.GroupCallPrefix,this.groupCallId))===null||h===void 0?void 0:h.getTs())!==null&&u!==void 0?u:null,this.updateParticipants(),t.on(we.Update,this.onRoomState),this.on(Le.ParticipantsChanged,this.onParticipantsChanged),this.on(Le.GroupCallStateChanged,this.onStateChanged),this.on(Le.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!l}create(){var e=this;return _(function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(vo.Outgoing,e),yield e.sendCallStateEvent(),e})()}sendCallStateEvent(){var e=this;return _(function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,F.GroupCallPrefix,t,e.groupCallId)})()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(Le.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,r=(a,s)=>a.sessionId===s.sessionId&&a.screensharing===s.screensharing,n=(a,s)=>Ql(a,s,r);Ql(e,t,n)||(this._participants=e,this.emit(Le.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var r of t.values())e(r)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return(e=(t=this.participants.get(this.room.getMember(this.client.getUserId())))===null||t===void 0?void 0:t.has(this.client.getDeviceId()))!==null&&e!==void 0?e:!1}callExpected(e){var t,r=ca(e),n=r===null?null:this.room.getMember(r),a=e.getOpponentDeviceId();return n!==null&&a!==void 0&&((t=this.participants.get(n))===null||t===void 0?void 0:t.get(a))!==void 0}initLocalCallFeed(){var e=this;return _(function*(){if(e.useLivekit){O.info("Livekit group call: not starting local call feed.");return}if(e.state!==Ve.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=Ve.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}})()}initLocalCallFeedInternal(){var e=this;return _(function*(){O.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));var t;try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===Yi.Video)}catch(n){if(e.allowCallWithoutVideoAndAudio)t=new MediaStream;else throw e.state=Ve.LocalCallFeedUninitialized,n}if(e._state!==Ve.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var r=new ir({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:Ne.Usermedia,audioMuted:e.initWithAudioMuted||t.getAudioTracks().length===0||e.isPtt,videoMuted:e.initWithVideoMuted||t.getVideoTracks().length===0});Ze(t.getAudioTracks(),!r.isAudioMuted()),Ze(t.getVideoTracks(),!r.isVideoMuted()),e.localCallFeed=r,e.addUserMediaFeed(r),e.state=Ve.LocalCallFeedInitialized})()}updateLocalUsermediaStream(e){var t=this;return _(function*(){if(t.localCallFeed){var r=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var n=t.localCallFeed.isAudioMuted(),a=t.localCallFeed.isVideoMuted();O.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(r.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(n,", vidShouldBeMuted=").concat(a,")")),Ze(e.getAudioTracks(),!n),Ze(e.getVideoTracks(),!a),t.client.getMediaHandler().stopUserMediaStream(r)}})()}enter(){var e=this;return _(function*(){if(e.state===Ve.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==Ve.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));O.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=Ve.Entered,e.client.on(ho.Incoming,e.onIncomingCall);for(var t of e.client.callEventHandler.calls.values())e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))})()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),this.transmitTimer!==null&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),this.retryCallLoopInterval!==void 0&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===Ve.Entered&&(this.forEachCall(t=>t.hangup(Ee.UserHangup,!1)),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(ho.Incoming,this.onIncomingCall),(e=this.stats)===null||e===void 0||e.stop())}leave(){this.dispose(),this.state=Ve.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return _(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:!0;if(t.dispose(),t.room.off(we.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(vo.Ended,t),t.state=Ve.Ended,r){var n=t.room.currentState.getStateEvents(F.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,F.GroupCallPrefix,ua(ua({},n.getContent()),{},{"m.terminated":mp.CallEnded}),t.groupCallId)}})()}isLocalVideoMuted(){return this.localCallFeed?this.localCallFeed.isVideoMuted():!0}isMicrophoneMuted(){return this.localCallFeed?this.localCallFeed.isAudioMuted():!0}setMicrophoneMuted(e){var t=this;return _(function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var r=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout(()=>{t.setMicrophoneMuted(!0)},t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(t.transmitTimer!==null&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall(s=>{var o;return(o=s.localUsermediaFeed)===null||o===void 0?void 0:o.setAudioVideoMuted(e,null)});var n=(function(){var s=_(function*(){var o=[];t.forEachCall(d=>o.push(d.sendMetadataUpdate())),yield Promise.all(o).catch(d=>O.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),d))});return function(){return s.apply(this,arguments)}})();if(r&&(yield n()),t.localCallFeed){O.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var a=yield t.checkAudioPermissionIfNecessary(e);if(!a)return!1;t.localCallFeed.setAudioVideoMuted(e,null),Ze(t.localCallFeed.stream.getAudioTracks(),!e)}else O.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall(s=>Ze(s.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(s))),t.emit(Le.LocalMuteStateChanged,e,t.isLocalVideoMuted()),r||(yield n()),!0})()}checkAudioPermissionIfNecessary(e){var t=this;return _(function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if(r?.getTracks().length===0)return O.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch{return O.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0})()}setLocalVideoMuted(e){var t=this;return _(function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){O.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(r),t.localCallFeed.setAudioVideoMuted(null,e),Ze(t.localCallFeed.stream.getVideoTracks(),!e)}catch{return O.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else O.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var n=[];return t.forEachCall(a=>n.push(a.setLocalVideoMuted(e))),yield Promise.all(n),t.forEachCall(a=>Ze(a.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(a))),t.emit(Le.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0})()}setScreensharingEnabled(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};if(e===r.isScreensharing())return e;if(e)try{O.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var a=yield r.client.getMediaHandler().getScreensharingStream(n),s=function*(l){var u=()=>{r.setScreensharingEnabled(!1),l.removeEventListener("ended",u)};l.addEventListener("ended",u)};for(var o of a.getTracks())yield*s(o);return O.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),r.localDesktopCapturerSourceId=n.desktopCapturerSourceId,r.localScreenshareFeed=new ir({client:r.client,roomId:r.room.roomId,userId:r.client.getUserId(),deviceId:r.client.getDeviceId(),stream:a,purpose:Ne.Screenshare,audioMuted:!1,videoMuted:!1}),r.addScreenshareFeed(r.localScreenshareFeed),r.emit(Le.LocalScreenshareStateChanged,!0,r.localScreenshareFeed,r.localDesktopCapturerSourceId),r.forEachCall(d=>d.pushLocalFeed(r.localScreenshareFeed.clone())),!0}catch(d){if(n.throwOnFail)throw d;return O.error("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() enabling screensharing error"),d),r.emit(Le.Error,new fo(Ii.NoUserMedia,"Failed to get screen-sharing stream: ",d)),!1}else return r.forEachCall(d=>{d.localScreensharingFeed&&d.removeLocalFeed(d.localScreensharingFeed)}),r.client.getMediaHandler().stopScreensharingStream(r.localScreenshareFeed.stream),r.removeScreenshareFeed(r.localScreenshareFeed),r.localScreenshareFeed=void 0,r.localDesktopCapturerSourceId=void 0,r.emit(Le.LocalScreenshareStateChanged,!1,void 0,void 0),!1})()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var r=this.client.getUserId(),n=this.client.getDeviceId();return e>=r&&(e!==r||t>n)}placeOutgoingCalls(){var e=this,t=!1,r=function(o){var d,l=(d=e.calls.get(o))!==null&&d!==void 0?d:new Map,u=function(f){var g=l.get(f);if(g?.getOpponentSessionId()!==v.sessionId&&e.wantsOutgoingCall(o,f)){t=!0,g!==void 0&&(O.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(o,", deviceId=").concat(f,", callId=").concat(g.callId,")")),g.hangup(Ee.NewSession,!1));var T=kn(e.client,e.room.roomId,{invitee:o,opponentDeviceId:f,opponentSessionId:v.sessionId,groupCallId:e.groupCallId});T===null?(O.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(o,", device=").concat(f,")")),l.delete(f)):(e.initCall(T),l.set(f,T),O.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(o,", deviceId=").concat(f,", sessionId=").concat(v.sessionId,")")),T.placeCallWithCallFeeds(e.getLocalFeeds().map(R=>R.clone()),v.screensharing).then(()=>{e.dataChannelsEnabled&&T.createDataChannel("datachannel",e.dataChannelOptions)}).catch(R=>{O.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(o,")"),R),R instanceof rr&&R.code===Ii.UnknownDevice?e.emit(Le.Error,R):e.emit(Le.Error,new fo(Ii.PlaceCallFailed,"Failed to place call to ".concat(o))),T.hangup(Ee.SignallingFailed,!1),l.get(f)===T&&l.delete(f)}))}};for(var[h,v]of a)u(h);l.size>0?e.calls.set(o,l):e.calls.delete(o)};for(var[{userId:n},a]of this.participants)r(n);t&&this.emit(Le.CallsChanged,this.calls)}getMemberStateEvents(e){return e===void 0?this.room.currentState.getStateEvents(F.GroupCallMemberPrefix):this.room.currentState.getStateEvents(F.GroupCallMemberPrefix,e)}initCall(e){var t=ca(e);if(!t)throw new Error("Cannot init call without user id");var r=()=>this.onCallFeedsChanged(e),n=(d,l)=>this.onCallStateChanged(e,d,l),a=this.onCallHangup,s=d=>this.onCallReplaced(e,d),o=this.callHandlers.get(t);o===void 0&&(o=new Map,this.callHandlers.set(t,o)),o.set(e.getOpponentDeviceId(),{onCallFeedsChanged:r,onCallStateChanged:n,onCallHangup:a,onCallReplaced:s}),e.on(_e.FeedsChanged,r),e.on(_e.State,n),e.on(_e.Hangup,a),e.on(_e.Replaced,s),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(_e)),e.initStats(this.getGroupCallStats()),r()}disposeCall(e,t){var r=ca(e),n=e.getOpponentDeviceId();if(!r)throw new Error("Cannot dispose call without user id");var a=this.callHandlers.get(r),{onCallFeedsChanged:s,onCallStateChanged:o,onCallHangup:d,onCallReplaced:l}=a.get(n);if(e.removeListener(_e.FeedsChanged,s),e.removeListener(_e.State,o),e.removeListener(_e.Hangup,d),e.removeListener(_e.Replaced,l),a.delete(r),a.size===0&&this.callHandlers.delete(r),e.hangupReason!==Ee.Replaced){var u=this.getUserMediaFeed(r,n);u&&this.removeUserMediaFeed(u);var h=this.getScreenshareFeed(r,n);h&&this.removeScreenshareFeed(h)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find(r=>r.userId===e&&r.deviceId===t)}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(Le.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var r=this.userMediaFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(r===-1)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(r,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(Le.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(Le.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(Le.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find(r=>r.userId===e&&r.deviceId===t)}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(Le.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var r=this.screenshareFeeds.findIndex(n=>n.userId===e.userId&&n.deviceId===e.deviceId);if(r===-1)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(r,1,t),e.dispose(),this.emit(Le.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex(r=>r.userId===e.userId&&r.deviceId===e.deviceId);if(t===-1)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(Le.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(!e){O.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"));return}if(this.participantsExpirationTimer!==null&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===Ve.Ended){this.participants=new Map;return}var t=new Map,r=Date.now(),n=this.state===Ve.Entered||this.enteredViaAnotherSession,a=1/0;for(var s of this.getMemberStateEvents()){var o=this.room.getMember(s.getStateKey()),d=s.getContent(),l=Array.isArray(d["m.calls"])?d["m.calls"]:[],u=l.find(T=>T["m.call_id"]===this.groupCallId),h=Array.isArray(u?.["m.devices"])?u["m.devices"]:[],v=h.filter(T=>typeof T.device_id=="string"&&typeof T.session_id=="string"&&typeof T.expires_ts=="number"&&T.expires_ts>r&&Array.isArray(T.feeds));if(!n&&o?.userId===this.client.getUserId()&&(v=v.filter(T=>T.device_id!==this.client.getDeviceId())),v.length>0&&o?.membership===Se.Join){var m=new Map;t.set(o,m);for(var f of v)m.set(f.device_id,{sessionId:f.session_id,screensharing:f.feeds.some(T=>T.purpose===Ne.Screenshare)}),f.expires_ts<a&&(a=f.expires_ts)}}if(n){var g=t.get(e);g===void 0&&(g=new Map,t.set(e,g)),g.has(this.client.getDeviceId())||g.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some(T=>T.purpose===Ne.Screenshare)})}this.participants=t,a<1/0&&(this.participantsExpirationTimer=setTimeout(()=>this.updateParticipants(),a-r))}updateDevices(e){var t=arguments,r=this;return _(function*(){var n,a=t.length>1&&t[1]!==void 0?t[1]:!1,s=Date.now(),o=r.client.getUserId(),d=r.getMemberStateEvents(o),l=(n=d?.getContent())!==null&&n!==void 0?n:{},u=Array.isArray(l["m.calls"])?l["m.calls"]:[],h=null,v=[];for(var m of u)m["m.call_id"]===r.groupCallId?h=m:v.push(m);h===null&&(h={});var f=Array.isArray(h["m.devices"])?h["m.devices"]:[],g=f.filter(I=>typeof I.device_id=="string"&&typeof I.session_id=="string"&&typeof I.expires_ts=="number"&&I.expires_ts>s&&Array.isArray(I.feeds)),T=e(g);if(T!==null){var R=[...v];T.length>0&&R.push(ua(ua({},h),{},{"m.call_id":r.groupCallId,"m.devices":T}));var S={"m.calls":R};yield r.client.sendStateEvent(r.room.roomId,F.GroupCallMemberPrefix,S,o,{keepAlive:a})}})()}addDeviceToMemberState(){var e=this;return _(function*(){yield e.updateDevices(t=>[...t.filter(r=>r.device_id!==e.client.getDeviceId()),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+Jd,feeds:e.getLocalFeeds().map(r=>({purpose:r.purpose}))}])})()}updateMemberState(){var e=this;return _(function*(){e.resendMemberStateTimer!==null&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===Ve.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval(_(function*(){O.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){O.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}}),Jd*3/4)):yield e.updateDevices(t=>t.filter(r=>r.device_id!==e.client.getDeviceId()),!0)})()}cleanMemberState(){var e=this;return _(function*(){var{devices:t}=yield e.client.getDevices(),r=new Map(t.map(n=>[n.device_id,n]));yield e.updateDevices(n=>{var a=n.filter(s=>{var o=r.get(s.device_id);return o?.last_seen_ts!==void 0&&!(s.device_id===e.client.getDeviceId()&&e.state!==Ve.Entered&&!e.enteredViaAnotherSession)});return a.length===n.length?null:a})})()}getGroupCallStats(){if(this.stats===void 0){var e=this.client.getUserId()||"unknown";this.stats=new pp(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(zt.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(zt.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(zt.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(zt.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,this.stats!==void 0&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}function zd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ha(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?zd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):zd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var ge=(function(i){return i.Fledgling="fledgling",i.InviteSent="invite_sent",i.WaitLocalMedia="wait_local_media",i.CreateOffer="create_offer",i.CreateAnswer="create_answer",i.Connecting="connecting",i.Connected="connected",i.Ringing="ringing",i.Ended="ended",i})({}),Yd=(function(i){return i.Voice="voice",i.Video="video",i})({}),fr=(function(i){return i.Inbound="inbound",i.Outbound="outbound",i})({}),ze=(function(i){return i.Local="local",i.Remote="remote",i})({}),_e=(function(i){return i.Hangup="hangup",i.State="state",i.Error="error",i.Replaced="replaced",i.LocalHoldUnhold="local_hold_unhold",i.RemoteHoldUnhold="remote_hold_unhold",i.HoldUnhold="hold_unhold",i.FeedsChanged="feeds_changed",i.AssertedIdentityChanged="asserted_identity_changed",i.LengthChanged="length_changed",i.DataChannel="datachannel",i.SendVoipEvent="send_voip_event",i.PeerConnectionCreated="peer_connection_created",i})({}),Ee=(function(i){return i.UserHangup="user_hangup",i.LocalOfferFailed="local_offer_failed",i.NoUserMedia="no_user_media",i.UnknownDevices="unknown_devices",i.SendInvite="send_invite",i.CreateAnswer="create_answer",i.CreateOffer="create_offer",i.SendAnswer="send_answer",i.SetRemoteDescription="set_remote_description",i.SetLocalDescription="set_local_description",i.AnsweredElsewhere="answered_elsewhere",i.IceFailed="ice_failed",i.InviteTimeout="invite_timeout",i.Replaced="replaced",i.SignallingFailed="signalling_timeout",i.UserBusy="user_busy",i.Transferred="transferred",i.NewSession="new_session",i})({}),gp="1",yp="stun:turn.matrix.org",xs=60*1e3,Sp=1e3,bp=30*1e3,Ep=2*1e3;class rr extends Error{constructor(e,t,r){super(t+": "+r),c(this,"code",void 0),this.code=e}}function Wr(){return Date.now().toString()+wr(16)}function Xd(i){var e=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:i?12e3:void 0}];return e}function Lt(i,e){return i+":"+e}class _p extends Ke{constructor(e){var t,r;if(super(),t=this,c(this,"roomId",void 0),c(this,"callId",void 0),c(this,"invitee",void 0),c(this,"hangupParty",void 0),c(this,"hangupReason",void 0),c(this,"direction",void 0),c(this,"ourPartyId",void 0),c(this,"peerConn",void 0),c(this,"toDeviceSeq",0),c(this,"isPtt",!1),c(this,"_state",ge.Fledgling),c(this,"client",void 0),c(this,"forceTURN",void 0),c(this,"turnServers",void 0),c(this,"candidateSendQueue",[]),c(this,"candidateSendTries",0),c(this,"candidatesEnded",!1),c(this,"feeds",[]),c(this,"transceivers",new Map),c(this,"inviteOrAnswerSent",!1),c(this,"waitForLocalAVStream",!1),c(this,"successor",void 0),c(this,"opponentMember",void 0),c(this,"opponentVersion",void 0),c(this,"opponentPartyId",void 0),c(this,"opponentCaps",void 0),c(this,"iceDisconnectedTimeout",void 0),c(this,"iceReconnectionTimeOut",void 0),c(this,"inviteTimeout",void 0),c(this,"removeTrackListeners",new Map),c(this,"remoteOnHold",!1),c(this,"callStatsAtEnd",void 0),c(this,"makingOffer",!1),c(this,"ignoreOffer",!1),c(this,"isSettingRemoteAnswerPending",!1),c(this,"responsePromiseChain",void 0),c(this,"remoteCandidateBuffer",new Map),c(this,"remoteAssertedIdentity",void 0),c(this,"remoteSDPStreamMetadata",void 0),c(this,"callLengthInterval",void 0),c(this,"callStartTime",void 0),c(this,"opponentDeviceId",void 0),c(this,"hasOpponentDeviceInfo",void 0),c(this,"opponentSessionId",void 0),c(this,"groupCallId",void 0),c(this,"stopVideoTrackTimer",void 0),c(this,"isOnlyDataChannelAllowed",void 0),c(this,"stats",void 0),c(this,"gotLocalIceCandidate",a=>{if(a.candidate){if(this.candidatesEnded&&O.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),O.debug("Call ".concat(this.callId," got local ICE ").concat(a.candidate.sdpMid," ").concat(a.candidate.candidate)),this.callHasEnded())return;a.candidate.candidate===""?this.queueCandidate(null):this.queueCandidate(a.candidate)}}),c(this,"onIceGatheringStateChange",a=>{var s;O.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),((s=this.peerConn)===null||s===void 0?void 0:s.iceGatheringState)==="complete"&&(this.queueCandidate(null),O.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))}),c(this,"getLocalOfferFailed",a=>{O.error("Call ".concat(this.callId," getLocalOfferFailed() running"),a),this.emit(_e.Error,new rr(Ee.LocalOfferFailed,"Failed to get local offer!",a),this),this.terminate(ze.Local,Ee.LocalOfferFailed,!1)}),c(this,"getUserMediaFailed",a=>{if(this.successor){this.successor.getUserMediaFailed(a);return}O.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),a),this.emit(_e.Error,new rr(Ee.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",a),this),this.terminate(ze.Local,Ee.NoUserMedia,!1)}),c(this,"placeCallFailed",a=>{if(this.successor){this.successor.placeCallFailed(a);return}O.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),a),this.emit(_e.Error,new rr(Ee.IceFailed,"Couldn't start call! Invalid ICE server configuration.",a),this),this.terminate(ze.Local,Ee.IceFailed,!1)}),c(this,"onIceConnectionStateChanged",()=>{var a,s,o,d,l,u;if(!this.callHasEnded()){if(O.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.iceConnectionState,", conn=").concat((s=this.peerConn)===null||s===void 0?void 0:s.connectionState,")")),["connected","completed"].includes((o=(d=this.peerConn)===null||d===void 0?void 0:d.iceConnectionState)!==null&&o!==void 0?o:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=ge.Connected,!this.callLengthInterval&&!this.callStartTime&&(this.callStartTime=Date.now(),this.callLengthInterval=setInterval(()=>{this.emit(_e.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)},Sp));else if(((l=this.peerConn)===null||l===void 0?void 0:l.iceConnectionState)=="failed"){var h;if(this.candidatesEnded=!1,(h=this.peerConn)!==null&&h!==void 0&&h.restartIce){var v;this.candidatesEnded=!1,O.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat((v=this.peerConn)===null||v===void 0?void 0:v.iceConnectionState,")")),this.peerConn.restartIce()}else O.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(Ee.IceFailed,!1)}else((u=this.peerConn)===null||u===void 0?void 0:u.iceConnectionState)=="disconnected"&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout(()=>{var f,g,T;O.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat((f=this.peerConn)===null||f===void 0?void 0:f.iceConnectionState,", conn=").concat((g=this.peerConn)===null||g===void 0?void 0:g.connectionState,")")),(T=this.peerConn)!==null&&T!==void 0&&T.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0},Ep),this.iceDisconnectedTimeout=setTimeout(()=>{O.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(Ee.IceFailed,!1)},bp),this.state=ge.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var m of this.getRemoteFeeds())m.setAudioVideoMuted(!0,!0)}}),c(this,"onSignallingStateChanged",()=>{var a;O.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat((a=this.peerConn)===null||a===void 0?void 0:a.signalingState,")"))}),c(this,"onTrack",a=>{if(a.streams.length===0){O.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(a.track.kind,")"));return}var s=a.streams[0];if(this.pushRemoteFeed(s),!this.removeTrackListeners.has(s)){var o=()=>{s.getTracks().length===0&&(O.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(s.id,")")),this.deleteFeedByStream(s),s.removeEventListener("removetrack",o),this.removeTrackListeners.delete(s))};s.addEventListener("removetrack",o),this.removeTrackListeners.set(s,o)}}),c(this,"onDataChannel",a=>{this.emit(_e.DataChannel,a.channel,this)}),c(this,"onNegotiationNeeded",_(function*(){if(O.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state!==ge.CreateOffer&&t.opponentVersion===0){O.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"));return}t.queueGotLocalOffer()})),c(this,"onHangupReceived",a=>{O.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(a)||this.state===ge.Ringing?this.terminate(ze.Remote,a.reason||Ee.UserHangup,!0):O.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(a.party_id,": our partner is ").concat(this.opponentPartyId))}),c(this,"onRejectReceived",a=>{O.debug("Call ".concat(this.callId," onRejectReceived() running"));var s=[ge.InviteSent,ge.Ringing].includes(this.state)||this.state===ge.Fledgling&&this.direction===fr.Inbound;s?this.terminate(ze.Remote,a.reason||Ee.UserHangup,!0):O.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))}),c(this,"onAnsweredElsewhere",a=>{O.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(ze.Remote,Ee.AnsweredElsewhere,!0)}),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");this.forceTURN=(r=e.forceTURN)!==null&&r!==void 0?r:!1,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],this.turnServers.length===0&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[yp]});for(var n of this.turnServers)dc(n,["urls"]);this.callId=Wr(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return _(function*(){yield e.placeCall(!0,!1)})()}placeVideoCall(){var e=this;return _(function*(){yield e.placeCall(!0,!0)})()}createDataChannel(e,t){var r=this.peerConn.createDataChannel(e,t);return this.emit(_e.DataChannel,r,this),r}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return!!(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return!!(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(_e.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?Yd.Video:Yd.Voice}get hasLocalUserMediaVideoTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Ne.Usermedia&&((t=e.stream)===null||t===void 0?void 0:t.getVideoTracks().length)})}get hasLocalUserMediaAudioTrack(){var e;return!!((e=this.localUsermediaStream)!==null&&e!==void 0&&e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some(e=>{var t;return e.purpose===Ne.Usermedia&&!!((t=e.stream)!==null&&t!==void 0&&t.getAudioTracks().length)})}get hasUserMediaAudioSender(){var e;return!!(!((e=this.transceivers.get(Lt(Ne.Usermedia,"audio")))===null||e===void 0)&&e.sender)}get hasUserMediaVideoSender(){var e;return!!(!((e=this.transceivers.get(Lt(Ne.Usermedia,"video")))===null||e===void 0)&&e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find(e=>e.purpose===Ne.Usermedia)}get localScreensharingFeed(){return this.getLocalFeeds().find(e=>e.purpose===Ne.Screenshare)}get localUsermediaStream(){var e;return(e=this.localUsermediaFeed)===null||e===void 0?void 0:e.stream}get localScreensharingStream(){var e;return(e=this.localScreensharingFeed)===null||e===void 0?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Ne.Usermedia)}get remoteScreensharingFeed(){return this.getRemoteFeeds().find(e=>e.purpose===Ne.Screenshare)}get remoteUsermediaStream(){var e;return(e=this.remoteUsermediaFeed)===null||e===void 0?void 0:e.stream}get remoteScreensharingStream(){var e;return(e=this.remoteScreensharingFeed)===null||e===void 0?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find(t=>t.stream.id===e)}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter(e=>e.isLocal())}getRemoteFeeds(){return this.feeds.filter(e=>!e.isLocal())}initOpponentCrypto(){var e=this;return _(function*(){var t;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall()){if(!e.client.getCrypto()){e.hasOpponentDeviceInfo=!0;return}var r=e.invitee||((t=e.getOpponentMember())===null||t===void 0?void 0:t.userId);throw r?(e.hasOpponentDeviceInfo=!1,new Zc(r)):new Error("Couldn't find opponent user ID to init crypto")}})()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={};for(var r of this.getLocalFeeds())e&&(r.sdpMetadataStreamId=r.stream.id),t[r.sdpMetadataStreamId]={purpose:r.purpose,audio_muted:r.isAudioMuted(),video_muted:r.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some(e=>!e.isLocal())}pushRemoteFeed(e){if(!this.opponentSupportsSDPStreamMetadata()){this.pushRemoteFeedWithoutMetadata(e);return}var t=this.getOpponentMember().userId,r=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,a=this.remoteSDPStreamMetadata[e.id].video_muted;if(!r){O.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){O.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new ir({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r,audioMuted:n,videoMuted:a})),this.emit(_e.FeedsChanged,this.feeds,this),O.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(r,")"))}pushRemoteFeedWithoutMetadata(e){var t,r=this.getOpponentMember().userId,n=Ne.Usermedia,a=(t=this.feeds.find(s=>!s.isLocal()))===null||t===void 0?void 0:t.stream;if(a&&e.id!==a.id){O.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")"));return}if(this.getFeedByStreamId(e.id)){O.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.feeds.push(new ir({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(_e.FeedsChanged,this.feeds,this),O.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")"))}pushNewLocalFeed(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,n=this.client.getUserId();if(Ze(e.getAudioTracks(),!0),Ze(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)){O.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")"));return}this.pushLocalFeed(new ir({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),r)}pushLocalFeed(e){var t=this,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(this.feeds.some(s=>e.stream.id===s.stream.id)){O.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));return}if(this.feeds.push(e),r){var n=function(){O.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(a.id,", kind=").concat(a.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(a.enabled,")"));var o=Lt(e.purpose,a.kind);if(t.transceivers.has(o)){var d=t.transceivers.get(o);d.sender.replaceTrack(a),d.direction=d.direction==="inactive"?"sendonly":"sendrecv"}else{var l=t.peerConn.addTrack(a,e.stream),u=t.peerConn.getTransceivers().find(h=>h.sender===l);u?t.transceivers.set(o,u):O.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var a of e.stream.getTracks())n()}O.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(_e.FeedsChanged,this.feeds,this)}removeLocalFeed(e){var t=Lt(e.purpose,"audio"),r=Lt(e.purpose,"video");for(var n of[t,r])if(this.transceivers.has(n)){var a=this.transceivers.get(n);a.sender&&this.peerConn.removeTrack(a.sender)}e.purpose===Ne.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)(!e.isLocal()||!this.groupCallId)&&e.dispose();this.feeds=[],this.emit(_e.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);if(!t){O.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"));return}this.deleteFeed(t)}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(_e.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return _(function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()})()}collectCallStats(){var e=this;return _(function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),r=[];return t.forEach(n=>{r.push(n)}),r}})()}initWithInvite(e){var t=this;return _(function*(){var r,n=e.getContent();t.direction=fr.Inbound;var a=yield t.client.checkTurnServers();a||O.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var s=n[hr];s?t.updateRemoteSDPStreamMetadata(s):O.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(_e.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(n.offer),O.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(n.offer.type)),yield t.addBufferedIceCandidates()}catch(u){O.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),u),t.terminate(ze.Local,Ee.SetRemoteDescription,!1);return}var o=(r=t.feeds.find(u=>!u.isLocal()))===null||r===void 0?void 0:r.stream;if(!t.isOnlyDataChannelAllowed&&(!o||o.getTracks().length===0)){O.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),t.terminate(ze.Local,Ee.SetRemoteDescription,!1);return}if(t.state=ge.Ringing,e.getLocalAge()){var d=setTimeout(()=>{if(t.state==ge.Ringing){var u;O.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=ze.Remote,t.state=ge.Ended,t.stopAllMedia(),t.peerConn.signalingState!="closed"&&t.peerConn.close(),(u=t.stats)===null||u===void 0||u.removeStatsReportGatherer(t.callId),t.emit(_e.Hangup,t)}},n.lifetime-e.getLocalAge()),l=u=>{u!==ge.Ringing&&(clearTimeout(d),t.off(_e.State,l))};t.on(_e.State,l)}})()}initWithHangup(e){this.state=ge.Ended}shouldAnswerWithMediaType(e,t,r){return e&&!t?(O.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r," because the other side isn't sending it either.")),!1):!hc(e)&&e!==t&&!this.opponentSupportsSDPStreamMetadata()?(O.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r,"=").concat(e," because the other side doesn't support it. Answering with ").concat(r,"=").concat(t,".")),t):e??t}answer(e,t){var r=this;return _(function*(){if(!r.inviteOrAnswerSent){if(e===!1&&t===!1)throw new Error("You CANNOT answer a call without media");if(!r.localUsermediaStream&&!r.waitForLocalAVStream){var n=r.state,a=r.shouldAnswerWithMediaType(e,r.hasRemoteUserMediaAudioTrack,"audio"),s=r.shouldAnswerWithMediaType(t,r.hasRemoteUserMediaVideoTrack,"video");r.state=ge.WaitLocalMedia,r.waitForLocalAVStream=!0;try{var o,d=yield r.client.getMediaHandler().getUserMediaStream(a,s);r.waitForLocalAVStream=!1;var l=new ir({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:(o=r.client.getDeviceId())!==null&&o!==void 0?o:void 0,stream:d,purpose:Ne.Usermedia,audioMuted:!1,videoMuted:!1}),u=[l];r.localScreensharingFeed&&u.push(r.localScreensharingFeed),r.answerWithCallFeeds(u)}catch(h){if(s)O.warn("Call ".concat(r.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),r.state=n,r.waitForLocalAVStream=!1,yield r.answer(a,!1);else{r.getUserMediaFailed(h);return}}}else r.waitForLocalAVStream&&(r.state=ge.WaitLocalMedia)}})()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){O.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===ge.WaitLocalMedia?(O.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[ge.CreateOffer,ge.InviteSent].includes(this.state)&&(e.direction===fr.Outbound?e.queueGotCallFeedsForAnswer([]):(O.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map(t=>t.clone())))),this.successor=e,this.emit(_e.Replaced,e,this),this.hangup(Ee.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(O.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(ze.Local,e,!t),![ge.Fledgling,ge.WaitLocalMedia].includes(this.state))){var r={};(this.opponentVersion&&this.opponentVersion!==0||e!==Ee.UserHangup)&&(r.reason=e),this.sendVoipEvent(F.CallHangup,r)}}reject(){if(this.state!==ge.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion===0){O.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),this.hangup(Ee.UserHangup,!0);return}O.debug("Rejecting call: "+this.callId),this.terminate(ze.Local,Ee.UserHangup,!0),this.sendVoipEvent(F.CallReject,{})}upgradeCall(e,t){var r=this;return _(function*(){if(!(!e&&!t)&&r.opponentSupportsSDPStreamMetadata())try{O.debug("Call ".concat(r.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var n=e||r.hasLocalUserMediaAudioTrack,a=t||r.hasLocalUserMediaVideoTrack,s=yield r.client.getMediaHandler().getUserMediaStream(n,a,!1);yield r.updateLocalUsermediaStream(s,e,t)}catch(o){O.error("Call ".concat(r.callId," upgradeCall() failed to upgrade the call"),o),r.emit(_e.Error,new rr(Ee.NoUserMedia,"Failed to get camera access: ",o),r)}})()}opponentSupportsSDPStreamMetadata(){return!!this.remoteSDPStreamMetadata}isScreensharing(){return!!this.localScreensharingStream}setScreensharingEnabled(e,t){var r=this;return _(function*(){if(e&&r.isScreensharing())return O.warn("Call ".concat(r.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!r.isScreensharing())return O.warn("Call ".concat(r.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!r.opponentSupportsSDPStreamMetadata())return r.setScreensharingEnabledWithoutMetadataSupport(e,t);if(O.debug("Call ".concat(r.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),e)try{var n=yield r.client.getMediaHandler().getScreensharingStream(t);return n?(r.pushNewLocalFeed(n,Ne.Screenshare),!0):!1}catch(d){return O.error("Call ".concat(r.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),d),!1}else{var a=r.transceivers.get(Lt(Ne.Screenshare,"audio")),s=r.transceivers.get(Lt(Ne.Screenshare,"video"));for(var o of[a,s])o&&o.sender&&r.peerConn.removeTrack(o.sender);return r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}})()}setScreensharingEnabledWithoutMetadataSupport(e,t){var r=this;return _(function*(){if(O.debug("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),e)try{var n,a=yield r.client.getMediaHandler().getScreensharingStream(t);if(!a)return!1;var s=a.getTracks().find(v=>v.kind==="video"),o=(n=r.transceivers.get(Lt(Ne.Usermedia,"video")))===null||n===void 0?void 0:n.sender;return o?.replaceTrack(s??null),r.pushNewLocalFeed(a,Ne.Screenshare,!1),!0}catch(v){return O.error("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),v),!1}else{var d,l,u=(d=r.localUsermediaStream)===null||d===void 0?void 0:d.getTracks().find(v=>v.kind==="video"),h=(l=r.transceivers.get(Lt(Ne.Usermedia,"video")))===null||l===void 0?void 0:l.sender;return h?.replaceTrack(u??null),r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}})()}updateLocalUsermediaStream(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1,a=t.length>2&&t[2]!==void 0?t[2]:!1,s=r.localUsermediaFeed,o=n||!s.isAudioMuted()&&!r.remoteOnHold,d=a||!s.isVideoMuted()&&!r.remoteOnHold;O.log("Call ".concat(r.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(o,", video=").concat(d,")")),Ze(e.getAudioTracks(),o),Ze(e.getVideoTracks(),d);for(var l of r.localUsermediaStream.getTracks())r.localUsermediaStream.removeTrack(l),l.stop();for(var u of e.getTracks())r.localUsermediaStream.addTrack(u);var h=function*(){var f=Lt(Ne.Usermedia,v.kind),g=r.transceivers.get(f),T=g?.sender,R=!1;if(T)try{O.info("Call ".concat(r.callId," updateLocalUsermediaStream() replacing track (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")")),yield T.replaceTrack(v),g.direction=g.direction==="inactive"?"sendonly":"sendrecv",R=!0}catch(b){O.warn("Call ".concat(r.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),b)}if(!R){O.info("Call ".concat(r.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(s.purpose,")"));var S=r.peerConn.addTrack(v,r.localUsermediaStream),I=r.peerConn.getTransceivers().find(b=>b.sender===S);I?r.transceivers.set(f,I):O.warn("Call ".concat(r.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var v of e.getTracks())yield*h()})()}setLocalVideoMuted(e){var t=this;return _(function*(){var r;if(O.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),!e&&t.stopVideoTrackTimer!==void 0&&(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e){var n;return(n=t.localUsermediaFeed)===null||n===void 0||n.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted()}if(!e&&t.localUsermediaStream.getVideoTracks().length===0){var a=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(a)}return(r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout(()=>{for(var s of t.localUsermediaStream.getVideoTracks())s.stop(),t.localUsermediaStream.removeTrack(s)},120)),t.isLocalVideoMuted()})()}isLocalVideoMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isVideoMuted())!==null&&e!==void 0?e:!1}setMicrophoneMuted(e){var t=this;return _(function*(){var r;return O.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?!e&&(!t.hasUserMediaAudioSender||!t.hasLocalUserMediaAudioTrack)?(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):((r=t.localUsermediaFeed)===null||r===void 0||r.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):t.isMicrophoneMuted()})()}isMicrophoneMuted(){var e,t;return(e=(t=this.localUsermediaFeed)===null||t===void 0?void 0:t.isAudioMuted())!==null&&e!==void 0?e:!1}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(var t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(_e.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==ge.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var r=["inactive","recvonly"].includes(t.currentDirection);r||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var r;if(((r=t.track)===null||r===void 0?void 0:r.kind)==="audio"&&t.dtmf){t.dtmf.insertDTMF(e);return}}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;O.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),Ze(this.localUsermediaStream.getAudioTracks(),!e),Ze(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return _(function*(){yield e.sendVoipEvent(F.CallSDPStreamMetadataChangedPrefix,{[hr]:e.getLocalSDPStreamMetadata()})})()}gotCallFeedsForInvite(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(this.successor){this.successor.queueGotCallFeedsForAnswer(e);return}if(this.callHasEnded()){this.stopAllMedia();return}for(var r of e)this.pushLocalFeed(r);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=ge.CreateOffer,O.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}sendAnswer(){var e=this;return _(function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[hr]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var r=e.discardDuplicateCandidates();O.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(r," candidates that will be sent in answer"));try{yield e.sendVoipEvent(F.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(s){e.state=ge.Ringing,s instanceof Fe&&s.event&&e.client.cancelPendingEvent(s.event);var n=Ee.SendAnswer,a="Failed to send answer";throw s.name=="UnknownDeviceError"&&(n=Ee.UnknownDevices,a="Unknown devices present in the room"),e.emit(_e.Error,new rr(n,a,s),e),s}e.sendCandidateQueue()})()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.gotCallFeedsForAnswer(e)):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var r=lo.parse(e.sdp);r.media.forEach(n=>{var a=new Map,s=new Map;for(var o of n.rtp)a.set(o.payload,o.codec),s.set(o.codec,o.payload);for(var d of t)if(d.mediaType===n.type){if(!s.has(d.codec)){O.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(d.codec," as it's not present."));continue}var l=[];d.enableDtx!==void 0&&l.push("usedtx=".concat(d.enableDtx?"1":"0")),d.maxAverageBitrate!==void 0&&l.push("maxaveragebitrate=".concat(d.maxAverageBitrate));var u=!1;for(var h of n.fmtp)a.get(h.payload)===d.codec&&(u=!0,h.config+=";"+l.join(";"));u||n.fmtp.push({payload:s.get(d.codec),config:l.join(";")})}}),e.sdp=lo.write(r)}createOffer(){var e=this;return _(function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,Xd(e.isPtt)),t})()}createAnswer(){var e=this;return _(function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,Xd(e.isPtt)),t})()}gotCallFeedsForAnswer(e){var t=this;return _(function*(){if(!t.callHasEnded()){t.waitForLocalAVStream=!1;for(var r of e)t.pushLocalFeed(r);t.state=ge.CreateAnswer;var n;try{t.getRidOfRTXCodecs(),n=yield t.createAnswer()}catch(a){O.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),a),t.terminate(ze.Local,Ee.CreateAnswer,!0);return}try{if(yield t.peerConn.setLocalDescription(n),t.callHasEnded()||(t.state=ge.Connecting,yield new Promise(a=>{setTimeout(a,200)}),t.callHasEnded()))return;t.sendAnswer()}catch(a){O.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),a),t.terminate(ze.Local,Ee.SetLocalDescription,!0);return}}})()}onRemoteIceCandidatesReceived(e){var t=this;return _(function*(){if(!t.callHasEnded()){var r=e.getContent(),n=r.candidates;if(!n){O.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"));return}var a=r.version===0?null:r.party_id||null;if(t.opponentPartyId===void 0){if(a){O.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(n.length," candidates until we pick an opponent"));var s=t.remoteCandidateBuffer.get(a)||[];s.push(...n),t.remoteCandidateBuffer.set(a,s)}return}if(!t.partyIdMatches(r)){O.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(r.party_id,": we have chosen party ID ").concat(t.opponentPartyId));return}yield t.addIceCandidates(n)}})()}onAnswerReceived(e){var t=this;return _(function*(){var r=e.getContent();if(O.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(r.party_id,")")),t.callHasEnded()){O.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));return}if(t.opponentPartyId!==void 0){O.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(r.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId));return}t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=ge.Connecting;var n=r[hr];n?t.updateRemoteSDPStreamMetadata(n):O.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(r.answer),t.isSettingRemoteAnswerPending=!1,O.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(r.answer.type))}catch(a){t.isSettingRemoteAnswerPending=!1,O.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),a),t.terminate(ze.Local,Ee.SetRemoteDescription,!1);return}if(t.opponentPartyId!==null)try{yield t.sendVoipEvent(F.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(a){O.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),a)}})()}onSelectAnswerReceived(e){var t=this;return _(function*(){if(t.direction!==fr.Inbound){O.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"));return}var r=e.getContent().selected_party_id;if(r==null){O.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"));return}r!==t.ourPartyId&&(O.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(r,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(ze.Remote,Ee.AnsweredElsewhere,!0))})()}onNegotiateReceived(e){var t=this;return _(function*(){var r=e.getContent(),n=r.description;if(!n||!n.sdp||!n.type){O.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"));return}var a=t.direction===fr.Inbound,s=!t.makingOffer&&(t.peerConn.signalingState==="stable"||t.isSettingRemoteAnswerPending),o=n.type==="offer"&&!s;if(t.ignoreOffer=!a&&o,t.ignoreOffer){O.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));return}var d=t.isLocalOnHold(),l=r[hr];l?t.updateRemoteSDPStreamMetadata(l):O.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending=n.type=="answer",yield t.peerConn.setRemoteDescription(n),t.isSettingRemoteAnswerPending=!1,O.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(n.type)),n.type==="offer"){var u,h;try{t.getRidOfRTXCodecs(),h=yield t.createAnswer()}catch(m){O.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),m),t.terminate(ze.Local,Ee.CreateAnswer,!0);return}yield t.peerConn.setLocalDescription(h),O.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(F.CallNegotiate,{lifetime:xs,description:(u=t.peerConn.localDescription)===null||u===void 0?void 0:u.toJSON(),[hr]:t.getLocalSDPStreamMetadata(!0)})}}catch(m){t.isSettingRemoteAnswerPending=!1,O.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),m)}var v=t.isLocalOnHold();d!==v&&(t.emit(_e.LocalHoldUnhold,v,t),t.emit(_e.HoldUnhold,v))})()}updateRemoteSDPStreamMetadata(e){this.remoteSDPStreamMetadata=vc(this.remoteSDPStreamMetadata||{},e,!0);for(var t of this.getRemoteFeeds()){var r,n=t.stream.id,a=this.remoteSDPStreamMetadata[n];t.setAudioVideoMuted(a?.audio_muted,a?.video_muted),t.purpose=(r=this.remoteSDPStreamMetadata[n])===null||r===void 0?void 0:r.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),r=t[hr];this.updateRemoteSDPStreamMetadata(r)}onAssertedIdentityReceived(e){var t=this;return _(function*(){var r=e.getContent();r.asserted_identity&&(t.remoteAssertedIdentity={id:r.asserted_identity.id,displayName:r.asserted_identity.display_name},t.emit(_e.AssertedIdentityChanged,t))})()}callHasEnded(){return this.state===ge.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then(()=>this.wrappedGotLocalOffer()):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return _(function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){e.getLocalOfferFailed(t);return}finally{e.makingOffer=!1}})()}gotLocalOffer(){var e=this;return _(function*(){if(O.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded()){O.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));return}var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(u){O.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),u),e.terminate(ze.Local,Ee.CreateOffer,!0);return}try{yield e.peerConn.setLocalDescription(t)}catch(u){O.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),u),e.terminate(ze.Local,Ee.SetLocalDescription,!0);return}if(e.peerConn.iceGatheringState==="gathering"&&(yield new Promise(u=>{setTimeout(u,200)})),!e.callHasEnded()){var r=e.state===ge.CreateOffer?F.CallInvite:F.CallNegotiate,n={lifetime:xs};if(r===F.CallInvite&&e.invitee&&(n.invitee=e.invitee),e.state===ge.CreateOffer){var a;n.offer=(a=e.peerConn.localDescription)===null||a===void 0?void 0:a.toJSON()}else{var s;n.description=(s=e.peerConn.localDescription)===null||s===void 0?void 0:s.toJSON()}n.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},n[hr]=e.getLocalSDPStreamMetadata(!0);var o=e.discardDuplicateCandidates();O.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(o," candidates that will be sent in offer"));try{yield e.sendVoipEvent(r,n)}catch(u){O.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),u),u instanceof Fe&&u.event&&e.client.cancelPendingEvent(u.event);var d=Ee.SignallingFailed,l="Signalling failed";e.state===ge.CreateOffer&&(d=Ee.SendInvite,l="Failed to send invite"),u.name=="UnknownDeviceError"&&(d=Ee.UnknownDevices,l="Unknown devices present in the room"),e.emit(_e.Error,new rr(d,l,u),e),e.terminate(ze.Local,d,!1);return}e.sendCandidateQueue(),e.state===ge.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=ge.InviteSent,e.inviteTimeout=setTimeout(()=>{e.inviteTimeout=void 0,e.state===ge.InviteSent&&e.hangup(Ee.InviteTimeout,!1)},xs))}})()}getRidOfRTXCodecs(){if(!(!RTCRtpReceiver.getCapabilities||!RTCRtpSender.getCapabilities)){var e=this.transceivers.get(Lt(Ne.Screenshare,"video"));if(!(!e||!e.setCodecPreferences)){var t=RTCRtpReceiver.getCapabilities("video").codecs,r=RTCRtpSender.getCapabilities("video").codecs,n=[];for(var a of[...t,...r])if(a.mimeType!=="video/rtx"){n.push(a);try{e.setCodecPreferences(n)}catch(s){O.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",a,s),n.pop()}}}}}sendVoipEvent(e,t){var r=this;return _(function*(){var n=ha(ha({},t),{},{version:gp,call_id:r.callId,party_id:r.ourPartyId,conf_id:r.groupCallId});if(r.opponentDeviceId){var a,s=r.toDeviceSeq++,o=ha(ha({},n),{},{device_id:r.client.deviceId,sender_session_id:r.client.getSessionId(),dest_session_id:r.opponentSessionId,seq:s,[Hi]:qf()});r.emit(_e.SendVoipEvent,{type:"toDevice",eventType:e,userId:r.invitee||((a=r.getOpponentMember())===null||a===void 0?void 0:a.userId),opponentDeviceId:r.opponentDeviceId,content:o},r);var d=r.invitee||r.getOpponentMember().userId;if(r.client.getUseE2eForGroupCall()){if(!r.hasOpponentDeviceInfo){O.warn("Call ".concat(r.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));return}throw new Error("Unimplemented")}else yield r.client.sendToDevice(e,new Map([[d,new Map([[r.opponentDeviceId,o]])]]))}else{var l;r.emit(_e.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:r.roomId,content:n,userId:r.invitee||((l=r.getOpponentMember())===null||l===void 0?void 0:l.userId)},r),yield r.client.sendEvent(r.roomId,e,n)}})()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,!(this.state===ge.Ringing||!this.inviteOrAnswerSent)){var t=this.direction===fr.Inbound?500:2e3;this.candidateSendTries===0&&setTimeout(()=>{this.sendCandidateQueue()},t)}}discardDuplicateCandidates(){for(var e=0,t=[],r=0;r<this.candidateSendQueue.length;r++){var n=this.candidateSendQueue[r];n.candidate===""?t.push(n):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return _(function*(){var r=yield t.client.getProfileInfo(e),n=Wr(),a={replacement_id:Wr(),target_user:{id:e,display_name:r.displayname,avatar_url:r.avatar_url},create_call:n};yield t.sendVoipEvent(F.CallReplaces,a),yield t.terminate(ze.Local,Ee.Transferred,!0)})()}transferToCall(e){var t=this;return _(function*(){var r,n,a=(r=e.getOpponentMember())===null||r===void 0?void 0:r.userId,s=a?yield t.client.getProfileInfo(a):void 0,o=(n=t.getOpponentMember())===null||n===void 0?void 0:n.userId,d=o?yield t.client.getProfileInfo(o):void 0,l=Wr(),u={replacement_id:Wr(),target_user:{id:o,display_name:d?.displayname,avatar_url:d?.avatar_url},await_call:l};yield e.sendVoipEvent(F.CallReplaces,u);var h={replacement_id:Wr(),target_user:{id:a,display_name:s?.displayname,avatar_url:s?.avatar_url},create_call:l};yield t.sendVoipEvent(F.CallReplaces,h),yield t.terminate(ze.Local,Ee.Transferred,!0),yield e.terminate(ze.Local,Ee.Transferred,!0)})()}terminate(e,t,r){var n=this;return _(function*(){var a;if(!n.callHasEnded()){n.hangupParty=e,n.hangupReason=t,n.state=ge.Ended,n.inviteTimeout&&(clearTimeout(n.inviteTimeout),n.inviteTimeout=void 0),n.iceDisconnectedTimeout!==void 0&&(clearTimeout(n.iceDisconnectedTimeout),n.iceDisconnectedTimeout=void 0),n.callLengthInterval&&(clearInterval(n.callLengthInterval),n.callLengthInterval=void 0),n.stopVideoTrackTimer!==void 0&&(clearTimeout(n.stopVideoTrackTimer),n.stopVideoTrackTimer=void 0);for(var[s,o]of n.removeTrackListeners)s.removeEventListener("removetrack",o);n.removeTrackListeners.clear(),n.callStatsAtEnd=yield n.collectCallStats(),n.stopAllMedia(),n.deleteAllFeeds(),n.peerConn&&n.peerConn.signalingState!=="closed"&&n.peerConn.close(),(a=n.stats)===null||a===void 0||a.removeStatsReportGatherer(n.callId),r&&n.emit(_e.Hangup,n),n.client.callEventHandler.calls.delete(n.callId)}})()}stopAllMedia(){O.debug("Call ".concat(this.callId," stopAllMedia() running"));for(var e of this.feeds)if(e.isLocal()&&e.purpose===Ne.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===Ne.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal()){O.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")"));for(var t of e.stream.getTracks())t.stop()}}checkForErrorListener(){if(this.listeners(Po.Error).length===0)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return _(function*(){if(!(e.candidateSendQueue.length===0||e.callHasEnded())){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var r={candidates:t.map(o=>o.toJSON())};e.candidatesEnded&&r.candidates.push({candidate:""}),O.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(F.CallCandidates,r),e.candidateSendTries=0,e.sendCandidateQueue()}catch(o){if(o instanceof Fe&&o.event&&e.client.cancelPendingEvent(o.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){O.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),o);var n=Ee.SignallingFailed,a="Signalling failed";e.emit(_e.Error,new rr(n,a,o),e),e.hangup(n,!1);return}var s=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,O.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(s,"ms"),o),setTimeout(()=>{e.sendCandidateQueue()},s)}}})()}placeCall(e,t){var r=this;return _(function*(){if(!e)throw new Error("You CANNOT start a call without audio");r.state=ge.WaitLocalMedia;var n;try{var a,s=yield r.client.getMediaHandler().getUserMediaStream(e,t);Ze(s.getAudioTracks(),!0),Ze(s.getVideoTracks(),!0),n=new ir({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:(a=r.client.getDeviceId())!==null&&a!==void 0?a:void 0,stream:s,purpose:Ne.Usermedia,audioMuted:!1,videoMuted:!1})}catch(o){r.getUserMediaFailed(o);return}try{yield r.placeCallWithCallFeeds([n])}catch(o){r.placeCallFailed(o);return}})()}placeCallWithCallFeeds(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;r.checkForErrorListener(),r.direction=fr.Outbound,yield r.initOpponentCrypto(),r.client.callEventHandler.calls.set(r.callId,r);var a=yield r.client.checkTurnServers();a||O.warn("Call ".concat(r.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),r.peerConn=r.createPeerConnection(),r.emit(_e.PeerConnectionCreated,r.peerConn,r),r.gotCallFeedsForInvite(e,n)})()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var r=this.getOpponentMember(),n=r?r.userId:"unknown";return(e=this.stats)===null||e===void 0||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){var t=e.version===0?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,r=e.getContent();if(O.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(r.party_id,")")),this.opponentVersion=r.version,this.opponentVersion===0?this.opponentPartyId=null:this.opponentPartyId=r.party_id||null,this.opponentCaps=r.capabilities||{},this.opponentMember=(t=this.client.getRoom(this.roomId).getMember(e.getSender()))!==null&&t!==void 0?t:void 0,this.opponentMember){var n;(n=this.stats)===null||n===void 0||n.updateOpponentMember(this.callId,this.opponentMember.userId)}}addBufferedIceCandidates(){var e=this;return _(function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(O.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()})()}addIceCandidates(e){var t=this;return _(function*(){for(var r of e){(r.sdpMid===null||r.sdpMid===void 0)&&(r.sdpMLineIndex===null||r.sdpMLineIndex===void 0)?O.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates")):O.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(r.sdpMid,", candidate=").concat(r.candidate,")"));try{yield t.peerConn.addIceCandidate(r)}catch(n){t.ignoreOffer?O.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),n):O.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),n)}}})()}get hasPeerConnection(){return!!this.peerConn}initStats(e){this.stats=e,this.stats.start()}}function Ze(i,e){for(var t of i)t.enabled=e}function po(){if(typeof window>"u"||typeof document>"u")return!1;try{var i,e,t,r=!!((i=(e=(t=window.RTCPeerConnection)!==null&&t!==void 0?t:window.RTCSessionDescription)!==null&&e!==void 0?e:window.RTCIceCandidate)!==null&&i!==void 0?i:navigator.mediaDevices);if(!r)return O.error("WebRTC is not supported in this browser / environment"),!1}catch(n){return O.error("Exception thrown when trying to access WebRTC",n),!1}return!0}function kn(i,e,t){if(!po())return null;var r=t?t.forceTURN:!1,n={client:i,roomId:e,invitee:t?.invitee,turnServers:i.getTurnServers(),forceTURN:i.forceTURN||r,opponentDeviceId:t?.opponentDeviceId,opponentSessionId:t?.opponentSessionId,groupCallId:t?.groupCallId},a=new _p(n);return i.reEmitter.reEmit(a,Object.values(_e)),a}var dr=(function(i){return i.DontNotify="dont_notify",i.Notify="notify",i.Coalesce="coalesce",i})({}),ds=(function(i){return i.Highlight="highlight",i.Sound="sound",i})({}),eh=(function(i){return i.ExactEquals="==",i.LessThan="<",i.GreaterThan=">",i.GreaterThanOrEqual=">=",i.LessThanOrEqual="<=",i})({}),th="2";function rh(i){return i==="==2"||i==="2"}var Ye=(function(i){return i.EventMatch="event_match",i.EventPropertyIs="event_property_is",i.EventPropertyContains="event_property_contains",i.ContainsDisplayName="contains_display_name",i.RoomMemberCount="room_member_count",i.SenderNotificationPermission="sender_notification_permission",i.CallStarted="call_started",i.CallStartedPrefix="org.matrix.msc3914.call_started",i})({}),it=(function(i){return i.Override="override",i.ContentSpecific="content",i.RoomSpecific="room",i.SenderSpecific="sender",i.Underride="underride",i})({}),rt=(function(i){return i.Master=".m.rule.master",i.IsUserMention=".m.rule.is_user_mention",i.IsRoomMention=".m.rule.is_room_mention",i.ContainsDisplayName=".m.rule.contains_display_name",i.ContainsUserName=".m.rule.contains_user_name",i.AtRoomNotification=".m.rule.roomnotif",i.DM=".m.rule.room_one_to_one",i.EncryptedDM=".m.rule.encrypted_room_one_to_one",i.Message=".m.rule.message",i.EncryptedMessage=".m.rule.encrypted",i.InviteToSelf=".m.rule.invite_for_me",i.MemberEvent=".m.rule.member_event",i.IncomingCall=".m.rule.call",i.SuppressNotices=".m.rule.suppress_notices",i.Tombstone=".m.rule.tombstone",i.PollStart=".m.rule.poll_start",i.PollStartUnstable=".org.matrix.msc3930.rule.poll_start",i.PollEnd=".m.rule.poll_end",i.PollEndUnstable=".org.matrix.msc3930.rule.poll_end",i.PollStartOneToOne=".m.rule.poll_start_one_to_one",i.PollStartOneToOneUnstable=".org.matrix.msc3930.rule.poll_start_one_to_one",i.PollEndOneToOne=".m.rule.poll_end_one_to_one",i.PollEndOneToOneUnstable=".org.matrix.msc3930.rule.poll_end_one_to_one",i})({});function Qd(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Zd(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?Qd(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):Qd(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var eu=[it.Override,it.ContentSpecific,it.RoomSpecific,it.SenderSpecific,it.Underride],wp={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:Ye.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:Ye.SenderNotificationPermission,key:"room"}],actions:[dr.Notify,{set_tweak:ds.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:Ye.EventMatch,key:"type",pattern:"m.reaction"}],actions:[dr.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:Ye.EventMatch,key:"type",pattern:F.RoomServerAcl},{kind:Ye.EventMatch,key:"state_key",pattern:""}],actions:[]}},ol=Symbol("UserDefinedRules"),Rp=[rt.Master,ol,rt.SuppressNotices,rt.InviteToSelf,rt.MemberEvent,rt.IsUserMention,rt.ContainsDisplayName,rt.IsRoomMention,rt.AtRoomNotification,rt.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],Tp={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:Ye.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:Ye.CallStarted}],actions:[dr.Notify,{set_tweak:ds.Sound,value:"default"}]}},Ip=[ol,rt.IncomingCall,".org.matrix.msc3914.rule.room.call",rt.EncryptedDM,rt.DM,rt.Message,rt.EncryptedMessage];function tu(i,e,t,r,n){var a=t.filter(f=>f.default),s=t.filter(f=>!f.default);function o(f){f===ol?l.push(...s):f in r?(i.warn("Adding default global ".concat(e," push rule ").concat(f)),l.push(r[f])):i.warn("Missing default global ".concat(e," push rule ").concat(f))}var d=0,l=[];for(var u of a){var h=n.indexOf(u.rule_id);if(h===-1){l.push(u);continue}for(;h>d;){var v=n[d];o(v),d+=1}l.push(u),d+=1}for(var m of n.slice(d))o(m);return l}class Ft{constructor(e){this.client=e,c(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var r of e)r===dr.Notify?t.notify=!0:typeof r=="object"&&(r.value===void 0&&(r.value=!0),t.tweaks[r.set_tweak]=r.value);return t}static rewriteDefaultRules(e,t){var r=JSON.parse(JSON.stringify(t));return r||(r={}),r.global||(r.global={}),r.global.override||(r.global.override=[]),r.global.underride||(r.global.underride=[]),r.global.override=tu(e,it.Override,r.global.override,wp,Rp),r.global.underride=tu(e,it.Underride,r.global.underride,Tp,Ip),r}static getPushRuleGlobRegex(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:"i",[n,a]=t?["(?<=^|\\W)","(?=\\W|$)"]:["^","$"],s="".concat(t,"-").concat(r,"-").concat(e);return Ft.cachedGlobToRegex[s]||(Ft.cachedGlobToRegex[s]=new RegExp(n+"("+cc(e)+")"+a,r)),Ft.cachedGlobToRegex[s]}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var r of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var n of r)if(n.conditions)for(var a of n.conditions)a.kind===Ye.EventMatch&&(t.delete(a.key),this.parsedKeys.set(a.key,Ft.partsForDottedKey(a.key)));t.forEach(s=>this.parsedKeys.delete(s))}matchingRuleFromKindSet(e,t){for(var r of eu){var n=t[r];if(n){for(var a of n)if(a.enabled){var s=this.templateRuleToRaw(r,a);if(s&&this.ruleMatchesEvent(s,e))return Zd(Zd({},a),{},{kind:r})}}}return null}templateRuleToRaw(e,t){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case it.Underride:case it.Override:r.conditions=t.conditions;break;case it.RoomSpecific:if(!t.rule_id)return null;r.conditions.push({kind:Ye.EventMatch,key:"room_id",value:t.rule_id});break;case it.SenderSpecific:if(!t.rule_id)return null;r.conditions.push({kind:Ye.EventMatch,key:"user_id",value:t.rule_id});break;case it.ContentSpecific:if(!t.pattern)return null;r.conditions.push({kind:Ye.EventMatch,key:"content.body",pattern:t.pattern});break}return r}eventFulfillsCondition(e,t){switch(e.kind){case Ye.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case Ye.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case Ye.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case Ye.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case Ye.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case Ye.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case Ye.CallStarted:case Ye.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var r=e.key;if(!r)return!1;var n=this.client.getRoom(t.getRoomId());return n!=null&&n.currentState?n.currentState.mayTriggerNotifOfType(r,t.getSender()):!1}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;var n=r.currentState.getJoinedMemberCount(),a=e.is.match(/^([=<>]*)(\d*)$/);if(!a)return!1;var s=a[1],o=parseInt(a[2]);if(isNaN(o))return!1;switch(s){case"":case"==":return n==o;case"<":return n<o;case">":return n>o;case"<=":return n<=o;case">=":return n>=o;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var r,n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||typeof n.body!="string")return!1;var a=this.client.getRoom(t.getRoomId()),s=a==null||(r=a.currentState)===null||r===void 0?void 0:r.getMember(this.client.credentials.userId);if(!s)return!1;var o=s.name,d=new RegExp("(^|\\W)"+uc(o)+"(\\W|$)","i");return n.body.search(d)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var r=this.valueForDottedKey(e.key,t);if(typeof r!="string")return!1;if(e.value)return e.value===r;if(typeof e.pattern!="string")return!1;var n=Ft.getPushRuleGlobRegex(e.pattern,e.key==="content.body");return!!r.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!e.key||e.value===void 0?!1:e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||e.value===void 0)return!1;var r=this.valueForDottedKey(e.key,t);return Array.isArray(r)?r.includes(e.value):!1}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||Qr(t.getPrevContent(),{}))}static partsForDottedKey(e){var t=[],r="",n=!1;for(var a of e){if(n){a==="\\"||a==="."?r+=a:r+="\\"+a,n=!1;continue}a=="."?(t.push(r),r=""):a=="\\"?n=!0:r+=a}return n&&(r+="\\"),t.push(r),t}valueForDottedKey(e,t){var r=this.parsedKeys.get(e);r===void 0&&(r=Ft.partsForDottedKey(e),this.parsedKeys.set(e,r));var n,a=r[0],s=0;for(a==="content"?(n=t.getContent(),++s):a==="type"?(n=t.getType(),++s):n=t.event;s<r.length;++s){if(hc(n))return;var o=r[s];n=n[o]}return n}matchingRuleForEventWithRulesets(e,t){return!t||e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global)}pushActionsForEventAndRulesets(e,t){var r=this.matchingRuleForEventWithRulesets(e,t);if(!r)return{};var n=Ft.actionListToActionsObject(r.actions);return n.tweaks.highlight===void 0&&(n.tweaks.highlight=r.kind==it.ContentSpecific),{actions:n,rule:r}}ruleMatchesEvent(e,t){var r;return this.client.supportsIntentionalMentions()&&t.getContent()["m.mentions"]!==void 0&&(e.rule_id===rt.ContainsUserName||e.rule_id===rt.ContainsDisplayName||e.rule_id===rt.AtRoomNotification)?!1:!((r=e.conditions)!==null&&r!==void 0&&r.some(n=>!this.eventFulfillsCondition(n,t)))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,r=this.getPushRuleAndKindById(e);return(t=r?.rule)!==null&&t!==void 0?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var r;if(((r=this.client.pushRules)===null||r===void 0?void 0:r[t])!==void 0){for(var n of eu)if(this.client.pushRules[t][n]!==void 0){for(var a of this.client.pushRules[t][n])if(a.rule_id===e)return{rule:a,kind:n}}}}return null}}c(Ft,"cachedGlobToRegex",{});var Mn=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],nh=Mn[0],ih=Mn[Mn.length-1],yt=(function(i){return i.SUCCESS="SUCCESS",i.IGNORE="IGNORE",i.PROMPT="PROMPT",i.FAIL_PROMPT="FAIL_PROMPT",i.FAIL_ERROR="FAIL_ERROR",i})({}),Ct=(function(i){return i.Invalid="Invalid homeserver discovery response",i.GenericFailure="Failed to get autodiscovery configuration from server",i.InvalidHsBaseUrl="Invalid base_url for m.homeserver",i.InvalidHomeserver="Homeserver URL does not appear to be a valid Matrix homeserver",i.InvalidIsBaseUrl="Invalid base_url for m.identity_server",i.InvalidIdentityServer="Identity server URL does not appear to be a valid identity server",i.InvalidIs="Invalid identity server discovery response",i.MissingWellknown="No .well-known JSON file found",i.InvalidJson="Invalid JSON",i.UnsupportedHomeserverSpecVersion="The homeserver does not meet the version requirements",i})({});class ye{static fromDiscoveryConfig(e){var t=this;return _(function*(){var r,n={"m.homeserver":{state:ye.FAIL_ERROR,error:ye.ERROR_INVALID,base_url:null},"m.identity_server":{state:ye.PROMPT,error:null,base_url:null}};if(!(e!=null&&e["m.homeserver"]))return O.error("No m.homeserver key in config"),n["m.homeserver"].state=ye.FAIL_PROMPT,n["m.homeserver"].error=ye.ERROR_INVALID,Promise.resolve(n);if(!e["m.homeserver"].base_url)return O.error("No m.homeserver base_url in config"),n["m.homeserver"].state=ye.FAIL_PROMPT,n["m.homeserver"].error=ye.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var a=t.sanitizeWellKnownUrl(e["m.homeserver"].base_url);if(!a)return O.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=ye.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var s=yield t.fetchWellKnownObject("".concat(a,"/_matrix/client/versions"));if(!s||!Array.isArray((r=s.raw)===null||r===void 0?void 0:r.versions))return O.error("Invalid /versions response"),n["m.homeserver"].error=ye.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=a,Promise.resolve(n);var o=new Set(s.raw.versions),d=!1;for(var l of Mn)if(o.has(l)){d=!0;break}if(!d)return O.error("Homeserver does not meet version requirements"),n["m.homeserver"].error=ye.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,n["m.homeserver"].base_url=a,Promise.resolve(n);n["m.homeserver"]={state:ye.SUCCESS,error:null,base_url:a};var u="";if(e["m.identity_server"]){var h={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:ye.FAIL_PROMPT,error:ye.ERROR_INVALID_IS,base_url:null}};if(u=t.sanitizeWellKnownUrl(e["m.identity_server"].base_url),!u)return O.error("Invalid base_url for m.identity_server"),h["m.identity_server"].error=ye.ERROR_INVALID_IS_BASE_URL,Promise.resolve(h);var v=yield t.fetchWellKnownObject("".concat(u,"/_matrix/identity/v2"));if(!(v!=null&&v.raw)||v.action!==yt.SUCCESS)return O.error("Invalid /v2 response"),h["m.identity_server"].error=ye.ERROR_INVALID_IDENTITY_SERVER,h["m.identity_server"].base_url=u,Promise.resolve(h)}return u&&u.toString().length>0&&(n["m.identity_server"]={state:ye.SUCCESS,error:null,base_url:u}),Object.keys(e).forEach(m=>{if(m==="m.homeserver"||m==="m.identity_server"){var f=["error","state","base_url"];for(var g of Object.keys(e[m]))f.includes(g)||(n[m][g]=e[m][g])}else n[m]=e[m]}),Promise.resolve(n)})()}static findClientConfig(e){var t=this;return _(function*(){if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var r={"m.homeserver":{state:ye.FAIL_ERROR,error:ye.ERROR_INVALID,base_url:null},"m.identity_server":{state:ye.PROMPT,error:null,base_url:null}},n=e.includes("://")?e:"https://".concat(e),a=yield t.fetchWellKnownObject("".concat(n,"/.well-known/matrix/client"));return!a||a.action!==yt.SUCCESS?(O.error("No response or error when parsing .well-known"),a.reason&&O.error(a.reason),a.action===yt.IGNORE?r["m.homeserver"]={state:ye.PROMPT,error:null,base_url:null}:(r["m.homeserver"].state=ye.FAIL_PROMPT,r["m.homeserver"].error=ye.ERROR_INVALID),Promise.resolve(r)):ye.fromDiscoveryConfig(a.raw)})()}static getRawClientConfig(e){var t=this;return _(function*(){var r;if(!e||typeof e!="string"||e.length===0)throw new Error("'domain' must be a string of non-zero length");var n=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return n?(r=n.raw)!==null&&r!==void 0?r:{}:{}})()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,r;try{r=new URL(e)}catch(o){O.error("Could not parse url",o)}if(!((t=r)!==null&&t!==void 0&&t.hostname)||r.protocol!=="http:"&&r.protocol!=="https:")return!1;var n=r.port?":".concat(r.port):"",a=r.pathname?r.pathname:"",s="".concat(r.protocol,"//").concat(r.hostname).concat(n).concat(a);return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(o){return O.error(o),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){ye.fetchFn=e}static fetchWellKnownObject(e){return _(function*(){var t;try{if(t=yield ye.fetch(e,{method:W.Get,signal:Ji(5e3)}),t.status===404)return{raw:{},action:yt.IGNORE,reason:ye.ERROR_MISSING_WELLKNOWN};if(t.status!==200)return{raw:{},action:yt.FAIL_PROMPT,reason:"General failure"}}catch(s){var r=s,n="";return typeof r=="object"&&(n=r?.message),{error:r,raw:{},action:yt.FAIL_PROMPT,reason:n||"General failure"}}try{return{raw:yield t.json(),action:yt.SUCCESS}}catch(s){var a=s;return{error:a,raw:{},action:yt.FAIL_PROMPT,reason:a?.name==="SyntaxError"?ye.ERROR_INVALID_JSON:ye.ERROR_INVALID}}})()}}c(ye,"ERROR_INVALID",Ct.Invalid);c(ye,"ERROR_GENERIC_FAILURE",Ct.GenericFailure);c(ye,"ERROR_INVALID_HS_BASE_URL",Ct.InvalidHsBaseUrl);c(ye,"ERROR_INVALID_HOMESERVER",Ct.InvalidHomeserver);c(ye,"ERROR_INVALID_IS_BASE_URL",Ct.InvalidIsBaseUrl);c(ye,"ERROR_INVALID_IDENTITY_SERVER",Ct.InvalidIdentityServer);c(ye,"ERROR_INVALID_IS",Ct.InvalidIs);c(ye,"ERROR_MISSING_WELLKNOWN",Ct.MissingWellknown);c(ye,"ERROR_INVALID_JSON",Ct.InvalidJson);c(ye,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",Ct.UnsupportedHomeserverSpecVersion);c(ye,"ALL_ERRORS",Object.keys(Ct));c(ye,"FAIL_ERROR",yt.FAIL_ERROR);c(ye,"FAIL_PROMPT",yt.FAIL_PROMPT);c(ye,"PROMPT",yt.PROMPT);c(ye,"SUCCESS",yt.SUCCESS);c(ye,"fetchFn",void 0);var Wa=(function(i){return i.IS="SERVICE_TYPE_IS",i.IM="SERVICE_TYPE_IM",i})({});class Cp{constructor(e){this.ourEvent=e,c(this,"timeline",void 0),c(this,"ourEventIndex",0),c(this,"paginateTokens",{[be.Backward]:null,[be.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return this.paginateTokens[e?be.Backward:be.Forward]}setPaginateToken(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.paginateTokens[t?be.Backward:be.Forward]=e??null}addEvents(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class Xi{static fromJson(e,t){var r=e.context||{},n=(r.events_before||[]).map(t),a=(r.events_after||[]).map(t),s=new Cp(t(e.result)),o=s.ourEvent.threadRootId;return n=n.filter(d=>d.threadRootId===o),a=a.filter(d=>d.threadRootId===o),s.setPaginateToken(r.start,!0),s.addEvents(n,!0),s.addEvents(a,!1),s.setPaginateToken(r.end,!1),new Xi(e.rank,s)}constructor(e,t){this.rank=e,this.context=t}}function Ka(i){return"parent_delay_id"in i&&typeof i.parent_delay_id!="string"?!1:"delay"in i&&typeof i.delay!="number"?!0:"delay"in i||"parent_delay_id"in i}var Rr=(function(i){return i.Cancel="cancel",i.Restart="restart",i.Send="send",i})({}),ah=(function(i){return i.Public="public",i.Private="private",i})({}),us=(function(i){return i.PrivateChat="private_chat",i.TrustedPrivateChat="trusted_private_chat",i.PublicChat="public_chat",i})({}),ll=(function(i){return i.Public="public",i.Invite="invite",i.Private="private",i.Knock="knock",i.Restricted="restricted",i})({}),sh=(function(i){return i.RoomMembership="m.room_membership",i})({}),xi=(function(i){return i.CanJoin="can_join",i.Forbidden="forbidden",i})({}),cs=(function(i){return i.Invited="invited",i.Joined="joined",i.Shared="shared",i.WorldReadable="world_readable",i})({});function ru(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function nu(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?ru(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):ru(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function Op(i,e){var t=!!e.preventReEmit,r=e.decrypt!==!1;function n(a){var s=i.getRoom(a.room_id),o;s&&a.state_key===void 0&&(o=s.findEventById(a.event_id)),!o||o.status?o=new at(a):(o.setUnsigned(nu(nu({},o.getUnsigned()),a.unsigned)),t=!0);var d=o.getServerAggregatedRelation(Ue.Replace);if(d!=null&&d.content){var l=n(d);o.makeReplaced(l)}var u=s?.findThreadForEvent(o);return u&&o.setThread(u),o.isEncrypted()&&(t||i.reEmitter.reEmit(o,[Me.Decrypted]),r&&i.decryptEventIfNeeded(o)),t||(i.reEmitter.reEmit(o,[Me.Replaced,Me.VisibilityChange]),s?.reEmitter.reEmit(o,[Me.BeforeRedaction])),o}return n}function iu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function vr(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?iu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):iu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}class au{constructor(e,t,r){this.client=e,this.indexEvent=t,this.directory=r}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return this.indexEvent.getContent().active===!0}get version(){var e;return(e=this.indexEvent.getContent().version)!==null&&e!==void 0?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return _(function*(){yield e.client.sendStateEvent(e.roomId,Jt.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())})()}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){var t=this;return _(function*(){yield t.client.sendStateEvent(t.roomId,Jt.name,vr(vr({},t.indexEvent.getContent()),{},{name:e}),t.id)})()}isLocked(){return this.indexEvent.getContent().locked||!1}setLocked(e){var t=this;return _(function*(){yield t.client.sendStateEvent(t.roomId,Jt.name,vr(vr({},t.indexEvent.getContent()),{},{locked:e}),t.id)})()}getFileInfo(){var e=this;return _(function*(){var t=yield e.getFileEvent(),r=t.getOriginalContent().file,n=e.client.mxcUrlToHttp(r.url);if(!n)throw new Error("No HTTP URL available for ".concat(r.url));return{info:r,httpUrl:n}})()}getFileEvent(){var e=this;return _(function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");for(var r=t.getUnfilteredTimelineSet().findEventById(e.id);!r&&t.getLiveTimeline().getState(te.BACKWARDS).paginationToken;)yield e.client.scrollback(t,100),r=t.getUnfilteredTimelineSet().findEventById(e.id);if(!r)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(r),r})()}createNewVersion(e,t,r,n){var a=this;return _(function*(){var s=yield a.directory.createFile(e,t,r,vr(vr({},n??{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:Ue.Replace,event_id:a.id}}));return yield a.client.sendStateEvent(a.roomId,Jt.name,{active:!0,name:e,version:a.version+1},s.event_id),yield a.client.sendStateEvent(a.roomId,Jt.name,vr(vr({},a.indexEvent.getContent()),{},{active:!1}),a.id),s})()}getVersionHistory(){var e=this;return _(function*(){var t=[];t.push(e);var r=e.client.getRoom(e.roomId);if(!r)throw new Error("Invalid or unknown room");var n=[...r.getLiveTimeline().getEvents()].reverse(),a,s=yield e.getFileEvent();do if(a=n.find(d=>d.replacingEventId()===s.getId()),a){var o=e.directory.getFile(a.getId());if(o)t.push(o),s=a;else break}while(a);return t})()}}function su(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Lr(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?su(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):su(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var kp={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[F.RoomPowerLevels]:100,[F.RoomHistoryVisibility]:100,[F.RoomTombstone]:100,[F.RoomEncryption]:100,[F.RoomName]:50,[F.RoomMessage]:50,[F.RoomMessageEncrypted]:50,[F.Sticker]:50},users:{}},vn=(function(i){return i.Viewer="viewer",i.Editor="editor",i.Owner="owner",i})({});class ou{constructor(e,t){if(this.client=e,this.roomId=t,c(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(F.SpaceParent);return e!=null&&e.length?e.every(t=>{var r;return!((r=t.getContent())!==null&&r!==void 0&&r.via)}):!0}setName(e){var t=this;return _(function*(){yield t.client.sendStateEvent(t.roomId,F.RoomName,{name:e},"")})()}invite(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!0,a=[r.retryInvite(e)];n&&a.push(...r.getDirectories().map(s=>s.invite(e,n))),yield Promise.all(a)})()}retryInvite(e){var t=this;return _(function*(){yield Ov(()=>t.client.invite(t.roomId,e),r=>!(r instanceof Fe&&r.errcode==="M_FORBIDDEN"))})()}setPermissions(e,t){var r=this;return _(function*(){var n,a=r.room.currentState.getStateEvents(F.RoomPowerLevels,"");if(Array.isArray(a))throw new Error("Unexpected return type for power levels");var s=a?.getContent()||{},o=s.users_default||0,d=s.events_default||50,l=((n=s.events)===null||n===void 0?void 0:n[F.RoomPowerLevels])||100,u=s.users||{};switch(t){case vn.Viewer:u[e]=o;break;case vn.Editor:u[e]=d;break;case vn.Owner:u[e]=l;break;default:throw new Error("Invalid role: "+t)}s.users=u,yield r.client.sendStateEvent(r.roomId,F.RoomPowerLevels,s,"")})()}getPermissions(e){var t,r,n=this.room.currentState.getStateEvents(F.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");var a=n?.getContent()||{},s=a.users_default||0,o=a.events_default||50,d=((t=a.events)===null||t===void 0?void 0:t[F.RoomPowerLevels])||100,l=((r=a.users)===null||r===void 0?void 0:r[e])||s;return l>=d?vn.Owner:l>=o?vn.Editor:vn.Viewer}createDirectory(e){var t=this;return _(function*(){var r=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,F.SpaceChild,{via:[t.client.getDomain()]},r.roomId),yield t.client.sendStateEvent(r.roomId,F.SpaceParent,{via:[t.client.getDomain()]},t.roomId),r})()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(F.SpaceChild);for(var r of t)try{var n=r.getStateKey();if(n){var a=this.client.unstableGetFileTreeSpace(n);a&&e.push(a)}}catch(s){O.warn("Unable to create tree space instance for listing. Are we joined?",s)}return e}getDirectory(e){return this.getDirectories().find(t=>t.roomId===e)}delete(){var e=this;return _(function*(){var t=e.getDirectories();for(var r of t)yield r.delete();var n=[Se.Invite,Se.Knock,Se.Join],a=e.room.currentState.getStateEvents(F.RoomMember);for(var s of a){var o=s.getStateKey()!==e.client.getUserId();if(o&&n.includes(s.getContent().membership)){var d=s.getStateKey();if(!d)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,d,"Room deleted")}}yield e.client.leave(e.roomId)})()}getOrderedChildren(e){var t=e.map(r=>({roomId:r.getStateKey(),order:r.getContent().order})).filter(r=>r.roomId);return t.sort((r,n)=>{if(r.order&&!n.order)return-1;if(!r.order&&n.order)return 1;if(!r.order&&!n.order){var a,s,o,d,l=this.client.getRoom(r.roomId),u=this.client.getRoom(n.roomId);if(!l||!u)return Ea(r.roomId,n.roomId);var h=(a=(s=l.currentState.getStateEvents(F.RoomCreate,""))===null||s===void 0?void 0:s.getTs())!==null&&a!==void 0?a:0,v=(o=(d=u.currentState.getStateEvents(F.RoomCreate,""))===null||d===void 0?void 0:d.getTs())!==null&&o!==void 0?o:0;return h===v?Ea(r.roomId,n.roomId):h-v}else return Ea(r.order,n.order)}),t}getParentRoom(){var e=this.room.currentState.getStateEvents(F.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var r=t.getStateKey();if(!r)throw new Error("No state key found for parent");var n=this.client.getRoom(r);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(F.SpaceChild),r=this.getOrderedChildren(t);return r.findIndex(n=>n.roomId===this.roomId)}setOrder(e){var t=this;return _(function*(){var r;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var n=t.getParentRoom(),a=n.currentState.getStateEvents(F.SpaceChild),s=t.getOrderedChildren(a);e=Math.max(Math.min(e,s.length-1),0);var o=t.getOrder(),d=o<e;d&&e===s.length-1?e--:!d&&e===0&&e++;var l=s[d?e:e-1],u=s[d?e+1:e],h=Tr[0],v=!1;if(!l)u!=null&&u.order&&(h=Yl(u.order));else if(e===s.length-1)u!=null&&u.order&&(h=Hn(u.order));else{var m=l?.order,f=u?.order;m&&f?m===f?h=Hn(m):h=kv(m,f):m?h=Hn(m):f?h=Yl(f):v=!0}if(v){for(var g,T=0;T<=e;T++){var R=s[T];if(T===0&&(g=R.order),R.order)g=R.order;else{var S;g=g?Hn(g):Tr[0];var I=n.currentState.getStateEvents(F.SpaceChild,R.roomId),b=(S=I?.getContent())!==null&&S!==void 0?S:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,F.SpaceChild,Lr(Lr({},b),{},{order:g}),R.roomId)}}g&&(h=Hn(g))}var w=n.currentState.getStateEvents(F.SpaceChild,t.roomId),p=(r=w?.getContent())!==null&&r!==void 0?r:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,F.SpaceChild,Lr(Lr({},p),{},{order:h}),t.roomId)})()}createFile(e,t,r,n){var a=this;return _(function*(){var{content_uri:s}=yield a.client.uploadContent(t,{includeFilename:!1});r.url=s;var o={msgtype:Wt.File,body:e,url:s,file:r};n=n??{},n["m.new_content"]&&(n["m.new_content"]=o);var d=yield a.client.sendMessage(a.roomId,Lr(Lr(Lr({},n),o),{},{[Ao.name]:{}}));return yield a.client.sendStateEvent(a.roomId,Jt.name,{active:!0,name:e},d.event_id),d})()}getFile(e){var t=this.room.currentState.getStateEvents(Jt.name,e);return t?new au(this.client,t,this):null}listFiles(){return this.listAllFiles().filter(e=>e.isActive)}listAllFiles(){var e,t=(e=this.room.currentState.getStateEvents(Jt.name))!==null&&e!==void 0?e:[];return t.map(r=>new au(this.client,r,this))}}var dl=(function(i){return i.Recent="recent",i.Rank="rank",i})({}),mr=(function(i){return i.LocalStreamsChanged="local_streams_changed",i})({});class Mp extends Ke{constructor(e){super(),this.client=e,c(this,"audioInput",void 0),c(this,"audioSettings",void 0),c(this,"videoInput",void 0),c(this,"localUserMediaStream",void 0),c(this,"userMediaStreams",[]),c(this,"screensharingStreams",[]),c(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return _(function*(){O.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())})()}setAudioSettings(e){var t=this;return _(function*(){O.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()})()}setVideoInput(e){var t=this;return _(function*(){O.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())})()}setMediaInputs(e,t){var r=this;return _(function*(){O.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),r.audioInput=e,r.videoInput=t,yield r.updateLocalUsermediaStreams()})()}updateLocalUsermediaStreams(){var e=this;return _(function*(){if(e.userMediaStreams.length!==0){var t=new Map;for(var r of e.client.callEventHandler.calls.values())t.set(r.callId,{audio:r.hasLocalUserMediaAudioTrack,video:r.hasLocalUserMediaVideoTrack});for(var n of e.userMediaStreams){O.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(n.id,")"));for(var a of n.getTracks())a.stop()}e.userMediaStreams=[],e.localUserMediaStream=void 0;for(var s of e.client.callEventHandler.calls.values())if(!(s.callHasEnded()||!t.has(s.callId))){var{audio:o,video:d}=t.get(s.callId);O.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(s.callId,")"));var l=yield e.getUserMediaStream(o,d);s.callHasEnded()||(yield s.updateLocalUsermediaStream(l))}for(var u of e.client.groupCallEventHandler.groupCalls.values())if(u.localCallFeed){O.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(u.groupCallId,")"));var h=yield e.getUserMediaStream(!0,u.type===Yi.Video);u.state!==Ve.Ended&&(yield u.updateLocalUsermediaStream(h))}e.emit(mr.LocalStreamsChanged)}})()}hasAudioDevice(){return _(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="audioinput").length>0}catch(t){return O.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}hasVideoDevice(){return _(function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter(t=>t.kind==="videoinput").length>0}catch(t){return O.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}})()}getUserMediaStream(e,t){var r=arguments,n=this;return _(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:!0;return n.getMediaStreamPromise?n.getMediaStreamPromise=n.getMediaStreamPromise.then(()=>n.getUserMediaStreamInternal(e,t,a)):n.getMediaStreamPromise=n.getUserMediaStreamInternal(e,t,a),n.getMediaStreamPromise})()}getUserMediaStreamInternal(e,t,r){var n=this;return _(function*(){var a=e&&(yield n.hasAudioDevice()),s=t&&(yield n.hasVideoDevice()),o,d=!0;if(n.localUserMediaStream){var l,u;a!==n.localUserMediaStream.getAudioTracks().length>0&&(d=!1),s!==n.localUserMediaStream.getVideoTracks().length>0&&(d=!1),a&&((l=n.localUserMediaStream.getAudioTracks()[0])===null||l===void 0||(l=l.getSettings())===null||l===void 0?void 0:l.deviceId)!==n.audioInput&&(d=!1),s&&((u=n.localUserMediaStream.getVideoTracks()[0])===null||u===void 0||(u=u.getSettings())===null||u===void 0?void 0:u.deviceId)!==n.videoInput&&(d=!1)}else d=!1;if(d){var f;if(o=n.localUserMediaStream.clone(),O.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat((f=n.localUserMediaStream)===null||f===void 0?void 0:f.id," newStreamId=").concat(o.id," shouldRequestAudio=").concat(a," shouldRequestVideo=").concat(s,")")),!a)for(var g of o.getAudioTracks())o.removeTrack(g);if(!s)for(var T of o.getVideoTracks())o.removeTrack(T)}else{var h;try{h=n.getUserMediaContraints(a,s,!0),o=yield navigator.mediaDevices.getUserMedia(h)}catch(R){O.warn("MediaHandler getUserMediaStreamInternal() error (e=".concat(R,"), retrying without exact deviceId")),h=n.getUserMediaContraints(a,s,!1),o=yield navigator.mediaDevices.getUserMedia(h)}O.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(o.id,", shouldRequestAudio=").concat(a,", shouldRequestVideo=").concat(s,", constraints=").concat(JSON.stringify(h),")"));for(var v of o.getTracks()){var m=v.getSettings();v.kind==="audio"?n.audioInput=m.deviceId:v.kind==="video"&&(n.videoInput=m.deviceId)}r&&(n.localUserMediaStream=o)}return r&&n.userMediaStreams.push(o),n.emit(mr.LocalStreamsChanged),o})()}stopUserMediaStream(e){O.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var r=this.userMediaStreams.indexOf(e);if(r!==-1&&(O.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(r,1)),this.emit(mr.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var n of e.getTracks()){var a;if((a=this.localUserMediaStream)!==null&&a!==void 0&&a.getTrackById(n.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return _(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:{},n=e.length>1&&e[1]!==void 0?e[1]:!0,a;if(t.screensharingStreams.length===0){var s=t.getScreenshareContraints(r);r.desktopCapturerSourceId?(O.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(r),")")),a=yield navigator.mediaDevices.getUserMedia(s)):(O.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(r),")")),a=yield navigator.mediaDevices.getDisplayMedia(s))}else{var o=t.screensharingStreams[t.screensharingStreams.length-1];O.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(o.id,")")),a=o.clone()}return n&&t.screensharingStreams.push(a),t.emit(mr.LocalStreamsChanged),a})()}stopScreensharingStream(e){O.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop();var r=this.screensharingStreams.indexOf(e);r!==-1&&(O.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(r,1)),this.emit(mr.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams){O.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")"));for(var t of e.getTracks())t.stop()}for(var r of this.screensharingStreams)for(var n of r.getTracks())n.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(mr.LocalStreamsChanged)}getUserMediaContraints(e,t,r){var n=!!navigator.webkitGetUserMedia,a=r?"exact":"ideal",s={};this.audioInput&&(s.deviceId={[a]:this.audioInput}),this.audioSettings&&(s.autoGainControl={ideal:this.audioSettings.autoGainControl},s.echoCancellation={ideal:this.audioSettings.echoCancellation},s.noiseSuppression={ideal:this.audioSettings.noiseSuppression});var o={width:n?{exact:640}:{ideal:640},height:n?{exact:360}:{ideal:360}};return this.videoInput&&(o.deviceId={[a]:this.videoInput}),{audio:e?s:!1,video:t?o:!1}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:r}=e;return t?{audio:r??!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:r??!1,video:!0}}}var lu=(function(i){return i.RequestFinished="FINISHED",i.Complete="COMPLETE",i})({}),Qi=(function(i){return i.PreProcess="ExtState.PreProcess",i.PostProcess="ExtState.PostProcess",i})({}),qa=(function(i){return i.RoomData="SlidingSync.RoomData",i.Lifecycle="SlidingSync.Lifecycle",i})({}),Pp=3;class Ap{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return Qi.PreProcess}onRequest(e){var t=this;return _(function*(){return e&&(O.log("ExtensionE2EE: invalidating all device lists due to missing 'pos'"),yield t.crypto.markAllTrackedUsersAsDirty()),{enabled:!0}})()}onResponse(e){var t=this;return _(function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e.device_unused_fallback_key_types||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})})()}}class Dp{constructor(e,t){this.client=e,this.cryptoCallbacks=t,c(this,"nextBatch",null)}name(){return"to_device"}when(){return Qi.PreProcess}onRequest(e){var t=this;return _(function*(){return{since:t.nextBatch!==null?t.nextBatch:void 0,limit:100,enabled:!0}})()}onResponse(e){var t=this;return _(function*(){var r=e.events||[],n;t.cryptoCallbacks?n=yield t.cryptoCallbacks.preprocessToDeviceMessages(r):n=r.map(a=>({message:a,encryptionInfo:null})),Xc(n,t.client),t.nextBatch=e.next_batch})()}}class Lp{constructor(e){this.client=e}name(){return"account_data"}when(){return Qi.PostProcess}onRequest(e){return _(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return _(function*(){e.global&&e.global.length>0&&t.processGlobalAccountData(e.global);for(var r in e.rooms){var n=wn(t.client,r,e.rooms[r]),a=t.client.getRoom(r);if(!a){O.warn("got account data for room but room doesn't exist on client:",r);continue}a.addAccountData(n),n.forEach(s=>{t.client.emit(ie.Event,s)})}})()}processGlobalAccountData(e){var t=wn(this.client,void 0,e),r=t.reduce((n,a)=>(n[a.getType()]=this.client.store.getAccountData(a.getType()),n),{});this.client.store.storeAccountDataEvents(t),t.forEach(n=>{if(n.getType()===F.PushRules){var a=n.getContent();this.client.setPushRules(a)}var s=r[n.getType()];return this.client.emit(ie.AccountData,n,s),n})}}class Up{constructor(e){this.client=e}name(){return"typing"}when(){return Qi.PostProcess}onRequest(e){return _(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return _(function*(){if(e!=null&&e.rooms)for(var r in e.rooms)lh(t.client,r,[e.rooms[r]])})()}}class Np{constructor(e){this.client=e}name(){return"receipts"}when(){return Qi.PostProcess}onRequest(e){return _(function*(){return{enabled:!0}})()}onResponse(e){var t=this;return _(function*(){if(e!=null&&e.rooms)for(var r in e.rooms)lh(t.client,r,[e.rooms[r]])})()}}class oh{constructor(e,t,r,n){this.slidingSync=e,this.client=t,c(this,"opts",void 0),c(this,"syncOpts",void 0),c(this,"syncState",null),c(this,"syncStateData",void 0),c(this,"lastPos",null),c(this,"failCount",0),c(this,"notifEvents",[]),this.opts=Jc(r),this.syncOpts=zc(n),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[ne.Timeline,ne.TimelineReset]),this.slidingSync.on(qa.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(qa.RoomData,this.onRoomData.bind(this));var a=[new Dp(this.client,this.syncOpts.cryptoCallbacks),new Lp(this.client),new Up(this.client),new Np(this.client)];this.syncOpts.cryptoCallbacks&&a.push(new Ap(this.syncOpts.cryptoCallbacks)),a.forEach(s=>{this.slidingSync.registerExtension(s)})}onRoomData(e,t){var r=this;return _(function*(){var n=r.client.store.getRoom(e);if(!n){if(!t.initial){r.syncOpts.logger.debug("initial flag not set but no stored room exists for room ",e,t);return}n=Yc(r.client,e,r.opts)}yield r.processRoomData(r.client,n,t)})()}onLifecycle(e,t,r){switch(r&&this.syncOpts.logger.debug("onLifecycle",e,r),e){case lu.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(Pe.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(Pe.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case lu.RequestFinished:if(r){if(this.failCount+=1,this.updateSyncState(this.failCount>Pp?Pe.Error:Pe.Reconnecting,{error:new Fe(r)}),this.shouldAbortSync(new Fe(r)))return}else this.failCount=0,this.syncOpts.logger.debug("SlidingSyncState.RequestFinished with ".concat(Object.keys(t?.rooms||[]).length," rooms"));break}}syncLeftRooms(){return _(function*(){return[]})()}peek(e){return _(function*(){return null})()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return(e=this.syncStateData)!==null&&e!==void 0?e:null}createRoom(e){var{timelineSupport:t}=this.client,r=new zi(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(r,[ne.Name,ne.Redaction,ne.RedactionCancelled,ne.Receipt,ne.Tags,ne.LocalEchoUpdated,ne.AccountData,ne.MyMembership,ne.Timeline,ne.TimelineReset]),this.registerStateListeners(r),r}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[we.Events,we.Members,we.NewMember,we.Update]),e.currentState.on(we.NewMember,(t,r,n)=>{var a;n.user=(a=this.client.getUser(n.userId))!==null&&a!==void 0?a:void 0,this.client.reEmitter.reEmit(n,[pt.Name,pt.Typing,pt.PowerLevel,pt.Membership])})}shouldAbortSync(e){return e.errcode==="M_UNKNOWN_TOKEN"?(this.syncOpts.logger.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(Pe.Error,{error:e}),!0):!1}processRoomData(e,t,r){var n=this;return _(function*(){r=xp(e,t.roomId,r);var a=wn(n.client,t.roomId,r.required_state),s=wn(n.client,t.roomId,r.timeline,!1),o=[];if(r.limited||r.initial){var d=new Set;t.getLiveTimeline().getEvents().forEach(S=>{d.add(S.getId())});for(var l=[],u=[],h=!1,v=s.length-1;v>=0;v--){var m=s[v];if(d.has(m.getId())){h=!0;continue}h?l.push(m):u.unshift(m)}s=u,l.length>0&&t.addEventsToTimeline(l,!0,!1,t.getLiveTimeline(),r.prev_batch)}var f=t.hasEncryptionStateEvent();if(r.notification_count!=null&&t.setUnreadNotificationCount(ke.Total,r.notification_count),r.highlight_count!=null&&(!f||f&&t.getUnreadNotificationCount(ke.Highlight)<=0)&&t.setUnreadNotificationCount(ke.Highlight,r.highlight_count),r.bump_stamp&&t.setBumpStamp(r.bump_stamp),Number.isInteger(r.invited_count)&&t.currentState.setInvitedMemberCount(r.invited_count),Number.isInteger(r.joined_count)&&t.currentState.setJoinedMemberCount(r.joined_count),r.invite_state){var g=wn(n.client,t.roomId,r.invite_state);yield n.injectRoomEvents(t,g),r.initial&&(t.recalculate(),n.client.store.storeRoom(t),n.client.emit(ie.Room,t)),g.forEach(S=>{n.client.emit(ie.Event,S)});return}if(r.limited){var T;t.getLiveTimeline().setPaginationToken((T=r.prev_batch)!==null&&T!==void 0?T:null,te.BACKWARDS)}yield n.injectRoomEvents(t,a,s,r.num_live),t.addEphemeralEvents(o),t.updateMyMembership(Se.Join),t.setMSC4186SummaryData(r.heroes,r.joined_count,r.invited_count),t.recalculate(),r.initial&&(e.store.storeRoom(t),e.emit(ie.Room,t)),n.addNotifications(s);var R=(function(){var S=_(function*(I){e.emit(ie.Event,I),I.isState()&&I.getType()==F.RoomEncryption&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(t,I))});return function(b){return S.apply(this,arguments)}})();yield gn(a,R),yield gn(s,R),o.forEach(function(S){e.emit(ie.Event,S)}),t.decryptCriticalEvents()})()}injectRoomEvents(e,t){var r=arguments,n=this;return _(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:[],s=r.length>3&&r[3]!==void 0?r[3]:0,o=e.getLiveTimeline(),d=o.getEvents().length==0;if(d){for(var l of t)n.client.getPushActionsForEvent(l);o.initialiseState(t)}d||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var u=[];s>0&&(u=a.slice(-1*s),a=a.slice(0,-1*u.length)),yield e.addLiveEvents(a,{fromCache:!0,addToState:!1}),u.length>0&&(yield e.addLiveEvents(u,{fromCache:!1,addToState:!1})),e.recalculate(),n.resolveInvites(e)})()}resolveInvites(e){if(!(!e||!this.opts.resolveInvitesToProfiles)){var t=this.client;e.getMembersWithMembership(Se.Invite).forEach(function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n=t.getUser(r.userId),a;n?a=Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):a=t.getProfileInfo(r.userId),a.then(function(s){var o=r.events.member;o.getContent().membership===Se.Invite&&(o.getContent().avatar_url=s.avatar_url,o.getContent().displayname=s.displayname,r.setMembershipEvent(o,e.currentState))},function(s){})}})}}retryImmediately(){return!0}sync(){var e=this;return _(function*(){for(e.syncOpts.logger.debug("Sliding sync init loop");!e.client.isGuest();)try{e.syncOpts.logger.debug("Getting push rules...");var t=yield e.client.getPushRules();e.syncOpts.logger.debug("Got push rules"),e.client.pushRules=t;break}catch(r){if(e.syncOpts.logger.error("Getting push rules failed",r),e.shouldAbortSync(r))return}yield e.slidingSync.start()})()}stop(){this.syncOpts.logger.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(ie.Sync,this.syncState,r,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var r=this.client.getPushActionsForEvent(t);r&&r.notify&&r.tweaks&&r.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort(function(e,t){return e.getTs()-t.getTs()}),this.notifEvents.forEach(e=>{var t;(t=this.client.getNotifTimelineSet())===null||t===void 0||t.addLiveEvent(e,{addToState:!1})}),this.notifEvents=[]}}function xp(i,e,t){if(!t.name)return t;for(var r of t.required_state)if(r.type===F.RoomName&&r.state_key==="")return r.content={name:t.name},t;return t.required_state.push({event_id:"$fake-sliding-sync-name-event-"+e,state_key:"",type:F.RoomName,content:{name:t.name},sender:i.getUserId(),origin_server_ts:new Date().getTime()}),t}function wn(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!0,n=i.getEventMapper({decrypt:r});return t.map(function(a){return a.room_id=e,n(a)})}function lh(i,e,t){var r=wn(i,e,t),n=i.getRoom(e);if(!n){O.warn("got ephemeral events for room but room doesn't exist on client:",e);return}n.addEphemeralEvents(r),r.forEach(a=>{i.emit(ie.Event,a)})}var hs=new Qe("m.beacon_info","org.matrix.msc3672.beacon_info"),Va=new Qe("m.beacon","org.matrix.msc3672.beacon");class Zr{static RETRY_BACKOFF_RATELIMIT(e,t,r){return Yo(r,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===F.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Zr.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Zr.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,c(this,"queues",{}),c(this,"activeQueues",[]),c(this,"procFn",null),c(this,"processQueue",r=>{var n=this.peekNextEvent(r);if(!n){this.disableQueue(r);return}this.queues[r].length,Promise.resolve().then(()=>this.procFn(n.event)).then(a=>{this.removeNextEvent(r),n.event.getId(),n.resolvers.resolve(a),this.processQueue(r)},a=>{n.attempts+=1;var s=this.retryAlgorithm(n.event,n.attempts,a);n.attempts,n.event.getId(),s===-1?(O.info("Queue '%s' giving up on event %s",r,n.event.getId()),this.clearQueue(r,a)):setTimeout(this.processQueue,s,r)})})}getQueueForEvent(e){var t=this.queueAlgorithm(e);return!t||!this.queues[t]?null:this.queues[t].map(function(r){return r.event})}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var r=!1;return Oa(this.queues[t],n=>n.event.getId()===e.getId()?(r=!0,!0):!1),r}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var r=Promise.withResolvers();return this.queues[t].push({event:e,resolvers:r,attempts:0}),e.getId(),this.startProcessingQueues(),r.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter(e=>this.activeQueues.indexOf(e)===-1&&this.queues[e].length>0).forEach(e=>{this.activeQueues.push(e),this.processQueue(e)})}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),O.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){O.info("clearing queue '%s'",e);for(var r;r=this.removeNextEvent(e);)r.resolvers.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}var du=20;class Fp{constructor(e,t){var r=this;this.client=e,this.logger=t,c(this,"sending",!1),c(this,"running",!0),c(this,"retryTimeout",null),c(this,"retryAttempts",0),c(this,"sendQueue",_(function*(){if(r.retryTimeout!==null&&clearTimeout(r.retryTimeout),r.retryTimeout=null,!(r.sending||!r.running)){r.logger.debug("Attempting to send queued to-device messages"),r.sending=!0;var n;try{for(;r.running&&(n=yield r.client.store.getOldestToDeviceBatch(),n!==null);)yield r.sendBatch(n),yield r.client.store.removeToDeviceBatch(n.id),r.retryAttempts=0;if(!r.running)return;r.logger.debug("All queued to-device messages sent")}catch(s){++r.retryAttempts;var a=Zr.RETRY_BACKOFF_RATELIMIT(null,r.retryAttempts,s);if(a===-1){Math.floor(s.httpStatus/100)===4?(r.logger.error("Fatal error when sending to-device message - dropping to-device batch!",s),yield r.client.store.removeToDeviceBatch(n.id)):r.logger.info("Automatic retry limit reached for to-device messages.");return}r.logger.info("Failed to send batch of to-device messages. Will retry in ".concat(a,"ms"),s),r.retryTimeout=setTimeout(r.sendQueue,a)}finally{r.sending=!1}}})),c(this,"onResumedSync",(n,a)=>{n===Pe.Syncing&&a!==Pe.Syncing&&(this.logger.info("Resuming queue after resumed sync"),this.sendQueue())})}start(){this.running=!0,this.sendQueue(),this.client.on(ie.Sync,this.onResumedSync)}stop(){this.running=!1,this.retryTimeout!==null&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(ie.Sync,this.onResumedSync)}queueBatch(e){var t=this;return _(function*(){for(var r=[],n=0;n<e.batch.length;n+=du){var a={eventType:e.eventType,batch:e.batch.slice(n,n+du),txnId:t.client.makeTxnId()};r.push(a);var s=a.batch.map(o=>"".concat(o.userId,"/").concat(o.deviceId," (msgid ").concat(o.payload[Hi],")"));t.logger.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(a.txnId),s)}yield t.client.store.saveToDeviceBatches(r),t.sendQueue()})()}sendBatch(e){var t=this;return _(function*(){var r=new lr(()=>new Map);for(var n of e.batch)r.getOrCreate(n.userId).set(n.deviceId,n.payload);t.logger.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,r,e.txnId)})()}}var Fs=new Et.UnstableValue("m.policies","org.matrix.msc3847.policies"),va=new Et.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),uu=(function(i){return i.Ban="m.ban",i})({}),Rn=(function(i){return i.User="m.policy.user",i.Room="m.policy.room",i.Server="m.policy.server",i})({}),cu={[Rn.User]:F.PolicyRuleUser,[Rn.Room]:F.PolicyRuleRoom,[Rn.Server]:F.PolicyRuleServer};class jp{constructor(e){this.client=e}addRule(e,t,r){var n=this;return _(function*(){var a=yield n.getOrCreateTargetRoom(),s=yield n.client.sendStateEvent(a.roomId,cu[e],{entity:t,reason:r,recommendation:uu.Ban});return s.event_id})()}removeRule(e){var t=this;return _(function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())})()}addSource(e){var t=this;return _(function*(){yield t.client.joinRoom(e);var r=(yield t.getOrCreateSourceRooms()).map(n=>n.roomId);return r.includes(e)?!1:(r.push(e),yield t.withIgnoreInvitesPolicies(n=>{n.sources=r}),!0)})()}getRuleForInvite(e){var t=this;return _(function*(){var{sender:r,roomId:n}=e,a=yield t.getOrCreateSourceRooms(),s=r.split(":")[1],o=n.split(":")[1];for(var d of a){var l=d.getUnfilteredTimelineSet().getLiveTimeline().getState(te.FORWARDS);for(var{scope:u,entities:h}of[{scope:Rn.Room,entities:[n]},{scope:Rn.User,entities:[r]},{scope:Rn.Server,entities:[s,o]}]){var v=l.getStateEvents(cu[u]);for(var m of v){var f=m.getContent();if(f?.recommendation==uu.Ban){var g=f?.entity;if(g){var T=void 0;try{T=new RegExp(cc(g))}catch{continue}for(var R of h)if(R&&T.test(R))return m}}}}}return null})()}getOrCreateTargetRoom(){var e=this;return _(function*(){var t=e.getIgnoreInvitesPolicies(),r=t.target;if(typeof r!="string"&&(r=null),r){var n=e.client.getRoom(r);if(n)return n;r=null}return r=(yield e.client.createRoom({name:"Individual Policy Room",preset:us.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies(a=>{a.target=r}),e.client.getRoom(r)})()}getOrCreateSourceRooms(){var e=this;return _(function*(){var t=e.getIgnoreInvitesPolicies(),r=t.sources,n=!1;Array.isArray(r)||(n=!0,r=[]);var a=r.filter(o=>typeof o=="string").map(o=>e.client.getRoom(o)).filter(o=>!!o);if(a.length!=r.length&&(n=!0),a.length==0){var s=yield e.getOrCreateTargetRoom();n=!0,a=[s]}return n&&(yield e.withIgnoreInvitesPolicies(o=>{o.sources=r})),a})()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return _(function*(){var{policies:r,ignoreInvitesPolicies:n}=t.getPoliciesAndIgnoreInvitesPolicies();e(n),r[va.name]=n,yield t.client.setAccountData(Fs.name,r)})()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[Fs.name,Fs.altName]){var r;if(t){var n=(r=this.client.getAccountData(t))===null||r===void 0?void 0:r.getContent();if(n){e=n;break}}}var a={},s=!1;for(var o of[va.name,va.altName])if(o){var d=e[o];if(d&&typeof d=="object"){a=d,s=!0;break}}return s||(e[va.name]=a),{policies:e,ignoreInvitesPolicies:a}}}var js="matrix-js-sdk",pg=(function(i){return i.Change="change",i})({}),mg=(function(i){return i[i.Unsent=1]="Unsent",i[i.Requested=2]="Requested",i[i.Ready=3]="Ready",i[i.Started=4]="Started",i[i.Cancelled=5]="Cancelled",i[i.Done=6]="Done",i})({}),gg=(function(i){return i.Cancel="cancel",i.ShowSas="show_sas",i.ShowReciprocateQr="show_reciprocate_qr",i})({});function Bp(i){if(i.length>=255)throw new TypeError("Alphabet too long");const e=new Uint8Array(256);for(let l=0;l<e.length;l++)e[l]=255;for(let l=0;l<i.length;l++){const u=i.charAt(l),h=u.charCodeAt(0);if(e[h]!==255)throw new TypeError(u+" is ambiguous");e[h]=l}const t=i.length,r=i.charAt(0),n=Math.log(t)/Math.log(256),a=Math.log(256)/Math.log(t);function s(l){if(l instanceof Uint8Array||(ArrayBuffer.isView(l)?l=new Uint8Array(l.buffer,l.byteOffset,l.byteLength):Array.isArray(l)&&(l=Uint8Array.from(l))),!(l instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(l.length===0)return"";let u=0,h=0,v=0;const m=l.length;for(;v!==m&&l[v]===0;)v++,u++;const f=(m-v)*a+1>>>0,g=new Uint8Array(f);for(;v!==m;){let S=l[v],I=0;for(let b=f-1;(S!==0||I<h)&&b!==-1;b--,I++)S+=256*g[b]>>>0,g[b]=S%t>>>0,S=S/t>>>0;if(S!==0)throw new Error("Non-zero carry");h=I,v++}let T=f-h;for(;T!==f&&g[T]===0;)T++;let R=r.repeat(u);for(;T<f;++T)R+=i.charAt(g[T]);return R}function o(l){if(typeof l!="string")throw new TypeError("Expected String");if(l.length===0)return new Uint8Array;let u=0,h=0,v=0;for(;l[u]===r;)h++,u++;const m=(l.length-u)*n+1>>>0,f=new Uint8Array(m);for(;u<l.length;){const S=l.charCodeAt(u);if(S>255)return;let I=e[S];if(I===255)return;let b=0;for(let w=m-1;(I!==0||b<v)&&w!==-1;w--,b++)I+=t*f[w]>>>0,f[w]=I%256>>>0,I=I/256>>>0;if(I!==0)throw new Error("Non-zero carry");v=b,u++}let g=m-v;for(;g!==m&&f[g]===0;)g++;const T=new Uint8Array(h+(m-g));let R=h;for(;g!==m;)T[R++]=f[g++];return T}function d(l){const u=o(l);if(u)return u;throw new Error("Non-base"+t+" character")}return{encode:s,decodeUnsafe:o,decode:d}}var Wp="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz";const Kp=Bp(Wp);var Bs=[139,1];function yg(i){var e,t=new Uint8Array(Bs.length+i.length+1);t.set(Bs,0),t.set(i,Bs.length);for(var r=0,n=0;n<t.length-1;++n)r^=t[n];t[t.length-1]=r;var a=Kp.encode(t);return(e=a.match(/.{1,4}/g))===null||e===void 0?void 0:e.join(" ")}var qp=256;function Sg(i,e,t){return mo.apply(this,arguments)}function mo(){return mo=_(function*(i,e,t){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:qp;if(!globalThis.crypto.subtle||!TextEncoder)throw new Error("Password-based backup is not available on this platform");var n=yield globalThis.crypto.subtle.importKey("raw",new TextEncoder().encode(i),{name:"PBKDF2"},!1,["deriveBits"]),a=yield globalThis.crypto.subtle.deriveBits({name:"PBKDF2",salt:new TextEncoder().encode(e),iterations:t,hash:"SHA-512"},n,r);return new Uint8Array(a)}),mo.apply(this,arguments)}var st=(function(i){return i.UserTrustStatusChanged="userTrustStatusChanged",i.KeyBackupStatus="crypto.keyBackupStatus",i.KeyBackupFailed="crypto.keyBackupFailed",i.KeyBackupSessionsRemaining="crypto.keyBackupSessionsRemaining",i.KeyBackupDecryptionKeyCached="crypto.keyBackupDecryptionKeyCached",i.VerificationRequestReceived="crypto.verificationRequestReceived",i.WillUpdateDevices="crypto.willUpdateDevices",i.DevicesUpdated="crypto.devicesUpdated",i.KeysChanged="crossSigning.keysChanged",i.LegacyCryptoStoreMigrationProgress="crypto.legacyCryptoStoreMigrationProgress",i.DehydratedDeviceCreated="dehydration.DehydratedDeviceCreated",i.DehydratedDeviceUploaded="dehydration.DehydratedDeviceUploaded",i.RehydrationStarted="dehydration.RehydrationStarted",i.RehydrationProgress="dehydration.RehydrationProgress",i.RehydrationCompleted="dehydration.RehydrationCompleted",i.RehydrationError="dehydration.RehydrationError",i.DehydrationKeyCached="dehydration.DehydrationKeyCached",i.DehydratedDeviceRotationError="dehydration.DehydratedDeviceRotationError",i})({}),Vp=(function(i){return i.MEGOLM_UNKNOWN_INBOUND_SESSION_ID="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",i.MEGOLM_KEY_WITHHELD="MEGOLM_KEY_WITHHELD",i.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",i.OLM_UNKNOWN_MESSAGE_INDEX="OLM_UNKNOWN_MESSAGE_INDEX",i.HISTORICAL_MESSAGE_NO_KEY_BACKUP="HISTORICAL_MESSAGE_NO_KEY_BACKUP",i.HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",i.HISTORICAL_MESSAGE_WORKING_BACKUP="HISTORICAL_MESSAGE_WORKING_BACKUP",i.HISTORICAL_MESSAGE_USER_NOT_JOINED="HISTORICAL_MESSAGE_USER_NOT_JOINED",i.SENDER_IDENTITY_PREVIOUSLY_VERIFIED="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",i.UNSIGNED_SENDER_DEVICE="UNSIGNED_SENDER_DEVICE",i.UNKNOWN_SENDER_DEVICE="UNKNOWN_SENDER_DEVICE",i.UNKNOWN_ERROR="UNKNOWN_ERROR",i})({}),Gp=(function(i){return i[i.AllDevicesIsolationMode=0]="AllDevicesIsolationMode",i[i.OnlySignedDevicesIsolationMode=1]="OnlySignedDevicesIsolationMode",i})({});class bg{constructor(e){this.errorOnVerifiedUserProblems=e,c(this,"kind",Gp.AllDevicesIsolationMode)}}class Eg{constructor(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=r,c(this,"needsUserApproval",void 0),this.needsUserApproval=n}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class _g{constructor(e){var t,r,n,a,s;c(this,"signedByOwner",void 0),c(this,"crossSigningVerified",void 0),c(this,"tofu",void 0),c(this,"localVerified",void 0),c(this,"trustCrossSignedDevices",void 0),this.signedByOwner=(t=e.signedByOwner)!==null&&t!==void 0?t:!1,this.crossSigningVerified=(r=e.crossSigningVerified)!==null&&r!==void 0?r:!1,this.tofu=(n=e.tofu)!==null&&n!==void 0?n:!1,this.localVerified=(a=e.localVerified)!==null&&a!==void 0?a:!1,this.trustCrossSignedDevices=(s=e.trustCrossSignedDevices)!==null&&s!==void 0?s:!1}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var wg=(function(i){return i.Fetch="fetch",i.LoadKeys="load_keys",i})({}),Rg=(function(i){return i.Master="master",i.SelfSigning="self_signing",i.UserSigning="user_signing",i})({}),Tg=(function(i){return i[i.NONE=0]="NONE",i[i.GREY=1]="GREY",i[i.RED=2]="RED",i})({}),Ig=(function(i){return i[i.UNKNOWN=0]="UNKNOWN",i[i.UNVERIFIED_IDENTITY=1]="UNVERIFIED_IDENTITY",i[i.UNSIGNED_DEVICE=2]="UNSIGNED_DEVICE",i[i.UNKNOWN_DEVICE=3]="UNKNOWN_DEVICE",i[i.AUTHENTICITY_NOT_GUARANTEED=4]="AUTHENTICITY_NOT_GUARANTEED",i[i.MISMATCHED_SENDER_KEY=5]="MISMATCHED_SENDER_KEY",i[i.SENT_IN_CLEAR=6]="SENT_IN_CLEAR",i[i.VERIFICATION_VIOLATION=7]="VERIFICATION_VIOLATION",i[i.MISMATCHED_SENDER=8]="MISMATCHED_SENDER",i})({}),Hp=new Uint8Array(8);function dh(i,e){return go.apply(this,arguments)}function go(){return go=_(function*(i,e){var t=yield globalThis.crypto.subtle.importKey("raw",i,{name:"HKDF"},!1,["deriveBits"]),r=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:Hp,info:new TextEncoder().encode(e),hash:"SHA-256"},t,512),n=r.slice(0,32),a=r.slice(32),s=globalThis.crypto.subtle.importKey("raw",n,{name:"AES-CTR"},!1,["encrypt","decrypt"]),o=globalThis.crypto.subtle.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([s,o])}),go.apply(this,arguments)}function uh(i,e,t,r){return yo.apply(this,arguments)}function yo(){return yo=_(function*(i,e,t,r){var n;r?n=_r(r):(n=new Uint8Array(16),globalThis.crypto.getRandomValues(n),n[8]&=127);var[a,s]=yield dh(e,t),o=new TextEncoder().encode(i),d=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:n,length:64},a,o),l=yield globalThis.crypto.subtle.sign({name:"HMAC"},s,d);return{iv:_n(n),ciphertext:_n(new Uint8Array(d)),mac:_n(new Uint8Array(l))}}),yo.apply(this,arguments)}function $p(i,e,t){return So.apply(this,arguments)}function So(){return So=_(function*(i,e,t){var[r,n]=yield dh(e,t),a=_r(i.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},n,_r(i.mac),a)))throw new Error("Error decrypting secret ".concat(t,": bad MAC"));var s=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:_r(i.iv),length:64},r,a);return new TextDecoder().decode(new Uint8Array(s))}),So.apply(this,arguments)}var Kr="m.secret_storage.v1.aes-hmac-sha2";class ch{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return _(function*(){var t,r=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return r&&(t=r.key)!==null&&t!==void 0?t:null})()}setDefaultKeyId(e){return new Promise((t,r)=>{var n=s=>{if(s.getType()==="m.secret_storage.default_key"){var o=s.getContent(),d=e===null?Object.keys(o).length===0:o.key===e;d&&(this.accountDataAdapter.removeListener(ie.AccountData,n),t())}};this.accountDataAdapter.on(ie.AccountData,n);var a=e===null?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",a).catch(s=>{this.accountDataAdapter.removeListener(ie.AccountData,n),r(s)})})}addKey(e,t,r){var n=this;return _(function*(){if(e!==Kr)throw new Error("Unknown key algorithm ".concat(e));var a={algorithm:e};t.name&&(a.name=t.name),t.passphrase&&(a.passphrase=t.passphrase);var{iv:s,mac:o}=yield Eo(t.key);if(a.iv=s,a.mac=o,!r)do r=wr(32);while(yield n.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(r)));return yield n.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(r),a),{keyId:r,keyInfo:a}})()}getKey(e){var t=this;return _(function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var r=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return r?[e,r]:null})()}hasKey(e){var t=this;return _(function*(){var r=yield t.getKey(e);return!!r})()}checkKey(e,t){return _(function*(){if(t.algorithm===Kr)if(t.mac){var{mac:r}=yield Eo(e,t.iv);return bo(t.mac)===bo(r)}else return!0;else throw new Error("Unknown algorithm")})()}store(e,t,r){var n=this;return _(function*(){if(t===null){yield n.accountDataAdapter.setAccountData(e,{});return}var a={};if(!r){var s=yield n.getDefaultKeyId();if(!s)throw new Error("No keys specified and no default key present");r=[s]}if(r.length===0)throw new Error("Zero keys given to encrypt with!");for(var o of r){var d=yield n.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(o));if(!d)throw new Error("Unknown key: "+o);if(d.algorithm===Kr){var l={[o]:d},[,u]=yield n.getSecretStorageKey(l,e);a[o]=yield u.encrypt(t)}else O.warn("unknown algorithm for secret storage key "+o+": "+d.algorithm)}yield n.accountDataAdapter.setAccountData(e,{encrypted:a})})()}get(e){var t=this;return _(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(r){if(!r.encrypted)throw new Error("Content is not encrypted!");var n={};for(var a of Object.keys(r.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a)),o=r.encrypted[a];s?.algorithm===Kr&&o.iv&&o.ciphertext&&o.mac&&(n[a]=s)}if(Object.keys(n).length===0)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[d,l]=yield t.getSecretStorageKey(n,e),u=r.encrypted[d];return l.decrypt(u)}})()}isStored(e){var t=this;return _(function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(!(r!=null&&r.encrypted))return null;var n={};for(var a of Object.keys(r.encrypted)){var s=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a));if(s){var o=r.encrypted[a];s.algorithm===Kr&&o.iv&&o.ciphertext&&o.mac&&(n[a]=s)}}return Object.keys(n).length?n:null})()}getSecretStorageKey(e,t){var r=this;return _(function*(){if(!r.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var n=yield r.callbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[a,s]=n;if(!e[a])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[a].algorithm===Kr){var o={encrypt:function(l){return uh(l,s,t)},decrypt:function(l){return $p(l,s,t)}};return[a,o]}else throw new Error("Unknown key type: "+e[a].algorithm)})()}}function bo(i){for(var e=i.length;e>=1&&i.charCodeAt(e-1)==61;)e--;return e<i.length?i.substring(0,e):i}var Jp="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function Eo(i,e){return uh(Jp,i,"",e)}const hh=Object.freeze(Object.defineProperty({__proto__:null,SECRET_STORAGE_ALGORITHM_V1_AES:Kr,ServerSideSecretStorageImpl:ch,calculateKeyCheck:Eo,trimTrailingEquals:bo},Symbol.toStringTag,{value:"Module"}));function ul(i){return _o.apply(this,arguments)}function _o(){return _o=_(function*(i){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var e=new TextEncoder().encode(i),t=yield globalThis.crypto.subtle.digest("SHA-256",e);return new Uint8Array(t)}),_o.apply(this,arguments)}var vh=1e3*60*60*4,zp=(i,e,t)=>{var r,n=" - ";if(typeof i.slot_id!="string"?e.push(n+"slot_id must be string"):i.slot_id.split("#").length!==2&&e.push(n+'slot_id must include exactly one "#"'),typeof i.member!="object"||i.member===null?e.push(n+"member must be an object"):(typeof i.member.user_id!="string"?e.push(n+"member.user_id must be string"):ts.test(i.member.user_id)?i.member.user_id!==t&&e.push(n+"member.user_id must match the sender"):e.push(n+"member.user_id must be a valid mxid"),typeof i.member.device_id!="string"&&e.push(n+"member.device_id must be string"),typeof i.member.id!="string"&&e.push(n+"member.id must be string")),typeof i.application!="object"||i.application===null?e.push(n+"application must be an object"):typeof i.application.type!="string"?e.push(n+"application.type must be a string"):i.application.type.includes("#")&&e.push(n+'application.type must not include "#"'),i.rtc_transports===void 0||!Array.isArray(i.rtc_transports))e.push(n+"rtc_transports must be an array");else for(var a of i.rtc_transports)if(typeof a!="object"||a===null||typeof a.type!="string"){e.push(n+"rtc_transports entries must be objects with a string type");break}if(i.versions===void 0||!Array.isArray(i.versions)?e.push(n+"versions must be an array"):i.versions.every(o=>typeof o=="string")||e.push(n+"versions must be an array of strings"),((r=i.sticky_key)!==null&&r!==void 0?r:i.msc4354_sticky_key)===void 0&&e.push(n+"sticky_key or msc4354_sticky_key must be a defined"),i.sticky_key!==void 0&&typeof i.sticky_key!="string"&&e.push(n+"sticky_key must be a string"),i.msc4354_sticky_key!==void 0&&typeof i.msc4354_sticky_key!="string"&&e.push(n+"msc4354_sticky_key must be a string"),i.sticky_key!==void 0&&i.msc4354_sticky_key!==void 0&&i.sticky_key!==i.msc4354_sticky_key&&e.push(n+"sticky_key and msc4354_sticky_key must be equal if both are defined"),i["m.relates_to"]!==void 0){var s=i["m.relates_to"];typeof s!="object"||s===null?e.push(n+"m.relates_to must be an object if provided"):(typeof s.event_id!="string"&&e.push(n+"m.relates_to.event_id must be a string"),s.rel_type!=="m.reference"&&e.push(n+"m.relates_to.rel_type must be m.reference"))}return e.length===0},Yp=(i,e)=>{var t,r=" - ";return typeof i.device_id!="string"&&e.push(r+"device_id must be string"),typeof i.call_id!="string"&&e.push(r+"call_id must be string"),typeof i.application!="string"&&e.push(r+"application must be a string"),typeof((t=i.focus_active)===null||t===void 0?void 0:t.type)!="string"&&e.push(r+"focus_active.type must be a string"),i.focus_active===void 0&&e.push(r+"focus_active has an invalid type"),i.foci_preferred!==void 0&&!(Array.isArray(i.foci_preferred)&&i.foci_preferred.every(n=>typeof n=="object"&&n!==null&&typeof n.type=="string"))&&e.push(r+"foci_preferred must be an array of transport objects"),i.created_ts!==void 0&&typeof i.created_ts!="number"&&e.push(r+"created_ts must be number"),i.scope!==void 0&&typeof i.scope!="string"&&e.push(r+"scope must be string"),i["m.call.intent"]!==void 0&&typeof i["m.call.intent"]!="string"&&e.push(r+"m.call.intent must be a string"),e.length===0};class sr{static equal(e,t){return Qr(e?.membershipData,t?.membershipData)}constructor(e,t,r,n){if(c(this,"logger",void 0),c(this,"matrixEventData",void 0),c(this,"rtcBackendIdentity",void 0),c(this,"membershipData",void 0),t.kind==="rtc"||t.kind==="session"){if(this.membershipData=t,r==null)throw new Error("rtcBackendIdentity must be defined when passing MembershipData");this.rtcBackendIdentity=r}else this.membershipData=sr.membershipDataFromMatrixEvent(new at({event_id:e.getId(),sender:e.getSender(),content:t})),this.rtcBackendIdentity="".concat(e.getSender(),":").concat(this.deviceId);var[a,s,o]=[e.getId(),e.getSender(),e.getTs()];if(a===void 0)throw new Error("parentEvent is missing eventId field");if(s===void 0)throw new Error("parentEvent is missing sender field");this.matrixEventData={eventId:a,sender:s,ts:o},this.logger=n?.getChild("[CallMembership ".concat(s,":").concat(this.deviceId,"]"))}static computeRtcBackendIdentity(e,t){return _(function*(){var{kind:r,data:n}=t;switch(r){case"rtc":return sr.computeRtcIdentityRaw(n.member.user_id,n.member.device_id,n.member.id);case"session":return"".concat(e.getSender(),":").concat(n.device_id)}})()}static computeRtcIdentityRaw(e,t,r){return _(function*(){var n="".concat(e,"|").concat(t,"|").concat(r),a=yield ul(n),s=Vn(a);return s})()}static membershipDataFromMatrixEvent(e){var[t,r,n]=[e.getId(),e.getSender(),e.getContent()];if(t===void 0)throw new Error("parentEvent is missing eventId field");if(r===void 0)throw new Error("parentEvent is missing sender field");var a=[],s=[];if(Yp(n,a))return{kind:"session",data:n};if(zp(n,s,r))return{kind:"rtc",data:n};var o=a.length<s.length?`Does not match MSC4143 m.call.member:
`.concat(a.join(`
`),`

`):`Does not match MSC4143 m.rtc.member:
`.concat(s.join(`
`),`

`),d=`
event:
`+JSON.stringify(n).replaceAll('"',"'");throw Error(`unknown CallMembership data.
`+o+d)}get sender(){return this.userId}get userId(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.member.user_id:this.matrixEventData.sender}get eventId(){return this.matrixEventData.eventId}get slotId(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.slot_id:cl({application:this.application,id:t.call_id})}get deviceId(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.member.device_id:t.device_id}get callIntent(){var{kind:e,data:t}=this.membershipData;switch(e){case"rtc":{var r,n=t.application["m.call.intent"];if(typeof n=="string")return n;(r=this.logger)===null||r===void 0||r.warn("RTC membership has invalid m.call.intent");return}default:return t["m.call.intent"]}}get slotDescription(){return am(this.slotId)}get application(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.application.type:t.application}get applicationData(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.application:{type:t.application,"m.call.intent":t["m.call.intent"]}}get scope(){var{kind:e,data:t}=this.membershipData;if(e!=="rtc")return t.scope}get membershipID(){return this.memberId}get memberId(){var e,{kind:t,data:r}=this.membershipData;return t==="rtc"?r.member.id:(e=r.membershipID)!==null&&e!==void 0?e:"".concat(this.matrixEventData.sender,":").concat(r.device_id)}createdTs(){var e,{kind:t,data:r}=this.membershipData;return t==="rtc"?this.matrixEventData.ts:(e=r.created_ts)!==null&&e!==void 0?e:this.matrixEventData.ts}getAbsoluteExpiry(){var e,{kind:t,data:r}=this.membershipData;if(t!=="rtc")return this.createdTs()+((e=r.expires)!==null&&e!==void 0?e:vh)}getMsUntilExpiry(){var{kind:e}=this.membershipData;if(e!=="rtc")return this.getAbsoluteExpiry()-Date.now()}isExpired(){var{kind:e}=this.membershipData;return e==="rtc"?!1:this.getMsUntilExpiry()<=0}getTransport(e){var{kind:t,data:r}=this.membershipData;switch(t){case"rtc":return r.rtc_transports[0];case"session":switch(r.focus_active.focus_selection){case"multi_sfu":return r.foci_preferred[0];case"oldest_membership":if(sr.equal(this,e))return r.foci_preferred[0];if(e!==void 0)return e.getTransport(e);break}}}getFocusActive(){var{kind:e,data:t}=this.membershipData;if(e==="session")return t.focus_active}get transports(){var{kind:e,data:t}=this.membershipData;return e==="rtc"?t.rtc_transports:t.foci_preferred}get kind(){return this.membershipData.kind}}var Ur=(function(i){return i.Disconnected="Disconnected",i.Connecting="Connecting",i.Connected="Connected",i.Disconnecting="Disconnecting",i.Unknown="Unknown",i})({}),wa=(i,e,t)=>i.sender===e&&i.deviceId===t;class Xp{constructor(e,t){this.membershipLoopHandler=e,c(this,"logger",void 0),c(this,"running",!1),c(this,"wakeup",r=>{this.logger.error("Cannot call wakeup before calling `startWithJoin()`")}),c(this,"_actions",[]),this.logger=(t??O).getChild("[NewMembershipActionScheduler]")}get actions(){return this._actions}startWithJoin(){var e=this;return _(function*(){if(e.running){e.logger.error("Cannot call startWithJoin() on NewMembershipActionScheduler while already running");return}e.running=!0,e._actions=[{ts:Date.now(),type:me.SendDelayedEvent}];try{for(var t=function*(){e._actions.sort((l,u)=>l.ts-u.ts);var n=e._actions[0],a=void 0,s=new Promise(l=>{e.wakeup=u=>{a=u,l()}});n.ts>Date.now()&&(yield Promise.race([s,qi(n.ts-Date.now())]));var o={};if(!a){e.logger.debug("Current MembershipManager processing: ".concat(n.type,`
Queue:`),e._actions,`
Date.now: "`.concat(Date.now()));try{o=yield e.membershipLoopHandler(n.type)}catch(l){throw Error("The MembershipManager shut down because of the end condition: ".concat(l))}}e._actions.splice(0,1);var d=a??o;"replace"in d?e._actions=d.replace:"insert"in d&&e._actions.push(...d.insert)};e._actions.length>0;)yield*t()}finally{e.running=!1}e.logger.debug("Leave MembershipManager ActionScheduler loop (no more actions)")})()}initiateJoin(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:me.SendDelayedEvent}]})}initiateLeave(){var e;(e=this.wakeup)===null||e===void 0||e.call(this,{replace:[{ts:Date.now(),type:me.SendScheduledDelayedLeaveEvent}]})}}var vs=(function(i){return i.TooNew="TOO_NEW",i})({});class fs extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}}c(fs,"TOO_NEW",vs.TooNew);class fh extends Error{constructor(e,t){super(e),this.value=t}}class ph extends Error{constructor(){super("MatrixClient has been stopped")}}class bt extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedDelayedEventsEndpointError"}}class Ga extends Error{constructor(e,t){super(e),this.clientEndpoint=t,this.name="UnsupportedStickyEventsEndpointError"}}var Sn=(function(i){return i.StatusChanged="StatusChanged",i.ProbablyLeft="ProbablyLeft",i.DelayIdChanged="DelayIdChanged",i})({});function hu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function bn(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?hu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):hu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var wo=3600*1e3,me=(function(i){return i.SendDelayedEvent="SendDelayedEvent",i.SendJoinEvent="SendJoinEvent",i.RestartDelayedEvent="RestartDelayedEvent",i.UpdateExpiry="UpdateExpiry",i.SendScheduledDelayedLeaveEvent="SendScheduledDelayedLeaveEvent",i.SendLeaveEvent="SendLeaveEvent",i})({});function Ot(i,e){return{insert:[{ts:Date.now()+(e??0),type:i}]}}function Ws(i,e){return{replace:[{ts:Date.now()+0,type:i}]}}class Fi extends Ke{isActivated(){return this.activated}isJoined(){return this.isActivated()}join(e,t,r){if(this.scheduler.running){this.logger.error("MembershipManager is already running. Ignoring join request.");return}this.fociPreferred=e,this.rtcTransport=t,this.leavePromiseResolvers=void 0,this.activated=!0,this.oldStatus=this.status,this.state=Fi.defaultState,this.scheduler.startWithJoin().catch(n=>{this.logger.error("MembershipManager stopped because: ",n),r?.(n)}).finally(()=>{if(this.activated=!1,this.oldStatus&&this.oldStatus!==this.status&&this.emit(Sn.StatusChanged,this.oldStatus,this.status),!this.scheduler.running){var n;(n=this.leavePromiseResolvers)===null||n===void 0||n.resolve(!0),this.leavePromiseResolvers=void 0}})}leave(e){return this.scheduler.running?(this.leavePromiseResolvers||(this.leavePromiseResolvers=Promise.withResolvers(),this.activated=!1,this.scheduler.initiateLeave(),e&&setTimeout(()=>{var t;return(t=this.leavePromiseResolvers)===null||t===void 0?void 0:t.resolve(!1)},e)),this.leavePromiseResolvers.promise):(this.logger.warn("Called MembershipManager.leave() even though the MembershipManager is not running"),Promise.resolve(!0))}onRTCSessionMemberUpdate(e){if(!this.isActivated())return Promise.resolve();if(this._ownMembership=e.find(r=>wa(r,this.userId,this.deviceId)),!this._ownMembership){var t=[me.SendDelayedEvent,me.SendJoinEvent];this.logger.warn("Missing own membership: force re-join"),this.state.hasMemberStateEvent=!1,this.scheduler.actions.some(r=>t.includes(r.type))?this.logger.error("tried adding another `SendDelayedEvent` actions even though we already have one in the Queue\nActionQueueOnMemberUpdate:",this.scheduler.actions):this.scheduler.initiateJoin()}return Promise.resolve()}updateCallIntent(e){var t=this;return _(function*(){if(!t.activated||!t.ownMembership)throw Error("You cannot update your intent before joining the call");t.ownMembership.callIntent!==e&&(t.callIntent=e,yield t.sendJoinEvent())})()}constructor(e,t,r,n,a){super(),this.joinConfig=e,this.room=t,this.client=r,this.slotDescription=n,c(this,"activated",!1),c(this,"logger",void 0),c(this,"callIntent",void 0),c(this,"leavePromiseResolvers",void 0),c(this,"_ownMembership",void 0),c(this,"oldStatus",void 0),c(this,"scheduler",void 0),c(this,"state",void 0),c(this,"deviceId",void 0),c(this,"userId",void 0),c(this,"stateKey",void 0),c(this,"rtcTransport",void 0),c(this,"fociPreferred",void 0),c(this,"delayedLeaveEventDelayMsOverride",void 0),c(this,"clientSendDelayedDisconnectMembership",()=>this.client._unstable_sendDelayedStateEvent(this.room.roomId,{delay:this.delayedLeaveEventDelayMs},F.GroupCallMemberPrefix,{},this.stateKey)),c(this,"clientSendMembership",d=>this.client.sendStateEvent(this.room.roomId,F.GroupCallMemberPrefix,d,this.stateKey)),this.logger=(a??O).getChild("[MembershipManager]");var[s,o]=[this.client.getUserId(),this.client.getDeviceId()];if(s===null)throw Error("Missing userId in client");if(o===null)throw Error("Missing deviceId in client");this.deviceId=o,this.userId=s,this.stateKey=this.makeMembershipStateKey(s,o),this.state=Fi.defaultState,this.callIntent=e?.callIntent,this.scheduler=new Xp(d=>(this.oldStatus&&(this.logger.debug("MembershipManager applied action changes. Status: ".concat(this.oldStatus," -> ").concat(this.status)),this.oldStatus!==this.status&&this.emit(Sn.StatusChanged,this.oldStatus,this.status)),this.oldStatus=this.status,this.logger.debug("MembershipManager before processing action. status=".concat(this.oldStatus)),this.membershipLoopHandler(d)),this.logger)}get ownMembership(){return this._ownMembership}static get defaultState(){return{hasMemberStateEvent:!1,delayId:void 0,startTime:0,rateLimitRetries:new Map,networkErrorRetries:new Map,expireUpdateIterations:1,probablyLeft:!1}}get networkErrorRetryMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.networkErrorRetryMs)!==null&&e!==void 0?e:3e3}get membershipEventExpiryMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.membershipEventExpiryMs)!==null&&e!==void 0?e:vh}get membershipEventExpiryHeadroomMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.membershipEventExpiryHeadroomMs)!==null&&e!==void 0?e:5e3}computeNextExpiryActionTs(e){return this.state.startTime+Math.min(this.membershipEventExpiryMs,wo)*e-this.membershipEventExpiryHeadroomMs}get delayedLeaveEventDelayMs(){var e,t,r;return(e=(t=this.delayedLeaveEventDelayMsOverride)!==null&&t!==void 0?t:(r=this.joinConfig)===null||r===void 0?void 0:r.delayedLeaveEventDelayMs)!==null&&e!==void 0?e:8e3}get delayedLeaveEventRestartMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartMs)!==null&&e!==void 0?e:5e3}get maximumRateLimitRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumRateLimitRetryCount)!==null&&e!==void 0?e:10}get maximumNetworkErrorRetryCount(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.maximumNetworkErrorRetryCount)!==null&&e!==void 0?e:10}get delayedLeaveEventRestartLocalTimeoutMs(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.delayedLeaveEventRestartLocalTimeoutMs)!==null&&e!==void 0?e:2e3}membershipLoopHandler(e){var t=this;return _(function*(){switch(e){case me.SendDelayedEvent:return t.state.delayId?t.cancelKnownDelayIdBeforeSendDelayedEvent(t.state.delayId):t.sendOrResendDelayedLeaveEvent();case me.RestartDelayedEvent:return t.state.delayId?t.restartDelayedEvent(t.state.delayId):Ot(me.SendDelayedEvent);case me.SendScheduledDelayedLeaveEvent:return t.state.hasMemberStateEvent?t.state.delayId?t.sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(t.state.delayId):Ot(me.SendLeaveEvent):{replace:[]};case me.SendJoinEvent:return t.sendJoinEvent();case me.UpdateExpiry:return t.updateExpiryOnJoinedEvent();case me.SendLeaveEvent:return t.state.hasMemberStateEvent?t.sendFallbackLeaveEvent():{replace:[]}}})()}sendOrResendDelayedLeaveEvent(){var e=this;return _(function*(){return yield e.clientSendDelayedDisconnectMembership().then(t=>(e.state.expectedServerDelayLeaveTs=Date.now()+e.delayedLeaveEventDelayMs,e.setAndEmitProbablyLeft(!1),e.resetRateLimitCounter(me.SendDelayedEvent),e.setAndEmitDelayId(t.delay_id),e.state.hasMemberStateEvent?Ot(me.RestartDelayedEvent,e.delayedLeaveEventRestartMs):Ot(me.SendJoinEvent))).catch(t=>{var r=me.SendDelayedEvent;if(e.manageMaxDelayExceededSituation(t))return Ot(r);var n=e.actionUpdateFromErrors(t,r,"_unstable_sendDelayedStateEvent");if(n)return n;if(e.state.hasMemberStateEvent){if(e.isUnsupportedDelayedEndpoint(t))return{};throw Error("Could not send delayed event, even though delayed events are supported. "+t)}else return e.isUnsupportedDelayedEndpoint(t)?e.logger.info("Not using delayed event because the endpoint is not supported"):e.logger.info("Not using delayed event because: "+t),Ot(me.SendJoinEvent)})})()}cancelKnownDelayIdBeforeSendDelayedEvent(e){var t=this;return _(function*(){return yield t.client._unstable_cancelScheduledDelayedEvent(e).then(()=>(t.setAndEmitDelayId(void 0),t.resetRateLimitCounter(me.SendDelayedEvent),Ws(me.SendDelayedEvent))).catch(r=>{var n=me.SendDelayedEvent,a=t.actionUpdateFromErrors(r,n,"cancelScheduledDelayedEvent");if(a)return a;if(t.isNotFoundError(r))return t.setAndEmitDelayId(void 0),Ws(n);if(t.isUnsupportedDelayedEndpoint(r))return Ws(me.SendJoinEvent);throw Error("We failed to cancel a delayed event where we already had a delay id with an error we cannot automatically handle")})})()}setAndEmitProbablyLeft(e){this.state.probablyLeft!==e&&(this.state.probablyLeft=e,this.emit(Sn.ProbablyLeft,this.state.probablyLeft))}setAndEmitDelayId(e){this.state.delayId!==e&&(this.state.delayId=e,this.emit(Sn.DelayIdChanged,this.state.delayId))}restartDelayedEvent(e){var t=this;return _(function*(){var r=t.state.expectedServerDelayLeaveTs?t.state.expectedServerDelayLeaveTs-Date.now():void 0,n=new Promise((a,s)=>{setTimeout(()=>{s(new lc("Restart delayed event timed out before the HS responded"))},r!==void 0&&!t.state.probablyLeft?Math.min(t.delayedLeaveEventRestartLocalTimeoutMs,r):t.delayedLeaveEventRestartLocalTimeoutMs)});return yield Promise.race([t.client._unstable_restartScheduledDelayedEvent(e),n]).then(()=>(t.state.expectedServerDelayLeaveTs=Date.now()+t.delayedLeaveEventDelayMs,t.resetRateLimitCounter(me.RestartDelayedEvent),t.setAndEmitProbablyLeft(!1),Ot(me.RestartDelayedEvent,t.delayedLeaveEventRestartMs))).catch(a=>{t.state.expectedServerDelayLeaveTs&&t.state.expectedServerDelayLeaveTs<=Date.now()&&t.setAndEmitProbablyLeft(!0);var s=me.RestartDelayedEvent;if(t.isNotFoundError(a))return t.setAndEmitDelayId(void 0),Ot(me.SendDelayedEvent);if(t.isUnsupportedDelayedEndpoint(a))return{};var o=t.actionUpdateFromErrors(a,s,"restartScheduledDelayedEvent");if(o)return o;throw Error("Could not restart delayed event, even though delayed events are supported. "+a)})})()}sendScheduledDelayedLeaveEventOrFallbackToSendLeaveEvent(e){var t=this;return _(function*(){return yield t.client._unstable_sendScheduledDelayedEvent(e).then(()=>(t.state.hasMemberStateEvent=!1,t.resetRateLimitCounter(me.SendScheduledDelayedLeaveEvent),{replace:[]})).catch(r=>{var n=me.SendLeaveEvent;if(t.isUnsupportedDelayedEndpoint(r))return{};if(t.isNotFoundError(r))return t.setAndEmitDelayId(void 0),Ot(n);var a=t.actionUpdateFromErrors(r,n,"sendScheduledDelayedEvent");return a||(t.logger.warn("Encountered unexpected error during SendScheduledDelayedLeaveEvent. Falling back to SendLeaveEvent",r),Ot(n))})})()}sendJoinEvent(){var e=this;return _(function*(){return yield e.clientSendMembership(e.makeMyMembership(e.membershipEventExpiryMs)).then(()=>{e.setAndEmitProbablyLeft(!1),e.state.startTime=Date.now(),e.state.expireUpdateIterations=1,e.state.hasMemberStateEvent=!0,e.resetRateLimitCounter(me.SendJoinEvent);var t=e.scheduler.actions.filter(r=>r.type!==me.UpdateExpiry&&r.type!==me.SendJoinEvent);return{replace:[...t,{ts:Date.now(),type:me.RestartDelayedEvent},{ts:e.computeNextExpiryActionTs(e.state.expireUpdateIterations),type:me.UpdateExpiry}]}}).catch(t=>{var r=e.actionUpdateFromErrors(t,me.SendJoinEvent,"sendStateEvent");if(r)return r;throw t})})()}updateExpiryOnJoinedEvent(){var e=this;return _(function*(){var t=e.state.expireUpdateIterations+1;return yield e.clientSendMembership(e.makeMyMembership(e.membershipEventExpiryMs*t)).then(()=>(e.resetRateLimitCounter(me.UpdateExpiry),e.state.expireUpdateIterations=t,{insert:[{ts:e.computeNextExpiryActionTs(t),type:me.UpdateExpiry}]})).catch(r=>{var n=e.actionUpdateFromErrors(r,me.UpdateExpiry,"sendStateEvent");if(n)return n;throw r})})()}sendFallbackLeaveEvent(){var e=this;return _(function*(){return yield e.clientSendMembership({}).then(()=>(e.resetRateLimitCounter(me.SendLeaveEvent),e.state.hasMemberStateEvent=!1,{replace:[]})).catch(t=>{var r=e.actionUpdateFromErrors(t,me.SendLeaveEvent,"sendStateEvent");if(r)return r;throw t})})()}makeMembershipStateKey(e,t){var r="".concat(e,"_").concat(t,"_").concat(this.slotDescription.application).concat(this.slotDescription.id);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?r:"_".concat(r)}makeMyMembership(e){var t,r,n=this.ownMembership,a=this.rtcTransport===void 0?{focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:(t=this.fociPreferred)!==null&&t!==void 0?t:[]}:{focus_active:{type:"livekit",focus_selection:"multi_sfu"},foci_preferred:[this.rtcTransport,...(r=this.fociPreferred)!==null&&r!==void 0?r:[]]};return bn(bn({application:this.slotDescription.application,call_id:this.slotDescription.id,scope:"m.room",device_id:this.deviceId,membershipID:"".concat(this.userId,":").concat(this.deviceId),expires:e,"m.call.intent":this.callIntent},a),n!==void 0?{created_ts:n.createdTs()}:void 0)}isNotFoundError(e){return e instanceof Fe&&e.errcode==="M_NOT_FOUND"}manageMaxDelayExceededSituation(e){if(e instanceof Fe&&e.errcode==="M_UNKNOWN"&&e.data["org.matrix.msc4140.errcode"]==="M_MAX_DELAY_EXCEEDED"){var t=e.data["org.matrix.msc4140.max_delay"];return typeof t=="number"&&this.delayedLeaveEventDelayMs>t&&(this.delayedLeaveEventDelayMsOverride=t),this.logger.warn("Retry sending delayed disconnection event due to server timeout limitations:",e),!0}return!1}actionUpdateFromErrors(e,t,r){var n=this.actionUpdateFromRateLimitError(e,r,t);if(n)return n;var a=this.actionUpdateFromNetworkErrorRetry(e,t);if(a)return a}actionUpdateFromRateLimitError(e,t,r){var n;if((e instanceof Ir||e instanceof Fe)&&e.isRateLimitError()){var a=(n=this.state.rateLimitRetries.get(r))!==null&&n!==void 0?n:0;if(a<this.maximumRateLimitRetryCount){var s,o=5e3;try{var d;s=(d=e.getRetryAfterMs())!==null&&d!==void 0?d:o,this.logger.info("Rate limited by server, retrying in ".concat(s,"ms"))}catch(l){this.logger.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(o),l),s=o}return this.state.rateLimitRetries.set(r,a+1),Ot(r,s)}throw Error("Exceeded maximum retries for "+r+" attempts (client."+t+")",{cause:e})}}actionUpdateFromNetworkErrorRetry(e,t){var r,n=(r=this.state.networkErrorRetries.get(t))!==null&&r!==void 0?r:0,a=this.networkErrorRetryMs/1e3+"s",s="("+n+"/"+this.maximumNetworkErrorRetryCount+")",o=this.networkErrorRetryMs;if(e instanceof Error&&e.name==="AbortError")o=0,this.logger.warn("Network local timeout error while sending event, immediate retry ("+s+")",e);else if(e instanceof Error&&e.message.includes("updating delayed event"))this.logger.warn("delayed event update timeout error, retrying in "+a+" "+s,e);else if(e instanceof Cr)this.logger.warn("Network connection error while sending event, retrying in "+a+" "+s,e);else if((e instanceof Ir||e instanceof Fe)&&typeof e.httpStatus=="number"&&e.httpStatus>=500&&e.httpStatus<600)this.logger.warn("Server error while sending event, retrying in "+a+" "+s,e);else return;if(n<this.maximumNetworkErrorRetryCount)return this.state.networkErrorRetries.set(t,n+1),Ot(t,o);throw Error("Reached maximum ("+this.maximumNetworkErrorRetryCount+") retries cause by: "+e)}isUnsupportedDelayedEndpoint(e){return e instanceof bt}resetRateLimitCounter(e){this.state.rateLimitRetries.set(e,0),this.state.networkErrorRetries.set(e,0)}get status(){var e=this.scheduler.actions;if(e.length===1){var{type:t}=e[0];switch(t){case me.SendDelayedEvent:case me.SendJoinEvent:return Ur.Connecting;case me.UpdateExpiry:return Ur.Connected;case me.SendScheduledDelayedLeaveEvent:case me.SendLeaveEvent:return Ur.Disconnecting}}else if(e.length===2){var r=e.map(a=>a.type);if((r.includes(me.RestartDelayedEvent)||r.includes(me.SendDelayedEvent)&&this.state.hasMemberStateEvent)&&r.includes(me.UpdateExpiry))return Ur.Connected}else if(e.length===3){var n=e.map(a=>a.type);if(n.filter(a=>a===me.RestartDelayedEvent).length===2&&n.includes(me.UpdateExpiry))return Ur.Connected}return this.scheduler.running?(this.logger.error("MembershipManager has an unknown state. Actions: ",e),Ur.Unknown):Ur.Disconnected}get probablyLeft(){return this.state.probablyLeft}get delayId(){return this.state.delayId}}class ps extends Fi{constructor(e,t,r,n,a,s){super(e,t,r,n,s),this.clientWithSticky=r,this.memberId=a,c(this,"clientSendDelayedDisconnectMembership",()=>this.clientWithSticky._unstable_sendStickyDelayedEvent(this.room.roomId,wo,{delay:this.delayedLeaveEventDelayMs},null,F.RTCMembership,{msc4354_sticky_key:this.memberId})),c(this,"clientSendMembership",o=>this.clientWithSticky._unstable_sendStickyEvent(this.room.roomId,wo,null,F.RTCMembership,bn(bn({},o),{},{msc4354_sticky_key:this.memberId})))}actionUpdateFromErrors(e,t,r){var n;return super.actionUpdateFromErrors(e,t,(n=ps.nameMap.get(r))!==null&&n!==void 0?n:"unknown")}makeMyMembership(e){var t=this.ownMembership,r=t!=null&&t.eventId?{"m.relation":{rel_type:Ue.Reference,event_id:t?.eventId}}:{};return bn({application:bn({type:this.slotDescription.application},this.callIntent?{"m.call.intent":this.callIntent}:{}),slot_id:cl(this.slotDescription),rtc_transports:this.rtcTransport?[this.rtcTransport]:[],member:{device_id:this.deviceId,user_id:this.userId,id:this.memberId},versions:[]},r)}}c(ps,"nameMap",new Map([["sendStateEvent","_unstable_sendStickyEvent"],["sendDelayedStateEvent","_unstable_sendStickyDelayedEvent"]]));var Pn=(function(i){return i.ReceivedKeys="received_keys",i.NotSupportedError="not_supported_error",i})({});function gr(i){return"".concat(i.userId,":").concat(i.deviceId,"(").concat(i.memberId,")")}class Qp{get updateEncryptionKeyThrottle(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.updateEncryptionKeyThrottle)!==null&&e!==void 0?e:3e3}get makeKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.makeKeyDelay)!==null&&e!==void 0?e:3e3}get useKeyDelay(){var e,t;return(e=(t=this.joinConfig)===null||t===void 0?void 0:t.useKeyDelay)!==null&&e!==void 0?e:5e3}constructor(e,t,r,n,a,s){var o=this;this.membership=e,this.getMemberships=t,this.transport=r,this.statistics=n,this.onEncryptionKeysChanged=a,c(this,"manageMediaKeys",!1),c(this,"keysEventUpdateTimeout",void 0),c(this,"makeNewKeyTimeout",void 0),c(this,"setNewKeyTimeouts",new Set),c(this,"encryptionKeys",new Map),c(this,"lastEncryptionKeyUpdateRequest",void 0),c(this,"lastMembershipFingerprints",void 0),c(this,"latestGeneratedKeyIndex",-1),c(this,"joinConfig",void 0),c(this,"logger",void 0),c(this,"joined",!1),c(this,"sendEncryptionKeysEvent",(function(){var d=_(function*(l){if(o.keysEventUpdateTimeout!==void 0&&(clearTimeout(o.keysEventUpdateTimeout),o.keysEventUpdateTimeout=void 0),o.lastEncryptionKeyUpdateRequest=Date.now(),!!o.joined){var u=o.getKeysForParticipant(o.membership);if(!u){o.logger.warn("Tried to send encryption keys event but no keys found!");return}if(typeof l!="number"&&o.latestGeneratedKeyIndex===-1){o.logger.warn("Tried to send encryption keys event but no current key index found!");return}var h=l??o.latestGeneratedKeyIndex;o.logger.info("Try sending encryption keys event. keyIndexToSend=".concat(h," (method parameter: ").concat(l,")"));var v=u[h];try{o.statistics.counters.roomEventEncryptionKeysSent+=1;var m=o.getMemberships().filter(g=>g.sender!=null).map(g=>({userId:g.sender,deviceId:g.deviceId,membershipTs:g.createdTs()}));yield o.transport.sendKey(al(v),h,m),o.logger.debug("sendEncryptionKeysEvent participantId=".concat(o.membership.userId,":").concat(o.membership.deviceId," numKeys=").concat(u.length," currentKeyIndex=").concat(o.latestGeneratedKeyIndex," keyIndexToSend=").concat(h))}catch(g){if(o.keysEventUpdateTimeout===void 0){var f=as(g,5e3);o.logger.warn("Failed to send m.call.encryption_key, retrying in ".concat(f),g),o.keysEventUpdateTimeout=setTimeout(()=>{o.sendEncryptionKeysEvent()},f)}else o.logger.info("Not scheduling key resend as another re-send is already pending")}}});return function(l){return d.apply(this,arguments)}})()),c(this,"onNewKeyReceived",(d,l,u,h)=>{this.logger.debug("Received key over key transport ".concat(d.userId,":").concat(d.deviceId," at index ").concat(u)),this.setEncryptionKey(d,u,l,h)}),c(this,"onRotateKeyTimeout",()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,this.logger.info("Making new sender key for key rotation");var d=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(d)}}),this.logger=(s??O).getChild("[EncryptionManager]")}rtcBackendIdentityFromMembershipParts(e){return"".concat(e.userId,":").concat(e.deviceId)}getEncryptionKeys(){var e=new Map;for(var[t,r]of this.encryptionKeys){var n=r.map((a,s)=>({key:a.key,membership:a.membership,keyIndex:s,rtcBackendIdentity:this.rtcBackendIdentityFromMembershipParts(a.membership)}));e.set(t,n)}return e}join(e){var t,r,n;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=(t=(r=this.joinConfig)===null||r===void 0?void 0:r.manageMediaKeys)!==null&&t!==void 0?t:this.manageMediaKeys,this.transport.on(Pn.ReceivedKeys,this.onNewKeyReceived),this.transport.start(),(n=this.joinConfig)!==null&&n!==void 0&&n.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){this.encryptionKeys.set(gr(this.membership),[]),this.transport.off(Pn.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.makeNewKeyTimeout!==void 0&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0);for(var e of this.setNewKeyTimeouts)clearTimeout(e);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){if(this.manageMediaKeys&&this.joined){var t=new Set(e.filter(l=>!wa(l,this.membership.userId,this.membership.deviceId)).map(gr)),r=new Set(this.getMemberships().filter(l=>!wa(l,this.membership.userId,this.membership.deviceId)).map(gr)),n=Array.from(t).some(l=>!r.has(l)),a=Array.from(r).some(l=>!t.has(l)),s=this.lastMembershipFingerprints;if(this.storeLastMembershipFingerprints(),n)this.makeNewKeyTimeout||(this.logger.debug("Member(s) have left: queueing sender key rotation"),this.makeNewKeyTimeout=setTimeout(this.onRotateKeyTimeout,this.makeKeyDelay));else if(a)this.logger.debug("New member(s) have joined: re-sending keys"),this.requestSendCurrentKey();else if(s){var o=this.lastMembershipFingerprints,d=Array.from(s).some(l=>!o.has(l))||Array.from(o).some(l=>!s.has(l));d&&(this.logger.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),this.requestSendCurrentKey())}}}makeNewSenderKey(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=Xf(16),r=this.getNewEncryptionKeyIndex();return this.logger.info("Generated new key at index "+r),this.setEncryptionKey(this.membership,r,t,Date.now(),e),r}requestSendCurrentKey(){if(this.manageMediaKeys){if(this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()){this.logger.info("Last encryption key event sent too recently: postponing"),this.keysEventUpdateTimeout===void 0&&(this.keysEventUpdateTimeout=setTimeout(()=>{this.sendEncryptionKeysEvent()},this.updateEncryptionKeyThrottle));return}this.sendEncryptionKeysEvent()}}getKeysForParticipant(e){var t;return(t=this.encryptionKeys.get(gr(e)))===null||t===void 0?void 0:t.map(r=>r.key)}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter(e=>!wa(e,this.membership.userId,this.membership.deviceId)).map(e=>"".concat(gr(e),":").concat(e.createdTs())))}getNewEncryptionKeyIndex(){return this.latestGeneratedKeyIndex===-1?0:(this.latestGeneratedKeyIndex+1)%256}setEncryptionKey(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!1;this.logger.debug("Setting encryption key for ".concat(e.userId,":").concat(e.deviceId," at index ").concat(t));var s=_r(r),o=gr(e);this.encryptionKeys.has(o)||this.encryptionKeys.set(o,[]);var d=this.encryptionKeys.get(o),l=d[t];if(l){if(l.timestamp>n){this.logger.info("Ignoring new key at index ".concat(t," for ").concat(o," as it is older than existing known key"));return}if(Zp(l.key,s)){l.timestamp=n;return}}if(e.userId===this.membership.userId&&e.deviceId===this.membership.deviceId&&(this.latestGeneratedKeyIndex=t),d[t]={key:s,timestamp:n,membership:e},a){var u=setTimeout(()=>{this.setNewKeyTimeouts.delete(u),this.logger.info("Delayed-emitting key changed event for ".concat(o," index ").concat(t)),this.onEncryptionKeysChanged(s,t,e,this.rtcBackendIdentityFromMembershipParts(e))},this.useKeyDelay);this.setNewKeyTimeouts.add(u)}else this.onEncryptionKeysChanged(s,t,e,this.rtcBackendIdentityFromMembershipParts(e))}}function Zp(i,e){return i===e?!0:!!i&&!!e&&i.length===e.length&&i.every((t,r)=>t===e[r])}class em{constructor(){c(this,"tsBuffer",new Map)}isOutdated(e,t){var r,n=gr(e);this.tsBuffer.has(n)||this.tsBuffer.set(n,new Map);var a=(r=this.tsBuffer.get(n))===null||r===void 0?void 0:r.get(t.keyIndex);return a&&a>t.creationTS?!0:(this.tsBuffer.get(n).set(t.keyIndex,t.creationTS),!1)}}class tm{constructor(e,t,r,n,a,s,o){this.ownMembership=e,this.getMemberships=t,this.transport=r,this.statistics=n,this.onEncryptionKeysChanged=a,c(this,"manageMediaKeys",!1),c(this,"useHashedRtcBackendIdentity",!1),c(this,"ownRtcBackendIdentityCache",void 0),c(this,"participantKeyRings",new Map),c(this,"outboundSession",null),c(this,"currentKeyDistributionPromise",null),c(this,"useKeyDelay",5e3),c(this,"keyRotationGracePeriodMs",1e4),c(this,"needToEnsureKeyAgain",!1),c(this,"keyBuffer",new em),c(this,"logger",void 0),c(this,"rtcIdentityProvider",void 0),c(this,"keysWithoutMatchingRTCMembership",[]),c(this,"onNewKeyReceived",(d,l,u,h)=>{var v;if(!this.manageMediaKeys){var m;(m=this.logger)===null||m===void 0||m.warn("Received key over transport ".concat(d.userId,":").concat(d.deviceId," at index ").concat(u," but media keys are disabled"));return}(v=this.logger)===null||v===void 0||v.debug("Received key over transport ".concat(d.userId,":").concat(d.deviceId," at index ").concat(u));var f=_r(l),g={key:f,membership:d,keyIndex:u,creationTS:h},T=this.keyBuffer.isOutdated(d,g);if(!T)this.addKeyToParticipant(g.key,g.keyIndex,g.membership),this.statistics.counters.roomEventEncryptionKeysReceived+=1;else{var R;(R=this.logger)===null||R===void 0||R.info("Received an out of order key for ".concat(d.userId,":").concat(d.deviceId,", dropping it"))}}),this.logger=s?.getChild("[EncryptionManager]"),this.rtcIdentityProvider=o??sr.computeRtcIdentityRaw}getOwnRtcBackendIdentity(){var e=this;return _(function*(){if(e.ownRtcBackendIdentityCache)return e.ownRtcBackendIdentityCache;if(e.useHashedRtcBackendIdentity){var t,{userId:r,deviceId:n,memberId:a}=e.ownMembership;(t=e.logger)===null||t===void 0||t.info("Computing RTC backend identity for ".concat(r,":").concat(n,":").concat(a," (SHOULD ONLY BE CALLED ONCE)")),e.ownRtcBackendIdentityCache=yield e.rtcIdentityProvider(r,n,a)}else e.ownRtcBackendIdentityCache="".concat(e.ownMembership.userId,":").concat(e.ownMembership.deviceId);return e.ownRtcBackendIdentityCache})()}getEncryptionKeys(){return new Map(this.participantKeyRings)}checkKeysWithoutMatchingRTCMembership(){var e=this.keysWithoutMatchingRTCMembership;this.keysWithoutMatchingRTCMembership=[],e.forEach(t=>{this.addKeyToParticipant(t.key,t.keyIndex,t.membership)})}addKeyToParticipant(e,t,r){var n=this.getMemberships(),a=n.find(o=>o.userId===r.userId&&o.deviceId===r.deviceId);if(!a){var s;(s=this.logger)===null||s===void 0||s.info("No matching RTC membership for key from ".concat(r.userId,":").concat(r.deviceId,", delaying key addition")),this.keysWithoutMatchingRTCMembership.push({key:e,keyIndex:t,membership:r});return}this.addKeyToParticipantWithBackendIdentity(e,t,r,a.rtcBackendIdentity)}addKeyToParticipantWithBackendIdentity(e,t,r,n){var a=gr(r);this.participantKeyRings.has(a)||this.participantKeyRings.set(a,[]),this.participantKeyRings.get(a).push({key:e,keyIndex:t,membership:r,rtcBackendIdentity:n}),this.onEncryptionKeysChanged(e,t,r,n)}join(e){var t,r,n,a,s;this.manageMediaKeys=(t=e?.manageMediaKeys)!==null&&t!==void 0?t:!0,this.useHashedRtcBackendIdentity=(r=e?.unstableSendStickyEvents)!==null&&r!==void 0?r:!1,this.useKeyDelay=(n=e?.useKeyDelay)!==null&&n!==void 0?n:1e3,this.keyRotationGracePeriodMs=(a=e?.keyRotationGracePeriodMs)!==null&&a!==void 0?a:1e4,this.transport.on(Pn.ReceivedKeys,this.onNewKeyReceived),this.getOwnRtcBackendIdentity(),(s=this.logger)===null||s===void 0||s.info("Joining room"),this.transport.start()}leave(){this.transport.off(Pn.ReceivedKeys,this.onNewKeyReceived),this.transport.stop(),this.participantKeyRings.clear()}ensureKeyDistribution(){if(this.manageMediaKeys)if(this.currentKeyDistributionPromise==null){var e;(e=this.logger)===null||e===void 0||e.debug("No active rollout, start a new one"),this.currentKeyDistributionPromise=this.rolloutOutboundKey().then(()=>{var r;if((r=this.logger)===null||r===void 0||r.debug("Rollout completed"),this.currentKeyDistributionPromise=null,this.needToEnsureKeyAgain){var n;(n=this.logger)===null||n===void 0||n.debug("New Rollout needed"),this.needToEnsureKeyAgain=!1,this.ensureKeyDistribution()}})}else{var t;(t=this.logger)===null||t===void 0||t.debug("Rollout in progress, a new rollout will be started after the current one"),this.needToEnsureKeyAgain=!0}}onMembershipsUpdate(){var e;(e=this.logger)===null||e===void 0||e.trace("onMembershipsUpdate"),this.ensureKeyDistribution(),this.checkKeysWithoutMatchingRTCMembership()}rolloutOutboundKey(){var e=this;return _(function*(){var t,r,n=e.outboundSession==null;if(n){var a={key:e.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:0};e.outboundSession=a,e.addKeyToParticipantWithBackendIdentity(a.key,a.keyId,e.ownMembership,yield e.getOwnRtcBackendIdentity())}var s=e.getMemberships().filter(y=>y.sender!=null).map(y=>({userId:y.sender,deviceId:y.deviceId,membershipTs:y.createdTs()})),o=(t=(r=e.outboundSession)===null||r===void 0?void 0:r.sharedWith)!==null&&t!==void 0?t:[];o=o.filter(y=>!s.some(P=>y.userId==P.userId&&y.deviceId==P.deviceId&&y.membershipTs!=P.membershipTs));var d=o.filter(y=>!s.some(P=>y.userId==P.userId&&y.deviceId==P.deviceId&&y.membershipTs==P.membershipTs)),l=s.filter(y=>!o.some(P=>y.userId==P.userId&&y.deviceId==P.deviceId&&y.membershipTs==P.membershipTs)),u=[],h,v=!1;if(d.length>0){var m=e.createNewOutboundSession();v=!0,u=s,h=m}else if(l.length>0){var f=Date.now(),g=f-e.outboundSession.creationTS;if(g<e.keyRotationGracePeriodMs){var T;(T=e.logger)===null||T===void 0||T.debug("New joiners detected, but the key is recent enough (age:".concat(g,"), keeping it")),u=l,h=e.outboundSession}else{var R;(R=e.logger)===null||R===void 0||R.debug("New joiners detected, rotating the key");var S=e.createNewOutboundSession();v=!0,u=s,h=S}}else return;try{var I,b;if((I=e.logger)===null||I===void 0||I.trace("Sending key..."),yield e.transport.sendKey(_n(h.key),h.keyId,u),e.statistics.counters.roomEventEncryptionKeysSent+=1,h.sharedWith.push(...u),(b=e.logger)===null||b===void 0||b.trace("key index:".concat(h.keyId," sent to ").concat(h.sharedWith.map(y=>"".concat(y.userId,":").concat(y.deviceId)).join(","))),v){var w,p;(w=e.logger)===null||w===void 0||w.trace("Delay Rollout for key:".concat(h.keyId,"...")),yield qi(e.useKeyDelay),(p=e.logger)===null||p===void 0||p.trace("...Delayed rollout of index:".concat(h.keyId," ")),e.addKeyToParticipantWithBackendIdentity(h.key,h.keyId,e.ownMembership,yield e.getOwnRtcBackendIdentity())}}catch(y){var E;(E=e.logger)===null||E===void 0||E.error("Failed to rollout key",y)}})()}createNewOutboundSession(){var e,t={key:this.generateRandomKey(),creationTS:Date.now(),sharedWith:[],keyId:this.nextKeyIndex()};return(e=this.logger)===null||e===void 0||e.info("creating new outbound key index:".concat(t.keyId)),this.outboundSession=t,t}nextKeyIndex(){return this.outboundSession?(this.outboundSession.keyId+1)%256:0}generateRandomKey(){var e=new Uint8Array(16);return globalThis.crypto.getRandomValues(e),e}}class rm extends Error{constructor(e){super(e)}get name(){return"NotSupportedError"}}class nm extends Ke{setParentLogger(e){this.logger=e.getChild("[ToDeviceKeyTransport]")}constructor(e,t,r,n,a){super(),this.membership=e,this.roomId=t,this.client=r,this.statistics=n,c(this,"logger",O),c(this,"onToDeviceEvent",s=>{if(s.getType()===F.CallEncryptionKeysPrefix){var o=this.getValidEventContent(s);o&&s.getSender()&&this.receiveCallKeyEvent(s.getSender(),o)}}),this.setParentLogger(a??O)}start(){this.client.on(ie.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.off(ie.ToDeviceEvent,this.onToDeviceEvent)}sendKey(e,t,r){var n=this;return _(function*(){var a={keys:{index:t,key:e},room_id:n.roomId,member:{claimed_device_id:n.membership.deviceId,id:n.membership.memberId},session:{call_id:"",application:"m.call",scope:"m.room"},sent_ts:Date.now()},s=r.map(o=>({userId:o.userId,deviceId:o.deviceId})).filter(o=>!(o.userId==n.membership.userId&&o.deviceId==n.membership.deviceId));s.length>0?(yield n.client.encryptAndSendToDevice(F.CallEncryptionKeysPrefix,s,a).catch(o=>{var d=o.message;if(d.includes("unknown variant")&&d.includes("send_to_device")||d.includes("not supported"))throw new rm("The widget driver does not support to-device encryption")}),n.statistics.counters.roomEventEncryptionKeysSent+=1):n.logger.warn("No targets found for sending key")})()}receiveCallKeyEvent(e,t){var r;this.statistics.counters.roomEventEncryptionKeysReceived+=1;var n=Date.now(),a=n-(typeof t.sent_ts=="number"?t.sent_ts:n);this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=a;var s="".concat(e,":").concat(t.member.claimed_device_id);this.emit(Pn.ReceivedKeys,{userId:e,deviceId:t.member.claimed_device_id,memberId:(r=t.member.id)!==null&&r!==void 0?r:s},t.keys.key,t.keys.index,n)}getValidEventContent(e){var t=e.getContent(),r=t.room_id;if(!r){this.logger.warn("Malformed Event: invalid call encryption keys event, no roomId");return}if(r!==this.roomId){this.logger.warn("Malformed Event: Mismatch roomId");return}if(!t.keys||!t.keys.key||typeof t.keys.index!="number"){this.logger.warn("Malformed Event: Missing keys field");return}if(!t.member||!t.member.claimed_device_id){this.logger.warn("Malformed Event: Missing claimed_device_id");return}return t}}class im extends Ke{setParentLogger(e){this.logger=e.getChild("[RoomKeyTransport]")}constructor(e,t,r,n){super(),this.room=e,this.client=t,this.statistics=r,c(this,"logger",O),this.setParentLogger(n??O)}start(){this.room.on(ne.Timeline,e=>{this.consumeCallEncryptionEvent(e)})}stop(){this.room.off(ne.Timeline,e=>{this.consumeCallEncryptionEvent(e)})}consumeCallEncryptionEvent(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;if(yield r.client.decryptEventIfNeeded(e),e.isDecryptionFailure()){n?r.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(r.logger.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout(()=>{r.consumeCallEncryptionEvent(e,!0)},1e3));return}else n&&r.logger.info("Decryption succeeded for event ".concat(e.getId()," after retry"));if(e.getType()!==F.CallEncryptionKeysPrefix)return Promise.resolve();if(!r.room)return r.logger.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();r.onEncryptionEvent(e)})()}sendKey(e,t,r){var n=this;return _(function*(){var a={keys:[{index:t,key:e}],device_id:n.client.getDeviceId(),call_id:"",sent_ts:Date.now()};try{yield n.client.sendEvent(n.room.roomId,F.CallEncryptionKeysPrefix,a)}catch(o){n.logger.error("Failed to send call encryption keys",o);var s=o;throw s.event&&n.client.cancelPendingEvent(s.event),o}})()}onEncryptionEvent(e){var t=e.getSender(),r=e.getContent(),n=r.device_id,a=r.call_id;if(!t){this.logger.warn("Received m.call.encryption_keys with no userId: callId=".concat(a));return}if(a!==""){this.logger.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(n,", callId=").concat(a));return}if(!Array.isArray(r.keys)){this.logger.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(a));return}if(t===this.client.getUserId()&&n===this.client.getDeviceId()){this.logger.info("Ignoring our own keys event");return}this.statistics.counters.roomEventEncryptionKeysReceived+=1;var s=Date.now()-(typeof r.sent_ts=="number"?r.sent_ts:e.getTs());this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=s;for(var o of r.keys){if(!o){this.logger.info("Ignoring false-y key in keys event");continue}var d=o.key,l=o.index;!d||l===void 0||l===null||a===void 0||a===null||typeof n!="string"||typeof a!="string"||typeof d!="string"||typeof l!="number"?this.logger.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(n,", encryptionKeyIndex=").concat(l," callId=").concat(a)):(this.logger.debug("onCallEncryption userId=".concat(t,":").concat(n," encryptionKeyIndex=").concat(l," age=").concat(s,"ms")),this.emit(Pn.ReceivedKeys,{userId:t,deviceId:n,memberId:"".concat(t,":").concat(n)},d,l,e.getTs()))}}}function vu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function fa(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?vu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):vu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Zt=(function(i){return i.MembershipsChanged="memberships_changed",i.JoinStateChanged="join_state_changed",i.EncryptionKeyChanged="encryption_key_changed",i.MembershipManagerError="membership_manager_error",i.DidSendCallNotification="did_send_call_notification",i})({});function am(i){var[e,t]=i.split("#");return{application:e,id:t}}function cl(i){return"".concat(i.application,"#").concat(i.id)}class ji extends Ke{get membershipStatus(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.status}get probablyLeft(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.probablyLeft}get delayId(){var e;return(e=this.membershipManager)===null||e===void 0?void 0:e.delayId}get callId(){var e;return(e=this.slotDescription)===null||e===void 0?void 0:e.id}get slotId(){return cl(this.slotDescription)}static callMembershipsForRoom(e){return O.error("[MatrixRTCSession ".concat(e.roomId,"] callMembershipsForRoom is deprecated. Use sessionMembershipsForSlot instead.")),[]}static sessionMembershipsForSlot(e,t){var r=arguments;return _(function*(){var{listenForStickyEvents:n,listenForMemberStateEvents:a}=r.length>2&&r[2]!==void 0?r[2]:{listenForStickyEvents:!0,listenForMemberStateEvents:!0},s=O.getChild("[MatrixRTCSession ".concat(e.roomId,"]")),o=[];if(n&&(o=[...e._unstable_getStickyEvents()].filter(S=>S.getType()===F.RTCMembership)),a){var d=e.getLiveTimeline().getState(te.FORWARDS);if(!d)return s.warn("Couldn't get state for room "+e.roomId+"using empty membership array"),[];var l=d.getStateEvents(F.GroupCallMemberPrefix);o=o.concat(l.filter(S=>!o.some(I=>I.getContent().msc4354_sticky_key===S.getStateKey())))}var u=[];for(var h of o){var v=h.getContent(),m=Object.keys(v).filter(S=>S!=="msc4354_sticky_key").length;if(m!==0){var f=void 0;if(m>1&&"application"in v?f=v:m===1&&"memberships"in v&&s.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),f!==void 0&&"application"in f)try{var g,T=sr.membershipDataFromMatrixEvent(h),R=new sr(h,T,yield sr.computeRtcBackendIdentity(h,T),O);if(!Qr(R.slotDescription,t)){s.info("Ignoring membership of user ".concat(R.sender," for a different slot:  ").concat(JSON.stringify(R.slotDescription)));continue}if(R.isExpired()){s.info("Ignoring expired device membership ".concat(R.sender,"/").concat(R.deviceId));continue}if(!e.hasMembershipState((g=R.sender)!==null&&g!==void 0?g:"",Se.Join)){s.info("Ignoring membership of user ".concat(R.sender," who is not in the room."));continue}u.push(R)}catch(S){s.warn("Couldn't construct call membership: ",S)}}}return u.sort((S,I)=>S.createdTs()-I.createdTs()),u.length>1&&s.debug("Call memberships in room ".concat(e.roomId,", in order: "),u.map(S=>[S.createdTs(),S.userId])),u})()}static sessionForSlot(e,t,r,n){return new ji(e,t,r,n)}get room(){return this.roomSubset}constructor(e,t,r,n){var a;super(),a=this,this.client=e,this.roomSubset=t,this.slotDescription=r,this.calculateMembershipsOpts=n,c(this,"membershipManager",void 0),c(this,"encryptionManager",void 0),c(this,"joinConfig",void 0),c(this,"logger",void 0),c(this,"pendingNotificationToSend",void 0),c(this,"expiryTimeout",void 0),c(this,"memberships",[]),c(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),c(this,"reEmitter",new qn(this)),c(this,"onRoomMemberUpdate",()=>{this.ensureRecalculateSessionMembers()}),c(this,"onStickyEventUpdate",(s,o,d)=>{[...s,...d,...o.flatMap(l=>[l.current,l.previous])].some(l=>l.getType()===F.RTCMembership)&&this.ensureRecalculateSessionMembers()}),c(this,"_onRTCSessionMemberUpdate",_(function*(){yield a.recalculateSessionMembers()})),c(this,"recalculateSessionMembersDirty",!1),c(this,"recalculateSessionMembersPromise",void 0),c(this,"recalculateSessionMembers",_(function*(){var s,o=a.memberships;a.memberships=yield ji.sessionMembershipsForSlot(a.room,a.slotDescription,a.calculateMembershipsOpts);var d=o.length!=a.memberships.length||o.some((m,f)=>!sr.equal(m,a.memberships[f]));if(d){var l,u;a.logger.info("Memberships for call in room ".concat(a.roomSubset.roomId," have changed: emitting (").concat(a.memberships.length," members)")),Cv(a.logger,"emit MatrixRTCSessionEvent.MembershipsChanged",()=>{a.emit(Zt.MembershipsChanged,o,a.memberships)}),(l=a.membershipManager)===null||l===void 0||l.onRTCSessionMemberUpdate(a.memberships);var h=(u=a.membershipManager)===null||u===void 0?void 0:u.ownMembership;if(a.pendingNotificationToSend&&h&&o.length===0){var v;h.eventId&&(v=a.joinConfig)!==null&&v!==void 0&&v.notificationType?a.sendCallNotify(h.eventId,a.joinConfig.notificationType,h.callIntent):a.logger.warn("Own membership eventId is undefined, cannot send call notification")}a.memberships.length>0&&(a.pendingNotificationToSend=void 0)}else a.logger.debug("No membership changes detected for room ".concat(a.roomSubset.roomId));(s=a.encryptionManager)===null||s===void 0||s.onMembershipsUpdate(o),a.setExpiryTimer()})),this.logger=O.getChild("[MatrixRTCSession ".concat(t.roomId,"]")),this.roomSubset.on(we.Members,this.onRoomMemberUpdate),this.roomSubset.on(yr.Update,this.onStickyEventUpdate),this.ensureRecalculateSessionMembers(),this.setExpiryTimer()}isJoined(){var e,t;return(e=(t=this.membershipManager)===null||t===void 0?void 0:t.isJoined())!==null&&e!==void 0?e:!1}stop(){var e=this;return _(function*(){var t;yield(t=e.membershipManager)===null||t===void 0?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0),e.roomSubset.off(we.Members,e.onRoomMemberUpdate),e.roomSubset.off(yr.Update,e.onStickyEventUpdate)})()}joinRTCSession(e,t,r,n){var a;if(this.isJoined()){this.logger.info("Already joined to session in room ".concat(this.roomSubset.roomId,": ignoring join call"));return}else{this.membershipManager=n!=null&&n.unstableSendStickyEvents?new ps(n,this.roomSubset,this.client,this.slotDescription,e.memberId,this.logger):new Fi(n,this.roomSubset,this.client,this.slotDescription,this.logger),this.reEmitter.reEmit(this.membershipManager,[Sn.ProbablyLeft,Sn.StatusChanged]);var s;if(n!=null&&n.useExperimentalToDeviceTransport){this.logger.info("Using experimental to-device transport for encryption keys"),this.logger.info("Using to-device with room fallback transport for encryption keys");var[o,d,l]=[this.roomSubset,this.client,this.statistics],u=new nm(e,o.roomId,d,l);this.encryptionManager=new tm(e,()=>this.memberships,u,this.statistics,(h,v,m,f)=>{this.emit(Zt.EncryptionKeyChanged,h,v,m,f)},this.logger)}else s=new im(this.roomSubset,this.client,this.statistics),this.encryptionManager=new Qp(e,()=>this.memberships,s,this.statistics,(h,v,m,f)=>{this.emit(Zt.EncryptionKeyChanged,h,v,m,f)})}this.joinConfig=n,this.pendingNotificationToSend=(a=this.joinConfig)===null||a===void 0?void 0:a.notificationType,this.membershipManager.join(t,r,h=>{this.logger.error("MembershipManager encountered an unrecoverable error: ",h),this.emit(Zt.MembershipManagerError,h),this.emit(Zt.JoinStateChanged,this.isJoined())}),this.encryptionManager.join(n),this.emit(Zt.JoinStateChanged,!0)}joinRoomSession(e,t,r){var[n,a]=[this.client.getUserId(),this.client.getDeviceId()],s="".concat(n,":").concat(a);this.joinRTCSession({userId:n,deviceId:a,memberId:s},e,t,r)}leaveRoomSession(){var e=arguments,t=this;return _(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:void 0;if(!t.isJoined())return t.logger.info("Not joined to session in room ".concat(t.roomSubset.roomId,": ignoring leave call")),!1;t.logger.info("Leaving call session in room ".concat(t.roomSubset.roomId)),t.encryptionManager.leave();var n=t.membershipManager.leave(r);return t.emit(Zt.JoinStateChanged,!1),yield n})()}getFocusInUse(){var e=this.getOldestMembership();return e?.getTransport(e)}getActiveFocus(){var e;return(e=this.getOldestMembership())===null||e===void 0?void 0:e.getFocusActive()}getOldestMembership(){return this.memberships[0]}getConsensusCallIntent(){var e,t=(e=this.memberships.find(r=>!!r.callIntent))===null||e===void 0?void 0:e.callIntent;if(t&&this.memberships.every(r=>!r.callIntent||r.callIntent===t))return t}updateCallIntent(e){var t=this;return _(function*(){var r,n,a=(r=t.membershipManager)===null||r===void 0?void 0:r.ownMembership;if(!a)throw Error("Not connected yet");yield(n=t.membershipManager)===null||n===void 0?void 0:n.updateCallIntent(e)})()}reemitEncryptionKeys(){var e;(e=this.encryptionManager)===null||e===void 0||e.getEncryptionKeys().forEach((t,r)=>{t.forEach(n=>{this.emit(Zt.EncryptionKeyChanged,n.key,n.keyIndex,n.membership,n.rtcBackendIdentity)})})}setExpiryTimer(){this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0);var e;for(var t of this.memberships){var r=t.getMsUntilExpiry();r!==void 0&&(e===void 0||r<e)&&(e=r)}e!=null&&(this.expiryTimeout=setTimeout(this.ensureRecalculateSessionMembers.bind(this),e))}sendCallNotify(e,t,r){var n=this,a=(function(){var o=_(function*(){var d={application:"m.call","m.mentions":{user_ids:[],room:!0},notify_type:t==="notification"?"notify":t,call_id:n.callId},l=yield n.client.sendEvent(n.roomSubset.roomId,F.CallNotify,d);return{response:l,content:d}});return function(){return o.apply(this,arguments)}})(),s=(function(){var o=_(function*(){var d={"m.mentions":{user_ids:[],room:!0},notification_type:t,"m.relates_to":{event_id:e,rel_type:Ue.Reference},sender_ts:Date.now(),lifetime:3e4};r&&(d["m.call.intent"]=r);var l=yield n.client.sendEvent(n.roomSubset.roomId,F.RTCNotification,d);return{response:l,content:d}});return function(){return o.apply(this,arguments)}})();Promise.all([a(),s()]).then(o=>{var[d,l]=o,u=fa(fa({},d.response),d.content),h=fa(fa({},l.response),l.content);this.emit(Zt.DidSendCallNotification,h,u)}).catch(o=>{var[d,l]=o;return this.logger.error("Failed to send call notification",d,l)})}ensureRecalculateSessionMembers(){this.recalculateSessionMembersPromise===void 0?this.recalculateSessionMembersPromise=this.recalculateSessionMembers().then(()=>{this.recalculateSessionMembersPromise=void 0,this.recalculateSessionMembersDirty&&(this.ensureRecalculateSessionMembers(),this.recalculateSessionMembersDirty=!1)}):this.recalculateSessionMembersDirty=!0}}var fu=(function(i){return i.SessionStarted="session_started",i.SessionEnded="session_ended",i})({});class sm extends Ke{constructor(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{application:"m.call",id:""};super(),this.client=t,this.slotDescription=r,c(this,"roomSessions",new Map),c(this,"logger",void 0),c(this,"onRoom",n=>{this.refreshRoom(n)}),c(this,"onEvent",n=>{if(n.unstableStickyExpiresAt&&n.getType()===F.RTCMembership){var a=this.client.getRoom(n.getRoomId());a&&this.refreshRoom(a)}}),c(this,"onRoomState",n=>{if(n.getType()===F.GroupCallMemberPrefix){var a=this.client.getRoom(n.getRoomId());if(!a){this.logger.error("Got room state event for unknown room ".concat(n.getRoomId(),"!"));return}this.refreshRoom(a)}}),this.logger=e.getChild("[MatrixRTCSessionManager]")}start(){for(var e of(t=this.client.getRooms())!==null&&t!==void 0?t:[]){var t,r=ji.sessionForSlot(this.client,e,this.slotDescription);r.memberships.length>0&&this.roomSessions.set(e.roomId,r)}this.client.on(ie.Room,this.onRoom),this.client.on(ie.Event,this.onEvent),this.client.on(we.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(ie.Room,this.onRoom),this.client.off(ie.Event,this.onEvent),this.client.off(we.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,ji.sessionForSlot(this.client,e,this.slotDescription)),this.roomSessions.get(e.roomId)}refreshRoom(e){var t=this;return _(function*(){var r=!t.roomSessions.has(e.roomId),n=t.getRoomSession(e),a=n.memberships.length>0&&!r;yield n._onRTCSessionMemberUpdate().catch(o=>{t.logger.error("Error updating RTC session members for ".concat(e.roomId,": ").concat(o))});var s=n.memberships.length>0;a&&!s?(t.logger.trace("Session ended for ".concat(e.roomId," (").concat(n.memberships.length," members)")),t.emit(fu.SessionEnded,e.roomId,t.roomSessions.get(e.roomId))):!a&&s&&(t.logger.trace("Session started for ".concat(e.roomId," (").concat(n.memberships.length," members)")),t.emit(fu.SessionStarted,e.roomId,t.roomSessions.get(e.roomId)))})()}}function Ks(i){return e=>{var t,r;return((t=e.content)===null||t===void 0||(t=t["m.relates_to"])===null||t===void 0?void 0:t.event_id)!==i||((r=e.content)===null||r===void 0||(r=r["m.relates_to"])===null||r===void 0?void 0:r.rel_type)===De.name}}class Ei extends Error{}Ei.prototype.name="InvalidTokenError";function om(i){return decodeURIComponent(atob(i).replace(/(.)/g,(e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r}))}function lm(i){let e=i.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return om(e)}catch{return atob(e)}}function mh(i,e){if(typeof i!="string")throw new Ei("Invalid token specified: must be a string");e||(e={});const t=e.header===!0?0:1,r=i.split(".")[t];if(typeof r!="string")throw new Ei(`Invalid token specified: missing part #${t+1}`);let n;try{n=lm(r)}catch(a){throw new Ei(`Invalid token specified: invalid base64 for part #${t+1} (${a.message})`)}try{return JSON.parse(n)}catch(a){throw new Ei(`Invalid token specified: invalid json for part #${t+1} (${a.message})`)}}var dm={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},Gt,Ht,Bi=(i=>(i[i.NONE=0]="NONE",i[i.ERROR=1]="ERROR",i[i.WARN=2]="WARN",i[i.INFO=3]="INFO",i[i.DEBUG=4]="DEBUG",i))(Bi||{});(i=>{function e(){Gt=3,Ht=dm}i.reset=e;function t(n){if(!(0<=n&&n<=4))throw new Error("Invalid log level");Gt=n}i.setLevel=t;function r(n){Ht=n}i.setLogger=r})(Bi||(Bi={}));var Xe=class qt{constructor(e){this._name=e}debug(...e){Gt>=4&&Ht.debug(qt._format(this._name,this._method),...e)}info(...e){Gt>=3&&Ht.info(qt._format(this._name,this._method),...e)}warn(...e){Gt>=2&&Ht.warn(qt._format(this._name,this._method),...e)}error(...e){Gt>=1&&Ht.error(qt._format(this._name,this._method),...e)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(e,t){const r=new qt(`${e}.${t}`);return r.debug("begin"),r}static _format(e,t){const r=`[${e}]`;return t?`${r} ${t}:`:r}static debug(e,...t){Gt>=4&&Ht.debug(qt._format(e),...t)}static info(e,...t){Gt>=3&&Ht.info(qt._format(e),...t)}static warn(e,...t){Gt>=2&&Ht.warn(qt._format(e),...t)}static error(e,...t){Gt>=1&&Ht.error(qt._format(e),...t)}};Bi.reset();var Wi=class{static decode(i){try{return mh(i)}catch(e){throw Xe.error("JwtUtils.decode",e),e}}static async generateSignedJwt(i,e,t){const r=ut.encodeBase64Url(new TextEncoder().encode(JSON.stringify(i))),n=ut.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),a=`${r}.${n}`,s=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},t,new TextEncoder().encode(a)),o=ut.encodeBase64Url(new Uint8Array(s));return`${a}.${o}`}static async generateSignedJwtWithHmac(i,e,t){const r=ut.encodeBase64Url(new TextEncoder().encode(JSON.stringify(i))),n=ut.encodeBase64Url(new TextEncoder().encode(JSON.stringify(e))),a=`${r}.${n}`,s=await window.crypto.subtle.sign("HMAC",t,new TextEncoder().encode(a)),o=ut.encodeBase64Url(new Uint8Array(s));return`${a}.${o}`}},um="10000000-1000-4000-8000-100000000000",Ro=i=>btoa([...new Uint8Array(i)].map(e=>String.fromCharCode(e)).join("")),gh=class Ut{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){return um.replace(/[018]/g,t=>(+t^Ut._randomWord()&15>>+t/4).toString(16)).replace(/-/g,"")}static generateCodeVerifier(){return Ut.generateUUIDv4()+Ut.generateUUIDv4()+Ut.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const r=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",r);return Ro(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw Xe.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const n=new TextEncoder().encode([e,t].join(":"));return Ro(n)}static async hash(e,t){const r=new TextEncoder().encode(t),n=await crypto.subtle.digest(e,r);return new Uint8Array(n)}static async customCalculateJwkThumbprint(e){let t;switch(e.kty){case"RSA":t={e:e.e,kty:e.kty,n:e.n};break;case"EC":t={crv:e.crv,kty:e.kty,x:e.x,y:e.y};break;case"OKP":t={crv:e.crv,kty:e.kty,x:e.x};break;case"oct":t={crv:e.k,kty:e.kty};break;default:throw new Error("Unknown jwk type")}const r=await Ut.hash("SHA-256",JSON.stringify(t));return Ut.encodeBase64Url(r)}static async generateDPoPProof({url:e,accessToken:t,httpMethod:r,keyPair:n,nonce:a}){let s,o;const d={jti:window.crypto.randomUUID(),htm:r??"GET",htu:e,iat:Math.floor(Date.now()/1e3)};t&&(s=await Ut.hash("SHA-256",t),o=Ut.encodeBase64Url(s),d.ath=o),a&&(d.nonce=a);try{const l=await crypto.subtle.exportKey("jwk",n.publicKey),u={alg:"ES256",typ:"dpop+jwt",jwk:{crv:l.crv,kty:l.kty,x:l.x,y:l.y}};return await Wi.generateSignedJwt(u,d,n.privateKey)}catch(l){throw l instanceof TypeError?new Error(`Error exporting dpop public key: ${l.message}`):l}}static async generateDPoPJkt(e){try{const t=await crypto.subtle.exportKey("jwk",e.publicKey);return await Ut.customCalculateJwkThumbprint(t)}catch(t){throw t instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${t.message}`):t}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}static async generateClientAssertionJwt(e,t,r,n="HS256"){const a=Math.floor(Date.now()/1e3),s={alg:n,typ:"JWT"},o={iss:e,sub:e,aud:r,jti:Ut.generateUUIDv4(),exp:a+300,iat:a},l={HS256:"SHA-256",HS384:"SHA-384",HS512:"SHA-512"}[n];if(!l)throw new Error(`Unsupported algorithm: ${n}. Supported algorithms are: HS256, HS384, HS512`);const u=new TextEncoder,h=await crypto.subtle.importKey("raw",u.encode(t),{name:"HMAC",hash:l},!1,["sign"]);return await Wi.generateSignedJwtWithHmac(s,o,h)}};gh.encodeBase64Url=i=>Ro(i).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var ut=gh,cm=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new Xe(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},Ha=class Ra extends cm{constructor(){super(...arguments),this._logger=new Xe(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const e=this._expiration-Ra.getEpochTime();this._logger.debug("timer completes in",e),this._expiration<=Ra.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(e){const t=this._logger.create("init");e=Math.max(Math.floor(e),1);const r=Ra.getEpochTime()+e;if(this.expiration===r&&this._timerHandle){t.debug("skipping since already initialized for expiration at",this.expiration);return}this.cancel(),t.debug("using duration",e),this._expiration=r;const n=Math.min(e,5);this._timerHandle=setInterval(this._callback,n*1e3)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},pu=class{static readParams(i,e="query"){if(!i)throw new TypeError("Invalid URL");const r=new URL(i,"http://127.0.0.1")[e==="fragment"?"hash":"search"];return new URLSearchParams(r.slice(1))}},An=";",Dn=class extends Error{constructor(i,e){var t,r,n;if(super(i.error_description||i.error||""),this.form=e,this.name="ErrorResponse",!i.error)throw Xe.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=i.error,this.error_description=(t=i.error_description)!=null?t:null,this.error_uri=(r=i.error_uri)!=null?r:null,this.state=i.userState,this.session_state=(n=i.session_state)!=null?n:null,this.url_state=i.url_state}},hm=class extends Error{constructor(i){super(i),this.name="ErrorTimeout"}},vm=class{constructor(){this._logger=new Xe("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(i){return this._logger.create(`getItem('${i}')`),this._data[i]}setItem(i,e){this._logger.create(`setItem('${i}')`),this._data[i]=e}removeItem(i){this._logger.create(`removeItem('${i}')`),delete this._data[i]}get length(){return Object.getOwnPropertyNames(this._data).length}key(i){return Object.getOwnPropertyNames(this._data)[i]}},To=class extends Error{constructor(i,e){super(e),this.name="ErrorDPoPNonce",this.nonce=i}},hl=class{constructor(i=[],e=null,t={}){this._jwtHandler=e,this._extraHeaders=t,this._logger=new Xe("JsonService"),this._contentTypes=[],this._contentTypes.push(...i,"application/json"),e&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(i,e={}){const{timeoutInSeconds:t,...r}=e;if(!t)return await fetch(i,r);const n=new AbortController,a=setTimeout(()=>n.abort(),t*1e3);try{return await fetch(i,{...e,signal:n.signal})}catch(s){throw s instanceof DOMException&&s.name==="AbortError"?new hm("Network timed out"):s}finally{clearTimeout(a)}}async getJson(i,{token:e,credentials:t,timeoutInSeconds:r}={}){const n=this._logger.create("getJson"),a={Accept:this._contentTypes.join(", ")};e&&(n.debug("token passed, setting Authorization header"),a.Authorization="Bearer "+e),this._appendExtraHeaders(a);let s;try{n.debug("url:",i),s=await this.fetchWithTimeout(i,{method:"GET",headers:a,timeoutInSeconds:r,credentials:t})}catch(l){throw n.error("Network Error"),l}n.debug("HTTP response received, status",s.status);const o=s.headers.get("Content-Type");if(o&&!this._contentTypes.find(l=>o.startsWith(l))&&n.throw(new Error(`Invalid response Content-Type: ${o??"undefined"}, from URL: ${i}`)),s.ok&&this._jwtHandler&&o?.startsWith("application/jwt"))return await this._jwtHandler(await s.text());let d;try{d=await s.json()}catch(l){throw n.error("Error parsing JSON response",l),s.ok?l:new Error(`${s.statusText} (${s.status})`)}if(!s.ok)throw n.error("Error from server:",d),d.error?new Dn(d):new Error(`${s.statusText} (${s.status}): ${JSON.stringify(d)}`);return d}async postForm(i,{body:e,basicAuth:t,timeoutInSeconds:r,initCredentials:n,extraHeaders:a}){const s=this._logger.create("postForm"),o={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...a};t!==void 0&&(o.Authorization="Basic "+t),this._appendExtraHeaders(o);let d;try{s.debug("url:",i),d=await this.fetchWithTimeout(i,{method:"POST",headers:o,body:e,timeoutInSeconds:r,credentials:n})}catch(v){throw s.error("Network error"),v}s.debug("HTTP response received, status",d.status);const l=d.headers.get("Content-Type");if(l&&!this._contentTypes.find(v=>l.startsWith(v)))throw new Error(`Invalid response Content-Type: ${l??"undefined"}, from URL: ${i}`);const u=await d.text();let h={};if(u)try{h=JSON.parse(u)}catch(v){throw s.error("Error parsing JSON response",v),d.ok?v:new Error(`${d.statusText} (${d.status})`)}if(!d.ok){if(s.error("Error from server:",h),d.headers.has("dpop-nonce")){const v=d.headers.get("dpop-nonce");throw new To(v,`${JSON.stringify(h)}`)}throw h.error?new Dn(h,e):new Error(`${d.statusText} (${d.status}): ${JSON.stringify(h)}`)}return h}_appendExtraHeaders(i){const e=this._logger.create("appendExtraHeaders"),t=Object.keys(this._extraHeaders),r=["accept","content-type"],n=["authorization"];t.length!==0&&t.forEach(a=>{if(r.includes(a.toLocaleLowerCase())){e.warn("Protected header could not be set",a,r);return}if(n.includes(a.toLocaleLowerCase())&&Object.keys(i).includes(a)){e.warn("Header could not be overridden",a,n);return}const s=typeof this._extraHeaders[a]=="function"?this._extraHeaders[a]():this._extraHeaders[a];s&&s!==""&&(i[a]=s)})}},yh=class{constructor(i){this._settings=i,this._logger=new Xe("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new hl(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const i=this._logger.create("getMetadata");if(this._metadata)return i.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw i.throw(new Error("No authority or metadataUrl configured on settings")),null;i.debug("getting metadata from",this._metadataUrl);const e=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return i.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},e,this._settings.metadataSeed),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(i=!0){return this._getMetadataProperty("token_endpoint",i)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(i=!0){return this._getMetadataProperty("revocation_endpoint",i)}getKeysEndpoint(i=!0){return this._getMetadataProperty("jwks_uri",i)}async _getMetadataProperty(i,e=!1){const t=this._logger.create(`_getMetadataProperty('${i}')`),r=await this.getMetadata();if(t.debug("resolved"),r[i]===void 0){if(e===!0){t.warn("Metadata does not contain optional property");return}t.throw(new Error("Metadata does not contain property "+i))}return r[i]}async getSigningKeys(){const i=this._logger.create("getSigningKeys");if(this._signingKeys)return i.debug("returning signingKeys from cache"),this._signingKeys;const e=await this.getKeysEndpoint(!1);i.debug("got jwks_uri",e);const t=await this._jsonService.getJson(e,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(i.debug("got key set",t),!Array.isArray(t.keys))throw i.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=t.keys,this._signingKeys}},ms=class{constructor({prefix:i="oidc.",store:e=localStorage}={}){this._logger=new Xe("WebStorageStateStore"),this._store=e,this._prefix=i}async set(i,e){this._logger.create(`set('${i}')`),i=this._prefix+i,await this._store.setItem(i,e)}async get(i){return this._logger.create(`get('${i}')`),i=this._prefix+i,await this._store.getItem(i)}async remove(i){this._logger.create(`remove('${i}')`),i=this._prefix+i;const e=await this._store.getItem(i);return await this._store.removeItem(i),e}async getAllKeys(){this._logger.create("getAllKeys");const i=await this._store.length,e=[];for(let t=0;t<i;t++){const r=await this._store.key(t);r&&r.indexOf(this._prefix)===0&&e.push(r.substr(this._prefix.length))}return e}},fm="code",pm="openid",mm="client_secret_post",gm=900,Io=class{constructor({authority:i,metadataUrl:e,metadata:t,signingKeys:r,metadataSeed:n,client_id:a,client_secret:s,response_type:o=fm,scope:d=pm,redirect_uri:l,post_logout_redirect_uri:u,client_authentication:h=mm,token_endpoint_auth_signing_alg:v="HS256",prompt:m,display:f,max_age:g,ui_locales:T,acr_values:R,resource:S,response_mode:I,filterProtocolClaims:b=!0,loadUserInfo:w=!1,requestTimeoutInSeconds:p,staleStateAgeInSeconds:E=gm,mergeClaimsStrategy:y={array:"replace"},disablePKCE:P=!1,stateStore:N,revokeTokenAdditionalContentTypes:V,fetchRequestCredentials:Q,refreshTokenAllowedScope:le,extraQueryParams:Ae={},extraTokenParams:$={},extraHeaders:ae={},dpop:se,omitScopeWhenRequesting:de=!1}){var ve;if(this.authority=i,e?this.metadataUrl=e:(this.metadataUrl=i,i&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=t,this.metadataSeed=n,this.signingKeys=r,this.client_id=a,this.client_secret=s,this.response_type=o,this.scope=d,this.redirect_uri=l,this.post_logout_redirect_uri=u,this.client_authentication=h,this.token_endpoint_auth_signing_alg=v,this.prompt=m,this.display=f,this.max_age=g,this.ui_locales=T,this.acr_values=R,this.resource=S,this.response_mode=I,this.filterProtocolClaims=b??!0,this.loadUserInfo=!!w,this.staleStateAgeInSeconds=E,this.mergeClaimsStrategy=y,this.omitScopeWhenRequesting=de,this.disablePKCE=!!P,this.revokeTokenAdditionalContentTypes=V,this.fetchRequestCredentials=Q||"same-origin",this.requestTimeoutInSeconds=p,N)this.stateStore=N;else{const Re=typeof window<"u"?window.localStorage:new vm;this.stateStore=new ms({store:Re})}if(this.refreshTokenAllowedScope=le,this.extraQueryParams=Ae,this.extraTokenParams=$,this.extraHeaders=ae,this.dpop=se,this.dpop&&!((ve=this.dpop)!=null&&ve.store))throw new Error("A DPoPStore is required when dpop is enabled")}},ym=class{constructor(i,e){this._settings=i,this._metadataService=e,this._logger=new Xe("UserInfoService"),this._getClaimsFromJwt=async t=>{const r=this._logger.create("_getClaimsFromJwt");try{const n=Wi.decode(t);return r.debug("JWT decoding successful"),n}catch(n){throw r.error("Error parsing JWT response"),n}},this._jsonService=new hl(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(i){const e=this._logger.create("getClaims");i||this._logger.throw(new Error("No token passed"));const t=await this._metadataService.getUserInfoEndpoint();e.debug("got userinfo url",t);const r=await this._jsonService.getJson(t,{token:i,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("got claims",r),r}},Sh=class{constructor(i,e){this._settings=i,this._metadataService=e,this._logger=new Xe("TokenClient"),this._jsonService=new hl(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:i="authorization_code",redirect_uri:e=this._settings.redirect_uri,client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,extraHeaders:n,...a}){const s=this._logger.create("exchangeCode");t||s.throw(new Error("A client_id is required")),e||s.throw(new Error("A redirect_uri is required")),a.code||s.throw(new Error("A code is required"));const o=new URLSearchParams({grant_type:i,redirect_uri:e});for(const[h,v]of Object.entries(a))v!=null&&o.set(h,v);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&r==null)throw s.throw(new Error("A client_secret is required")),null;let d;const l=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":d=ut.generateBasicAuth(t,r);break;case"client_secret_post":o.append("client_id",t),r&&o.append("client_secret",r);break;case"client_secret_jwt":{const h=await ut.generateClientAssertionJwt(t,r,l,this._settings.token_endpoint_auth_signing_alg);o.append("client_id",t),o.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),o.append("client_assertion",h);break}}s.debug("got token endpoint");const u=await this._jsonService.postForm(l,{body:o,basicAuth:d,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:n});return s.debug("got response"),u}async exchangeCredentials({grant_type:i="password",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,scope:r=this._settings.scope,...n}){const a=this._logger.create("exchangeCredentials");e||a.throw(new Error("A client_id is required"));const s=new URLSearchParams({grant_type:i});this._settings.omitScopeWhenRequesting||s.set("scope",r);for(const[u,h]of Object.entries(n))h!=null&&s.set(u,h);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&t==null)throw a.throw(new Error("A client_secret is required")),null;let o;const d=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":o=ut.generateBasicAuth(e,t);break;case"client_secret_post":s.append("client_id",e),t&&s.append("client_secret",t);break;case"client_secret_jwt":{const u=await ut.generateClientAssertionJwt(e,t,d,this._settings.token_endpoint_auth_signing_alg);s.append("client_id",e),s.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),s.append("client_assertion",u);break}}a.debug("got token endpoint");const l=await this._jsonService.postForm(d,{body:s,basicAuth:o,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return a.debug("got response"),l}async exchangeRefreshToken({grant_type:i="refresh_token",client_id:e=this._settings.client_id,client_secret:t=this._settings.client_secret,timeoutInSeconds:r,extraHeaders:n,...a}){const s=this._logger.create("exchangeRefreshToken");e||s.throw(new Error("A client_id is required")),a.refresh_token||s.throw(new Error("A refresh_token is required"));const o=new URLSearchParams({grant_type:i});for(const[h,v]of Object.entries(a))Array.isArray(v)?v.forEach(m=>o.append(h,m)):v!=null&&o.set(h,v);if((this._settings.client_authentication==="client_secret_basic"||this._settings.client_authentication==="client_secret_jwt")&&t==null)throw s.throw(new Error("A client_secret is required")),null;let d;const l=await this._metadataService.getTokenEndpoint(!1);switch(this._settings.client_authentication){case"client_secret_basic":d=ut.generateBasicAuth(e,t);break;case"client_secret_post":o.append("client_id",e),t&&o.append("client_secret",t);break;case"client_secret_jwt":{const h=await ut.generateClientAssertionJwt(e,t,l,this._settings.token_endpoint_auth_signing_alg);o.append("client_id",e),o.append("client_assertion_type","urn:ietf:params:oauth:client-assertion-type:jwt-bearer"),o.append("client_assertion",h);break}}s.debug("got token endpoint");const u=await this._jsonService.postForm(l,{body:o,basicAuth:d,timeoutInSeconds:r,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:n});return s.debug("got response"),u}async revoke(i){var e;const t=this._logger.create("revoke");i.token||t.throw(new Error("A token is required"));const r=await this._metadataService.getRevocationEndpoint(!1);t.debug(`got revocation endpoint, revoking ${(e=i.token_type_hint)!=null?e:"default token type"}`);const n=new URLSearchParams;for(const[a,s]of Object.entries(i))s!=null&&n.set(a,s);n.set("client_id",this._settings.client_id),this._settings.client_secret&&n.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(r,{body:n,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),t.debug("got response")}},Sm=class{constructor(i,e,t){this._settings=i,this._metadataService=e,this._claimsService=t,this._logger=new Xe("ResponseValidator"),this._userInfoService=new ym(this._settings,this._metadataService),this._tokenClient=new Sh(this._settings,this._metadataService)}async validateSigninResponse(i,e,t){const r=this._logger.create("validateSigninResponse");this._processSigninState(i,e),r.debug("state processed"),await this._processCode(i,e,t),r.debug("code processed"),i.isOpenId&&this._validateIdTokenAttributes(i),r.debug("tokens validated"),await this._processClaims(i,e?.skipUserInfo,i.isOpenId),r.debug("claims processed")}async validateCredentialsResponse(i,e){const t=this._logger.create("validateCredentialsResponse"),r=i.isOpenId&&!!i.id_token;r&&this._validateIdTokenAttributes(i),t.debug("tokens validated"),await this._processClaims(i,e,r),t.debug("claims processed")}async validateRefreshResponse(i,e){var t,r;const n=this._logger.create("validateRefreshResponse");i.userState=e.data,(t=i.session_state)!=null||(i.session_state=e.session_state),(r=i.scope)!=null||(i.scope=e.scope),i.isOpenId&&i.id_token&&(this._validateIdTokenAttributes(i,e.id_token),n.debug("ID Token validated")),i.id_token||(i.id_token=e.id_token,i.profile=e.profile);const a=i.isOpenId&&!!i.id_token;await this._processClaims(i,!1,a),n.debug("claims processed")}validateSignoutResponse(i,e){const t=this._logger.create("validateSignoutResponse");if(e.id!==i.state&&t.throw(new Error("State does not match")),t.debug("state validated"),i.userState=e.data,i.error)throw t.warn("Response was error",i.error),new Dn(i)}_processSigninState(i,e){var t;const r=this._logger.create("_processSigninState");if(e.id!==i.state&&r.throw(new Error("State does not match")),e.client_id||r.throw(new Error("No client_id on state")),e.authority||r.throw(new Error("No authority on state")),this._settings.authority!==e.authority&&r.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==e.client_id&&r.throw(new Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),i.userState=e.data,i.url_state=e.url_state,(t=i.scope)!=null||(i.scope=e.scope),i.error)throw r.warn("Response was error",i.error),new Dn(i);e.code_verifier&&!i.code&&r.throw(new Error("Expected code in response"))}async _processClaims(i,e=!1,t=!0){const r=this._logger.create("_processClaims");if(i.profile=this._claimsService.filterProtocolClaims(i.profile),e||!this._settings.loadUserInfo||!i.access_token){r.debug("not loading user info");return}r.debug("loading user info");const n=await this._userInfoService.getClaims(i.access_token);r.debug("user info claims received from user info endpoint"),t&&n.sub!==i.profile.sub&&r.throw(new Error("subject from UserInfo response does not match subject in ID Token")),i.profile=this._claimsService.mergeClaims(i.profile,this._claimsService.filterProtocolClaims(n)),r.debug("user info claims received, updated profile:",i.profile)}async _processCode(i,e,t){const r=this._logger.create("_processCode");if(i.code){r.debug("Validating code");const n=await this._tokenClient.exchangeCode({client_id:e.client_id,client_secret:e.client_secret,code:i.code,redirect_uri:e.redirect_uri,code_verifier:e.code_verifier,extraHeaders:t,...e.extraTokenParams});Object.assign(i,n)}else r.debug("No code to process")}_validateIdTokenAttributes(i,e){var t;const r=this._logger.create("_validateIdTokenAttributes");r.debug("decoding ID Token JWT");const n=Wi.decode((t=i.id_token)!=null?t:"");if(n.sub||r.throw(new Error("ID Token is missing a subject claim")),e){const a=Wi.decode(e);n.sub!==a.sub&&r.throw(new Error("sub in id_token does not match current sub")),n.auth_time&&n.auth_time!==a.auth_time&&r.throw(new Error("auth_time in id_token does not match original auth_time")),n.azp&&n.azp!==a.azp&&r.throw(new Error("azp in id_token does not match original azp")),!n.azp&&a.azp&&r.throw(new Error("azp not in id_token, but present in original id_token"))}i.profile=n}},$a=class Co{constructor(e){this.id=e.id||ut.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=Ha.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new Xe("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(e){return Xe.createStatic("State","fromStorageString"),Promise.resolve(new Co(JSON.parse(e)))}static async clearStaleState(e,t){const r=Xe.createStatic("State","clearStaleState"),n=Ha.getEpochTime()-t,a=await e.getAllKeys();r.debug("got keys",a);for(let s=0;s<a.length;s++){const o=a[s],d=await e.get(o);let l=!1;if(d)try{const u=await Co.fromStorageString(d);r.debug("got item from key:",o,u.created),u.created<=n&&(l=!0)}catch(u){r.error("Error parsing state for key:",o,u),l=!0}else r.debug("no item in storage for key:",o),l=!0;l&&(r.debug("removed item for key:",o),e.remove(o))}}},vl=class Oo extends $a{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(e){const t=e.code_verifier===!0?ut.generateCodeVerifier():e.code_verifier||void 0,r=t?await ut.generateCodeChallenge(t):void 0;return new Oo({...e,code_verifier:t,code_challenge:r})}toStorageString(){return new Xe("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(e){Xe.createStatic("SigninState","fromStorageString");const t=JSON.parse(e);return Oo.create(t)}},bh=class Eh{constructor(e){this.url=e.url,this.state=e.state}static async create({url:e,authority:t,client_id:r,redirect_uri:n,response_type:a,scope:s,state_data:o,response_mode:d,request_type:l,client_secret:u,nonce:h,url_state:v,resource:m,skipUserInfo:f,extraQueryParams:g,extraTokenParams:T,disablePKCE:R,dpopJkt:S,omitScopeWhenRequesting:I,...b}){if(!e)throw this._logger.error("create: No url passed"),new Error("url");if(!r)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!n)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!a)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!s)throw this._logger.error("create: No scope passed"),new Error("scope");if(!t)throw this._logger.error("create: No authority passed"),new Error("authority");const w=await vl.create({data:o,request_type:l,url_state:v,code_verifier:!R,client_id:r,authority:t,redirect_uri:n,response_mode:d,client_secret:u,scope:s,extraTokenParams:T,skipUserInfo:f}),p=new URL(e);p.searchParams.append("client_id",r),p.searchParams.append("redirect_uri",n),p.searchParams.append("response_type",a),I||p.searchParams.append("scope",s),h&&p.searchParams.append("nonce",h),S&&p.searchParams.append("dpop_jkt",S);let E=w.id;v&&(E=`${E}${An}${v}`),p.searchParams.append("state",E),w.code_challenge&&(p.searchParams.append("code_challenge",w.code_challenge),p.searchParams.append("code_challenge_method","S256")),m&&(Array.isArray(m)?m:[m]).forEach(P=>p.searchParams.append("resource",P));for(const[y,P]of Object.entries({response_mode:d,...b,...g}))P!=null&&p.searchParams.append(y,P.toString());return new Eh({url:p.href,state:w})}};bh._logger=new Xe("SigninRequest");var bm=bh,Em="openid",Ta=class{constructor(i){if(this.access_token="",this.token_type="",this.profile={},this.state=i.get("state"),this.session_state=i.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(An);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(An))}this.error=i.get("error"),this.error_description=i.get("error_description"),this.error_uri=i.get("error_uri"),this.code=i.get("code")}get expires_in(){if(this.expires_at!==void 0)return this.expires_at-Ha.getEpochTime()}set expires_in(i){typeof i=="string"&&(i=Number(i)),i!==void 0&&i>=0&&(this.expires_at=Math.floor(i)+Ha.getEpochTime())}get isOpenId(){var i;return((i=this.scope)==null?void 0:i.split(" ").includes(Em))||!!this.id_token}},_m=class{constructor({url:i,state_data:e,id_token_hint:t,post_logout_redirect_uri:r,extraQueryParams:n,request_type:a,client_id:s,url_state:o}){if(this._logger=new Xe("SignoutRequest"),!i)throw this._logger.error("ctor: No url passed"),new Error("url");const d=new URL(i);if(t&&d.searchParams.append("id_token_hint",t),s&&d.searchParams.append("client_id",s),r&&(d.searchParams.append("post_logout_redirect_uri",r),e||o)){this.state=new $a({data:e,request_type:a,url_state:o});let l=this.state.id;o&&(l=`${l}${An}${o}`),d.searchParams.append("state",l)}for(const[l,u]of Object.entries({...n}))u!=null&&d.searchParams.append(l,u.toString());this.url=d.href}},wm=class{constructor(i){if(this.state=i.get("state"),this.state){const e=decodeURIComponent(this.state).split(An);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(An))}this.error=i.get("error"),this.error_description=i.get("error_description"),this.error_uri=i.get("error_uri")}},Rm=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],Tm=["sub","iss","aud","exp","iat"],Im=class{constructor(i){this._settings=i,this._logger=new Xe("ClaimsService")}filterProtocolClaims(i){const e={...i};if(this._settings.filterProtocolClaims){let t;Array.isArray(this._settings.filterProtocolClaims)?t=this._settings.filterProtocolClaims:t=Rm;for(const r of t)Tm.includes(r)||delete e[r]}return e}mergeClaims(i,e){const t={...i};for(const[r,n]of Object.entries(e))if(t[r]!==n)if(Array.isArray(t[r])||Array.isArray(n))if(this._settings.mergeClaimsStrategy.array=="replace")t[r]=n;else{const a=Array.isArray(t[r])?t[r]:[t[r]];for(const s of Array.isArray(n)?n:[n])a.includes(s)||a.push(s);t[r]=a}else typeof t[r]=="object"&&typeof n=="object"?t[r]=this.mergeClaims(t[r],n):t[r]=n;return t}},Cm=class{constructor(i,e){this.keys=i,this.nonce=e}},fl=class{constructor(i,e){this._logger=new Xe("OidcClient"),this.settings=i instanceof Io?i:new Io(i),this.metadataService=e??new yh(this.settings),this._claimsService=new Im(this.settings),this._validator=new Sm(this.settings,this.metadataService,this._claimsService),this._tokenClient=new Sh(this.settings,this.metadataService)}async createSigninRequest({state:i,request:e,request_uri:t,request_type:r,id_token_hint:n,login_hint:a,skipUserInfo:s,nonce:o,url_state:d,response_type:l=this.settings.response_type,scope:u=this.settings.scope,redirect_uri:h=this.settings.redirect_uri,prompt:v=this.settings.prompt,display:m=this.settings.display,max_age:f=this.settings.max_age,ui_locales:g=this.settings.ui_locales,acr_values:T=this.settings.acr_values,resource:R=this.settings.resource,response_mode:S=this.settings.response_mode,extraQueryParams:I=this.settings.extraQueryParams,extraTokenParams:b=this.settings.extraTokenParams,dpopJkt:w,omitScopeWhenRequesting:p=this.settings.omitScopeWhenRequesting}){const E=this._logger.create("createSigninRequest");if(l!=="code")throw new Error("Only the Authorization Code flow (with PKCE) is supported");const y=await this.metadataService.getAuthorizationEndpoint();E.debug("Received authorization endpoint",y);const P=await bm.create({url:y,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:h,response_type:l,scope:u,state_data:i,url_state:d,prompt:v,display:m,max_age:f,ui_locales:g,id_token_hint:n,login_hint:a,acr_values:T,dpopJkt:w,resource:R,request:e,request_uri:t,extraQueryParams:I,extraTokenParams:b,request_type:r,response_mode:S,client_secret:this.settings.client_secret,skipUserInfo:s,nonce:o,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:p});await this.clearStaleState();const N=P.state;return await this.settings.stateStore.set(N.id,N.toStorageString()),P}async readSigninResponseState(i,e=!1){const t=this._logger.create("readSigninResponseState"),r=new Ta(pu.readParams(i,this.settings.response_mode));if(!r.state)throw t.throw(new Error("No state in response")),null;const n=await this.settings.stateStore[e?"remove":"get"](r.state);if(!n)throw t.throw(new Error("No matching state found in storage")),null;return{state:await vl.fromStorageString(n),response:r}}async processSigninResponse(i,e,t=!0){const r=this._logger.create("processSigninResponse"),{state:n,response:a}=await this.readSigninResponseState(i,t);if(r.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const s=await this.getDpopProof(this.settings.dpop.store);e={...e,DPoP:s}}try{await this._validator.validateSigninResponse(a,n,e)}catch(s){if(s instanceof To&&this.settings.dpop){const o=await this.getDpopProof(this.settings.dpop.store,s.nonce);e.DPoP=o,await this._validator.validateSigninResponse(a,n,e)}else throw s}return a}async getDpopProof(i,e){let t,r;return(await i.getAllKeys()).includes(this.settings.client_id)?(r=await i.get(this.settings.client_id),r.nonce!==e&&e&&(r.nonce=e,await i.set(this.settings.client_id,r))):(t=await ut.generateDPoPKeys(),r=new Cm(t,e),await i.set(this.settings.client_id,r)),await ut.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:r.keys,nonce:r.nonce})}async processResourceOwnerPasswordCredentials({username:i,password:e,skipUserInfo:t=!1,extraTokenParams:r={}}){const n=await this._tokenClient.exchangeCredentials({username:i,password:e,...r}),a=new Ta(new URLSearchParams);return Object.assign(a,n),await this._validator.validateCredentialsResponse(a,t),a}async useRefreshToken({state:i,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,extraTokenParams:a}){var s;const o=this._logger.create("useRefreshToken");let d;if(this.settings.refreshTokenAllowedScope===void 0)d=i.scope;else{const h=this.settings.refreshTokenAllowedScope.split(" ");d=(((s=i.scope)==null?void 0:s.split(" "))||[]).filter(m=>h.includes(m)).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const h=await this.getDpopProof(this.settings.dpop.store);n={...n,DPoP:h}}let l;try{l=await this._tokenClient.exchangeRefreshToken({refresh_token:i.refresh_token,scope:d,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,...a})}catch(h){if(h instanceof To&&this.settings.dpop)n.DPoP=await this.getDpopProof(this.settings.dpop.store,h.nonce),l=await this._tokenClient.exchangeRefreshToken({refresh_token:i.refresh_token,scope:d,redirect_uri:e,resource:t,timeoutInSeconds:r,extraHeaders:n,...a});else throw h}const u=new Ta(new URLSearchParams);return Object.assign(u,l),o.debug("validating response",u),await this._validator.validateRefreshResponse(u,{...i,scope:d}),u}async createSignoutRequest({state:i,id_token_hint:e,client_id:t,request_type:r,url_state:n,post_logout_redirect_uri:a=this.settings.post_logout_redirect_uri,extraQueryParams:s=this.settings.extraQueryParams}={}){const o=this._logger.create("createSignoutRequest"),d=await this.metadataService.getEndSessionEndpoint();if(!d)throw o.throw(new Error("No end session endpoint")),null;o.debug("Received end session endpoint",d),!t&&a&&!e&&(t=this.settings.client_id);const l=new _m({url:d,id_token_hint:e,client_id:t,post_logout_redirect_uri:a,state_data:i,extraQueryParams:s,request_type:r,url_state:n});await this.clearStaleState();const u=l.state;return u&&(o.debug("Signout request has state to persist"),await this.settings.stateStore.set(u.id,u.toStorageString())),l}async readSignoutResponseState(i,e=!1){const t=this._logger.create("readSignoutResponseState"),r=new wm(pu.readParams(i,this.settings.response_mode));if(!r.state){if(t.debug("No state in response"),r.error)throw t.warn("Response was error:",r.error),new Dn(r);return{state:void 0,response:r}}const n=await this.settings.stateStore[e?"remove":"get"](r.state);if(!n)throw t.throw(new Error("No matching state found in storage")),null;return{state:await $a.fromStorageString(n),response:r}}async processSignoutResponse(i){const e=this._logger.create("processSignoutResponse"),{state:t,response:r}=await this.readSignoutResponseState(i,!0);return t?(e.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(r,t)):e.debug("No state from storage; skipping response validation"),r}clearStaleState(){return this._logger.create("clearStaleState"),$a.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(i,e){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:i,token_type_hint:e})}},ct=(function(i){return i.NotSupported="OIDC authentication not supported",i.Misconfigured="OIDC is misconfigured",i.General="Something went wrong with OIDC discovery",i.OpSupport="Configured OIDC OP does not support required functions",i.DynamicRegistrationNotSupported="Dynamic registration not supported",i.DynamicRegistrationFailed="Dynamic registration failed",i.DynamicRegistrationInvalid="Dynamic registration invalid response",i.CodeExchangeFailed="Failed to exchange code for token",i.InvalidBearerTokenResponse="Invalid bearer token response",i.InvalidIdToken="Invalid ID token",i.MissingOrInvalidStoredState="State required to finish logging in is not found in storage.",i})({}),pl=i=>!!i&&typeof i=="object"&&!Array.isArray(i),or=(i,e)=>!i[e]||!Ci(i,e)?(O.error("Missing or invalid property: ".concat(e)),!1):!0,Ci=(i,e)=>i[e]&&typeof i[e]!="string"?(O.error("Invalid property: ".concat(e)),!1):!0,mu=(i,e)=>i[e]&&(!Array.isArray(i[e])||!i[e].every(t=>typeof t=="string"))?(O.error("Invalid property: ".concat(e)),!1):!0,qs=(i,e,t)=>{var r=i[e];return!r||!Array.isArray(r)||!r.includes(t)?(O.error("Invalid property: ".concat(e,". ").concat(t," is required.")),!1):!0},ml=i=>{if(!pl(i))throw O.error("Issuer configuration not found or malformed"),new Error(ct.OpSupport);var e=[or(i,"issuer"),or(i,"authorization_endpoint"),or(i,"token_endpoint"),or(i,"revocation_endpoint"),Ci(i,"registration_endpoint"),Ci(i,"account_management_uri"),Ci(i,"device_authorization_endpoint"),mu(i,"account_management_actions_supported"),qs(i,"response_types_supported","code"),qs(i,"grant_types_supported","authorization_code"),qs(i,"code_challenge_methods_supported","S256"),mu(i,"prompt_values_supported")].some(t=>!t);if(!e)return i;throw O.error("Issuer configuration not valid"),new Error(ct.OpSupport)},gl=i=>{try{return mh(i)}catch(e){throw O.error("Could not decode id_token",e),e}},yl=(i,e,t,r)=>{try{if(!i)throw new Error("No ID token");var n=gl(i);if(n.iss!==e)throw new Error("Invalid issuer");var a=typeof n.aud=="string"?[n.aud]:n.aud;if(!a.includes(t))throw new Error("Invalid audience");if(r!==void 0&&n.nonce!==r)throw new Error("Invalid nonce");if(!n.exp||Date.now()>n.exp*1e3)throw new Error("Invalid expiry")}catch(s){throw O.error("Invalid ID token",s),new Error(ct.InvalidIdToken)}};function Sl(i){if(!pl(i))throw O.error("Stored user state not found"),new Error(ct.MissingOrInvalidStoredState);var e=[or(i,"homeserverUrl"),or(i,"nonce"),Ci(i,"identityServerUrl")].some(t=>!t);if(e)throw new Error(ct.MissingOrInvalidStoredState)}var Om=i=>pl(i)&&or(i,"token_type")&&i.token_type.toLowerCase()==="bearer"&&or(i,"access_token")&&or(i,"refresh_token")&&(!("expires_in"in i)||typeof i.expires_in=="number");function bl(i){if(!Om(i))throw new Error(ct.InvalidBearerTokenResponse)}function gu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Ja(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?gu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):gu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Zi=i=>{var e=i??wr(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(e)},km=(function(){var i=_(function*(e){if(!globalThis.crypto.subtle)return O.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield ul(e);return Vn(t)});return function(t){return i.apply(this,arguments)}})(),_h=i=>{var{redirectUri:e}=i;return{scope:Zi(),redirectUri:e,state:wr(8),nonce:wr(8),codeVerifier:wr(64)}},wh=(function(){var i=_(function*(e,t,r){var{scope:n,redirectUri:a,state:s,nonce:o,codeVerifier:d}=r,l=new URL(e);return l.searchParams.append("response_mode","query"),l.searchParams.append("response_type","code"),l.searchParams.append("redirect_uri",a),l.searchParams.append("client_id",t),l.searchParams.append("state",s),l.searchParams.append("scope",n),l.searchParams.append("nonce",o),l.searchParams.append("code_challenge_method","S256"),l.searchParams.append("code_challenge",yield km(d)),l.toString()});return function(t,r,n){return i.apply(this,arguments)}})(),Rh=(function(){var i=_(function*(e){var{metadata:t,redirectUri:r,clientId:n,homeserverUrl:a,identityServerUrl:s,nonce:o,prompt:d,urlState:l,loginHint:u}=e,h=Zi(),v=new fl(Ja(Ja({},t),{},{client_id:n,redirect_uri:r,authority:t.issuer,response_mode:"query",response_type:"code",scope:h,stateStore:new ms({prefix:"mx_oidc_",store:window.sessionStorage})})),m={homeserverUrl:a,nonce:o,identityServerUrl:s},f=yield v.createSigninRequest({state:m,nonce:o,prompt:d,url_state:l,login_hint:u});return f.url});return function(t){return i.apply(this,arguments)}})(),Mm=i=>({id_token:i.id_token,scope:i.scope,expires_at:i.expires_at,refresh_token:i.refresh_token,access_token:i.access_token,token_type:"Bearer"}),Th=(function(){var i=_(function*(e,t){var r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),Bi.setLogger(O);try{var n=new Ta(r.searchParams),a=new ms({prefix:"mx_oidc_",store:window.sessionStorage}),s=yield a.get(n.state);if(!s)throw new Error(ct.MissingOrInvalidStoredState);var o=yield vl.fromStorageString(s),d=new fl(Ja(Ja({},o),{},{stateStore:a})),l=yield d.processSigninResponse(r.href),u=l.userState;Sl(u),bl(l),yl(l.id_token,d.settings.authority,d.settings.client_id,u.nonce);var h=Mm(l);return{oidcClientSettings:{clientId:d.settings.client_id,issuer:d.settings.authority},tokenResponse:h,homeserverUrl:u.homeserverUrl,identityServerUrl:u.identityServerUrl,idTokenClaims:l.profile}}catch(m){O.error("Oidc login failed",m);var v=m.message;throw Object.values(ct).includes(v)?m:new Error(ct.CodeExchangeFailed)}});return function(t,r){return i.apply(this,arguments)}})();function yu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Su(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?yu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):yu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var gs=(function(){var i=_(function*(e){var t=new URL(".well-known/openid-configuration",e),r=yield fetch(t,{method:W.Get,signal:Ji(5e3)}),n=yield r.json();return ys(n)});return function(t){return i.apply(this,arguments)}})(),ys=(function(){var i=_(function*(e){var t=ml(e),r=new Io({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),n=new yh(r);return Su(Su({},t),{},{signingKeys:yield n.getSigningKeys()})});return function(t){return i.apply(this,arguments)}})(),Ih="urn:ietf:params:oauth:grant-type:device_code",Vs=(i,e)=>{if(!e)return!1;var t=new URL(e);return!(t.protocol!==i.protocol||t.hostname!==i.hostname&&!t.hostname.endsWith(".".concat(i.hostname)))},Ch=(function(){var i=_(function*(e,t){if(!e.registration_endpoint)throw new Error(ct.DynamicRegistrationNotSupported);var r=["authorization_code","refresh_token"];if(r.some(u=>!e.grant_types_supported.includes(u)))throw new Error(ct.DynamicRegistrationNotSupported);var n=new URL(t.clientUri),a={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:r,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,contacts:t.contacts,logo_uri:Vs(n,t.logoUri)?t.logoUri:void 0,policy_uri:Vs(n,t.policyUri)?t.policyUri:void 0,tos_uri:Vs(n,t.tosUri)?t.tosUri:void 0},s={Accept:"application/json","Content-Type":"application/json"};try{var o=yield fetch(e.registration_endpoint,{method:W.Post,headers:s,body:JSON.stringify(a)});if(o.status>=400)throw new Error(ct.DynamicRegistrationFailed);var d=yield o.json(),l=d.client_id;if(!l||typeof l!="string")throw new Error(ct.DynamicRegistrationInvalid);return l}catch(u){throw Object.values(ct).includes(u.message)?u:(O.error("Dynamic registration request failed",u),new Error(ct.DynamicRegistrationFailed))}});return function(t,r){return i.apply(this,arguments)}})();class Oh{constructor(e,t,r,n,a){this.issuer=e,this.clientId=t,this.redirectUri=r,this.deviceId=n,this.idTokenClaims=a,c(this,"oidcClientReady",void 0),c(this,"initPromise",void 0),c(this,"oidcClient",void 0),c(this,"inflightRefreshRequest",void 0),this.oidcClientReady=Promise.resolve()}ensureInit(){var e=this;return _(function*(){if(!e.oidcClient){if(e.initPromise)return e.initPromise;e.initPromise=e.initialiseOidcClient(e.issuer,e.clientId,e.deviceId,e.redirectUri);try{yield e.initPromise}finally{e.initPromise=void 0}}})()}initialiseOidcClient(e,t,r,n){var a=this;return _(function*(){try{var s,o=yield gs(e),d=Zi(r);a.oidcClient=new fl({metadata:o,signingKeys:(s=o.signingKeys)!==null&&s!==void 0?s:void 0,client_id:t,scope:d,redirect_uri:n,authority:o.issuer,stateStore:new ms({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(l){throw O.error("Failed to initialise OIDC client.",l),new Error("Failed to initialise OIDC client.")}})()}doRefreshAccessToken(e){var t=this;return _(function*(){yield t.ensureInit(),t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var r=yield t.inflightRefreshRequest;return r}catch(n){throw n instanceof Dn?new ss(n):n}finally{t.inflightRefreshRequest=void 0}})()}persistTokens(e){return _(function*(){})()}getNewTokens(e){var t=this;return _(function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var r={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},n=Date.now(),a=yield t.oidcClient.useRefreshToken({state:r,timeoutInSeconds:300}),s={accessToken:a.access_token,refreshToken:a.refresh_token,expiry:a.expires_in?new Date(n+a.expires_in*1e3):void 0};return yield t.persistTokens(s),s})()}}var Pm=["server","limit","since"];function bu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function qe(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?bu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):bu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var Am=3e3,Eu=600*1e3,kh=new Qe("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),en=(function(i){return i.Chronological="chronological",i.Detached="detached",i})({}),Mh=new Nn("m.get_login_token","org.matrix.msc3882.get_login_token"),El="uk.half-shot.msc2666",_l="uk.half-shot.msc2666.mutual_rooms",wl="uk.half-shot.msc2666.query_mutual_rooms",ot="org.matrix.msc4140",za="org.matrix.msc4354",Rl="uk.tcpip.msc4133",Tl="uk.tcpip.msc4133.stable",Kt="$",ie=(function(i){return i.Sync="sync",i.Event="event",i.ToDeviceEvent="toDeviceEvent",i.ReceivedToDeviceMessage="receivedToDeviceMessage",i.AccountData="accountData",i.Room="Room",i.DeleteRoom="deleteRoom",i.SyncUnexpectedError="sync.unexpectedError",i.ClientWellKnown="WellKnown.client",i.ReceivedVoipEvent="received_voip_event",i.TurnServers="turnServers",i.TurnServersError="turnServers.error",i})({}),Dm=new Qe("action","org.matrix.msc3824.action");class ea extends Ke{constructor(e){var t,r,n,a,s,o;super(),n=this,c(this,"logger",void 0),c(this,"reEmitter",new qn(this)),c(this,"olmVersion",null),c(this,"usingExternalCrypto",!1),c(this,"_store",void 0),c(this,"deviceId",void 0),c(this,"credentials",void 0),c(this,"legacyPickleKey",void 0),c(this,"scheduler",void 0),c(this,"clientRunning",!1),c(this,"timelineSupport",!1),c(this,"urlPreviewCache",{}),c(this,"identityServer",void 0),c(this,"http",void 0),c(this,"cryptoBackend",void 0),c(this,"enableEncryptedStateEvents",void 0),c(this,"cryptoCallbacks",void 0),c(this,"callEventHandler",void 0),c(this,"groupCallEventHandler",void 0),c(this,"supportsCallTransfer",!1),c(this,"forceTURN",!1),c(this,"iceCandidatePoolSize",0),c(this,"idBaseUrl",void 0),c(this,"baseUrl",void 0),c(this,"isVoipWithNoMediaAllowed",void 0),c(this,"disableVoip",void 0),c(this,"useLivekitForGroupCalls",void 0),c(this,"canSupportVoip",!1),c(this,"peekSync",null),c(this,"isGuestAccount",!1),c(this,"ongoingScrollbacks",{}),c(this,"notifTimelineSet",null),c(this,"legacyCryptoStore",void 0),c(this,"verificationMethods",void 0),c(this,"fallbackICEServerAllowed",!1),c(this,"syncApi",void 0),c(this,"roomNameGenerator",void 0),c(this,"pushRules",void 0),c(this,"syncLeftRoomsPromise",void 0),c(this,"syncedLeftRooms",!1),c(this,"clientOpts",void 0),c(this,"clientWellKnownIntervalID",void 0),c(this,"canResetTimelineCallback",void 0),c(this,"canSupport",new Map),c(this,"pushProcessor",new Ft(this)),c(this,"serverVersionsPromise",void 0),c(this,"clientWellKnown",void 0),c(this,"clientWellKnownPromise",void 0),c(this,"turnServers",[]),c(this,"turnServersExpiry",0),c(this,"checkTurnServersIntervalID",void 0),c(this,"txnCtr",0),c(this,"mediaHandler",new Mp(this)),c(this,"sessionId",void 0),c(this,"eventsBeingEncrypted",new Set),c(this,"useE2eForGroupCall",!0),c(this,"toDeviceMessageQueue",void 0),c(this,"livekitServiceURL",void 0),c(this,"_secretStorage",void 0),c(this,"ignoredInvites",void 0),c(this,"matrixRTC",void 0),c(this,"serverCapabilitiesService",void 0),c(this,"startCallEventHandler",()=>{this.isInitialSyncComplete()&&(po()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(ie.Sync,this.startCallEventHandler))}),c(this,"startMatrixRTC",()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(ie.Sync,this.startMatrixRTC))}),c(this,"fixupRoomNotifications",()=>{if(this.isInitialSyncComplete()){var l,u=((l=this.getRooms())!==null&&l!==void 0?l:[]).filter(m=>m.getUnreadNotificationCount(ke.Total)>0);for(var h of u){var v=this.getSafeUserId();h.fixupNotifications(v)}this.off(ie.Sync,this.fixupRoomNotifications)}}),this.logger=(t=e.logger)!==null&&t!==void 0?t:O,e.baseUrl=Is(e.baseUrl),e.idBaseUrl=Is(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=(r=e.usingExternalCrypto)!==null&&r!==void 0?r:!1,this.store=e.store||new xf,this.deviceId=e.deviceId||null,this.sessionId=wr(10);var d=e.userId||null;this.credentials={userId:d},this.http=new Qo(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:$e.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.pickleKey&&(this.legacyPickleKey=e.pickleKey),this.useLivekitForGroupCalls=!!e.useLivekitForGroupCalls,this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((function(){var l=_(function*(u){var h=n.getRoom(u.getRoomId());u.status!==pe.SENDING&&n.updatePendingEventStatus(h,u,pe.SENDING);var v=yield n.sendEventHttpRequest(u);return h&&h.updatePendingEvent(u,pe.SENT,v.event_id),v});return function(u){return l.apply(this,arguments)}})()),this.disableVoip=(a=e.disableVoip)!==null&&a!==void 0?a:!1,!this.disableVoip&&po()&&(this.callEventHandler=new ip(this),this.groupCallEventHandler=new ap(this),this.canSupportVoip=!0,this.on(ie.Sync,this.startCallEventHandler)),this.matrixRTC=new sm(this.logger,this),this.serverCapabilitiesService=new el(this.logger,this.http),this.on(ie.Sync,this.fixupRoomNotifications),this.timelineSupport=!!e.timelineSupport,this.legacyCryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.enableEncryptedStateEvents=(s=e.enableEncryptedStateEvents)!==null&&s!==void 0?s:!1,this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=e.iceCandidatePoolSize===void 0?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,e.useE2eForGroupCall!==void 0&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new Fp(this,this.logger),this.on(Me.Decrypted,l=>{Il(this,l)}),this.ignoredInvites=new jp(this),this._secretStorage=new ch(this,(o=e.cryptoCallbacks)!==null&&o!==void 0?o:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator(t=>Yt.createUser(t,this))}get store(){return this._store}startClient(e){var t=this;return _(function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(ie.Sync,t.startMatrixRTC);var r=t.getUserId();r&&t.store.storeUser(new Yt(r)),t.supportsVoip()&&(t.checkTurnServersIntervalID=setInterval(()=>{t.checkTurnServers()},Eu),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:n,list:a,fwdPagination:s}=yield t.doesServerSupportThread();xe.setServerSideSupport(n),xe.setServerSideListSupport(a),xe.setServerSideFwdPaginationSupport(s)}catch(o){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",o)}t.clientOpts=e??{},t.clientOpts.slidingSync?t.syncApi=new oh(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new br(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch(o=>t.logger.info("Sync startup aborted with an error:",o)),t.clientOpts.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}})()}buildSyncApiOptions(){return{cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>this.canResetTimelineCallback?this.canResetTimelineCallback(e):!1,logger:this.logger.getChild("sync")}}stopClient(){var e,t,r,n,a;(e=this.cryptoBackend)===null||e===void 0||e.stop(),this.off(ie.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,(t=this.syncApi)===null||t===void 0||t.stop(),this.syncApi=void 0,(r=this.peekSync)===null||r===void 0||r.stopPeeking(),(n=this.callEventHandler)===null||n===void 0||n.stop(),(a=this.groupCallEventHandler)===null||a===void 0||a.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,this.clientWellKnownIntervalID!==void 0&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}clearStores(){var e=this,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var r=[];r.push(this.store.deleteAllData()),this.legacyCryptoStore&&r.push(this.legacyCryptoStore.deleteAllData());var n=(function(){var a=_(function*(){var s;try{if(s=globalThis.indexedDB,!s)return}catch{return}var o=function*(v){var m=new Promise((f,g)=>{e.logger.info("Removing IndexedDB instance ".concat(v));var T=s.deleteDatabase(v);T.onsuccess=R=>{e.logger.info("Removed IndexedDB instance ".concat(v)),f(0)},T.onerror=R=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(v,":"),R),f(0)},T.onblocked=R=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(v))}});yield m};for(var d of["".concat((l=t.cryptoDatabasePrefix)!==null&&l!==void 0?l:js,"::matrix-sdk-crypto"),"".concat((u=t.cryptoDatabasePrefix)!==null&&u!==void 0?u:js,"::matrix-sdk-crypto-meta")]){var l,u;yield*o(d)}});return function(){return a.apply(this,arguments)}})();return r.push(n()),Promise.all(r).then()}getUserId(){var e,t;return(e=(t=this.credentials)===null||t===void 0?void 0:t.userId)!==null&&e!==void 0?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return(e=this.credentials)!==null&&e!==void 0&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return(e=(t=this.credentials)===null||t===void 0||(t=t.userId)===null||t===void 0?void 0:t.split(":")[0].substring(1))!==null&&e!==void 0?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return!this.disableVoip&&this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return kn(this,e)}createGroupCall(e,t,r,n,a,s){var o=this;return _(function*(){if(o.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var d=o.getRoom(e);if(!d)throw new Error("Cannot find room ".concat(e));return new ls(o,d,t,r,n,void 0,a||o.isVoipWithNoMediaAllowed,s,o.isVoipWithNoMediaAllowed,o.useLivekitForGroupCalls,o.livekitServiceURL).create()})()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return(e=(t=this.syncApi)===null||t===void 0?void 0:t.getSyncState())!==null&&e!==void 0?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return e?e===Pe.Prepared||e===Pe.Syncing:!1}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),(e=(t=this.syncApi)===null||t===void 0?void 0:t.retryImmediately())!==null&&e!==void 0?e:!1}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return _(function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()})()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initRustCrypto(){var e=arguments,t=this;return _(function*(){var r,n,a=e.length>0&&e[0]!==void 0?e[0]:{};if(t.cryptoBackend){t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");return}var s=t.getUserId();if(s===null)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var o=t.getDeviceId();if(o===null)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var d=yield lv(()=>import("./index-BKOyEJqU.js"),[]),l=yield d.initRustCrypto({logger:t.logger,http:t.http,userId:s,deviceId:o,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:a.useIndexedDB===!1?null:(r=a.cryptoDatabasePrefix)!==null&&r!==void 0?r:js,storeKey:a.storageKey,storePassphrase:a.storagePassword,legacyCryptoStore:t.legacyCryptoStore,legacyPickleKey:(n=t.legacyPickleKey)!==null&&n!==void 0?n:"DEFAULT_KEY",legacyMigrationProgressListener:(u,h)=>{t.emit(st.LegacyCryptoStoreMigrationProgress,u,h)},enableEncryptedStateEvents:t.enableEncryptedStateEvents});l.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=l,t.on(pt.Membership,l.onRoomMembership.bind(l)),t.on(ie.Event,u=>{l.onLiveEventFromSync(u)}),t.reEmitter.reEmit(l,[st.VerificationRequestReceived,st.UserTrustStatusChanged,st.KeyBackupStatus,st.KeyBackupSessionsRemaining,st.KeyBackupFailed,st.KeyBackupDecryptionKeyCached,st.KeysChanged,st.DevicesUpdated,st.WillUpdateDevices,st.DehydratedDeviceCreated,st.DehydratedDeviceUploaded,st.RehydrationStarted,st.RehydrationProgress,st.RehydrationCompleted,st.RehydrationError,st.DehydrationKeyCached,st.DehydratedDeviceRotationError])})()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isRoomEncrypted(e){var t=this.getRoom(e);return t?t.hasEncryptionStateEvent():!1}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}makeKeyBackupPath(e,t,r){var n;t!==void 0?n=Z("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):e!==void 0?n=Z("/room_keys/keys/$roomId",{$roomId:e}):n="/room_keys/keys";var a=r===void 0?void 0:{version:r};return{path:n,queryData:a}}deleteKeysFromBackup(e,t,r){var n=this;return _(function*(){var a=n.makeKeyBackupPath(e,t,r);yield n.http.authedRequest(W.Delete,a.path,a.queryData,void 0,{prefix:$e.V3})})()}getMediaConfig(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=e?"/media/config":"/config";return this.http.authedRequest(W.Get,t,void 0,void 0,{prefix:e?$e.V1:Jr.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=this.store.getRooms(),r=new Set(t);for(var n of r){var a=this.findPredecessorRooms(n,!0,e);for(var s of a)r.delete(s)}return Array.from(r)}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var r=this;return _(function*(){if(!r.clientRunning)return r.logger.warn("Calling `setAccountData` before the client is started: `getAccountData` may return inconsistent results."),yield ja(5,()=>r.setAccountDataRaw(e,t));var n=r.store.getAccountData(e);if(n&&Qr(n.event.content,t))return{};var a=Promise.withResolvers();function s(d){d.getType()===e&&a.resolve()}r.addListener(ie.AccountData,s);try{var o=yield ja(5,()=>r.setAccountDataRaw(e,t));return yield a.promise,o}finally{r.removeListener(ie.AccountData,s)}})()}setAccountDataRaw(e,t){var r=Z("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this.http.authedRequest(W.Put,r,void 0,t)}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return _(function*(){if(t.isInitialSyncComplete()){var r=t.store.getAccountData(e);return r?r.getContent():null}var n=Z("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(W.Get,n)}catch(s){var a;if(((a=s.data)===null||a===void 0?void 0:a.errcode)==="M_NOT_FOUND")return null;throw s}})()}deleteAccountData(e){var t=this;return _(function*(){var r=t.canSupport.get(nt.AccountDataDeletion);if(r===tt.Unsupported){yield t.setAccountData(e,{});return}var n=Z("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),a=r===tt.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(W.Delete,n,void 0,void 0,a)})()}getIgnoredUsers(){var e=this.getAccountData(F.IgnoredUserList);return e!=null&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach(r=>{t.ignored_users[r]={}}),this.setAccountData(F.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,r=this;return _(function*(){var n,a,s=t.length>1&&t[1]!==void 0?t[1]:{},o=r.getRoom(e),d=o?.getMember(r.getSafeUserId()),l=d?.membership,u=l==Se.Invite&&(n=d==null||(a=d.events.member)===null||a===void 0?void 0:a.getSender())!==null&&n!==void 0?n:null;if(r.logger.debug("joinRoom[".concat(e,"]: preJoinMembership=").concat(l,", inviter=").concat(u,", opts=").concat(JSON.stringify(s))),l==Se.Join)return o;var h=Promise.resolve();if(s.inviteSignUrl){var v=new URL(s.inviteSignUrl);v.searchParams.set("mxid",r.credentials.userId),h=r.http.requestOtherUrl(W.Post,v)}var m={};s.viaServers&&(m.via=m.server_name=s.viaServers.slice(0,3));var f={},g=yield h;g&&(f.third_party_signed=g);var T=Z("/join/$roomid",{$roomid:e}),R=yield r.http.authedRequest(W.Post,T,m,f),S=R.room_id;if(s.acceptSharedHistory&&u&&r.cryptoBackend){var I=yield r.cryptoBackend.maybeAcceptKeyBundle(S,u);I||r.cryptoBackend.markRoomAsPendingKeyBundle(S,u)}var b=r.getRoom(S);if(b!=null&&b.hasMembershipState(r.credentials.userId,Se.Join))return b;var w=new br(r,r.clientOpts,r.buildSyncApiOptions());return w.createRoom(S)})()}knockRoom(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=this.getRoom(e);if(r!=null&&r.hasMembershipState(this.credentials.userId,Se.Knock))return Promise.resolve({room_id:r.roomId});var n=Z("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),a={};if(t.viaServers){var s=Array.isArray(t.viaServers)?t.viaServers.slice(0,3):[t.viaServers];a.server_name=s,a.via=s}var o={};return t.reason&&(o.reason=t.reason),this.http.authedRequest(W.Post,n,a,o)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,pe.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![pe.QUEUED,pe.NOT_SENT,pe.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===pe.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===pe.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,pe.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,F.RoomName,{name:t})}setRoomTopic(e,t,r){var n=Fc(t,r);return this.sendStateEvent(e,F.RoomTopic,n)}getRoomTags(e){var t=Z("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(W.Get,t)}setRoomTag(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=Z("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(W.Put,n,void 0,r)}deleteRoomTag(e,t){var r=Z("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(W.Delete,r)}setRoomAccountData(e,t,r){var n=Z("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(W.Put,n,void 0,r)}setPowerLevel(e,t,r){var n=this;return _(function*(){var a,s;if(n.clientRunning&&n.isInitialSyncComplete()){var o;s=(o=n.getRoom(e))===null||o===void 0||(o=o.currentState)===null||o===void 0||(o=o.getStateEvents(F.RoomPowerLevels,""))===null||o===void 0?void 0:o.getContent()}if(!s)try{s=yield n.getStateEvent(e,F.RoomPowerLevels,"")}catch(u){if(u instanceof Fe&&u.errcode==="M_NOT_FOUND")s={};else throw u}s=Ki(s),(a=s)!==null&&a!==void 0&&a.users||(s.users={});var d=Array.isArray(t)?t:[t];for(var l of d)r==null?delete s.users[l]:s.users[l]=r;return n.sendStateEvent(e,F.RoomPowerLevels,s,"")})()}unstable_createLiveBeacon(e,t){var r=this;return _(function*(){return r.unstable_setLiveBeacon(e,t)})()}unstable_setLiveBeacon(e,t){var r=this;return _(function*(){return r.sendStateEvent(e,hs.name,t,r.getUserId())})()}sendEvent(e,t,r,n,a){var s,o,d,l;return!(t!=null&&t.startsWith(Kt))&&t!==null?(l=n,d=r,o=t,s=null):(l=a,d=n,o=r,s=t),this.addThreadRelationIfNeeded(d,s,e),this.sendCompleteEvent({roomId:e,threadId:s,eventObject:{type:o,content:d},txnId:l})}addThreadRelationIfNeeded(e,t,r){var n;if(t&&!((n=e["m.relates_to"])!==null&&n!==void 0&&n.rel_type)){var a,s,o=!!((a=e["m.relates_to"])!==null&&a!==void 0&&a["m.in_reply_to"]);e["m.relates_to"]=qe(qe({},e["m.relates_to"]),{},{rel_type:De.name,event_id:t,is_falling_back:!o});var d=(s=this.getRoom(r))===null||s===void 0?void 0:s.getThread(t);if(d&&!o){var l,u;e["m.relates_to"]["m.in_reply_to"]={event_id:(l=(u=d.lastReply(h=>h.isRelation(De.name)&&!h.status))===null||u===void 0?void 0:u.getId())!==null&&l!==void 0?l:t}}}}sendCompleteEvent(e){var{roomId:t,threadId:r,eventObject:n,delayOpts:a,queryDict:s,txnId:o}=e;o||(o=this.makeTxnId());var d=new at(Object.assign(n,{event_id:"~"+t+":"+o,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:t,origin_server_ts:new Date().getTime()})),l=this.getRoom(t),u=r?l?.getThread(r):void 0;u&&d.setThread(u),a||(this.reEmitter.reEmit(d,[Me.Replaced,Me.VisibilityChange]),l?.reEmitter.reEmit(d,[Me.BeforeRedaction]));var h=d.getAssociatedId();if(h!=null&&h.startsWith("~")){var v=l?.getPendingEvents().find(f=>f.getId()===h);v?.once(Me.LocalEventIdReplaced,()=>{d.updateAssociatedId(v.getId())})}var m=d.getType();return this.logger.debug("sendEvent of type ".concat(m," in ").concat(t," with txnId ").concat(o).concat(a?" (delayed event)":"").concat(s?" query params: "+JSON.stringify(s):"")),d.setTxnId(o),d.setStatus(pe.SENDING),a?this.encryptAndSendEvent(l,d,a,s):(l?.addPendingEvent(d,o),d.status===pe.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(l,d,s))}encryptAndSendEvent(e,t,r,n){var a=this;return _(function*(){var s=n;if(r&&Ka(r))return a.sendEventHttpRequest(t,r,s);s||(s=r);try{var o;a.eventsBeingEncrypted.add(t.getId());try{yield a.encryptEventIfNeeded(t,e??void 0)}finally{o=!a.eventsBeingEncrypted.delete(t.getId())}if(o)return{};t.status===pe.ENCRYPTING&&a.updatePendingEventStatus(e,t,pe.SENDING);var d=null;return a.scheduler&&(d=a.scheduler.queueEvent(t),d&&a.scheduler.getQueueForEvent(t).length>1&&a.updatePendingEventStatus(e,t,pe.QUEUED)),d||(d=a.sendEventHttpRequest(t,s),e&&(d=d.then(l=>(e.updatePendingEvent(t,pe.SENT,l.event_id),l)))),yield d}catch(l){a.logger.error("Error sending event",l);try{t.error=l,a.updatePendingEventStatus(e,t,pe.NOT_SENT)}catch(u){a.logger.error("Exception in error handler!",u)}throw l instanceof Fe&&(l.event=t),l}})()}encryptEventIfNeeded(e,t){var r=this;return _(function*(){if(t&&(yield r.shouldEncryptEventForRoom(e,t))&&!(!r.cryptoBackend&&r.usingExternalCrypto)){if(!r.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");r.updatePendingEventStatus(t,e,pe.ENCRYPTING),yield r.cryptoBackend.encryptEvent(e,t)}})()}shouldEncryptEventForRoom(e,t){var r=this;return _(function*(){var n;return e.isEncrypted()||e.getType()===F.Reaction||e.isRedaction()?!1:!!(t.hasEncryptionStateEvent()||(yield(n=r.cryptoBackend)===null||n===void 0?void 0:n.isEncryptionEnabledInRoom(t.roomId)))})()}getEncryptedIfNeededEventType(e,t){var r;return t===F.Reaction?t:(r=this.getRoom(e))!==null&&r!==void 0&&r.hasEncryptionStateEvent()?F.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e,t,r){var n=e.getTxnId();n||(n=this.makeTxnId(),e.setTxnId(n));var a={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:n},s;if(e.isState()){var o="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(o="/rooms/$roomId/state/$eventType/$stateKey"),s=Z(o,a)}else if(e.isRedaction()&&e.event.redacts){var d="/rooms/$roomId/redact/$redactsEventId/$txnId";s=Z(d,qe({$redactsEventId:e.event.redacts},a))}else s=Z("/rooms/$roomId/send/$eventType/$txnId",a);var l=t&&Ka(t)?t:void 0,u=l?r:t,h=e.getWireContent();return l?this.http.authedRequest(W.Put,s,qe(qe({},_u(l)),u),h):this.http.authedRequest(W.Put,s,u,h).then(v=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(v.event_id)),v))}redactEvent(e,t,r,n,a){var s,o,d;(s=r)!==null&&s!==void 0&&s.startsWith(Kt)||(a=n,n=r,r=t,t=null);var l=(o=a)===null||o===void 0?void 0:o.reason,u={reason:l};if(((d=a)===null||d===void 0?void 0:d.with_rel_types)!==void 0){if(this.canSupport.get(nt.RelationBasedRedactions)===tt.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(r," txnId: ").concat(n," threadId ").concat(t));var h=this.canSupport.get(nt.RelationBasedRedactions)===tt.Stable?La.stable:La.unstable;u[h]=a.with_rel_types}return this.sendCompleteEvent({roomId:e,threadId:t,eventObject:{type:F.RoomRedaction,content:u,redacts:r},txnId:n})}sendMessage(e,t,r,n){typeof t!="string"&&t!==null&&(n=r,r=t,t=null);var a=F.RoomMessage,s=r;return this.sendEvent(e,t,a,s,n)}sendTextMessage(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Kt))&&t!==null&&(n=r,r=t,t=null);var s=Dc(r);return this.sendMessage(e,t,s,n)}sendNotice(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Kt))&&t!==null&&(n=r,r=t,t=null);var s=Lc(r);return this.sendMessage(e,t,s,n)}sendEmoteMessage(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Kt))&&t!==null&&(n=r,r=t,t=null);var s=Uc(r);return this.sendMessage(e,t,s,n)}sendImageMessage(e,t,r,n){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Image";!((a=t)!==null&&a!==void 0&&a.startsWith(Kt))&&t!==null&&(s=n||"Image",n=r,r=t,t=null);var o={msgtype:Wt.Image,url:r,info:n,body:s};return this.sendMessage(e,t,o)}sendStickerMessage(e,t,r,n){var a,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:"Sticker";!((a=t)!==null&&a!==void 0&&a.startsWith(Kt))&&t!==null&&(s=n||"Sticker",n=r,r=t,t=null);var o={url:r,info:n,body:s};return this.sendEvent(e,t,F.Sticker,o)}sendHtmlMessage(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Kt))&&t!==null&&(n=r,r=t,t=null);var s=Mc(r,n);return this.sendMessage(e,t,s)}sendHtmlNotice(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Kt))&&t!==null&&(n=r,r=t,t=null);var s=Pc(r,n);return this.sendMessage(e,t,s)}sendHtmlEmote(e,t,r,n){var a;!((a=t)!==null&&a!==void 0&&a.startsWith(Kt))&&t!==null&&(n=r,r=t,t=null);var s=Ac(r,n);return this.sendMessage(e,t,s)}_unstable_sendDelayedEvent(e,t,r,n,a,s){var o=this;return _(function*(){if(!(yield o.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","sendDelayedEvent");return o.addThreadRelationIfNeeded(a,r,e),o.sendCompleteEvent({roomId:e,threadId:r,eventObject:{type:n,content:a},delayOpts:t,txnId:s})})()}_unstable_sendStickyDelayedEvent(e,t,r,n,a,s,o){var d=this;return _(function*(){if(!(yield d.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","getDelayedEvents");if(!(yield d.doesServerSupportUnstableFeature(za)))throw new Ga("Server does not support the sticky events","sendStickyEvent");return d.addThreadRelationIfNeeded(s,n,e),d.sendCompleteEvent({roomId:e,threadId:n,eventObject:{type:a,content:s},queryDict:{"org.matrix.msc4354.sticky_duration_ms":t},delayOpts:r,txnId:o})})()}_unstable_sendDelayedStateEvent(e,t,r,n){var a=arguments,s=this;return _(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:"",d=a.length>5&&a[5]!==void 0?a[5]:{};if(!(yield s.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","sendDelayedStateEvent");var l={$roomId:e,$eventType:r,$stateKey:o},u=Z("/rooms/$roomId/state/$eventType",l);return o!==void 0&&(u=Z(u+"/$stateKey",l)),s.http.authedRequest(W.Put,u,_u(t),n,d)})()}_unstable_sendStickyEvent(e,t,r,n,a,s){var o=this;return _(function*(){if(!(yield o.doesServerSupportUnstableFeature(za)))throw new Ga("Server does not support the sticky events","sendStickyEvent");return o.addThreadRelationIfNeeded(a,r,e),o.sendCompleteEvent({roomId:e,threadId:r,eventObject:{type:n,content:a},queryDict:{"org.matrix.msc4354.sticky_duration_ms":t},txnId:s})})()}_unstable_getDelayedEvents(e,t,r){var n=this;return _(function*(){if(!(yield n.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","getDelayedEvents");var a={from:r,status:e,delay_id:t};return yield n.http.authedRequest(W.Get,"/delayed_events",a,void 0,{prefix:"".concat($e.Unstable,"/").concat(ot)})})()}_unstable_updateDelayedEvent(e,t){var r=arguments,n=this;return _(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:{};if(!(yield n.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","updateDelayedEvent");return yield n.updateScheduledDelayedEventWithActionInBody(e,t,a)})()}_unstable_cancelScheduledDelayedEvent(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};return yield r.updateScheduledDelayedEvent(e,Rr.Cancel,n)})()}_unstable_restartScheduledDelayedEvent(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};return yield r.updateScheduledDelayedEvent(e,Rr.Restart,n)})()}_unstable_sendScheduledDelayedEvent(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};return yield r.updateScheduledDelayedEvent(e,Rr.Send,n)})()}updateScheduledDelayedEvent(e,t){var r=arguments,n=this;return _(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:{};if(!(yield n.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","".concat(t,"ScheduledDelayedEvent"));try{var s=Z("/delayed_events/$delayId/$action",{$delayId:e,$action:t});return yield n.http.request(W.Post,s,void 0,void 0,qe(qe({},a),{},{prefix:"".concat($e.Unstable,"/").concat(ot)}))}catch(o){if(o instanceof Fe&&o.errcode==="M_UNRECOGNIZED")return yield n.updateScheduledDelayedEventWithActionInBody(e,t,a);throw o}})()}updateScheduledDelayedEventWithActionInBody(e,t){var r=arguments,n=this;return _(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:{},s=Z("/delayed_events/$delayId",{$delayId:e}),o={action:t};try{return yield n.http.request(W.Post,s,void 0,o,qe(qe({},a),{},{prefix:"".concat($e.Unstable,"/").concat(ot)}))}catch(d){if(d instanceof Fe&&d.errcode==="M_MISSING_TOKEN")return yield n.http.authedRequest(W.Post,s,void 0,o,qe(qe({},a),{},{prefix:"".concat($e.Unstable,"/").concat(ot)}));throw d}})()}sendReceipt(e,t,r){var n=arguments,a=this;return _(function*(){var s=n.length>3&&n[3]!==void 0?n[3]:!1;if(a.isGuest())return Promise.resolve({});var o=Z("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),d=!s&&a.supportsThreads(),l=d?qe(qe({},r),{},{thread_id:tn(e)}):r,u=a.http.authedRequest(W.Post,o,void 0,l||{}),h=a.getRoom(e.getRoomId());return h&&a.credentials.userId&&h.addLocalEchoReceipt(a.credentials.userId,e,t,s),u})()}sendReadReceipt(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:ht.Read,a=t.length>2&&t[2]!==void 0?t[2]:!1;if(e){var s=e.getId(),o=r.getRoom(e.getRoomId());if(o!=null&&o.hasPendingEvent(s))throw new Error("Cannot set read receipt to a pending event (".concat(s,")"));return r.sendReceipt(e,n,{},a)}})()}setRoomReadMarkers(e,t,r,n){var a=this;return _(function*(){var s=a.getRoom(e);if(s!=null&&s.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));var o;if(r){if(o=r.getId(),s!=null&&s.hasPendingEvent(o))throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));s?.addLocalEchoReceipt(a.credentials.userId,r,ht.Read)}var d;if(n){if(d=n.getId(),s!=null&&s.hasPendingEvent(d))throw new Error("Cannot set read receipt to a pending event (".concat(d,")"));s?.addLocalEchoReceipt(a.credentials.userId,n,ht.ReadPrivate)}return yield a.setRoomReadMarkersHttpRequest(e,t,o,d)})()}sendRtcDecline(e,t){return this.sendEvent(e,F.RTCDecline,{"m.relates_to":{event_id:t,rel_type:Ue.Reference}})}getUrlPreview(e,t){t=Math.floor(t/6e4)*6e4;var r=new URL(e);r.hash="",e=r.toString();var n=t+"_"+e;if(n in this.urlPreviewCache)return this.urlPreviewCache[n];var a=this.http.authedRequest(W.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:Jr.V3,priority:"low"});return this.urlPreviewCache[n]=a,a}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});var n=Z("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),a={typing:t};return t&&(a.timeout=r||2e4),this.http.authedRequest(W.Put,n,void 0,a)}getRoomUpgradeHistory(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,n=this.getRoom(e);if(!n)return[];var a=this.findPredecessorRooms(n,t,r),s=this.findSuccessorRooms(n,t,r);return[...a,n,...s]}findPredecessorRooms(e,t,r){for(var n,a=[],s=new Set([e.roomId]),o=(n=e.findPredecessor(r))===null||n===void 0?void 0:n.roomId;o!==null;){var d;if(o){if(s.has(o))break;s.add(o)}var l=this.getRoom(o);if(l===null)break;if(t){var u=l.currentState.getStateEvents(F.RoomTombstone,"");if(!u||u.getContent().replacement_room!==e.roomId)break}a.splice(0,0,l),e=l,o=(d=e.findPredecessor(r))===null||d===void 0?void 0:d.roomId}return a}findSuccessorRooms(e,t,r){for(var n=[],a=e.currentState.getStateEvents(F.RoomTombstone,"");a;){var s=this.getRoom(a.getContent().replacement_room);if(!s||s.roomId===e.roomId)break;if(t){var o,d=(o=s.findPredecessor(r))===null||o===void 0?void 0:o.roomId;if(!d||d!==e.roomId)break}n.push(s);var l=new Set(n.map(u=>u.roomId));if(l.size<n.length)return n.slice(0,n.length-1);e=s,a=e.currentState.getStateEvents(F.RoomTombstone,"")}return n}invite(e,t){var r=arguments,n=this;return _(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:{};if(typeof a!="object"&&(a={reason:a}),a.shareEncryptedHistory){var s;yield(s=n.cryptoBackend)===null||s===void 0?void 0:s.shareRoomHistoryWithUser(e,t)}return yield n.membershipChange(e,t,Se.Invite,a.reason)})()}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,r){var n=this;return _(function*(){var a,s=Z("/rooms/$roomId/invite",{$roomId:e}),o=n.getIdentityServerUrl(!0);if(!o)return Promise.reject(new Fe({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var d={id_server:o,medium:t,address:r};if((a=n.identityServer)!==null&&a!==void 0&&a.getAccessToken){var l=yield n.identityServer.getAccessToken();l&&(d.id_access_token=l)}return n.http.authedRequest(W.Post,s,void 0,d)})()}leave(e){return this.membershipChange(e,void 0,Se.Leave)}leaveRoomChain(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,r=this.getRoomUpgradeHistory(e,!0),n=r;if(!t){n=[];for(var a of r)if(n.push(a),a.roomId===e)break}var s={},o=[],d=u=>this.leave(u).then(()=>{delete s[u]}).catch(h=>{s[u]=h});for(var l of n)o.push(d(l.roomId));return Promise.all(o).then(()=>s)}ban(e,t,r){return this.membershipChange(e,t,Se.Ban,r)}forget(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!0,a=Z("/rooms/$room_id/forget",{$room_id:e}),s=yield r.http.authedRequest(W.Post,a);return n&&(r.store.removeRoom(e),r.emit(ie.DeleteRoom,e)),s})()}unban(e,t){var r=Z("/rooms/$roomId/unban",{$roomId:e}),n={user_id:t};return this.http.authedRequest(W.Post,r,void 0,n)}kick(e,t,r){var n=Z("/rooms/$roomId/kick",{$roomId:e}),a={user_id:t,reason:r};return this.http.authedRequest(W.Post,n,void 0,a)}membershipChange(e,t,r,n){var a=Z("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(W.Post,a,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushActions()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;if(!e.getPushDetails()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushDetails()}setProfileInfo(e,t){var r=Z("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(W.Put,r,void 0,t)}setDisplayName(e){var t=this;return _(function*(){var r=yield t.setProfileInfo("displayname",{displayname:e}),n=t.getUser(t.getUserId());return n&&(n.displayName=e,n.emit(gt.DisplayName,n.events.presence,n)),r})()}setAvatarUrl(e){var t=this;return _(function*(){var r=yield t.setProfileInfo("avatar_url",{avatar_url:e}),n=t.getUser(t.getUserId());return n&&(n.avatarUrl=e,n.emit(gt.AvatarUrl,n.events.presence,n)),r})()}mxcUrlToHttp(e,t,r,n,a,s,o){return Gi(this.baseUrl,e,t,r,n,a,s,o)}setSyncPresence(e){var t=this;return _(function*(){var r;(r=t.syncApi)===null||r===void 0||r.setPresence(e)})()}setPresence(e){var t=this;return _(function*(){var r=Z("/presence/$userId/status",{$userId:t.credentials.userId}),n=["offline","online","unavailable"];if(n.indexOf(e.presence)===-1)throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(W.Put,r,void 0,e)})()}getPresence(e){var t=Z("/presence/$userId/status",{$userId:e});return this.http.authedRequest(W.Get,t)}scrollback(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:30,r=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs){var a=Date.now()-n.errorTs;r=Math.max(Am-a,0)}if(e.oldState.paginationToken===null)return Promise.resolve(e);var s=this.store.scrollback(e,t).length;if(s===t)return Promise.resolve(e);t=t-s;var o=new Promise((d,l)=>{qi(r).then(()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,be.Backward)).then(u=>{var h,v,m=u.chunk.map(this.getEventMapper());if(u.state){var f=u.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(f)}var[g,T,R]=e.partitionThreadedEvents(m);this.processAggregatedTimelineEvents(e,g),e.addEventsToTimeline(g,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,T,!0),R.forEach(S=>e.relations.aggregateChildEvent(S)),e.oldState.paginationToken=(h=u.end)!==null&&h!==void 0?h:null,u.chunk.length===0&&(e.oldState.paginationToken=null),this.store.storeEvents(e,m,(v=u.end)!==null&&v!==void 0?v:null,!0),delete this.ongoingScrollbacks[e.roomId],d(e)}).catch(u=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},l(u)})});return n={promise:o},this.ongoingScrollbacks[e.roomId]=n,o}getEventMapper(e){return Op(this,e||{})}getEventContext(e,t){var r=this;return _(function*(){var n,a=Z("/rooms/$roomId/context/$eventId",{$roomId:e,$eventId:t}),s={limit:"0"};(n=r.clientOpts)!==null&&n!==void 0&&n.lazyLoadMembers&&(s.filter=JSON.stringify(St.LAZY_LOADING_MESSAGES_FILTER));var o=yield r.http.authedRequest(W.Get,a,s);if(o.event){var d,l,u;return{start:o.start,end:o.end,event:o.event,events_after:(d=o.events_after)!==null&&d!==void 0?d:[],events_before:(l=o.events_before)!==null&&l!==void 0?l:[],state:(u=o.state)!==null&&u!==void 0?u:[]}}throw new Error("'event' not in '/context' result - homeserver too old?")})()}getEventTimeline(e,t){var r=this;return _(function*(){var n,a,s;if(!r.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!(e!=null&&e.room))throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&r.supportsThreads()){var o;return(o=yield r.getThreadTimeline(e,t))!==null&&o!==void 0?o:null}var d=yield r.getEventContext(e.room.roomId,t);if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var l=r.getEventMapper(),u=l(d.event);if(u.isRelation(De.name))return r.logger.warn("Tried loading a regular timeline at the position of a thread event"),null;var h=[...d.events_after.reverse().map(l),u,...d.events_before.map(l)],v=e.getTimelineForEvent(h[0].getId());if(v)v.getState(te.BACKWARDS).setUnknownStateEvents(d.state.map(l));else{var m;v=e.addTimeline(),v.initialiseState(d.state.map(l)),v.getState(te.FORWARDS).paginationToken=(m=d.end)!==null&&m!==void 0?m:null}var[f,g,T]=e.room.partitionThreadedEvents(h);return e.addEventsToTimeline(f,!0,!1,v,d.start),r.processThreadEvents(e.room,g,!0),r.processAggregatedTimelineEvents(e.room,f),T.forEach(R=>e.relations.aggregateChildEvent(R)),(n=(a=e.getTimelineForEvent(t))!==null&&a!==void 0?a:(s=e.room.findThreadForEvent(u))===null||s===void 0?void 0:s.liveTimeline)!==null&&n!==void 0?n:v})()}getThreadTimeline(e,t){var r=this;return _(function*(){if(!r.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var n=yield r.getEventContext(e.room.roomId,t),a=r.getEventMapper(),s=a(n.event);if(e.canContain(s)){var o=r.canSupport.get(nt.RelationsRecursion)!==tt.Unsupported;if(xe.hasServerSideSupport)if(xe.hasServerSideFwdPaginationSupport){var d,l,u;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var h=e.thread,v=yield r.fetchRelations(e.room.roomId,h.id,null,null,{dir:be.Backward,from:n.start,recurse:o||void 0}),m=yield r.fetchRelations(e.room.roomId,h.id,null,null,{dir:be.Forward,from:n.end,recurse:o||void 0}),f=[...m.chunk.reverse().filter(Ks(h.id)).map(a),s,...v.chunk.filter(Ks(h.id)).map(a)];for(var g of f){var T;yield(T=e.thread)===null||T===void 0?void 0:T.processEvent(g)}var R=e.getTimelineForEvent(s.getId());if(R?R.getState(te.BACKWARDS).setUnknownStateEvents(n.state.map(a)):(R=e.addTimeline(),R.initialiseState(n.state.map(a))),e.addEventsToTimeline(f,!0,!1,R,m.next_batch),!v.next_batch){var S=yield r.fetchRoomEvent(e.room.roomId,h.id);e.addEventsToTimeline([a(S)],!0,!1,R,null)}return R.setPaginationToken((d=v.next_batch)!==null&&d!==void 0?d:null,be.Backward),R.setPaginationToken((l=m.next_batch)!==null&&l!==void 0?l:null,be.Forward),r.processAggregatedTimelineEvents(e.room,f),(u=e.getTimelineForEvent(t))!==null&&u!==void 0?u:R}else{for(var I,b=e.thread,w=yield r.fetchRelations(e.room.roomId,b.id,De.name,null,{dir:be.Backward,from:n.start,recurse:o||void 0}),p=[],E=n.end;E;){var y=yield r.fetchRelations(e.room.roomId,b.id,De.name,null,{dir:be.Forward,from:E,recurse:o||void 0});E=y.next_batch,p.push(...y.chunk)}var P=[...p.reverse().map(a),s,...w.chunk.map(a)];for(var N of P){var V;yield(V=e.thread)===null||V===void 0?void 0:V.processEvent(N)}var Q=e.getLiveTimeline();if(Q.getState(te.BACKWARDS).setUnknownStateEvents(n.state.map(a)),e.addEventsToTimeline(P,!0,!1,Q,null),!w.next_batch){var le=yield r.fetchRoomEvent(e.room.roomId,b.id);e.addEventsToTimeline([a(le)],!0,!1,Q,null)}return Q.setPaginationToken((I=w.next_batch)!==null&&I!==void 0?I:null,be.Backward),Q.setPaginationToken(null,be.Forward),r.processAggregatedTimelineEvents(e.room,P),Q}}})()}getLatestTimeline(e){var t=this;return _(function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var r;if(e.threadListType!==null){var n,a=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,be.Backward,e.threadListType,e.getFilter());r=(n=a.chunk)===null||n===void 0?void 0:n[0]}else if(e.thread&&xe.hasServerSideSupport){var s,o=t.canSupport.get(nt.RelationsRecursion)!==tt.Unsupported,d=yield t.fetchRelations(e.room.roomId,e.thread.id,De.name,null,{dir:be.Backward,limit:1,recurse:o||void 0});r=(s=d.chunk)===null||s===void 0?void 0:s[0]}else{var l,u,h=Z("/rooms/$roomId/messages",{$roomId:e.room.roomId}),v={dir:"b"};(l=t.clientOpts)!==null&&l!==void 0&&l.lazyLoadMembers&&(v.filter=JSON.stringify(St.LAZY_LOADING_MESSAGES_FILTER));var m=yield t.http.authedRequest(W.Get,h,v);r=(u=m.chunk)===null||u===void 0?void 0:u[0]}if(!r)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,r.event_id)})()}createMessagesRequest(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,o=Z("/rooms/$roomId/messages",{$roomId:e}),d={limit:n.toString(),dir:a};t&&(d.from=t);var l=null;if((r=this.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(l=Object.assign({},St.LAZY_LOADING_MESSAGES_FILTER)),s){var u;l=l||{},Object.assign(l,(u=s.getRoomTimelineFilterComponent())===null||u===void 0?void 0:u.toJSON())}return l&&(d.filter=JSON.stringify(l)),this.http.authedRequest(W.Get,o,d)}createThreadListMessagesRequest(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:30,a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:be.Backward,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:At.All,o=arguments.length>5?arguments[5]:void 0,d=Z("/rooms/$roomId/threads",{$roomId:e}),l={limit:n.toString(),dir:a,include:Cl(s)};t&&(l.from=t);var u={};if((r=this.clientOpts)!==null&&r!==void 0&&r.lazyLoadMembers&&(u=qe({},St.LAZY_LOADING_MESSAGES_FILTER)),o){var h;u=qe(qe({},u),(h=o.getRoomTimelineFilterComponent())===null||h===void 0?void 0:h.toJSON())}Object.keys(u).length&&(l.filter=JSON.stringify(u));var v={prefix:xe.hasServerSideListSupport===dt.Stable?$e.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(W.Get,d,l,void 0,v).then(m=>{var f;return qe(qe({},m),{},{chunk:(f=m.chunk)===null||f===void 0?void 0:f.reverse(),start:m.prev_batch,end:m.next_batch})})}paginateEventTimeline(e,t){var r=this,n=e.getTimelineSet()===this.notifTimelineSet,a=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,o=e.getTimelineSet().thread;t=t||{};var d=t.backwards||!1;if(n&&!d)throw new Error("paginateNotifTimeline can only paginate backwards");var l=d?te.BACKWARDS:te.FORWARDS,u=e.getPaginationToken(l),h=e.paginationRequests[l];if(h)return h;var v,m,f;if(n){var g;v="/notifications",m={limit:((g=t.limit)!==null&&g!==void 0?g:30).toString(),only:"highlight"},u&&u!=="end"&&(m.from=u),f=this.http.authedRequest(W.Get,v,m).then((function(){var b=_(function*(w){var p=w.next_token,E=[];w.notifications=w.notifications.filter(jt);for(var y=0;y<w.notifications.length;y++){var P=w.notifications[y],N=r.getEventMapper()(P.event);r.getPushDetailsForEvent(N,!0),N.event.room_id=P.room_id,E[y]=N}var V=e.getTimelineSet();return V.addEventsToTimeline(E,d,!1,e,p),r.processAggregatedTimelineEvents(V.room,E),d&&!w.next_token&&e.setPaginationToken(null,l),!!w.next_token});return function(w){return b.apply(this,arguments)}})()).finally(()=>{e.paginationRequests[l]=null}),e.paginationRequests[l]=f}else if(s!==null){if(!a)throw new Error("Unknown room "+e.getRoomId());if(!xe.hasServerSideFwdPaginationSupport&&l===be.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");f=this.createThreadListMessagesRequest(e.getRoomId(),u,t.limit,l,s,e.getFilter()).then(b=>{if(b.state){var w=e.getState(l),p=b.state.filter(jt).map(this.getEventMapper());w.setUnknownStateEvents(p)}var E=b.end,y=b.chunk.filter(jt).map(this.getEventMapper()),P=e.getTimelineSet();return P.addEventsToTimeline(y,d,!1,e,E),this.processAggregatedTimelineEvents(a,y),this.processThreadRoots(a,y,d),d&&b.end==b.start&&e.setPaginationToken(null,l),b.end!==b.start}).finally(()=>{e.paginationRequests[l]=null}),e.paginationRequests[l]=f}else if(o){var T,R,S=this.getRoom((T=e.getRoomId())!==null&&T!==void 0?T:void 0);if(!S)throw new Error("Unknown room "+e.getRoomId());var I=this.canSupport.get(nt.RelationsRecursion)!==tt.Unsupported;f=this.fetchRelations((R=e.getRoomId())!==null&&R!==void 0?R:"",o.id,null,null,{dir:l,limit:t.limit,from:u??void 0,recurse:I||void 0}).then((function(){var b=_(function*(w){var p=r.getEventMapper(),E=w.chunk.filter(jt).filter(Ks(o.id)).map(p);for(var y of E.slice().reverse()){yield o?.processEvent(y);var P=y.getSender();(!d||o?.getEventReadUpTo(P)===null)&&S.addLocalEchoReceipt(P,y,ht.Read)}var N=w.next_batch,V=e.getTimelineSet();if(V.addEventsToTimeline(E,d,!1,e,N??null),!N&&d){var Q,le,Ae=(Q=o.rootEvent)!==null&&Q!==void 0?Q:p(yield r.fetchRoomEvent((le=e.getRoomId())!==null&&le!==void 0?le:"",o.id));V.addEventsToTimeline([Ae],!0,!1,e,null)}return r.processAggregatedTimelineEvents(V.room,E),d&&!N&&e.setPaginationToken(null,l),!!N});return function(w){return b.apply(this,arguments)}})()).finally(()=>{e.paginationRequests[l]=null}),e.paginationRequests[l]=f}else{if(!a)throw new Error("Unknown room "+e.getRoomId());f=this.createMessagesRequest(e.getRoomId(),u,t.limit,l,e.getFilter()).then(b=>{if(b.state){var w=e.getState(l),p=b.state.filter(jt).map(this.getEventMapper());w.setUnknownStateEvents(p)}var E=b.end,y=b.chunk.filter(jt).map(this.getEventMapper()),P=e.getTimelineSet(),[N,,V]=a.partitionThreadedEvents(y);P.addEventsToTimeline(N,d,!1,e,E),this.processAggregatedTimelineEvents(a,N),this.processThreadRoots(a,N.filter(le=>le.getServerAggregatedRelation(De.name)),!1),V.forEach(le=>a.relations.aggregateChildEvent(le));var Q=b.end===void 0||b.end===b.start;return d&&Q&&e.setPaginationToken(null,l),!Q}).finally(()=>{e.paginationRequests[l]=null}),e.paginationRequests[l]=f}return f}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20;return(t=this.peekSync)===null||t===void 0||t.stopPeeking(),this.peekSync=new br(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,r)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var r=this.sendStateEvent(e,F.RoomGuestAccess,{guest_access:t.allowJoin?xi.CanJoin:xi.Forbidden},""),n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,F.RoomHistoryVisibility,{history_visibility:cs.WorldReadable},"")),Promise.all([n,r]).then()}requestRegisterEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestRegisterMsisdnToken(e,t,r,n,a){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:a})}requestAdd3pidEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestAdd3pidMsisdnToken(e,t,r,n,a){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:a})}requestPasswordEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestPasswordMsisdnToken(e,t,r,n,a){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:a})}requestTokenFromEndpoint(e,t){var r=this;return _(function*(){var n=Object.assign({},t);return r.http.request(W.Post,e,void 0,n)})()}getRoomPushRule(e,t){if(this.pushRules){var r;return(r=this.pushRules[e])===null||r===void 0||(r=r.room)===null||r===void 0?void 0:r.find(n=>n.rule_id===t)}else throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){var n,a=!1,s=this.getRoomPushRule(e,t);if(s!=null&&s.actions.includes(dr.DontNotify)&&(a=!0),!r)a&&(n=this.deletePushRule(e,it.RoomSpecific,s.rule_id));else if(!s)n=this.addPushRule(e,it.RoomSpecific,t,{actions:[dr.DontNotify]});else if(!a){var o=Promise.withResolvers();this.deletePushRule(e,it.RoomSpecific,s.rule_id).then(()=>{this.addPushRule(e,it.RoomSpecific,t,{actions:[dr.DontNotify]}).then(()=>{o.resolve()}).catch(d=>{o.reject(d)})}).catch(d=>{o.reject(d)}),n=o.promise}if(n)return new Promise((d,l)=>{n.then(()=>{this.getPushRules().then(u=>{this.pushRules=u,d()}).catch(u=>{l(u)})}).catch(u=>{this.getPushRules().then(h=>{this.pushRules=h,l(u)}).catch(h=>{l(u)})})})}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:dl.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(n=>this.processRoomEventsSearch(r,n))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then(n=>this.processRoomEventsSearch(e,n)).finally(()=>{e.pendingRequest=void 0});return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,n,a=t.search_categories.room_events;e.count=a.count,e.next_batch=a.next_batch;var s=new Set(a.highlights);e.highlights.forEach(m=>{s.add(m)}),e.highlights=Array.from(s);for(var o=this.getEventMapper(),d=(r=(n=a.results)===null||n===void 0?void 0:n.length)!==null&&r!==void 0?r:0,l=0;l<d;l++){var u=Xi.fromJson(a.results[l],o),h=this.getRoom(u.context.getEvent().getRoomId());if(h)for(var v of u.context.getTimeline())v.setMetadata(h.currentState,!1);e.results.push(u)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new br(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then(()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0}).finally(()=>{this.syncLeftRoomsPromise=void 0}),this.syncLeftRoomsPromise}createFilter(e){var t=Z("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(W.Post,t,void 0,e).then(r=>{var n=St.fromJson(this.credentials.userId,r.filter_id,e);return this.store.storeFilter(n),n})}getFilter(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}var a=Z("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(W.Get,a).then(s=>{var o=St.fromJson(e,t,s);return this.store.storeFilter(o),o})}getOrCreateFilter(e,t){var r=this;return _(function*(){var n=r.store.getFilterIdByName(e),a;if(n){try{var s=yield r.getFilter(r.credentials.userId,n,!0);if(s){var o=s.getDefinition(),d=t.getDefinition();Qr(o,d)&&(a=n)}}catch(u){if(u.errcode!=="M_UNKNOWN"&&u.errcode!=="M_NOT_FOUND")throw u}a||r.store.setFilterIdByName(e,void 0)}if(a)return a;var l=yield r.createFilter(t.getDefinition());return r.store.setFilterIdByName(e,l.filterId),l.filterId})()}getOpenIdToken(){var e=Z("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(W.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(W.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return this.checkTurnServersIntervalID!==void 0}checkTurnServers(){var e=this;return _(function*(){if(e.supportsVoip()){var t=!1,r=e.turnServersExpiry-Date.now();if(r>Eu)e.logger.debug("TURN creds are valid for another "+r+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var n=yield e.turnServer();if(n.uris){e.logger.debug("Got TURN URIs: "+n.uris+" refresh in "+n.ttl+" secs");var a={urls:n.uris,username:n.username,credential:n.password};e.turnServers=[a],e.turnServersExpiry=Date.now()+n.ttl*1e3,t=!0,e.emit(ie.TurnServers,e.turnServers)}}catch(s){e.logger.error("Failed to get TURN URIs",s),s.httpStatus===403?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),e.checkTurnServersIntervalID!==null&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(ie.TurnServersError,s,!0)):e.emit(ie.TurnServersError,s,!1)}}return t}})()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=Z("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(W.Get,e,void 0,void 0,{prefix:""}).then(t=>t.admin)}whoisSynapseUser(e){var t=Z("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(W.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=Z("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(W.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return _(function*(){var t;e.clientWellKnownPromise=ye.getRawClientConfig((t=e.getDomain())!==null&&t!==void 0?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(ie.ClientWellKnown,e.clientWellKnown)})()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter(r=>{var[n,a]=r;return e.includes(typeof a)}).reduce((r,n)=>{var[a,s]=n;return r[a]=s,r},{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return _(function*(){var r=yield t.doesServerSupportUnstableFeature(El),n=yield t.doesServerSupportUnstableFeature(_l),a=yield t.doesServerSupportUnstableFeature(wl);if(!r&&!n&&!a)throw Error("Server does not support the Mutual Rooms API");var s,o;a?(s="/uk.half-shot.msc2666/user/mutual_rooms",o={user_id:e}):(s=Z("/uk.half-shot.msc2666/user/".concat(n?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),o={});var d=[],l=null;do{var u={};l!=null&&a&&(u.batch_token=l);var h=yield t.http.authedRequest(W.Get,s,qe(qe({},o),u),void 0,{prefix:$e.Unstable});d.push(...h.joined),h.next_batch_token!==void 0?l=h.next_batch_token:l=null}while(l!=null);return d})()}_unstable_getRTCTransports(){var e=this;return _(function*(){return(yield e.http.authedRequest(W.Get,"/rtc/transports",void 0,void 0,{prefix:"".concat($e.Unstable,"/org.matrix.msc4143")})).rtc_transports})()}getVersions(){var e=this;return _(function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(W.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch(r=>{throw e.serverVersionsPromise=void 0,r});var t=yield e.serverVersionsPromise;return e.canSupport=yield Lf(t),e.serverVersionsPromise})()}isVersionSupported(e){var t=this;return _(function*(){var{versions:r}=yield t.getVersions();return r&&r.includes(e)})()}doesServerSupportUnstableFeature(e){var t=this;return _(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features;return n&&!!n[e]})()}doesServerForceEncryptionForPreset(e){var t=this;return _(function*(){var r=yield t.getVersions();if(!r)return!1;var n=r.unstable_features,a=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n["io.element.e2ee_forced.".concat(a)]})()}doesServerSupportThread(){var e=this;return _(function*(){if(yield e.isVersionSupported("v1.4"))return{threads:dt.Stable,list:dt.Stable,fwdPagination:dt.Stable};try{var[t,r,n,a,s,o]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:Oi(r,t),list:Oi(a,n),fwdPagination:Oi(o,s)}}catch{return{threads:dt.None,list:dt.None,fwdPagination:dt.None}}})()}hasLazyLoadMembersEnabled(){var e;return!!((e=this.clientOpts)!==null&&e!==void 0&&e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,r,n){var a=arguments,s=this;return _(function*(){var o,d,l=a.length>4&&a[4]!==void 0?a[4]:{dir:be.Backward},u=n?s.getEncryptedIfNeededEventType(e,n):null,[h,v]=yield Promise.all([s.fetchRoomEvent(e,t),s.fetchRelations(e,t,r,u,l)]),m=s.getEventMapper(),f=h?m(h):void 0,g=v.chunk.map(m);if(u===F.RoomMessageEncrypted){var T=f?g.concat(f):g;yield Promise.all(T.map(R=>s.decryptEventIfNeeded(R))),n!==null&&(g=g.filter(R=>R.getType()===n))}return f&&r===Ue.Replace&&(g=g.filter(R=>R.getSender()===f.getSender())),{originalEvent:f??null,events:g,nextBatch:(o=v.next_batch)!==null&&o!==void 0?o:null,prevBatch:(d=v.prev_batch)!==null&&d!==void 0?d:null}})()}generateClientSecret(){return wr(32)}decryptEventIfNeeded(e,t){return e.isState()&&!this.enableEncryptedStateEvents?Promise.resolve():(e.shouldAttemptDecryption()&&this.getCrypto()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve())}termsUrlForService(e,t){switch(e){case Wa.IS:return this.http.getUrl("/terms",void 0,Vt.V2,t);case Wa.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return r&&((e=this.idBaseUrl)!==null&&e!==void 0&&e.startsWith("http://")||(t=this.idBaseUrl)!==null&&t!==void 0&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=Is(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return(e=this.http.opts.refreshToken)!==null&&e!==void 0?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return this.http.opts.accessToken!==void 0}makeTxnId(){return"m"+new Date().getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(W.Get,"/register/available",{username:e}).then(t=>t.available).catch(t=>t.errcode==="M_USER_IN_USE"?!1:Promise.reject(t))}register(e,t,r,n,a,s,o){r&&(n.session=r);var d={auth:n,refresh_token:!0};return e!=null&&(d.username=e),t!=null&&(d.password=t),s!=null&&(d.guest_access_token=s),o!=null&&(d.inhibit_login=o),this.registerRequest(d)}registerGuest(){var{body:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var r={};return t&&(r.kind=t),this.http.request(W.Post,"/register",r,e)}refreshToken(e){var t=r=>this.http.authedRequest(W.Post,"/refresh",void 0,{refresh_token:e},{prefix:r,inhibitLogoutEmit:!0});return t($e.V3).catch(r=>{if(r.errcode==="M_UNRECOGNIZED")return t($e.V1);throw r})}loginFlows(){return this.http.request(W.Get,"/login")}login(e,t){return this.loginRequest(qe(qe({},t),{},{type:e})).then(r=>(r.access_token&&r.user_id&&(this.http.opts.accessToken=r.access_token,this.credentials={userId:r.user_id}),r))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"sso",r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,a="/login/"+t+"/redirect";r&&(a+="/"+r);var s={redirectUrl:e,[Dm.unstable]:n};return this.http.getUrl(a,s).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return _(function*(){return yield t.http.authedRequest(W.Post,"/login",void 0,e)})()}logout(){var e=arguments,t=this;return _(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:!1;return r&&(t.stopClient(),t.http.abort()),t.http.authedRequest(W.Post,"/logout")})()}deactivateAccount(e,t){var r={};return e&&(r.auth=e),t!==void 0&&(r.erase=t),this.http.authedRequest(W.Post,"/account/deactivate",void 0,r)}requestLoginToken(e){var t=this;return _(function*(){var r={auth:e};return t.http.authedRequest(W.Post,"/login/get_token",void 0,r,{prefix:$e.V1})})()}getFallbackAuthUrl(e,t){var r=Z("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t}).href}createRoom(e){var t=this;return _(function*(){var r,n=(e.invite_3pid||[]).filter(o=>!o.id_access_token);if(n.length>0&&(r=t.identityServer)!==null&&r!==void 0&&r.getAccessToken){var a=yield t.identityServer.getAccessToken();if(a)for(var s of n)s.id_access_token=a}return t.http.authedRequest(W.Post,"/createRoom",void 0,e)})()}fetchRelations(e,t,r,n){var a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:{dir:be.Backward},s=a;xe.hasServerSideFwdPaginationSupport===dt.Experimental&&(s=$l("dir","org.matrix.msc3715.dir",s)),this.canSupport.get(nt.RelationsRecursion)===tt.Unstable&&(s=$l("recurse","org.matrix.msc3981.recurse",s));var o=Xs(s),d="/rooms/$roomId/relations/$eventId";r!==null?(d+="/$relationType",n!==null&&(d+="/$eventType")):n!==null&&(this.logger.warn("eventType: ".concat(n,` ignored when fetching
            relations as relationType is null`)),n=null);var l=Z(d+"?"+o,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return this.http.authedRequest(W.Get,l,void 0,void 0,{prefix:$e.V1})}roomState(e){var t=Z("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(W.Get,t)}fetchRoomEvent(e,t){var r=Z("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(W.Get,r)}members(e,t,r,n){var a={};t&&(a.membership=t),r&&(a.not_membership=r),n&&(a.at=n);var s=Xs(a),o=Z("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(W.Get,o)}upgradeRoom(e,t){var r=Z("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(W.Post,r,void 0,{new_version:t})}getStateEvent(e,t,r){var n={$roomId:e,$eventType:t,$stateKey:r},a=Z("/rooms/$roomId/state/$eventType",n);return r!==void 0&&(a=Z(a+"/$stateKey",n)),this.http.authedRequest(W.Get,a)}sendStateEvent(e,t,r){var n=arguments,a=this;return _(function*(){var s=n.length>3&&n[3]!==void 0?n[3]:"",o=n.length>4&&n[4]!==void 0?n[4]:{},d=a.getRoom(e),l=new at({room_id:e,type:t,state_key:s,content:r});yield a.encryptStateEventIfNeeded(l,d??void 0);var u={$roomId:e,$eventType:l.getWireType(),$stateKey:l.getWireStateKey()},h=Z("/rooms/$roomId/state/$eventType",u);return s!==void 0&&(h=Z(h+"/$stateKey",u)),a.http.authedRequest(W.Put,h,void 0,l.getWireContent(),o)})()}encryptStateEventIfNeeded(e,t){var r=this;return _(function*(){if(r.enableEncryptedStateEvents&&t&&!(!r.cryptoBackend&&r.usingExternalCrypto)){if(!r.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");(yield r.shouldEncryptEventForRoom(e,t))&&(yield r.cryptoBackend.isStateEncryptionEnabledInRoom(t.roomId))&&(["m.room.create","m.room.member","m.room.join_rules","m.room.power_levels","m.room.third_party_invite","m.room.history_visibility","m.room.guest_access","m.room.encryption"].includes(e.getType())||(yield r.cryptoBackend.encryptEvent(e,t)))}})()}roomInitialSync(e,t){var r,n=Z("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(W.Get,n,{limit:(r=t?.toString())!==null&&r!==void 0?r:"30"})}setRoomReadMarkersHttpRequest(e,t,r,n){var a=this;return _(function*(){var s=Z("/rooms/$roomId/read_markers",{$roomId:e}),o={[ht.FullyRead]:t,[ht.Read]:r};return((yield a.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield a.isVersionSupported("v1.4")))&&(o[ht.ReadPrivate]=n),a.http.authedRequest(W.Post,s,void 0,o)})()}getJoinedRooms(){var e=Z("/joined_rooms",{});return this.http.authedRequest(W.Get,e)}getJoinedRoomMembers(e){var t=Z("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(W.Get,t)}publicRooms(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},{server:t,limit:r,since:n}=e,a=zv(e,Pm);if(Object.keys(a).length===0){var s={server:t,limit:r,since:n};return this.http.authedRequest(W.Get,"/publicRooms",s)}else{var o={server:t},d=qe({limit:r,since:n},a);return this.http.authedRequest(W.Post,"/publicRooms",o,d)}}createAlias(e,t){var r=Z("/directory/room/$alias",{$alias:e}),n={room_id:t};return this.http.authedRequest(W.Put,r,void 0,n)}deleteAlias(e){var t=Z("/directory/room/$alias",{$alias:e});return this.http.authedRequest(W.Delete,t)}getLocalAliases(e){var t=Z("/rooms/$roomId/aliases",{$roomId:e}),r=$e.V3;return this.http.authedRequest(W.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){var t=Z("/directory/room/$alias",{$alias:e});return this.http.authedRequest(W.Get,t)}getRoomDirectoryVisibility(e){var t=Z("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(W.Get,t)}setRoomDirectoryVisibility(e,t){var r=Z("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(W.Put,r,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:r}=e,n={search_term:t};return r!==void 0&&(n.limit=r),this.http.authedRequest(W.Post,"/user_directory/search",void 0,n)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var r=t?Z("/profile/$userId/$info",{$userId:e,$info:t}):Z("/profile/$userId",{$userId:e});return this.http.authedRequest(W.Get,r)}doesServerSupportExtendedProfiles(){var e=this;return _(function*(){return(yield e.isVersionSupported("v1.16"))||(yield e.doesServerSupportUnstableFeature(Rl))||(yield e.doesServerSupportUnstableFeature(Tl))})()}getExtendedProfileRequestPrefix(){var e=this;return _(function*(){return(yield e.isVersionSupported("v1.16"))||(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?$e.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"})()}getExtendedProfile(e){var t=this;return _(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(W.Get,Z("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getExtendedProfileProperty(e,t){var r=this;return _(function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=yield r.http.authedRequest(W.Get,Z("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield r.getExtendedProfileRequestPrefix()});return n[t]})()}setExtendedProfileProperty(e,t){var r=this;return _(function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=r.getUserId();yield r.http.authedRequest(W.Put,Z("/profile/$userId/$key",{$userId:n,$key:e}),void 0,{[e]:t},{prefix:yield r.getExtendedProfileRequestPrefix()})})()}deleteExtendedProfileProperty(e){var t=this;return _(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(W.Delete,Z("/profile/$userId/$key",{$userId:r,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}patchExtendedProfile(e){var t=this;return _(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();return t.http.authedRequest(W.Patch,Z("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}setExtendedProfile(e){var t=this;return _(function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(W.Put,Z("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})})()}getThreePids(){return this.http.authedRequest(W.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return _(function*(){var r="/account/3pid/add";return t.http.authedRequest(W.Post,r,void 0,e)})()}bindThreePid(e){var t=this;return _(function*(){var r="/account/3pid/bind";return t.http.authedRequest(W.Post,r,void 0,e)})()}unbindThreePid(e,t){var r=this;return _(function*(){var n="/account/3pid/unbind",a={medium:e,address:t,id_server:r.getIdentityServerUrl(!0)};return r.http.authedRequest(W.Post,n,void 0,a)})()}deleteThreePid(e,t){var r="/account/3pid/delete";return this.http.authedRequest(W.Post,r,void 0,{medium:e,address:t})}setPassword(e,t,r){var n="/account/password",a={auth:e,new_password:t,logout_devices:r};return this.http.authedRequest(W.Post,n,void 0,a)}getDevices(){return this.http.authedRequest(W.Get,"/devices")}getDevice(e){var t=Z("/devices/$device_id",{$device_id:e});return this.http.authedRequest(W.Get,t)}setDeviceDetails(e,t){var r=Z("/devices/$device_id",{$device_id:e});return this.http.authedRequest(W.Put,r,void 0,t)}deleteDevice(e,t){var r=Z("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(W.Delete,r,void 0,n)}deleteMultipleDevices(e,t){var r={devices:e};t&&(r.auth=t);var n="/delete_devices";return this.http.authedRequest(W.Post,n,void 0,r)}getPushers(){var e=this;return _(function*(){var t=yield e.http.authedRequest(W.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map(r=>(r.hasOwnProperty(Ua.name)||(r[Ua.name]=!0),r))),t})()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(W.Post,t,void 0,e)}removePusher(e,t){var r="/pushers/set",n={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(W.Post,r,void 0,n)}setLocalNotificationSettings(e,t){var r="".concat(Uo.name,".").concat(e);return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(W.Get,"/pushrules/").then(e=>(this.setPushRules(e),this.pushRules))}setPushRules(e){this.pushRules=Ft.rewriteDefaultRules(this.logger,e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,n){var a=Z("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(W.Put,a,void 0,n)}deletePushRule(e,t,r){var n=Z("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(W.Delete,n)}setPushRuleEnabled(e,t,r,n){var a=Z("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(W.Put,a,void 0,{enabled:n})}setPushRuleActions(e,t,r,n){var a=Z("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(W.Put,a,void 0,{actions:n})}search(e,t){var{body:r,next_batch:n}=e,a={};return n&&(a.next_batch=n),this.http.authedRequest(W.Post,"/search",a,r,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(W.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(W.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r={device_keys:{}};return t!==void 0&&(r.token=t),e.forEach(n=>{r.device_keys[n]=[]}),this.http.authedRequest(W.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"signed_curve25519",r=arguments.length>2?arguments[2]:void 0,n={};t===void 0&&(t="signed_curve25519");for(var[a,s]of e){var o=n[a]||{};Ma(n,a,o),Ma(o,s,t)}var d={one_time_keys:n};r&&(d.timeout=r);var l="/keys/claim";return this.http.authedRequest(W.Post,l,void 0,d)}getKeyChanges(e,t){var r={from:e,to:t};return this.http.authedRequest(W.Get,"/keys/changes",r)}uploadDeviceSigningKeys(e,t){var r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(W.Post,"/keys/device_signing/upload",void 0,r,{prefix:$e.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,Vt.V2,this.idBaseUrl);return this.http.requestOtherUrl(W.Post,t,e)}requestEmailToken(e,t,r,n,a){var s={client_secret:t,email:e,send_attempt:r?.toString()};return n&&(s.next_link=n),this.http.idServerRequest(W.Post,"/validate/email/requestToken",s,Vt.V2,a)}requestMsisdnToken(e,t,r,n,a,s){var o={client_secret:r,country:e,phone_number:t,send_attempt:n?.toString()};return a&&(o.next_link=a),this.http.idServerRequest(W.Post,"/validate/msisdn/requestToken",o,Vt.V2,s)}submitMsisdnToken(e,t,r,n){var a={sid:e,client_secret:t,token:r};return this.http.idServerRequest(W.Post,"/validate/msisdn/submitToken",a,Vt.V2,n??void 0)}submitMsisdnTokenOtherUrl(e,t,r,n){var a={sid:t,client_secret:r,token:n};return this.http.requestOtherUrl(W.Post,e,a)}getIdentityHashDetails(e){return this.http.idServerRequest(W.Get,"/hash_details",void 0,Vt.V2,e)}identityHashedLookup(e,t){var r=this;return _(function*(){var n={},a=yield r.getIdentityHashDetails(t);if(!a||!a.lookup_pepper||!a.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=a.lookup_pepper;var s={};if(a.algorithms.includes("sha256"))n.addresses=yield Promise.all(e.map((function(){var v=_(function*(m){var f=m[0].toLowerCase(),g=m[1].toLowerCase(),T=yield ul("".concat(f," ").concat(g," ").concat(n.pepper)),R=Vn(T);return s[R]=m[0],R});return function(m){return v.apply(this,arguments)}})())),n.algorithm="sha256";else if(a.algorithms.includes("none"))n.addresses=e.map(v=>{var m=v[0].toLowerCase(),f=v[1].toLowerCase(),g="".concat(m," ").concat(f);return s[g]=v[0],g}),n.algorithm="none";else throw new Error("Unsupported identity server: unknown hash algorithm");var o=yield r.http.idServerRequest(W.Post,"/lookup",n,Vt.V2,t);if(!(o!=null&&o.mappings))return[];var d=[];for(var l of Object.keys(o.mappings)){var u=o.mappings[l],h=s[l];if(!h)throw new Error("Identity server returned more results than expected");d.push({address:h,mxid:u})}return d})()}lookupThreePid(e,t,r){var n=this;return _(function*(){var a=yield n.identityHashedLookup([[t,e]],r),s=a.find(d=>d.address===t);if(!s)return{};var o={address:t,medium:e,mxid:s.mxid};return o})()}bulkLookupThreePids(e,t){var r=this;return _(function*(){var n=yield r.identityHashedLookup(e.map(d=>[d[1],d[0]]),t),a=[],s=function*(l){var u=e.find(h=>h[1]===l.address);if(!u)throw new Error("Identity sever returned unexpected results");a.push([u[0],l.address,l.mxid])};for(var o of n)yield*s(o);return{threepids:a}})()}getIdentityAccount(e){return this.http.idServerRequest(W.Get,"/account",void 0,Vt.V2,e)}sendToDevice(e,t,r){var n=Z("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),a={messages:Vr(t)},s=new Map;for(var[o,d]of t)s.set(o,Array.from(d.keys()));return this.logger.debug("PUT ".concat(n),s),this.http.authedRequest(W.Put,n,void 0,a)}encryptAndSendToDevice(e,t,r){var n=this;return _(function*(){if(!n.cryptoBackend)throw new Error("Cannot encrypt to device event, your client does not support encryption.");var a=yield n.cryptoBackend.encryptToDeviceMessages(e,t,r);yield n.queueToDevice(a)})()}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(W.Get,"/thirdparty/protocols").then(e=>{if(!e||typeof e!="object")throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e})}getThirdpartyLocation(e,t){var r=Z("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(W.Get,r,t)}getThirdpartyUser(e,t){var r=Z("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(W.Get,r,t)}getTerms(e,t){var r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(W.Get,r)}agreeToTerms(e,t,r,n){var a=this.termsUrlForService(e,t),s={Authorization:"Bearer "+r};return this.http.requestOtherUrl(W.Post,a,{user_accepts:n},{headers:s})}reportEvent(e,t,r,n){var a=Z("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(W.Post,a,void 0,{score:r,reason:n})}reportRoom(e,t){var r=Z("/rooms/$roomId/report",{$roomId:e});return this.http.authedRequest(W.Post,r,void 0,{reason:t})}getRoomHierarchy(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,a=arguments.length>4?arguments[4]:void 0,s=Z("/rooms/$roomId/hierarchy",{$roomId:e}),o={suggested_only:String(n),max_depth:r?.toString(),from:a,limit:t?.toString()};return this.http.authedRequest(W.Get,s,o,void 0,{prefix:$e.V1}).catch(d=>{if(d.errcode==="M_UNRECOGNIZED")return this.http.authedRequest(W.Get,s,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw d})}unstableCreateFileTree(e){var t=this;return _(function*(){var{room_id:r}=yield t.createRoom({name:e,preset:us.PrivateChat,power_level_content_override:qe(qe({},kp),{},{users:{[t.getUserId()]:100}}),creation_content:{[Ai]:$r.Space},initial_state:[{type:Pa.name,state_key:Da.name,content:{[Aa.name]:!0}},{type:F.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new ou(t,r)})()}unstableGetFileTreeSpace(e){var t,r,n=this.getRoom(e);if(n?.getMyMembership()!==Se.Join)return null;var a=n.currentState.getStateEvents(F.RoomCreate,""),s=n.currentState.getStateEvents(Pa.name,Da.name);if(!a)throw new Error("Expected single room create event");return!(s!=null&&(t=s.getContent())!==null&&t!==void 0&&t[Aa.name])||((r=a.getContent())===null||r===void 0?void 0:r[Ai])!==$r.Space?null:new ou(this,e)}slidingSync(e,t,r){var n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);var a=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(W.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.simplified_msc3575",baseUrl:t,localTimeoutMs:a,abortSignal:r})}supportsThreads(){var e;return((e=this.clientOpts)===null||e===void 0?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(nt.IntentionalMentions)!==tt.Unsupported}getRoomSummary(e,t){var r=this;return _(function*(){var n={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var a=Z("/summary/$roomid",{$roomid:e});return yield r.http.authedRequest(W.Get,a,{via:t},void 0,n)}catch(o){if(o instanceof Fe&&o.errcode==="M_UNRECOGNIZED"){var s=Z("/rooms/$roomid/summary",{$roomid:e});return yield r.http.authedRequest(W.Get,s,{via:t},void 0,n)}else throw o}})()}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){this.supportsThreads()&&e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){t!=null&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return _(function*(){return e.http.authedRequest(W.Get,"/account/whoami")})()}timestampToEvent(e,t,r){var n=this;return _(function*(){var a=Z("/rooms/$roomId/timestamp_to_event",{$roomId:e}),s={ts:t.toString(),dir:r};try{return yield n.http.authedRequest(W.Get,a,s,void 0,{prefix:$e.V1})}catch(o){if(o.errcode==="M_UNRECOGNIZED"&&(o.httpStatus===400||o.httpStatus===404||o.httpStatus===405))return yield n.http.authedRequest(W.Get,a,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw o}})()}getAuthMetadata(){var e=this;return _(function*(){var t;try{t=yield e.http.request(W.Get,"/auth_metadata",void 0,void 0,{prefix:$e.Unstable+"/org.matrix.msc2965"})}catch(n){if(n instanceof Fe&&n.errcode==="M_UNRECOGNIZED"){var{issuer:r}=yield e.http.request(W.Get,"/auth_issuer",void 0,void 0,{prefix:$e.Unstable+"/org.matrix.msc2965"});return gs(r)}throw n}return ys(t)})()}}c(ea,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY");function _u(i){return Object.fromEntries(Object.entries(i).map(e=>{var[t,r]=e;return["".concat(ot,".").concat(t),r]}))}function Il(i,e){var t,r=i.getUserId(),n=e.getId(),a=i.getRoom(e.getRoomId());if(!(!a||!r||!n)){if(!a.findEventById(n)){O.info("Decrypted event ".concat(e.getId()," is not in room ").concat(a.roomId,": ignoring"));return}var s=!!e.threadRootId&&!e.isThreadRoot,o;if(s){var d=a.getThread(e.threadRootId);o=d?d.hasUserReadEvent(r,n):!0}else o=a.hasUserReadEvent(r,n);if(!o){var l=i.getPushActionsForEvent(e,!0),u=!!(l!=null&&(t=l.tweaks)!==null&&t!==void 0&&t.highlight);if(u){var h=a.getUnreadCountForEventContext(ke.Highlight,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,ke.Highlight,h):a.setUnreadNotificationCount(ke.Highlight,h)}var v=!!(l!=null&&l.notify);if(v){var m=a.getUnreadCountForEventContext(ke.Total,e)+1;s?a.setThreadUnreadNotificationCount(e.threadRootId,ke.Total,m):a.setUnreadNotificationCount(ke.Total,m)}}}}function tn(i){return Ln(i)?jn:i.threadRootId}function Ln(i){if(!i.threadRootId||i.isThreadRoot)return!0;if(!i.isRelation())return O.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(i.getId())),!0;if(i.isRelation(De.name))return!1;var e=i.relationEventId===i.threadRootId;return e}function wu(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function Ru(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?wu(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):wu(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}var vt=(function(i){return i.New="Thread.new",i.Update="Thread.update",i.NewReply="Thread.newReply",i.ViewThread="Thread.viewThread",i.Delete="Thread.delete",i})({}),dt=(function(i){return i[i.None=0]="None",i[i.Experimental=1]="Experimental",i[i.Stable=2]="Stable",i})({});function Oi(i,e){return i?dt.Stable:e?dt.Experimental:dt.None}class xe extends Kc{constructor(e,t,r){var n,a;if(super(),n=this,this.id=e,this.rootEvent=t,c(this,"timelineSet",void 0),c(this,"_currentUserParticipated",!1),c(this,"reEmitter",void 0),c(this,"lastEvent",void 0),c(this,"replyCount",0),c(this,"lastPendingEvent",void 0),c(this,"pendingReplyCount",0),c(this,"room",void 0),c(this,"client",void 0),c(this,"pendingEventOrdering",void 0),c(this,"processRootEventPromise",void 0),c(this,"initialEventsFetched",!xe.hasServerSideSupport),c(this,"initalEventFetchProm",void 0),c(this,"replayEvents",[]),c(this,"onTimelineReset",_(function*(){yield n.processRootEventPromise,n.processRootEventPromise=void 0})),c(this,"onBeforeRedaction",(s,o)=>{s!=null&&s.isRelation(De.name)&&this.room.eventShouldLiveIn(s).threadId===this.id&&s.getId()!==this.id&&!o.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(vt.Update,this))}),c(this,"onRedaction",(function(){var s=_(function*(o,d,l){if(l===n.id)if(n.replyCount<=0){for(var u of n.timeline)n.clearEventMetadata(u);n.lastEvent=n.rootEvent,n._currentUserParticipated=!1,n.emit(vt.Delete,n)}else{var h;((h=n.lastEvent)===null||h===void 0?void 0:h.getId())===o.getAssociatedId()&&(yield n.processRootEventPromise,n.processRootEventPromise=void 0),yield n.updateThreadMetadata()}});return function(o,d,l){return s.apply(this,arguments)}})()),c(this,"onTimelineEvent",(s,o,d)=>{if(!d){var l=s.getSender();l&&o&&this.shouldSendLocalEchoReceipt(l,s)&&o.addLocalEchoReceipt(l,s,ht.Read),s.getId()!==this.id&&s.isRelation(De.name)&&this.replyCount++}this.onEcho(s,d??!1)}),c(this,"onLocalEcho",s=>{this.onEcho(s,!1)}),c(this,"onEcho",(function(){var s=_(function*(o,d){o.threadRootId===n.id&&n.lastEvent!==o&&(yield n.updateThreadMetadata(),o.isRelation(De.name)&&(d||(n.lastEvent=void 0,n.emit(vt.NewReply,n,o))))});return function(o,d){return s.apply(this,arguments)}})()),this.setMaxListeners(1e3),!(r!=null&&r.room))throw new Error("element-web#22141: A thread requires a room in order to function");this.room=r.room,this.client=r.client,this.pendingEventOrdering=(a=r.pendingEventOrdering)!==null&&a!==void 0?a:en.Chronological,this.timelineSet=new Gr(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new qn(this),this.reEmitter.reEmit(this.timelineSet,[ne.Timeline,ne.TimelineReset]),this.room.on(Me.BeforeRedaction,this.onBeforeRedaction),this.room.on(ne.Redaction,this.onRedaction),this.room.on(ne.LocalEchoUpdated,this.onLocalEcho),this.room.on(ne.TimelineReset,this.onTimelineReset),this.timelineSet.on(ne.Timeline,this.onTimelineEvent),this.processReceipts(r.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return _(function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),r=e.client.getEventMapper();e.rootEvent=r(t)}catch(n){O.error("Failed to fetch thread root to construct thread with",n)}yield e.processEvent(e.rootEvent)})()}static setServerSideSupport(e){xe.hasServerSideSupport=e,e!==dt.Stable&&(zr.setPreferUnstable(!0),Yr.setPreferUnstable(!0),De.setPreferUnstable(!0))}static setServerSideListSupport(e){xe.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){xe.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var r,n=(r=this.client.canSupport.get(nt.RelationsRecursion))!==null&&r!==void 0?r:tt.Unsupported;if(n===tt.Unsupported){var a,s=(a=this.getReadReceiptForUserId(e))===null||a===void 0?void 0:a.eventId;if(s){var o=this.findEventById(s);if(o&&o.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(te.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach(r=>this.addEvent(r,t,!1)),this.updateThreadMetadata()}addEvent(e,t){var r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;this.setEventMetadata(e);var n=this.lastReply(),a=!n||e.localTimestamp>=n.localTimestamp;if(!xe.hasServerSideSupport)this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);else if(e.isRelation(Ue.Annotation)||e.isRelation(Ue.Replace)){this.addRelatedThreadEvent(e,t);return}else!t&&a?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e);e.getId()!==this.id&&e.isRelation(De.name)&&!t&&a&&(this.lastEvent=void 0),r&&(this.emit(vt.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){if(this.initialEventsFetched){var a,s=(a=this.client.canSupport.get(nt.RelationsRecursion))!==null&&a!==void 0?a:tt.Unsupported;s===tt.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var r;if((r=this.replayEvents)===null||r===void 0||r.push(e),e.isRelation(Ue.Annotation)){var n;(n=this.timelineSet.relations)===null||n===void 0||n.aggregateChildEvent(e,this.timelineSet)}}}processEvent(e){var t=this;return _(function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))})()}processReceipts(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[];for(var{eventId:t,receiptType:r,userId:n,receipt:a,synthetic:s}of e)this.addReceiptToStructure(t,r,n,a,s)}getRootEventBundledRelationship(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.rootEvent;return e?.getServerAggregatedRelation(De.name)}processRootEvent(){var e=this;return _(function*(){var t=e.getRootEventBundledRelationship();if(xe.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var r=e.client.getEventMapper();e.lastEvent=r(Ru(Ru({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}})()}updatePendingReplyCount(){var e=this.pendingEventOrdering===en.Detached?this.room.getPendingEvents():this.events,t=e.filter(r=>{var n;return r.threadRootId===this.id&&r.isRelation(De.name)&&r.status!==null&&r.getId()!==((n=this.lastEvent)===null||n===void 0?void 0:n.getId())});this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var r=this;return _(function*(){var n=r.liveTimeline;r.timelineSet.resetLiveTimeline(e??void 0,t??void 0);var a=r.liveTimeline,s,o;if(e){var d=yield r.client.createMessagesRequest(r.roomId,e,1,be.Forward);s=d.end}if(t){var l=yield r.client.createMessagesRequest(r.roomId,t,1,be.Backward);o=l.start}t&&n.getPaginationToken(be.Forward)===t&&n.setPaginationToken(o??null,be.Forward),e&&a.getPaginationToken(be.Backward)===e&&a.setPaginationToken(s??null,be.Backward)})()}updateThreadFromRootEvent(){var e=this;return _(function*(){xe.hasServerSideSupport&&(!e.initialEventsFetched&&!e.lastEvent&&(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()})()}updateThreadMetadata(){var e=this;return _(function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{e.timelineSet.resetLiveTimeline(),e.replyCount===0&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,be.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0;for(var t of e.replayEvents)e.addEvent(t,!1);e.replayEvents=null,e.emit(ne.TimelineReset,e.room,e.timelineSet,!0)}catch(r){O.error("Failed to load start of newly created thread: ",r),e.initialEventsFetched=!1}e.emit(vt.Update,e)})()}fetchEditsWhereNeeded(){var e=arguments,t=this;return _(function*(){var r,n=(r=t.client.canSupport.get(nt.RelationsRecursion))!==null&&r!==void 0?r:tt.Unsupported;if(n===tt.Unsupported){for(var a=e.length,s=new Array(a),o=0;o<a;o++)s[o]=e[o];return Promise.all(s.filter(Lm).map((function(){var d=_(function*(l){try{var u=yield t.client.relations(t.roomId,l.getId(),Ue.Replace,l.getType(),{limit:1});if(u.events.length){var h=u.events[0];l.makeReplaced(h),t.insertEventIntoTimeline(h)}}catch(v){O.error("Failed to load edits for encrypted thread event",v)}});return function(l){return d.apply(this,arguments)}})()))}})()}setEventMetadata(e){e&&(te.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){if(e){var t;e.setThread(void 0),(t=e.event)===null||t===void 0||(t=t.unsigned)===null||t===void 0||(t=t["m.relations"])===null||t===void 0||delete t[De.name]}}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:n=>n.isRelation(De.name),t=this.timeline.length-1;t>=0;t--){var r=this.timeline[t];if(e(r))return r}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return(e=(t=this.lastPendingEvent)!==null&&t!==void 0?t:this.lastEvent)!==null&&e!==void 0?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof at}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var r=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(r&&n){var a=n.getTs()<this.room.getOldestThreadedReceiptTs(),s=n.getId();if(a&&s)return s}var o=super.getEventReadUpTo(e,t);if(n){var d=this.room.getLastUnthreadedReceiptFor(e);if(!d)return o;for(var l=((u=this.timeline)===null||u===void 0?void 0:u.length)-1;l>=0;--l){var u,h,v=this.timeline[l];if(v.getId()===o)return o;if(v.getTs()<d.ts)return(h=v.getId())!==null&&h!==void 0?h:o}}return o}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var r,n,a,s,o,d,l=((r=(n=this.lastReply())===null||n===void 0?void 0:n.getTs())!==null&&r!==void 0?r:0)<this.room.getOldestThreadedReceiptTs(),u=(a=(s=this.room.getLastUnthreadedReceiptFor(e))===null||s===void 0?void 0:s.ts)!==null&&a!==void 0?a:0,h=((o=this===null||this===void 0||(d=this.lastReply())===null||d===void 0?void 0:d.getTs())!==null&&o!==void 0?o:0)<u;if(l||h)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}c(xe,"hasServerSideSupport",dt.None);c(xe,"hasServerSideListSupport",dt.None);c(xe,"hasServerSideFwdPaginationSupport",dt.None);function Lm(i){return i.isEncrypted()&&(i.isRelation(De.name)||i.isThreadRoot)}var zr=new Qa("related_by_senders","io.element.relation_senders"),Yr=new Qa("related_by_rel_types","io.element.relation_types"),De=new Qa("m.thread","io.element.thread"),At=(function(i){return i[i.My=0]="My",i[i.All=1]="All",i})({});function Cl(i){return i===At.My?"participated":"all"}class Tu extends Error{constructor(e,t,r){super(t),this.code=e,c(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=Um(this,r)}}function Um(i,e){var t=i.name+"[msg: "+i.message;return e&&(t+=", "+Object.keys(e).map(r=>r+": "+e[r]).join(", ")),t+="]",t}var Iu=Object.freeze({visible:!0}),Ss=36e5,Me=(function(i){return i.Decrypted="Event.decrypted",i.BeforeRedaction="Event.beforeRedaction",i.VisibilityChange="Event.visibilityChange",i.LocalEventIdReplaced="Event.localEventIdReplaced",i.Status="Event.status",i.Replaced="Event.replaced",i.RelationsCreated="Event.relationsCreated",i.SentinelUpdated="Event.sentinelUpdated",i})({});class at extends Ke{setMetadata(e,t){var r,n,a=this.isState()&&this.getType()===F.RoomMember&&this.getSender()===this.getStateKey(),s=!1;if(a||!((r=this.sender)!==null&&r!==void 0&&(r=r.events)!==null&&r!==void 0&&r.member)){var o=e.getSentinelMember(this.getSender());o!==this.sender&&(s=!0),this.sender=o}if(a||!((n=this.target)!==null&&n!==void 0&&(n=n.events)!==null&&n!==void 0&&n.member)&&this.getType()===F.RoomMember){var d=e.getSentinelMember(this.getStateKey());d!==this.target&&(s=!0),this.target=d}this.isState()&&t&&(this.forwardLooking=!1),s&&this.emit(Me.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.event=t,c(this,"pushDetails",{}),c(this,"_replacingEvent",null),c(this,"_localRedactionEvent",null),c(this,"_isCancelled",!1),c(this,"clearEvent",void 0),c(this,"visibility",Iu),c(this,"_hasCachedExtEv",!1),c(this,"_cachedExtEv",void 0),c(this,"_decryptionFailureReason",null),c(this,"senderCurve25519Key",null),c(this,"claimedEd25519Key",null),c(this,"decryptionPromise",null),c(this,"retryDecryption",!1),c(this,"txnId",void 0),c(this,"thread",void 0),c(this,"threadId",void 0),c(this,"localTimestamp",void 0),c(this,"sender",null),c(this,"target",null),c(this,"status",null),c(this,"error",null),c(this,"forwardLooking",!0),c(this,"reEmitter",void 0),c(this,"unstableStickyExpiresAt",void 0),["state_key","type","sender","room_id","membership"].forEach(a=>{typeof t[a]=="string"&&(t[a]=Ts(t[a]))}),["membership","avatar_url","displayname"].forEach(a=>{var s;typeof((s=t.content)===null||s===void 0?void 0:s[a])=="string"&&(t.content[a]=Ts(t.content[a]))}),["rel_type"].forEach(a=>{var s;typeof((s=t.content)===null||s===void 0||(s=s["m.relates_to"])===null||s===void 0?void 0:s[a])=="string"&&(t.content["m.relates_to"][a]=Ts(t.content["m.relates_to"][a]))}),this.txnId=t.txn_id;var r=this.getAge(),n=Date.now();this.localTimestamp=r!==void 0?n-r:(e=this.getTs())!==null&&e!==void 0?e:n,this.reEmitter=new qn(this),this.unstableStickyInfo&&(this.unstableStickyInfo.duration_ttl_ms?this.unstableStickyExpiresAt=n+this.unstableStickyInfo.duration_ttl_ms:this.unstableStickyExpiresAt=Math.min(n,this.getTs())+this.unstableStickyInfo.duration_ms)}get unstableExtensibleEvent(){if(!this._hasCachedExtEv){var e;this._cachedExtEv=(e=Et.ExtensibleEvents.parse(this.getEffectiveEvent()))!==null&&e!==void 0?e:void 0}return this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===F.RoomMessageEncrypted)for(var[t,r]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||e[t]===void 0&&(e[t]=r);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e=this.getRoomId();if(e){var t;return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(e," ts=").concat((t=this.getDate())===null||t===void 0?void 0:t.toISOString())}else{var r=this.getContent()[Hi];return"msgid=".concat(r," type=").concat(this.getWireType()," sender=").concat(this.getSender())}}getOriginalContent(){var e;if(this._localRedactionEvent)return{};if(this.clearEvent){var t;return(t=this.clearEvent.content)!==null&&t!==void 0?t:{}}return(e=this.event.content)!==null&&e!==void 0?e:{}}getContent(){if(this._localRedactionEvent)return{};if(this._replacingEvent){var e;return(e=this._replacingEvent.getContent()["m.new_content"])!==null&&e!==void 0?e:{}}else return this.getOriginalContent()}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=(e=this.getWireContent())===null||e===void 0?void 0:e["m.relates_to"];if(t?.rel_type===De.name)return t.event_id;if(this.thread)return this.thread.id;if(this.threadId!==void 0)return this.threadId;var r=this.getUnsigned();if(typeof r[Di.name]=="string")return r[Di.name]}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(De.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return(e=this.getWireContent()["m.relates_to"])===null||e===void 0||(e=e["m.in_reply_to"])===null||e===void 0?void 0:e.event_id}get relationEventId(){var e;return(e=this.getWireContent())===null||e===void 0||(e=e["m.relates_to"])===null||e===void 0?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.clearEvent?this.clearEvent.state_key:this.event.state_key}getWireStateKey(){return this.event.state_key}isState(){return this.event.state_key!==void 0}getMembershipAtEvent(){var e=this.getUnsigned();return No.findIn(e)}makeEncrypted(e,t,r,n){this.clearEvent={type:this.event.type,content:this.event.content,state_key:this.event.state_key},this.event.type=e,this.event.content=t,this.senderCurve25519Key=r,this.claimedEd25519Key=n,this.isState()&&(this.event.state_key="".concat(this.clearEvent.type,":").concat(this.clearEvent.state_key))}isBeingDecrypted(){return this.decryptionPromise!=null}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return this._decryptionFailureReason!==null}get decryptionFailureReason(){return this._decryptionFailureReason}shouldAttemptDecryption(){return!(this.isRedacted()||this.isBeingDecrypted()||this.clearEvent||!this.isEncrypted())}attemptDecryption(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};if(!r.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var a=r.clearEvent&&!r.isDecryptionFailure();if(a)throw new Error("Attempt to decrypt event which has already been decrypted");return r.decryptionPromise?(O.log("Event ".concat(r.getId()," already being decrypted; queueing a retry")),r.retryDecryption=!0,r.decryptionPromise):(r.decryptionPromise=r.decryptionLoop(e,n),r.decryptionPromise)})()}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:{};for(yield Promise.resolve();;){r.retryDecryption=!1;var a=void 0;try{var s=yield e.decryptEvent(r);n.isRetry===!0&&O.info("Decrypted event on retry (".concat(r.getDetails(),")")),r.setClearData(s),r._decryptionFailureReason=null}catch(d){var o=d instanceof Tu?d.detailedString:String(d);if(a=d,r.retryDecryption){O.log("Error decrypting event (".concat(r.getDetails(),"), but retrying: ").concat(o));continue}O.warn("Error decrypting event (".concat(r.getDetails(),"): ").concat(o)),r.setClearDataForDecryptionFailure(String(d)),r._decryptionFailureReason=d instanceof Tu?d.code:Vp.UNKNOWN_ERROR}r.decryptionPromise=null,r.retryDecryption=!1,r.setPushDetails(),n.emit!==!1&&r.emit(Me.Decrypted,r,a);return}})()}setClearData(e){var t,r;this.clearEvent=e.clearEvent,this.senderCurve25519Key=(t=e.senderCurve25519Key)!==null&&t!==void 0?t:null,this.claimedEd25519Key=(r=e.claimedEd25519Key)!==null&&r!==void 0?r:null,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:F.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return this.event.type===F.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return[]}isKeySourceUntrusted(){return!1}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(Me.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,r,n=(t=e?.visible)!==null&&t!==void 0?t:!0,a=(r=e?.reason)!==null&&r!==void 0?r:null,s=!1;(this.visibility.visible!==n||!this.visibility.visible&&this.visibility.reason!==a)&&(s=!0),s&&(n?this.visibility=Iu:this.visibility=Object.freeze({visible:!1,reason:a}),this.emit(Me.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");this._localRedactionEvent=null,this.emit(Me.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;for(var r in this.event)this.event.hasOwnProperty(r)&&!Nm.has(r)&&delete this.event[r];this.isEncrypted()&&(this.clearEvent=void 0);var n=this.getType()in Cu?Cu[this.getType()]:{},a=this.getContent();for(var s in a)a.hasOwnProperty(s)&&!n[s]&&delete a[s];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var r of t.events){var n;((n=r.getRelation())===null||n===void 0?void 0:n.event_id)===this.getId()&&r.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;(t=this.thread)===null||t===void 0||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var r=e.getLiveTimeline();r.getTimelineSet().insertEventIntoTimeline(this,r,r.getState(te.FORWARDS),!1)}isRedacted(){return!!this.getUnsigned().redacted_because}isRedaction(){return this.getType()===F.RoomRedaction}asVisibilityChange(){if(!Sr.matches(this.getType()))return null;var e=this.getRelation();if(!e||e.rel_type!="m.reference")return null;var t=e.event_id;if(!t)return null;var r=this.getWireContent(),n=!!r.visible,a=r.reason;return a&&typeof a!="string"?null:{visible:n,reason:a,eventId:t}}isVisibilityEvent(){return Sr.matches(this.getType())}getRedactionEvent(){var e,t;if(!this.isRedacted())return null;if((e=this.clearEvent)!==null&&e!==void 0&&e.unsigned){var r,n;return(r=(n=this.clearEvent)===null||n===void 0?void 0:n.unsigned.redacted_because)!==null&&r!==void 0?r:null}else return(t=this.event.unsigned)!==null&&t!==void 0&&t.redacted_because?this.event.unsigned.redacted_because:{}}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,r=this.getUnsigned(),n=this.getId();this.event=e,r.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=r.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(Me.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-((t=this.getAge())!==null&&t!==void 0?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(Me.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(Me.LocalEventIdReplaced,this)}isRelation(e){var t,r=(t=this.getWireContent())===null||t===void 0?void 0:t["m.relates_to"];return this.isState()&&(r!=null&&r.rel_type)&&[Ue.Replace,Ue.Thread].includes(r.rel_type)?!1:!!(r!=null&&r.rel_type&&r.event_id&&(!e||r.rel_type===e))}getRelation(){var e;return this.isRelation()&&(e=this.getWireContent()["m.relates_to"])!==null&&e!==void 0?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=e??null,this.emit(Me.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return(t=this.getUnsigned()["m.relations"])===null||t===void 0?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(Ue.Replace);if(e)return e.event_id;if(this._replacingEvent)return this._replacingEvent.getId()}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(Ue.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var r;return(r=this._replacingEvent.getDate())!==null&&r!==void 0?r:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();if(this.replyEventId)return this.replyEventId;if(e)return e.event_id;if(this.isRedaction())return this.event.redacts}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new at(JSON.parse(JSON.stringify(this.event)));for(var[t,r]of Object.entries(this))t!=="event"&&(e[t]=r);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=Qs(this.event),r=Qs(e.event);return JSON.stringify(t)===JSON.stringify(r)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[vt.Update]),this.thread=e,this.setThreadId(e?.id),e&&this.reEmitter.reEmit(e,[vt.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}get unstableStickyInfo(){var e,t;if((e=this.event.msc4354_sticky)!==null&&e!==void 0&&e.duration_ms)return{duration_ms:Math.min(Ss,this.event.msc4354_sticky.duration_ms),duration_ttl_ms:(t=this.event.unsigned)===null||t===void 0?void 0:t.msc4354_sticky_duration_ttl_ms}}}var Nm=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),Cu={[F.RoomMember]:{membership:1},[F.RoomJoinRules]:{join_rule:1},[F.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}},xm=["1","2","3","4","5","6","7","8","9","10","11"];function Fm(i){return!xm.includes(i)}var Tt=(function(i){return i[i.NotStarted=0]="NotStarted",i[i.InProgress=1]="InProgress",i[i.Finished=2]="Finished",i})(Tt||{}),we=(function(i){return i.Events="RoomState.events",i.Members="RoomState.members",i.NewMember="RoomState.newMember",i.Update="RoomState.update",i.BeaconLiveness="RoomState.BeaconLiveness",i.Marker="RoomState.Marker",i})({});class Un extends Ke{constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{status:Tt.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,c(this,"reEmitter",new qn(this)),c(this,"sentinels",{}),c(this,"displayNameToUserIds",new Map),c(this,"userIdsToDisplayNames",{}),c(this,"tokenToInvite",{}),c(this,"joinedMemberCount",null),c(this,"summaryJoinedMemberCount",null),c(this,"invitedMemberCount",null),c(this,"summaryInvitedMemberCount",null),c(this,"modified",-1),c(this,"members",{}),c(this,"events",new Map),c(this,"paginationToken",null),c(this,"beacons",new Map),c(this,"_liveBeaconIds",[]),c(this,"getVersionWarning",!1),this.updateModifiedTime()}getRoomVersion(){var e,t=this.getStateEvents(F.RoomCreate,"");return t?(e=t.getContent().room_version)!==null&&e!==void 0?e:"1":(this.getVersionWarning||(O.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getJoinedMemberCount(){return this.summaryJoinedMemberCount!==null?this.summaryJoinedMemberCount:(this.joinedMemberCount===null&&(this.joinedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Se.Join?e+1:e,0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return this.summaryInvitedMemberCount!==null?this.summaryInvitedMemberCount:(this.invitedMemberCount===null&&(this.invitedMemberCount=this.getMembers().reduce((e,t)=>t.membership===Se.Invite?e+1:e,0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter(t=>!e.includes(t.userId))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(t===void 0){t=new Cn(this.roomId,e);var r=this.members[e];r!=null&&r.events.member&&t.setMembershipEvent(r.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return t===void 0?[]:null;if(t===void 0)return Array.from(this.events.get(e).values());var r=this.events.get(e).get(t);return r||null}get hasLiveBeacons(){var e;return!!((e=this.liveBeaconIds)!==null&&e!==void 0&&e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new Un(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=Tt.NotStarted,Array.from(this.events.values()).forEach(r=>{e.setStateEvents(Array.from(r.values()))}),this.oobMemberFlags.status=t,this.summaryInvitedMemberCount!==null&&e.setInvitedMemberCount(this.getInvitedMemberCount()),this.summaryJoinedMemberCount!==null&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==Tt.Finished&&this.getMembers().forEach(r=>{if(r.isOutOfBand()){var n;(n=e.getMember(r.userId))===null||n===void 0||n.markOutOfBand()}}),e}setUnknownStateEvents(e){var t=e.filter(r=>!this.events.has(r.getType())||!this.events.get(r.getType()).has(r.getStateKey()));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach(r=>{if(!(r.getRoomId()!==this.roomId||!r.isState())){hs.matches(r.getType())&&this.setBeacon(r);var n=this.getStateEventMatching(r);if(this.setStateEvent(r),r.getType()===F.RoomMember){var a;this.updateDisplayNameCache(r.getStateKey(),(a=r.getContent().displayname)!==null&&a!==void 0?a:""),this.updateThirdPartyTokenCache(r)}this.emit(we.Events,r,this,n)}}),this.onBeaconLivenessChange(),e.forEach(r=>{if(!(r.getRoomId()!==this.roomId||!r.isState()))if(r.getType()===F.RoomMember){var n=r.getStateKey();(r.getContent().membership===Se.Leave||r.getContent().membership===Se.Ban)&&(r.getContent().avatar_url=r.getContent().avatar_url||r.getPrevContent().avatar_url,r.getContent().displayname=r.getContent().displayname||r.getPrevContent().displayname);var a=this.getOrCreateMember(n,r);a.setMembershipEvent(r,this),this.updateMember(a),this.emit(we.Members,r,this,a)}else if(r.getType()===F.RoomPowerLevels){if(r.getStateKey()!=="")return;var s=Object.values(this.members),o=this.getStateEvents(F.RoomCreate,""),d=Ou(this.getRoomVersion(),o);s.forEach(l=>{var u=l.getLastModifiedTime();if(o){var h=ku(l.userId,r,d);l.setPowerLevel(h,r)}u!==l.getLastModifiedTime()&&this.emit(we.Members,r,this,l)}),this.sentinels={}}else Do.matches(r.getType())&&this.emit(we.Marker,r,t)}),this.emit(we.Update,this)}processBeaconEvents(e,t){var r=this;return _(function*(){if(!(!e.length||!r.beacons.size)){var n=[...r.beacons.values()].reduce((l,u)=>(l[u.beaconInfoId]=u,l),{}),a=(l,u)=>{if(Va.matches(u.getType())){var h=n[l];h&&h.addLocations([u])}},s=function*(u){var h,v=(h=u.getRelation())===null||h===void 0?void 0:h.event_id;if(!v||!n[v])return{v:void 0};if(!Va.matches(u.getType())&&!u.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(u),a(v,u)}catch{u.isDecryptionFailure()&&u.once(Me.Decrypted,_(function*(){a(v,u)}))}},o;for(var d of e)if(o=yield*s(d),o)return o.v}})()}getOrCreateMember(e,t){var r=this.members[e];return r||(r=new Cn(this.roomId,e),this.members[e]=r,this.emit(we.NewMember,t,this,r)),r}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=Ui(e);if(this.beacons.has(t)){var r=this.beacons.get(t);if(e.isRedacted()){var n;r.beaconInfoId===((n=e.getRedactionEvent())===null||n===void 0?void 0:n.redacts)&&(r.destroy(),this.beacons.delete(t));return}return r.update(e)}if(!e.isRedacted()){var a=new Ko(e);this.reEmitter.reEmit(a,[We.New,We.Update,We.Destroy,We.LivenessChange]),this.emit(We.New,e,a),a.on(We.LivenessChange,this.onBeaconLivenessChange.bind(this)),a.on(We.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(a.identifier,a)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter(e=>e.isLive).map(e=>e.identifier),this.emit(we.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,r;return(t=(r=this.events.get(e.getType()))===null||r===void 0?void 0:r.get(e.getStateKey()))!==null&&t!==void 0?t:null}updateMember(e){var t=this.getStateEvents(F.RoomCreate,""),r=this.getStateEvents(F.RoomPowerLevels,"");if(r&&t){var n=ku(e.userId,r,Ou(this.getRoomVersion(),t));e.setPowerLevel(n,r)}delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===Tt.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===Tt.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===Tt.NotStarted&&(this.oobMemberFlags.status=Tt.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===Tt.InProgress&&(this.oobMemberFlags.status=Tt.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach(t=>{var r=this.members[t];r.isOutOfBand()&&(++e,delete this.members[t])}),O.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=Tt.NotStarted}setOutOfBandMembers(e){O.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===Tt.InProgress&&(O.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=Tt.Finished,e.forEach(t=>this.setOutOfBandMember(t)),this.emit(we.Update,this))}setOutOfBandMember(e){if(e.getType()===F.RoomMember){var t=e.getStateKey(),r=this.getMember(t);if(!(r&&!r.isOutOfBand())){var n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit(we.Members,e,this,n)}}}setTypingEvent(e){Object.values(this.members).forEach(function(t){t.setTypingEvent(e)})}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return(t=this.displayNameToUserIds.get(Hr(e)))!==null&&t!==void 0?t:[]}maySendRedactionForEvent(e,t){var r=this.getMember(t);if(!r||r.membership===Se.Leave||e.status||e.isRedacted())return!1;var n=this.maySendEvent(F.RoomRedaction,t);return n?e.getSender()===t?!0:this.hasSufficientPowerLevelFor("redact",r.powerLevel):!1}hasSufficientPowerLevelFor(e,t){var r=this.getStateEvents(F.RoomPowerLevels,""),n={};r&&(n=r.getContent());var a=50;return Jl(n[e])&&(a=n[e]),t>=a}maySendMessage(e){return this.maySendEventOfType(F.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return t.isGuest()||!t.credentials.userId?!1:this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,r){var n,a=this.getStateEvents(F.RoomPowerLevels,""),s,o={},d=0,l=0;a&&(s=a.getContent(),o=s.events||{},Number.isSafeInteger(s.state_default)?d=s.state_default:d=50,Number.isSafeInteger(s.events_default)&&(l=s.events_default));var u=r?d:l;Number.isSafeInteger(o[e])&&(u=o[e]);var h=this.getMember(t),v=(n=h?.powerLevel)!==null&&n!==void 0?n:0;return v>=u}mayTriggerNotifOfType(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents(F.RoomPowerLevels,""),a=50;return n&&n.getContent()&&n.getContent().notifications&&Jl(n.getContent().notifications[e])&&(a=n.getContent().notifications[e]),r.powerLevel>=a}getJoinRule(){var e,t=this.getStateEvents(F.RoomJoinRules,""),r=(e=t?.getContent())!==null&&e!==void 0?e:{};return r.join_rule||ll.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(F.RoomHistoryVisibility,""),r=(e=t?.getContent())!==null&&e!==void 0?e:{};return r.history_visibility||cs.Shared}getGuestAccess(){var e,t=this.getStateEvents(F.RoomGuestAccess,""),r=(e=t?.getContent())!==null&&e!==void 0?e:{};return r.guest_access||xi.Forbidden}findPredecessor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(e){var t=this.getStateEvents(F.RoomPredecessor,"");if(t){var r=t.getContent(),n=r.predecessor_room_id,a=r.last_known_event_id;typeof a!="string"&&(a=void 0);var s=r.via_servers;if(Array.isArray(s)||(s=void 0),typeof n=="string")return{roomId:n,eventId:a,viaServers:s}}}var o=this.getStateEvents(F.RoomCreate,"");if(o){var d=o.getContent().predecessor;if(d){var l=d.room_id;if(typeof l=="string"){var u=d.event_id;return(typeof u!="string"||u==="")&&(u=void 0),{roomId:l,eventId:u}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var r=this.getStateEvents(F.RoomThirdPartyInvite,t);r&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var r=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],r){var n=Hr(r),a=this.displayNameToUserIds.get(n);if(a){var s=a.filter(u=>u!==e);this.displayNameToUserIds.set(n,s)}}this.userIdsToDisplayNames[e]=t;var o=t&&Hr(t);if(o){var d,l=(d=this.displayNameToUserIds.get(o))!==null&&d!==void 0?d:[];l.push(e),this.displayNameToUserIds.set(o,l)}}}function Ou(i,e){var t=new Set;if(Fm(i)&&e){var r=e.getSender();r&&t.add(r);var n=e.getDirectionalContent().additional_creators;Array.isArray(n)&&n.forEach(a=>t.add(a))}return t}function ku(i,e,t){if(t.has(i))return 1/0;var r=e.getDirectionalContent(),n=r.users||{};return n[i]!==void 0&&Number.isInteger(n[i])?n[i]:r.users_default!==void 0?r.users_default:0}function Mu(i){var e=typeof i=="string"&&!!i&&i!=="undefined"&&i!=="null";return e||typeof i=="number"}class bs{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};c(this,"rooms",{}),c(this,"users",{}),c(this,"syncToken",null),c(this,"filters",new lr(()=>new Map)),c(this,"accountData",new Map),c(this,"localStorage",void 0),c(this,"oobMembers",new Map),c(this,"pendingEvents",{}),c(this,"clientOptions",void 0),c(this,"pendingToDeviceBatches",[]),c(this,"nextToDeviceBatchId",0),c(this,"createUser",void 0),c(this,"onRoomMember",(t,r,n)=>{var a;if(n.membership!==Se.Invite){var s=this.users[n.userId]||((a=this.createUser)===null||a===void 0?void 0:a.call(this,n.userId));n.name&&(s.setDisplayName(n.name),n.events.member&&s.setRawDisplayName(n.events.member.getDirectionalContent().displayname)),n.events.member&&n.events.member.getContent().avatar_url&&s.setAvatarUrl(n.events.member.getContent().avatar_url),this.users[s.userId]=s}}),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(we.Members,this.onRoomMember),e.currentState.getMembers().forEach(t=>{this.onRoomMember(null,e.currentState,t)})}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(we.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map(function(e){return e.summary})}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,r,n){}storeFilter(e){!(e!=null&&e.userId)||!(e!=null&&e.filterId)||this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var r;return((r=this.filters.get(e))===null||r===void 0?void 0:r.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var r=this.localStorage.getItem(t);if(Mu(r))return r}catch{}return null}setFilterIdByName(e,t){if(this.localStorage){var r="mxjssdk_memory_filter_"+e;try{Mu(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch{}}}storeAccountDataEvents(e){e.forEach(t=>{var r=!Object.keys(t.getContent()).length;r?this.accountData.delete(t.getType()):this.accountData.set(t.getType(),t)})}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new lr(()=>new Map),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return _(function*(){var r;return(r=t.pendingEvents[e])!==null&&r!==void 0?r:[]})()}setPendingEvents(e,t){var r=this;return _(function*(){r.pendingEvents[e]=t})()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return _(function*(){return e.pendingToDeviceBatches.length===0?null:e.pendingToDeviceBatches[0]})()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter(t=>t.id!==e),Promise.resolve()}destroy(){return _(function*(){})()}}var Gs={},Nr={},fn={},Pu;function Ol(){if(Pu)return fn;Pu=1,Object.defineProperty(fn,"__esModule",{value:!0}),fn.WidgetApiDirection=void 0,fn.invertedDirection=e;var i=(function(t){return t.ToWidget="toWidget",t.FromWidget="fromWidget",t})({});fn.WidgetApiDirection=i;function e(t){if(t===i.ToWidget)return i.FromWidget;if(t===i.FromWidget)return i.ToWidget;throw new Error("Invalid direction")}return fn}var er={},Au;function kl(){if(Au)return er;Au=1,Object.defineProperty(er,"__esModule",{value:!0}),er.UnstableApiVersion=er.MatrixApiVersion=er.CurrentApiVersions=void 0;var i=(function(r){return r.Prerelease1="0.0.1",r.Prerelease2="0.0.2",r})({});er.MatrixApiVersion=i;var e=(function(r){return r.MSC2762="org.matrix.msc2762",r.MSC2762_UPDATE_STATE="org.matrix.msc2762_update_state",r.MSC2871="org.matrix.msc2871",r.MSC2873="org.matrix.msc2873",r.MSC2931="org.matrix.msc2931",r.MSC2974="org.matrix.msc2974",r.MSC2876="org.matrix.msc2876",r.MSC3819="org.matrix.msc3819",r.MSC3846="town.robin.msc3846",r.MSC3869="org.matrix.msc3869",r.MSC3973="org.matrix.msc3973",r.MSC4039="org.matrix.msc4039",r})({});er.UnstableApiVersion=e;var t=[i.Prerelease1,i.Prerelease2,e.MSC2762,e.MSC2762_UPDATE_STATE,e.MSC2871,e.MSC2873,e.MSC2931,e.MSC2974,e.MSC2876,e.MSC3819,e.MSC3846,e.MSC3869,e.MSC3973,e.MSC4039];return er.CurrentApiVersions=t,er}var si={},Du;function Ml(){if(Du)return si;Du=1,Object.defineProperty(si,"__esModule",{value:!0}),si.PostmessageTransport=void 0;var i=es(),e=Es(),t=["message"];function r(p){"@babel/helpers - typeof";return r=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(E){return typeof E}:function(E){return E&&typeof Symbol=="function"&&E.constructor===Symbol&&E!==Symbol.prototype?"symbol":typeof E},r(p)}function n(p,E){if(p==null)return{};var y=a(p,E),P,N;if(Object.getOwnPropertySymbols){var V=Object.getOwnPropertySymbols(p);for(N=0;N<V.length;N++)P=V[N],!(E.indexOf(P)>=0)&&Object.prototype.propertyIsEnumerable.call(p,P)&&(y[P]=p[P])}return y}function a(p,E){if(p==null)return{};var y={},P=Object.keys(p),N,V;for(V=0;V<P.length;V++)N=P[V],!(E.indexOf(N)>=0)&&(y[N]=p[N]);return y}function s(p,E){var y=Object.keys(p);if(Object.getOwnPropertySymbols){var P=Object.getOwnPropertySymbols(p);E&&(P=P.filter(function(N){return Object.getOwnPropertyDescriptor(p,N).enumerable})),y.push.apply(y,P)}return y}function o(p){for(var E=1;E<arguments.length;E++){var y=arguments[E]!=null?arguments[E]:{};E%2?s(Object(y),!0).forEach(function(P){S(p,P,y[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(p,Object.getOwnPropertyDescriptors(y)):s(Object(y)).forEach(function(P){Object.defineProperty(p,P,Object.getOwnPropertyDescriptor(y,P))})}return p}function d(p,E){if(!(p instanceof E))throw new TypeError("Cannot call a class as a function")}function l(p,E){for(var y=0;y<E.length;y++){var P=E[y];P.enumerable=P.enumerable||!1,P.configurable=!0,"value"in P&&(P.writable=!0),Object.defineProperty(p,I(P.key),P)}}function u(p,E,y){return E&&l(p.prototype,E),Object.defineProperty(p,"prototype",{writable:!1}),p}function h(p,E){if(typeof E!="function"&&E!==null)throw new TypeError("Super expression must either be null or a function");p.prototype=Object.create(E&&E.prototype,{constructor:{value:p,writable:!0,configurable:!0}}),Object.defineProperty(p,"prototype",{writable:!1}),E&&v(p,E)}function v(p,E){return v=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(P,N){return P.__proto__=N,P},v(p,E)}function m(p){var E=T();return function(){var P=R(p),N;if(E){var V=R(this).constructor;N=Reflect.construct(P,arguments,V)}else N=P.apply(this,arguments);return f(this,N)}}function f(p,E){if(E&&(r(E)==="object"||typeof E=="function"))return E;if(E!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return g(p)}function g(p){if(p===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return p}function T(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function R(p){return R=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(y){return y.__proto__||Object.getPrototypeOf(y)},R(p)}function S(p,E,y){return E=I(E),E in p?Object.defineProperty(p,E,{value:y,enumerable:!0,configurable:!0,writable:!0}):p[E]=y,p}function I(p){var E=b(p,"string");return r(E)==="symbol"?E:String(E)}function b(p,E){if(r(p)!=="object"||p===null)return p;var y=p[Symbol.toPrimitive];if(y!==void 0){var P=y.call(p,E);if(r(P)!=="object")return P;throw new TypeError("@@toPrimitive must return a primitive value.")}return(E==="string"?String:Number)(p)}var w=(function(p){h(y,p);var E=m(y);function y(P,N,V,Q){var le;return d(this,y),le=E.call(this),le.sendDirection=P,le.transportWindow=V,le.inboundWindow=Q,S(g(le),"strictOriginCheck",!1),S(g(le),"targetOrigin","*"),S(g(le),"timeoutSeconds",10),S(g(le),"_ready",!1),S(g(le),"_widgetId",void 0),S(g(le),"outboundRequests",new Map),S(g(le),"stopController",new AbortController),le._widgetId=N,le}return u(y,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){for(var N="widgetapi-".concat(Date.now()),V=0,Q=N;this.outboundRequests.has(Q);)Q="".concat(N,"-").concat(V++);return this.outboundRequests.set(Q,null),Q}},{key:"sendInternal",value:function(N){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),N),this.transportWindow.postMessage(N,this.targetOrigin)}},{key:"reply",value:function(N,V){return this.sendInternal(o(o({},N),{},{response:V}))}},{key:"send",value:function(N,V){return this.sendComplete(N,V).then(function(Q){return Q.response})}},{key:"sendComplete",value:function(N,V){var Q=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var le={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:N,data:V};return N===e.WidgetApiToWidgetAction.UpdateVisibility&&(le.visible=V.visible),new Promise(function(Ae,$){var ae=function(je){Re(),Ae(je)},se=function(je){Re(),$(je)},de=setTimeout(function(){return se(new Error("Request timed out"))},(Q.timeoutSeconds||1)*1e3),ve=function(){return se(new Error("Transport stopped"))};Q.stopController.signal.addEventListener("abort",ve);var Re=function(){Q.outboundRequests.delete(le.requestId),clearTimeout(de),Q.stopController.signal.removeEventListener("abort",ve)};Q.outboundRequests.set(le.requestId,{request:le,resolve:ae,reject:se}),Q.sendInternal(le)})}},{key:"start",value:function(){var N=this;this.inboundWindow.addEventListener("message",function(V){N.handleMessage(V)}),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(N){if(!this.stopController.signal.aborted&&N.data&&!(this.strictOriginCheck&&N.origin!==globalThis.origin)){var V=N.data;if(!(!V.action||!V.requestId||!V.widgetId))if(V.response){if(V.api!==this.sendDirection)return;this.handleResponse(V)}else{var Q=V;if(Q.api!==(0,e.invertedDirection)(this.sendDirection))return;this.handleRequest(Q)}}}},{key:"handleRequest",value:function(N){if(this.widgetId){if(this.widgetId!==N.widgetId)return}else this._widgetId=N.widgetId;this.emit("message",new CustomEvent("message",{detail:N}))}},{key:"handleResponse",value:function(N){if(N.widgetId===this.widgetId){var V=this.outboundRequests.get(N.requestId);if(V)if((0,e.isErrorResponse)(N.response)){var Q=N.response.error,le=Q.message,Ae=n(Q,t);V.reject(new e.WidgetApiResponseError(le,Ae))}else V.resolve(N)}}}]),y})(i.EventEmitter);return si.PostmessageTransport=w,si}var xr={},Lu;function Pl(){if(Lu)return xr;Lu=1,Object.defineProperty(xr,"__esModule",{value:!0}),xr.WidgetApiToWidgetAction=xr.WidgetApiFromWidgetAction=void 0;var i=(function(t){return t.SupportedApiVersions="supported_api_versions",t.Capabilities="capabilities",t.NotifyCapabilities="notify_capabilities",t.ThemeChange="theme_change",t.LanguageChange="language_change",t.TakeScreenshot="screenshot",t.UpdateVisibility="visibility",t.OpenIDCredentials="openid_credentials",t.WidgetConfig="widget_config",t.CloseModalWidget="close_modal",t.ButtonClicked="button_clicked",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.UpdateState="update_state",t.UpdateTurnServers="update_turn_servers",t})({});xr.WidgetApiToWidgetAction=i;var e=(function(t){return t.SupportedApiVersions="supported_api_versions",t.ContentLoaded="content_loaded",t.SendSticker="m.sticker",t.UpdateAlwaysOnScreen="set_always_on_screen",t.GetOpenIDCredentials="get_openid",t.CloseModalWidget="close_modal",t.OpenModalWidget="open_modal",t.SetModalButtonEnabled="set_button_enabled",t.SendEvent="send_event",t.SendToDevice="send_to_device",t.WatchTurnServers="watch_turn_servers",t.UnwatchTurnServers="unwatch_turn_servers",t.BeeperReadRoomAccountData="com.beeper.read_room_account_data",t.MSC2876ReadEvents="org.matrix.msc2876.read_events",t.MSC2931Navigate="org.matrix.msc2931.navigate",t.MSC2974RenegotiateCapabilities="org.matrix.msc2974.request_capabilities",t.MSC3869ReadRelations="org.matrix.msc3869.read_relations",t.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",t.MSC4039GetMediaConfigAction="org.matrix.msc4039.get_media_config",t.MSC4039UploadFileAction="org.matrix.msc4039.upload_file",t.MSC4039DownloadFileAction="org.matrix.msc4039.download_file",t.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",t.MSC4354SendStickyEvent="org.matrix.msc4354.send_sticky_event",t})({});return xr.WidgetApiFromWidgetAction=e,xr}var oi={},Uu;function Al(){if(Uu)return oi;Uu=1,Object.defineProperty(oi,"__esModule",{value:!0}),oi.OpenIDRequestState=void 0;var i=(function(e){return e.Allowed="allowed",e.Blocked="blocked",e.PendingUserConfirmation="request",e})({});return oi.OpenIDRequestState=i,oi}var li={},Nu;function Ph(){if(Nu)return li;Nu=1,Object.defineProperty(li,"__esModule",{value:!0}),li.MatrixWidgetType=void 0;var i=(function(e){return e.Custom="m.custom",e.JitsiMeet="m.jitsi",e.Stickerpicker="m.stickerpicker",e})({});return li.MatrixWidgetType=i,li}var di={},xu;function Ah(){if(xu)return di;xu=1,Object.defineProperty(di,"__esModule",{value:!0}),di.BuiltInModalButtonID=void 0;var i=(function(e){return e.Close="m.close",e})({});return di.BuiltInModalButtonID=i,di}var tr={},Fu;function Dl(){if(Fu)return tr;Fu=1,Object.defineProperty(tr,"__esModule",{value:!0}),tr.WidgetEventCapability=tr.EventKind=tr.EventDirection=void 0;function i(v){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m},i(v)}function e(v,m){var f=typeof Symbol<"u"&&v[Symbol.iterator]||v["@@iterator"];if(!f){if(Array.isArray(v)||(f=t(v))||m){f&&(v=f);var g=0,T=function(){};return{s:T,n:function(){return g>=v.length?{done:!0}:{done:!1,value:v[g++]}},e:function(w){throw w},f:T}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var R=!0,S=!1,I;return{s:function(){f=f.call(v)},n:function(){var w=f.next();return R=w.done,w},e:function(w){S=!0,I=w},f:function(){try{!R&&f.return!=null&&f.return()}finally{if(S)throw I}}}}function t(v,m){if(v){if(typeof v=="string")return r(v,m);var f=Object.prototype.toString.call(v).slice(8,-1);if(f==="Object"&&v.constructor&&(f=v.constructor.name),f==="Map"||f==="Set")return Array.from(v);if(f==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(f))return r(v,m)}}function r(v,m){(m==null||m>v.length)&&(m=v.length);for(var f=0,g=new Array(m);f<m;f++)g[f]=v[f];return g}function n(v,m){if(!(v instanceof m))throw new TypeError("Cannot call a class as a function")}function a(v,m){for(var f=0;f<m.length;f++){var g=m[f];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(v,o(g.key),g)}}function s(v,m,f){return m&&a(v.prototype,m),f&&a(v,f),Object.defineProperty(v,"prototype",{writable:!1}),v}function o(v){var m=d(v,"string");return i(m)==="symbol"?m:String(m)}function d(v,m){if(i(v)!=="object"||v===null)return v;var f=v[Symbol.toPrimitive];if(f!==void 0){var g=f.call(v,m);if(i(g)!=="object")return g;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(v)}var l=(function(v){return v.Event="event",v.State="state_event",v.ToDevice="to_device",v.RoomAccount="room_account",v})({});tr.EventKind=l;var u=(function(v){return v.Send="send",v.Receive="receive",v})({});tr.EventDirection=u;var h=(function(){function v(m,f,g,T,R){n(this,v),this.direction=m,this.eventType=f,this.kind=g,this.keyStr=T,this.raw=R}return s(v,[{key:"matchesAsStateEvent",value:function(f,g,T){return this.kind!==l.State||this.direction!==f||this.eventType!==g?!1:this.keyStr===null||this.keyStr===T}},{key:"matchesAsToDeviceEvent",value:function(f,g){return!(this.kind!==l.ToDevice||this.direction!==f||this.eventType!==g)}},{key:"matchesAsRoomEvent",value:function(f,g){var T=arguments.length>2&&arguments[2]!==void 0?arguments[2]:null;if(this.kind!==l.Event||this.direction!==f||this.eventType!==g)return!1;if(this.eventType==="m.room.message"){if(this.keyStr===null||this.keyStr===T)return!0}else return!0;return!1}},{key:"matchesAsRoomAccountData",value:function(f,g){return!(this.kind!==l.RoomAccount||this.direction!==f||this.eventType!==g)}}],[{key:"forStateEvent",value:function(f,g,T){g=g.replace(/#/g,"\\#"),T=T!=null?"#".concat(T):"";var R="org.matrix.msc2762.".concat(f,".state_event:").concat(g).concat(T);return v.findEventCapabilities([R])[0]}},{key:"forToDeviceEvent",value:function(f,g){var T="org.matrix.msc3819.".concat(f,".to_device:").concat(g);return v.findEventCapabilities([T])[0]}},{key:"forRoomEvent",value:function(f,g){var T="org.matrix.msc2762.".concat(f,".event:").concat(g);return v.findEventCapabilities([T])[0]}},{key:"forRoomMessageEvent",value:function(f,g){g=g??"";var T="org.matrix.msc2762.".concat(f,".event:m.room.message#").concat(g);return v.findEventCapabilities([T])[0]}},{key:"forRoomAccountData",value:function(f,g){var T="com.beeper.capabilities.".concat(f,".room_account_data:").concat(g);return v.findEventCapabilities([T])[0]}},{key:"findEventCapabilities",value:function(f){var g=[],T=e(f),R;try{for(T.s();!(R=T.n()).done;){var S=R.value,I=null,b=void 0,w=null;if(S.startsWith("org.matrix.msc2762.send.event:")?(I=u.Send,w=l.Event,b=S.substring(30)):S.startsWith("org.matrix.msc2762.send.state_event:")?(I=u.Send,w=l.State,b=S.substring(36)):S.startsWith("org.matrix.msc3819.send.to_device:")?(I=u.Send,w=l.ToDevice,b=S.substring(34)):S.startsWith("org.matrix.msc2762.receive.event:")?(I=u.Receive,w=l.Event,b=S.substring(33)):S.startsWith("org.matrix.msc2762.receive.state_event:")?(I=u.Receive,w=l.State,b=S.substring(39)):S.startsWith("org.matrix.msc3819.receive.to_device:")?(I=u.Receive,w=l.ToDevice,b=S.substring(37)):S.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(I=u.Receive,w=l.RoomAccount,b=S.substring(50)),!(I===null||w===null||b===void 0)){var p=b.startsWith("m.room.message#")||w===l.State,E=null;if(b.includes("#")&&p){var y=b.split("#"),P=y.findIndex(function(N){return!N.endsWith("\\")});b=y.slice(0,P+1).map(function(N){return N.endsWith("\\")?N.substring(0,N.length-1):N}).join("#"),E=y.slice(P+1).join("#")}g.push(new v(I,b,w,E,S))}}}catch(N){T.e(N)}finally{T.f()}return g}}]),v})();return tr.WidgetEventCapability=h,tr}var ui={},ju;function Ll(){if(ju)return ui;ju=1,Object.defineProperty(ui,"__esModule",{value:!0}),ui.Symbols=void 0;var i=(function(e){return e.AnyRoom="*",e})({});return ui.Symbols=i,ui}var ci={},Bu;function Ul(){if(Bu)return ci;Bu=1,Object.defineProperty(ci,"__esModule",{value:!0}),ci.UpdateDelayedEventAction=void 0;var i=(function(e){return e.Cancel="cancel",e.Restart="restart",e.Send="send",e})({});return ci.UpdateDelayedEventAction=i,ci}var Wu;function jm(){if(Wu)return Nr;Wu=1;function i(L){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(A){return typeof A}:function(A){return A&&typeof Symbol=="function"&&A.constructor===Symbol&&A!==Symbol.prototype?"symbol":typeof A},i(L)}Object.defineProperty(Nr,"__esModule",{value:!0}),Nr.WidgetApiResponseError=Nr.WidgetApi=void 0;var e=es(),t=Ol(),r=kl(),n=Ml(),a=Pl(),s=Al(),o=Ph(),d=Ah(),l=Dl(),u=Ll(),h=Ul();function v(){v=function(){return L};var L={},A=Object.prototype,k=A.hasOwnProperty,M=Object.defineProperty||function(B,K,G){B[K]=G.value},C=typeof Symbol=="function"?Symbol:{},U=C.iterator||"@@iterator",D=C.asyncIterator||"@@asyncIterator",x=C.toStringTag||"@@toStringTag";function j(B,K,G){return Object.defineProperty(B,K,{value:G,enumerable:!0,configurable:!0,writable:!0}),B[K]}try{j({},"")}catch{j=function(G,Y,ue){return G[Y]=ue}}function q(B,K,G,Y){var ue=K&&K.prototype instanceof he?K:he,ce=Object.create(ue.prototype),Te=new on(Y||[]);return M(ce,"_invoke",{value:_s(B,G,Te)}),ce}function J(B,K,G){try{return{type:"normal",arg:B.call(K,G)}}catch(Y){return{type:"throw",arg:Y}}}L.wrap=q;var fe={};function he(){}function oe(){}function Ie(){}var Be={};j(Be,U,function(){return this});var Je=Object.getPrototypeOf,ee=Je&&Je(Je(re([])));ee&&ee!==A&&k.call(ee,U)&&(Be=ee);var Oe=Ie.prototype=he.prototype=Object.create(Be);function an(B){["next","throw","return"].forEach(function(K){j(B,K,function(G){return this._invoke(K,G)})})}function Or(B,K){function G(ue,ce,Te,Ge){var He=J(B[ue],B,ce);if(He.type!=="throw"){var ft=He.arg,cr=ft.value;return cr&&i(cr)=="object"&&k.call(cr,"__await")?K.resolve(cr.__await).then(function(Mr){G("next",Mr,Te,Ge)},function(Mr){G("throw",Mr,Te,Ge)}):K.resolve(cr).then(function(Mr){ft.value=Mr,Te(ft)},function(Mr){return G("throw",Mr,Te,Ge)})}Ge(He.arg)}var Y;M(this,"_invoke",{value:function(ce,Te){function Ge(){return new K(function(He,ft){G(ce,Te,He,ft)})}return Y=Y?Y.then(Ge,Ge):Ge()}})}function _s(B,K,G){var Y="suspendedStart";return function(ue,ce){if(Y==="executing")throw new Error("Generator is already running");if(Y==="completed"){if(ue==="throw")throw ce;return z()}for(G.method=ue,G.arg=ce;;){var Te=G.delegate;if(Te){var Ge=sn(Te,G);if(Ge){if(Ge===fe)continue;return Ge}}if(G.method==="next")G.sent=G._sent=G.arg;else if(G.method==="throw"){if(Y==="suspendedStart")throw Y="completed",G.arg;G.dispatchException(G.arg)}else G.method==="return"&&G.abrupt("return",G.arg);Y="executing";var He=J(B,K,G);if(He.type==="normal"){if(Y=G.done?"completed":"suspendedYield",He.arg===fe)continue;return{value:He.arg,done:G.done}}He.type==="throw"&&(Y="completed",G.method="throw",G.arg=He.arg)}}}function sn(B,K){var G=K.method,Y=B.iterator[G];if(Y===void 0)return K.delegate=null,G==="throw"&&B.iterator.return&&(K.method="return",K.arg=void 0,sn(B,K),K.method==="throw")||G!=="return"&&(K.method="throw",K.arg=new TypeError("The iterator does not provide a '"+G+"' method")),fe;var ue=J(Y,B.iterator,K.arg);if(ue.type==="throw")return K.method="throw",K.arg=ue.arg,K.delegate=null,fe;var ce=ue.arg;return ce?ce.done?(K[B.resultName]=ce.value,K.next=B.nextLoc,K.method!=="return"&&(K.method="next",K.arg=void 0),K.delegate=null,fe):ce:(K.method="throw",K.arg=new TypeError("iterator result is not an object"),K.delegate=null,fe)}function Gn(B){var K={tryLoc:B[0]};1 in B&&(K.catchLoc=B[1]),2 in B&&(K.finallyLoc=B[2],K.afterLoc=B[3]),this.tryEntries.push(K)}function kr(B){var K=B.completion||{};K.type="normal",delete K.arg,B.completion=K}function on(B){this.tryEntries=[{tryLoc:"root"}],B.forEach(Gn,this),this.reset(!0)}function re(B){if(B){var K=B[U];if(K)return K.call(B);if(typeof B.next=="function")return B;if(!isNaN(B.length)){var G=-1,Y=function ue(){for(;++G<B.length;)if(k.call(B,G))return ue.value=B[G],ue.done=!1,ue;return ue.value=void 0,ue.done=!0,ue};return Y.next=Y}}return{next:z}}function z(){return{value:void 0,done:!0}}return oe.prototype=Ie,M(Oe,"constructor",{value:Ie,configurable:!0}),M(Ie,"constructor",{value:oe,configurable:!0}),oe.displayName=j(Ie,x,"GeneratorFunction"),L.isGeneratorFunction=function(B){var K=typeof B=="function"&&B.constructor;return!!K&&(K===oe||(K.displayName||K.name)==="GeneratorFunction")},L.mark=function(B){return Object.setPrototypeOf?Object.setPrototypeOf(B,Ie):(B.__proto__=Ie,j(B,x,"GeneratorFunction")),B.prototype=Object.create(Oe),B},L.awrap=function(B){return{__await:B}},an(Or.prototype),j(Or.prototype,D,function(){return this}),L.AsyncIterator=Or,L.async=function(B,K,G,Y,ue){ue===void 0&&(ue=Promise);var ce=new Or(q(B,K,G,Y),ue);return L.isGeneratorFunction(K)?ce:ce.next().then(function(Te){return Te.done?Te.value:ce.next()})},an(Oe),j(Oe,x,"Generator"),j(Oe,U,function(){return this}),j(Oe,"toString",function(){return"[object Generator]"}),L.keys=function(B){var K=Object(B),G=[];for(var Y in K)G.push(Y);return G.reverse(),function ue(){for(;G.length;){var ce=G.pop();if(ce in K)return ue.value=ce,ue.done=!1,ue}return ue.done=!0,ue}},L.values=re,on.prototype={constructor:on,reset:function(K){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(kr),!K)for(var G in this)G.charAt(0)==="t"&&k.call(this,G)&&!isNaN(+G.slice(1))&&(this[G]=void 0)},stop:function(){this.done=!0;var K=this.tryEntries[0].completion;if(K.type==="throw")throw K.arg;return this.rval},dispatchException:function(K){if(this.done)throw K;var G=this;function Y(ft,cr){return Te.type="throw",Te.arg=K,G.next=ft,cr&&(G.method="next",G.arg=void 0),!!cr}for(var ue=this.tryEntries.length-1;ue>=0;--ue){var ce=this.tryEntries[ue],Te=ce.completion;if(ce.tryLoc==="root")return Y("end");if(ce.tryLoc<=this.prev){var Ge=k.call(ce,"catchLoc"),He=k.call(ce,"finallyLoc");if(Ge&&He){if(this.prev<ce.catchLoc)return Y(ce.catchLoc,!0);if(this.prev<ce.finallyLoc)return Y(ce.finallyLoc)}else if(Ge){if(this.prev<ce.catchLoc)return Y(ce.catchLoc,!0)}else{if(!He)throw new Error("try statement without catch or finally");if(this.prev<ce.finallyLoc)return Y(ce.finallyLoc)}}}},abrupt:function(K,G){for(var Y=this.tryEntries.length-1;Y>=0;--Y){var ue=this.tryEntries[Y];if(ue.tryLoc<=this.prev&&k.call(ue,"finallyLoc")&&this.prev<ue.finallyLoc){var ce=ue;break}}ce&&(K==="break"||K==="continue")&&ce.tryLoc<=G&&G<=ce.finallyLoc&&(ce=null);var Te=ce?ce.completion:{};return Te.type=K,Te.arg=G,ce?(this.method="next",this.next=ce.finallyLoc,fe):this.complete(Te)},complete:function(K,G){if(K.type==="throw")throw K.arg;return K.type==="break"||K.type==="continue"?this.next=K.arg:K.type==="return"?(this.rval=this.arg=K.arg,this.method="return",this.next="end"):K.type==="normal"&&G&&(this.next=G),fe},finish:function(K){for(var G=this.tryEntries.length-1;G>=0;--G){var Y=this.tryEntries[G];if(Y.finallyLoc===K)return this.complete(Y.completion,Y.afterLoc),kr(Y),fe}},catch:function(K){for(var G=this.tryEntries.length-1;G>=0;--G){var Y=this.tryEntries[G];if(Y.tryLoc===K){var ue=Y.completion;if(ue.type==="throw"){var ce=ue.arg;kr(Y)}return ce}}throw new Error("illegal catch attempt")},delegateYield:function(K,G,Y){return this.delegate={iterator:re(K),resultName:G,nextLoc:Y},this.method==="next"&&(this.arg=void 0),fe}},L}function m(L,A,k,M,C,U,D){try{var x=L[U](D),j=x.value}catch(q){k(q);return}x.done?A(j):Promise.resolve(j).then(M,C)}function f(L){return function(){var A=this,k=arguments;return new Promise(function(M,C){var U=L.apply(A,k);function D(j){m(U,M,C,D,x,"next",j)}function x(j){m(U,M,C,D,x,"throw",j)}D(void 0)})}}function g(L,A){var k=Object.keys(L);if(Object.getOwnPropertySymbols){var M=Object.getOwnPropertySymbols(L);A&&(M=M.filter(function(C){return Object.getOwnPropertyDescriptor(L,C).enumerable})),k.push.apply(k,M)}return k}function T(L){for(var A=1;A<arguments.length;A++){var k=arguments[A]!=null?arguments[A]:{};A%2?g(Object(k),!0).forEach(function(M){b(L,M,k[M])}):Object.getOwnPropertyDescriptors?Object.defineProperties(L,Object.getOwnPropertyDescriptors(k)):g(Object(k)).forEach(function(M){Object.defineProperty(L,M,Object.getOwnPropertyDescriptor(k,M))})}return L}function R(L,A){var k=typeof Symbol<"u"&&L[Symbol.iterator]||L["@@iterator"];if(!k){if(Array.isArray(L)||(k=S(L))||A){k&&(L=k);var M=0,C=function(){};return{s:C,n:function(){return M>=L.length?{done:!0}:{done:!1,value:L[M++]}},e:function(q){throw q},f:C}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var U=!0,D=!1,x;return{s:function(){k=k.call(L)},n:function(){var q=k.next();return U=q.done,q},e:function(q){D=!0,x=q},f:function(){try{!U&&k.return!=null&&k.return()}finally{if(D)throw x}}}}function S(L,A){if(L){if(typeof L=="string")return I(L,A);var k=Object.prototype.toString.call(L).slice(8,-1);if(k==="Object"&&L.constructor&&(k=L.constructor.name),k==="Map"||k==="Set")return Array.from(L);if(k==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(k))return I(L,A)}}function I(L,A){(A==null||A>L.length)&&(A=L.length);for(var k=0,M=new Array(A);k<A;k++)M[k]=L[k];return M}function b(L,A,k){return A=E(A),A in L?Object.defineProperty(L,A,{value:k,enumerable:!0,configurable:!0,writable:!0}):L[A]=k,L}function w(L,A){for(var k=0;k<A.length;k++){var M=A[k];M.enumerable=M.enumerable||!1,M.configurable=!0,"value"in M&&(M.writable=!0),Object.defineProperty(L,E(M.key),M)}}function p(L,A,k){return A&&w(L.prototype,A),Object.defineProperty(L,"prototype",{writable:!1}),L}function E(L){var A=y(L,"string");return i(A)==="symbol"?A:String(A)}function y(L,A){if(i(L)!=="object"||L===null)return L;var k=L[Symbol.toPrimitive];if(k!==void 0){var M=k.call(L,A);if(i(M)!=="object")return M;throw new TypeError("@@toPrimitive must return a primitive value.")}return(A==="string"?String:Number)(L)}function P(L,A){if(!(L instanceof A))throw new TypeError("Cannot call a class as a function")}function N(L,A){if(typeof A!="function"&&A!==null)throw new TypeError("Super expression must either be null or a function");L.prototype=Object.create(A&&A.prototype,{constructor:{value:L,writable:!0,configurable:!0}}),Object.defineProperty(L,"prototype",{writable:!1}),A&&de(L,A)}function V(L){var A=ae();return function(){var M=ve(L),C;if(A){var U=ve(this).constructor;C=Reflect.construct(M,arguments,U)}else C=M.apply(this,arguments);return Q(this,C)}}function Q(L,A){if(A&&(i(A)==="object"||typeof A=="function"))return A;if(A!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return le(L)}function le(L){if(L===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return L}function Ae(L){var A=typeof Map=="function"?new Map:void 0;return Ae=function(M){if(M===null||!se(M))return M;if(typeof M!="function")throw new TypeError("Super expression must either be null or a function");if(typeof A<"u"){if(A.has(M))return A.get(M);A.set(M,C)}function C(){return $(M,arguments,ve(this).constructor)}return C.prototype=Object.create(M.prototype,{constructor:{value:C,enumerable:!1,writable:!0,configurable:!0}}),de(C,M)},Ae(L)}function $(L,A,k){return ae()?$=Reflect.construct.bind():$=function(C,U,D){var x=[null];x.push.apply(x,U);var j=Function.bind.apply(C,x),q=new j;return D&&de(q,D.prototype),q},$.apply(null,arguments)}function ae(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function se(L){return Function.toString.call(L).indexOf("[native code]")!==-1}function de(L,A){return de=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(M,C){return M.__proto__=C,M},de(L,A)}function ve(L){return ve=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(k){return k.__proto__||Object.getPrototypeOf(k)},ve(L)}function Re(L){return new Qt(L,0)}function et(L){return function(){return new je(L.apply(this,arguments))}}function je(L){var A,k;function M(U,D){try{var x=L[U](D),j=x.value,q=j instanceof Qt;Promise.resolve(q?j.v:j).then(function(J){if(q){var fe=U==="return"?"return":"next";if(!j.k||J.done)return M(fe,J);J=L[fe](J).value}C(x.done?"return":"normal",J)},function(J){M("throw",J)})}catch(J){C("throw",J)}}function C(U,D){switch(U){case"return":A.resolve({value:D,done:!0});break;case"throw":A.reject(D);break;default:A.resolve({value:D,done:!1})}(A=A.next)?M(A.key,A.arg):k=null}this._invoke=function(U,D){return new Promise(function(x,j){var q={key:U,arg:D,resolve:x,reject:j,next:null};k?k=k.next=q:(A=k=q,M(U,D))})},typeof L.return!="function"&&(this.return=void 0)}je.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},je.prototype.next=function(L){return this._invoke("next",L)},je.prototype.throw=function(L){return this._invoke("throw",L)},je.prototype.return=function(L){return this._invoke("return",L)};function Qt(L,A){this.v=L,this.k=A}var H=(function(L){N(k,L);var A=V(k);function k(M,C){var U;return P(this,k),U=A.call(this,M),U.data=C,U}return p(k)})(Ae(Error));Nr.WidgetApiResponseError=H,H.prototype.name=H.name;var X=(function(L){N(k,L);var A=V(k);function k(){var M,C=arguments.length>0&&arguments[0]!==void 0?arguments[0]:null,U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;if(P(this,k),M=A.call(this),b(le(M),"transport",void 0),b(le(M),"capabilitiesFinished",!1),b(le(M),"supportsMSC2974Renegotiate",!1),b(le(M),"requestedCapabilities",[]),b(le(M),"approvedCapabilities",void 0),b(le(M),"cachedClientVersions",void 0),b(le(M),"turnServerWatchers",0),!globalThis.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return M.transport=new n.PostmessageTransport(t.WidgetApiDirection.FromWidget,C,globalThis.parent,globalThis),M.transport.targetOrigin=U,M.transport.on("message",M.handleMessage.bind(le(M))),M}return p(k,[{key:"hasCapability",value:function(C){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(C):this.requestedCapabilities.includes(C)}},{key:"requestCapability",value:function(C){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(C)}},{key:"requestCapabilities",value:function(C){var U=R(C),D;try{for(U.s();!(D=U.n()).done;){var x=D.value;this.requestCapability(x)}}catch(j){U.e(j)}finally{U.f()}}},{key:"requestCapabilityForRoomTimeline",value:function(C){this.requestCapability("org.matrix.msc2762.timeline:".concat(C))}},{key:"requestCapabilityToSendState",value:function(C,U){this.requestCapability(l.WidgetEventCapability.forStateEvent(l.EventDirection.Send,C,U).raw)}},{key:"requestCapabilityToReceiveState",value:function(C,U){this.requestCapability(l.WidgetEventCapability.forStateEvent(l.EventDirection.Receive,C,U).raw)}},{key:"requestCapabilityToSendToDevice",value:function(C){this.requestCapability(l.WidgetEventCapability.forToDeviceEvent(l.EventDirection.Send,C).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(C){this.requestCapability(l.WidgetEventCapability.forToDeviceEvent(l.EventDirection.Receive,C).raw)}},{key:"requestCapabilityToSendEvent",value:function(C){this.requestCapability(l.WidgetEventCapability.forRoomEvent(l.EventDirection.Send,C).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(C){this.requestCapability(l.WidgetEventCapability.forRoomEvent(l.EventDirection.Receive,C).raw)}},{key:"requestCapabilityToSendMessage",value:function(C){this.requestCapability(l.WidgetEventCapability.forRoomMessageEvent(l.EventDirection.Send,C).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(C){this.requestCapability(l.WidgetEventCapability.forRoomMessageEvent(l.EventDirection.Receive,C).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(C){this.requestCapability(l.WidgetEventCapability.forRoomAccountData(l.EventDirection.Receive,C).raw)}},{key:"requestOpenIDConnectToken",value:function(){var C=this;return new Promise(function(U,D){C.transport.sendComplete(a.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then(function(x){var j=x.response;if(j.state===s.OpenIDRequestState.Allowed)U(j);else if(j.state===s.OpenIDRequestState.Blocked)D(new Error("User declined to verify their identity"));else if(j.state===s.OpenIDRequestState.PendingUserConfirmation){var q=function J(fe){fe.preventDefault();var he=fe.detail;he.data.original_request_id===x.requestId&&(he.data.state===s.OpenIDRequestState.Allowed?(U(he.data),C.transport.reply(he,{})):he.data.state===s.OpenIDRequestState.Blocked?(D(new Error("User declined to verify their identity")),C.transport.reply(he,{})):(D(new Error("Invalid state on reply: "+j.state)),C.transport.reply(he,{error:{message:"Invalid state"}})),C.off("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),J))};C.on("action:".concat(a.WidgetApiToWidgetAction.OpenIDCredentials),q)}else D(new Error("Invalid state: "+j.state))}).catch(D)})}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(a.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(C){return this.transport.send(a.WidgetApiFromWidgetAction.SendSticker,C).then()}},{key:"setAlwaysOnScreen",value:function(C){return this.transport.send(a.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:C}).then(function(U){return U.success})}},{key:"openModalWidget",value:function(C,U){var D=arguments.length>2&&arguments[2]!==void 0?arguments[2]:[],x=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{},j=arguments.length>4&&arguments[4]!==void 0?arguments[4]:o.MatrixWidgetType.Custom;return this.transport.send(a.WidgetApiFromWidgetAction.OpenModalWidget,{type:j,url:C,name:U,buttons:D,data:x}).then()}},{key:"closeModalWidget",value:function(){var C=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return this.transport.send(a.WidgetApiFromWidgetAction.CloseModalWidget,C).then()}},{key:"sendRoomEvent",value:function(C,U,D,x,j,q){return this.sendEvent(C,void 0,U,D,x,j,q)}},{key:"sendStateEvent",value:function(C,U,D,x,j,q){return this.sendEvent(C,U,D,x,j,q)}},{key:"sendEvent",value:function(C,U,D,x,j,q,J){return this.transport.send(a.WidgetApiFromWidgetAction.SendEvent,T(T(T(T(T({type:C,content:D},U!==void 0&&{state_key:U}),x!==void 0&&{room_id:x}),j!==void 0&&{delay:j}),q!==void 0&&{parent_delay_id:q}),J!==void 0&&{sticky_duration_ms:J}))}},{key:"cancelScheduledDelayedEvent",value:function(C){return this.transport.send(a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:C,action:h.UpdateDelayedEventAction.Cancel})}},{key:"restartScheduledDelayedEvent",value:function(C){return this.transport.send(a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:C,action:h.UpdateDelayedEventAction.Restart})}},{key:"sendScheduledDelayedEvent",value:function(C){return this.transport.send(a.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:C,action:h.UpdateDelayedEventAction.Send})}},{key:"sendToDevice",value:function(C,U,D){return this.transport.send(a.WidgetApiFromWidgetAction.SendToDevice,{type:C,encrypted:U,messages:D})}},{key:"readRoomAccountData",value:function(C,U){var D={type:C};return U&&(U.includes(u.Symbols.AnyRoom)?D.room_ids=u.Symbols.AnyRoom:D.room_ids=U),this.transport.send(a.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,D).then(function(x){return x.events})}},{key:"readRoomEvents",value:function(C,U,D,x,j){var q={type:C,msgtype:D};return U!==void 0&&(q.limit=U),x&&(x.includes(u.Symbols.AnyRoom)?q.room_ids=u.Symbols.AnyRoom:q.room_ids=x),j&&(q.since=j),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,q).then(function(J){return J.events})}},{key:"readEventRelations",value:(function(){var M=f(v().mark(function U(D,x,j,q,J,fe,he,oe){var Ie,Be;return v().wrap(function(ee){for(;;)switch(ee.prev=ee.next){case 0:return ee.next=2,this.getClientVersions();case 2:if(Ie=ee.sent,Ie.includes(r.UnstableApiVersion.MSC3869)){ee.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return Be={event_id:D,rel_type:j,event_type:q,room_id:x,to:he,from:fe,limit:J,direction:oe},ee.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3869ReadRelations,Be));case 7:case"end":return ee.stop()}},U,this)}));function C(U,D,x,j,q,J,fe,he){return M.apply(this,arguments)}return C})()},{key:"readStateEvents",value:function(C,U,D,x){var j={type:C,state_key:D===void 0?!0:D};return U!==void 0&&(j.limit=U),x&&(x.includes(u.Symbols.AnyRoom)?j.room_ids=u.Symbols.AnyRoom:j.room_ids=x),this.transport.send(a.WidgetApiFromWidgetAction.MSC2876ReadEvents,j).then(function(q){return q.events})}},{key:"setModalButtonEnabled",value:function(C,U){if(C===d.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(a.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:C,enabled:U}).then()}},{key:"navigateTo",value:function(C){if(!C||!C.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(a.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:C}).then()}},{key:"getTurnServers",value:function(){var C=this;return et(v().mark(function U(){var D,x;return v().wrap(function(q){for(;;)switch(q.prev=q.next){case 0:if(x=(function(){var J=f(v().mark(function fe(he){return v().wrap(function(Ie){for(;;)switch(Ie.prev=Ie.next){case 0:he.preventDefault(),D(he.detail.data),C.transport.reply(he.detail,{});case 3:case"end":return Ie.stop()}},fe)}));return function(he){return J.apply(this,arguments)}})(),C.on("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),x),C.turnServerWatchers!==0){q.next=12;break}return q.prev=3,q.next=6,Re(C.transport.send(a.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:q.next=12;break;case 8:throw q.prev=8,q.t0=q.catch(3),C.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),x),q.t0;case 12:C.turnServerWatchers++,q.prev=13;case 14:return q.next=17,Re(new Promise(function(J){return D=J}));case 17:return q.next=19,q.sent;case 19:q.next=14;break;case 21:if(q.prev=21,C.off("action:".concat(a.WidgetApiToWidgetAction.UpdateTurnServers),x),C.turnServerWatchers--,C.turnServerWatchers!==0){q.next=27;break}return q.next=27,Re(C.transport.send(a.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return q.finish(21);case 28:case"end":return q.stop()}},U,null,[[3,8],[13,,21,28]])}))()}},{key:"searchUserDirectory",value:(function(){var M=f(v().mark(function U(D,x){var j,q;return v().wrap(function(fe){for(;;)switch(fe.prev=fe.next){case 0:return fe.next=2,this.getClientVersions();case 2:if(j=fe.sent,j.includes(r.UnstableApiVersion.MSC3973)){fe.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return q={search_term:D,limit:x},fe.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,q));case 7:case"end":return fe.stop()}},U,this)}));function C(U,D){return M.apply(this,arguments)}return C})()},{key:"getMediaConfig",value:(function(){var M=f(v().mark(function U(){var D,x;return v().wrap(function(q){for(;;)switch(q.prev=q.next){case 0:return q.next=2,this.getClientVersions();case 2:if(D=q.sent,D.includes(r.UnstableApiVersion.MSC4039)){q.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return x={},q.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,x));case 7:case"end":return q.stop()}},U,this)}));function C(){return M.apply(this,arguments)}return C})()},{key:"uploadFile",value:(function(){var M=f(v().mark(function U(D){var x,j;return v().wrap(function(J){for(;;)switch(J.prev=J.next){case 0:return J.next=2,this.getClientVersions();case 2:if(x=J.sent,x.includes(r.UnstableApiVersion.MSC4039)){J.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return j={file:D},J.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039UploadFileAction,j));case 7:case"end":return J.stop()}},U,this)}));function C(U){return M.apply(this,arguments)}return C})()},{key:"downloadFile",value:(function(){var M=f(v().mark(function U(D){var x,j;return v().wrap(function(J){for(;;)switch(J.prev=J.next){case 0:return J.next=2,this.getClientVersions();case 2:if(x=J.sent,x.includes(r.UnstableApiVersion.MSC4039)){J.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return j={content_uri:D},J.abrupt("return",this.transport.send(a.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,j));case 7:case"end":return J.stop()}},U,this)}));function C(U){return M.apply(this,arguments)}return C})()},{key:"start",value:function(){var C=this;this.transport.start(),this.getClientVersions().then(function(U){U.includes(r.UnstableApiVersion.MSC2974)&&(C.supportsMSC2974Renegotiate=!0)})}},{key:"handleMessage",value:function(C){var U=new CustomEvent("action:".concat(C.detail.action),{detail:C.detail,cancelable:!0});if(this.emit("action:".concat(C.detail.action),U),!U.defaultPrevented)switch(C.detail.action){case a.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(C.detail);case a.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(C.detail);case a.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(C.detail,{});case a.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(C.detail,{});default:return this.transport.reply(C.detail,{error:{message:"Unknown or unsupported action: "+C.detail.action}})}}},{key:"replyVersions",value:function(C){this.transport.reply(C,{supported_versions:r.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var C=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(a.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then(function(U){return C.cachedClientVersions=U.supported_versions,U.supported_versions}).catch(function(U){return console.warn("non-fatal error getting supported client versions: ",U),[]})}},{key:"handleCapabilities",value:function(C){var U=this;return this.capabilitiesFinished?this.transport.reply(C,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then(function(D){return D.includes(r.UnstableApiVersion.MSC2871)?U.once("action:".concat(a.WidgetApiToWidgetAction.NotifyCapabilities),function(x){U.approvedCapabilities=x.detail.data.approved,U.emit("ready")}):U.emit("ready"),U.capabilitiesFinished=!0,U.transport.reply(C,{capabilities:U.requestedCapabilities})})}}]),k})(e.EventEmitter);return Nr.WidgetApi=X,Nr}var hi={},kt={},Ku;function Dh(){if(Ku)return kt;Ku=1,Object.defineProperty(kt,"__esModule",{value:!0}),kt.VideoConferenceCapabilities=kt.StickerpickerCapabilities=kt.MatrixCapabilities=void 0,kt.getTimelineRoomIDFromCapability=a,kt.isTimelineCapability=r,kt.isTimelineCapabilityFor=n;var i=(function(s){return s.Screenshots="m.capability.screenshot",s.StickerSending="m.sticker",s.AlwaysOnScreen="m.always_on_screen",s.RequiresClient="io.element.requires_client",s.MSC2931Navigate="org.matrix.msc2931.navigate",s.MSC3846TurnServers="town.robin.msc3846.turn_servers",s.MSC3973UserDirectorySearch="org.matrix.msc3973.user_directory_search",s.MSC4039UploadFile="org.matrix.msc4039.upload_file",s.MSC4039DownloadFile="org.matrix.msc4039.download_file",s.MSC4157SendDelayedEvent="org.matrix.msc4157.send.delayed_event",s.MSC4157UpdateDelayedEvent="org.matrix.msc4157.update_delayed_event",s.MSC4354SendStickyEvent="org.matrix.msc4354.send_sticky_event",s})({});kt.MatrixCapabilities=i;var e=[i.StickerSending];kt.StickerpickerCapabilities=e;var t=[i.AlwaysOnScreen];kt.VideoConferenceCapabilities=t;function r(s){return s?.startsWith("org.matrix.msc2762.timeline:")}function n(s,o){return s==="org.matrix.msc2762.timeline:".concat(o)}function a(s){return s.substring(s.indexOf(":")+1)}return kt}var vi={},qu;function Lh(){if(qu)return vi;qu=1,Object.defineProperty(vi,"__esModule",{value:!0}),vi.SimpleObservable=void 0;function i(h){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(v){return typeof v}:function(v){return v&&typeof Symbol=="function"&&v.constructor===Symbol&&v!==Symbol.prototype?"symbol":typeof v},i(h)}function e(h,v){var m=typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(!m){if(Array.isArray(h)||(m=t(h))||v){m&&(h=m);var f=0,g=function(){};return{s:g,n:function(){return f>=h.length?{done:!0}:{done:!1,value:h[f++]}},e:function(b){throw b},f:g}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var T=!0,R=!1,S;return{s:function(){m=m.call(h)},n:function(){var b=m.next();return T=b.done,b},e:function(b){R=!0,S=b},f:function(){try{!T&&m.return!=null&&m.return()}finally{if(R)throw S}}}}function t(h,v){if(h){if(typeof h=="string")return r(h,v);var m=Object.prototype.toString.call(h).slice(8,-1);if(m==="Object"&&h.constructor&&(m=h.constructor.name),m==="Map"||m==="Set")return Array.from(h);if(m==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(m))return r(h,v)}}function r(h,v){(v==null||v>h.length)&&(v=h.length);for(var m=0,f=new Array(v);m<v;m++)f[m]=h[m];return f}function n(h,v){if(!(h instanceof v))throw new TypeError("Cannot call a class as a function")}function a(h,v){for(var m=0;m<v.length;m++){var f=v[m];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(h,d(f.key),f)}}function s(h,v,m){return v&&a(h.prototype,v),Object.defineProperty(h,"prototype",{writable:!1}),h}function o(h,v,m){return v=d(v),v in h?Object.defineProperty(h,v,{value:m,enumerable:!0,configurable:!0,writable:!0}):h[v]=m,h}function d(h){var v=l(h,"string");return i(v)==="symbol"?v:String(v)}function l(h,v){if(i(h)!=="object"||h===null)return h;var m=h[Symbol.toPrimitive];if(m!==void 0){var f=m.call(h,v);if(i(f)!=="object")return f;throw new TypeError("@@toPrimitive must return a primitive value.")}return(v==="string"?String:Number)(h)}var u=(function(){function h(v){n(this,h),o(this,"listeners",[]),v&&this.listeners.push(v)}return s(h,[{key:"onUpdate",value:function(m){this.listeners.push(m)}},{key:"update",value:function(m){var f=e(this.listeners),g;try{for(f.s();!(g=f.n()).done;){var T=g.value;T(m)}}catch(R){f.e(R)}finally{f.f()}}},{key:"close",value:function(){this.listeners=[]}}]),h})();return vi.SimpleObservable=u,vi}var Vu;function Bm(){if(Vu)return hi;Vu=1,Object.defineProperty(hi,"__esModule",{value:!0}),hi.ClientWidgetApi=void 0;var i=es(),e=Ml(),t=Ol(),r=Pl(),n=Dh(),a=kl(),s=Dl(),o=Al(),d=Lh(),l=Ll(),u=Ul();function h(H){"@babel/helpers - typeof";return h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(X){return typeof X}:function(X){return X&&typeof Symbol=="function"&&X.constructor===Symbol&&X!==Symbol.prototype?"symbol":typeof X},h(H)}function v(H,X){var L=Object.keys(H);if(Object.getOwnPropertySymbols){var A=Object.getOwnPropertySymbols(H);X&&(A=A.filter(function(k){return Object.getOwnPropertyDescriptor(H,k).enumerable})),L.push.apply(L,A)}return L}function m(H){for(var X=1;X<arguments.length;X++){var L=arguments[X]!=null?arguments[X]:{};X%2?v(Object(L),!0).forEach(function(A){de(H,A,L[A])}):Object.getOwnPropertyDescriptors?Object.defineProperties(H,Object.getOwnPropertyDescriptors(L)):v(Object(L)).forEach(function(A){Object.defineProperty(H,A,Object.getOwnPropertyDescriptor(L,A))})}return H}function f(H,X){var L=typeof Symbol<"u"&&H[Symbol.iterator]||H["@@iterator"];if(!L){if(Array.isArray(H)||(L=R(H))||X){L&&(H=L);var A=0,k=function(){};return{s:k,n:function(){return A>=H.length?{done:!0}:{done:!1,value:H[A++]}},e:function(x){throw x},f:k}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var M=!0,C=!1,U;return{s:function(){L=L.call(H)},n:function(){var x=L.next();return M=x.done,x},e:function(x){C=!0,U=x},f:function(){try{!M&&L.return!=null&&L.return()}finally{if(C)throw U}}}}function g(H){return I(H)||S(H)||R(H)||T()}function T(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function R(H,X){if(H){if(typeof H=="string")return b(H,X);var L=Object.prototype.toString.call(H).slice(8,-1);if(L==="Object"&&H.constructor&&(L=H.constructor.name),L==="Map"||L==="Set")return Array.from(H);if(L==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(L))return b(H,X)}}function S(H){if(typeof Symbol<"u"&&H[Symbol.iterator]!=null||H["@@iterator"]!=null)return Array.from(H)}function I(H){if(Array.isArray(H))return b(H)}function b(H,X){(X==null||X>H.length)&&(X=H.length);for(var L=0,A=new Array(X);L<X;L++)A[L]=H[L];return A}function w(){w=function(){return H};var H={},X=Object.prototype,L=X.hasOwnProperty,A=Object.defineProperty||function(re,z,B){re[z]=B.value},k=typeof Symbol=="function"?Symbol:{},M=k.iterator||"@@iterator",C=k.asyncIterator||"@@asyncIterator",U=k.toStringTag||"@@toStringTag";function D(re,z,B){return Object.defineProperty(re,z,{value:B,enumerable:!0,configurable:!0,writable:!0}),re[z]}try{D({},"")}catch{D=function(B,K,G){return B[K]=G}}function x(re,z,B,K){var G=z&&z.prototype instanceof J?z:J,Y=Object.create(G.prototype),ue=new Gn(K||[]);return A(Y,"_invoke",{value:an(re,B,ue)}),Y}function j(re,z,B){try{return{type:"normal",arg:re.call(z,B)}}catch(K){return{type:"throw",arg:K}}}H.wrap=x;var q={};function J(){}function fe(){}function he(){}var oe={};D(oe,M,function(){return this});var Ie=Object.getPrototypeOf,Be=Ie&&Ie(Ie(kr([])));Be&&Be!==X&&L.call(Be,M)&&(oe=Be);var Je=he.prototype=J.prototype=Object.create(oe);function ee(re){["next","throw","return"].forEach(function(z){D(re,z,function(B){return this._invoke(z,B)})})}function Oe(re,z){function B(G,Y,ue,ce){var Te=j(re[G],re,Y);if(Te.type!=="throw"){var Ge=Te.arg,He=Ge.value;return He&&h(He)=="object"&&L.call(He,"__await")?z.resolve(He.__await).then(function(ft){B("next",ft,ue,ce)},function(ft){B("throw",ft,ue,ce)}):z.resolve(He).then(function(ft){Ge.value=ft,ue(Ge)},function(ft){return B("throw",ft,ue,ce)})}ce(Te.arg)}var K;A(this,"_invoke",{value:function(Y,ue){function ce(){return new z(function(Te,Ge){B(Y,ue,Te,Ge)})}return K=K?K.then(ce,ce):ce()}})}function an(re,z,B){var K="suspendedStart";return function(G,Y){if(K==="executing")throw new Error("Generator is already running");if(K==="completed"){if(G==="throw")throw Y;return on()}for(B.method=G,B.arg=Y;;){var ue=B.delegate;if(ue){var ce=Or(ue,B);if(ce){if(ce===q)continue;return ce}}if(B.method==="next")B.sent=B._sent=B.arg;else if(B.method==="throw"){if(K==="suspendedStart")throw K="completed",B.arg;B.dispatchException(B.arg)}else B.method==="return"&&B.abrupt("return",B.arg);K="executing";var Te=j(re,z,B);if(Te.type==="normal"){if(K=B.done?"completed":"suspendedYield",Te.arg===q)continue;return{value:Te.arg,done:B.done}}Te.type==="throw"&&(K="completed",B.method="throw",B.arg=Te.arg)}}}function Or(re,z){var B=z.method,K=re.iterator[B];if(K===void 0)return z.delegate=null,B==="throw"&&re.iterator.return&&(z.method="return",z.arg=void 0,Or(re,z),z.method==="throw")||B!=="return"&&(z.method="throw",z.arg=new TypeError("The iterator does not provide a '"+B+"' method")),q;var G=j(K,re.iterator,z.arg);if(G.type==="throw")return z.method="throw",z.arg=G.arg,z.delegate=null,q;var Y=G.arg;return Y?Y.done?(z[re.resultName]=Y.value,z.next=re.nextLoc,z.method!=="return"&&(z.method="next",z.arg=void 0),z.delegate=null,q):Y:(z.method="throw",z.arg=new TypeError("iterator result is not an object"),z.delegate=null,q)}function _s(re){var z={tryLoc:re[0]};1 in re&&(z.catchLoc=re[1]),2 in re&&(z.finallyLoc=re[2],z.afterLoc=re[3]),this.tryEntries.push(z)}function sn(re){var z=re.completion||{};z.type="normal",delete z.arg,re.completion=z}function Gn(re){this.tryEntries=[{tryLoc:"root"}],re.forEach(_s,this),this.reset(!0)}function kr(re){if(re){var z=re[M];if(z)return z.call(re);if(typeof re.next=="function")return re;if(!isNaN(re.length)){var B=-1,K=function G(){for(;++B<re.length;)if(L.call(re,B))return G.value=re[B],G.done=!1,G;return G.value=void 0,G.done=!0,G};return K.next=K}}return{next:on}}function on(){return{value:void 0,done:!0}}return fe.prototype=he,A(Je,"constructor",{value:he,configurable:!0}),A(he,"constructor",{value:fe,configurable:!0}),fe.displayName=D(he,U,"GeneratorFunction"),H.isGeneratorFunction=function(re){var z=typeof re=="function"&&re.constructor;return!!z&&(z===fe||(z.displayName||z.name)==="GeneratorFunction")},H.mark=function(re){return Object.setPrototypeOf?Object.setPrototypeOf(re,he):(re.__proto__=he,D(re,U,"GeneratorFunction")),re.prototype=Object.create(Je),re},H.awrap=function(re){return{__await:re}},ee(Oe.prototype),D(Oe.prototype,C,function(){return this}),H.AsyncIterator=Oe,H.async=function(re,z,B,K,G){G===void 0&&(G=Promise);var Y=new Oe(x(re,z,B,K),G);return H.isGeneratorFunction(z)?Y:Y.next().then(function(ue){return ue.done?ue.value:Y.next()})},ee(Je),D(Je,U,"Generator"),D(Je,M,function(){return this}),D(Je,"toString",function(){return"[object Generator]"}),H.keys=function(re){var z=Object(re),B=[];for(var K in z)B.push(K);return B.reverse(),function G(){for(;B.length;){var Y=B.pop();if(Y in z)return G.value=Y,G.done=!1,G}return G.done=!0,G}},H.values=kr,Gn.prototype={constructor:Gn,reset:function(z){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(sn),!z)for(var B in this)B.charAt(0)==="t"&&L.call(this,B)&&!isNaN(+B.slice(1))&&(this[B]=void 0)},stop:function(){this.done=!0;var z=this.tryEntries[0].completion;if(z.type==="throw")throw z.arg;return this.rval},dispatchException:function(z){if(this.done)throw z;var B=this;function K(Ge,He){return ue.type="throw",ue.arg=z,B.next=Ge,He&&(B.method="next",B.arg=void 0),!!He}for(var G=this.tryEntries.length-1;G>=0;--G){var Y=this.tryEntries[G],ue=Y.completion;if(Y.tryLoc==="root")return K("end");if(Y.tryLoc<=this.prev){var ce=L.call(Y,"catchLoc"),Te=L.call(Y,"finallyLoc");if(ce&&Te){if(this.prev<Y.catchLoc)return K(Y.catchLoc,!0);if(this.prev<Y.finallyLoc)return K(Y.finallyLoc)}else if(ce){if(this.prev<Y.catchLoc)return K(Y.catchLoc,!0)}else{if(!Te)throw new Error("try statement without catch or finally");if(this.prev<Y.finallyLoc)return K(Y.finallyLoc)}}}},abrupt:function(z,B){for(var K=this.tryEntries.length-1;K>=0;--K){var G=this.tryEntries[K];if(G.tryLoc<=this.prev&&L.call(G,"finallyLoc")&&this.prev<G.finallyLoc){var Y=G;break}}Y&&(z==="break"||z==="continue")&&Y.tryLoc<=B&&B<=Y.finallyLoc&&(Y=null);var ue=Y?Y.completion:{};return ue.type=z,ue.arg=B,Y?(this.method="next",this.next=Y.finallyLoc,q):this.complete(ue)},complete:function(z,B){if(z.type==="throw")throw z.arg;return z.type==="break"||z.type==="continue"?this.next=z.arg:z.type==="return"?(this.rval=this.arg=z.arg,this.method="return",this.next="end"):z.type==="normal"&&B&&(this.next=B),q},finish:function(z){for(var B=this.tryEntries.length-1;B>=0;--B){var K=this.tryEntries[B];if(K.finallyLoc===z)return this.complete(K.completion,K.afterLoc),sn(K),q}},catch:function(z){for(var B=this.tryEntries.length-1;B>=0;--B){var K=this.tryEntries[B];if(K.tryLoc===z){var G=K.completion;if(G.type==="throw"){var Y=G.arg;sn(K)}return Y}}throw new Error("illegal catch attempt")},delegateYield:function(z,B,K){return this.delegate={iterator:kr(z),resultName:B,nextLoc:K},this.method==="next"&&(this.arg=void 0),q}},H}function p(H,X,L,A,k,M,C){try{var U=H[M](C),D=U.value}catch(x){L(x);return}U.done?X(D):Promise.resolve(D).then(A,k)}function E(H){return function(){var X=this,L=arguments;return new Promise(function(A,k){var M=H.apply(X,L);function C(D){p(M,A,k,C,U,"next",D)}function U(D){p(M,A,k,C,U,"throw",D)}C(void 0)})}}function y(H,X){if(!(H instanceof X))throw new TypeError("Cannot call a class as a function")}function P(H,X){for(var L=0;L<X.length;L++){var A=X[L];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(H,ve(A.key),A)}}function N(H,X,L){return X&&P(H.prototype,X),Object.defineProperty(H,"prototype",{writable:!1}),H}function V(H,X){if(typeof X!="function"&&X!==null)throw new TypeError("Super expression must either be null or a function");H.prototype=Object.create(X&&X.prototype,{constructor:{value:H,writable:!0,configurable:!0}}),Object.defineProperty(H,"prototype",{writable:!1}),X&&Q(H,X)}function Q(H,X){return Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(A,k){return A.__proto__=k,A},Q(H,X)}function le(H){var X=ae();return function(){var A=se(H),k;if(X){var M=se(this).constructor;k=Reflect.construct(A,arguments,M)}else k=A.apply(this,arguments);return Ae(this,k)}}function Ae(H,X){if(X&&(h(X)==="object"||typeof X=="function"))return X;if(X!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return $(H)}function $(H){if(H===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return H}function ae(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function se(H){return se=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(L){return L.__proto__||Object.getPrototypeOf(L)},se(H)}function de(H,X,L){return X=ve(X),X in H?Object.defineProperty(H,X,{value:L,enumerable:!0,configurable:!0,writable:!0}):H[X]=L,H}function ve(H){var X=Re(H,"string");return h(X)==="symbol"?X:String(X)}function Re(H,X){if(h(H)!=="object"||H===null)return H;var L=H[Symbol.toPrimitive];if(L!==void 0){var A=L.call(H,X);if(h(A)!=="object")return A;throw new TypeError("@@toPrimitive must return a primitive value.")}return(X==="string"?String:Number)(H)}function et(H){var X,L,A,k=2;for(typeof Symbol<"u"&&(L=Symbol.asyncIterator,A=Symbol.iterator);k--;){if(L&&(X=H[L])!=null)return X.call(H);if(A&&(X=H[A])!=null)return new je(X.call(H));L="@@asyncIterator",A="@@iterator"}throw new TypeError("Object is not async iterable")}function je(H){function X(L){if(Object(L)!==L)return Promise.reject(new TypeError(L+" is not an object."));var A=L.done;return Promise.resolve(L.value).then(function(k){return{value:k,done:A}})}return je=function(A){this.s=A,this.n=A.next},je.prototype={s:null,n:null,next:function(){return X(this.n.apply(this.s,arguments))},return:function(A){var k=this.s.return;return k===void 0?Promise.resolve({value:A,done:!0}):X(k.apply(this.s,arguments))},throw:function(A){var k=this.s.return;return k===void 0?Promise.reject(A):X(k.apply(this.s,arguments))}},new je(H)}var Qt=(function(H){V(L,H);var X=le(L);function L(A,k,M){var C;if(y(this,L),C=X.call(this),C.widget=A,C.driver=M,de($(C),"transport",void 0),de($(C),"cachedWidgetVersions",null),de($(C),"contentLoadedActionSent",!1),de($(C),"allowedCapabilities",new Set),de($(C),"allowedEvents",[]),de($(C),"isStopped",!1),de($(C),"turnServers",null),de($(C),"contentLoadedWaitTimer",void 0),de($(C),"pushRoomStateTasks",new Set),de($(C),"pushRoomStateResult",new Map),de($(C),"flushRoomStateTask",null),de($(C),"viewedRoomId",null),!(k!=null&&k.contentWindow))throw new Error("No iframe supplied");if(!A)throw new Error("Invalid widget");if(!M)throw new Error("Invalid driver");return C.transport=new e.PostmessageTransport(t.WidgetApiDirection.ToWidget,A.id,k.contentWindow,globalThis),C.transport.targetOrigin=A.origin,C.transport.on("message",C.handleMessage.bind($(C))),k.addEventListener("load",C.onIframeLoad.bind($(C))),C.transport.start(),C}return N(L,[{key:"hasCapability",value:function(k){return this.allowedCapabilities.has(k)}},{key:"canUseRoomTimeline",value:function(k){return this.hasCapability("org.matrix.msc2762.timeline:".concat(l.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(k))}},{key:"canSendRoomEvent",value:function(k){var M=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(C){return C.matchesAsRoomEvent(s.EventDirection.Send,k,M)})}},{key:"canSendStateEvent",value:function(k,M){return this.allowedEvents.some(function(C){return C.matchesAsStateEvent(s.EventDirection.Send,k,M)})}},{key:"canSendToDeviceEvent",value:function(k){return this.allowedEvents.some(function(M){return M.matchesAsToDeviceEvent(s.EventDirection.Send,k)})}},{key:"canReceiveRoomEvent",value:function(k){var M=arguments.length>1&&arguments[1]!==void 0?arguments[1]:null;return this.allowedEvents.some(function(C){return C.matchesAsRoomEvent(s.EventDirection.Receive,k,M)})}},{key:"canReceiveStateEvent",value:function(k,M){return this.allowedEvents.some(function(C){return C.matchesAsStateEvent(s.EventDirection.Receive,k,M)})}},{key:"canReceiveToDeviceEvent",value:function(k){return this.allowedEvents.some(function(M){return M.matchesAsToDeviceEvent(s.EventDirection.Receive,k)})}},{key:"canReceiveRoomAccountData",value:function(k){return this.allowedEvents.some(function(M){return M.matchesAsRoomAccountData(s.EventDirection.Receive,k)})}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:(function(){var A=E(w().mark(function M(){var C;return w().wrap(function(D){for(;;)switch(D.prev=D.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){D.next=2;break}return D.abrupt("return",this.cachedWidgetVersions);case 2:return D.prev=2,D.next=5,this.transport.send(r.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return C=D.sent,this.cachedWidgetVersions=C.supported_versions,D.abrupt("return",C.supported_versions);case 10:return D.prev=10,D.t0=D.catch(2),console.warn("non-fatal error getting supported widget versions: ",D.t0),D.abrupt("return",[]);case 14:case"end":return D.stop()}},M,this,[[2,10]])}));function k(){return A.apply(this,arguments)}return k})()},{key:"beginCapabilities",value:function(){var k=this;this.emit("preparing");var M;this.transport.send(r.WidgetApiToWidgetAction.Capabilities,{}).then(function(C){return M=C.capabilities,k.driver.validateCapabilities(new Set(C.capabilities))}).then(function(C){k.allowCapabilities(g(C),M),k.emit("ready")}).catch(function(C){k.emit("error:preparing",C)})}},{key:"allowCapabilities",value:function(k,M){var C,U=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),k);var D=f(k),x;try{for(D.s();!(x=D.n()).done;){var j=x.value;this.allowedCapabilities.add(j)}}catch(ee){D.e(ee)}finally{D.f()}var q=s.WidgetEventCapability.findEventCapabilities(k);(C=this.allowedEvents).push.apply(C,g(q)),this.transport.send(r.WidgetApiToWidgetAction.NotifyCapabilities,{requested:M,approved:Array.from(this.allowedCapabilities)}).catch(function(ee){console.warn("non-fatal error notifying widget of approved capabilities:",ee)}).then(function(){U.emit("capabilitiesNotified")});var J=f(k),fe;try{for(J.s();!(fe=J.n()).done;){var he=fe.value;if((0,n.isTimelineCapability)(he)){var oe=(0,n.getTimelineRoomIDFromCapability)(he);if(oe===l.Symbols.AnyRoom){var Ie=f(this.driver.getKnownRooms()),Be;try{for(Ie.s();!(Be=Ie.n()).done;){var Je=Be.value;this.pushRoomState(Je)}}catch(ee){Ie.e(ee)}finally{Ie.f()}}else this.pushRoomState(oe)}}}catch(ee){J.e(ee)}finally{J.f()}q.length>0&&this.viewedRoomId!==null&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(k){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout(function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")},1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(k){if(this.contentLoadedWaitTimer!==void 0&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(k,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(k,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(k){this.transport.reply(k,{supported_versions:a.CurrentApiVersions})}},{key:"supportsUpdateState",value:(function(){var A=E(w().mark(function M(){return w().wrap(function(U){for(;;)switch(U.prev=U.next){case 0:return U.next=2,this.getWidgetVersions();case 2:return U.abrupt("return",U.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return U.stop()}},M,this)}));function k(){return A.apply(this,arguments)}return k})()},{key:"handleCapabilitiesRenegotiate",value:function(k){var M,C=this;this.transport.reply(k,{});var U=((M=k.data)===null||M===void 0?void 0:M.capabilities)||[],D=new Set(U.filter(function(x){return!C.hasCapability(x)}));D.size===0&&this.allowCapabilities([],[]),this.driver.validateCapabilities(D).then(function(x){return C.allowCapabilities(g(x),g(D))})}},{key:"handleNavigate",value:function(k){var M,C=this;if(!this.hasCapability(n.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(k,{error:{message:"Missing capability"}});if(!((M=k.data)!==null&&M!==void 0&&M.uri.startsWith("https://matrix.to/#")))return this.transport.reply(k,{error:{message:"Invalid matrix.to URI"}});var U=function(x){console.error("[ClientWidgetApi] Failed to handle navigation: ",x),C.handleDriverError(x,k,"Error handling navigation")};try{this.driver.navigate(k.data.uri.toString()).catch(function(D){return U(D)}).then(function(){return C.transport.reply(k,{})})}catch(D){return U(D)}}},{key:"handleOIDC",value:function(k){var M=this,C=1,U=function(q,J){return J=J||{},C>1?M.transport.send(r.WidgetApiToWidgetAction.OpenIDCredentials,m({state:q,original_request_id:k.requestId},J)):M.transport.reply(k,m({state:q},J))},D=function(q){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",q),C>1?U(o.OpenIDRequestState.Blocked):M.transport.reply(k,{error:{message:q}})},x=new d.SimpleObservable(function(j){if(j.state===o.OpenIDRequestState.PendingUserConfirmation&&C>1)return x.close(),D("client provided out-of-phase response to OIDC flow");if(j.state===o.OpenIDRequestState.PendingUserConfirmation){U(j.state),C++;return}return j.state===o.OpenIDRequestState.Allowed&&!j.token?D("client provided invalid OIDC token for an allowed request"):(j.state===o.OpenIDRequestState.Blocked&&(j.token=void 0),x.close(),U(j.state,j.token))});this.driver.askOpenID(x)}},{key:"handleReadRoomAccountData",value:function(k){var M=this,C=this.driver.readRoomAccountData(k.data.type);return this.canReceiveRoomAccountData(k.data.type)?C.then(function(U){M.transport.reply(k,{events:U})}):this.transport.reply(k,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:(function(){var A=E(w().mark(function M(C){var U=this,D,x,j,q,J,fe,he,oe,Ie,Be;return w().wrap(function(ee){for(;;)switch(ee.prev=ee.next){case 0:if(C.data.type){ee.next=2;break}return ee.abrupt("return",this.transport.reply(C,{error:{message:"Invalid request - missing event type"}}));case 2:if(!(C.data.limit!==void 0&&(!C.data.limit||C.data.limit<0))){ee.next=4;break}return ee.abrupt("return",this.transport.reply(C,{error:{message:"Invalid request - limit out of range"}}));case 4:if(C.data.room_ids!==void 0){ee.next=8;break}D=this.viewedRoomId===null?[]:[this.viewedRoomId],ee.next=30;break;case 8:if(C.data.room_ids!==l.Symbols.AnyRoom){ee.next=12;break}D=this.driver.getKnownRooms().filter(function(Oe){return U.canUseRoomTimeline(Oe)}),ee.next=30;break;case 12:D=C.data.room_ids,x=f(D),ee.prev=14,x.s();case 16:if((j=x.n()).done){ee.next=22;break}if(q=j.value,this.canUseRoomTimeline(q)){ee.next=20;break}return ee.abrupt("return",this.transport.reply(C,{error:{message:"Unable to access room timeline: ".concat(q)}}));case 20:ee.next=16;break;case 22:ee.next=27;break;case 24:ee.prev=24,ee.t0=ee.catch(14),x.e(ee.t0);case 27:return ee.prev=27,x.f(),ee.finish(27);case 30:if(J=C.data.limit||0,fe=C.data.since,he=void 0,oe=void 0,C.data.state_key===void 0){ee.next=40;break}if(he=C.data.state_key===!0?void 0:C.data.state_key.toString(),this.canReceiveStateEvent(C.data.type,(Ie=he)!==null&&Ie!==void 0?Ie:null)){ee.next=38;break}return ee.abrupt("return",this.transport.reply(C,{error:{message:"Cannot read state events of this type"}}));case 38:ee.next=43;break;case 40:if(oe=C.data.msgtype,this.canReceiveRoomEvent(C.data.type,oe)){ee.next=43;break}return ee.abrupt("return",this.transport.reply(C,{error:{message:"Cannot read room events of this type"}}));case 43:if(!(C.data.room_ids===void 0&&D.length===0)){ee.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),ee.next=47,C.data.state_key===void 0?this.driver.readRoomEvents(C.data.type,oe,J,null,fe):this.driver.readStateEvents(C.data.type,he,J,null);case 47:Be=ee.sent,ee.next=68;break;case 50:return ee.next=52,this.supportsUpdateState();case 52:if(!ee.sent){ee.next=58;break}return ee.next=55,Promise.all(D.map(function(Oe){return U.driver.readRoomTimeline(Oe,C.data.type,oe,he,J,fe)}));case 55:Be=ee.sent.flat(1),ee.next=68;break;case 58:if(C.data.state_key!==void 0){ee.next=64;break}return ee.next=61,Promise.all(D.map(function(Oe){return U.driver.readRoomTimeline(Oe,C.data.type,oe,he,J,fe)}));case 61:ee.t1=ee.sent,ee.next=67;break;case 64:return ee.next=66,Promise.all(D.map(function(Oe){return U.driver.readRoomState(Oe,C.data.type,he)}));case 66:ee.t1=ee.sent;case 67:Be=ee.t1.flat(1);case 68:this.transport.reply(C,{events:Be});case 69:case"end":return ee.stop()}},M,this,[[14,24,27,30]])}));function k(M){return A.apply(this,arguments)}return k})()},{key:"handleSendEvent",value:function(k){var M=this;if(!k.data.type)return this.transport.reply(k,{error:{message:"Invalid request - missing event type"}});if(k.data.room_id&&!this.canUseRoomTimeline(k.data.room_id))return this.transport.reply(k,{error:{message:"Unable to access room timeline: ".concat(k.data.room_id)}});var C=k.data.delay!==void 0||k.data.parent_delay_id!==void 0;if(C&&!this.hasCapability(n.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(k,{error:{message:"Missing capability for ".concat(n.MatrixCapabilities.MSC4157SendDelayedEvent)}});var U=k.data.sticky_duration_ms!==void 0;if(U&&!this.hasCapability(n.MatrixCapabilities.MSC4354SendStickyEvent))return this.transport.reply(k,{error:{message:"Missing capability for ".concat(n.MatrixCapabilities.MSC4354SendStickyEvent)}});var D;if(k.data.state_key!==void 0){if(!this.canSendStateEvent(k.data.type,k.data.state_key))return this.transport.reply(k,{error:{message:"Cannot send state events of this type"}});if(U)return this.transport.reply(k,{error:{message:"Cannot send a state event with a sticky duration"}});if(C){var x,j;D=this.driver.sendDelayedEvent((x=k.data.delay)!==null&&x!==void 0?x:null,(j=k.data.parent_delay_id)!==null&&j!==void 0?j:null,k.data.type,k.data.content||{},k.data.state_key,k.data.room_id)}else D=this.driver.sendEvent(k.data.type,k.data.content||{},k.data.state_key,k.data.room_id)}else{var q=k.data.content||{},J=q.msgtype;if(!this.canSendRoomEvent(k.data.type,J))return this.transport.reply(k,{error:{message:"Cannot send room events of this type"}});var fe=[k.data.type,q,null,k.data.room_id];if(C&&k.data.sticky_duration_ms){var he,oe;D=this.driver.sendDelayedStickyEvent((he=k.data.delay)!==null&&he!==void 0?he:null,(oe=k.data.parent_delay_id)!==null&&oe!==void 0?oe:null,k.data.sticky_duration_ms,k.data.type,q,k.data.room_id)}else if(C){var Ie,Be,Je;D=(Ie=this.driver).sendDelayedEvent.apply(Ie,[(Be=k.data.delay)!==null&&Be!==void 0?Be:null,(Je=k.data.parent_delay_id)!==null&&Je!==void 0?Je:null].concat(fe))}else if(k.data.sticky_duration_ms)D=this.driver.sendStickyEvent(k.data.sticky_duration_ms,k.data.type,q,k.data.room_id);else{var ee;D=(ee=this.driver).sendEvent.apply(ee,fe)}}D.then(function(Oe){return M.transport.reply(k,m({room_id:Oe.roomId},"eventId"in Oe?{event_id:Oe.eventId}:{delay_id:Oe.delayId}))}).catch(function(Oe){console.error("error sending event: ",Oe),M.handleDriverError(Oe,k,"Error sending event")})}},{key:"handleUpdateDelayedEvent",value:function(k){var M=this;if(!k.data.delay_id)return this.transport.reply(k,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(n.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(k,{error:{message:"Missing capability"}});var C;switch(k.data.action){case u.UpdateDelayedEventAction.Cancel:C=this.driver.cancelScheduledDelayedEvent;break;case u.UpdateDelayedEventAction.Restart:C=this.driver.restartScheduledDelayedEvent;break;case u.UpdateDelayedEventAction.Send:C=this.driver.sendScheduledDelayedEvent;break;default:return this.transport.reply(k,{error:{message:"Invalid request - unsupported action"}})}C.call(this.driver,k.data.delay_id).then(function(){return M.transport.reply(k,{})}).catch(function(U){console.error("error updating delayed event: ",U),M.handleDriverError(U,k,"Error updating delayed event")})}},{key:"handleSendToDevice",value:(function(){var A=E(w().mark(function M(C){return w().wrap(function(D){for(;;)switch(D.prev=D.next){case 0:if(C.data.type){D.next=4;break}this.transport.reply(C,{error:{message:"Invalid request - missing event type"}}),D.next=26;break;case 4:if(C.data.messages){D.next=8;break}this.transport.reply(C,{error:{message:"Invalid request - missing event contents"}}),D.next=26;break;case 8:if(typeof C.data.encrypted=="boolean"){D.next=12;break}this.transport.reply(C,{error:{message:"Invalid request - missing encryption flag"}}),D.next=26;break;case 12:if(this.canSendToDeviceEvent(C.data.type)){D.next=16;break}this.transport.reply(C,{error:{message:"Cannot send to-device events of this type"}}),D.next=26;break;case 16:return D.prev=16,D.next=19,this.driver.sendToDevice(C.data.type,C.data.encrypted,C.data.messages);case 19:this.transport.reply(C,{}),D.next=26;break;case 22:D.prev=22,D.t0=D.catch(16),console.error("error sending to-device event",D.t0),this.handleDriverError(D.t0,C,"Error sending event");case 26:case"end":return D.stop()}},M,this,[[16,22]])}));function k(M){return A.apply(this,arguments)}return k})()},{key:"pollTurnServers",value:(function(){var A=E(w().mark(function M(C,U){var D,x,j,q,J,fe;return w().wrap(function(oe){for(;;)switch(oe.prev=oe.next){case 0:return oe.prev=0,oe.next=3,this.transport.send(r.WidgetApiToWidgetAction.UpdateTurnServers,U);case 3:D=!1,x=!1,oe.prev=5,q=et(C);case 7:return oe.next=9,q.next();case 9:if(!(D=!(J=oe.sent).done)){oe.next=16;break}return fe=J.value,oe.next=13,this.transport.send(r.WidgetApiToWidgetAction.UpdateTurnServers,fe);case 13:D=!1,oe.next=7;break;case 16:oe.next=22;break;case 18:oe.prev=18,oe.t0=oe.catch(5),x=!0,j=oe.t0;case 22:if(oe.prev=22,oe.prev=23,!(D&&q.return!=null)){oe.next=27;break}return oe.next=27,q.return();case 27:if(oe.prev=27,!x){oe.next=30;break}throw j;case 30:return oe.finish(27);case 31:return oe.finish(22);case 32:oe.next=37;break;case 34:oe.prev=34,oe.t1=oe.catch(0),console.error("error polling for TURN servers",oe.t1);case 37:case"end":return oe.stop()}},M,this,[[0,34],[5,18,22,32],[23,,27,31]])}));function k(M,C){return A.apply(this,arguments)}return k})()},{key:"handleWatchTurnServers",value:(function(){var A=E(w().mark(function M(C){var U,D,x,j;return w().wrap(function(J){for(;;)switch(J.prev=J.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){J.next=4;break}this.transport.reply(C,{error:{message:"Missing capability"}}),J.next=26;break;case 4:if(!this.turnServers){J.next=8;break}this.transport.reply(C,{}),J.next=26;break;case 8:return J.prev=8,U=this.driver.getTurnServers(),J.next=12,U.next();case 12:if(D=J.sent,x=D.done,j=D.value,!x){J.next=17;break}throw new Error("Client refuses to provide any TURN servers");case 17:this.transport.reply(C,{}),this.pollTurnServers(U,j),this.turnServers=U,J.next=26;break;case 22:J.prev=22,J.t0=J.catch(8),console.error("error getting first TURN server results",J.t0),this.transport.reply(C,{error:{message:"TURN servers not available"}});case 26:case"end":return J.stop()}},M,this,[[8,22]])}));function k(M){return A.apply(this,arguments)}return k})()},{key:"handleUnwatchTurnServers",value:(function(){var A=E(w().mark(function M(C){return w().wrap(function(D){for(;;)switch(D.prev=D.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3846TurnServers)){D.next=4;break}this.transport.reply(C,{error:{message:"Missing capability"}}),D.next=12;break;case 4:if(this.turnServers){D.next=8;break}this.transport.reply(C,{}),D.next=12;break;case 8:return D.next=10,this.turnServers.return(void 0);case 10:this.turnServers=null,this.transport.reply(C,{});case 12:case"end":return D.stop()}},M,this)}));function k(M){return A.apply(this,arguments)}return k})()},{key:"handleReadRelations",value:(function(){var A=E(w().mark(function M(C){var U=this,D,x;return w().wrap(function(q){for(;;)switch(q.prev=q.next){case 0:if(C.data.event_id){q.next=2;break}return q.abrupt("return",this.transport.reply(C,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(C.data.limit!==void 0&&C.data.limit<0)){q.next=4;break}return q.abrupt("return",this.transport.reply(C,{error:{message:"Invalid request - limit out of range"}}));case 4:if(!(C.data.room_id!==void 0&&!this.canUseRoomTimeline(C.data.room_id))){q.next=6;break}return q.abrupt("return",this.transport.reply(C,{error:{message:"Unable to access room timeline: ".concat(C.data.room_id)}}));case 6:return q.prev=6,q.next=9,this.driver.readEventRelations(C.data.event_id,C.data.room_id,C.data.rel_type,C.data.event_type,C.data.from,C.data.to,C.data.limit,C.data.direction);case 9:return D=q.sent,x=D.chunk.filter(function(J){return J.state_key!==void 0?U.canReceiveStateEvent(J.type,J.state_key):U.canReceiveRoomEvent(J.type,J.content.msgtype)}),q.abrupt("return",this.transport.reply(C,{chunk:x,prev_batch:D.prevBatch,next_batch:D.nextBatch}));case 14:q.prev=14,q.t0=q.catch(6),console.error("error getting the relations",q.t0),this.handleDriverError(q.t0,C,"Unexpected error while reading relations");case 18:case"end":return q.stop()}},M,this,[[6,14]])}));function k(M){return A.apply(this,arguments)}return k})()},{key:"handleUserDirectorySearch",value:(function(){var A=E(w().mark(function M(C){var U;return w().wrap(function(x){for(;;)switch(x.prev=x.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC3973UserDirectorySearch)){x.next=2;break}return x.abrupt("return",this.transport.reply(C,{error:{message:"Missing capability"}}));case 2:if(typeof C.data.search_term=="string"){x.next=4;break}return x.abrupt("return",this.transport.reply(C,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(C.data.limit!==void 0&&C.data.limit<0)){x.next=6;break}return x.abrupt("return",this.transport.reply(C,{error:{message:"Invalid request - limit out of range"}}));case 6:return x.prev=6,x.next=9,this.driver.searchUserDirectory(C.data.search_term,C.data.limit);case 9:return U=x.sent,x.abrupt("return",this.transport.reply(C,{limited:U.limited,results:U.results.map(function(j){return{user_id:j.userId,display_name:j.displayName,avatar_url:j.avatarUrl}})}));case 13:x.prev=13,x.t0=x.catch(6),console.error("error searching in the user directory",x.t0),this.handleDriverError(x.t0,C,"Unexpected error while searching in the user directory");case 17:case"end":return x.stop()}},M,this,[[6,13]])}));function k(M){return A.apply(this,arguments)}return k})()},{key:"handleGetMediaConfig",value:(function(){var A=E(w().mark(function M(C){var U;return w().wrap(function(x){for(;;)switch(x.prev=x.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){x.next=2;break}return x.abrupt("return",this.transport.reply(C,{error:{message:"Missing capability"}}));case 2:return x.prev=2,x.next=5,this.driver.getMediaConfig();case 5:return U=x.sent,x.abrupt("return",this.transport.reply(C,U));case 9:x.prev=9,x.t0=x.catch(2),console.error("error while getting the media configuration",x.t0),this.handleDriverError(x.t0,C,"Unexpected error while getting the media configuration");case 13:case"end":return x.stop()}},M,this,[[2,9]])}));function k(M){return A.apply(this,arguments)}return k})()},{key:"handleUploadFile",value:(function(){var A=E(w().mark(function M(C){var U;return w().wrap(function(x){for(;;)switch(x.prev=x.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039UploadFile)){x.next=2;break}return x.abrupt("return",this.transport.reply(C,{error:{message:"Missing capability"}}));case 2:return x.prev=2,x.next=5,this.driver.uploadFile(C.data.file);case 5:return U=x.sent,x.abrupt("return",this.transport.reply(C,{content_uri:U.contentUri}));case 9:x.prev=9,x.t0=x.catch(2),console.error("error while uploading a file",x.t0),this.handleDriverError(x.t0,C,"Unexpected error while uploading a file");case 13:case"end":return x.stop()}},M,this,[[2,9]])}));function k(M){return A.apply(this,arguments)}return k})()},{key:"handleDownloadFile",value:(function(){var A=E(w().mark(function M(C){var U;return w().wrap(function(x){for(;;)switch(x.prev=x.next){case 0:if(this.hasCapability(n.MatrixCapabilities.MSC4039DownloadFile)){x.next=2;break}return x.abrupt("return",this.transport.reply(C,{error:{message:"Missing capability"}}));case 2:return x.prev=2,x.next=5,this.driver.downloadFile(C.data.content_uri);case 5:return U=x.sent,x.abrupt("return",this.transport.reply(C,{file:U.file}));case 9:x.prev=9,x.t0=x.catch(2),console.error("error while downloading a file",x.t0),this.handleDriverError(x.t0,C,"Unexpected error while downloading a file");case 13:case"end":return x.stop()}},M,this,[[2,9]])}));function k(M){return A.apply(this,arguments)}return k})()},{key:"handleDriverError",value:function(k,M,C){var U=this.driver.processError(k);this.transport.reply(M,{error:m({message:C},U)})}},{key:"handleMessage",value:function(k){if(!this.isStopped){var M=new CustomEvent("action:".concat(k.detail.action),{detail:k.detail,cancelable:!0});if(this.emit("action:".concat(k.detail.action),M),!M.defaultPrevented)switch(k.detail.action){case r.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(k.detail);case r.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(k.detail);case r.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(k.detail);case r.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(k.detail);case r.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(k.detail);case r.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(k.detail);case r.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(k.detail);case r.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(k.detail);case r.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(k.detail);case r.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(k.detail);case r.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(k.detail);case r.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(k.detail);case r.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(k.detail);case r.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(k.detail);case r.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(k.detail);case r.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(k.detail);case r.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(k.detail);default:return this.transport.reply(k.detail,{error:{message:"Unknown or unsupported action: "+k.detail.action}})}}}},{key:"updateTheme",value:function(k){return this.transport.send(r.WidgetApiToWidgetAction.ThemeChange,k)}},{key:"updateLanguage",value:function(k){return this.transport.send(r.WidgetApiToWidgetAction.LanguageChange,{lang:k})}},{key:"takeScreenshot",value:function(){return this.transport.send(r.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(k){return this.transport.send(r.WidgetApiToWidgetAction.UpdateVisibility,{visible:k})}},{key:"sendWidgetConfig",value:function(k){return this.transport.send(r.WidgetApiToWidgetAction.WidgetConfig,k).then()}},{key:"notifyModalWidgetButtonClicked",value:function(k){return this.transport.send(r.WidgetApiToWidgetAction.ButtonClicked,{id:k}).then()}},{key:"notifyModalWidgetClose",value:function(k){return this.transport.send(r.WidgetApiToWidgetAction.CloseModalWidget,k).then()}},{key:"feedEvent",value:(function(){var A=E(w().mark(function M(C,U){var D;return w().wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(U!==void 0&&this.setViewedRoomId(U),!(C.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(C.room_id))){j.next=3;break}return j.abrupt("return");case 3:if(!(C.state_key!==void 0&&C.state_key!==null)){j.next=8;break}if(this.canReceiveStateEvent(C.type,C.state_key)){j.next=6;break}return j.abrupt("return");case 6:j.next=10;break;case 8:if(this.canReceiveRoomEvent(C.type,(D=C.content)===null||D===void 0?void 0:D.msgtype)){j.next=10;break}return j.abrupt("return");case 10:return j.next=12,this.transport.send(r.WidgetApiToWidgetAction.SendEvent,C);case 12:case"end":return j.stop()}},M,this)}));function k(M,C){return A.apply(this,arguments)}return k})()},{key:"feedToDevice",value:(function(){var A=E(w().mark(function M(C,U){return w().wrap(function(x){for(;;)switch(x.prev=x.next){case 0:if(!this.canReceiveToDeviceEvent(C.type)){x.next=3;break}return x.next=3,this.transport.send(r.WidgetApiToWidgetAction.SendToDevice,m(m({},C),{},{encrypted:U}));case 3:case"end":return x.stop()}},M,this)}));function k(M,C){return A.apply(this,arguments)}return k})()},{key:"setViewedRoomId",value:function(k){this.viewedRoomId=k,k!==null&&!this.canUseRoomTimeline(k)&&this.pushRoomState(k)}},{key:"flushRoomState",value:(function(){var A=E(w().mark(function M(){var C,U,D,x,j,q,J;return w().wrap(function(he){for(;;)switch(he.prev=he.next){case 0:he.prev=0;case 1:return he.next=3,Promise.all(this.pushRoomStateTasks);case 3:if(this.pushRoomStateTasks.size>0){he.next=1;break}case 4:C=[],U=f(this.pushRoomStateResult.values());try{for(U.s();!(D=U.n()).done;){x=D.value,j=f(x.values());try{for(j.s();!(q=j.n()).done;)J=q.value,C.push.apply(C,g(J.values()))}catch(oe){j.e(oe)}finally{j.f()}}}catch(oe){U.e(oe)}finally{U.f()}return he.next=9,this.getWidgetVersions();case 9:if(!he.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){he.next=12;break}return he.next=12,this.transport.send(r.WidgetApiToWidgetAction.UpdateState,{state:C});case 12:return he.prev=12,this.flushRoomStateTask=null,he.finish(12);case 15:case"end":return he.stop()}},M,this,[[0,,12,15]])}));function k(){return A.apply(this,arguments)}return k})()},{key:"pushRoomState",value:function(k){var M=this,C=f(this.allowedEvents),U;try{var D=function(){var j=U.value;if(j.kind===s.EventKind.State&&j.direction===s.EventDirection.Receive){var q,J,fe=M.driver.readRoomState(k,j.eventType,(q=j.keyStr)!==null&&q!==void 0?q:void 0),he=fe.then(function(oe){var Ie=f(oe),Be;try{for(Ie.s();!(Be=Ie.n()).done;){var Je=Be.value,ee=M.pushRoomStateResult.get(k);ee===void 0&&(ee=new Map,M.pushRoomStateResult.set(k,ee));var Oe=ee.get(j.eventType);Oe===void 0&&(Oe=new Map,ee.set(j.eventType,Oe)),Oe.has(Je.state_key)||Oe.set(Je.state_key,Je)}}catch(an){Ie.e(an)}finally{Ie.f()}},function(oe){return console.error("Failed to read room state for ".concat(k," (").concat(j.eventType,", ").concat(j.keyStr,")"),oe)}).then(function(){M.pushRoomStateTasks.delete(he)});M.pushRoomStateTasks.add(he),(J=M.flushRoomStateTask)!==null&&J!==void 0||(M.flushRoomStateTask=M.flushRoomState()),M.flushRoomStateTask.catch(function(oe){return console.error("Failed to push room state",oe)})}};for(C.s();!(U=C.n()).done;)D()}catch(x){C.e(x)}finally{C.f()}}},{key:"feedStateUpdate",value:(function(){var A=E(w().mark(function M(C){var U,D;return w().wrap(function(j){for(;;)switch(j.prev=j.next){case 0:if(C.state_key!==void 0){j.next=2;break}throw new Error("Not a state event");case 2:if(!((C.room_id===this.viewedRoomId||this.canUseRoomTimeline(C.room_id))&&this.canReceiveStateEvent(C.type,C.state_key))){j.next=21;break}if(this.pushRoomStateTasks.size!==0){j.next=11;break}return j.next=6,this.getWidgetVersions();case 6:if(!j.sent.includes(a.UnstableApiVersion.MSC2762_UPDATE_STATE)){j.next=9;break}return j.next=9,this.transport.send(r.WidgetApiToWidgetAction.UpdateState,{state:[C]});case 9:j.next=21;break;case 11:U=this.pushRoomStateResult.get(C.room_id),U===void 0&&(U=new Map,this.pushRoomStateResult.set(C.room_id,U)),D=U.get(C.type),D===void 0&&(D=new Map,U.set(C.type,D)),D.has(C.type)||D.set(C.state_key,C);case 16:return j.next=18,Promise.all(this.pushRoomStateTasks);case 18:if(this.pushRoomStateTasks.size>0){j.next=16;break}case 19:return j.next=21,this.flushRoomStateTask;case 21:case"end":return j.stop()}},M,this)}));function k(M){return A.apply(this,arguments)}return k})()}]),L})(i.EventEmitter);return hi.ClientWidgetApi=Qt,hi}var pa={},Gu;function Wm(){if(Gu)return pa;Gu=1,Object.defineProperty(pa,"__esModule",{value:!0}),pa.isErrorResponse=e;function i(t){"@babel/helpers - typeof";return i=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(r){return typeof r}:function(r){return r&&typeof Symbol=="function"&&r.constructor===Symbol&&r!==Symbol.prototype?"symbol":typeof r},i(t)}function e(t){var r=t.error;return i(r)==="object"&&r!==null&&"message"in r&&typeof r.message=="string"}return pa}var fi={},Hu;function Km(){if(Hu)return fi;Hu=1,Object.defineProperty(fi,"__esModule",{value:!0}),fi.WidgetKind=void 0;var i=(function(e){return e.Room="room",e.Account="account",e.Modal="modal",e})({});return fi.WidgetKind=i,fi}var pi={},$u;function qm(){if($u)return pi;$u=1,Object.defineProperty(pi,"__esModule",{value:!0}),pi.ModalButtonKind=void 0;var i=(function(e){return e.Primary="m.primary",e.Secondary="m.secondary",e.Warning="m.warning",e.Danger="m.danger",e.Link="m.link",e})({});return pi.ModalButtonKind=i,pi}var ma={},Ju;function Uh(){if(Ju)return ma;Ju=1,Object.defineProperty(ma,"__esModule",{value:!0}),ma.isValidUrl=i;function i(e){if(!e)return!1;try{var t=new URL(e);return!(t.protocol!=="http"&&t.protocol!=="https")}catch(r){if(r instanceof TypeError)return!1;throw r}}return ma}var ga={},zu;function Nh(){if(zu)return ga;zu=1,Object.defineProperty(ga,"__esModule",{value:!0}),ga.assertPresent=i;function i(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))}return ga}var mi={},Yu;function xh(){if(Yu)return mi;Yu=1,Object.defineProperty(mi,"__esModule",{value:!0}),mi.Widget=void 0;var i=Es(),e=Nh();function t(l){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(u){return typeof u}:function(u){return u&&typeof Symbol=="function"&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u},t(l)}function r(l,u){if(!(l instanceof u))throw new TypeError("Cannot call a class as a function")}function n(l,u){for(var h=0;h<u.length;h++){var v=u[h];v.enumerable=v.enumerable||!1,v.configurable=!0,"value"in v&&(v.writable=!0),Object.defineProperty(l,s(v.key),v)}}function a(l,u,h){return u&&n(l.prototype,u),Object.defineProperty(l,"prototype",{writable:!1}),l}function s(l){var u=o(l,"string");return t(u)==="symbol"?u:String(u)}function o(l,u){if(t(l)!=="object"||l===null)return l;var h=l[Symbol.toPrimitive];if(h!==void 0){var v=h.call(l,u);if(t(v)!=="object")return v;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(l)}var d=(function(){function l(u){if(r(this,l),this.definition=u,!this.definition)throw new Error("Definition is required");(0,e.assertPresent)(u,"id"),(0,e.assertPresent)(u,"creatorUserId"),(0,e.assertPresent)(u,"type"),(0,e.assertPresent)(u,"url")}return a(l,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return this.definition.waitForIframeLoad===!1?!1:(this.definition.waitForIframeLoad===!0,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(h){return(0,i.runTemplate)(this.templateUrl,this.definition,h)}}]),l})();return mi.Widget=d,mi}var gi={},Xu;function Vm(){if(Xu)return gi;Xu=1,Object.defineProperty(gi,"__esModule",{value:!0}),gi.WidgetParser=void 0;var i=xh(),e=Uh();function t(v){"@babel/helpers - typeof";return t=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(m){return typeof m}:function(m){return m&&typeof Symbol=="function"&&m.constructor===Symbol&&m!==Symbol.prototype?"symbol":typeof m},t(v)}function r(v,m){var f=typeof Symbol<"u"&&v[Symbol.iterator]||v["@@iterator"];if(!f){if(Array.isArray(v)||(f=n(v))||m){f&&(v=f);var g=0,T=function(){};return{s:T,n:function(){return g>=v.length?{done:!0}:{done:!1,value:v[g++]}},e:function(w){throw w},f:T}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var R=!0,S=!1,I;return{s:function(){f=f.call(v)},n:function(){var w=f.next();return R=w.done,w},e:function(w){S=!0,I=w},f:function(){try{!R&&f.return!=null&&f.return()}finally{if(S)throw I}}}}function n(v,m){if(v){if(typeof v=="string")return a(v,m);var f=Object.prototype.toString.call(v).slice(8,-1);if(f==="Object"&&v.constructor&&(f=v.constructor.name),f==="Map"||f==="Set")return Array.from(v);if(f==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(f))return a(v,m)}}function a(v,m){(m==null||m>v.length)&&(m=v.length);for(var f=0,g=new Array(m);f<m;f++)g[f]=v[f];return g}function s(v,m){if(!(v instanceof m))throw new TypeError("Cannot call a class as a function")}function o(v,m){for(var f=0;f<m.length;f++){var g=m[f];g.enumerable=g.enumerable||!1,g.configurable=!0,"value"in g&&(g.writable=!0),Object.defineProperty(v,l(g.key),g)}}function d(v,m,f){return f&&o(v,f),Object.defineProperty(v,"prototype",{writable:!1}),v}function l(v){var m=u(v,"string");return t(m)==="symbol"?m:String(m)}function u(v,m){if(t(v)!=="object"||v===null)return v;var f=v[Symbol.toPrimitive];if(f!==void 0){var g=f.call(v,m);if(t(g)!=="object")return g;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(v)}var h=(function(){function v(){s(this,v)}return d(v,null,[{key:"parseAccountData",value:function(f){if(!f)return[];for(var g=[],T=0,R=Object.keys(f);T<R.length;T++){var S=R[T],I=f[S];if(I&&!(I.type!=="m.widget"&&I.type!=="im.vector.modular.widgets")&&I.sender){var b=I.state_key||I.id;if(b===S){var w={content:I.content,sender:I.sender,type:"m.widget",state_key:S,event_id:"$example",room_id:"!example",origin_server_ts:1},p=v.parseRoomWidget(w);p&&g.push(p)}}}return g}},{key:"parseWidgetsFromRoomState",value:function(f){if(!f)return[];var g=[],T=r(f),R;try{for(T.s();!(R=T.n()).done;){var S=R.value,I=v.parseRoomWidget(S);I&&g.push(I)}}catch(b){T.e(b)}finally{T.f()}return g}},{key:"parseRoomWidget",value:function(f){if(!f||f.type!=="m.widget"&&f.type!=="im.vector.modular.widgets")return null;var g=f.content||{},T={id:f.state_key,creatorUserId:g.creatorUserId||f.sender,name:g.name,type:g.type,url:g.url,waitForIframeLoad:g.waitForIframeLoad,data:g.data};return v.processEstimatedWidget(T)}},{key:"processEstimatedWidget",value:function(f){return!f.id||!f.creatorUserId||!f.type||!(0,e.isValidUrl)(f.url)?null:new i.Widget(f)}}]),v})();return gi.WidgetParser=h,gi}var yi={},Qu;function Gm(){if(Qu)return yi;Qu=1,Object.defineProperty(yi,"__esModule",{value:!0}),yi.runTemplate=i,yi.toString=e;function i(t,r,n){for(var a=Object.assign({},r.data,{matrix_room_id:n.widgetRoomId||"",matrix_user_id:n.currentUserId,matrix_display_name:n.userDisplayName||n.currentUserId,matrix_avatar_url:n.userHttpAvatarUrl||"",matrix_widget_id:r.id,"org.matrix.msc2873.client_id":n.clientId||"","org.matrix.msc2873.client_theme":n.clientTheme||"","org.matrix.msc2873.client_language":n.clientLanguage||"","org.matrix.msc3819.matrix_device_id":n.deviceId||"","org.matrix.msc4039.matrix_base_url":n.baseUrl||""}),s=t,o=0,d=Object.keys(a);o<d.length;o++){var l=d[o],u="$".concat(l).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),h=new RegExp(u,"g");s=s.replace(h,encodeURIComponent(e(a[l])))}return s}function e(t){return t==null?"".concat(t):String(t)}return yi}var Si={},Zu;function Hm(){if(Zu)return Si;Zu=1,Object.defineProperty(Si,"__esModule",{value:!0}),Si.WidgetDriver=void 0;var i=Es();function e(d){"@babel/helpers - typeof";return e=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(l){return typeof l}:function(l){return l&&typeof Symbol=="function"&&l.constructor===Symbol&&l!==Symbol.prototype?"symbol":typeof l},e(d)}function t(d,l){if(!(d instanceof l))throw new TypeError("Cannot call a class as a function")}function r(d,l){for(var u=0;u<l.length;u++){var h=l[u];h.enumerable=h.enumerable||!1,h.configurable=!0,"value"in h&&(h.writable=!0),Object.defineProperty(d,a(h.key),h)}}function n(d,l,u){return l&&r(d.prototype,l),Object.defineProperty(d,"prototype",{writable:!1}),d}function a(d){var l=s(d,"string");return e(l)==="symbol"?l:String(l)}function s(d,l){if(e(d)!=="object"||d===null)return d;var u=d[Symbol.toPrimitive];if(u!==void 0){var h=u.call(d,l);if(e(h)!=="object")return h;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(d)}var o=(function(){function d(){t(this,d)}return n(d,[{key:"validateCapabilities",value:function(u){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(u,h){return Promise.reject(new Error("Failed to override function"))}},{key:"sendStickyEvent",value:function(u,h,v){throw new Error("Method not implemented.")}},{key:"sendDelayedEvent",value:function(u,h,v,m){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedStickyEvent",value:function(u,h,v,m,f){throw new Error("Method not implemented.")}},{key:"cancelScheduledDelayedEvent",value:function(u){return Promise.reject(new Error("Failed to override function"))}},{key:"restartScheduledDelayedEvent",value:function(u){return Promise.reject(new Error("Failed to override function"))}},{key:"sendScheduledDelayedEvent",value:function(u){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(u,h,v){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(u){return Promise.resolve([])}},{key:"readRoomEvents",value:function(u,h,v){return Promise.resolve([])}},{key:"readStateEvents",value:function(u,h,v){return Promise.resolve([])}},{key:"readRoomTimeline",value:function(u,h,v,m,f,g){return m===void 0?this.readRoomEvents(h,v,f,[u],g):this.readStateEvents(h,m,f,[u])}},{key:"readRoomState",value:function(u,h,v){return this.readStateEvents(h,v,Number.MAX_SAFE_INTEGER,[u])}},{key:"readEventRelations",value:function(u,h,v,m,f,g,T,R){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(u){u.update({state:i.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(u){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(u,h){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(u){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(u){throw new Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw new Error("Querying known rooms is not implemented")}},{key:"processError",value:function(u){}}]),d})();return Si.WidgetDriver=o,Si}var ec;function Es(){return ec||(ec=1,(function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=jm();Object.keys(e).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===e[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return e[y]}})});var t=Bm();Object.keys(t).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===t[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return t[y]}})});var r=Ll();Object.keys(r).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===r[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return r[y]}})});var n=Ml();Object.keys(n).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===n[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return n[y]}})});var a=Ph();Object.keys(a).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===a[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return a[y]}})});var s=Wm();Object.keys(s).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===s[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return s[y]}})});var o=Pl();Object.keys(o).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===o[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return o[y]}})});var d=Ol();Object.keys(d).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===d[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return d[y]}})});var l=kl();Object.keys(l).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===l[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return l[y]}})});var u=Dh();Object.keys(u).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===u[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return u[y]}})});var h=Al();Object.keys(h).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===h[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return h[y]}})});var v=Km();Object.keys(v).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===v[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return v[y]}})});var m=qm();Object.keys(m).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===m[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return m[y]}})});var f=Ah();Object.keys(f).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===f[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return f[y]}})});var g=Ul();Object.keys(g).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===g[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return g[y]}})});var T=Dl();Object.keys(T).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===T[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return T[y]}})});var R=Uh();Object.keys(R).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===R[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return R[y]}})});var S=Nh();Object.keys(S).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===S[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return S[y]}})});var I=xh();Object.keys(I).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===I[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return I[y]}})});var b=Vm();Object.keys(b).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===b[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return b[y]}})});var w=Gm();Object.keys(w).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===w[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return w[y]}})});var p=Lh();Object.keys(p).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===p[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return p[y]}})});var E=Hm();Object.keys(E).forEach(function(y){y==="default"||y==="__esModule"||y in i&&i[y]===E[y]||Object.defineProperty(i,y,{enumerable:!0,get:function(){return E[y]}})})})(Gs)),Gs}var Pt=Es();function tc(i,e){var t=Object.keys(i);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(i);e&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(i,n).enumerable})),t.push.apply(t,r)}return t}function ya(i){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?tc(Object(t),!0).forEach(function(r){c(i,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):tc(Object(t)).forEach(function(r){Object.defineProperty(i,r,Object.getOwnPropertyDescriptor(t,r))})}return i}function $m(i){var e,t,r,n=2;for(typeof Symbol<"u"&&(t=Symbol.asyncIterator,r=Symbol.iterator);n--;){if(t&&(e=i[t])!=null)return e.call(i);if(r&&(e=i[r])!=null)return new Ia(e.call(i));t="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function Ia(i){function e(t){if(Object(t)!==t)return Promise.reject(new TypeError(t+" is not an object."));var r=t.done;return Promise.resolve(t.value).then(function(n){return{value:n,done:r}})}return Ia=function(r){this.s=r,this.n=r.next},Ia.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(r){var n=this.s.return;return n===void 0?Promise.resolve({value:r,done:!0}):e(n.apply(this.s,arguments))},throw:function(r){var n=this.s.return;return n===void 0?Promise.reject(r):e(n.apply(this.s,arguments))}},new Ia(i)}var ki=(function(i){return i.PendingEventsChanged="PendingEvent.pendingEventsChanged",i})({});class Nl extends ea{constructor(e,t,r,n,a){var s,o,d,l,u,h,v,m,f,g,T,R,S,I;super(n),s=this,this.widgetApi=e,this.capabilities=t,this.roomId=r,c(this,"room",void 0),c(this,"widgetApiReady",void 0),c(this,"roomStateSynced",void 0),c(this,"lifecycle",void 0),c(this,"syncState",null),c(this,"pendingSendingEventsTxId",[]),c(this,"eventEmitter",new Ke),c(this,"updateTxId",(function(){var p=_(function*(E){if(E.getSender()===s.getUserId()&&s.pendingSendingEventsTxId.some(V=>E.getType()===V.type)){for(var y,P=(y=s.pendingSendingEventsTxId.find(V=>V.id===E.getId()))===null||y===void 0?void 0:y.txId;!P&&s.pendingSendingEventsTxId.length>0;){var N;yield new Promise(V=>s.eventEmitter.once(ki.PendingEventsChanged,()=>V())),P=(N=s.pendingSendingEventsTxId.find(V=>V.id===E.getId()))===null||N===void 0?void 0:N.txId}P&&(E.setTxnId(P),E.setUnsigned(ya(ya({},E.getUnsigned()),{},{transaction_id:P}))),s.pendingSendingEventsTxId=s.pendingSendingEventsTxId.filter(V=>V.id!==E.getId()),s.pendingSendingEventsTxId.length===0&&s.eventEmitter.emit(ki.PendingEventsChanged)}});return function(E){return p.apply(this,arguments)}})()),c(this,"onEvent",(function(){var p=_(function*(E){if(E.preventDefault(),E.detail.data.room_id===s.roomId){var y=new at(E.detail.data);yield s.updateTxId(y),s.syncApi instanceof br?(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,void 0,[],[y]):yield s.syncApi.injectRoomEvents(s.room,[],void 0,[y]):(yield s.supportUpdateState())?yield s.syncApi.injectRoomEvents(s.room,[],[y]):O.error("slididng sync cannot be used in widget mode if the client widget driver does not support the version: 'org.matrix.msc2762_update_state'"),s.emit(ie.Event,y),s.setSyncState(Pe.Syncing),O.info("Received event ".concat(y.getId()," ").concat(y.getType()))}else{var{event_id:P,room_id:N}=E.detail.data;O.info("Received event ".concat(P," for a different room ").concat(N,"; discarding"))}yield s.ack(E)});return function(E){return p.apply(this,arguments)}})()),c(this,"onToDevice",(function(){var p=_(function*(E){E.preventDefault();var y=new at({type:E.detail.data.type,sender:E.detail.data.sender,content:E.detail.data.content});E.detail.data.encrypted&&y.makeEncrypted(F.RoomMessageEncrypted,{},"",""),s.emit(ie.ToDeviceEvent,y),s.setSyncState(Pe.Syncing),yield s.ack(E)});return function(E){return p.apply(this,arguments)}})()),c(this,"onStateUpdate",(function(){var p=_(function*(E){E.preventDefault(),(yield s.supportUpdateState())||O.warn("received update_state widget action but the widget driver did not claim to support 'org.matrix.msc2762_update_state'");for(var y of E.detail.data.state)if(y.room_id===s.roomId){var P=new at(y);s.syncApi instanceof br?yield s.syncApi.injectRoomEvents(s.room,void 0,[P]):yield s.syncApi.injectRoomEvents(s.room,[P]),O.info("Updated state entry ".concat(P.getType()," ").concat(P.getStateKey()," to ").concat(P.getId()))}else{var{event_id:N,room_id:V}=E.detail.data;O.info("Received state entry ".concat(N," for a different room ").concat(V,"; discarding"))}yield s.ack(E)});return function(E){return p.apply(this,arguments)}})());var b=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=(function(){var p=_(function*(E,y){try{return yield b(E,y)}catch(P){rc(P)}});return function(E,y){return p.apply(this,arguments)}})();var w=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=(function(){var p=_(function*(E,y){try{return yield w(E,y)}catch(P){rc(P)}});return function(E,y){return p.apply(this,arguments)}})(),this.widgetApiReady=new Promise(p=>this.widgetApi.once("ready",p)),this.roomStateSynced=(o=t.receiveState)!==null&&o!==void 0&&o.length?new Promise(p=>this.widgetApi.once("action:".concat(Pt.WidgetApiToWidgetAction.UpdateState),p)):Promise.resolve(),((d=t.sendEvent)!==null&&d!==void 0&&d.length||(l=t.receiveEvent)!==null&&l!==void 0&&l.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||t.receiveMessage===!0||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||(u=t.sendState)!==null&&u!==void 0&&u.length||(h=t.receiveState)!==null&&h!==void 0&&h.length)&&e.requestCapabilityForRoomTimeline(r),(v=t.sendEvent)===null||v===void 0||v.forEach(p=>e.requestCapabilityToSendEvent(p)),(m=t.receiveEvent)===null||m===void 0||m.forEach(p=>e.requestCapabilityToReceiveEvent(p)),t.sendMessage===!0?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach(p=>e.requestCapabilityToSendMessage(p)),t.receiveMessage===!0?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach(p=>e.requestCapabilityToReceiveMessage(p)),(f=t.sendState)===null||f===void 0||f.forEach(p=>{var{eventType:E,stateKey:y}=p;return e.requestCapabilityToSendState(E,y)}),(g=t.receiveState)===null||g===void 0||g.forEach(p=>{var{eventType:E,stateKey:y}=p;return e.requestCapabilityToReceiveState(E,y)}),(T=t.sendToDevice)===null||T===void 0||T.forEach(p=>e.requestCapabilityToSendToDevice(p)),(R=t.receiveToDevice)===null||R===void 0||R.forEach(p=>e.requestCapabilityToReceiveToDevice(p)),t.sendDelayedEvents&&((S=t.sendEvent)!==null&&S!==void 0&&S.length||t.sendMessage===!0||Array.isArray(t.sendMessage)&&t.sendMessage.length||(I=t.sendState)!==null&&I!==void 0&&I.length)&&e.requestCapability(Pt.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(Pt.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(Pt.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(Pt.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(Pt.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.on("action:".concat(Pt.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),e.start(),a&&e.sendContentLoaded()}supportUpdateState(){var e=this;return _(function*(){return(yield e.widgetApi.getClientVersions()).includes(Pt.UnstableApiVersion.MSC2762_UPDATE_STATE)})()}startClient(){var e=arguments,t=this;return _(function*(){var r=e.length>0&&e[0]!==void 0?e[0]:{};t.lifecycle=new AbortController;var n=t.getUserId();if(n&&t.store.storeUser(new Yt(n)),r.slidingSync?t.syncApi=new oh(r.slidingSync,t,r,t.buildSyncApiOptions()):t.syncApi=new br(t,r,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield t.supportUpdateState())yield t.roomStateSynced;else{var a,s;yield Promise.all((a=(s=t.capabilities.receiveState)===null||s===void 0?void 0:s.map((function(){var o=_(function*(d){var{eventType:l,stateKey:u}=d,h=yield t.widgetApi.readStateEvents(l,void 0,u,[t.roomId]),v=h.map(m=>new at(m));t.syncApi instanceof br?yield t.syncApi.injectRoomEvents(t.room,void 0,v):yield t.syncApi.injectRoomEvents(t.room,v),v.forEach(m=>{t.emit(ie.Event,m),O.info("Backfilled event ".concat(m.getId()," ").concat(m.getType()," ").concat(m.getStateKey()))})});return function(d){return o.apply(this,arguments)}})()))!==null&&a!==void 0?a:[])}r.clientWellKnownPollPeriod!==void 0&&(t.clientWellKnownIntervalID=setInterval(()=>{t.fetchClientWellKnown()},1e3*r.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(Pe.Syncing),O.info("Finished initial sync"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()})()}stopClient(){this.widgetApi.off("action:".concat(Pt.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(Pt.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),this.widgetApi.off("action:".concat(Pt.WidgetApiToWidgetAction.UpdateState),this.onStateUpdate),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return _(function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))})()}encryptAndSendEvent(e,t,r){var n=this;return _(function*(){var a=t.event.redacts?ya(ya({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(r){var s=yield n.widgetApi.sendRoomEvent(t.getType(),a,e.roomId,"delay"in r?r.delay:void 0,"parent_delay_id"in r?r.parent_delay_id:void 0).catch(Rt);return n.validateSendDelayedEventResponse(s)}var o=t.getTxnId();o&&n.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:o});var d;try{d=yield n.widgetApi.sendRoomEvent(t.getType(),a,e.roomId).catch(Rt)}catch(l){throw n.updatePendingEventStatus(e,t,pe.NOT_SENT),l}return e.updatePendingEvent(t,pe.SENT,d.event_id),n.pendingSendingEventsTxId.forEach(l=>{l.txId===o&&(l.id=d.event_id)}),n.eventEmitter.emit(ki.PendingEventsChanged),{event_id:d.event_id}})()}sendStateEvent(e,t,r){var n=arguments,a=this;return _(function*(){var s=n.length>3&&n[3]!==void 0?n[3]:"",o=yield a.widgetApi.sendStateEvent(t,s,r,e).catch(Rt);if(o.event_id===void 0)throw new Error("'event_id' absent from response to an event request");return{event_id:o.event_id}})()}_unstable_sendDelayedStateEvent(e,t,r,n){var a=arguments,s=this;return _(function*(){var o=a.length>4&&a[4]!==void 0?a[4]:"";if(!(yield s.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","sendDelayedStateEvent");var d=yield s.widgetApi.sendStateEvent(r,o,n,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0).catch(Rt);return s.validateSendDelayedEventResponse(d)})()}validateSendDelayedEventResponse(e){if(e.delay_id===void 0)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var r=this;return _(function*(){if(!(yield r.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","updateDelayedEvent");var n;switch(t){case Rr.Cancel:n=r.widgetApi.cancelScheduledDelayedEvent;break;case Rr.Restart:n=r.widgetApi.cancelScheduledDelayedEvent;break;case Rr.Send:n=r.widgetApi.sendScheduledDelayedEvent;break}return yield n.call(r.widgetApi,e).catch(Rt),{}})()}_unstable_cancelScheduledDelayedEvent(e){var t=this;return _(function*(){if(!(yield t.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","cancelScheduledDelayedEvent");return yield t.widgetApi.cancelScheduledDelayedEvent(e).catch(Rt),{}})()}_unstable_restartScheduledDelayedEvent(e){var t=this;return _(function*(){if(!(yield t.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","restartScheduledDelayedEvent");return yield t.widgetApi.restartScheduledDelayedEvent(e).catch(Rt),{}})()}_unstable_sendScheduledDelayedEvent(e){var t=this;return _(function*(){if(!(yield t.doesServerSupportUnstableFeature(ot)))throw new bt("Server does not support the delayed events API","sendScheduledDelayedEvent");return yield t.widgetApi.sendScheduledDelayedEvent(e).catch(Rt),{}})()}encryptAndSendToDevice(e,t,r){var n=this;return _(function*(){var a=new lr(()=>new Map);for(var{userId:s,deviceId:o}of t)a.getOrCreate(s).set(o,r);yield n.widgetApi.sendToDevice(e,!0,Vr(a)).catch(Rt)})()}sendToDevice(e,t){var r=this;return _(function*(){return yield r.widgetApi.sendToDevice(e,!1,Vr(t)).catch(Rt),{}})()}getOpenIdToken(){var e=this;return _(function*(){var t=yield e.widgetApi.requestOpenIDConnectToken().catch(Rt);return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}})()}queueToDevice(e){var t=this;return _(function*(){var{eventType:r,batch:n}=e,a=new lr(()=>new Map);for(var{userId:s,deviceId:o,payload:d}of n)a.getOrCreate(s).set(o,d);yield t.widgetApi.sendToDevice(r,!1,Vr(a)).catch(Rt)})()}sendToDeviceViaWidgetApi(e,t,r){var n=this;return _(function*(){yield n.widgetApi.sendToDevice(e,t,Vr(r)).catch(Rt)})()}checkTurnServers(){var e=this;return _(function*(){return e.turnServers.length>0})()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(ie.Sync,e,t)}ack(e){var t=this;return _(function*(){yield t.widgetApi.transport.reply(e.detail,{})})()}watchTurnServers(){var e=this;return _(function*(){var t=e.widgetApi.getTurnServers(),r=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",r);try{var n=!1,a=!1,s;try{for(var o=$m(t),d;n=!(d=yield o.next()).done;n=!1){var l=d.value;e.turnServers=[{urls:l.uris,username:l.username,credential:l.password}],e.emit(ie.TurnServers,e.turnServers),O.log("Received TURN server: ".concat(l.uris))}}catch(u){a=!0,s=u}finally{try{n&&o.return!=null&&(yield o.return())}finally{if(a)throw s}}}catch(u){O.warn("Error watching TURN servers",u)}finally{e.lifecycle.signal.removeEventListener("abort",r)}})()}}function rc(i){throw i instanceof Pt.WidgetApiResponseError&&i.data.matrix_api_error?Fe.fromWidgetApiErrorData(i.data.matrix_api_error):i}function Rt(i){throw i instanceof Error&&i.message==="Request timed out"?new Cr("widget api timeout"):i}class Jm{constructor(){c(this,"unthreadedReadReceipts",new Map),c(this,"threadedReadReceipts",new lr(()=>new Map))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){e?.forEach(t=>{t.type!==F.Receipt||!t.content||Object.keys(t.content).forEach(r=>{Object.entries(t.content[r]).forEach(n=>{var[a,s]=n;if(Mo(a))for(var o of Object.keys(s)){var d=t.content[r][a][o],l={data:t.content[r][a][o],type:a,eventId:r};d.thread_id?this.setThreaded(d.thread_id,o,l):this.setUnthreaded(o,l)}})})})}buildAccumulatedReceiptEvent(e){var t={type:F.Receipt,room_id:e,content:{}},r=new lr(()=>new lr(()=>new Map));for(var[n,a]of this.allUnthreaded())r.getOrCreate(a.eventId).getOrCreate(a.type).set(n,a.data);for(var[s,o]of this.allThreaded())r.getOrCreate(o.eventId).getOrCreate(o.type).set(s,o.data);return t.content=Vr(r),r.size>0?t:null}}var $t=(function(i){return i.Invite="invite",i.Leave="leave",i.Join="join",i.Knock="knock",i})({});function zm(i){return"_localTs"in i&&i._localTs!==void 0}class xl{constructor(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};this.opts=e,c(this,"accountData",{}),c(this,"inviteRooms",{}),c(this,"knockRooms",{}),c(this,"joinRooms",{}),c(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){!e.account_data||!e.account_data.events||e.account_data.events.forEach(t=>{this.accountData[t.type]=t})}accumulateRooms(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach(r=>{this.accumulateRoom(r,$t.Invite,e.rooms.invite[r],t)}),e.rooms.join&&Object.keys(e.rooms.join).forEach(r=>{this.accumulateRoom(r,$t.Join,e.rooms.join[r],t)}),e.rooms.leave&&Object.keys(e.rooms.leave).forEach(r=>{this.accumulateRoom(r,$t.Leave,e.rooms.leave[r],t)}),e.rooms.knock&&Object.keys(e.rooms.knock).forEach(r=>{this.accumulateRoom(r,$t.Knock,e.rooms.knock[r],t)}))}accumulateRoom(e,t,r){var n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;switch(t){case $t.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case $t.Knock:this.accumulateKnockState(e,r);break;case $t.Join:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,n);break;case $t.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:O.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(!(!t.invite_state||!t.invite_state.events)){if(!this.inviteRooms[e]){this.inviteRooms[e]={invite_state:t.invite_state};return}var r=this.inviteRooms[e];t.invite_state.events.forEach(n=>{for(var a=!1,s=0;s<r.invite_state.events.length;s++){var o=r.invite_state.events[s];o.type===n.type&&o.state_key==n.state_key&&(r.invite_state.events[s]=n,a=!0)}a||r.invite_state.events.push(n)})}}accumulateKnockState(e,t){if(!(!t.knock_state||!t.knock_state.events)){if(!this.knockRooms[e]){this.knockRooms[e]={knock_state:t.knock_state};return}var r=this.knockRooms[e];t.knock_state.events.forEach(n=>{for(var a=!1,s=0;s<r.knock_state.events.length;s++){var o=r.knock_state.events[s];o.type===n.type&&o.state_key==n.state_key&&(r.knock_state.events[s]=n,a=!0)}a||r.knock_state.events.push(n)})}}accumulateJoinState(e,t){var r,n,a,s,o,d,l,u=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,h=Date.now();this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new Jm,_stickyEvents:[]});var v=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach(E=>{v._accountData[E.type]=E}),t.unread_notifications&&(v._unreadNotifications=t.unread_notifications),v._unreadThreadNotifications=(r=(n=t[Li.stable])!==null&&n!==void 0?n:t[Li.unstable])!==null&&r!==void 0?r:void 0,t.summary){var m,f,g,T="m.heroes",R="m.invited_member_count",S="m.joined_member_count",I=v._summary,b=t.summary;I[T]=(m=b[T])!==null&&m!==void 0?m:I[T],I[S]=(f=b[S])!==null&&f!==void 0?f:I[S],I[R]=(g=b[R])!==null&&g!==void 0?g:I[R]}if(v._receipts.consumeEphemeralEvents((a=t.ephemeral)===null||a===void 0?void 0:a.events),t.timeline&&t.timeline.limited&&(v._timeline=[]),(s=t.state)===null||s===void 0||(s=s.events)===null||s===void 0||s.forEach(E=>{Sa(v._currentState,E)}),(o=t["org.matrix.msc4222.state_after"])===null||o===void 0||(o=o.events)===null||o===void 0||o.forEach(E=>{Sa(v._currentState,E)}),(d=t.timeline)===null||d===void 0||(d=d.events)===null||d===void 0||d.forEach((E,y)=>{var P;t["org.matrix.msc4222.state_after"]||Sa(v._currentState,E);var N;if(u)N=E;else{var V;N=Object.assign({},E),N.unsigned!==void 0&&(N.unsigned=Object.assign({},N.unsigned));var Q=(V=E.unsigned)===null||V===void 0?void 0:V.age;Q!==void 0&&(N._localTs=Date.now()-Q)}v._timeline.push({event:N,token:y===0&&(P=t.timeline.prev_batch)!==null&&P!==void 0?P:null})}),v._stickyEvents=v._stickyEvents.filter(E=>{var{expiresTs:y}=E;return y>h}),(l=t.msc4354_sticky)!==null&&l!==void 0&&l.events&&(v._stickyEvents=v._stickyEvents.concat(t.msc4354_sticky.events.map(E=>{var y=Math.min(E.msc4354_sticky.duration_ms,Ss),P=Math.min(E.origin_server_ts,h);return{event:E,expiresTs:y+P}}))),v._timeline.length>this.opts.maxTimelineEntries){for(var w=v._timeline.length-this.opts.maxTimelineEntries,p=w;p<v._timeline.length;p++)if(v._timeline[p].token){v._timeline=v._timeline.slice(p,v._timeline.length);break}}}getJSON(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach(n=>{t.invite[n]=this.inviteRooms[n]}),Object.keys(this.knockRooms).forEach(n=>{t.knock[n]=this.knockRooms[n]}),Object.keys(this.joinRooms).forEach(n=>{var a,s=this.joinRooms[n],o={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:s._unreadNotifications,unread_thread_notifications:s._unreadThreadNotifications,summary:s._summary,msc4354_sticky:(a=s._stickyEvents)!==null&&a!==void 0&&a.length?{events:s._stickyEvents.map(m=>m.event)}:void 0};Object.keys(s._accountData).forEach(m=>{o.account_data.events.push(s._accountData[m])});var d=s._receipts.buildAccumulatedReceiptEvent(n);d&&o.ephemeral.events.push(d),s._timeline.forEach(m=>{if(!o.timeline.prev_batch){if(!m.token)return;o.timeline.prev_batch=m.token}var f;!e&&zm(m.event)?(f=Object.assign({},m.event),f.unsigned!==void 0&&(f.unsigned=Object.assign({},f.unsigned)),delete f._localTs,f.unsigned=f.unsigned||{},f.unsigned.age=Date.now()-m.event._localTs):f=m.event,o.timeline.events.push(f)});for(var l=Object.create(null),u=o.timeline.events.length-1;u>=0;u--){var h=o.timeline.events[u];if(!(h.state_key===null||h.state_key===void 0)){var v=Ki(h);v.unsigned&&(v.unsigned.prev_content&&(v.content=v.unsigned.prev_content),v.unsigned.prev_sender&&(v.sender=v.unsigned.prev_sender)),Sa(l,v)}}Object.keys(s._currentState).forEach(m=>{Object.keys(s._currentState[m]).forEach(f=>{var g=s._currentState[m][f];o["org.matrix.msc4222.state_after"].events.push(g),l[m]&&l[m][f]&&(g=l[m][f]),o.state.events.push(g)})}),t.join[n]=o});var r=[];return Object.keys(this.accountData).forEach(n=>{r.push(this.accountData[n])}),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}}function Sa(i,e){e.state_key===null||e.state_key===void 0||!e.type||(i[e.type]||(i[e.type]=Object.create(null)),i[e.type][e.state_key]=e)}var Fl=(function(i){return i[i.Blocked=-1]="Blocked",i[i.Unverified=0]="Unverified",i[i.Verified=1]="Verified",i})({});class Fh{constructor(e){c(this,"deviceId",void 0),c(this,"userId",void 0),c(this,"algorithms",void 0),c(this,"keys",void 0),c(this,"verified",void 0),c(this,"signatures",void 0),c(this,"displayName",void 0),c(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||Fl.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}var nc=function(){},Ym=10;class jh{constructor(e,t){var r,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};this.client=e,this.timelineSet=t,c(this,"windowLimit",void 0),c(this,"start",void 0),c(this,"end",void 0),c(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3,(r=t.room)===null||r===void 0||r.on(ne.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:20,r=n=>{if(!n)throw new Error("No timeline given to initFields");var a,s=n.getEvents();if(!e)a=s.length;else if(a=s.findIndex(l=>l.getId()===e),a<0)throw new Error("getEventTimeline result didn't include requested event");var o=Math.min(s.length,a+Math.ceil(t/2)),d=Math.max(0,o-t);this.start=new Ya(n,d-n.getBaseIndex()),this.end=new Ya(n,o-n.getBaseIndex()),this.eventCount=o-d};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){if(e==te.BACKWARDS){var t;return(t=this.start)!==null&&t!==void 0?t:null}else if(e==te.FORWARDS){var r;return(r=this.end)!==null&&r!==void 0?r:null}else throw new Error("Invalid direction '"+e+"'")}extend(e,t){var r=this.getTimelineIndex(e);if(!r)return!1;var n=e==te.BACKWARDS?r.retreat(t):r.advance(t);if(n){this.eventCount+=n,nc("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");var a=this.eventCount-this.windowLimit;return a>0&&this.unpaginate(a,e!=te.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,n){n&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&e[e.length-1]===void 0&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return!1;if(e==te.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var r=t.timeline.getNeighbouringTimeline(e),n=t.timeline.getPaginationToken(e);return!!r||!!n}paginate(e,t){var r=arguments,n=this;return _(function*(){var a=r.length>2&&r[2]!==void 0?r[2]:!0,s=r.length>3&&r[3]!==void 0?r[3]:Ym,o=n.getTimelineIndex(e);if(!o)return!1;if(o.pendingPaginate)return o.pendingPaginate;if(n.extend(e,t))return!0;if(!a||s===0)return!1;var d=o.timeline.getPaginationToken(e);if(!d)return!1;var l=n.client.paginateEventTimeline(o.timeline,{backwards:e==te.BACKWARDS,limit:t}).finally(function(){o.pendingPaginate=void 0}).then(u=>u?n.paginate(e,t,!0,s-1):n.paginate(e,t,!1,0));return o.pendingPaginate=l,l})()}unpaginate(e,t){var r=t?this.start:this.end;if(!r)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,nc("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];for(var e=[],t=this.start.timeline;t;){var r,n,a=t.getEvents(),s=0,o=a.length;t===this.start.timeline&&(s=this.start.index+t.getBaseIndex()),t===((r=this.end)===null||r===void 0?void 0:r.timeline)&&(o=this.end.index+t.getBaseIndex());for(var d=s;d<o;d++)e.push(a[d]);if(t===((n=this.end)===null||n===void 0?void 0:n.timeline))break;t=t.getNeighbouringTimeline(te.FORWARDS)}return e}}class Ya{constructor(e,t){this.timeline=e,this.index=t,c(this,"pendingPaginate",void 0)}minIndex(){return this.timeline.getBaseIndex()*-1}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?te.BACKWARDS:te.FORWARDS);return r?(this.timeline=r,e<0?this.index=this.maxIndex():this.index=this.minIndex(),this.advance(e)):0}retreat(e){return this.advance(e*-1)*-1}}var bi="m.login.email.identity",ic="m.login.msisdn",Xa=(function(i){return i.Password="m.login.password",i.Recaptcha="m.login.recaptcha",i.Terms="m.login.terms",i.Email="m.login.email.identity",i.Msisdn="m.login.msisdn",i.Sso="m.login.sso",i.SsoUnstable="org.matrix.login.sso",i.Dummy="m.login.dummy",i.RegistrationToken="m.login.registration_token",i.UnstableRegistrationToken="org.matrix.msc3231.login.registration_token",i})({});class jl extends Error{constructor(e,t,r){super(e),this.required_stages=t,this.flows=r,c(this,"name","NoAuthFlowFoundError")}}class Bh{constructor(e){var t=this;c(this,"matrixClient",void 0),c(this,"inputs",void 0),c(this,"clientSecret",void 0),c(this,"requestCallback",void 0),c(this,"busyChangedCallback",void 0),c(this,"stateUpdatedCallback",void 0),c(this,"requestEmailTokenCallback",void 0),c(this,"supportedStages",void 0),c(this,"data",void 0),c(this,"emailSid",void 0),c(this,"requestingEmailToken",!1),c(this,"attemptAuthDeferred",null),c(this,"chosenFlow",null),c(this,"currentStage",null),c(this,"emailAttempt",1),c(this,"submitPromise",null),c(this,"requestEmailToken",_(function*(){if(t.requestingEmailToken)O.warn("Could not request email token: Already requesting");else{O.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var r=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=r.sid,O.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}})),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,e.supportedStages!==void 0&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return _(function*(){var t;e.attemptAuthDeferred=Promise.withResolvers();var r=e.attemptAuthDeferred.promise;if((t=e.data)!==null&&t!==void 0&&(t=t.flows)!==null&&t!==void 0&&t.length)e.startNextAuthStage();else{var n;(n=e.busyChangedCallback)===null||n===void 0||n.call(e,!0);var a=e.data.session?{session:e.data.session}:null;e.doRequest(a).finally(()=>{var s;(s=e.busyChangedCallback)===null||s===void 0||s.call(e,!1)})}return r})()}poll(){var e=this;return _(function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==bi&&e.emailSid){var r={sid:e.emailSid,client_secret:e.clientSecret},n=e.matrixClient.getIdentityServerUrl();n&&(r.id_server=new URL(n).host),t={type:bi,threepid_creds:r}}e.submitAuthDict(t,!0)}})()}getSessionId(){var e;return(e=this.data)===null||e===void 0?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return(t=this.data)===null||t===void 0||(t=t.params)===null||t===void 0?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,r=this;return _(function*(){var n,a=t.length>1&&t[1]!==void 0?t[1]:!1;if(!r.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");if(!a){var s;(s=r.busyChangedCallback)===null||s===void 0||s.call(r,!0)}for(;r.submitPromise;)try{yield r.submitPromise}catch{}var o;(n=r.data)!==null&&n!==void 0&&n.session?o=Object.assign({session:r.data.session},e):o=e;try{r.submitPromise=r.doRequest(o,a),yield r.submitPromise}finally{if(r.submitPromise=null,!a){var d;(d=r.busyChangedCallback)===null||d===void 0||d.call(r,!1)}}})()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,r=this;return _(function*(){var n=t.length>1&&t[1]!==void 0?t[1]:!1;try{var a=yield r.requestCallback(e,n);r.attemptAuthDeferred.resolve(a),r.attemptAuthDeferred=null}catch(f){var s,o,d,l,u=f instanceof Fe?f:null,h=(s=u==null||(o=u.data)===null||o===void 0?void 0:o.flows)!==null&&s!==void 0?s:null,v=((d=r.data)===null||d===void 0?void 0:d.flows)||!!h;if(!u||u.httpStatus!==401||!u.data||!v)if(n)O.log("Background poll request failed doing UI auth: ignoring",f);else{var m;(m=r.attemptAuthDeferred)===null||m===void 0||m.reject(f)}u&&!u.data&&(u.data={}),u&&!u.data.flows&&!u.data.completed&&!u.data.session&&(u.data.flows=r.data.flows,u.data.completed=r.data.completed,u.data.session=r.data.session),u&&(r.data=u.data);try{r.startNextAuthStage()}catch(g){r.attemptAuthDeferred.reject(g),r.attemptAuthDeferred=null;return}if(!r.emailSid&&(l=r.chosenFlow)!==null&&l!==void 0&&l.stages.includes(Xa.Email))try{yield r.requestEmailToken()}catch(g){r.attemptAuthDeferred.reject(g),r.attemptAuthDeferred=null}}})()}startNextAuthStage(){var e,t,r=this.chooseStage();if(!r)throw new Error("No incomplete flows from the server");if(this.currentStage=r,r===Xa.Dummy){this.submitAuthDict({type:"m.login.dummy"});return}if((e=this.data)!==null&&e!==void 0&&e.errcode||(t=this.data)!==null&&t!==void 0&&t.error){var n,a;this.stateUpdatedCallback(r,{errcode:((n=this.data)===null||n===void 0?void 0:n.errcode)||"",error:((a=this.data)===null||a===void 0?void 0:a.error)||""});return}this.stateUpdatedCallback(r,r===bi?{emailSid:this.emailSid}:{})}chooseStage(){this.chosenFlow===null&&(this.chosenFlow=this.chooseFlow()),O.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return O.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return this.supportedStages!==void 0&&(t+=e.stages.filter(r=>!this.supportedStages.has(r)).length*10),t}chooseFlow(){var e,t=((e=this.data)===null||e===void 0?void 0:e.flows)||[],r=!!this.inputs.emailAddress||!!this.emailSid,n=!!this.inputs.phoneCountry&&!!this.inputs.phoneNumber;t.sort((u,h)=>this.scoreFlow(u)-this.scoreFlow(h));for(var a of t){var s=!1,o=!1;for(var d of a.stages)d===bi?s=!0:d==ic&&(o=!0);if(s==r&&o==n)return a}var l=[];throw r&&l.push(bi),n&&l.push(ic),new jl("No appropriate authentication flow found",l,t)}firstUncompletedStage(e){var t,r=((t=this.data)===null||t===void 0?void 0:t.completed)||[];return e.stages.find(n=>!r.includes(n))}}function Wh(i,e){return new Promise((t,r)=>{var n=!0,a=i.open(e);a.onupgradeneeded=()=>{n=!1},a.onblocked=()=>r(a.error),a.onsuccess=()=>{var s=a.result;s.close(),n||i.deleteDatabase(e),t(n)},a.onerror=()=>r(a.error)})}var Kh=[i=>{i.createObjectStore("users",{keyPath:["userId"]}),i.createObjectStore("accountData",{keyPath:["type"]}),i.createObjectStore("sync",{keyPath:["clobber"]})},i=>{var e=i.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});e.createIndex("room","room_id")},i=>{i.createObjectStore("client_options",{keyPath:["clobber"]})},i=>{i.createObjectStore("to_device_queue",{autoIncrement:!0})}],Xm=Kh.length;function ba(i,e,t){var r=i.openCursor(e);return new Promise((n,a)=>{var s=[];r.onerror=()=>{var o;a(new Error("Query failed: "+((o=r.error)===null||o===void 0?void 0:o.name)))},r.onsuccess=()=>{var o=r.result;if(!o){n(s);return}s.push(t(o)),o.continue()}})}function Fr(i){return new Promise((e,t)=>{i.oncomplete=function(r){e(r)},i.onerror=function(){t(i.error)}})}function qh(i){return new Promise((e,t)=>{i.onsuccess=function(r){e(r)},i.onerror=function(){t(i.error)}})}function Qm(i){return new Promise((e,t)=>{i.onsuccess=()=>e(i),i.onerror=r=>t(r)})}function Hs(i){return qh(i).then(e=>i.result)}class ac{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),Wh(e,t)}constructor(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"default";this.indexedDB=e,c(this,"dbName",void 0),c(this,"syncAccumulator",void 0),c(this,"db",void 0),c(this,"disconnected",!0),c(this,"_isNewlyCreated",!1),c(this,"syncToDatabasePromise",void 0),c(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new xl}connect(e){var t=this;if(!this.disconnected)return O.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,O.log("LocalIndexedDBStoreBackend.connect: connecting...");var r=this.indexedDB.open(this.dbName,Xm);return r.onupgradeneeded=n=>{var a=r.result,s=n.oldVersion;O.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(s)),s<1&&(this._isNewlyCreated=!0),Kh.forEach((o,d)=>{s<=d&&o(a)})},r.onblocked=()=>{O.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},O.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),qh(r).then(_(function*(){O.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=r.result,t.db.onversionchange=()=>{var n;(n=t.db)===null||n===void 0||n.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,e?.()},yield t.init()}))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then(e=>{var[t,r]=e;O.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:r.nextBatch,rooms:r.roomsData,account_data:{events:t}},!0)})}getOutOfBandMembers(e){return new Promise((t,r)=>{var n=this.db.transaction(["oob_membership_events"],"readonly"),a=n.objectStore("oob_membership_events"),s=a.index("room"),o=IDBKeyRange.only(e),d=s.openCursor(o),l=[],u=!1;d.onsuccess=()=>{var h=d.result;if(!h)return!l.length&&!u?t(null):t(l);var v=h.value;v.oob_written?u=!0:l.push(v),h.continue()},d.onerror=h=>{r(h)}}).then(t=>(O.log("LL: got ".concat(t?.length," membershipEvents from storage for room ").concat(e," ...")),t))}setOutOfBandMembers(e,t){var r=this;return _(function*(){O.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var n=r.db.transaction(["oob_membership_events"],"readwrite"),a=n.objectStore("oob_membership_events");t.forEach(o=>{a.put(o)});var s={room_id:e,oob_written:!0,state_key:0};a.put(s),yield Fr(n),O.log("LL: backend done storing for ".concat(e,"!"))})()}clearOutOfBandMembers(e){var t=this;return _(function*(){var r=t.db.transaction(["oob_membership_events"],"readonly"),n=r.objectStore("oob_membership_events"),a=n.index("room"),s=IDBKeyRange.only(e),o=Hs(a.openKeyCursor(s,"next")).then(f=>(f?.primaryKey)[1]),d=Hs(a.openKeyCursor(s,"prev")).then(f=>(f?.primaryKey)[1]),[l,u]=yield Promise.all([o,d]),h=t.db.transaction(["oob_membership_events"],"readwrite"),v=h.objectStore("oob_membership_events"),m=IDBKeyRange.bound([e,l],[e,u]);O.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,l],[e,u]),yield Qm(v.delete(m))})()}clearDatabase(){return new Promise(e=>{var t;O.log("Removing indexeddb instance: ".concat(this.dbName)),(t=this.db)===null||t===void 0||t.close();var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{O.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},r.onerror=()=>{var n;O.warn("unable to delete js-sdk store indexeddb: ".concat((n=r.error)===null||n===void 0?void 0:n.name)),e()},r.onsuccess=()=>{O.log("Removed indexeddb instance: ".concat(this.dbName)),e()}})}getSavedSync(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(Ki(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then(()=>{this.syncAccumulator.accumulate(e)})}syncToDatabase(e){var t=this;return _(function*(){return t.syncToDatabasePromise?(O.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)})()}doSyncToDatabase(e){var t=this;return _(function*(){try{var r=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(r.accountData),t.persistSyncData(r.nextBatch,r.roomsData)])}finally{t.syncToDatabasePromise=void 0}})()}persistSyncData(e,t){return O.log("Persisting sync data up to",e),ln(()=>{var r=this.db.transaction(["sync"],"readwrite"),n=r.objectStore("sync");return n.put({clobber:"-",nextBatch:e,roomsData:t}),Fr(r).then(()=>{O.log("Persisted sync data up to",e)})})}persistAccountData(e){return ln(()=>{var t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(var n of e)r.put(n);return Fr(t).then()})}persistUserPresenceEvents(e){return ln(()=>{var t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(var n of e)r.put({userId:n[0],event:n[1]});return Fr(t).then()})}getUserPresenceEvents(){return ln(()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return ba(t,void 0,r=>[r.value.userId,r.value.event])})}loadAccountData(){return O.log("LocalIndexedDBStoreBackend: loading account data..."),ln(()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return ba(t,void 0,r=>r.value).then(r=>(O.log("LocalIndexedDBStoreBackend: loaded account data"),r))})}loadSyncData(){return O.log("LocalIndexedDBStoreBackend: loading sync data..."),ln(()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return ba(t,void 0,r=>r.value).then(r=>(O.log("LocalIndexedDBStoreBackend: loaded sync data"),r.length>1&&O.warn("loadSyncData: More than 1 sync row found."),r.length>0?r[0]:{}))})}getClientOptions(){return Promise.resolve().then(()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return ba(t,void 0,r=>{var n;return(n=r.value)===null||n===void 0?void 0:n.options}).then(r=>r[0])})}storeClientOptions(e){var t=this;return _(function*(){var r=t.db.transaction(["client_options"],"readwrite"),n=r.objectStore("client_options");n.put({clobber:"-",options:e}),yield Fr(r)})()}saveToDeviceBatches(e){var t=this;return _(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");for(var a of e)n.add(a);yield Fr(r)})()}getOldestToDeviceBatch(){var e=this;return _(function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),r=t.objectStore("to_device_queue"),n=yield Hs(r.openCursor());if(!n)return null;var a=n.value;return{id:n.key,txnId:a.txnId,eventType:a.eventType,batch:a.batch}})()}removeToDeviceBatch(e){var t=this;return _(function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");n.delete(e),yield Fr(r)})()}destroy(){var e=this;return _(function*(){var t;(t=e.db)===null||t===void 0||t.close()})()}}class Zm{constructor(e,t){this.workerFactory=e,this.dbName=t,c(this,"worker",void 0),c(this,"nextSeq",0),c(this,"inFlight",{}),c(this,"startPromise",void 0),c(this,"onWorkerMessage",r=>{var n=r.data;if(n.command=="closed"){var a;(a=this.onClose)===null||a===void 0||a.call(this)}else if(n.command=="cmd_success"||n.command=="cmd_fail"){if(n.seq===void 0){O.error("Got reply from worker with no seq");return}var s=this.inFlight[n.seq];if(s===void 0){O.error("Got reply for unknown seq "+n.seq);return}if(delete this.inFlight[n.seq],n.command=="cmd_success")s.resolve(n.result);else{var o=new Error(n.error.message);o.name=n.error.name,s.reject(o)}}else O.warn("Unrecognised message from worker: ",n)})}connect(e){return this.onClose=e,this.ensureStarted().then(()=>this.doCmd("connect"))}clearDatabase(){return this.ensureStarted().then(()=>this.doCmd("clearDatabase"))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return _(function*(){return t.doCmd("saveToDeviceBatches",[e])})()}getOldestToDeviceBatch(){var e=this;return _(function*(){return e.doCmd("getOldestToDeviceBatch")})()}removeToDeviceBatch(e){var t=this;return _(function*(){return t.doCmd("removeToDeviceBatch",[e])})()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then(()=>{O.log("IndexedDB worker is ready")})),this.startPromise}doCmd(e,t){return Promise.resolve().then(()=>{var r,n=this.nextSeq++,a=Promise.withResolvers();return this.inFlight[n]=a,(r=this.worker)===null||r===void 0||r.postMessage({command:e,seq:n,args:t}),a.promise})}destroy(){var e=this;return _(function*(){var t;(t=e.worker)===null||t===void 0||t.terminate()})()}}var eg=1e3*60*5;class Vh extends bs{static exists(e,t){return ac.exists(e,t)}constructor(e){if(super(e),c(this,"backend",void 0),c(this,"startedUp",!1),c(this,"syncTs",0),c(this,"userModifiedMap",{}),c(this,"emitter",new Ke),c(this,"onClose",()=>{this.emitter.emit("closed")}),c(this,"getSavedSync",this.degradable(()=>this.backend.getSavedSync(),"getSavedSync")),c(this,"isNewlyCreated",this.degradable(()=>this.backend.isNewlyCreated(),"isNewlyCreated")),c(this,"getSavedSyncToken",this.degradable(()=>this.backend.getNextBatchToken(),"getSavedSyncToken")),c(this,"deleteAllData",this.degradable(()=>(super.deleteAllData(),this.backend.clearDatabase().then(()=>{O.log("Deleted indexeddb data.")},t=>{throw O.error("Failed to delete indexeddb data: ".concat(t)),t})),null)),c(this,"reallySave",this.degradable(()=>{this.syncTs=Date.now();var t=[];for(var r of this.getUsers())this.userModifiedMap[r.userId]!==r.getLastModifiedTime()&&r.events.presence&&(t.push([r.userId,r.events.presence.event]),this.userModifiedMap[r.userId]=r.getLastModifiedTime());return this.backend.syncToDatabase(t)},null)),c(this,"setSyncData",this.degradable(t=>this.backend.setSyncData(t),"setSyncData")),c(this,"getOutOfBandMembers",this.degradable(t=>this.backend.getOutOfBandMembers(t),"getOutOfBandMembers")),c(this,"setOutOfBandMembers",this.degradable((t,r)=>(super.setOutOfBandMembers(t,r),this.backend.setOutOfBandMembers(t,r)),"setOutOfBandMembers")),c(this,"clearOutOfBandMembers",this.degradable(t=>(super.clearOutOfBandMembers(t),this.backend.clearOutOfBandMembers(t)),"clearOutOfBandMembers")),c(this,"getClientOptions",this.degradable(()=>this.backend.getClientOptions(),"getClientOptions")),c(this,"storeClientOptions",this.degradable(t=>(super.storeClientOptions(t),this.backend.storeClientOptions(t)),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new Zm(e.workerFactory,e.dbName):this.backend=new ac(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(O.log("IndexedDBStore.startup: already started"),Promise.resolve()):(O.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then(()=>(O.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents())).then(e=>{O.log("IndexedDBStore.startup: processing presence events"),e.forEach(t=>{var[r,n]=t;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var a=this.createUser(r);n&&a.setPresenceEvent(new at(n)),this.userModifiedMap[a.userId]=a.getLastModifiedTime(),this.storeUser(a)}),this.startedUp=!0}))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>eg}save(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var r=this,n=t?super[t]:null;return _(function*(){for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];try{return yield e.call(r,...s)}catch(d){O.error("IndexedDBStore failure, degrading to MemoryStore",d),r.emitter.emit("degraded",d);try{O.log("IndexedDBStore trying to delete degraded data"),yield r.backend.clearDatabase(),O.log("IndexedDBStore delete after degrading succeeded")}catch(l){O.warn("IndexedDBStore delete after degrading failed",l)}if(n)return n.call(r,...s)}})}getPendingEvents(e){var t=()=>super.getPendingEvents,r=this;return _(function*(){if(!r.localStorage)return t().call(r,e);var n=r.localStorage.getItem($s(e));if(n)try{return JSON.parse(n)}catch(a){O.error("Could not parse persisted pending events",a)}return[]})()}setPendingEvents(e,t){var r=()=>super.setPendingEvents,n=this;return _(function*(){if(!n.localStorage)return r().call(n,e,t);t.length>0?n.localStorage.setItem($s(e),JSON.stringify(t)):n.localStorage.removeItem($s(e))})()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function $s(i){return"mx_pending_events_".concat(i)}var Bt="crypto.",sc=Bt+"migration",Js=Bt+"account",tg=Bt+"cross_signing_keys",Ca=Bt+"inboundgroupsessions/",rg=Bt+"inboundgroupsessions.withheld/",ng=Bt+"rooms/",zs=Bt+"sessionsneedingbackup";function pn(i){return Bt+"sessions/"+i}function Ys(i,e){return Ca+i+"/"+e}function ig(i,e){return rg+i+"/"+e}function ag(i){return ng+i}class ta extends Vi{static exists(e){for(var t=e.length,r=0;r<t;r++){var n;if((n=e.key(r))!==null&&n!==void 0&&n.startsWith(Bt))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return _(function*(){return ta.exists(e.store)})()}getMigrationState(){var e=this;return _(function*(){var t;return(t=Mt(e.store,sc))!==null&&t!==void 0?t:Tn.NOT_STARTED})()}setMigrationState(e){var t=this;return _(function*(){jr(t.store,sc,e)})()}countEndToEndSessions(e,t){for(var r=0,n=0;n<this.store.length;++n){var a=this.store.key(n);if(a!=null&&a.startsWith(pn(""))){var s=Mt(this.store,a);r+=Object.keys(s??{}).length}}t(r)}_getEndToEndSessions(e){var t=Mt(this.store,pn(e)),r={};for(var[n,a]of Object.entries(t||{}))typeof a=="string"?r[n]={session:a}:r[n]=a;return r}getEndToEndSession(e,t,r,n){var a,s=this._getEndToEndSessions(e);n((a=s[t])!==null&&a!==void 0?a:{})}getEndToEndSessions(e,t,r){var n;r((n=this._getEndToEndSessions(e))!==null&&n!==void 0?n:{})}storeEndToEndSession(e,t,r,n){var a=this._getEndToEndSessions(e)||{};a[t]=r,jr(this.store,pn(e),a)}getEndToEndSessionsBatch(){var e=this;return _(function*(){for(var t=[],r=0;r<e.store.length;++r){var n;if((n=e.store.key(r))!==null&&n!==void 0&&n.startsWith(pn(""))){var a=e.store.key(r).split("/")[1];for(var s of Object.values(e._getEndToEndSessions(a)))if(t.push(s),t.length>=In)return t}}return t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return _(function*(){for(var{deviceKey:r,sessionId:n}of e){var a=t._getEndToEndSessions(r)||{};delete a[n],Object.keys(a).length===0?t.store.removeItem(pn(r)):jr(t.store,pn(r),a)}})()}getEndToEndInboundGroupSession(e,t,r,n){n(Mt(this.store,Ys(e,t)),Mt(this.store,ig(e,t)))}storeEndToEndInboundGroupSession(e,t,r,n){jr(this.store,Ys(e,t),r)}countEndToEndInboundGroupSessions(){var e=this;return _(function*(){for(var t=0,r=0;r<e.store.length;++r){var n=e.store.key(r);n!=null&&n.startsWith(Ca)&&(t+=1)}return t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return _(function*(){for(var t=Mt(e.store,zs)||{},r=[],n=0;n<e.store.length;++n){var a=e.store.key(n);if(a!=null&&a.startsWith(Ca)){var s=a.slice(Ca.length);if(r.push({senderKey:s.slice(0,43),sessionId:s.slice(44),sessionData:Mt(e.store,a),needsBackup:s in t}),r.length>=In)return r}}return r.length===0?null:r})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return _(function*(){for(var{senderKey:r,sessionId:n}of e){var a=Ys(r,n);t.store.removeItem(a)}})()}getEndToEndRooms(e,t){for(var r={},n=ag(""),a=0;a<this.store.length;++a){var s=this.store.key(a);if(s!=null&&s.startsWith(n)){var o=s.slice(n.length);r[o]=Mt(this.store,s)}}t(r)}markSessionsNeedingBackup(e){var t=Mt(this.store,zs)||{};for(var r of e)t[r.senderKey+"/"+r.sessionId]=!0;return jr(this.store,zs,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(Js),Promise.resolve()}getAccount(e,t){var r=Mt(this.store,Js);t(r)}storeAccount(e,t){jr(this.store,Js,t)}getCrossSigningKeys(e,t){var r=Mt(this.store,tg);t(r)}getSecretStorePrivateKey(e,t,r){var n=Mt(this.store,Bt+"ssss_cache.".concat(r));t(n)}storeSecretStorePrivateKey(e,t,r){jr(this.store,Bt+"ssss_cache.".concat(t),r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function Mt(i,e){try{return JSON.parse(i.getItem(e))}catch(t){O.log("Error: Failed to get key %s: %s",e,t.message),O.log(t.stack)}return null}function jr(i,e,t){i.setItem(e,JSON.stringify(t))}class sg{constructor(e){this.db=e,c(this,"nextTxnId",0),e.onversionchange=()=>{O.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return _(function*(){throw Error("Not implemented for Backend")})()}startup(){var e=this;return _(function*(){return e})()}deleteAllData(){return _(function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")})()}getMigrationState(){var e=this;return _(function*(){var t=Tn.NOT_STARTED;return yield e.doTxn("readonly",[Ce.STORE_ACCOUNT],r=>{var n=r.objectStore(Ce.STORE_ACCOUNT),a=n.get(ro);a.onsuccess=()=>{var s;t=(s=a.result)!==null&&s!==void 0?s:Tn.NOT_STARTED}}),t})()}setMigrationState(e){var t=this;return _(function*(){yield t.doTxn("readwrite",[Ce.STORE_ACCOUNT],r=>{var n=r.objectStore(Ce.STORE_ACCOUNT);n.put(e,ro)})})()}getAccount(e,t){var r=e.objectStore("account"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(a){mt(e,a)}}}storeAccount(e,t){var r=e.objectStore("account");r.put(t,"-")}getCrossSigningKeys(e,t){var r=e.objectStore("account"),n=r.get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(a){mt(e,a)}}}getSecretStorePrivateKey(e,t,r){var n=e.objectStore("account"),a=n.get("ssss_cache:".concat(r));a.onsuccess=function(){try{t(a.result||null)}catch(s){mt(e,s)}}}storeSecretStorePrivateKey(e,t,r){var n=e.objectStore("account");n.put(r,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var r=e.objectStore("sessions"),n=r.count();n.onsuccess=function(){try{t(n.result)}catch(a){mt(e,a)}}}getEndToEndSessions(e,t,r){var n=t.objectStore("sessions"),a=n.index("deviceKey"),s=a.openCursor(e),o={};s.onsuccess=function(){var d=s.result;if(d)o[d.value.sessionId]={session:d.value.session,lastReceivedMessageTs:d.value.lastReceivedMessageTs},d.continue();else try{r(o)}catch(l){mt(t,l)}}}getEndToEndSession(e,t,r,n){var a=r.objectStore("sessions"),s=a.get([e,t]);s.onsuccess=function(){try{s.result?n({session:s.result.session,lastReceivedMessageTs:s.result.lastReceivedMessageTs}):n(null)}catch(o){mt(r,o)}}}storeEndToEndSession(e,t,r,n){var a=n.objectStore("sessions");a.put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}getEndToEndSessionsBatch(){var e=this;return _(function*(){var t=[];return yield e.doTxn("readonly",[Ce.STORE_SESSIONS],r=>{var n=r.objectStore(Ce.STORE_SESSIONS),a=n.openCursor();a.onsuccess=function(){try{var s=a.result;s&&(t.push(s.value),t.length<In&&s.continue())}catch(o){mt(r,o)}}}),t.length===0?null:t})()}deleteEndToEndSessionsBatch(e){var t=this;return _(function*(){yield t.doTxn("readwrite",[Ce.STORE_SESSIONS],(function(){var r=_(function*(n){try{var a=n.objectStore(Ce.STORE_SESSIONS),s=function*(){var u=a.delete([o,d]);yield new Promise(h=>{u.onsuccess=h})};for(var{deviceKey:o,sessionId:d}of e)yield*s()}catch(l){mt(n,l)}});return function(n){return r.apply(this,arguments)}})())})()}getEndToEndInboundGroupSession(e,t,r,n){var a=!1,s=!1,o=r.objectStore("inbound_group_sessions"),d=o.get([e,t]);d.onsuccess=function(){try{d.result?a=d.result.session:a=null,s!==!1&&n(a,s)}catch(h){mt(r,h)}};var l=r.objectStore("inbound_group_sessions_withheld"),u=l.get([e,t]);u.onsuccess=function(){try{u.result?s=u.result.session:s=null,a!==!1&&n(a,s)}catch(h){mt(r,h)}}}storeEndToEndInboundGroupSession(e,t,r,n){var a=n.objectStore("inbound_group_sessions");a.put({senderCurve25519Key:e,sessionId:t,session:r})}countEndToEndInboundGroupSessions(){var e=this;return _(function*(){var t=0;return yield e.doTxn("readonly",[Ce.STORE_INBOUND_GROUP_SESSIONS],r=>{var n=r.objectStore(Ce.STORE_INBOUND_GROUP_SESSIONS),a=n.count();a.onsuccess=()=>{t=a.result}}),t})()}getEndToEndInboundGroupSessionsBatch(){var e=this;return _(function*(){var t=[];return yield e.doTxn("readonly",[Ce.STORE_INBOUND_GROUP_SESSIONS,Ce.STORE_BACKUP],r=>{var n=r.objectStore(Ce.STORE_INBOUND_GROUP_SESSIONS),a=r.objectStore(Ce.STORE_BACKUP),s=n.openCursor();s.onsuccess=function(){try{var o=s.result;if(o){var d=a.get(o.key);d.onsuccess=()=>{t.push({senderKey:o.value.senderCurve25519Key,sessionId:o.value.sessionId,sessionData:o.value.session,needsBackup:d.result!==void 0}),t.length<In&&o.continue()}}}catch(l){mt(r,l)}}}),t.length===0?null:t})()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return _(function*(){yield t.doTxn("readwrite",[Ce.STORE_INBOUND_GROUP_SESSIONS],(function(){var r=_(function*(n){try{var a=n.objectStore(Ce.STORE_INBOUND_GROUP_SESSIONS),s=function*(){var u=a.delete([o,d]);yield new Promise(h=>{u.onsuccess=h})};for(var{senderKey:o,sessionId:d}of e)yield*s()}catch(l){mt(n,l)}});return function(n){return r.apply(this,arguments)}})())})()}getEndToEndDeviceData(e,t){var r=e.objectStore("device_data"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(a){mt(e,a)}}}getEndToEndRooms(e,t){var r={},n=e.objectStore("rooms"),a=n.openCursor();a.onsuccess=function(){var s=a.result;if(s)r[s.key]=s.value,s.continue();else try{t(r)}catch(o){mt(e,o)}}}markSessionsNeedingBackup(e,t){var r=this;return _(function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map(a=>new Promise((s,o)=>{var d=n.put({senderCurve25519Key:a.senderKey,sessionId:a.sessionId});d.onsuccess=s,d.onerror=o})))})()}doTxn(e,t,r){var n=this.db.transaction(t,e),a=dg(n),s=r(n);return a.then(()=>s)}}var Gh=[i=>{lg(i)},i=>{i.createObjectStore("account")},i=>{var e=i.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});e.createIndex("deviceKey","deviceKey")},i=>{i.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{i.createObjectStore("device_data")},i=>{i.createObjectStore("rooms")},i=>{i.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{i.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},i=>{var e=i.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});e.createIndex("deviceKey","deviceKey"),i.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},i=>{i.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},i=>{i.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],Hh=Gh.length;function og(i,e){O.log("Upgrading IndexedDBCryptoStore from version ".concat(e)+" to ".concat(Hh)),Gh.forEach((t,r)=>{e<=r&&t(i)})}function lg(i){var e=i.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});e.createIndex("session",["requestBody.room_id","requestBody.session_id"]),e.createIndex("state","state")}function mt(i,e){i._mx_abortexception=e;try{i.abort()}catch{}}function dg(i){return new Promise((e,t)=>{i.oncomplete=()=>{i._mx_abortexception!==void 0&&t(i._mx_abortexception),e(null)},i.onerror=r=>{i._mx_abortexception!==void 0?t(i._mx_abortexception):(O.log("Error performing indexeddb txn",r),t(i.error))},i.onabort=r=>{i._mx_abortexception!==void 0?t(i._mx_abortexception):(O.log("Error performing indexeddb txn",r),t(i.error))}})}class Ce{static exists(e,t){return Wh(e,t)}static existsAndIsNotMigrated(e,t){return new Promise((r,n)=>{var a=!0,s=e.open(t);s.onupgradeneeded=()=>{a=!1},s.onblocked=()=>n(s.error),s.onsuccess=()=>{var o=s.result;if(!a)o.close(),e.deleteDatabase(t),r(!1);else{var d=o.transaction([Ce.STORE_ACCOUNT],"readonly"),l=d.objectStore(Ce.STORE_ACCOUNT),u=l.get(ro);u.onsuccess=()=>{var h,v=(h=u.result)!==null&&h!==void 0?h:Tn.NOT_STARTED;r(v===Tn.NOT_STARTED)},u.onerror=()=>{n(u.error)},o.close()}},s.onerror=()=>n(s.error)})}constructor(e,t){this.indexedDB=e,this.dbName=t,c(this,"backendPromise",void 0),c(this,"backend",void 0)}containsData(){var e=this;return _(function*(){return Ce.exists(e.indexedDB,e.dbName)})()}startup(){return this.backendPromise?this.backendPromise:(this.backendPromise=new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}O.log("connecting to indexeddb ".concat(this.dbName));var r=this.indexedDB.open(this.dbName,Hh);r.onupgradeneeded=n=>{var a=r.result,s=n.oldVersion;og(a,s)},r.onblocked=()=>{O.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=n=>{O.log("Error connecting to indexeddb",n),t(r.error)},r.onsuccess=()=>{var n=r.result;O.log("connected to indexeddb ".concat(this.dbName)),e(new sg(n))}}).then(e=>e.doTxn("readonly",[Ce.STORE_INBOUND_GROUP_SESSIONS,Ce.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],t=>{e.getEndToEndInboundGroupSession("","",t,()=>{})}).then(()=>e)).catch(e=>{if(e.name==="VersionError")throw O.warn("Crypto DB is too new for us to use!",e),new fs(vs.TooNew);O.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{if(!(globalThis.localStorage instanceof Storage))throw new Error("localStorage is not available");return new ta(globalThis.localStorage)}catch(t){return O.warn("Unable to open localStorage: falling back to in-memory store: ".concat(t)),new Vi}}).then(e=>(this.backend=e,e)),this.backendPromise)}deleteAllData(){return new Promise((e,t)=>{if(!this.indexedDB){t(new Error("no indexeddb support available"));return}O.log("Removing indexeddb instance: ".concat(this.dbName));var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{O.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=n=>{O.log("Error deleting data from indexeddb",n),t(r.error)},r.onsuccess=()=>{O.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}).catch(e=>{O.warn("unable to delete IndexedDBCryptoStore: ".concat(e))})}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this.backend.getSecretStorePrivateKey(e,t,r)}storeSecretStorePrivateKey(e,t,r){this.backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this.backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this.backend.getEndToEndSessions(e,t,r)}storeEndToEndSession(e,t,r,n){this.backend.storeEndToEndSession(e,t,r,n)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,r,n){this.backend.getEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this.backend.storeEndToEndInboundGroupSession(e,t,r,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}doTxn(e,t,r,n){return this.backend.doTxn(e,t,r,n)}}c(Ce,"STORE_ACCOUNT","account");c(Ce,"STORE_SESSIONS","sessions");c(Ce,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions");c(Ce,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld");c(Ce,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions");c(Ce,"STORE_PARKED_SHARED_HISTORY","parked_shared_history");c(Ce,"STORE_DEVICE_DATA","device_data");c(Ce,"STORE_ROOMS","rooms");c(Ce,"STORE_BACKUP","sessions_needing_backup");var $h=(function(i){return i.Email="email",i.Phone="msisdn",i})({}),Jh=new Qe("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),zh=(function(i){return i.Gitlab="gitlab",i.Github="github",i.Apple="apple",i.Google="google",i.Facebook="facebook",i.Twitter="twitter",i})({}),Yh=(function(i){return i.LOGIN="login",i.REGISTER="register",i})({}),Xh="m.tz",Qh="us.cloke.msc4175.tz";class Zh{constructor(e){c(this,"relations",void 0),this.relations=e.filter(t=>!!t)}getRelations(){return this.relations.reduce((e,t)=>[...e,...t.getRelations()],[])}on(e,t){this.relations.forEach(r=>r.on(e,t))}off(e,t){this.relations.forEach(r=>r.off(e,t))}}var ev=(function(i){return i.Global="Global",i.SetItemError="setItem",i.GetItemError="getItem",i.RemoveItemError="removeItem",i.ClearError="clear",i.QuotaExceededError="QuotaExceededError",i})({});class ug extends Ke{}var tv=new ug,rv=()=>new Vi;function Bl(i){rv=i}function nv(i){var e,t,r;return i.store=(e=i.store)!==null&&e!==void 0?e:new bs({localStorage:globalThis.localStorage}),i.scheduler=(t=i.scheduler)!==null&&t!==void 0?t:new Zr,i.cryptoStore=(r=i.cryptoStore)!==null&&r!==void 0?r:rv(),i}function iv(i){return new ea(nv(i))}function av(i,e,t,r){var n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:!0;return new Nl(i,e,t,nv(r),n)}const cg=Object.freeze(Object.defineProperty({__proto__:null,AuthType:Xa,AutoDiscovery:ye,AutoDiscoveryAction:yt,AutoDiscoveryError:Ct,Beacon:Ko,BeaconEvent:We,CallEvent:_e,CallFeedEvent:xt,Category:$t,ClientEvent:ie,ClientPrefix:$e,ClientStoppedError:ph,ConditionKind:Ye,ConditionOperator:eh,ConnectionError:Cr,ContentHelpers:Bc,DELEGATED_OIDC_COMPATIBILITY:Jh,DEVICE_CODE_SCOPE:Ih,DMMemberCountCondition:th,DebugLogger:Za,Device:Fh,DeviceVerification:Fl,Direction:be,DuplicateStrategy:En,EVENT_VISIBILITY_CHANGE_TYPE:Sr,EventEmitterEvents:Po,EventStatus:pe,EventTimeline:te,EventTimelineSet:Gr,EventType:F,FILTER_RELATED_BY_REL_TYPES:Yr,FILTER_RELATED_BY_SENDERS:zr,FeatureSupport:dt,Filter:St,GET_LOGIN_TOKEN_CAPABILITY:Mh,GroupCall:ls,GroupCallEvent:Le,GroupCallIntent:sl,GroupCallState:Ve,GroupCallStatsReportEvent:yn,GroupCallType:Yi,GuestAccess:xi,HTTPError:Ir,HistoryVisibility:cs,HttpApiEvent:Fa,IdentityPrefix:Vt,IdentityProviderBrand:zh,IndexedDBCryptoStore:Ce,IndexedDBStore:Vh,InteractiveAuth:Bh,InvalidCryptoStoreError:fs,InvalidCryptoStoreState:vs,JoinRule:ll,KNOWN_SAFE_ROOM_VERSION:tl,KeySignatureUploadError:fh,KnownMembership:Se,LOCAL_NOTIFICATION_SETTINGS_PREFIX:Uo,LocalStorageCryptoStore:ta,LocalStorageErrors:ev,LocationAssetType:Xr,MAIN_ROOM_TIMELINE:jn,MAXIMUM_MATRIX_VERSION:ih,MAX_STICKY_DURATION_MS:Ss,MINIMUM_MATRIX_VERSION:nh,MSC3912_RELATION_BASED_REDACTIONS_PROP:La,MXID_PATTERN:ts,M_ASSET:xn,M_BEACON:Va,M_BEACON_INFO:hs,M_HTML:Oc,M_LOCATION:Fn,M_MESSAGE:Cc,M_POLL_END:Ni,M_POLL_KIND_DISCLOSED:qc,M_POLL_KIND_UNDISCLOSED:Vc,M_POLL_RESPONSE:On,M_POLL_START:Gc,M_TEXT:ns,M_TIMESTAMP:ur,M_TOPIC:is,MatrixClient:ea,MatrixError:Fe,MatrixEvent:at,MatrixEventEvent:Me,MatrixHttpApi:Qo,MatrixSafetyError:Jo,MatrixSafetyErrorCode:$o,MatrixScheduler:Zr,MediaHandlerEvent:mr,MediaPrefix:Jr,MemoryCryptoStore:Vi,MemoryStore:bs,Method:W,MsgType:Wt,NoAuthFlowFoundError:jl,NotificationCountType:ke,OidcError:ct,OidcTokenRefresher:Oh,PUSHER_DEVICE_ID:mc,PUSHER_ENABLED:Ua,PendingEventOrdering:en,Poll:qo,PollEvent:nr,Preset:us,ProfileKeyMSC4175Timezone:Qh,ProfileKeyTimezone:Xh,PushRuleActionName:dr,PushRuleKind:it,REFERENCE_RELATION:Wo,ReceiptType:ht,RelatedRelations:Zh,RelationType:Ue,Relations:rs,RelationsEvent:wi,RestrictedAllowType:sh,Room:zi,RoomCreateTypeField:Ai,RoomEvent:ne,RoomMember:Cn,RoomMemberEvent:pt,RoomNameType:Nt,RoomState:Un,RoomStateEvent:we,RoomSummary:Bo,RoomType:$r,RoomVersionStability:Zo,RoomWidgetClient:Nl,RoomWidgetClientEvent:ki,RuleId:rt,SERVICE_TYPES:Wa,SSOAction:Yh,STABLE_MSC4133_EXTENDED_PROFILES:Tl,SUPPORTED_MATRIX_VERSIONS:Mn,SearchOrderBy:dl,SearchResult:Xi,SecretStorage:hh,ServerCapabilities:el,SetPresence:rl,SlidingSyncEvent:qa,StatsReport:zt,SyncAccumulator:xl,SyncState:Pe,THREAD_RELATION_TYPE:De,Thread:xe,ThreadEvent:vt,ThreadFilterType:At,ThreepidMedium:$h,TimelineIndex:Ya,TimelineWindow:jh,ToDeviceMessageId:Hi,TokenRefreshError:Ho,TokenRefreshLogoutError:ss,TweakName:ds,TypedEventEmitter:Ke,UNSIGNED_MEMBERSHIP_FIELD:No,UNSIGNED_THREAD_ID_FIELD:Di,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:Lo,UNSTABLE_MSC2666_MUTUAL_ROOMS:_l,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:wl,UNSTABLE_MSC2666_SHARED_ROOMS:El,UNSTABLE_MSC2716_MARKER:Do,UNSTABLE_MSC3088_ENABLED:Aa,UNSTABLE_MSC3088_PURPOSE:Pa,UNSTABLE_MSC3089_BRANCH:Jt,UNSTABLE_MSC3089_LEAF:Ao,UNSTABLE_MSC3089_TREE_SUBTYPE:Da,UNSTABLE_MSC3852_LAST_SEEN_UA:kh,UNSTABLE_MSC4133_EXTENDED_PROFILES:Rl,UNSTABLE_MSC4140_DELAYED_EVENTS:ot,UNSTABLE_MSC4354_STICKY_EVENTS:za,UnsupportedDelayedEventsEndpointError:bt,UnsupportedStickyEventsEndpointError:Ga,UpdateDelayedEventAction:Rr,User:Yt,UserEvent:gt,Visibility:ah,anySignal:zo,calculateRetryBackoff:Yo,completeAuthorizationCodeGrant:Th,createClient:iv,createNewMatrixCall:kn,createRoomWidgetClient:av,decodeBase64:_r,decodeIdToken:gl,determineFeatureSupport:Oi,discoverAndValidateOIDCIssuerWellKnown:gs,encodeBase64:_n,encodeUnpaddedBase64:al,encodeUnpaddedBase64Url:Vn,fixNotificationCountOnDecryption:Il,generateAuthorizationParams:_h,generateAuthorizationUrl:wh,generateOidcAuthorizationUrl:Rh,generateScope:Zi,getBeaconInfoIdentifier:Ui,getHttpUriForMxc:Gi,inMainTimelineForReceipt:Ln,isDmMemberCountCondition:rh,isEventTypeSame:kc,isPollEvent:Vo,isSendDelayedEventRequestOpts:Ka,isTimestampInDuration:xa,localStorageErrorsEventsEmitter:tv,parseErrorResponse:os,registerOidcClient:Ch,retryNetworkOperation:ja,safeGetRetryAfterMs:as,setCryptoStoreFactory:Bl,threadFilterTypeToFilter:Cl,threadIdForReceipt:tn,timeoutSignal:Ji,validateAuthMetadata:ml,validateAuthMetadataAndKeys:ys,validateBearerTokenResponse:bl,validateIdToken:yl,validateStoredUserState:Sl},Symbol.toStringTag,{value:"Module"}));if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;var ko;try{ko=globalThis.indexedDB}catch{}ko&&Bl(()=>new Ce(ko,"matrix-js-sdk:crypto"));globalThis.matrixcs=cg;const Og=Object.freeze(Object.defineProperty({__proto__:null,AuthType:Xa,AutoDiscovery:ye,AutoDiscoveryAction:yt,AutoDiscoveryError:Ct,Beacon:Ko,BeaconEvent:We,CallEvent:_e,CallFeedEvent:xt,Category:$t,ClientEvent:ie,ClientPrefix:$e,ClientStoppedError:ph,ConditionKind:Ye,ConditionOperator:eh,ConnectionError:Cr,ContentHelpers:Bc,DELEGATED_OIDC_COMPATIBILITY:Jh,DEVICE_CODE_SCOPE:Ih,DMMemberCountCondition:th,DebugLogger:Za,Device:Fh,DeviceVerification:Fl,Direction:be,DuplicateStrategy:En,EVENT_VISIBILITY_CHANGE_TYPE:Sr,EventEmitterEvents:Po,EventStatus:pe,EventTimeline:te,EventTimelineSet:Gr,EventType:F,FILTER_RELATED_BY_REL_TYPES:Yr,FILTER_RELATED_BY_SENDERS:zr,FeatureSupport:dt,Filter:St,GET_LOGIN_TOKEN_CAPABILITY:Mh,GroupCall:ls,GroupCallEvent:Le,GroupCallIntent:sl,GroupCallState:Ve,GroupCallStatsReportEvent:yn,GroupCallType:Yi,GuestAccess:xi,HTTPError:Ir,HistoryVisibility:cs,HttpApiEvent:Fa,IdentityPrefix:Vt,IdentityProviderBrand:zh,IndexedDBCryptoStore:Ce,IndexedDBStore:Vh,InteractiveAuth:Bh,InvalidCryptoStoreError:fs,InvalidCryptoStoreState:vs,JoinRule:ll,KNOWN_SAFE_ROOM_VERSION:tl,KeySignatureUploadError:fh,KnownMembership:Se,LOCAL_NOTIFICATION_SETTINGS_PREFIX:Uo,LocalStorageCryptoStore:ta,LocalStorageErrors:ev,LocationAssetType:Xr,MAIN_ROOM_TIMELINE:jn,MAXIMUM_MATRIX_VERSION:ih,MAX_STICKY_DURATION_MS:Ss,MINIMUM_MATRIX_VERSION:nh,MSC3912_RELATION_BASED_REDACTIONS_PROP:La,MXID_PATTERN:ts,M_ASSET:xn,M_BEACON:Va,M_BEACON_INFO:hs,M_HTML:Oc,M_LOCATION:Fn,M_MESSAGE:Cc,M_POLL_END:Ni,M_POLL_KIND_DISCLOSED:qc,M_POLL_KIND_UNDISCLOSED:Vc,M_POLL_RESPONSE:On,M_POLL_START:Gc,M_TEXT:ns,M_TIMESTAMP:ur,M_TOPIC:is,MatrixClient:ea,MatrixError:Fe,MatrixEvent:at,MatrixEventEvent:Me,MatrixHttpApi:Qo,MatrixSafetyError:Jo,MatrixSafetyErrorCode:$o,MatrixScheduler:Zr,MediaHandlerEvent:mr,MediaPrefix:Jr,MemoryCryptoStore:Vi,MemoryStore:bs,Method:W,MsgType:Wt,NoAuthFlowFoundError:jl,NotificationCountType:ke,OidcError:ct,OidcTokenRefresher:Oh,PUSHER_DEVICE_ID:mc,PUSHER_ENABLED:Ua,PendingEventOrdering:en,Poll:qo,PollEvent:nr,Preset:us,ProfileKeyMSC4175Timezone:Qh,ProfileKeyTimezone:Xh,PushRuleActionName:dr,PushRuleKind:it,REFERENCE_RELATION:Wo,ReceiptType:ht,RelatedRelations:Zh,RelationType:Ue,Relations:rs,RelationsEvent:wi,RestrictedAllowType:sh,Room:zi,RoomCreateTypeField:Ai,RoomEvent:ne,RoomMember:Cn,RoomMemberEvent:pt,RoomNameType:Nt,RoomState:Un,RoomStateEvent:we,RoomSummary:Bo,RoomType:$r,RoomVersionStability:Zo,RoomWidgetClient:Nl,RoomWidgetClientEvent:ki,RuleId:rt,SERVICE_TYPES:Wa,SSOAction:Yh,STABLE_MSC4133_EXTENDED_PROFILES:Tl,SUPPORTED_MATRIX_VERSIONS:Mn,SearchOrderBy:dl,SearchResult:Xi,SecretStorage:hh,ServerCapabilities:el,SetPresence:rl,SlidingSyncEvent:qa,StatsReport:zt,SyncAccumulator:xl,SyncState:Pe,THREAD_RELATION_TYPE:De,Thread:xe,ThreadEvent:vt,ThreadFilterType:At,ThreepidMedium:$h,TimelineIndex:Ya,TimelineWindow:jh,ToDeviceMessageId:Hi,TokenRefreshError:Ho,TokenRefreshLogoutError:ss,TweakName:ds,TypedEventEmitter:Ke,UNSIGNED_MEMBERSHIP_FIELD:No,UNSIGNED_THREAD_ID_FIELD:Di,UNSTABLE_ELEMENT_FUNCTIONAL_USERS:Lo,UNSTABLE_MSC2666_MUTUAL_ROOMS:_l,UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:wl,UNSTABLE_MSC2666_SHARED_ROOMS:El,UNSTABLE_MSC2716_MARKER:Do,UNSTABLE_MSC3088_ENABLED:Aa,UNSTABLE_MSC3088_PURPOSE:Pa,UNSTABLE_MSC3089_BRANCH:Jt,UNSTABLE_MSC3089_LEAF:Ao,UNSTABLE_MSC3089_TREE_SUBTYPE:Da,UNSTABLE_MSC3852_LAST_SEEN_UA:kh,UNSTABLE_MSC4133_EXTENDED_PROFILES:Rl,UNSTABLE_MSC4140_DELAYED_EVENTS:ot,UNSTABLE_MSC4354_STICKY_EVENTS:za,UnsupportedDelayedEventsEndpointError:bt,UnsupportedStickyEventsEndpointError:Ga,UpdateDelayedEventAction:Rr,User:Yt,UserEvent:gt,Visibility:ah,anySignal:zo,calculateRetryBackoff:Yo,completeAuthorizationCodeGrant:Th,createClient:iv,createNewMatrixCall:kn,createRoomWidgetClient:av,decodeBase64:_r,decodeIdToken:gl,determineFeatureSupport:Oi,discoverAndValidateOIDCIssuerWellKnown:gs,encodeBase64:_n,encodeUnpaddedBase64:al,encodeUnpaddedBase64Url:Vn,fixNotificationCountOnDecryption:Il,generateAuthorizationParams:_h,generateAuthorizationUrl:wh,generateOidcAuthorizationUrl:Rh,generateScope:Zi,getBeaconInfoIdentifier:Ui,getHttpUriForMxc:Gi,inMainTimelineForReceipt:Ln,isDmMemberCountCondition:rh,isEventTypeSame:kc,isPollEvent:Vo,isSendDelayedEventRequestOpts:Ka,isTimestampInDuration:xa,localStorageErrorsEventsEmitter:tv,parseErrorResponse:os,registerOidcClient:Ch,retryNetworkOperation:ja,safeGetRetryAfterMs:as,setCryptoStoreFactory:Bl,threadFilterTypeToFilter:Cl,threadIdForReceipt:tn,timeoutSignal:Ji,validateAuthMetadata:ml,validateAuthMetadataAndKeys:ys,validateBearerTokenResponse:bl,validateIdToken:yl,validateStoredUserState:Sl},Symbol.toStringTag,{value:"Module"}));export{bg as A,lr as B,st as C,Gp as D,F as E,Tu as F,Vp as G,cs as H,wg as I,Tg as J,Se as K,fg as L,W as M,Ig as N,Ce as O,Tn as P,$p as Q,ne as R,Kr as S,Ke as T,Eg as U,pg as V,Og as W,lv as _,c as a,_ as b,Hi as c,_r as d,Z as e,Yo as f,oc as g,Fl as h,Fh as i,qn as j,mg as k,vg as l,Wt as m,gg as n,Fe as o,$e as p,Sg as q,ph as r,qi as s,_n as t,Gi as u,_g as v,Rg as w,wr as x,yg as y,Me as z};
