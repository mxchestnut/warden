#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

cd backend

# Prevent committing sensitive files
echo "ğŸ”’ Checking for sensitive files..."

# Check if .env file is being committed
if git diff --cached --name-only | grep -q "\.env$"; then
    echo "âŒ ERROR: Attempting to commit .env file!"
    echo "Please remove .env from staging: git reset HEAD .env"
    exit 1
fi

# Check for hardcoded API keys or secrets in staged files
if git diff --cached | grep -iE "(AIza[0-9A-Za-z_-]{35}|npg_[a-zA-Z0-9]+|MTQ[0-9A-Za-z._-]+)" | grep -v ".env.example" > /dev/null; then
    echo "âŒ ERROR: Hardcoded API keys or tokens detected!"
    echo "Please remove sensitive credentials from your code."
    exit 1
fi

# Run TypeScript compilation check
echo "ğŸ” Checking TypeScript compilation..."
npm run build > /dev/null 2>&1 || {
    echo "âŒ TypeScript compilation failed!"
    npm run build
    exit 1
}

# Run security audit (non-blocking, just warning)
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=moderate || {
    echo "âš ï¸  Security vulnerabilities found. Consider running 'npm audit fix'"
}

# Run lint-staged for staged files
echo "âœ¨ Formatting and linting staged files..."
npx lint-staged || exit 1

echo "âœ… Pre-commit checks passed!"
