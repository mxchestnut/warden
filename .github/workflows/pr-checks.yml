name: PR Quality Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, ready_for_review ]

# Cancel previous runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Check if PR is ready (not draft)
  check-pr-status:
    name: Check PR Status
    runs-on: ubuntu-latest
    steps:
      - name: Skip if draft PR
        if: github.event.pull_request.draft == true
        run: |
          echo "‚è∏Ô∏è  Skipping checks for draft PR"
          exit 0

  # Lint and type check backend
  backend-quality:
    name: Backend - Lint & Type Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Run ESLint
        working-directory: backend
        run: npm run lint
        continue-on-error: false

      - name: Run TypeScript type checking
        working-directory: backend
        run: npx tsc --noEmit

      - name: Check for type errors in routes
        working-directory: backend
        run: |
          echo "Checking for critical type errors..."
          npx tsc --noEmit 2>&1 | grep -v "src/routes/" || true

  # Lint and type check frontend
  frontend-quality:
    name: Frontend - Lint & Type Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        working-directory: frontend-src
        run: npm ci

      - name: Run ESLint
        working-directory: frontend-src
        run: npm run lint

      - name: Run TypeScript type checking
        working-directory: frontend-src
        run: npx tsc --noEmit

  # Build verification
  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Build backend
        working-directory: backend
        run: npm run build

      - name: Verify backend build artifacts
        working-directory: backend
        run: |
          echo "Checking dist/ directory..."
          ls -lh dist/
          test -f dist/server.js || exit 1
          test -f dist/config/env.js || exit 1
          test -f dist/config/swagger.js || exit 1
          echo "‚úÖ Backend build artifacts verified"

      - name: Install frontend dependencies
        working-directory: frontend-src
        run: npm ci

      - name: Build frontend
        working-directory: frontend-src
        run: npm run build

      - name: Verify frontend build artifacts
        working-directory: frontend-src
        run: |
          echo "Checking dist/ directory..."
          ls -lh dist/
          test -f dist/index.html || exit 1
          test -d dist/assets || exit 1
          echo "‚úÖ Frontend build artifacts verified"

      - name: Check bundle size
        working-directory: frontend-src
        run: |
          BUNDLE_SIZE=$(du -sh dist | cut -f1)
          echo "üì¶ Frontend bundle size: $BUNDLE_SIZE"
          # Warn if over 5MB
          SIZE_BYTES=$(du -sb dist | cut -f1)
          if [ $SIZE_BYTES -gt 5242880 ]; then
            echo "‚ö†Ô∏è Warning: Bundle size exceeds 5MB"
          fi

  # Dependency security check
  security-check:
    name: Security & Dependency Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Backend security audit
        working-directory: backend
        run: |
          npm audit --audit-level=high
        continue-on-error: true

      - name: Frontend security audit
        working-directory: frontend-src
        run: |
          npm audit --audit-level=high
        continue-on-error: true

      - name: Check for outdated critical dependencies
        run: |
          echo "Checking for outdated dependencies..."
          cd backend && npm outdated || true
          cd ../frontend-src && npm outdated || true

  # Code quality summary
  pr-summary:
    name: PR Quality Summary
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality, build-verification, security-check]
    if: always()
    
    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const results = {
              backend: '${{ needs.backend-quality.result }}',
              frontend: '${{ needs.frontend-quality.result }}',
              build: '${{ needs.build-verification.result }}',
              security: '${{ needs.security-check.result }}'
            };
            
            const emoji = (result) => {
              if (result === 'success') return '‚úÖ';
              if (result === 'failure') return '‚ùå';
              return '‚ö†Ô∏è';
            };
            
            const allPassed = Object.values(results).every(r => r === 'success');
            
            const body = `## üîç PR Quality Checks
            
            | Check | Status |
            |-------|--------|
            | Backend Quality | ${emoji(results.backend)} ${results.backend} |
            | Frontend Quality | ${emoji(results.frontend)} ${results.frontend} |
            | Build Verification | ${emoji(results.build)} ${results.build} |
            | Security Audit | ${emoji(results.security)} ${results.security} |
            
            ${allPassed ? '‚úÖ **All checks passed!** Ready to merge.' : '‚ö†Ô∏è **Some checks failed.** Please review the logs above.'}
            
            [View detailed results ‚Üí](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if any check failed
        if: |
          needs.backend-quality.result != 'success' ||
          needs.frontend-quality.result != 'success' ||
          needs.build-verification.result != 'success'
        run: exit 1
